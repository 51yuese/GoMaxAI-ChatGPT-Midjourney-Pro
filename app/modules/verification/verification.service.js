'use strict';const _0x3785c8=_0x5591;(function(_0x5b0017,_0x1b31b9){const _0x2b760c=_0x5591,_0x350711=_0x5b0017();while(!![]){try{const _0x33c551=-parseInt(_0x2b760c(0x147))/0x1+-parseInt(_0x2b760c(0x163))/0x2*(-parseInt(_0x2b760c(0x15c))/0x3)+parseInt(_0x2b760c(0x176))/0x4+parseInt(_0x2b760c(0x184))/0x5*(-parseInt(_0x2b760c(0x160))/0x6)+parseInt(_0x2b760c(0x16d))/0x7*(parseInt(_0x2b760c(0x14a))/0x8)+-parseInt(_0x2b760c(0x17b))/0x9+-parseInt(_0x2b760c(0x15d))/0xa*(-parseInt(_0x2b760c(0x162))/0xb);if(_0x33c551===_0x1b31b9)break;else _0x350711['push'](_0x350711['shift']());}catch(_0x4ecc59){_0x350711['push'](_0x350711['shift']());}}}(_0x493a,0xc53d9));function _0x493a(){const _0x10a907=['object','验证码不存在','typeorm','2556352tgAXCd','__metadata','design:paramtypes','expiresAt','createdAt','12878955LDedrK','now','Message','function','getOwnPropertyDescriptor','https://dysmsapi.aliyuncs.com','getTime','验证码错误','VerifycationEntity','185ZEeeUb','../redisCache/redisCache.service','图形验证码已过期、请重新输入!','DESC','POST','getPhoneVerifyConfig','__esModule','createRandomCode','VerificationService','save','findOne','664881MyBIvg','../../common/constants/status.constant','确实必要参数错误！','12205744UmYzLN','验证码发送失败！','验证码已过期','InjectRepository','stringify','globalConfigService','图形验证码错误、请检查填写!','update','code','del','sendPhoneCode','length','USED','BAD_REQUEST','defineProperty','verifyCaptcha','used','verifyCode','1583616XxXYfD','41460NXXNRQ','./verifycation.entity','decorate','69522mCOygN','@alicloud/pop-core','297rqaWEQ','4YCyDvz','verifycationEntity','SendSms','createVerification','HttpException','VerificationUseStatusEnum','getNamespace','当前验证码已被使用！','HttpStatus','redisCacheService','7YzrhVf','Repository','GlobalConfigService','../globalConfig/globalConfig.service','Code','data'];_0x493a=function(){return _0x10a907;};return _0x493a();}var __decorate=this&&this['__decorate']||function(_0x6b4b4a,_0x201e44,_0x317ffa,_0x29f204){const _0x3190ee=_0x5591;var _0x2d52a6=arguments[_0x3190ee(0x155)],_0xbe56a1=_0x2d52a6<0x3?_0x201e44:_0x29f204===null?_0x29f204=Object[_0x3190ee(0x17f)](_0x201e44,_0x317ffa):_0x29f204,_0x16030e;if(typeof Reflect===_0x3190ee(0x173)&&typeof Reflect[_0x3190ee(0x15f)]===_0x3190ee(0x17e))_0xbe56a1=Reflect[_0x3190ee(0x15f)](_0x6b4b4a,_0x201e44,_0x317ffa,_0x29f204);else{for(var _0x10d09e=_0x6b4b4a['length']-0x1;_0x10d09e>=0x0;_0x10d09e--)if(_0x16030e=_0x6b4b4a[_0x10d09e])_0xbe56a1=(_0x2d52a6<0x3?_0x16030e(_0xbe56a1):_0x2d52a6>0x3?_0x16030e(_0x201e44,_0x317ffa,_0xbe56a1):_0x16030e(_0x201e44,_0x317ffa))||_0xbe56a1;}return _0x2d52a6>0x3&&_0xbe56a1&&Object['defineProperty'](_0x201e44,_0x317ffa,_0xbe56a1),_0xbe56a1;},__metadata=this&&this[_0x3785c8(0x177)]||function(_0x33b0e3,_0x59bfa6){const _0x10e4c8=_0x3785c8;if(typeof Reflect===_0x10e4c8(0x173)&&typeof Reflect['metadata']===_0x10e4c8(0x17e))return Reflect['metadata'](_0x33b0e3,_0x59bfa6);},__param=this&&this['__param']||function(_0x194b28,_0xd2be7d){return function(_0x17190d,_0x11323a){_0xd2be7d(_0x17190d,_0x11323a,_0x194b28);};};Object[_0x3785c8(0x158)](exports,_0x3785c8(0x142),{'value':!![]}),exports[_0x3785c8(0x144)]=void 0x0;const globalConfig_service_1=require(_0x3785c8(0x170)),status_constant_1=require(_0x3785c8(0x148)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x3785c8(0x175)),verifycation_entity_1=require(_0x3785c8(0x15e)),common_1=require('@nestjs/common'),utils_1=require('../../common/utils'),redisCache_service_1=require(_0x3785c8(0x185)),Core=require(_0x3785c8(0x161));function _0x5591(_0x5f4b2e,_0x50d1a5){const _0x493ac5=_0x493a();return _0x5591=function(_0x559179,_0x168446){_0x559179=_0x559179-0x140;let _0x3ffdfb=_0x493ac5[_0x559179];return _0x3ffdfb;},_0x5591(_0x5f4b2e,_0x50d1a5);}let VerificationService=class VerificationService{constructor(_0x10b5e0,_0x3c1f94,_0x1a098f){const _0x11355a=_0x3785c8;this['verifycationEntity']=_0x10b5e0,this[_0x11355a(0x14f)]=_0x3c1f94,this[_0x11355a(0x16c)]=_0x1a098f;}async[_0x3785c8(0x166)](_0x53cb33,_0x222946,_0x307b68=0x1e*0x3c){const _0x181e0d=_0x3785c8,_0x5eddfa=await this['verifycationEntity'][_0x181e0d(0x146)]({'where':{'userId':_0x53cb33['id'],'type':_0x222946},'order':{'createdAt':_0x181e0d(0x187)}});if(_0x5eddfa&&_0x5eddfa[_0x181e0d(0x17a)][_0x181e0d(0x181)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x55596a=Math['ceil']((_0x5eddfa[_0x181e0d(0x17a)][_0x181e0d(0x181)]()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1['HttpException'](_0x55596a+'S内不得重新发送',common_1['HttpStatus']['BAD_REQUEST']);}const _0x2c32bd=(0x0,utils_1[_0x181e0d(0x143)])(),_0x291381=new Date(Date[_0x181e0d(0x17c)]()+_0x307b68*0x3e8),{id:_0x1a44c9,email:_0x32cca0}=_0x53cb33,_0x26f971={'userId':_0x1a44c9,'type':_0x222946,'code':_0x2c32bd,'expiresAt':_0x291381,'email':_0x32cca0};return await this[_0x181e0d(0x164)][_0x181e0d(0x145)](_0x26f971);}async[_0x3785c8(0x15b)]({code:_0x48d1dd,id:_0x1b61cd},_0x5c1076){const _0xc56c75=_0x3785c8,_0x349626=await this[_0xc56c75(0x164)]['findOne']({'where':{'id':_0x1b61cd,'type':_0x5c1076},'order':{'createdAt':_0xc56c75(0x187)}});if(!_0x349626)throw new common_1[(_0xc56c75(0x167))](_0xc56c75(0x174),common_1[_0xc56c75(0x16b)][_0xc56c75(0x157)]);if(_0x349626[_0xc56c75(0x15a)]===status_constant_1['VerificationUseStatusEnum']['USED'])throw new common_1[(_0xc56c75(0x167))](_0xc56c75(0x16a),common_1[_0xc56c75(0x16b)][_0xc56c75(0x157)]);else _0x349626[_0xc56c75(0x15a)]=status_constant_1[_0xc56c75(0x168)][_0xc56c75(0x156)],await this[_0xc56c75(0x164)][_0xc56c75(0x151)]({'id':_0x1b61cd},_0x349626);if(Number(_0x349626[_0xc56c75(0x152)])!==Number(_0x48d1dd))throw new common_1[(_0xc56c75(0x167))](_0xc56c75(0x182),common_1[_0xc56c75(0x16b)][_0xc56c75(0x157)]);if(_0x349626[_0xc56c75(0x179)]<new Date())throw new common_1[(_0xc56c75(0x167))](_0xc56c75(0x14c),common_1[_0xc56c75(0x16b)][_0xc56c75(0x157)]);return _0x349626;}async[_0x3785c8(0x159)](_0x5b358a){const _0x454bc6=_0x3785c8,{captchaId:_0x150e3a,captchaCode:_0x4b316a}=_0x5b358a,_0x1d4cd2=await this['globalConfigService'][_0x454bc6(0x169)](),_0x548d22=_0x1d4cd2+':CAPTCHA:'+_0x150e3a,_0x5b12cf=await this[_0x454bc6(0x16c)]['get']({'key':_0x548d22});await this[_0x454bc6(0x16c)][_0x454bc6(0x153)]({'key':_0x548d22});if(!_0x5b12cf)throw new common_1[(_0x454bc6(0x167))](_0x454bc6(0x186),common_1[_0x454bc6(0x16b)][_0x454bc6(0x157)]);if(!_0x5b12cf||_0x5b12cf!==_0x4b316a)throw new common_1[(_0x454bc6(0x167))](_0x454bc6(0x150),common_1['HttpStatus'][_0x454bc6(0x157)]);}async[_0x3785c8(0x154)](_0x346706){const _0x3334fe=_0x3785c8,{accessKeyId:_0xb8c90c,accessKeySecret:_0x1d3bfa,SignName:_0x49a844,TemplateCode:_0x58d24a}=await this['globalConfigService'][_0x3334fe(0x141)](),{phone:_0xcd850c,code:_0x5782eb}=_0x346706;if(!_0xcd850c||!_0x5782eb)throw new common_1[(_0x3334fe(0x167))](_0x3334fe(0x149),common_1[_0x3334fe(0x16b)][_0x3334fe(0x157)]);const _0x53b0d8=new Core({'accessKeyId':_0xb8c90c,'accessKeySecret':_0x1d3bfa,'endpoint':_0x3334fe(0x180),'apiVersion':'2017-05-25'}),_0x4db02e={'PhoneNumbers':_0xcd850c,'SignName':_0x49a844,'TemplateCode':_0x58d24a,'TemplateParam':JSON[_0x3334fe(0x14e)]({'code':_0x5782eb})},_0x5d19d1={'method':_0x3334fe(0x140),'formatParams':![]};try{const _0x5f39bc=await _0x53b0d8['request'](_0x3334fe(0x165),_0x4db02e,_0x5d19d1);if(_0x5f39bc[_0x3334fe(0x171)]==='OK')return!![];else throw new common_1[(_0x3334fe(0x167))](_0x5f39bc[_0x3334fe(0x17d)]||_0x3334fe(0x14b),common_1[_0x3334fe(0x16b)]['BAD_REQUEST']);}catch(_0x5a7e4a){throw new common_1[(_0x3334fe(0x167))](_0x5a7e4a?.[_0x3334fe(0x172)]?.[_0x3334fe(0x17d)]||_0x3334fe(0x14b),common_1[_0x3334fe(0x16b)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3785c8(0x14d)])(verifycation_entity_1[_0x3785c8(0x183)])),__metadata(_0x3785c8(0x178),[typeorm_2[_0x3785c8(0x16e)],globalConfig_service_1[_0x3785c8(0x16f)],redisCache_service_1['RedisCacheService']])],VerificationService),exports['VerificationService']=VerificationService;