'use strict';const _0x10a4ef=_0x5d19;function _0x3bdf(){const _0x2b5d02=['390ViwcGQ','../globalConfig/globalConfig.service','224412vPsokp','验证码错误','确实必要参数错误！','GlobalConfigService','request','16379ddfqvL','HttpStatus','getPhoneVerifyConfig','design:paramtypes','__param','getOwnPropertyDescriptor','metadata','58144ZyDStJ','USED','4668PGuFZj','findOne','2017-05-25','./verifycation.entity','stringify','20KlFnWh','S内不得重新发送','redisCacheService','48130IjcoJO','save','BAD_REQUEST','POST','DESC','typeorm','验证码发送失败！','Repository','ceil','decorate','globalConfigService','Injectable','207XzkBvg','HttpException','getTime','__decorate','used','function','52902IQoBBo','../../common/utils','object','SendSms','@alicloud/pop-core','verifyCaptcha','InjectRepository','__metadata','code','defineProperty','VerificationUseStatusEnum','VerificationService','@nestjs/common','Message','verifycationEntity','RedisCacheService','createdAt','188DbdcqA','4YmSKLp','sendPhoneCode','1295098ddSGFN','update','getNamespace','now','https://dysmsapi.aliyuncs.com','@nestjs/typeorm','createRandomCode','verifyCode'];_0x3bdf=function(){return _0x2b5d02;};return _0x3bdf();}(function(_0x10f32f,_0x56caf2){const _0x162ad4=_0x5d19,_0x55ad45=_0x10f32f();while(!![]){try{const _0x1d6f18=-parseInt(_0x162ad4(0x110))/0x1*(-parseInt(_0x162ad4(0xec))/0x2)+-parseInt(_0x162ad4(0xf8))/0x3*(parseInt(_0x162ad4(0x10f))/0x4)+-parseInt(_0x162ad4(0xe9))/0x5*(parseInt(_0x162ad4(0x11c))/0x6)+parseInt(_0x162ad4(0x112))/0x7+parseInt(_0x162ad4(0x128))/0x8+parseInt(_0x162ad4(0xfe))/0x9*(-parseInt(_0x162ad4(0x11a))/0xa)+parseInt(_0x162ad4(0x121))/0xb*(parseInt(_0x162ad4(0x12a))/0xc);if(_0x1d6f18===_0x56caf2)break;else _0x55ad45['push'](_0x55ad45['shift']());}catch(_0x1360a9){_0x55ad45['push'](_0x55ad45['shift']());}}}(_0x3bdf,0x76926));var __decorate=this&&this[_0x10a4ef(0xfb)]||function(_0x1e373d,_0x392522,_0x21ccb8,_0x263590){const _0x5c4c4b=_0x10a4ef;var _0x243888=arguments['length'],_0x40ea9f=_0x243888<0x3?_0x392522:_0x263590===null?_0x263590=Object[_0x5c4c4b(0x126)](_0x392522,_0x21ccb8):_0x263590,_0x168635;if(typeof Reflect===_0x5c4c4b(0x100)&&typeof Reflect[_0x5c4c4b(0xf5)]===_0x5c4c4b(0xfd))_0x40ea9f=Reflect[_0x5c4c4b(0xf5)](_0x1e373d,_0x392522,_0x21ccb8,_0x263590);else{for(var _0x367db4=_0x1e373d['length']-0x1;_0x367db4>=0x0;_0x367db4--)if(_0x168635=_0x1e373d[_0x367db4])_0x40ea9f=(_0x243888<0x3?_0x168635(_0x40ea9f):_0x243888>0x3?_0x168635(_0x392522,_0x21ccb8,_0x40ea9f):_0x168635(_0x392522,_0x21ccb8))||_0x40ea9f;}return _0x243888>0x3&&_0x40ea9f&&Object['defineProperty'](_0x392522,_0x21ccb8,_0x40ea9f),_0x40ea9f;},__metadata=this&&this[_0x10a4ef(0x105)]||function(_0x5a7226,_0x23363a){const _0xb4ddf2=_0x10a4ef;if(typeof Reflect==='object'&&typeof Reflect[_0xb4ddf2(0x127)]===_0xb4ddf2(0xfd))return Reflect['metadata'](_0x5a7226,_0x23363a);},__param=this&&this[_0x10a4ef(0x125)]||function(_0xfc08a5,_0x5e624f){return function(_0xc68546,_0x4e32ef){_0x5e624f(_0xc68546,_0x4e32ef,_0xfc08a5);};};Object[_0x10a4ef(0x107)](exports,'__esModule',{'value':!![]}),exports[_0x10a4ef(0x109)]=void 0x0;const globalConfig_service_1=require(_0x10a4ef(0x11b)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x10a4ef(0x117)),typeorm_2=require(_0x10a4ef(0xf1)),verifycation_entity_1=require(_0x10a4ef(0x12d)),common_1=require(_0x10a4ef(0x10a)),utils_1=require(_0x10a4ef(0xff)),redisCache_service_1=require('../redisCache/redisCache.service'),Core=require(_0x10a4ef(0x102));function _0x5d19(_0x599078,_0x4d5129){const _0x3bdf0d=_0x3bdf();return _0x5d19=function(_0x5d1987,_0xd5276d){_0x5d1987=_0x5d1987-0xe8;let _0xb137fd=_0x3bdf0d[_0x5d1987];return _0xb137fd;},_0x5d19(_0x599078,_0x4d5129);}let VerificationService=class VerificationService{constructor(_0x19746c,_0x125872,_0x20ea85){const _0x234a49=_0x10a4ef;this[_0x234a49(0x10c)]=_0x19746c,this['globalConfigService']=_0x125872,this[_0x234a49(0xeb)]=_0x20ea85;}async['createVerification'](_0x4703d2,_0x432877,_0x1fafce=0x1e*0x3c){const _0x1edb82=_0x10a4ef,_0xb7e2d3=await this['verifycationEntity'][_0x1edb82(0x12b)]({'where':{'userId':_0x4703d2['id'],'type':_0x432877},'order':{'createdAt':_0x1edb82(0xf0)}});if(_0xb7e2d3&&_0xb7e2d3[_0x1edb82(0x10e)]['getTime']()+0x1*0x3c*0x3e8>Date['now']()){const _0x5dfc87=Math[_0x1edb82(0xf4)]((_0xb7e2d3[_0x1edb82(0x10e)][_0x1edb82(0xfa)]()+0x1*0x3c*0x3e8-Date[_0x1edb82(0x115)]())/0x3e8);throw new common_1[(_0x1edb82(0xf9))](_0x5dfc87+_0x1edb82(0xea),common_1[_0x1edb82(0x122)]['BAD_REQUEST']);}const _0x3a8835=(0x0,utils_1[_0x1edb82(0x118)])(),_0x4023d8=new Date(Date[_0x1edb82(0x115)]()+_0x1fafce*0x3e8),{id:_0x50bd51,email:_0x28d653}=_0x4703d2,_0x529c58={'userId':_0x50bd51,'type':_0x432877,'code':_0x3a8835,'expiresAt':_0x4023d8,'email':_0x28d653};return await this[_0x1edb82(0x10c)][_0x1edb82(0xed)](_0x529c58);}async[_0x10a4ef(0x119)]({code:_0x27fe15,id:_0x516607},_0x35cc02){const _0x1ae872=_0x10a4ef,_0x247e24=await this[_0x1ae872(0x10c)][_0x1ae872(0x12b)]({'where':{'id':_0x516607,'type':_0x35cc02},'order':{'createdAt':_0x1ae872(0xf0)}});if(!_0x247e24)throw new common_1[(_0x1ae872(0xf9))]('验证码不存在',common_1[_0x1ae872(0x122)][_0x1ae872(0xee)]);if(_0x247e24[_0x1ae872(0xfc)]===status_constant_1[_0x1ae872(0x108)][_0x1ae872(0x129)])throw new common_1[(_0x1ae872(0xf9))]('当前验证码已被使用！',common_1['HttpStatus'][_0x1ae872(0xee)]);else _0x247e24[_0x1ae872(0xfc)]=status_constant_1[_0x1ae872(0x108)][_0x1ae872(0x129)],await this[_0x1ae872(0x10c)][_0x1ae872(0x113)]({'id':_0x516607},_0x247e24);if(Number(_0x247e24[_0x1ae872(0x106)])!==Number(_0x27fe15))throw new common_1[(_0x1ae872(0xf9))](_0x1ae872(0x11d),common_1[_0x1ae872(0x122)][_0x1ae872(0xee)]);if(_0x247e24['expiresAt']<new Date())throw new common_1[(_0x1ae872(0xf9))]('验证码已过期',common_1[_0x1ae872(0x122)][_0x1ae872(0xee)]);return _0x247e24;}async[_0x10a4ef(0x103)](_0x4cd9e2){const _0x24ed75=_0x10a4ef,{captchaId:_0x355c89,captchaCode:_0x12a6a7}=_0x4cd9e2,_0x493842=await this[_0x24ed75(0xf6)][_0x24ed75(0x114)](),_0x25ddc8=_0x493842+':CAPTCHA:'+_0x355c89,_0x219671=await this[_0x24ed75(0xeb)]['get']({'key':_0x25ddc8});await this[_0x24ed75(0xeb)]['del']({'key':_0x25ddc8});if(!_0x219671)throw new common_1['HttpException']('图形验证码已过期、请重新输入!',common_1['HttpStatus'][_0x24ed75(0xee)]);if(!_0x219671||_0x219671!==_0x12a6a7)throw new common_1[(_0x24ed75(0xf9))]('图形验证码错误、请检查填写!',common_1[_0x24ed75(0x122)]['BAD_REQUEST']);}async[_0x10a4ef(0x111)](_0x965999){const _0x53bbbe=_0x10a4ef,{accessKeyId:_0x3031ac,accessKeySecret:_0x1beeef,SignName:_0x3ba968,TemplateCode:_0x5869b6}=await this[_0x53bbbe(0xf6)][_0x53bbbe(0x123)](),{phone:_0x2c8cf8,code:_0x16df83}=_0x965999;if(!_0x2c8cf8||!_0x16df83)throw new common_1['HttpException'](_0x53bbbe(0x11e),common_1[_0x53bbbe(0x122)]['BAD_REQUEST']);const _0x1e3d38=new Core({'accessKeyId':_0x3031ac,'accessKeySecret':_0x1beeef,'endpoint':_0x53bbbe(0x116),'apiVersion':_0x53bbbe(0x12c)}),_0x201c3d={'PhoneNumbers':_0x2c8cf8,'SignName':_0x3ba968,'TemplateCode':_0x5869b6,'TemplateParam':JSON[_0x53bbbe(0xe8)]({'code':_0x16df83})},_0x4629ea={'method':_0x53bbbe(0xef),'formatParams':![]};try{const _0x225abf=await _0x1e3d38[_0x53bbbe(0x120)](_0x53bbbe(0x101),_0x201c3d,_0x4629ea);if(_0x225abf['Code']==='OK')return!![];else throw new common_1[(_0x53bbbe(0xf9))](_0x225abf[_0x53bbbe(0x10b)]||'验证码发送失败！',common_1[_0x53bbbe(0x122)][_0x53bbbe(0xee)]);}catch(_0x25f5d0){throw new common_1['HttpException'](_0x25f5d0?.['data']?.['Message']||_0x53bbbe(0xf2),common_1[_0x53bbbe(0x122)][_0x53bbbe(0xee)]);}}};VerificationService=__decorate([(0x0,common_1[_0x10a4ef(0xf7)])(),__param(0x0,(0x0,typeorm_1[_0x10a4ef(0x104)])(verifycation_entity_1['VerifycationEntity'])),__metadata(_0x10a4ef(0x124),[typeorm_2[_0x10a4ef(0xf3)],globalConfig_service_1[_0x10a4ef(0x11f)],redisCache_service_1[_0x10a4ef(0x10d)]])],VerificationService),exports[_0x10a4ef(0x109)]=VerificationService;