'use strict';const _0x4ea58b=_0x4d12;(function(_0x4a0734,_0x43b768){const _0x8ac20=_0x4d12,_0x17a1a1=_0x4a0734();while(!![]){try{const _0x38c70e=-parseInt(_0x8ac20(0x11b))/0x1+-parseInt(_0x8ac20(0x118))/0x2+-parseInt(_0x8ac20(0x126))/0x3*(-parseInt(_0x8ac20(0x119))/0x4)+-parseInt(_0x8ac20(0x125))/0x5+parseInt(_0x8ac20(0x115))/0x6+parseInt(_0x8ac20(0x131))/0x7*(parseInt(_0x8ac20(0x12c))/0x8)+parseInt(_0x8ac20(0x10f))/0x9*(parseInt(_0x8ac20(0x10b))/0xa);if(_0x38c70e===_0x43b768)break;else _0x17a1a1['push'](_0x17a1a1['shift']());}catch(_0x5275b8){_0x17a1a1['push'](_0x17a1a1['shift']());}}}(_0x2067,0xe0bc0));function _0x4d12(_0x39ee53,_0x5eb36a){const _0x20670a=_0x2067();return _0x4d12=function(_0x4d1263,_0xf675af){_0x4d1263=_0x4d1263-0x102;let _0x270136=_0x20670a[_0x4d1263];return _0x270136;},_0x4d12(_0x39ee53,_0x5eb36a);}function _0x2067(){const _0x270375=['__metadata','Repository','createRandomCode','function','HttpStatus','S内不得重新发送','21950DWfSzC','../../common/utils','Message','used','7506mrPwYc','https://dysmsapi.aliyuncs.com','VerificationUseStatusEnum','../../common/constants/status.constant','DESC','HttpException','7088280KqKEGc','当前验证码已被使用！','length','89842aqGwkV','3932XhsdQF','../redisCache/redisCache.service','1516119lVElDc','VerifycationEntity','../globalConfig/globalConfig.service','__decorate','getNamespace','BAD_REQUEST','验证码错误','decorate','__param','__esModule','7122170KrvpfL','738YIsVXU','图形验证码已过期、请重新输入!','验证码发送失败！','验证码不存在','RedisCacheService','createdAt','8kUGzWj','expiresAt','globalConfigService','get','now','4565106OIuYVq','VerificationService','@nestjs/typeorm','sendPhoneCode','verifycationEntity','del','defineProperty','USED','Code','code','getTime','图形验证码错误、请检查填写!','getOwnPropertyDescriptor','redisCacheService','typeorm','metadata','@nestjs/common','data','InjectRepository','object'];_0x2067=function(){return _0x270375;};return _0x2067();}var __decorate=this&&this[_0x4ea58b(0x11e)]||function(_0x1932f8,_0x2c78d2,_0x5714b9,_0x170a77){const _0x358502=_0x4ea58b;var _0x44f1ac=arguments[_0x358502(0x117)],_0x4f413f=_0x44f1ac<0x3?_0x2c78d2:_0x170a77===null?_0x170a77=Object[_0x358502(0x13d)](_0x2c78d2,_0x5714b9):_0x170a77,_0x5503c5;if(typeof Reflect===_0x358502(0x104)&&typeof Reflect[_0x358502(0x122)]===_0x358502(0x108))_0x4f413f=Reflect[_0x358502(0x122)](_0x1932f8,_0x2c78d2,_0x5714b9,_0x170a77);else{for(var _0x4668b4=_0x1932f8[_0x358502(0x117)]-0x1;_0x4668b4>=0x0;_0x4668b4--)if(_0x5503c5=_0x1932f8[_0x4668b4])_0x4f413f=(_0x44f1ac<0x3?_0x5503c5(_0x4f413f):_0x44f1ac>0x3?_0x5503c5(_0x2c78d2,_0x5714b9,_0x4f413f):_0x5503c5(_0x2c78d2,_0x5714b9))||_0x4f413f;}return _0x44f1ac>0x3&&_0x4f413f&&Object['defineProperty'](_0x2c78d2,_0x5714b9,_0x4f413f),_0x4f413f;},__metadata=this&&this[_0x4ea58b(0x105)]||function(_0x541fa2,_0x8f34f9){const _0x3ce470=_0x4ea58b;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x3ce470(0x140)](_0x541fa2,_0x8f34f9);},__param=this&&this[_0x4ea58b(0x123)]||function(_0x203637,_0x32328e){return function(_0x4c253f,_0x92b4e2){_0x32328e(_0x4c253f,_0x92b4e2,_0x203637);};};Object[_0x4ea58b(0x137)](exports,_0x4ea58b(0x124),{'value':!![]}),exports[_0x4ea58b(0x132)]=void 0x0;const globalConfig_service_1=require(_0x4ea58b(0x11d)),status_constant_1=require(_0x4ea58b(0x112)),typeorm_1=require(_0x4ea58b(0x133)),typeorm_2=require(_0x4ea58b(0x13f)),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x4ea58b(0x141)),utils_1=require(_0x4ea58b(0x10c)),redisCache_service_1=require(_0x4ea58b(0x11a)),Core=require('@alicloud/pop-core');let VerificationService=class VerificationService{constructor(_0x18afc3,_0x54a78b,_0x313bde){const _0x88d93e=_0x4ea58b;this[_0x88d93e(0x135)]=_0x18afc3,this['globalConfigService']=_0x54a78b,this[_0x88d93e(0x13e)]=_0x313bde;}async['createVerification'](_0x1f7039,_0x4a7b56,_0x3f9352=0x1e*0x3c){const _0xf780e2=_0x4ea58b,_0x40a11d=await this[_0xf780e2(0x135)]['findOne']({'where':{'userId':_0x1f7039['id'],'type':_0x4a7b56},'order':{'createdAt':_0xf780e2(0x113)}});if(_0x40a11d&&_0x40a11d[_0xf780e2(0x12b)]['getTime']()+0x1*0x3c*0x3e8>Date[_0xf780e2(0x130)]()){const _0x233180=Math['ceil']((_0x40a11d[_0xf780e2(0x12b)][_0xf780e2(0x13b)]()+0x1*0x3c*0x3e8-Date[_0xf780e2(0x130)]())/0x3e8);throw new common_1[(_0xf780e2(0x114))](_0x233180+_0xf780e2(0x10a),common_1[_0xf780e2(0x109)][_0xf780e2(0x120)]);}const _0x1e625b=(0x0,utils_1[_0xf780e2(0x107)])(),_0x5e4219=new Date(Date[_0xf780e2(0x130)]()+_0x3f9352*0x3e8),{id:_0x2ac29e,email:_0x26ee64}=_0x1f7039,_0x28287c={'userId':_0x2ac29e,'type':_0x4a7b56,'code':_0x1e625b,'expiresAt':_0x5e4219,'email':_0x26ee64};return await this['verifycationEntity']['save'](_0x28287c);}async['verifyCode']({code:_0x129559,id:_0x40bd70},_0x4862b9){const _0x12c39d=_0x4ea58b,_0xbf713c=await this['verifycationEntity']['findOne']({'where':{'id':_0x40bd70,'type':_0x4862b9},'order':{'createdAt':_0x12c39d(0x113)}});if(!_0xbf713c)throw new common_1[(_0x12c39d(0x114))](_0x12c39d(0x129),common_1[_0x12c39d(0x109)]['BAD_REQUEST']);if(_0xbf713c[_0x12c39d(0x10e)]===status_constant_1[_0x12c39d(0x111)][_0x12c39d(0x138)])throw new common_1[(_0x12c39d(0x114))](_0x12c39d(0x116),common_1['HttpStatus'][_0x12c39d(0x120)]);else _0xbf713c[_0x12c39d(0x10e)]=status_constant_1[_0x12c39d(0x111)][_0x12c39d(0x138)],await this[_0x12c39d(0x135)]['update']({'id':_0x40bd70},_0xbf713c);if(Number(_0xbf713c[_0x12c39d(0x13a)])!==Number(_0x129559))throw new common_1[(_0x12c39d(0x114))](_0x12c39d(0x121),common_1[_0x12c39d(0x109)][_0x12c39d(0x120)]);if(_0xbf713c[_0x12c39d(0x12d)]<new Date())throw new common_1[(_0x12c39d(0x114))]('验证码已过期',common_1[_0x12c39d(0x109)][_0x12c39d(0x120)]);return _0xbf713c;}async['verifyCaptcha'](_0x3faa7c){const _0xfcdfbf=_0x4ea58b,{captchaId:_0x2f9015,captchaCode:_0xf50a4c}=_0x3faa7c,_0x2f9cde=await this[_0xfcdfbf(0x12e)][_0xfcdfbf(0x11f)](),_0x3a66e6=_0x2f9cde+':CAPTCHA:'+_0x2f9015,_0xa6931f=await this[_0xfcdfbf(0x13e)][_0xfcdfbf(0x12f)]({'key':_0x3a66e6});await this[_0xfcdfbf(0x13e)][_0xfcdfbf(0x136)]({'key':_0x3a66e6});if(!_0xa6931f)throw new common_1[(_0xfcdfbf(0x114))](_0xfcdfbf(0x127),common_1[_0xfcdfbf(0x109)]['BAD_REQUEST']);if(!_0xa6931f||_0xa6931f!==_0xf50a4c)throw new common_1['HttpException'](_0xfcdfbf(0x13c),common_1[_0xfcdfbf(0x109)]['BAD_REQUEST']);}async[_0x4ea58b(0x134)](_0x4a62ea){const _0x3d17b4=_0x4ea58b,{accessKeyId:_0x482c0e,accessKeySecret:_0x2d708e,SignName:_0x34b1b2,TemplateCode:_0x55969c}=await this[_0x3d17b4(0x12e)]['getPhoneVerifyConfig'](),{phone:_0x5d3730,code:_0x481f40}=_0x4a62ea;if(!_0x5d3730||!_0x481f40)throw new common_1[(_0x3d17b4(0x114))]('确实必要参数错误！',common_1[_0x3d17b4(0x109)]['BAD_REQUEST']);const _0x417e1d=new Core({'accessKeyId':_0x482c0e,'accessKeySecret':_0x2d708e,'endpoint':_0x3d17b4(0x110),'apiVersion':'2017-05-25'}),_0x133fd8={'PhoneNumbers':_0x5d3730,'SignName':_0x34b1b2,'TemplateCode':_0x55969c,'TemplateParam':JSON['stringify']({'code':_0x481f40})},_0x5456d3={'method':'POST','formatParams':![]};try{const _0x42ff90=await _0x417e1d['request']('SendSms',_0x133fd8,_0x5456d3);if(_0x42ff90[_0x3d17b4(0x139)]==='OK')return!![];else throw new common_1['HttpException'](_0x42ff90['Message']||_0x3d17b4(0x128),common_1['HttpStatus'][_0x3d17b4(0x120)]);}catch(_0x4c71a5){throw new common_1[(_0x3d17b4(0x114))](_0x4c71a5?.[_0x3d17b4(0x102)]?.[_0x3d17b4(0x10d)]||_0x3d17b4(0x128),common_1[_0x3d17b4(0x109)][_0x3d17b4(0x120)]);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x4ea58b(0x103)])(verifycation_entity_1[_0x4ea58b(0x11c)])),__metadata('design:paramtypes',[typeorm_2[_0x4ea58b(0x106)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x4ea58b(0x12a)]])],VerificationService),exports[_0x4ea58b(0x132)]=VerificationService;