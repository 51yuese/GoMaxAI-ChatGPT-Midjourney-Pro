'use strict';function _0x1088(_0x2ffade,_0x3f8a4f){const _0x1c2521=_0x1c25();return _0x1088=function(_0x108817,_0x53a8ac){_0x108817=_0x108817-0x177;let _0x3bf40a=_0x1c2521[_0x108817];return _0x3bf40a;},_0x1088(_0x2ffade,_0x3f8a4f);}const _0x569f24=_0x1088;(function(_0x470fbb,_0x18435d){const _0x2dfe01=_0x1088,_0x1a9f2d=_0x470fbb();while(!![]){try{const _0x22fb02=-parseInt(_0x2dfe01(0x18c))/0x1+parseInt(_0x2dfe01(0x186))/0x2*(-parseInt(_0x2dfe01(0x197))/0x3)+parseInt(_0x2dfe01(0x1a8))/0x4*(parseInt(_0x2dfe01(0x180))/0x5)+-parseInt(_0x2dfe01(0x1bf))/0x6+parseInt(_0x2dfe01(0x1bc))/0x7*(parseInt(_0x2dfe01(0x1ab))/0x8)+-parseInt(_0x2dfe01(0x187))/0x9+parseInt(_0x2dfe01(0x18e))/0xa;if(_0x22fb02===_0x18435d)break;else _0x1a9f2d['push'](_0x1a9f2d['shift']());}catch(_0x215688){_0x1a9f2d['push'](_0x1a9f2d['shift']());}}}(_0x1c25,0x424fd));var __decorate=this&&this['__decorate']||function(_0x3530c0,_0x3c5f1b,_0x4a1299,_0x1f2d82){const _0x139b57=_0x1088;var _0x6af0f3=arguments[_0x139b57(0x1ad)],_0x2d71f9=_0x6af0f3<0x3?_0x3c5f1b:_0x1f2d82===null?_0x1f2d82=Object[_0x139b57(0x19e)](_0x3c5f1b,_0x4a1299):_0x1f2d82,_0x3dcbde;if(typeof Reflect===_0x139b57(0x1b5)&&typeof Reflect['decorate']===_0x139b57(0x177))_0x2d71f9=Reflect['decorate'](_0x3530c0,_0x3c5f1b,_0x4a1299,_0x1f2d82);else{for(var _0x2117f2=_0x3530c0['length']-0x1;_0x2117f2>=0x0;_0x2117f2--)if(_0x3dcbde=_0x3530c0[_0x2117f2])_0x2d71f9=(_0x6af0f3<0x3?_0x3dcbde(_0x2d71f9):_0x6af0f3>0x3?_0x3dcbde(_0x3c5f1b,_0x4a1299,_0x2d71f9):_0x3dcbde(_0x3c5f1b,_0x4a1299))||_0x2d71f9;}return _0x6af0f3>0x3&&_0x2d71f9&&Object[_0x139b57(0x19a)](_0x3c5f1b,_0x4a1299,_0x2d71f9),_0x2d71f9;},__metadata=this&&this[_0x569f24(0x1aa)]||function(_0x503eac,_0x31d531){const _0x206502=_0x569f24;if(typeof Reflect===_0x206502(0x1b5)&&typeof Reflect['metadata']===_0x206502(0x177))return Reflect[_0x206502(0x18a)](_0x503eac,_0x31d531);},__param=this&&this[_0x569f24(0x1a2)]||function(_0x2f68fd,_0x48f8ac){return function(_0xd54901,_0x50f4d0){_0x48f8ac(_0xd54901,_0x50f4d0,_0x2f68fd);};};Object[_0x569f24(0x19a)](exports,'__esModule',{'value':!![]}),exports[_0x569f24(0x18f)]=void 0x0;const globalConfig_service_1=require(_0x569f24(0x19b)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x569f24(0x1b3)),typeorm_2=require(_0x569f24(0x183)),verifycation_entity_1=require(_0x569f24(0x19d)),common_1=require(_0x569f24(0x1ae)),utils_1=require(_0x569f24(0x1b0)),redisCache_service_1=require(_0x569f24(0x1a5)),Core=require(_0x569f24(0x1b8));function _0x1c25(){const _0x319e6e=['HttpStatus','del','defineProperty','../globalConfig/globalConfig.service','BAD_REQUEST','./verifycation.entity','getOwnPropertyDescriptor','verifycationEntity','getTime','USED','__param','design:paramtypes','data','../redisCache/redisCache.service','sendPhoneCode','DESC','914152mrfpKn','used','__metadata','7000DpBnjH','createdAt','length','@nestjs/common','createRandomCode','../../common/utils','stringify','now','@nestjs/typeorm','HttpException','object','https://dysmsapi.aliyuncs.com','GlobalConfigService','@alicloud/pop-core','get','当前验证码已被使用！','图形验证码错误、请检查填写!','14HueWeu','Repository','Message','922146PdsLVn','function','验证码错误','globalConfigService','RedisCacheService','图形验证码已过期、请重新输入!','验证码已过期','redisCacheService','verifyCode','createVerification','10GKGDBl','确实必要参数错误！','InjectRepository','typeorm','ceil','验证码发送失败！','271290OdnXkC','763218aUtUtm','findOne','expiresAt','metadata','getNamespace','295200ywmjOm','request','4821250WiSLTn','VerificationService','2017-05-25','Code','code','S内不得重新发送','getPhoneVerifyConfig','VerificationUseStatusEnum',':CAPTCHA:','3fXhXkZ'];_0x1c25=function(){return _0x319e6e;};return _0x1c25();}let VerificationService=class VerificationService{constructor(_0x47dfb4,_0x47e088,_0x163934){const _0x306d81=_0x569f24;this['verifycationEntity']=_0x47dfb4,this[_0x306d81(0x179)]=_0x47e088,this[_0x306d81(0x17d)]=_0x163934;}async[_0x569f24(0x17f)](_0x46429d,_0x4d4dc6,_0x245ca1=0x1e*0x3c){const _0x1282d2=_0x569f24,_0x1e7a5d=await this[_0x1282d2(0x19f)][_0x1282d2(0x188)]({'where':{'userId':_0x46429d['id'],'type':_0x4d4dc6},'order':{'createdAt':_0x1282d2(0x1a7)}});if(_0x1e7a5d&&_0x1e7a5d[_0x1282d2(0x1ac)][_0x1282d2(0x1a0)]()+0x1*0x3c*0x3e8>Date[_0x1282d2(0x1b2)]()){const _0x5427b2=Math[_0x1282d2(0x184)]((_0x1e7a5d[_0x1282d2(0x1ac)][_0x1282d2(0x1a0)]()+0x1*0x3c*0x3e8-Date[_0x1282d2(0x1b2)]())/0x3e8);throw new common_1['HttpException'](_0x5427b2+_0x1282d2(0x193),common_1[_0x1282d2(0x198)][_0x1282d2(0x19c)]);}const _0x55ae5a=(0x0,utils_1[_0x1282d2(0x1af)])(),_0x239a62=new Date(Date[_0x1282d2(0x1b2)]()+_0x245ca1*0x3e8),{id:_0x53dcbd,email:_0x50e653}=_0x46429d,_0x442ec0={'userId':_0x53dcbd,'type':_0x4d4dc6,'code':_0x55ae5a,'expiresAt':_0x239a62,'email':_0x50e653};return await this[_0x1282d2(0x19f)]['save'](_0x442ec0);}async[_0x569f24(0x17e)]({code:_0x3ed061,id:_0x5450c9},_0x5e7000){const _0x478d57=_0x569f24,_0x21079e=await this[_0x478d57(0x19f)][_0x478d57(0x188)]({'where':{'id':_0x5450c9,'type':_0x5e7000},'order':{'createdAt':'DESC'}});if(!_0x21079e)throw new common_1[(_0x478d57(0x1b4))]('验证码不存在',common_1['HttpStatus'][_0x478d57(0x19c)]);if(_0x21079e[_0x478d57(0x1a9)]===status_constant_1[_0x478d57(0x195)][_0x478d57(0x1a1)])throw new common_1[(_0x478d57(0x1b4))](_0x478d57(0x1ba),common_1[_0x478d57(0x198)][_0x478d57(0x19c)]);else _0x21079e['used']=status_constant_1['VerificationUseStatusEnum']['USED'],await this[_0x478d57(0x19f)]['update']({'id':_0x5450c9},_0x21079e);if(Number(_0x21079e[_0x478d57(0x192)])!==Number(_0x3ed061))throw new common_1[(_0x478d57(0x1b4))](_0x478d57(0x178),common_1[_0x478d57(0x198)][_0x478d57(0x19c)]);if(_0x21079e[_0x478d57(0x189)]<new Date())throw new common_1[(_0x478d57(0x1b4))](_0x478d57(0x17c),common_1[_0x478d57(0x198)][_0x478d57(0x19c)]);return _0x21079e;}async['verifyCaptcha'](_0x3c1359){const _0x21cf99=_0x569f24,{captchaId:_0x3297e5,captchaCode:_0x4ac6da}=_0x3c1359,_0x29cb36=await this[_0x21cf99(0x179)][_0x21cf99(0x18b)](),_0x15a272=_0x29cb36+_0x21cf99(0x196)+_0x3297e5,_0x74c201=await this[_0x21cf99(0x17d)][_0x21cf99(0x1b9)]({'key':_0x15a272});await this['redisCacheService'][_0x21cf99(0x199)]({'key':_0x15a272});if(!_0x74c201)throw new common_1[(_0x21cf99(0x1b4))](_0x21cf99(0x17b),common_1[_0x21cf99(0x198)][_0x21cf99(0x19c)]);if(!_0x74c201||_0x74c201!==_0x4ac6da)throw new common_1[(_0x21cf99(0x1b4))](_0x21cf99(0x1bb),common_1[_0x21cf99(0x198)][_0x21cf99(0x19c)]);}async[_0x569f24(0x1a6)](_0x40bbc1){const _0x488553=_0x569f24,{accessKeyId:_0x5b47ca,accessKeySecret:_0x443c74,SignName:_0xf27ef,TemplateCode:_0x5646a5}=await this[_0x488553(0x179)][_0x488553(0x194)](),{phone:_0x272f29,code:_0x24683b}=_0x40bbc1;if(!_0x272f29||!_0x24683b)throw new common_1[(_0x488553(0x1b4))](_0x488553(0x181),common_1[_0x488553(0x198)][_0x488553(0x19c)]);const _0x266d2e=new Core({'accessKeyId':_0x5b47ca,'accessKeySecret':_0x443c74,'endpoint':_0x488553(0x1b6),'apiVersion':_0x488553(0x190)}),_0x30a434={'PhoneNumbers':_0x272f29,'SignName':_0xf27ef,'TemplateCode':_0x5646a5,'TemplateParam':JSON[_0x488553(0x1b1)]({'code':_0x24683b})},_0x12a4cd={'method':'POST','formatParams':![]};try{const _0x51fd22=await _0x266d2e[_0x488553(0x18d)]('SendSms',_0x30a434,_0x12a4cd);if(_0x51fd22[_0x488553(0x191)]==='OK')return!![];else throw new common_1[(_0x488553(0x1b4))](_0x51fd22[_0x488553(0x1be)]||_0x488553(0x185),common_1[_0x488553(0x198)][_0x488553(0x19c)]);}catch(_0xd6126c){throw new common_1[(_0x488553(0x1b4))](_0xd6126c?.[_0x488553(0x1a4)]?.[_0x488553(0x1be)]||_0x488553(0x185),common_1[_0x488553(0x198)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x569f24(0x182)])(verifycation_entity_1['VerifycationEntity'])),__metadata(_0x569f24(0x1a3),[typeorm_2[_0x569f24(0x1bd)],globalConfig_service_1[_0x569f24(0x1b7)],redisCache_service_1[_0x569f24(0x17a)]])],VerificationService),exports['VerificationService']=VerificationService;