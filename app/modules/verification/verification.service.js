'use strict';const _0x5d0169=_0x4f27;function _0x2267(){const _0x541efe=['metadata','6476246RkLWIQ','验证码发送失败！','__decorate','4032928IGjVcP','__param','图形验证码错误、请检查填写!','298374trqIoc','Injectable','POST','getTime','del','VerificationService','905756FfBrIC','../../common/utils','GlobalConfigService','验证码已过期','当前验证码已被使用！','redisCacheService','findOne','function','createRandomCode','@alicloud/pop-core','getNamespace','Repository','RedisCacheService','验证码不存在','globalConfigService','decorate','https://dysmsapi.aliyuncs.com','verifycationEntity','../../common/constants/status.constant','HttpStatus','getOwnPropertyDescriptor','Message','request','verifyCaptcha','object','../globalConfig/globalConfig.service','DESC','2017-05-25','确实必要参数错误！','createdAt','5CcIfOn','8EWRcNz','length','../redisCache/redisCache.service','__esModule','save','图形验证码已过期、请重新输入!','Code','USED','VerifycationEntity','8825016oNHgfj','BAD_REQUEST',':CAPTCHA:','./verifycation.entity','3978936FaCcjU','typeorm','S内不得重新发送','expiresAt','now','22245903yYLITv','used','data','HttpException'];_0x2267=function(){return _0x541efe;};return _0x2267();}(function(_0x4b2a8a,_0x42ff4a){const _0x22986d=_0x4f27,_0x43be32=_0x4b2a8a();while(!![]){try{const _0x538ccb=-parseInt(_0x22986d(0xe4))/0x1+parseInt(_0x22986d(0xc1))/0x2*(-parseInt(_0x22986d(0xde))/0x3)+parseInt(_0x22986d(0xdb))/0x4*(-parseInt(_0x22986d(0xc0))/0x5)+parseInt(_0x22986d(0xce))/0x6+parseInt(_0x22986d(0xd8))/0x7+-parseInt(_0x22986d(0xca))/0x8+parseInt(_0x22986d(0xd3))/0x9;if(_0x538ccb===_0x42ff4a)break;else _0x43be32['push'](_0x43be32['shift']());}catch(_0x28c0da){_0x43be32['push'](_0x43be32['shift']());}}}(_0x2267,0x9d822));function _0x4f27(_0x119551,_0x4499be){const _0x226734=_0x2267();return _0x4f27=function(_0x4f27d9,_0x90d87f){_0x4f27d9=_0x4f27d9-0xb4;let _0x2cd275=_0x226734[_0x4f27d9];return _0x2cd275;},_0x4f27(_0x119551,_0x4499be);}var __decorate=this&&this[_0x5d0169(0xda)]||function(_0x22acc2,_0xbd8fe4,_0x15655e,_0x3a9efa){const _0x3ea877=_0x5d0169;var _0x420e07=arguments[_0x3ea877(0xc2)],_0x25459c=_0x420e07<0x3?_0xbd8fe4:_0x3a9efa===null?_0x3a9efa=Object[_0x3ea877(0xb6)](_0xbd8fe4,_0x15655e):_0x3a9efa,_0x1962ee;if(typeof Reflect==='object'&&typeof Reflect[_0x3ea877(0xf3)]===_0x3ea877(0xeb))_0x25459c=Reflect[_0x3ea877(0xf3)](_0x22acc2,_0xbd8fe4,_0x15655e,_0x3a9efa);else{for(var _0x5868ea=_0x22acc2[_0x3ea877(0xc2)]-0x1;_0x5868ea>=0x0;_0x5868ea--)if(_0x1962ee=_0x22acc2[_0x5868ea])_0x25459c=(_0x420e07<0x3?_0x1962ee(_0x25459c):_0x420e07>0x3?_0x1962ee(_0xbd8fe4,_0x15655e,_0x25459c):_0x1962ee(_0xbd8fe4,_0x15655e))||_0x25459c;}return _0x420e07>0x3&&_0x25459c&&Object['defineProperty'](_0xbd8fe4,_0x15655e,_0x25459c),_0x25459c;},__metadata=this&&this['__metadata']||function(_0x3621be,_0x399c8c){const _0x25d9c9=_0x5d0169;if(typeof Reflect===_0x25d9c9(0xba)&&typeof Reflect[_0x25d9c9(0xd7)]==='function')return Reflect[_0x25d9c9(0xd7)](_0x3621be,_0x399c8c);},__param=this&&this[_0x5d0169(0xdc)]||function(_0x23a4c2,_0x297712){return function(_0x1a313b,_0x13e1ab){_0x297712(_0x1a313b,_0x13e1ab,_0x23a4c2);};};Object['defineProperty'](exports,_0x5d0169(0xc4),{'value':!![]}),exports[_0x5d0169(0xe3)]=void 0x0;const globalConfig_service_1=require(_0x5d0169(0xbb)),status_constant_1=require(_0x5d0169(0xb4)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5d0169(0xcf)),verifycation_entity_1=require(_0x5d0169(0xcd)),common_1=require('@nestjs/common'),utils_1=require(_0x5d0169(0xe5)),redisCache_service_1=require(_0x5d0169(0xc3)),Core=require(_0x5d0169(0xed));let VerificationService=class VerificationService{constructor(_0x5b51c1,_0x2a4385,_0x1c78d9){const _0x4b93ae=_0x5d0169;this[_0x4b93ae(0xf5)]=_0x5b51c1,this[_0x4b93ae(0xf2)]=_0x2a4385,this['redisCacheService']=_0x1c78d9;}async['createVerification'](_0x2323d4,_0x20be4d,_0xa2e123=0x1e*0x3c){const _0x7c2b7a=_0x5d0169,_0x155372=await this['verifycationEntity'][_0x7c2b7a(0xea)]({'where':{'userId':_0x2323d4['id'],'type':_0x20be4d},'order':{'createdAt':_0x7c2b7a(0xbc)}});if(_0x155372&&_0x155372[_0x7c2b7a(0xbf)][_0x7c2b7a(0xe1)]()+0x1*0x3c*0x3e8>Date[_0x7c2b7a(0xd2)]()){const _0x14772a=Math['ceil']((_0x155372['createdAt'][_0x7c2b7a(0xe1)]()+0x1*0x3c*0x3e8-Date[_0x7c2b7a(0xd2)]())/0x3e8);throw new common_1[(_0x7c2b7a(0xd6))](_0x14772a+_0x7c2b7a(0xd0),common_1[_0x7c2b7a(0xb5)][_0x7c2b7a(0xcb)]);}const _0x1c8707=(0x0,utils_1[_0x7c2b7a(0xec)])(),_0x4ba377=new Date(Date[_0x7c2b7a(0xd2)]()+_0xa2e123*0x3e8),{id:_0xceea8f,email:_0x12f0c1}=_0x2323d4,_0x1dd51e={'userId':_0xceea8f,'type':_0x20be4d,'code':_0x1c8707,'expiresAt':_0x4ba377,'email':_0x12f0c1};return await this[_0x7c2b7a(0xf5)][_0x7c2b7a(0xc5)](_0x1dd51e);}async['verifyCode']({code:_0x26d2d5,id:_0x435033},_0x1a24c7){const _0x9acc4c=_0x5d0169,_0x17a899=await this['verifycationEntity'][_0x9acc4c(0xea)]({'where':{'id':_0x435033,'type':_0x1a24c7},'order':{'createdAt':_0x9acc4c(0xbc)}});if(!_0x17a899)throw new common_1[(_0x9acc4c(0xd6))](_0x9acc4c(0xf1),common_1[_0x9acc4c(0xb5)][_0x9acc4c(0xcb)]);if(_0x17a899[_0x9acc4c(0xd4)]===status_constant_1['VerificationUseStatusEnum'][_0x9acc4c(0xc8)])throw new common_1[(_0x9acc4c(0xd6))](_0x9acc4c(0xe8),common_1[_0x9acc4c(0xb5)][_0x9acc4c(0xcb)]);else _0x17a899['used']=status_constant_1['VerificationUseStatusEnum']['USED'],await this['verifycationEntity']['update']({'id':_0x435033},_0x17a899);if(Number(_0x17a899['code'])!==Number(_0x26d2d5))throw new common_1[(_0x9acc4c(0xd6))]('验证码错误',common_1['HttpStatus'][_0x9acc4c(0xcb)]);if(_0x17a899[_0x9acc4c(0xd1)]<new Date())throw new common_1[(_0x9acc4c(0xd6))](_0x9acc4c(0xe7),common_1[_0x9acc4c(0xb5)]['BAD_REQUEST']);return _0x17a899;}async[_0x5d0169(0xb9)](_0x5312c7){const _0x32cc73=_0x5d0169,{captchaId:_0x25f9cf,captchaCode:_0x161b50}=_0x5312c7,_0x475b8e=await this[_0x32cc73(0xf2)][_0x32cc73(0xee)](),_0x50d7f4=_0x475b8e+_0x32cc73(0xcc)+_0x25f9cf,_0x41df43=await this[_0x32cc73(0xe9)]['get']({'key':_0x50d7f4});await this[_0x32cc73(0xe9)][_0x32cc73(0xe2)]({'key':_0x50d7f4});if(!_0x41df43)throw new common_1['HttpException'](_0x32cc73(0xc6),common_1[_0x32cc73(0xb5)]['BAD_REQUEST']);if(!_0x41df43||_0x41df43!==_0x161b50)throw new common_1[(_0x32cc73(0xd6))](_0x32cc73(0xdd),common_1[_0x32cc73(0xb5)]['BAD_REQUEST']);}async['sendPhoneCode'](_0x2966d6){const _0x9e7cee=_0x5d0169,{accessKeyId:_0x1ab193,accessKeySecret:_0x42bb03,SignName:_0x3a6185,TemplateCode:_0x3d1e34}=await this[_0x9e7cee(0xf2)]['getPhoneVerifyConfig'](),{phone:_0x41a2d6,code:_0x1801bc}=_0x2966d6;if(!_0x41a2d6||!_0x1801bc)throw new common_1['HttpException'](_0x9e7cee(0xbe),common_1[_0x9e7cee(0xb5)][_0x9e7cee(0xcb)]);const _0x2f992a=new Core({'accessKeyId':_0x1ab193,'accessKeySecret':_0x42bb03,'endpoint':_0x9e7cee(0xf4),'apiVersion':_0x9e7cee(0xbd)}),_0x4f1dc8={'PhoneNumbers':_0x41a2d6,'SignName':_0x3a6185,'TemplateCode':_0x3d1e34,'TemplateParam':JSON['stringify']({'code':_0x1801bc})},_0x523756={'method':_0x9e7cee(0xe0),'formatParams':![]};try{const _0xe68821=await _0x2f992a[_0x9e7cee(0xb8)]('SendSms',_0x4f1dc8,_0x523756);if(_0xe68821[_0x9e7cee(0xc7)]==='OK')return!![];else throw new common_1[(_0x9e7cee(0xd6))](_0xe68821[_0x9e7cee(0xb7)]||'验证码发送失败！',common_1[_0x9e7cee(0xb5)][_0x9e7cee(0xcb)]);}catch(_0x4a4287){throw new common_1[(_0x9e7cee(0xd6))](_0x4a4287?.[_0x9e7cee(0xd5)]?.[_0x9e7cee(0xb7)]||_0x9e7cee(0xd9),common_1['HttpStatus'][_0x9e7cee(0xcb)]);}}};VerificationService=__decorate([(0x0,common_1[_0x5d0169(0xdf)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x5d0169(0xc9)])),__metadata('design:paramtypes',[typeorm_2[_0x5d0169(0xef)],globalConfig_service_1[_0x5d0169(0xe6)],redisCache_service_1[_0x5d0169(0xf0)]])],VerificationService),exports[_0x5d0169(0xe3)]=VerificationService;