'use strict';const _0x1fa046=_0x87a0;(function(_0x4bb207,_0x571660){const _0x269e05=_0x87a0,_0xf844d8=_0x4bb207();while(!![]){try{const _0x49cbfa=-parseInt(_0x269e05(0x10b))/0x1*(parseInt(_0x269e05(0x108))/0x2)+-parseInt(_0x269e05(0xf2))/0x3*(-parseInt(_0x269e05(0x111))/0x4)+parseInt(_0x269e05(0x106))/0x5+parseInt(_0x269e05(0xf4))/0x6*(-parseInt(_0x269e05(0x118))/0x7)+-parseInt(_0x269e05(0xe5))/0x8+parseInt(_0x269e05(0x109))/0x9+parseInt(_0x269e05(0x121))/0xa;if(_0x49cbfa===_0x571660)break;else _0xf844d8['push'](_0xf844d8['shift']());}catch(_0x23f447){_0xf844d8['push'](_0xf844d8['shift']());}}}(_0xf21a,0xe88f1));function _0xf21a(){const _0x538516=['10732311pjIFGp','metadata','771503dCUFMO','GlobalConfigService','Repository','图形验证码错误、请检查填写!','Code','__param','4hwzHLU','HttpStatus','createRandomCode','redisCacheService','getNamespace','data','globalConfigService','14qMoGYf','sendPhoneCode','S内不得重新发送','确实必要参数错误！','getTime','typeorm','Message','Injectable','VerificationUseStatusEnum','18368510YNpMKO','POST','del','../../common/utils','../redisCache/redisCache.service','SendSms','@nestjs/typeorm','DESC','当前验证码已被使用！','VerificationService','验证码不存在','function','decorate','2017-05-25','defineProperty','5702768qlDlVu','getPhoneVerifyConfig','used','findOne','USED','BAD_REQUEST','getOwnPropertyDescriptor','../globalConfig/globalConfig.service','验证码已过期','verifycationEntity','design:paramtypes','RedisCacheService','@alicloud/pop-core','2421261twkAqV','ceil','3152274HImwFY','验证码错误','VerifycationEntity','verifyCode','now','length','@nestjs/common','stringify','object','createdAt','./verifycation.entity','InjectRepository','验证码发送失败！','save','HttpException','get','request','code','2113770vSQLUU',':CAPTCHA:','4RdvTUT'];_0xf21a=function(){return _0x538516;};return _0xf21a();}function _0x87a0(_0x58cc54,_0x2cc0dc){const _0xf21aad=_0xf21a();return _0x87a0=function(_0x87a03e,_0x50ce53){_0x87a03e=_0x87a03e-0xdc;let _0x3ad3bc=_0xf21aad[_0x87a03e];return _0x3ad3bc;},_0x87a0(_0x58cc54,_0x2cc0dc);}var __decorate=this&&this['__decorate']||function(_0x119cd0,_0x4ea857,_0x488127,_0x3a7eb1){const _0x14dd5c=_0x87a0;var _0x3fe67d=arguments[_0x14dd5c(0xf9)],_0x47d6b4=_0x3fe67d<0x3?_0x4ea857:_0x3a7eb1===null?_0x3a7eb1=Object[_0x14dd5c(0xeb)](_0x4ea857,_0x488127):_0x3a7eb1,_0x53acab;if(typeof Reflect===_0x14dd5c(0xfc)&&typeof Reflect[_0x14dd5c(0xe2)]===_0x14dd5c(0xe1))_0x47d6b4=Reflect[_0x14dd5c(0xe2)](_0x119cd0,_0x4ea857,_0x488127,_0x3a7eb1);else{for(var _0x1d2398=_0x119cd0[_0x14dd5c(0xf9)]-0x1;_0x1d2398>=0x0;_0x1d2398--)if(_0x53acab=_0x119cd0[_0x1d2398])_0x47d6b4=(_0x3fe67d<0x3?_0x53acab(_0x47d6b4):_0x3fe67d>0x3?_0x53acab(_0x4ea857,_0x488127,_0x47d6b4):_0x53acab(_0x4ea857,_0x488127))||_0x47d6b4;}return _0x3fe67d>0x3&&_0x47d6b4&&Object[_0x14dd5c(0xe4)](_0x4ea857,_0x488127,_0x47d6b4),_0x47d6b4;},__metadata=this&&this['__metadata']||function(_0x499861,_0x12944f){const _0x462ff4=_0x87a0;if(typeof Reflect===_0x462ff4(0xfc)&&typeof Reflect[_0x462ff4(0x10a)]===_0x462ff4(0xe1))return Reflect['metadata'](_0x499861,_0x12944f);},__param=this&&this[_0x1fa046(0x110)]||function(_0x298144,_0x21f186){return function(_0x1c4394,_0x219cd7){_0x21f186(_0x1c4394,_0x219cd7,_0x298144);};};Object[_0x1fa046(0xe4)](exports,'__esModule',{'value':!![]}),exports[_0x1fa046(0xdf)]=void 0x0;const globalConfig_service_1=require(_0x1fa046(0xec)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x1fa046(0xdc)),typeorm_2=require(_0x1fa046(0x11d)),verifycation_entity_1=require(_0x1fa046(0xfe)),common_1=require(_0x1fa046(0xfa)),utils_1=require(_0x1fa046(0x124)),redisCache_service_1=require(_0x1fa046(0x125)),Core=require(_0x1fa046(0xf1));let VerificationService=class VerificationService{constructor(_0x2789c3,_0x13d2a0,_0x57d086){const _0x17e487=_0x1fa046;this[_0x17e487(0xee)]=_0x2789c3,this['globalConfigService']=_0x13d2a0,this[_0x17e487(0x114)]=_0x57d086;}async['createVerification'](_0x471bd9,_0x21225d,_0x1bf65b=0x1e*0x3c){const _0x3500dc=_0x1fa046,_0x81bf1f=await this[_0x3500dc(0xee)][_0x3500dc(0xe8)]({'where':{'userId':_0x471bd9['id'],'type':_0x21225d},'order':{'createdAt':_0x3500dc(0xdd)}});if(_0x81bf1f&&_0x81bf1f[_0x3500dc(0xfd)]['getTime']()+0x1*0x3c*0x3e8>Date[_0x3500dc(0xf8)]()){const _0x1e0176=Math[_0x3500dc(0xf3)]((_0x81bf1f['createdAt'][_0x3500dc(0x11c)]()+0x1*0x3c*0x3e8-Date[_0x3500dc(0xf8)]())/0x3e8);throw new common_1[(_0x3500dc(0x102))](_0x1e0176+_0x3500dc(0x11a),common_1['HttpStatus'][_0x3500dc(0xea)]);}const _0x51cfdc=(0x0,utils_1[_0x3500dc(0x113)])(),_0xc3794=new Date(Date['now']()+_0x1bf65b*0x3e8),{id:_0xcbb59d,email:_0x4f7f23}=_0x471bd9,_0x4ef9c9={'userId':_0xcbb59d,'type':_0x21225d,'code':_0x51cfdc,'expiresAt':_0xc3794,'email':_0x4f7f23};return await this[_0x3500dc(0xee)][_0x3500dc(0x101)](_0x4ef9c9);}async[_0x1fa046(0xf7)]({code:_0x99c24d,id:_0xfcfdfa},_0x1c0757){const _0x45808b=_0x1fa046,_0x41e2ab=await this[_0x45808b(0xee)][_0x45808b(0xe8)]({'where':{'id':_0xfcfdfa,'type':_0x1c0757},'order':{'createdAt':_0x45808b(0xdd)}});if(!_0x41e2ab)throw new common_1[(_0x45808b(0x102))](_0x45808b(0xe0),common_1[_0x45808b(0x112)][_0x45808b(0xea)]);if(_0x41e2ab[_0x45808b(0xe7)]===status_constant_1[_0x45808b(0x120)][_0x45808b(0xe9)])throw new common_1['HttpException'](_0x45808b(0xde),common_1[_0x45808b(0x112)][_0x45808b(0xea)]);else _0x41e2ab[_0x45808b(0xe7)]=status_constant_1[_0x45808b(0x120)][_0x45808b(0xe9)],await this[_0x45808b(0xee)]['update']({'id':_0xfcfdfa},_0x41e2ab);if(Number(_0x41e2ab[_0x45808b(0x105)])!==Number(_0x99c24d))throw new common_1[(_0x45808b(0x102))](_0x45808b(0xf5),common_1[_0x45808b(0x112)]['BAD_REQUEST']);if(_0x41e2ab['expiresAt']<new Date())throw new common_1[(_0x45808b(0x102))](_0x45808b(0xed),common_1[_0x45808b(0x112)]['BAD_REQUEST']);return _0x41e2ab;}async['verifyCaptcha'](_0x34534f){const _0x8115af=_0x1fa046,{captchaId:_0x34e6c9,captchaCode:_0x3dd2dc}=_0x34534f,_0x3d39ab=await this[_0x8115af(0x117)][_0x8115af(0x115)](),_0x430099=_0x3d39ab+_0x8115af(0x107)+_0x34e6c9,_0x336f83=await this[_0x8115af(0x114)][_0x8115af(0x103)]({'key':_0x430099});await this[_0x8115af(0x114)][_0x8115af(0x123)]({'key':_0x430099});if(!_0x336f83)throw new common_1[(_0x8115af(0x102))]('图形验证码已过期、请重新输入!',common_1[_0x8115af(0x112)][_0x8115af(0xea)]);if(!_0x336f83||_0x336f83!==_0x3dd2dc)throw new common_1['HttpException'](_0x8115af(0x10e),common_1[_0x8115af(0x112)][_0x8115af(0xea)]);}async[_0x1fa046(0x119)](_0x24578b){const _0xf36c0e=_0x1fa046,{accessKeyId:_0x52556c,accessKeySecret:_0x230911,SignName:_0x5b1f,TemplateCode:_0x26fed4}=await this['globalConfigService'][_0xf36c0e(0xe6)](),{phone:_0x216073,code:_0x16aa93}=_0x24578b;if(!_0x216073||!_0x16aa93)throw new common_1[(_0xf36c0e(0x102))](_0xf36c0e(0x11b),common_1['HttpStatus'][_0xf36c0e(0xea)]);const _0x46f400=new Core({'accessKeyId':_0x52556c,'accessKeySecret':_0x230911,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0xf36c0e(0xe3)}),_0x974c9e={'PhoneNumbers':_0x216073,'SignName':_0x5b1f,'TemplateCode':_0x26fed4,'TemplateParam':JSON[_0xf36c0e(0xfb)]({'code':_0x16aa93})},_0x2a6f65={'method':_0xf36c0e(0x122),'formatParams':![]};try{const _0x16ccd1=await _0x46f400[_0xf36c0e(0x104)](_0xf36c0e(0x126),_0x974c9e,_0x2a6f65);if(_0x16ccd1[_0xf36c0e(0x10f)]==='OK')return!![];else throw new common_1[(_0xf36c0e(0x102))](_0x16ccd1[_0xf36c0e(0x11e)]||_0xf36c0e(0x100),common_1[_0xf36c0e(0x112)][_0xf36c0e(0xea)]);}catch(_0x1991a7){throw new common_1[(_0xf36c0e(0x102))](_0x1991a7?.[_0xf36c0e(0x116)]?.[_0xf36c0e(0x11e)]||_0xf36c0e(0x100),common_1[_0xf36c0e(0x112)][_0xf36c0e(0xea)]);}}};VerificationService=__decorate([(0x0,common_1[_0x1fa046(0x11f)])(),__param(0x0,(0x0,typeorm_1[_0x1fa046(0xff)])(verifycation_entity_1[_0x1fa046(0xf6)])),__metadata(_0x1fa046(0xef),[typeorm_2[_0x1fa046(0x10d)],globalConfig_service_1[_0x1fa046(0x10c)],redisCache_service_1[_0x1fa046(0xf0)]])],VerificationService),exports[_0x1fa046(0xdf)]=VerificationService;