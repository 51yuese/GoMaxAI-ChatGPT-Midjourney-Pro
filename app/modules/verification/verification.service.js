'use strict';function _0x105f(){const _0x5c4767=['sendPhoneCode','function','decorate','design:paramtypes','metadata','41247OzPZWq','809979EAHLDX','图形验证码错误、请检查填写!','BAD_REQUEST','getTime','used','verifyCaptcha','RedisCacheService','redisCacheService','code','确实必要参数错误！','HttpStatus','@nestjs/typeorm','@alicloud/pop-core','DESC','defineProperty','findOne','3RiBnRV','save','验证码错误','当前验证码已被使用！','expiresAt','Code','now','getPhoneVerifyConfig','图形验证码已过期、请重新输入!','__esModule','4770WvhIlW','createVerification','length','HttpException','../../common/utils','VerificationService','del','VerifycationEntity','object','../globalConfig/globalConfig.service','21PskYmK','__param','./verifycation.entity','request','__decorate','POST','Injectable','@nestjs/common','815890GmjXYH','createRandomCode','Message','verifycationEntity','SendSms','S内不得重新发送','USED','9105112GfxmHM','3461544xtbbxB','1271095etWaAP','createdAt','globalConfigService','verifyCode','../../common/constants/status.constant','__metadata','783942EwgCfL',':CAPTCHA:'];_0x105f=function(){return _0x5c4767;};return _0x105f();}const _0x225927=_0x2c63;(function(_0x5ac659,_0x22ca96){const _0x41973c=_0x2c63,_0x3548e0=_0x5ac659();while(!![]){try{const _0x4e6e5d=-parseInt(_0x41973c(0x10f))/0x1+-parseInt(_0x41973c(0x13b))/0x2*(parseInt(_0x41973c(0x11f))/0x3)+-parseInt(_0x41973c(0x143))/0x4+-parseInt(_0x41973c(0x144))/0x5+parseInt(_0x41973c(0x107))/0x6*(-parseInt(_0x41973c(0x133))/0x7)+parseInt(_0x41973c(0x142))/0x8+-parseInt(_0x41973c(0x10e))/0x9*(-parseInt(_0x41973c(0x129))/0xa);if(_0x4e6e5d===_0x22ca96)break;else _0x3548e0['push'](_0x3548e0['shift']());}catch(_0x41906c){_0x3548e0['push'](_0x3548e0['shift']());}}}(_0x105f,0x9132a));function _0x2c63(_0x1aa2b5,_0x4cf22a){const _0x105f55=_0x105f();return _0x2c63=function(_0x2c6336,_0x5e9b38){_0x2c6336=_0x2c6336-0x103;let _0x992114=_0x105f55[_0x2c6336];return _0x992114;},_0x2c63(_0x1aa2b5,_0x4cf22a);}var __decorate=this&&this[_0x225927(0x137)]||function(_0x2e9dd9,_0x183609,_0x2c45e5,_0x3fcdd3){const _0x5a72d9=_0x225927;var _0x314ed6=arguments[_0x5a72d9(0x12b)],_0x27a32f=_0x314ed6<0x3?_0x183609:_0x3fcdd3===null?_0x3fcdd3=Object['getOwnPropertyDescriptor'](_0x183609,_0x2c45e5):_0x3fcdd3,_0x4bfeab;if(typeof Reflect===_0x5a72d9(0x131)&&typeof Reflect[_0x5a72d9(0x10b)]==='function')_0x27a32f=Reflect[_0x5a72d9(0x10b)](_0x2e9dd9,_0x183609,_0x2c45e5,_0x3fcdd3);else{for(var _0x4327a6=_0x2e9dd9[_0x5a72d9(0x12b)]-0x1;_0x4327a6>=0x0;_0x4327a6--)if(_0x4bfeab=_0x2e9dd9[_0x4327a6])_0x27a32f=(_0x314ed6<0x3?_0x4bfeab(_0x27a32f):_0x314ed6>0x3?_0x4bfeab(_0x183609,_0x2c45e5,_0x27a32f):_0x4bfeab(_0x183609,_0x2c45e5))||_0x27a32f;}return _0x314ed6>0x3&&_0x27a32f&&Object[_0x5a72d9(0x11d)](_0x183609,_0x2c45e5,_0x27a32f),_0x27a32f;},__metadata=this&&this[_0x225927(0x106)]||function(_0x2e1800,_0x769bbb){const _0x578460=_0x225927;if(typeof Reflect===_0x578460(0x131)&&typeof Reflect[_0x578460(0x10d)]===_0x578460(0x10a))return Reflect['metadata'](_0x2e1800,_0x769bbb);},__param=this&&this[_0x225927(0x134)]||function(_0x4c2284,_0xf0879a){return function(_0x142430,_0x86703d){_0xf0879a(_0x142430,_0x86703d,_0x4c2284);};};Object[_0x225927(0x11d)](exports,_0x225927(0x128),{'value':!![]}),exports[_0x225927(0x12e)]=void 0x0;const globalConfig_service_1=require(_0x225927(0x132)),status_constant_1=require(_0x225927(0x105)),typeorm_1=require(_0x225927(0x11a)),typeorm_2=require('typeorm'),verifycation_entity_1=require(_0x225927(0x135)),common_1=require(_0x225927(0x13a)),utils_1=require(_0x225927(0x12d)),redisCache_service_1=require('../redisCache/redisCache.service'),Core=require(_0x225927(0x11b));let VerificationService=class VerificationService{constructor(_0x4a2243,_0x17720f,_0x11d096){const _0x1b9443=_0x225927;this[_0x1b9443(0x13e)]=_0x4a2243,this['globalConfigService']=_0x17720f,this[_0x1b9443(0x116)]=_0x11d096;}async[_0x225927(0x12a)](_0x46b2e5,_0x176037,_0xd930f0=0x1e*0x3c){const _0x4d33d9=_0x225927,_0x54c83c=await this[_0x4d33d9(0x13e)][_0x4d33d9(0x11e)]({'where':{'userId':_0x46b2e5['id'],'type':_0x176037},'order':{'createdAt':_0x4d33d9(0x11c)}});if(_0x54c83c&&_0x54c83c[_0x4d33d9(0x145)][_0x4d33d9(0x112)]()+0x1*0x3c*0x3e8>Date['now']()){const _0x43dd78=Math['ceil']((_0x54c83c[_0x4d33d9(0x145)][_0x4d33d9(0x112)]()+0x1*0x3c*0x3e8-Date[_0x4d33d9(0x125)]())/0x3e8);throw new common_1[(_0x4d33d9(0x12c))](_0x43dd78+_0x4d33d9(0x140),common_1[_0x4d33d9(0x119)]['BAD_REQUEST']);}const _0x266ad2=(0x0,utils_1[_0x4d33d9(0x13c)])(),_0x264a61=new Date(Date[_0x4d33d9(0x125)]()+_0xd930f0*0x3e8),{id:_0x5817da,email:_0x3f0f4f}=_0x46b2e5,_0x5b7dae={'userId':_0x5817da,'type':_0x176037,'code':_0x266ad2,'expiresAt':_0x264a61,'email':_0x3f0f4f};return await this[_0x4d33d9(0x13e)][_0x4d33d9(0x120)](_0x5b7dae);}async[_0x225927(0x104)]({code:_0x590211,id:_0x9a0231},_0x315c50){const _0x14aa67=_0x225927,_0x59ae3b=await this[_0x14aa67(0x13e)]['findOne']({'where':{'id':_0x9a0231,'type':_0x315c50},'order':{'createdAt':'DESC'}});if(!_0x59ae3b)throw new common_1[(_0x14aa67(0x12c))]('验证码不存在',common_1[_0x14aa67(0x119)][_0x14aa67(0x111)]);if(_0x59ae3b[_0x14aa67(0x113)]===status_constant_1['VerificationUseStatusEnum'][_0x14aa67(0x141)])throw new common_1['HttpException'](_0x14aa67(0x122),common_1[_0x14aa67(0x119)][_0x14aa67(0x111)]);else _0x59ae3b['used']=status_constant_1['VerificationUseStatusEnum'][_0x14aa67(0x141)],await this['verifycationEntity']['update']({'id':_0x9a0231},_0x59ae3b);if(Number(_0x59ae3b[_0x14aa67(0x117)])!==Number(_0x590211))throw new common_1[(_0x14aa67(0x12c))](_0x14aa67(0x121),common_1['HttpStatus']['BAD_REQUEST']);if(_0x59ae3b[_0x14aa67(0x123)]<new Date())throw new common_1['HttpException']('验证码已过期',common_1[_0x14aa67(0x119)]['BAD_REQUEST']);return _0x59ae3b;}async[_0x225927(0x114)](_0x53679d){const _0x5b1254=_0x225927,{captchaId:_0xdae953,captchaCode:_0x32db4f}=_0x53679d,_0x217dfc=await this[_0x5b1254(0x103)]['getNamespace'](),_0x183a89=_0x217dfc+_0x5b1254(0x108)+_0xdae953,_0x3bc16d=await this[_0x5b1254(0x116)]['get']({'key':_0x183a89});await this[_0x5b1254(0x116)][_0x5b1254(0x12f)]({'key':_0x183a89});if(!_0x3bc16d)throw new common_1[(_0x5b1254(0x12c))](_0x5b1254(0x127),common_1[_0x5b1254(0x119)]['BAD_REQUEST']);if(!_0x3bc16d||_0x3bc16d!==_0x32db4f)throw new common_1[(_0x5b1254(0x12c))](_0x5b1254(0x110),common_1[_0x5b1254(0x119)]['BAD_REQUEST']);}async[_0x225927(0x109)](_0x224092){const _0x3429d7=_0x225927,{accessKeyId:_0x5d5cb2,accessKeySecret:_0x216bab,SignName:_0x5f3d66,TemplateCode:_0x43801a}=await this[_0x3429d7(0x103)][_0x3429d7(0x126)](),{phone:_0x1ee4fd,code:_0x432617}=_0x224092;if(!_0x1ee4fd||!_0x432617)throw new common_1[(_0x3429d7(0x12c))](_0x3429d7(0x118),common_1['HttpStatus'][_0x3429d7(0x111)]);const _0x860bbe=new Core({'accessKeyId':_0x5d5cb2,'accessKeySecret':_0x216bab,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':'2017-05-25'}),_0x4ba4fa={'PhoneNumbers':_0x1ee4fd,'SignName':_0x5f3d66,'TemplateCode':_0x43801a,'TemplateParam':JSON['stringify']({'code':_0x432617})},_0x34b7a9={'method':_0x3429d7(0x138),'formatParams':![]};try{const _0xddb15c=await _0x860bbe[_0x3429d7(0x136)](_0x3429d7(0x13f),_0x4ba4fa,_0x34b7a9);if(_0xddb15c[_0x3429d7(0x124)]==='OK')return!![];else throw new common_1[(_0x3429d7(0x12c))](_0xddb15c[_0x3429d7(0x13d)]||'验证码发送失败！',common_1[_0x3429d7(0x119)][_0x3429d7(0x111)]);}catch(_0x32be77){throw new common_1[(_0x3429d7(0x12c))](_0x32be77?.['data']?.[_0x3429d7(0x13d)]||'验证码发送失败！',common_1['HttpStatus']['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1[_0x225927(0x139)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1[_0x225927(0x130)])),__metadata(_0x225927(0x10c),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x225927(0x115)]])],VerificationService),exports[_0x225927(0x12e)]=VerificationService;