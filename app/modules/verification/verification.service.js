'use strict';function _0x2de3(_0x5a5b74,_0x1055a2){const _0x5160ec=_0x5160();return _0x2de3=function(_0x2de38d,_0x5305fe){_0x2de38d=_0x2de38d-0xd3;let _0x1c6dd5=_0x5160ec[_0x2de38d];return _0x1c6dd5;},_0x2de3(_0x5a5b74,_0x1055a2);}const _0x325b6c=_0x2de3;(function(_0x57f60e,_0xc78991){const _0x5b98e3=_0x2de3,_0x582dc2=_0x57f60e();while(!![]){try{const _0x51fc3c=parseInt(_0x5b98e3(0xd7))/0x1+-parseInt(_0x5b98e3(0x100))/0x2+parseInt(_0x5b98e3(0xf7))/0x3*(parseInt(_0x5b98e3(0x115))/0x4)+parseInt(_0x5b98e3(0xfe))/0x5*(parseInt(_0x5b98e3(0xde))/0x6)+-parseInt(_0x5b98e3(0x10d))/0x7*(-parseInt(_0x5b98e3(0x104))/0x8)+parseInt(_0x5b98e3(0xec))/0x9+-parseInt(_0x5b98e3(0xf6))/0xa;if(_0x51fc3c===_0xc78991)break;else _0x582dc2['push'](_0x582dc2['shift']());}catch(_0x3dd086){_0x582dc2['push'](_0x582dc2['shift']());}}}(_0x5160,0x20571));var __decorate=this&&this[_0x325b6c(0xdd)]||function(_0x50c87d,_0x4d2b7a,_0x34b660,_0x13f968){const _0x23a974=_0x325b6c;var _0x4da8ad=arguments[_0x23a974(0x110)],_0x4ab71f=_0x4da8ad<0x3?_0x4d2b7a:_0x13f968===null?_0x13f968=Object[_0x23a974(0xf9)](_0x4d2b7a,_0x34b660):_0x13f968,_0x398c0e;if(typeof Reflect==='object'&&typeof Reflect[_0x23a974(0xf5)]===_0x23a974(0xe7))_0x4ab71f=Reflect['decorate'](_0x50c87d,_0x4d2b7a,_0x34b660,_0x13f968);else{for(var _0x4b6079=_0x50c87d[_0x23a974(0x110)]-0x1;_0x4b6079>=0x0;_0x4b6079--)if(_0x398c0e=_0x50c87d[_0x4b6079])_0x4ab71f=(_0x4da8ad<0x3?_0x398c0e(_0x4ab71f):_0x4da8ad>0x3?_0x398c0e(_0x4d2b7a,_0x34b660,_0x4ab71f):_0x398c0e(_0x4d2b7a,_0x34b660))||_0x4ab71f;}return _0x4da8ad>0x3&&_0x4ab71f&&Object[_0x23a974(0x113)](_0x4d2b7a,_0x34b660,_0x4ab71f),_0x4ab71f;},__metadata=this&&this[_0x325b6c(0x116)]||function(_0x142a00,_0x152c1d){const _0x3042be=_0x325b6c;if(typeof Reflect==='object'&&typeof Reflect[_0x3042be(0xf8)]===_0x3042be(0xe7))return Reflect[_0x3042be(0xf8)](_0x142a00,_0x152c1d);},__param=this&&this[_0x325b6c(0xd4)]||function(_0x395c56,_0x49c39f){return function(_0x3c871f,_0x2219a2){_0x49c39f(_0x3c871f,_0x2219a2,_0x395c56);};};Object[_0x325b6c(0x113)](exports,_0x325b6c(0xd6),{'value':!![]}),exports[_0x325b6c(0x10f)]=void 0x0;function _0x5160(){const _0x26908c=['12444luMrTC','findOne','VerificationUseStatusEnum','图形验证码已过期、请重新输入!','Repository','get','RedisCacheService','now','InjectRepository','function','@alicloud/pop-core','typeorm','getTime','验证码不存在','501696ltCREg','HttpStatus','globalConfigService',':CAPTCHA:','data','图形验证码错误、请检查填写!','DESC','@nestjs/typeorm','../redisCache/redisCache.service','decorate','1878390BMKRzV','13890yUxXOJ','metadata','getOwnPropertyDescriptor','./verifycation.entity','USED','used','update','5gTKSqT','ceil','28148RoZdJy','Injectable','BAD_REQUEST','verifyCaptcha','28216ssiBnH','POST','HttpException','createVerification','Message','确实必要参数错误！','验证码发送失败！','SendSms','../globalConfig/globalConfig.service','119PuzZEK','../../common/utils','VerificationService','length','code','2017-05-25','defineProperty','stringify','64VJcrkw','__metadata','redisCacheService','createRandomCode','__param','expiresAt','__esModule','142521pawWXF','@nestjs/common','request','createdAt','verifycationEntity','GlobalConfigService','__decorate'];_0x5160=function(){return _0x26908c;};return _0x5160();}const globalConfig_service_1=require(_0x325b6c(0x10c)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x325b6c(0xf3)),typeorm_2=require(_0x325b6c(0xe9)),verifycation_entity_1=require(_0x325b6c(0xfa)),common_1=require(_0x325b6c(0xd8)),utils_1=require(_0x325b6c(0x10e)),redisCache_service_1=require(_0x325b6c(0xf4)),Core=require(_0x325b6c(0xe8));let VerificationService=class VerificationService{constructor(_0x5a085d,_0x2ea522,_0x3c88d7){const _0x2edb10=_0x325b6c;this[_0x2edb10(0xdb)]=_0x5a085d,this[_0x2edb10(0xee)]=_0x2ea522,this[_0x2edb10(0x117)]=_0x3c88d7;}async[_0x325b6c(0x107)](_0x5bb872,_0x3d39a4,_0x411a34=0x1e*0x3c){const _0x1aaa01=_0x325b6c,_0x2cbc85=await this[_0x1aaa01(0xdb)][_0x1aaa01(0xdf)]({'where':{'userId':_0x5bb872['id'],'type':_0x3d39a4},'order':{'createdAt':'DESC'}});if(_0x2cbc85&&_0x2cbc85[_0x1aaa01(0xda)][_0x1aaa01(0xea)]()+0x1*0x3c*0x3e8>Date[_0x1aaa01(0xe5)]()){const _0x53a5ba=Math[_0x1aaa01(0xff)]((_0x2cbc85['createdAt']['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x1aaa01(0x106))](_0x53a5ba+'S内不得重新发送',common_1[_0x1aaa01(0xed)][_0x1aaa01(0x102)]);}const _0x200878=(0x0,utils_1[_0x1aaa01(0xd3)])(),_0x35f1ee=new Date(Date[_0x1aaa01(0xe5)]()+_0x411a34*0x3e8),{id:_0x30b5c2,email:_0x486824}=_0x5bb872,_0x42e67d={'userId':_0x30b5c2,'type':_0x3d39a4,'code':_0x200878,'expiresAt':_0x35f1ee,'email':_0x486824};return await this[_0x1aaa01(0xdb)]['save'](_0x42e67d);}async['verifyCode']({code:_0x365cc6,id:_0x505cbe},_0x1dd878){const _0x3e6332=_0x325b6c,_0x8f9589=await this[_0x3e6332(0xdb)][_0x3e6332(0xdf)]({'where':{'id':_0x505cbe,'type':_0x1dd878},'order':{'createdAt':_0x3e6332(0xf2)}});if(!_0x8f9589)throw new common_1[(_0x3e6332(0x106))](_0x3e6332(0xeb),common_1[_0x3e6332(0xed)][_0x3e6332(0x102)]);if(_0x8f9589[_0x3e6332(0xfc)]===status_constant_1[_0x3e6332(0xe0)]['USED'])throw new common_1[(_0x3e6332(0x106))]('当前验证码已被使用！',common_1[_0x3e6332(0xed)]['BAD_REQUEST']);else _0x8f9589['used']=status_constant_1[_0x3e6332(0xe0)][_0x3e6332(0xfb)],await this[_0x3e6332(0xdb)][_0x3e6332(0xfd)]({'id':_0x505cbe},_0x8f9589);if(Number(_0x8f9589[_0x3e6332(0x111)])!==Number(_0x365cc6))throw new common_1[(_0x3e6332(0x106))]('验证码错误',common_1[_0x3e6332(0xed)]['BAD_REQUEST']);if(_0x8f9589[_0x3e6332(0xd5)]<new Date())throw new common_1['HttpException']('验证码已过期',common_1['HttpStatus'][_0x3e6332(0x102)]);return _0x8f9589;}async[_0x325b6c(0x103)](_0xd05851){const _0x13c875=_0x325b6c,{captchaId:_0x2ec1cb,captchaCode:_0x44886d}=_0xd05851,_0x2d8adc=await this[_0x13c875(0xee)]['getNamespace'](),_0x34922d=_0x2d8adc+_0x13c875(0xef)+_0x2ec1cb,_0x5da536=await this[_0x13c875(0x117)][_0x13c875(0xe3)]({'key':_0x34922d});await this[_0x13c875(0x117)]['del']({'key':_0x34922d});if(!_0x5da536)throw new common_1[(_0x13c875(0x106))](_0x13c875(0xe1),common_1[_0x13c875(0xed)][_0x13c875(0x102)]);if(!_0x5da536||_0x5da536!==_0x44886d)throw new common_1[(_0x13c875(0x106))](_0x13c875(0xf1),common_1[_0x13c875(0xed)][_0x13c875(0x102)]);}async['sendPhoneCode'](_0x40eddd){const _0x58f8d6=_0x325b6c,{accessKeyId:_0x5a5774,accessKeySecret:_0x292dff,SignName:_0x1456e6,TemplateCode:_0x275ccd}=await this[_0x58f8d6(0xee)]['getPhoneVerifyConfig'](),{phone:_0x510cf7,code:_0x36b197}=_0x40eddd;if(!_0x510cf7||!_0x36b197)throw new common_1[(_0x58f8d6(0x106))](_0x58f8d6(0x109),common_1['HttpStatus'][_0x58f8d6(0x102)]);const _0x39c626=new Core({'accessKeyId':_0x5a5774,'accessKeySecret':_0x292dff,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x58f8d6(0x112)}),_0x487093={'PhoneNumbers':_0x510cf7,'SignName':_0x1456e6,'TemplateCode':_0x275ccd,'TemplateParam':JSON[_0x58f8d6(0x114)]({'code':_0x36b197})},_0x557599={'method':_0x58f8d6(0x105),'formatParams':![]};try{const _0x43623a=await _0x39c626[_0x58f8d6(0xd9)](_0x58f8d6(0x10b),_0x487093,_0x557599);if(_0x43623a['Code']==='OK')return!![];else throw new common_1['HttpException'](_0x43623a[_0x58f8d6(0x108)]||_0x58f8d6(0x10a),common_1[_0x58f8d6(0xed)]['BAD_REQUEST']);}catch(_0x53a5d3){throw new common_1[(_0x58f8d6(0x106))](_0x53a5d3?.[_0x58f8d6(0xf0)]?.[_0x58f8d6(0x108)]||_0x58f8d6(0x10a),common_1['HttpStatus'][_0x58f8d6(0x102)]);}}};VerificationService=__decorate([(0x0,common_1[_0x325b6c(0x101)])(),__param(0x0,(0x0,typeorm_1[_0x325b6c(0xe6)])(verifycation_entity_1['VerifycationEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x325b6c(0xe2)],globalConfig_service_1[_0x325b6c(0xdc)],redisCache_service_1[_0x325b6c(0xe4)]])],VerificationService),exports['VerificationService']=VerificationService;