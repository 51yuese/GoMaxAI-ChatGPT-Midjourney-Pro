'use strict';function _0x59d2(){const _0x4045a4=['object','VerifycationEntity','defineProperty','length','getOwnPropertyDescriptor','redisCacheService','createVerification','RedisCacheService','../../common/utils','del','21790xghfRI','InjectRepository','HttpStatus','@alicloud/pop-core','33EZnIyB','7921137UeShwd','__decorate',':CAPTCHA:','metadata','design:paramtypes','../redisCache/redisCache.service','save','HttpException','Message','get','10648320baSSzE','createRandomCode','BAD_REQUEST','globalConfigService','findOne','SendSms','11YUZkdy','@nestjs/common','VerificationService','验证码发送失败！','update','@nestjs/typeorm','verifyCaptcha','used','createdAt','verifycationEntity','1560ByPZBt','data','__param','883863BnUUPy','USED','ceil','DESC','8xcofVR','decorate','sendPhoneCode','图形验证码已过期、请重新输入!','74356908nJibJe','getTime','request','https://dysmsapi.aliyuncs.com','306rpSaJO','535732RfWbip','S内不得重新发送','../../common/constants/status.constant','1570jEgEWT','function','now','code','./verifycation.entity','../globalConfig/globalConfig.service','VerificationUseStatusEnum','getPhoneVerifyConfig','__metadata'];_0x59d2=function(){return _0x4045a4;};return _0x59d2();}const _0x2d9a7b=_0xeba2;(function(_0x10d79a,_0x132a38){const _0x3ff38d=_0xeba2,_0x2a085a=_0x10d79a();while(!![]){try{const _0x188dd7=-parseInt(_0x3ff38d(0x9c))/0x1*(parseInt(_0x3ff38d(0xaf))/0x2)+-parseInt(_0x3ff38d(0x81))/0x3*(parseInt(_0x3ff38d(0xac))/0x4)+parseInt(_0x3ff38d(0x7d))/0x5*(-parseInt(_0x3ff38d(0xab))/0x6)+-parseInt(_0x3ff38d(0x82))/0x7+parseInt(_0x3ff38d(0xa3))/0x8*(-parseInt(_0x3ff38d(0x9f))/0x9)+-parseInt(_0x3ff38d(0x8c))/0xa+parseInt(_0x3ff38d(0x92))/0xb*(parseInt(_0x3ff38d(0xa7))/0xc);if(_0x188dd7===_0x132a38)break;else _0x2a085a['push'](_0x2a085a['shift']());}catch(_0x1befae){_0x2a085a['push'](_0x2a085a['shift']());}}}(_0x59d2,0xefa9a));var __decorate=this&&this[_0x2d9a7b(0x83)]||function(_0x16cb1b,_0x4278fa,_0x13bb97,_0x47405a){const _0xcb47fc=_0x2d9a7b;var _0x2f8cbe=arguments[_0xcb47fc(0x76)],_0x151690=_0x2f8cbe<0x3?_0x4278fa:_0x47405a===null?_0x47405a=Object[_0xcb47fc(0x77)](_0x4278fa,_0x13bb97):_0x47405a,_0x5c78c4;if(typeof Reflect===_0xcb47fc(0x73)&&typeof Reflect[_0xcb47fc(0xa4)]==='function')_0x151690=Reflect[_0xcb47fc(0xa4)](_0x16cb1b,_0x4278fa,_0x13bb97,_0x47405a);else{for(var _0x56e91f=_0x16cb1b[_0xcb47fc(0x76)]-0x1;_0x56e91f>=0x0;_0x56e91f--)if(_0x5c78c4=_0x16cb1b[_0x56e91f])_0x151690=(_0x2f8cbe<0x3?_0x5c78c4(_0x151690):_0x2f8cbe>0x3?_0x5c78c4(_0x4278fa,_0x13bb97,_0x151690):_0x5c78c4(_0x4278fa,_0x13bb97))||_0x151690;}return _0x2f8cbe>0x3&&_0x151690&&Object[_0xcb47fc(0x75)](_0x4278fa,_0x13bb97,_0x151690),_0x151690;},__metadata=this&&this[_0x2d9a7b(0x72)]||function(_0x41a929,_0x559ffb){const _0x2224da=_0x2d9a7b;if(typeof Reflect===_0x2224da(0x73)&&typeof Reflect['metadata']===_0x2224da(0xb0))return Reflect[_0x2224da(0x85)](_0x41a929,_0x559ffb);},__param=this&&this[_0x2d9a7b(0x9e)]||function(_0x29a21c,_0x4b2618){return function(_0x2ad3bd,_0x441a93){_0x4b2618(_0x2ad3bd,_0x441a93,_0x29a21c);};};Object[_0x2d9a7b(0x75)](exports,'__esModule',{'value':!![]}),exports[_0x2d9a7b(0x94)]=void 0x0;const globalConfig_service_1=require(_0x2d9a7b(0xb4)),status_constant_1=require(_0x2d9a7b(0xae)),typeorm_1=require(_0x2d9a7b(0x97)),typeorm_2=require('typeorm'),verifycation_entity_1=require(_0x2d9a7b(0xb3)),common_1=require(_0x2d9a7b(0x93)),utils_1=require(_0x2d9a7b(0x7b)),redisCache_service_1=require(_0x2d9a7b(0x87)),Core=require(_0x2d9a7b(0x80));let VerificationService=class VerificationService{constructor(_0x1433c7,_0x441572,_0x3acd44){const _0x1fa586=_0x2d9a7b;this[_0x1fa586(0x9b)]=_0x1433c7,this[_0x1fa586(0x8f)]=_0x441572,this[_0x1fa586(0x78)]=_0x3acd44;}async[_0x2d9a7b(0x79)](_0x116903,_0x4c4a46,_0x2c87aa=0x1e*0x3c){const _0x1181f7=_0x2d9a7b,_0x9432d9=await this[_0x1181f7(0x9b)][_0x1181f7(0x90)]({'where':{'userId':_0x116903['id'],'type':_0x4c4a46},'order':{'createdAt':'DESC'}});if(_0x9432d9&&_0x9432d9['createdAt'][_0x1181f7(0xa8)]()+0x1*0x3c*0x3e8>Date[_0x1181f7(0xb1)]()){const _0x34cf83=Math[_0x1181f7(0xa1)]((_0x9432d9[_0x1181f7(0x9a)][_0x1181f7(0xa8)]()+0x1*0x3c*0x3e8-Date[_0x1181f7(0xb1)]())/0x3e8);throw new common_1[(_0x1181f7(0x89))](_0x34cf83+_0x1181f7(0xad),common_1[_0x1181f7(0x7f)]['BAD_REQUEST']);}const _0x50fa34=(0x0,utils_1[_0x1181f7(0x8d)])(),_0x24ac7d=new Date(Date['now']()+_0x2c87aa*0x3e8),{id:_0xa8321e,email:_0x14c608}=_0x116903,_0x1f8e0a={'userId':_0xa8321e,'type':_0x4c4a46,'code':_0x50fa34,'expiresAt':_0x24ac7d,'email':_0x14c608};return await this[_0x1181f7(0x9b)][_0x1181f7(0x88)](_0x1f8e0a);}async['verifyCode']({code:_0x5751d9,id:_0x1cb30d},_0x26c9e0){const _0x3c0df8=_0x2d9a7b,_0x38d512=await this['verifycationEntity']['findOne']({'where':{'id':_0x1cb30d,'type':_0x26c9e0},'order':{'createdAt':_0x3c0df8(0xa2)}});if(!_0x38d512)throw new common_1['HttpException']('验证码不存在',common_1[_0x3c0df8(0x7f)]['BAD_REQUEST']);if(_0x38d512[_0x3c0df8(0x99)]===status_constant_1[_0x3c0df8(0x70)][_0x3c0df8(0xa0)])throw new common_1[(_0x3c0df8(0x89))]('当前验证码已被使用！',common_1['HttpStatus'][_0x3c0df8(0x8e)]);else _0x38d512['used']=status_constant_1[_0x3c0df8(0x70)]['USED'],await this['verifycationEntity'][_0x3c0df8(0x96)]({'id':_0x1cb30d},_0x38d512);if(Number(_0x38d512[_0x3c0df8(0xb2)])!==Number(_0x5751d9))throw new common_1['HttpException']('验证码错误',common_1[_0x3c0df8(0x7f)][_0x3c0df8(0x8e)]);if(_0x38d512['expiresAt']<new Date())throw new common_1[(_0x3c0df8(0x89))]('验证码已过期',common_1['HttpStatus'][_0x3c0df8(0x8e)]);return _0x38d512;}async[_0x2d9a7b(0x98)](_0x313183){const _0x189e60=_0x2d9a7b,{captchaId:_0x123365,captchaCode:_0x48d386}=_0x313183,_0x1db27a=await this['globalConfigService']['getNamespace'](),_0x3160a4=_0x1db27a+_0x189e60(0x84)+_0x123365,_0x495ab5=await this[_0x189e60(0x78)][_0x189e60(0x8b)]({'key':_0x3160a4});await this[_0x189e60(0x78)][_0x189e60(0x7c)]({'key':_0x3160a4});if(!_0x495ab5)throw new common_1['HttpException'](_0x189e60(0xa6),common_1[_0x189e60(0x7f)][_0x189e60(0x8e)]);if(!_0x495ab5||_0x495ab5!==_0x48d386)throw new common_1['HttpException']('图形验证码错误、请检查填写!',common_1['HttpStatus'][_0x189e60(0x8e)]);}async[_0x2d9a7b(0xa5)](_0x3ade0e){const _0x9ef1a7=_0x2d9a7b,{accessKeyId:_0x4eb86d,accessKeySecret:_0x558861,SignName:_0x100854,TemplateCode:_0x286c6d}=await this[_0x9ef1a7(0x8f)][_0x9ef1a7(0x71)](),{phone:_0x4c4e29,code:_0x1815db}=_0x3ade0e;if(!_0x4c4e29||!_0x1815db)throw new common_1[(_0x9ef1a7(0x89))]('确实必要参数错误！',common_1[_0x9ef1a7(0x7f)][_0x9ef1a7(0x8e)]);const _0x1b58cd=new Core({'accessKeyId':_0x4eb86d,'accessKeySecret':_0x558861,'endpoint':_0x9ef1a7(0xaa),'apiVersion':'2017-05-25'}),_0x17ceca={'PhoneNumbers':_0x4c4e29,'SignName':_0x100854,'TemplateCode':_0x286c6d,'TemplateParam':JSON['stringify']({'code':_0x1815db})},_0x3e8334={'method':'POST','formatParams':![]};try{const _0x25fc1c=await _0x1b58cd[_0x9ef1a7(0xa9)](_0x9ef1a7(0x91),_0x17ceca,_0x3e8334);if(_0x25fc1c['Code']==='OK')return!![];else throw new common_1[(_0x9ef1a7(0x89))](_0x25fc1c[_0x9ef1a7(0x8a)]||'验证码发送失败！',common_1[_0x9ef1a7(0x7f)][_0x9ef1a7(0x8e)]);}catch(_0x5a9969){throw new common_1['HttpException'](_0x5a9969?.[_0x9ef1a7(0x9d)]?.['Message']||_0x9ef1a7(0x95),common_1['HttpStatus'][_0x9ef1a7(0x8e)]);}}};function _0xeba2(_0x37ac06,_0x970426){const _0x59d295=_0x59d2();return _0xeba2=function(_0xeba21f,_0x5112fa){_0xeba21f=_0xeba21f-0x70;let _0x419c1c=_0x59d295[_0xeba21f];return _0x419c1c;},_0xeba2(_0x37ac06,_0x970426);}VerificationService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2d9a7b(0x7e)])(verifycation_entity_1[_0x2d9a7b(0x74)])),__metadata(_0x2d9a7b(0x86),[typeorm_2['Repository'],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x2d9a7b(0x7a)]])],VerificationService),exports[_0x2d9a7b(0x94)]=VerificationService;