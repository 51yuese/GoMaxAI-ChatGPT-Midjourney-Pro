'use strict';const _0x1196f3=_0x327b;function _0x327b(_0x2139e1,_0x1dead2){const _0xfb2e7e=_0xfb2e();return _0x327b=function(_0x327b0b,_0x5ce79d){_0x327b0b=_0x327b0b-0xff;let _0x4ef589=_0xfb2e7e[_0x327b0b];return _0x4ef589;},_0x327b(_0x2139e1,_0x1dead2);}(function(_0x443683,_0x4321c0){const _0x2573e5=_0x327b,_0x21c947=_0x443683();while(!![]){try{const _0x39db02=-parseInt(_0x2573e5(0x172))/0x1*(parseInt(_0x2573e5(0x174))/0x2)+parseInt(_0x2573e5(0x153))/0x3*(parseInt(_0x2573e5(0x148))/0x4)+parseInt(_0x2573e5(0x16b))/0x5+parseInt(_0x2573e5(0x127))/0x6*(parseInt(_0x2573e5(0x149))/0x7)+parseInt(_0x2573e5(0x132))/0x8*(-parseInt(_0x2573e5(0x144))/0x9)+-parseInt(_0x2573e5(0x15f))/0xa*(parseInt(_0x2573e5(0x11c))/0xb)+-parseInt(_0x2573e5(0x14f))/0xc*(parseInt(_0x2573e5(0x146))/0xd);if(_0x39db02===_0x4321c0)break;else _0x21c947['push'](_0x21c947['shift']());}catch(_0x2f6a0f){_0x21c947['push'](_0x21c947['shift']());}}}(_0xfb2e,0xa4d65));function _0xfb2e(){const _0x19d656=['getUserById','useCount\x20+\x201','keyPoolMap','redisCacheService','../../common/constants/redisKey.constant','BAD_REQUEST','map','模型名称已存在，请修改模型名称','execute','reduce','verify','getOfficialModels','/v1/models','getAccessToken','__metadata','80982WWWWPL','keys','keyStatus','@nestjs/common','assign','hideString','__param','secret','id\x20=\x20:id','keyType','getModelByName','6sMtWca','modelName','setModel','proxyUrl','useToken\x20+\x20','modelType','../../common/constants/status.constant','HttpException','userService','getOwnPropertyDescriptor','displaySort','8NRDfFu','vipExpire','update','Like','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','key','sort','key:\x20','Repository','../../common/constants/model.constant','error:\x20','design:paramtypes','createQueryBuilder','EModelType','缺失必要参数！','jsonwebtoken','VIP_FREE','getRandomAudioKey','67329lfttxp','admin','13lTwsel','暂未配置相关模型，请联系管理员！','2946508XVkPUF','2770033PymqVN','filter','queryModels','find','super','keyList','281328SKbZmU','push','typeorm','saveUseLog','3Ffckzt','../chatgpt/baidu','getMusicModel','getModelByType','model','forEach','message','where','object','modelsEntity','keyInfo','headers','760VhLxXd','当前未指定特殊模型KEY、前往后台设置！','random','visitor','refreshBaiduAccesstoken','ModelsEntity','modelsList','当前未指定语音对话模型KEY、前往后台设置把！','split','当前账号不存在！','error','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','1869280xNPbzB','InjectRepository','当前调用模型已经被移除、请重新选择模型！','findOne','get','affected','ModelsService','1367YGHtRB','../../common/utils','352rTZQiz','https://apiv.chatgpt-3.vip','then','metadata','initCalcKey','canUpload','DESC','front','decorate','status','Logger','floor','role','HttpStatus','defineProperty','data','暂未配置音乐模型，请联系管理员','log','modelTypes','authorization','getCurrentModelKeyInfo','function','length','modelMaps','keyPoolIndexMap','../redisCache/redisCache.service'];_0xfb2e=function(){return _0x19d656;};return _0xfb2e();}var __decorate=this&&this['__decorate']||function(_0x4d1fb6,_0x162d09,_0x4d8486,_0x3e4b52){const _0x194ff7=_0x327b;var _0x12af6f=arguments[_0x194ff7(0x109)],_0x404559=_0x12af6f<0x3?_0x162d09:_0x3e4b52===null?_0x3e4b52=Object[_0x194ff7(0x130)](_0x162d09,_0x4d8486):_0x3e4b52,_0x43252c;if(typeof Reflect==='object'&&typeof Reflect[_0x194ff7(0x17c)]===_0x194ff7(0x108))_0x404559=Reflect['decorate'](_0x4d1fb6,_0x162d09,_0x4d8486,_0x3e4b52);else{for(var _0x36b463=_0x4d1fb6[_0x194ff7(0x109)]-0x1;_0x36b463>=0x0;_0x36b463--)if(_0x43252c=_0x4d1fb6[_0x36b463])_0x404559=(_0x12af6f<0x3?_0x43252c(_0x404559):_0x12af6f>0x3?_0x43252c(_0x162d09,_0x4d8486,_0x404559):_0x43252c(_0x162d09,_0x4d8486))||_0x404559;}return _0x12af6f>0x3&&_0x404559&&Object[_0x194ff7(0x101)](_0x162d09,_0x4d8486,_0x404559),_0x404559;},__metadata=this&&this[_0x1196f3(0x11b)]||function(_0x2ff8a3,_0x565a70){const _0x883910=_0x1196f3;if(typeof Reflect===_0x883910(0x15b)&&typeof Reflect['metadata']===_0x883910(0x108))return Reflect[_0x883910(0x177)](_0x2ff8a3,_0x565a70);},__param=this&&this[_0x1196f3(0x122)]||function(_0x4d6f6a,_0x36a36f){return function(_0x10082a,_0x453f7e){_0x36a36f(_0x10082a,_0x453f7e,_0x4d6f6a);};};Object[_0x1196f3(0x101)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x1196f3(0x11f)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1196f3(0x151)),models_entity_1=require('./models.entity'),status_constant_1=require(_0x1196f3(0x12d)),baidu_1=require(_0x1196f3(0x154)),utils_1=require(_0x1196f3(0x173)),model_constant_1=require(_0x1196f3(0x13b)),jwt=require(_0x1196f3(0x141)),redisCache_service_1=require(_0x1196f3(0x10c)),user_service_1=require('../user/user.service'),redisKey_constant_1=require(_0x1196f3(0x111));let ModelsService=class ModelsService{constructor(_0x39d4b4,_0x3f1b34,_0x41a9ca){const _0x2e1a95=_0x1196f3;this[_0x2e1a95(0x15c)]=_0x39d4b4,this[_0x2e1a95(0x12f)]=_0x3f1b34,this['redisCacheService']=_0x41a9ca,this['modelTypes']=[],this[_0x2e1a95(0x10a)]={},this[_0x2e1a95(0x14e)]={},this[_0x2e1a95(0x10f)]={},this[_0x2e1a95(0x10b)]={};}async['onModuleInit'](){const _0x106635=_0x1196f3;await this[_0x106635(0x178)](),await this[_0x106635(0x163)]();}async[_0x1196f3(0x118)](){const _0x2b092d=_0x1196f3,_0x47c58a=_0x2b092d(0x175),_0x394d77=_0x47c58a+_0x2b092d(0x119);return await fetch(_0x394d77,{'method':_0x2b092d(0x16f),'headers':{'Authorization':_0x2b092d(0x16a)}})[_0x2b092d(0x176)](async _0x14615e=>{const _0x3f4dc2=_0x2b092d,_0x384365=await _0x14615e['json']();return _0x384365[_0x3f4dc2(0x102)];});}async[_0x1196f3(0x178)](){const _0x201954=_0x1196f3;this[_0x201954(0x10f)]={},this[_0x201954(0x10b)]={},this['keyList']={},this[_0x201954(0x10a)]={},this[_0x201954(0x105)]=[];const _0x53629a=await this[_0x201954(0x15c)][_0x201954(0x14c)]({'where':{'status':!![]}}),_0x5f3071=_0x53629a[_0x201954(0x116)]((_0x293bc7,_0x48e593)=>{const _0x4c129e=_0x201954;return!_0x293bc7[_0x48e593['keyType']]?_0x293bc7[_0x48e593['keyType']]=[_0x48e593]:_0x293bc7[_0x48e593[_0x4c129e(0x125)]]['push'](_0x48e593),_0x293bc7;},{});this[_0x201954(0x105)]=Object[_0x201954(0x11d)](_0x5f3071)[_0x201954(0x113)](_0x541fc8=>{return{'label':status_constant_1['ModelsMapCn'][_0x541fc8],'val':_0x541fc8};}),this['modelMaps']=_0x5f3071,this[_0x201954(0x14e)]={},_0x53629a[_0x201954(0x158)](_0x3117f1=>{const _0x1e86df=_0x201954,{keyType:_0x599ed3,model:_0x1ed713,keyWeight:_0xa909bd}=_0x3117f1;if(!this[_0x1e86df(0x10f)][_0x1ed713])this[_0x1e86df(0x10f)][_0x1ed713]=[];for(let _0x1ce9f8=0x0;_0x1ce9f8<_0xa909bd;_0x1ce9f8++){this[_0x1e86df(0x10f)][_0x1ed713][_0x1e86df(0x150)](_0x3117f1);}if(!this['keyPoolIndexMap'][_0x1ed713])this[_0x1e86df(0x10b)][_0x1ed713]=0x0;if(!this[_0x1e86df(0x14e)][_0x599ed3])this[_0x1e86df(0x14e)][_0x599ed3]={};if(!this[_0x1e86df(0x14e)][_0x599ed3][_0x1ed713])this[_0x1e86df(0x14e)][_0x599ed3][_0x1ed713]=[];this[_0x1e86df(0x14e)][_0x599ed3][_0x1ed713][_0x1e86df(0x150)](_0x3117f1);});}async['lockKey'](_0x2e3b14,_0x5a426c,_0xc44b2b=-0x1){const _0x384bbb=_0x1196f3,_0x56baf8=await this[_0x384bbb(0x15c)][_0x384bbb(0x134)]({'id':_0x2e3b14},{'status':![],'keyStatus':_0xc44b2b,'remark':_0x5a426c});common_1[_0x384bbb(0x17e)][_0x384bbb(0x169)](_0x384bbb(0x139)+_0x2e3b14+_0x384bbb(0x136)),await this[_0x384bbb(0x178)]();}async[_0x1196f3(0x126)](_0x2f967a){const _0x29641c=_0x1196f3;return this['modelsEntity'][_0x29641c(0x16e)]({'where':{'modelName':_0x2f967a}});}async[_0x1196f3(0x107)](_0x37f479){const _0xe6614f=_0x1196f3;if(!this[_0xe6614f(0x10f)][_0x37f479])throw new common_1[(_0xe6614f(0x12e))](_0xe6614f(0x16d),common_1[_0xe6614f(0x100)][_0xe6614f(0x112)]);this[_0xe6614f(0x10b)][_0x37f479]++;const _0x37af13=this[_0xe6614f(0x10b)][_0x37f479];if(_0x37af13>=this[_0xe6614f(0x10f)][_0x37f479][_0xe6614f(0x109)])this[_0xe6614f(0x10b)][_0x37f479]=0x0;return this[_0xe6614f(0x10f)][_0x37f479][this[_0xe6614f(0x10b)][_0x37f479]];}async[_0x1196f3(0x156)](_0x7053a0,_0x4abc64){const _0x20489f=_0x1196f3,_0x574477={'modelType':_0x7053a0,'status':!![],'keyStatus':0x1};_0x4abc64&&(_0x574477[_0x20489f(0x157)]=_0x4abc64);const _0x4326c9=await this[_0x20489f(0x15c)][_0x20489f(0x14c)]({'where':_0x574477,'order':{'displaySort':'DESC'}});if(!_0x4326c9[_0x20489f(0x109)])throw new Error(_0x20489f(0x147));const _0x22334a=_0x4326c9[0x0],_0x56cd84=this['modelTypes']['find'](_0x3a1c34=>Number(_0x3a1c34['val'])===_0x22334a[_0x20489f(0x125)]);return{'modelTypeInfo':_0x56cd84,'modelInfo':{..._0x22334a,'topN':0.8,'systemMessage':'','rounds':0x8}};}async[_0x1196f3(0x129)](_0x28367b){const _0x40ab0d=_0x1196f3;try{const {id:_0x47cae4}=_0x28367b;_0x28367b[_0x40ab0d(0x17d)]&&(_0x28367b[_0x40ab0d(0x11e)]=0x1);const _0x2603aa=Object[_0x40ab0d(0x120)]({},_0x28367b);if(_0x47cae4){const _0xd1f2=await this[_0x40ab0d(0x15c)]['update']({'id':_0x47cae4},_0x2603aa);return await this[_0x40ab0d(0x178)](),_0xd1f2[_0x40ab0d(0x170)]>0x0;}else{const _0x5ca88c=await this[_0x40ab0d(0x15c)]['findOne']({'where':{'modelName':_0x2603aa[_0x40ab0d(0x128)]}});if(_0x5ca88c)throw new Error(_0x40ab0d(0x114));const _0xa19983=await this['modelsEntity']['save'](_0x2603aa);return await this[_0x40ab0d(0x178)](),_0x28367b[_0x40ab0d(0x125)]===0x2&&this['refreshBaiduAccesstoken'](),_0xa19983;}}catch(_0x2d221b){console[_0x40ab0d(0x104)](_0x40ab0d(0x13c),_0x2d221b);throw new common_1['HttpException'](_0x2d221b[_0x40ab0d(0x159)],common_1[_0x40ab0d(0x100)]['BAD_REQUEST']);}}async['delModel']({id:_0x5e029a}){const _0x8c0069=_0x1196f3;if(!_0x5e029a)throw new common_1[(_0x8c0069(0x12e))](_0x8c0069(0x140),common_1[_0x8c0069(0x100)][_0x8c0069(0x112)]);const _0xc1acfe=await this[_0x8c0069(0x15c)][_0x8c0069(0x16e)]({'where':{'id':_0x5e029a}});if(!_0xc1acfe)throw new common_1['HttpException'](_0x8c0069(0x168),common_1[_0x8c0069(0x100)][_0x8c0069(0x112)]);const _0x459531=await this[_0x8c0069(0x15c)]['delete']({'id':_0x5e029a});return await this[_0x8c0069(0x178)](),_0x459531;}async[_0x1196f3(0x14b)](_0x1b8f28,_0x1ffc63){const _0x36aee1=_0x1196f3;let _0x21f31a=_0x36aee1(0x162),_0x48b68a;if(_0x1b8f28[_0x36aee1(0x15e)][_0x36aee1(0x106)]){const _0x138157=_0x1b8f28[_0x36aee1(0x15e)][_0x36aee1(0x106)][_0x36aee1(0x167)]('\x20'),_0x202fe1=jwt[_0x36aee1(0x117)](_0x138157[0x1],process['env']['JWT_SECRET']);_0x21f31a=_0x202fe1[_0x36aee1(0xff)],_0x48b68a=_0x202fe1['id'];}const {keyType:_0xb999af,key:_0xbc6bc4,status:_0x520479,model:_0x3cae8b,modelType:_0x46b832,page:page=0x1,size:size=0xa,upload:_0x2baf71}=_0x1ffc63;let _0x49d2c4={};_0x3cae8b&&(_0x49d2c4['model']=_0x3cae8b),_0xb999af&&(_0x49d2c4[_0x36aee1(0x125)]=_0xb999af),_0xbc6bc4&&(_0x49d2c4[_0x36aee1(0x137)]=(0x0,typeorm_2[_0x36aee1(0x135)])('%'+_0xbc6bc4+'%')),_0x46b832&&(_0x49d2c4[_0x36aee1(0x12c)]=_0x46b832),_0x520479&&(_0x49d2c4['status']=Number(_0x520479)===0x1?!![]:![]);_0x2baf71!==undefined&&(_0x49d2c4[_0x36aee1(0x179)]=Boolean(_0x2baf71));_0x21f31a!==_0x36aee1(0x145)&&_0x21f31a!=='super'&&(_0x49d2c4[_0x36aee1(0x17b)]=!![],_0x49d2c4[_0x36aee1(0x17d)]=!![]);const [_0x1daaef,_0x136023]=await this[_0x36aee1(0x15c)]['findAndCount']({'where':_0x49d2c4,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':_0x36aee1(0x17a),'createdAt':_0x36aee1(0x17a)}});_0x21f31a!==_0x36aee1(0x14d)&&_0x1daaef[_0x36aee1(0x158)](_0x9006c8=>{const _0x1c1628=_0x36aee1;_0x9006c8[_0x1c1628(0x137)]=(0x0,utils_1[_0x1c1628(0x121)])(_0x9006c8['key']),_0x9006c8[_0x1c1628(0x123)]=(0x0,utils_1[_0x1c1628(0x121)])(_0x9006c8['secret']),_0x9006c8[_0x1c1628(0x12a)]=(0x0,utils_1[_0x1c1628(0x121)])(_0x9006c8[_0x1c1628(0x12a)]);});if(_0x48b68a){const _0x34cc34=await this[_0x36aee1(0x12f)][_0x36aee1(0x10d)](_0x48b68a);if(_0x34cc34[_0x36aee1(0x133)]||_0x34cc34['lifetimeVip']){const _0x265f30=[];for(let _0x277929=0x0;_0x277929<_0x1daaef[_0x36aee1(0x109)];_0x277929++){const _0x3530ea=_0x1daaef[_0x277929],_0x1eb313=redisKey_constant_1[_0x36aee1(0x142)]+'-'+_0x48b68a+'-'+_0x3530ea['id'],_0x16c8d6=await await this[_0x36aee1(0x110)][_0x36aee1(0x16f)]({'key':_0x1eb313});_0x265f30[_0x36aee1(0x150)](Object['assign']({},_0x3530ea,{'used':_0x16c8d6||0x0}));}return{'rows':_0x265f30,'count':_0x136023};}}return{'rows':_0x1daaef,'count':_0x136023};}async[_0x1196f3(0x165)](_0x26ec32=0x0){const _0x5eb508=_0x1196f3,_0xf09387=(0x0,utils_1['deepClone'])(this[_0x5eb508(0x10a)]);return Object[_0x5eb508(0x11d)](_0xf09387)[_0x5eb508(0x158)](_0x4bb24e=>{const _0x265e10=_0x5eb508;let _0x5ce14f=_0xf09387[_0x4bb24e];if(_0x26ec32===0x0)_0x5ce14f=_0x5ce14f['filter'](_0x4bd448=>Boolean(_0x4bd448[_0x265e10(0x17b)]))[_0x265e10(0x138)]((_0x1f92d3,_0x801b33)=>_0x801b33[_0x265e10(0x131)]-_0x1f92d3['displaySort']);else _0x26ec32===0x2&&(_0x5ce14f=_0x5ce14f[_0x265e10(0x14a)](_0x33640c=>!Boolean(_0x33640c[_0x265e10(0x17b)]))['sort']((_0xf4b1dd,_0x18c05c)=>_0x18c05c[_0x265e10(0x131)]-_0xf4b1dd['displaySort']));_0xf09387[_0x4bb24e]=_0x5ce14f['map'](_0x12c392=>Object[_0x265e10(0x120)]({},_0x12c392));}),{'modelTypeList':this[_0x5eb508(0x105)],'modelMaps':_0xf09387};}async[_0x1196f3(0x152)](_0x214143,_0x387249){const _0x34d500=_0x1196f3;await this[_0x34d500(0x15c)][_0x34d500(0x13e)]()[_0x34d500(0x134)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>_0x34d500(0x10e),'useToken':()=>_0x34d500(0x12b)+_0x387249})[_0x34d500(0x15a)](_0x34d500(0x124),{'id':_0x214143})[_0x34d500(0x115)]();}async[_0x1196f3(0x163)](){const _0xdc7133=_0x1196f3,_0x55e696=await this['modelsEntity'][_0xdc7133(0x14c)]({'where':{'keyType':0x2}}),_0x368ab5={};_0x55e696[_0xdc7133(0x158)](_0x1fc228=>{const _0x5a2738=_0xdc7133,{key:_0x3858f2,secret:_0x3574d3}=_0x1fc228;!_0x368ab5['key']?_0x368ab5[_0x3858f2]=[{'keyInfo':_0x1fc228}]:_0x368ab5[_0x3858f2][_0x5a2738(0x150)](_0x1fc228);}),Object[_0xdc7133(0x11d)](_0x368ab5)[_0xdc7133(0x158)](async _0x14127a=>{const _0x366f24=_0xdc7133,{secret:_0xeac645,id:_0x65167}=_0x368ab5[_0x14127a][0x0][_0x366f24(0x15d)],_0x5ec074=await(0x0,baidu_1[_0x366f24(0x11a)])(_0x14127a,_0xeac645);await this[_0x366f24(0x15c)][_0x366f24(0x134)]({'key':_0x14127a},{'accessToken':_0x5ec074});}),setTimeout(()=>{this['initCalcKey']();},0x3e8);}async['getRandomKey'](_0x5dba05){const _0xc759d1=_0x1196f3,_0x4e4131=await this[_0xc759d1(0x15c)][_0xc759d1(0x14c)]({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x5dba05}});if(!_0x4e4131['length'])throw new common_1[(_0xc759d1(0x12e))](_0xc759d1(0x160),common_1[_0xc759d1(0x100)][_0xc759d1(0x112)]);return _0x4e4131[0x0];}async[_0x1196f3(0x143)](){const _0x3728d2=_0x1196f3,_0x14fd0c=await this[_0x3728d2(0x15c)][_0x3728d2(0x14c)]({'where':{'status':!![],'keyStatus':0x1,'canAudio':!![]}});if(!_0x14fd0c[_0x3728d2(0x109)])throw new common_1[(_0x3728d2(0x12e))](_0x3728d2(0x166),common_1[_0x3728d2(0x100)][_0x3728d2(0x112)]);return _0x14fd0c[0x0];}async['getAllKey'](){const _0x5f026d=_0x1196f3;return await this[_0x5f026d(0x15c)][_0x5f026d(0x14c)]();}async[_0x1196f3(0x155)](){const _0x2e7c64=_0x1196f3;try{const _0x10ea15=await this[_0x2e7c64(0x15c)]['find']({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1[_0x2e7c64(0x13f)]['MUSIC']}});if(_0x10ea15['length']===0x0)throw new Error(_0x2e7c64(0x103));return _0x10ea15[Math[_0x2e7c64(0x17f)](Math[_0x2e7c64(0x161)]()*_0x10ea15[_0x2e7c64(0x109)])];}catch(_0x589de6){throw new common_1[(_0x2e7c64(0x12e))](_0x589de6[_0x2e7c64(0x159)],common_1['HttpStatus']['BAD_REQUEST']);}}};ModelsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1196f3(0x16c)])(models_entity_1[_0x1196f3(0x164)])),__metadata(_0x1196f3(0x13d),[typeorm_2[_0x1196f3(0x13a)],user_service_1['UserService'],redisCache_service_1['RedisCacheService']])],ModelsService),exports[_0x1196f3(0x171)]=ModelsService;