'use strict';const _0x1c271a=_0x7360;function _0x4732(){const _0x198f77=['1817495ghklwm','error','RedisCacheService','3323874BuZebm','refreshBaiduAccesstoken','front','proxyUrl','redisCacheService','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','2960920IdgRYy','3730218FgINcm','HttpException','userService','then','__metadata','当前未指定特殊模型KEY、前往后台设置！','280VFjuWc','typeorm','modelDel','clsService','UserService','metadata','useCount\x20+\x201','function','findAndCount','keyList','BAD_REQUEST','名称已存在，请修改名称','__param','Logger','modelSave','getRole','map','model','sort','keys','lifetimeVip','vipExpire','https://apiv.chatgpt-3.vip','getModelByIds','key','forEach','push','nestjs-cls','../redisCache/redisCache.service','Like','./models.entity','reduce','initCalcKey','canUpload','modelName','queryModels','ModelsEntity','filter','../user/user.service','keyPoolMap','getAllKey','onModuleInit','id\x20=\x20:id','log','val','HttpStatus','findOne','7145831CyUMVO','defineProperty','update','find','ModelsMapCn','isSuper','length','DESC','deepClone','secret','decorate','json','getCurrentModelKeyInfo','35586LUvuaM','createQueryBuilder','status','modelMaps','getOfficialModels','where','getMusicModel','Not','keyInfo','keyPoolIndexMap','../../common/constants/model.constant','当前调用模型已经被移除、请重新选择模型！','hideString','346902eTQfPr','../../common/utils','getModelByName','当前未指定语音对话模型KEY、前往后台设置把！','lockKey','modelTypes','keyType','delModel','../chatgpt/baidu','keyStatus','saveUseLog','displaySort','design:paramtypes','getRandomKey','Injectable','getUserId','message','modelsEntity','InjectRepository','modelType','modelsList','ClsService','__decorate','object','EModelType'];_0x4732=function(){return _0x198f77;};return _0x4732();}(function(_0x45fe44,_0x183bec){const _0x402f4b=_0x7360,_0x48d47a=_0x45fe44();while(!![]){try{const _0x554fea=-parseInt(_0x402f4b(0x243))/0x1+parseInt(_0x402f4b(0x1ed))/0x2+parseInt(_0x402f4b(0x236))/0x3*(-parseInt(_0x402f4b(0x1fa))/0x4)+parseInt(_0x402f4b(0x1ea))/0x5+-parseInt(_0x402f4b(0x1f4))/0x6+parseInt(_0x402f4b(0x229))/0x7+-parseInt(_0x402f4b(0x1f3))/0x8;if(_0x554fea===_0x183bec)break;else _0x48d47a['push'](_0x48d47a['shift']());}catch(_0x4c02ee){_0x48d47a['push'](_0x48d47a['shift']());}}}(_0x4732,0xd6299));var __decorate=this&&this[_0x1c271a(0x1e7)]||function(_0x24628e,_0x1d066d,_0x283b69,_0x11ff5f){const _0x194c60=_0x1c271a;var _0xbae240=arguments[_0x194c60(0x22f)],_0x4fa259=_0xbae240<0x3?_0x1d066d:_0x11ff5f===null?_0x11ff5f=Object['getOwnPropertyDescriptor'](_0x1d066d,_0x283b69):_0x11ff5f,_0xf1471d;if(typeof Reflect===_0x194c60(0x1e8)&&typeof Reflect[_0x194c60(0x233)]==='function')_0x4fa259=Reflect[_0x194c60(0x233)](_0x24628e,_0x1d066d,_0x283b69,_0x11ff5f);else{for(var _0x2d4b7c=_0x24628e[_0x194c60(0x22f)]-0x1;_0x2d4b7c>=0x0;_0x2d4b7c--)if(_0xf1471d=_0x24628e[_0x2d4b7c])_0x4fa259=(_0xbae240<0x3?_0xf1471d(_0x4fa259):_0xbae240>0x3?_0xf1471d(_0x1d066d,_0x283b69,_0x4fa259):_0xf1471d(_0x1d066d,_0x283b69))||_0x4fa259;}return _0xbae240>0x3&&_0x4fa259&&Object[_0x194c60(0x22a)](_0x1d066d,_0x283b69,_0x4fa259),_0x4fa259;},__metadata=this&&this[_0x1c271a(0x1f8)]||function(_0x128034,_0xe29601){const _0x32920d=_0x1c271a;if(typeof Reflect===_0x32920d(0x1e8)&&typeof Reflect[_0x32920d(0x1ff)]===_0x32920d(0x201))return Reflect['metadata'](_0x128034,_0xe29601);},__param=this&&this[_0x1c271a(0x206)]||function(_0x203e80,_0x1c057c){return function(_0x114868,_0x516391){_0x1c057c(_0x114868,_0x516391,_0x203e80);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x1c271a(0x1fb)),models_entity_1=require(_0x1c271a(0x218)),status_constant_1=require('../../common/constants/status.constant'),baidu_1=require(_0x1c271a(0x1d9)),utils_1=require(_0x1c271a(0x244)),model_constant_1=require(_0x1c271a(0x240)),redisCache_service_1=require(_0x1c271a(0x216)),user_service_1=require(_0x1c271a(0x220)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),nestjs_cls_1=require(_0x1c271a(0x215));function _0x7360(_0x2f47bb,_0x5cd6ed){const _0x4732b5=_0x4732();return _0x7360=function(_0x7360dd,_0x30bea0){_0x7360dd=_0x7360dd-0x1d9;let _0x72eed0=_0x4732b5[_0x7360dd];return _0x72eed0;},_0x7360(_0x2f47bb,_0x5cd6ed);}let ModelsService=class ModelsService{constructor(_0x359096,_0x4a4be0,_0x139e7d,_0x16aaa8){const _0x5c0f8c=_0x1c271a;this[_0x5c0f8c(0x1e2)]=_0x359096,this['clsService']=_0x4a4be0,this['userService']=_0x139e7d,this[_0x5c0f8c(0x1f1)]=_0x16aaa8,this[_0x5c0f8c(0x248)]=[],this[_0x5c0f8c(0x239)]={},this['keyList']={},this[_0x5c0f8c(0x221)]={},this[_0x5c0f8c(0x23f)]={};}async[_0x1c271a(0x223)](){const _0x440055=_0x1c271a;await this[_0x440055(0x21a)](),await this[_0x440055(0x1ee)]();}async[_0x1c271a(0x23a)](){const _0x4bb9a6=_0x1c271a,_0x583277=_0x4bb9a6(0x210),_0x4ad0c6=_0x583277+'/v1/models';return await fetch(_0x4ad0c6,{'method':'get','headers':{'Authorization':_0x4bb9a6(0x1f2)}})[_0x4bb9a6(0x1f7)](async _0x3436e7=>{const _0x497e7a=_0x4bb9a6,_0x2a04bb=await _0x3436e7[_0x497e7a(0x234)]();return _0x2a04bb['data'];});}async[_0x1c271a(0x21a)](){const _0x53a118=_0x1c271a;this[_0x53a118(0x221)]={},this[_0x53a118(0x23f)]={},this['keyList']={},this['modelMaps']={},this[_0x53a118(0x248)]=[];const _0x3edfcf=await this['modelsEntity']['find']({'where':{'status':!![]}}),_0x5851bc=_0x3edfcf[_0x53a118(0x219)]((_0x5965bc,_0x2dfbca)=>{const _0x32dda4=_0x53a118;return!_0x5965bc[_0x2dfbca[_0x32dda4(0x249)]]?_0x5965bc[_0x2dfbca[_0x32dda4(0x249)]]=[_0x2dfbca]:_0x5965bc[_0x2dfbca[_0x32dda4(0x249)]][_0x32dda4(0x214)](_0x2dfbca),_0x5965bc;},{});this[_0x53a118(0x248)]=Object[_0x53a118(0x20d)](_0x5851bc)[_0x53a118(0x20a)](_0x1b2458=>{const _0x456fe1=_0x53a118;return{'label':status_constant_1[_0x456fe1(0x22d)][_0x1b2458],'val':_0x1b2458};}),this['modelMaps']=_0x5851bc,this['keyList']={},_0x3edfcf['forEach'](_0xfc4019=>{const _0x25a97b=_0x53a118,{keyType:_0x569a08,model:_0x251099,keyWeight:_0x5cd3ed}=_0xfc4019;if(!this['keyPoolMap'][_0x251099])this['keyPoolMap'][_0x251099]=[];for(let _0x7b8345=0x0;_0x7b8345<_0x5cd3ed;_0x7b8345++){this[_0x25a97b(0x221)][_0x251099][_0x25a97b(0x214)](_0xfc4019);}if(!this[_0x25a97b(0x23f)][_0x251099])this[_0x25a97b(0x23f)][_0x251099]=0x0;if(!this[_0x25a97b(0x203)][_0x569a08])this[_0x25a97b(0x203)][_0x569a08]={};if(!this[_0x25a97b(0x203)][_0x569a08][_0x251099])this[_0x25a97b(0x203)][_0x569a08][_0x251099]=[];this[_0x25a97b(0x203)][_0x569a08][_0x251099][_0x25a97b(0x214)](_0xfc4019);});}async[_0x1c271a(0x247)](_0x3b47e7,_0x1f8eab,_0x410c57=-0x1){const _0x1511fa=_0x1c271a,_0x80b1a7=await this[_0x1511fa(0x1e2)][_0x1511fa(0x22b)]({'id':_0x3b47e7},{'status':![],'keyStatus':_0x410c57,'remark':_0x1f8eab});common_1[_0x1511fa(0x207)][_0x1511fa(0x1eb)]('key:\x20'+_0x3b47e7+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),await this[_0x1511fa(0x21a)]();}async[_0x1c271a(0x245)](_0x55d9b9){const _0x1d2c86=_0x1c271a;return this['modelsEntity'][_0x1d2c86(0x228)]({'where':{'modelName':_0x55d9b9}});}async[_0x1c271a(0x235)](_0x21b662){const _0x5beb0c=_0x1c271a;if(!this[_0x5beb0c(0x221)][_0x21b662])throw new common_1['HttpException'](_0x5beb0c(0x241),common_1[_0x5beb0c(0x227)][_0x5beb0c(0x204)]);this[_0x5beb0c(0x23f)][_0x21b662]++;const _0x1d5ffa=this[_0x5beb0c(0x23f)][_0x21b662];if(_0x1d5ffa>=this[_0x5beb0c(0x221)][_0x21b662][_0x5beb0c(0x22f)])this[_0x5beb0c(0x23f)][_0x21b662]=0x0;return this[_0x5beb0c(0x221)][_0x21b662][this['keyPoolIndexMap'][_0x21b662]];}async['getModelByType'](_0xa84009,_0x162be0){const _0x2144dd=_0x1c271a,_0x49a006={'modelType':_0xa84009,'status':!![],'keyStatus':0x1};_0x162be0&&(_0x49a006[_0x2144dd(0x20b)]=_0x162be0);const _0x123bff=await this[_0x2144dd(0x1e2)][_0x2144dd(0x22c)]({'where':_0x49a006,'order':{'displaySort':'DESC'}});if(!_0x123bff['length'])throw new Error('暂未配置相关模型，请联系管理员！');const _0x5f51c6=_0x123bff[0x0],_0x3ed0d0=this[_0x2144dd(0x248)][_0x2144dd(0x22c)](_0xe89d5a=>Number(_0xe89d5a[_0x2144dd(0x226)])===_0x5f51c6[_0x2144dd(0x249)]);return{'modelTypeInfo':_0x3ed0d0,'modelInfo':{..._0x5f51c6,'topN':0.8,'systemMessage':'','rounds':0x8}};}async['setModel'](_0x2aad37){const _0x4268f7=_0x1c271a;try{return await this['modelSave'](_0x2aad37),await this['initCalcKey'](),_0x2aad37['keyType']===0x2&&this['refreshBaiduAccesstoken'](),!![];}catch(_0x4447aa){console[_0x4268f7(0x225)]('error:\x20',_0x4447aa);throw new common_1[(_0x4268f7(0x1f5))](_0x4447aa[_0x4268f7(0x1e1)],common_1[_0x4268f7(0x227)]['BAD_REQUEST']);}}async[_0x1c271a(0x208)](_0x2144d2){const _0x21b39b=_0x1c271a;_0x2144d2[_0x21b39b(0x238)]&&(_0x2144d2[_0x21b39b(0x1da)]=0x1);if(_0x2144d2['id']){const _0x284f8c=await this['modelsEntity'][_0x21b39b(0x228)]({'where':{'id':(0x0,typeorm_2[_0x21b39b(0x23d)])(_0x2144d2['id']),'modelName':_0x2144d2[_0x21b39b(0x21c)],'modelType':_0x2144d2['modelType']}});if(_0x284f8c)throw new Error(_0x21b39b(0x205));await this[_0x21b39b(0x1e2)][_0x21b39b(0x22b)]({'id':_0x2144d2['id']},_0x2144d2);}else{const _0x3c77df=await this[_0x21b39b(0x1e2)][_0x21b39b(0x228)]({'where':{'modelName':_0x2144d2[_0x21b39b(0x21c)],'modelType':_0x2144d2[_0x21b39b(0x1e4)]}});if(_0x3c77df)throw new Error(_0x21b39b(0x205));await this[_0x21b39b(0x1e2)]['save'](_0x2144d2);}}async[_0x1c271a(0x24a)]({id:_0x18c8ce}){const _0x58c2fa=_0x1c271a;if(!_0x18c8ce)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x58c2fa(0x227)][_0x58c2fa(0x204)]);return await this['modelDel']([_0x18c8ce]),await this[_0x58c2fa(0x21a)](),!![];}async[_0x1c271a(0x1fc)](_0x21ebe7){const _0x2f1d4f=_0x1c271a;if(!_0x21ebe7||!_0x21ebe7['length'])return!![];return await this[_0x2f1d4f(0x1e2)]['delete']({'id':(0x0,typeorm_2['In'])(_0x21ebe7)}),!![];}async[_0x1c271a(0x21d)](_0x58d87a,_0x313cad){const _0x5cfcac=_0x1c271a,_0x38d042=(0x0,utils_1[_0x5cfcac(0x209)])(this[_0x5cfcac(0x1fd)]),_0x2b1c21=(0x0,utils_1[_0x5cfcac(0x1e0)])(this[_0x5cfcac(0x1fd)]),{keyType:_0x358fcc,key:_0x2e29c3,status:_0x4f289a,model:_0x32d615,modelName:_0x58e463,modelType:_0x2224ec,page:page=0x1,size:size=0xa,upload:_0x51198d}=_0x313cad;let _0x1bcad8={};_0x32d615&&(_0x1bcad8['model']=_0x32d615);_0x2e29c3&&(_0x1bcad8[_0x5cfcac(0x212)]=(0x0,typeorm_2[_0x5cfcac(0x217)])('%'+_0x2e29c3+'%'));_0x358fcc&&(_0x1bcad8['keyType']=_0x358fcc);_0x2224ec&&(_0x1bcad8[_0x5cfcac(0x1e4)]=_0x2224ec);_0x4f289a!==undefined&&(_0x1bcad8[_0x5cfcac(0x238)]=_0x4f289a);_0x58e463&&(_0x1bcad8[_0x5cfcac(0x21c)]=(0x0,typeorm_2['Like'])('%'+_0x58e463+'%'));_0x51198d!==undefined&&(_0x1bcad8[_0x5cfcac(0x21b)]=Boolean(_0x51198d));!(0x0,utils_1[_0x5cfcac(0x22e)])(this[_0x5cfcac(0x1fd)])&&(_0x1bcad8[_0x5cfcac(0x1ef)]=!![],_0x1bcad8[_0x5cfcac(0x238)]=!![]);const [_0x529246,_0x2b11ff]=await this[_0x5cfcac(0x1e2)][_0x5cfcac(0x202)]({'where':_0x1bcad8,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':_0x5cfcac(0x230),'createdAt':_0x5cfcac(0x230)}});!(0x0,utils_1[_0x5cfcac(0x22e)])(this['clsService'])&&_0x529246['forEach'](_0x41c9ce=>{const _0x580130=_0x5cfcac;_0x41c9ce[_0x580130(0x212)]=(0x0,utils_1[_0x580130(0x242)])(_0x41c9ce[_0x580130(0x212)]),_0x41c9ce[_0x580130(0x232)]=(0x0,utils_1[_0x580130(0x242)])(_0x41c9ce[_0x580130(0x232)]),_0x41c9ce[_0x580130(0x1f0)]=(0x0,utils_1['hideString'])(_0x41c9ce[_0x580130(0x1f0)]);});if(_0x2b1c21){const _0x5235f6=await this[_0x5cfcac(0x1f6)]['getUserById'](_0x2b1c21);if(_0x5235f6[_0x5cfcac(0x20f)]||_0x5235f6[_0x5cfcac(0x20e)]){const _0xc2a248=[];for(let _0xb8d2cf=0x0;_0xb8d2cf<_0x529246[_0x5cfcac(0x22f)];_0xb8d2cf++){const _0x1bf7f1=_0x529246[_0xb8d2cf],_0x43e50f=redisKey_constant_1['VIP_FREE']+'-'+_0x2b1c21+'-'+_0x1bf7f1['id'],_0x2707ae=await await this[_0x5cfcac(0x1f1)]['get']({'key':_0x43e50f});_0xc2a248['push'](Object['assign']({},_0x1bf7f1,{'used':_0x2707ae||0x0}));}return{'rows':_0xc2a248,'count':_0x2b11ff};}}return{'rows':_0x529246,'count':_0x2b11ff};}['getModelById'](_0x38bfc4){const _0x342a42=_0x1c271a;return this['modelsEntity'][_0x342a42(0x228)]({'where':{'id':_0x38bfc4}});}[_0x1c271a(0x211)](_0x504b74){const _0x2ef0b0=_0x1c271a;return this[_0x2ef0b0(0x1e2)][_0x2ef0b0(0x22c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x504b74)}});}async[_0x1c271a(0x1e5)](_0x575f69=0x0){const _0x2ecc08=_0x1c271a,_0x446229=(0x0,utils_1[_0x2ecc08(0x231)])(this[_0x2ecc08(0x239)]);return Object[_0x2ecc08(0x20d)](_0x446229)[_0x2ecc08(0x213)](_0x587b42=>{const _0x491e06=_0x2ecc08;let _0x314b21=_0x446229[_0x587b42];if(_0x575f69===0x0)_0x314b21=_0x314b21[_0x491e06(0x21f)](_0x92327f=>Boolean(_0x92327f[_0x491e06(0x1ef)]))[_0x491e06(0x20c)]((_0x1f1a1b,_0x8730ba)=>_0x8730ba['displaySort']-_0x1f1a1b['displaySort']);else _0x575f69===0x2&&(_0x314b21=_0x314b21[_0x491e06(0x21f)](_0x1b0b51=>!Boolean(_0x1b0b51[_0x491e06(0x1ef)]))[_0x491e06(0x20c)]((_0x41edb4,_0x1706e0)=>_0x1706e0[_0x491e06(0x1dc)]-_0x41edb4['displaySort']));_0x446229[_0x587b42]=_0x314b21[_0x491e06(0x20a)](_0x27284d=>Object['assign']({},_0x27284d));}),{'modelTypeList':this[_0x2ecc08(0x248)],'modelMaps':_0x446229};}async[_0x1c271a(0x1db)](_0x213cb9,_0x1e902d){const _0x20932c=_0x1c271a;await this[_0x20932c(0x1e2)][_0x20932c(0x237)]()['update'](models_entity_1[_0x20932c(0x21e)])['set']({'useCount':()=>_0x20932c(0x200),'useToken':()=>'useToken\x20+\x20'+_0x1e902d})[_0x20932c(0x23b)](_0x20932c(0x224),{'id':_0x213cb9})['execute']();}async[_0x1c271a(0x1ee)](){const _0x3d41bb=_0x1c271a,_0x292497=await this[_0x3d41bb(0x1e2)][_0x3d41bb(0x22c)]({'where':{'keyType':0x2}}),_0x550667={};_0x292497[_0x3d41bb(0x213)](_0xdbf510=>{const _0x821716=_0x3d41bb,{key:_0x42d815,secret:_0x2d0eb2}=_0xdbf510;!_0x550667[_0x821716(0x212)]?_0x550667[_0x42d815]=[{'keyInfo':_0xdbf510}]:_0x550667[_0x42d815][_0x821716(0x214)](_0xdbf510);}),Object[_0x3d41bb(0x20d)](_0x550667)['forEach'](async _0x31119b=>{const _0x54ef97=_0x3d41bb,{secret:_0x3d8737,id:_0x54831d}=_0x550667[_0x31119b][0x0][_0x54ef97(0x23e)],_0xfd53bd=await(0x0,baidu_1['getAccessToken'])(_0x31119b,_0x3d8737);await this[_0x54ef97(0x1e2)][_0x54ef97(0x22b)]({'key':_0x31119b},{'accessToken':_0xfd53bd});}),setTimeout(()=>{this['initCalcKey']();},0x3e8);}async[_0x1c271a(0x1de)](_0x3d19c2){const _0x4b2973=_0x1c271a,_0x246065=await this['modelsEntity'][_0x4b2973(0x22c)]({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x3d19c2},'order':{'displaySort':_0x4b2973(0x230)}});if(!_0x246065['length'])throw new common_1[(_0x4b2973(0x1f5))](_0x4b2973(0x1f9),common_1[_0x4b2973(0x227)][_0x4b2973(0x204)]);return _0x246065[0x0];}async['getRandomAudioKey'](){const _0x22d607=_0x1c271a,_0x262231=await this['modelsEntity'][_0x22d607(0x22c)]({'where':{'status':!![],'keyStatus':0x1,'canAudio':!![]}});if(!_0x262231[_0x22d607(0x22f)])throw new common_1[(_0x22d607(0x1f5))](_0x22d607(0x246),common_1['HttpStatus']['BAD_REQUEST']);return _0x262231[0x0];}async[_0x1c271a(0x222)](){const _0x4e3e02=_0x1c271a;return await this[_0x4e3e02(0x1e2)][_0x4e3e02(0x22c)]();}async[_0x1c271a(0x23c)](){const _0x25fe8d=_0x1c271a;try{const _0x42c845=await this[_0x25fe8d(0x1e2)][_0x25fe8d(0x22c)]({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1[_0x25fe8d(0x1e9)]['MUSIC']}});if(_0x42c845['length']===0x0)throw new Error('暂未配置音乐模型，请联系管理员');return _0x42c845[Math['floor'](Math['random']()*_0x42c845[_0x25fe8d(0x22f)])];}catch(_0x4bca84){throw new common_1['HttpException'](_0x4bca84[_0x25fe8d(0x1e1)],common_1[_0x25fe8d(0x227)][_0x25fe8d(0x204)]);}}};ModelsService=__decorate([(0x0,common_1[_0x1c271a(0x1df)])(),__param(0x0,(0x0,typeorm_1[_0x1c271a(0x1e3)])(models_entity_1['ModelsEntity'])),__metadata(_0x1c271a(0x1dd),[typeorm_2['Repository'],nestjs_cls_1[_0x1c271a(0x1e6)],user_service_1[_0x1c271a(0x1fe)],redisCache_service_1[_0x1c271a(0x1ec)]])],ModelsService),exports['ModelsService']=ModelsService;