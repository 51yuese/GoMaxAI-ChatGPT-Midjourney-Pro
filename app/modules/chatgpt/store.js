'use strict';const _0x1cc6a6=_0x1516;(function(_0x22640c,_0x32147f){const _0x38b539=_0x1516,_0x479fb5=_0x22640c();while(!![]){try{const _0x152a50=parseInt(_0x38b539(0x126))/0x1+-parseInt(_0x38b539(0x10b))/0x2+parseInt(_0x38b539(0x11e))/0x3*(parseInt(_0x38b539(0x11a))/0x4)+parseInt(_0x38b539(0x103))/0x5*(parseInt(_0x38b539(0x116))/0x6)+parseInt(_0x38b539(0x107))/0x7+parseInt(_0x38b539(0x101))/0x8+-parseInt(_0x38b539(0x127))/0x9;if(_0x152a50===_0x32147f)break;else _0x479fb5['push'](_0x479fb5['shift']());}catch(_0x13261d){_0x479fb5['push'](_0x479fb5['shift']());}}}(_0xae7d,0x19892));function _0x1516(_0x2e54d7,_0x16e03b){const _0x15160d=_0xae7d();return _0x1516=function(_0xdd156c,_0xda3e8b){_0xdd156c=_0xdd156c-0x100;let _0xbcc298=_0x15160d[_0xdd156c];return _0xbcc298;},_0x1516(_0x2e54d7,_0x16e03b);}function _0xae7d(){const _0x468626=['encode','slice','parentMessageId','content','get','split','368382hiVlVF','expires','_getTokenCount','get_encoding','184VmJxii','push','min','reduce','5586xeOCaP','join','namespace','length','test','log','_recursivePruning','store','111121QGtkha','3205377mkamYz','chat','splice','text','generateKey','formatOptions','41368eYRgdU','user','10HgevfI','defineProperty','NineStore','buildMessageFromParentMessageId','1322874soyMAP','getUuid','setData','getData','105946TEvJPw','set','image_url','system','__esModule'];_0xae7d=function(){return _0x468626;};return _0xae7d();}Object[_0x1cc6a6(0x104)](exports,_0x1cc6a6(0x10f),{'value':!![]}),exports[_0x1cc6a6(0x105)]=void 0x0;const uuid_1=require('uuid'),tiktoken_1=require('@dqbd/tiktoken'),tokenizer=(0x0,tiktoken_1[_0x1cc6a6(0x119)])('cl100k_base');class NineStore{constructor(_0x3b0765){const _0x117bc4=_0x1cc6a6,{store:_0x36fdb8,namespace:_0x1707d4,expires:_0x1f0836}=this[_0x117bc4(0x100)](_0x3b0765);this['store']=_0x36fdb8,this[_0x117bc4(0x120)]=_0x1707d4,this[_0x117bc4(0x117)]=_0x1f0836;}['formatOptions'](_0x484e5a){const _0x1db4b9=_0x1cc6a6,{store:_0x442fdc,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x1db4b9(0x128)}=_0x484e5a;return{'store':_0x442fdc,'namespace':namespace,'expires':expires};}[_0x1cc6a6(0x12b)](_0x50a9cd){const _0x1c4d64=_0x1cc6a6;return this['namespace']?this[_0x1c4d64(0x120)]+'-'+_0x50a9cd:_0x50a9cd;}async[_0x1cc6a6(0x10a)](_0x28f000){const _0x51ef91=_0x1cc6a6,_0x23002d=await this[_0x51ef91(0x125)][_0x51ef91(0x114)](_0x28f000);return _0x23002d;}async[_0x1cc6a6(0x109)](_0xe26290,_0x8efe33=this[_0x1cc6a6(0x117)]){const _0x4766d8=_0x1cc6a6;await this['store'][_0x4766d8(0x10c)](_0xe26290['id'],_0xe26290,_0x8efe33);}async[_0x1cc6a6(0x106)](_0x4652da,_0xed4847){const _0x4c3e2b=_0x1cc6a6;let {maxRounds:_0x2cb1c3,maxModelToken:_0x45dde8,maxResponseTokens:_0x2c2e4b,systemMessage:systemMessage='',name:_0x40d725}=_0xed4847,{parentMessageId:_0xc4ce38}=_0xed4847,_0x496bd1=[],_0x30dfde=0x0;systemMessage&&_0x496bd1[_0x4c3e2b(0x11b)]({'role':_0x4c3e2b(0x10e),'content':systemMessage});const _0x5355f6=_0x496bd1[_0x4c3e2b(0x121)];let _0x1fb371=0x0;if(_0x4652da){let _0x37aeac=!![];const _0x3f6e8c=[],_0x25488f=[],_0x293b7c=_0x4652da[_0x4c3e2b(0x115)]('\x20');for(let _0x262712=0x0;_0x262712<_0x293b7c[_0x4c3e2b(0x121)];_0x262712++){_0x37aeac&&/^[http:\/\/|https:\/\/]/[_0x4c3e2b(0x122)](_0x293b7c[_0x262712])?_0x3f6e8c[_0x4c3e2b(0x11b)](_0x293b7c[_0x262712]):(_0x37aeac=![],_0x293b7c[_0x262712]&&_0x25488f[_0x4c3e2b(0x11b)](_0x293b7c[_0x262712]));}let _0x5c1d25=[];for(const _0x124824 of _0x3f6e8c){_0x5c1d25[_0x4c3e2b(0x11b)]({'type':_0x4c3e2b(0x10d),'image_url':{'url':_0x124824}});}_0x5c1d25['length']?_0x496bd1[_0x4c3e2b(0x11b)]({'role':_0x4c3e2b(0x102),'content':[{'text':_0x25488f['join']('\x20'),'type':_0x4c3e2b(0x12a)},..._0x5c1d25]}):_0x496bd1[_0x4c3e2b(0x11b)]({'role':'user','content':_0x25488f[_0x4c3e2b(0x11f)]('\x20'),'name':_0x40d725});}let _0x4ccfd1=_0x496bd1;do{if(!_0xc4ce38)break;const _0xbfdcb5=await this['getData'](_0xc4ce38);if(!_0xbfdcb5)break;const {text:_0x230f95,name:_0x33732d,role:_0x9aaa34}=_0xbfdcb5;_0x4ccfd1=_0x4ccfd1['slice'](0x0,_0x5355f6)['concat']([{'role':_0x9aaa34,'content':_0x230f95,'name':_0x33732d},..._0x4ccfd1[_0x4c3e2b(0x111)](_0x5355f6)]),_0x1fb371++;if(_0x2cb1c3&&_0x1fb371>=_0x2cb1c3)break;if(_0x45dde8&&_0x2c2e4b){const _0x475d6a=_0x45dde8-_0x2c2e4b;_0x30dfde=await this['_getTokenCount'](_0x4ccfd1);const _0x21f4a3=_0x30dfde+0xc8<=_0x475d6a;!_0x21f4a3&&(_0x4ccfd1=this[_0x4c3e2b(0x124)](_0x496bd1,_0x475d6a,systemMessage));}_0xc4ce38=_0xbfdcb5[_0x4c3e2b(0x112)];}while(!![]);const _0x484c2c=Math['max'](0x1,Math[_0x4c3e2b(0x11c)](_0x45dde8-_0x30dfde,_0x2c2e4b));return _0x4ccfd1;}async[_0x1cc6a6(0x118)](_0x4cbe3e){const _0x2def29=_0x1cc6a6;let _0x43ffcf=_0x4cbe3e[_0x2def29(0x11d)]((_0x2edd64,_0x280ffa)=>{const _0x4fb098=_0x2def29;return _0x2edd64+=_0x280ffa[_0x4fb098(0x113)];},'');return console[_0x2def29(0x123)]('汇总的文本数量:\x20',_0x43ffcf),_0x43ffcf=_0x43ffcf['replace'](/<\|endoftext\|>/g,''),tokenizer[_0x2def29(0x110)](_0x43ffcf)[_0x2def29(0x121)];}async[_0x1cc6a6(0x124)](_0x55114a,_0x1ac4f6,_0x2ea850){const _0x164271=_0x1cc6a6,_0x4f0f0b=await this[_0x164271(0x118)](_0x55114a);if(_0x4f0f0b<=_0x1ac4f6)return _0x55114a;return _0x55114a[_0x164271(0x129)](_0x2ea850?0x1:0x0,0x1),this[_0x164271(0x124)](_0x55114a,_0x1ac4f6,_0x2ea850);}[_0x1cc6a6(0x108)](){return(0x0,uuid_1['v4'])();}}exports['NineStore']=NineStore;