'use strict';const _0x2fe4bb=_0x1e61;(function(_0x293cbe,_0x311479){const _0x92feb0=_0x1e61,_0x392017=_0x293cbe();while(!![]){try{const _0x267a05=-parseInt(_0x92feb0(0x26b))/0x1*(parseInt(_0x92feb0(0x293))/0x2)+parseInt(_0x92feb0(0x379))/0x3+-parseInt(_0x92feb0(0x368))/0x4*(-parseInt(_0x92feb0(0x325))/0x5)+parseInt(_0x92feb0(0x252))/0x6+-parseInt(_0x92feb0(0x343))/0x7+-parseInt(_0x92feb0(0x2af))/0x8*(parseInt(_0x92feb0(0x336))/0x9)+parseInt(_0x92feb0(0x220))/0xa;if(_0x267a05===_0x311479)break;else _0x392017['push'](_0x392017['shift']());}catch(_0x128957){_0x392017['push'](_0x392017['shift']());}}}(_0xbd85,0x723ce));function _0x1e61(_0x367dcd,_0x29ffbc){const _0xbd8513=_0xbd85();return _0x1e61=function(_0x1e6157,_0xc175ba){_0x1e6157=_0x1e6157-0x1a3;let _0x1ad713=_0xbd8513[_0x1e6157];return _0x1ad713;},_0x1e61(_0x367dcd,_0x29ffbc);}function _0xbd85(){const _0x21fdc7=['Connection','2022-08-31','SunoTaskService','pptx_url','createReadStream','audio2text\x20','checkUserStatus','lockKey','Like','addOneIfOdd','../../common/constants/balance.constant','preset','\x20image_end_url\x20','model_name','conversationOptions','../api/lumaTask.service','keyType','\x0a\x20\x20\x20\x20\x20\x20','getUserModelFree','musicCreate','checkAutoReply','pptDownload','Transfer-Encoding','getRandomAudioKey','email','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','sunoMusicTask','chatMusicUpload','music-task','../../common/constants/chat.constant','transaction','customSystemMessage','object','schoolPicture','openai','stream','removeFile','gpt-4','task_result','ChatGPTAPI','3221424lGstRX','options','当前模型key余额已耗尽，请充值！','audio','vipFreeNum','listByGroupId','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','complex','../api/sunoTask.service','make_instrumental','png_down_url','voiceChat','pleader','yoo_task_id','assistant','pptTaskEntity','EModelType','openai-draw','preview_url','../autoreply/autoreply.service','32k','phone','POST','../../common/utils','Bearer\x20','3ECOSUJ','errMsg','GptsService','toString','../gpts/gpts.service','file-extract','EPPTTaskType','sendMessageFromZhipu','parse','fontName','模型秘钥错误或模型余额不足','log','chatGroupService','asr','gptsService','isSuper','Beare\x20','choices','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20pdf_down_url\x20is\x20null','png','../../common/constants/music.constant','[耗时打印]文字对话耗时：','runwayTaskService','pdf_down_url','userId','toISOString','validateBeforeDraw','startTime','PPTConfig','kling-video_std_5','https://ark.cn-beijing.volces.com','uncollectByRelIds','lyrics','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','/api/chatLog/notify-Suno-lyrics?id=','SUCCEEDED','DeductionKey','-------------openAiErrHandler--------------','modelInfo','is_end','246524SHQXwC','debuctBalance4PPT','pptResult','appid','crypto','update','ClsService','../../common/result','videos','modelType','buildOptions','AUC7419233800922468658','pptAddNote','jmengImageTask','author','pptReCover','image_url','pptDel','application/octet-stream','thirdId','price','getReqSaasId','content','configChatGptApi','MUSIC','updated_at','jmengvideo-task','task_id','8BQIzEl','Please\x20check\x20the\x20back-end\x20console','post','/api/v3','aspect_ratio','binary_data_base64','api','图片生成失败','statusCode','length','MindTaskService','whisper-1','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','config','../chatGroup/chatGroup.service','Content-type','SunoMusicTask','create','UPLOAD','school','messageStore','语音转换失败','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','notifyAsr','music','/v1','volcano_tts','getConfigByKeys','pptCover','当前请求已过载、请稍等会儿再试试吧！','Price','getModelByType','then','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','chatMusicLyrics','stringify','video_url','PPT','redis://','X-Accel-Buffering','base64','\x20--aspect_ratio\x20','buffer','originTaskId','ModelsService','原始任务不存在！','200','code','cwd','模型类型不存在','__decorate','Unauthorized','data:\x20','parentMessageId','chatTask','aac','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','mkdirSync','startsWith','Repository','notify_hook','responseMessageWithThink','mindTaskId','ASR','count','pptEditorVipFree','deductBalance4Draw','catch','progress','saveChatLog','created_at','服务异常、请重新试试吧！！！','getGroupInfoFromId','Speech_Synthesis7418877984234656063','collectPage','split','video-task','end','REDIS_HOST','extend','status','editorUrl','getAppById','removeSpecialCharacters','chatDraw','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','last_image','getDrawFree','fileUrl','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','subTitle','deductBalance4Chat','task_status','abort','abortController','all','jmengChatVideo','kling-draw-task','page_count','error','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','response.length','/api/chatLog/notify-Suno-upload?id=','../chatLog/chatLog.service','validateBalance4Video','initOpenAi','../../common/constants/model.constant','message','pptCreate','reasoning_content','prompt\x20','ids','sunoTaskService','slice','listUndoneVideoForLuma','视频生成失败','sendMessageFromFastgpt','musicLyricsVipFree','5xnQYAB','process_url','CHAT_TYPE','toLowerCase','slideType','musicConfig','openaiModel4MaxTokens32k','openaiModel3MaxTokens16k','../api/doubao.service','https://api.openai.com','Logger','checkBadWords','arrayBuffer','schoolLogo','completions','chatMuiscTask','from','2671686xLVvjc','usage','createAPI','curIp','writeFileSync','pptService','getModelInfoByKeyType','accessToken','groupId','modelId','state_description','buildMessageFromParentMessageId','deductBalance4Video','4961446LyrnmL','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x20and\x20(type=\x27create\x27\x20or\x20type=\x27file\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','uuid','state','debug','download_url','modelSubType','__param','result','globalConfigService','resCover','defineProperty','trim','key','ADDPAGE','totalTokens','style','creat','./store','doubaoService','push','connection','query','musicUpload','getModelByKeyModel','fastgpt','pptCollectPage','badwordsService','prompt','Invalid\x20user\x20information','/api/chatgpt/notify-asr','design:paramtypes','./spark','音乐生成失败，没有响应','Error\x20in\x20pptConfig:','pptCreateFile','\x20image_url\x20','3255364MLEmOe','files','color','defaultBaseUrl','endTime','getTime','getModelById','LessThan','提供了错误的模型秘钥','validateBeforeChat','getRandomKey','GOMAXAI_HOST','setHeader','模型秘钥错误或模型金额不足，请联系管理员！','map','EChatType','CVSync2AsyncSubmitTask','364803nduLaW','sendMessage','formatModelToken','t2v','string','validateBalance4Draw','ADDNOTES','getCurrentModel','gomaxai-chatlog','application/octet-stream;\x20charset=utf-8','--------------------CHATDRAW--------------------','gpts','sunoMusicId','@nestjs/typeorm','../api/runwayTask.service','pop','path','pptCreateVipFree','runwayVideoTask','pptAddPage','getKeyFree','YooPPTService','gomaxAiStore','EMusicTaskType','pptDetail','Injectable','userService','progressUrl','coverId','message_id','https://','openAiErrHandler','getCurrentModelByChatGroupId','klingVideoTask','maskEmail','apiKey','modelOptions','detail','kimiUpload','answerMp3','OTHER','findAndCount','request','../../common/store','getDrawModelVipFree','REDIS_PORT','../../common/constants/redisKey.constant','chatMusic','绘制图片失败，请稍后试试吧！','getVideoConfig','saveMindTask','slideNumber','importDynamic','text/event-stream','url','PAYMENT_REQUIRED','catalogs','mindTaskService','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','compileNetwork','sendMessageFromSpark','../api/klingTask.service','绘制图片失败，请检查你的提示词是否有非法描述！','delta','ratio','think','UserCollectType','getModelVipFree','user','pageCount','VipFree','REDIS_USER','join','mind','OpenAiErrorCodeMessage','openaiModel3MaxTokensRes','jimeng_vgfm_i2v_l20','write','VIDEO','forEach','role','chatgpt','title','pptCreateThesis','test','Cache-Control','configDoubaoApi','completed','\x20model:\x20','save','mergeCollectData','musicCreateVipFree','/upload','HttpStatus','autoreplyService','fileService','getModelByKeyType','success','once','buildSystemMessage','completionTokens','timeout','getUuid','getClientIp','msg','Download','16k','TTS','pptx','pptNote','--------------------------------------------------------','lumaChatVideo','remove\x20file\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.state_desc\x20as\x20stateDesc,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.editor_url\x20as\x20editorUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.images,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.preview_url\x20as\x20previewUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pdf_down_url\x20as\x20pdfDownUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.png_down_url\x20as\x20pngDownUrl\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','systemPreMessage','resolve','../models/models.service','../../common/constants/ppt.constant','stateDesc','DRAW','pathname','gpt_description_prompt','\x20--expand_prompt\x20','cn-north-1','saveGptsUseLog','PAINT_TYPE','pptEditor','keyv','Content-Type','PPT不存在','signal','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','speech','fileInfo','./../user/user.service','Bearer;','answer','listTaskByIds','responseMessage','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%','pptChangeTheme','syncLumaTask','tts','fanyi\x20mj-associate','env','modelName','luma-video','deduct','set','chatProcess','pptConfig','data','lumaVideoTask','systemMessage','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','getModelConfig','getOwnPropertyDescriptor','system','getVideoModelFree','proxyUrl','finish_reason','suno-v3','refundBalance4Chat','default','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','relId','pptRecPage','response','findOne','metadata','../file/file.service','pptStructure','mp3','runwayChatVideo','http','text','image','type','validateVideoBeforeChat','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','model','musicUploadPrice','\x20key\x20->\x20','musicLyrics','KLingTaskService','find','setData','failed','RunwayTaskService','getRandomKeyForKeyType','saveVoiceChat','[耗时打印]文字转语音耗时：','pptOutlineVipFree','webroot','unlink','secret',',\x20模型名称:\x20','本次调用:\x20','NineStore','floor','saveUseLog','musicUploadVipFree','promptTokens','STRUCTURE','LumaTaskService','CREATE','chatLogId','theme','Incorrect\x20API\x20key\x20provided','yooTaskId','Service','GlobalConfigService','CHAT','pptEditorPrice','abs','uploadFile','RECOVER','----------Doubao---------','pptCreatePrice','modelConfig','randomUUID','params','未配置语音模型或语音模型key，请配置并启用语音功能！','FILE','debuctBalance4Muisc','视频生成失败，没有响应','./baidu','select\x20*\x20from\x20ppt_task\x20where\x20\x20(status<>2\x20or\x20status\x20is\x20null\x20)and\x20yoo_task_id\x20is\x20not\x20null','chatLogService','gomaxai-default-key','pptOnlineEditor','.png','includes','ChatgptService','CVProcess','contents','gpt-3','jmengVideoTask','@nestjs/common','tts-1','getUserInfoFromHeader','__esModule','openaiTimeoutMs','returnDrawDetail','THESIS','validateBalance4Chat','unifiedFormattingResponse','json','asyncPPTProgress','function','clsService','configKimiApi','getModelsByModelType','downUrl','nestjs-cls','volc_auc_common','listAssetsBychatLogIds','/v1/images/generations','klingTaskService','./zhipu','当前模型不是聊天模型','ChatGroupService','lumaTaskService','onModuleInit','HttpException','openAi','indexOf','existsSync','BAD_REQUEST','replace','\x20OFFSET\x20','Result','语音转文本失败','transition','modelsService','COVER','upload','3709900rLDbCf','openaiModel3MaxTokens','advisor','REDIS_PASSWORD','appId','conversationId','parseAndSaveVideo','当前模型key余额已耗尽','openaiModel4MaxTokens32kRes','video'];_0xbd85=function(){return _0x21fdc7;};return _0xbd85();}var __decorate=this&&this[_0x2fe4bb(0x2e1)]||function(_0x27655b,_0x5415f1,_0x29c1b7,_0xecd999){const _0x236d38=_0x2fe4bb;var _0x24b076=arguments[_0x236d38(0x2b8)],_0x44aac6=_0x24b076<0x3?_0x5415f1:_0xecd999===null?_0xecd999=Object[_0x236d38(0x1a7)](_0x5415f1,_0x29c1b7):_0xecd999,_0x2481a2;if(typeof Reflect===_0x236d38(0x24a)&&typeof Reflect['decorate']===_0x236d38(0x204))_0x44aac6=Reflect['decorate'](_0x27655b,_0x5415f1,_0x29c1b7,_0xecd999);else{for(var _0x26b69b=_0x27655b['length']-0x1;_0x26b69b>=0x0;_0x26b69b--)if(_0x2481a2=_0x27655b[_0x26b69b])_0x44aac6=(_0x24b076<0x3?_0x2481a2(_0x44aac6):_0x24b076>0x3?_0x2481a2(_0x5415f1,_0x29c1b7,_0x44aac6):_0x2481a2(_0x5415f1,_0x29c1b7))||_0x44aac6;}return _0x24b076>0x3&&_0x44aac6&&Object[_0x236d38(0x34e)](_0x5415f1,_0x29c1b7,_0x44aac6),_0x44aac6;},__metadata=this&&this['__metadata']||function(_0x37eb41,_0x596e31){const _0x4f8564=_0x2fe4bb;if(typeof Reflect===_0x4f8564(0x24a)&&typeof Reflect['metadata']===_0x4f8564(0x204))return Reflect[_0x4f8564(0x1b4)](_0x37eb41,_0x596e31);},__param=this&&this[_0x2fe4bb(0x34a)]||function(_0x5338fe,_0x383d9e){return function(_0x5f5510,_0x2fd743){_0x383d9e(_0x5f5510,_0x2fd743,_0x5338fe);};};Object[_0x2fe4bb(0x34e)](exports,_0x2fe4bb(0x1fc),{'value':!![]}),exports[_0x2fe4bb(0x1f4)]=void 0x0;const file_service_1=require(_0x2fe4bb(0x1b5)),user_service_1=require(_0x2fe4bb(0x3ff)),openai_1=require(_0x2fe4bb(0x24c)),common_1=require(_0x2fe4bb(0x1f9)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x2fe4bb(0x269)),axios_1=require('axios'),balance_constant_1=require(_0x2fe4bb(0x234)),chatLog_service_1=require(_0x2fe4bb(0x316)),uuid=require(_0x2fe4bb(0x345)),fs=require('fs'),typeorm_1=require('typeorm'),typeorm_2=require(_0x2fe4bb(0x386)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x2fe4bb(0x265)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),chatGroup_service_1=require(_0x2fe4bb(0x2bd)),models_service_1=require(_0x2fe4bb(0x3ed)),baidu_1=require(_0x2fe4bb(0x1ed)),helper_1=require('./helper'),store_1=require(_0x2fe4bb(0x355)),zhipu_1=require(_0x2fe4bb(0x20e)),spark_1=require(_0x2fe4bb(0x363)),model_constant_1=require(_0x2fe4bb(0x319)),fs_1=require('fs'),path_1=require(_0x2fe4bb(0x389)),gpts_service_1=require(_0x2fe4bb(0x26f)),yooPPT_service_1=require('../api/yooPPT.service'),pptTask_entity_1=require('./entity/pptTask.entity'),ppt_constant_1=require(_0x2fe4bb(0x3ee)),lumaTask_service_1=require(_0x2fe4bb(0x239)),nestjs_cls_1=require(_0x2fe4bb(0x209)),doubao_service_1=require(_0x2fe4bb(0x32d)),crypto_1=require(_0x2fe4bb(0x297)),chat_constant_1=require(_0x2fe4bb(0x247)),result_1=require(_0x2fe4bb(0x29a)),runwayTask_service_1=require(_0x2fe4bb(0x387)),klingTask_service_1=require(_0x2fe4bb(0x3b6)),sunoTask_service_1=require(_0x2fe4bb(0x25a)),mindTask_service_1=require('../mindTask/mindTask.service'),collectType_constant_1=require('../../common/constants/collectType.constant'),redisKey_constant_1=require(_0x2fe4bb(0x3a7)),store_2=require(_0x2fe4bb(0x3a4)),music_constant_1=require(_0x2fe4bb(0x27f)),openapi_1=require('@volcengine/openapi');let ChatgptService=class ChatgptService{constructor(_0x383cb8,_0x4242e1,_0xb35678,_0x34e739,_0x34b3f8,_0xed3167,_0x372078,_0x181d95,_0x488509,_0x62626f,_0x4792f1,_0x339a0c,_0x425f8f,_0x507780,_0x453e1d,_0x122da8,_0xd6a916,_0x5cff8d,_0x1ccd58){const _0x3dcce3=_0x2fe4bb;this['pptTaskEntity']=_0x383cb8,this[_0x3dcce3(0x205)]=_0x4242e1,this[_0x3dcce3(0x393)]=_0xb35678,this['fileService']=_0x34e739,this[_0x3dcce3(0x279)]=_0x34b3f8,this[_0x3dcce3(0x33b)]=_0xed3167,this[_0x3dcce3(0x356)]=_0x372078,this[_0x3dcce3(0x21d)]=_0x181d95,this[_0x3dcce3(0x1ef)]=_0x488509,this[_0x3dcce3(0x211)]=_0x62626f,this[_0x3dcce3(0x281)]=_0x4792f1,this[_0x3dcce3(0x20d)]=_0x339a0c,this[_0x3dcce3(0x31f)]=_0x425f8f,this[_0x3dcce3(0x35e)]=_0x507780,this[_0x3dcce3(0x3d7)]=_0x453e1d,this[_0x3dcce3(0x277)]=_0x122da8,this[_0x3dcce3(0x34c)]=_0xd6a916,this[_0x3dcce3(0x358)]=_0x5cff8d,this[_0x3dcce3(0x3b2)]=_0x1ccd58,this['defaultBaseUrl']=_0x3dcce3(0x32e),this['messageStore']=null,this[_0x3dcce3(0x38f)]=null,this[_0x3dcce3(0x24e)]=_0x5b3efa=>{const _0x20de7c=_0x3dcce3;return fs[_0x20de7c(0x1cd)](_0x5b3efa,_0x2fd459=>{const _0x24fec3=_0x20de7c;_0x2fd459?console[_0x24fec3(0x276)](_0x24fec3(0x3e9),_0x2fd459):console[_0x24fec3(0x276)]('remove\x20file\x20%s\x20success',_0x5b3efa);});};}async[_0x2fe4bb(0x212)](){const _0x4f62b6=_0x2fe4bb;let _0x29abc8=await(0x0,utils_1[_0x4f62b6(0x3ad)])(_0x4f62b6(0x3ca));_0x29abc8=_0x29abc8?.[_0x4f62b6(0x1ae)]?_0x29abc8[_0x4f62b6(0x1ae)]:_0x29abc8,this[_0x4f62b6(0x2b5)]=_0x29abc8[_0x4f62b6(0x251)];let _0x278814=await(0x0,utils_1[_0x4f62b6(0x3ad)])(_0x4f62b6(0x3f8));_0x278814=_0x278814?.[_0x4f62b6(0x1ae)]?_0x278814[_0x4f62b6(0x1ae)]:_0x278814;let _0x619a28=await(0x0,utils_1[_0x4f62b6(0x3ad)])('@keyv/redis');_0x619a28=_0x619a28?.[_0x4f62b6(0x1ae)]?_0x619a28['default']:_0x619a28;const _0x18af61=+process['env'][_0x4f62b6(0x3a6)],_0x315773=process[_0x4f62b6(0x409)][_0x4f62b6(0x2fd)],_0x3e57cc=process[_0x4f62b6(0x409)][_0x4f62b6(0x223)],_0x1b0b34=process['env'][_0x4f62b6(0x3c0)],_0xaec97c=_0x4f62b6(0x2d5)+(_0x1b0b34||'')+':'+(_0x3e57cc||'')+'@'+_0x315773+':'+_0x18af61,_0x40f632=new _0x619a28(_0xaec97c);this[_0x4f62b6(0x2c3)]=new _0x278814({'store':_0x40f632,'namespace':_0x4f62b6(0x381)}),this[_0x4f62b6(0x38f)]=new store_1[(_0x4f62b6(0x1d1))]({'store':this[_0x4f62b6(0x2c3)],'namespace':'chat'}),!this[_0x4f62b6(0x214)]&&this[_0x4f62b6(0x318)]();}[_0x2fe4bb(0x318)](){const _0x3dd0a2=_0x2fe4bb;this[_0x3dd0a2(0x214)]=new openai_1[(_0x3dd0a2(0x1ae))]({'apiKey':_0x3dd0a2(0x1f0),'baseURL':this[_0x3dd0a2(0x36b)]+_0x3dd0a2(0x2c8)});}async['getModelConfig'](_0x1d4b9b){const _0x5d4938=_0x2fe4bb,{type:_0x5b61db,groupId:_0x382e77,modelType:_0x21a5b8,officialModel:_0x1ce3a3,keyType:_0x33b6e8}=_0x1d4b9b;console[_0x5d4938(0x276)](_0x5d4938(0x3e7),_0x1d4b9b);let _0x56f905,_0x446fed;_0x5b61db&&_0x5b61db===_0x5d4938(0x384)?(_0x446fed=await this[_0x5d4938(0x279)][_0x5d4938(0x2f7)](_0x382e77),_0x56f905=_0x446fed[_0x5d4938(0x33f)]):_0x446fed=await this['chatGroupService'][_0x5d4938(0x2f7)](_0x382e77);let _0x7e641e;if(_0x446fed)_0x7e641e=JSON[_0x5d4938(0x273)](_0x446fed[_0x5d4938(0x2bc)]);else{if(_0x33b6e8)_0x7e641e=await this[_0x5d4938(0x21d)][_0x5d4938(0x33c)](_0x21a5b8,_0x33b6e8);else _0x21a5b8?_0x7e641e=await this['modelsService']['getModelByType'](_0x21a5b8,_0x1ce3a3):_0x7e641e=await this[_0x5d4938(0x21d)][_0x5d4938(0x2ce)](model_constant_1[_0x5d4938(0x262)][_0x5d4938(0x3a1)]);}if(!_0x7e641e)throw new common_1[(_0x5d4938(0x213))]('未获取到模型基础配置，请前往后台配置并启用',common_1[_0x5d4938(0x3d6)][_0x5d4938(0x217)]);return{'appId':_0x56f905,'modelConfig':_0x7e641e};}async['buildSystemMessage'](_0x1ab854){const _0x2a517f=_0x2fe4bb,_0xcca290=this;let _0x3241a1='',_0x223ea7='',{type:_0x10e4d8,appId:_0x3359c0,prompt:_0x3c1385,custom:_0x58ad06,usingNetwork:_0x666f4a,systemMessage:_0x268fe6,customSystemMessage:_0x1e9d5e}=_0x1ab854;const _0x51a762=async function(){const _0x28a68a=_0x1e61,_0x3dac4a=new Date()[_0x28a68a(0x284)]()['split']('T')[0x0];return _0x223ea7=await _0xcca290[_0x28a68a(0x34c)][_0x28a68a(0x2ca)]([_0x28a68a(0x3eb)]),_0x223ea7+(_0x28a68a(0x313)+_0x3dac4a);};if(_0x3359c0){const _0x32501b=await this[_0x2a517f(0x279)][_0x2a517f(0x301)](_0x3359c0,0x1);if(!_0x32501b)throw new common_1[(_0x2a517f(0x213))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x2a517f(0x3d6)][_0x2a517f(0x217)]);_0x32501b[_0x2a517f(0x235)]&&(_0x268fe6=_0x32501b[_0x2a517f(0x235)]);}else{if(_0x58ad06)_0x268fe6=_0x268fe6;else _0x1e9d5e?_0x268fe6=_0x1e9d5e:_0x10e4d8!=='gpts'&&(_0x268fe6=await _0x51a762());}return _0x666f4a&&(_0x3241a1=await(0x0,utils_1[_0x2a517f(0x3b4)])(_0x3c1385),!_0x223ea7&&(_0x268fe6=await _0x51a762())),{'systemMessage':_0x268fe6,'netWorkPrompt':_0x3241a1};}async[_0x2fe4bb(0x380)](_0x29a0ee){const _0x3c1aee=_0x2fe4bb,{type:_0x425abf,custom:_0x4a616a,groupId:_0x708181,modelConfig:_0x4e5c6b}=_0x29a0ee;let _0x2770e2=null;if(!_0x4a616a&&!_0x425abf){const _0x4a368b=await this[_0x3c1aee(0x21d)][_0x3c1aee(0x2ce)](model_constant_1['EModelType'][_0x3c1aee(0x1df)],_0x4e5c6b['modelInfo']['model']);_0x2770e2=_0x4a368b[_0x3c1aee(0x291)];}else{if(_0x425abf==='gpts')_0x2770e2=await this[_0x3c1aee(0x279)][_0x3c1aee(0x399)](_0x708181);else{if(_0x425abf==='file'){const _0x194d3e=await this[_0x3c1aee(0x21d)]['getModelByType'](model_constant_1[_0x3c1aee(0x262)][_0x3c1aee(0x1ea)],_0x4e5c6b[_0x3c1aee(0x291)][_0x3c1aee(0x1bf)]);_0x2770e2=_0x194d3e[_0x3c1aee(0x291)];}else _0x4a616a?_0x2770e2=await this['modelsService'][_0x3c1aee(0x372)](model_constant_1[_0x3c1aee(0x262)][_0x3c1aee(0x3a1)]):_0x2770e2=await this[_0x3c1aee(0x21d)][_0x3c1aee(0x372)](model_constant_1[_0x3c1aee(0x262)][_0x3c1aee(0x1df)]);}}if(!_0x2770e2)throw new common_1[(_0x3c1aee(0x213))](_0x3c1aee(0x2c5),common_1[_0x3c1aee(0x3d6)][_0x3c1aee(0x217)]);return _0x425abf===_0x3c1aee(0x384)?_0x4e5c6b[_0x3c1aee(0x291)][_0x3c1aee(0x1bf)]=_0x2770e2[_0x3c1aee(0x1bf)]:_0x2770e2[_0x3c1aee(0x1bf)]=_0x4e5c6b['modelInfo'][_0x3c1aee(0x1bf)],_0x2770e2;}async[_0x2fe4bb(0x1bd)](_0x37553d){const _0x4ce1d9=_0x2fe4bb,{user:_0x262c58,prompt:_0x6d02fc,currentRequestModel:_0x416356,requestParams:_0x1fd117}=_0x37553d;await this[_0x4ce1d9(0x393)][_0x4ce1d9(0x230)](_0x262c58),await this['badwordsService']['checkBadWords'](_0x6d02fc,_0x262c58['id']),await this['userService'][_0x4ce1d9(0x317)](_0x262c58['id'],_0x416356,_0x1fd117);}async[_0x2fe4bb(0x371)](_0x2a681f){const _0xbb8e5e=_0x2fe4bb,{user:_0x5756b6,prompt:_0x4101b9,currentRequestModel:_0xdd0f10}=_0x2a681f;await this[_0xbb8e5e(0x393)][_0xbb8e5e(0x230)](_0x5756b6),await this[_0xbb8e5e(0x35e)][_0xbb8e5e(0x330)](_0x4101b9,_0x5756b6['id']),await this[_0xbb8e5e(0x393)][_0xbb8e5e(0x200)](_0x5756b6['id'],_0xdd0f10);}async[_0x2fe4bb(0x285)](_0x442a3f){const _0x115b9f=_0x2fe4bb,{user:_0x2992c5,prompt:_0x20f448,currentRequestModel:_0x507e96,count:_0x27c2fb}=_0x442a3f;await this[_0x115b9f(0x393)][_0x115b9f(0x230)](_0x2992c5),await this[_0x115b9f(0x35e)][_0x115b9f(0x330)](_0x20f448,_0x2992c5['id']),await this[_0x115b9f(0x393)][_0x115b9f(0x37e)](_0x2992c5['id'],_0x507e96,_0x27c2fb||0x1);}async[_0x2fe4bb(0x29d)](_0x2b1777,_0x139efd,_0x238c6e){const _0x2daaa9=_0x2fe4bb,_0x2ce83f=await this['globalConfigService']['getConfigByKeys']([_0x2daaa9(0x1fd)]),_0x2e3903=Number(_0x2ce83f)||0x493e0,_0x2fdadb={'timeoutMs':+_0x2e3903,'systemMessage':_0x139efd||'','parentMessageId':_0x2b1777||'','completionParams':{'temperature':0.8,'model':_0x238c6e[_0x2daaa9(0x1bf)]}};return _0x2fdadb;}async[_0x2fe4bb(0x2aa)](_0x37dbbd,_0x2015bc){const _0x5c9888=_0x2fe4bb;let _0x13e9c0=_0x37dbbd[_0x5c9888(0x1aa)];if(!_0x13e9c0){const _0x2fab2c=await this[_0x5c9888(0x34c)][_0x5c9888(0x2ca)](['openaiBaseUrl']);_0x2fab2c?_0x13e9c0=_0x2fab2c:_0x13e9c0=_0x5c9888(0x32e);}const _0x108f49=0x1f40,_0x378678=0x1000;let _0x2e433b='v1';_0x13e9c0[_0x5c9888(0x215)]('v2')==-0x1&&(_0x13e9c0=_0x13e9c0+'/'+_0x2e433b);const _0x563710=new this[(_0x5c9888(0x2b5))]({'maxModelTokens':_0x108f49,'apiBaseUrl':_0x13e9c0,'messageStore':this[_0x5c9888(0x2c3)],'apiKey':(0x0,utils_1[_0x5c9888(0x302)])(_0x37dbbd[_0x5c9888(0x350)]),'maxResponseTokens':_0x378678>=_0x108f49?Math[_0x5c9888(0x1e1)](Math['floor'](_0x108f49/0x2)):_0x378678});return _0x563710;}async[_0x2fe4bb(0x206)](_0x234020){const _0x7cd6c6=_0x2fe4bb,_0x297bae=new openai_1[(_0x7cd6c6(0x1ae))]({'baseURL':_0x234020['proxyUrl']+_0x7cd6c6(0x2c8)||'https://api.moonshot.cn/v1','apiKey':_0x234020[_0x7cd6c6(0x350)]});return _0x297bae;}async[_0x2fe4bb(0x3cf)](_0x30b7bd){const _0x38afd3=_0x2fe4bb;let _0x32faac=_0x30b7bd[_0x38afd3(0x1aa)]||_0x38afd3(0x289);const _0x323afd=new openai_1[(_0x38afd3(0x1ae))]({'baseURL':_0x32faac+_0x38afd3(0x2b2),'apiKey':(0x0,utils_1[_0x38afd3(0x302)])(_0x30b7bd[_0x38afd3(0x350)])});return _0x323afd;}async[_0x2fe4bb(0x39f)](_0x47d708,_0x3ef027,_0x13cfc8=null){const _0x1cc2ba=_0x2fe4bb;let _0x4c4038=[];for(const _0x16c7a6 of _0x3ef027){const _0x40c66c=new URL(_0x16c7a6);let _0x5aacb7=(0x0,path_1[_0x1cc2ba(0x3c1)])(process[_0x1cc2ba(0x2df)](),_0x1cc2ba(0x1cc),_0x40c66c[_0x1cc2ba(0x3f1)]);_0x5aacb7=decodeURIComponent(_0x5aacb7);const _0x1685b4=await _0x47d708[_0x1cc2ba(0x369)][_0x1cc2ba(0x2c0)]({'file':fs[_0x1cc2ba(0x22e)](_0x5aacb7),'purpose':_0x1cc2ba(0x270)});let _0x44a65d=await(await _0x47d708['files'][_0x1cc2ba(0x2a9)](_0x1685b4['id']))[_0x1cc2ba(0x1ba)]();_0x4c4038[_0x1cc2ba(0x357)]({'role':_0x1cc2ba(0x1a8),'content':_0x44a65d});}return _0x4c4038;}async[_0x2fe4bb(0x398)](_0x5ddd77,_0x23cf79){const _0x732413=_0x2fe4bb;console[_0x732413(0x276)](_0x732413(0x290),_0x5ddd77);let _0x530c5b='',_0x4b72b1=_0x5ddd77[_0x732413(0x2b7)];return!_0x530c5b&&(_0x530c5b=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4b72b1]?errorMessage_constant_1[_0x732413(0x3c3)][_0x4b72b1]:_0x732413(0x2f6)),_0x5ddd77?.[_0x732413(0x31a)]['includes']('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&(await this[_0x732413(0x21d)][_0x732413(0x231)](_0x23cf79['id'],'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x530c5b='当前模型key已被封禁'),_0x5ddd77?.[_0x732413(0x2b7)]===0x1ad&&_0x5ddd77[_0x732413(0x31a)]['includes'](_0x732413(0x2bb))&&(await this[_0x732413(0x21d)][_0x732413(0x231)](_0x23cf79['id'],'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x530c5b=_0x732413(0x227)),_0x5ddd77?.['statusCode']===0x191&&_0x5ddd77['message']['includes'](_0x732413(0x1db))&&(await this[_0x732413(0x21d)][_0x732413(0x231)](_0x23cf79['id'],'模型秘钥错误或模型余额不足',-0x2),_0x530c5b='模型秘钥错误或模型金额不足，请联系管理员！'),_0x5ddd77?.[_0x732413(0x2b7)]===0x191&&(_0x530c5b=_0x732413(0x375)),_0x5ddd77?.[_0x732413(0x2b7)]===0x191&&_0x5ddd77['message'][_0x732413(0x1f3)]('Unauthorized')&&(await this['modelsService'][_0x732413(0x231)](_0x23cf79['id'],_0x732413(0x275),-0x2),_0x530c5b=_0x732413(0x375)),_0x5ddd77?.[_0x732413(0x2b7)]===0x194&&_0x5ddd77[_0x732413(0x31a)][_0x732413(0x1f3)](_0x732413(0x258))&&(await this[_0x732413(0x21d)][_0x732413(0x231)](_0x23cf79['id'],'当前模型不是聊天模型',-0x4),_0x530c5b=_0x732413(0x3fc)),_0x530c5b;}[_0x2fe4bb(0x2ec)](_0x5bb2f3,_0x284ef8,_0x2d70a2,_0x50aec7,_0x4b847d){const _0xef2580=_0x2fe4bb;let _0x523c70='';_0x284ef8[_0xef2580(0x39e)][_0xef2580(0x27c)]['length']&&_0x284ef8[_0xef2580(0x39e)][_0xef2580(0x27c)][_0xef2580(0x3c8)](_0x2bfffe=>{const _0x2b7989=_0xef2580;_0x2bfffe[_0x2b7989(0x3b8)]?.[_0x2b7989(0x31c)]&&(_0x523c70+=_0x2bfffe['delta'][_0x2b7989(0x31c)]);});_0x284ef8[_0xef2580(0x3ba)]=_0x523c70;if(_0x2d70a2)_0x5bb2f3[_0xef2580(0x3c6)](_0xef2580(0x2e3)+JSON[_0xef2580(0x2d2)](_0x284ef8)+'\x0a\x0a');else _0x50aec7&&_0x5bb2f3[_0xef2580(0x3c6)](_0x4b847d?JSON[_0xef2580(0x2d2)](_0x284ef8):'\x0a'+JSON[_0xef2580(0x2d2)](_0x284ef8));return _0x523c70;}[_0x2fe4bb(0x403)](_0x49747d,_0x11e4d4,_0x156c46,_0x220976,_0x41c92a){const _0x11acea=_0x2fe4bb;if(_0x156c46)console['log'](_0x11acea(0x1e4),_0x11e4d4),_0x49747d[_0x11acea(0x3c6)](_0x11acea(0x2e3)+JSON['stringify'](_0x11e4d4)+'\x0a\x0a');else _0x220976&&(console[_0x11acea(0x276)](_0x11acea(0x1e4),_0x11e4d4),_0x49747d['write'](_0x41c92a?JSON[_0x11acea(0x2d2)](_0x11e4d4):'\x0a'+JSON[_0x11acea(0x2d2)](_0x11e4d4)));}async['chatProcess'](_0x695af6,_0x5a62c7,_0x92dd21,_0x5f2ce0=!![],_0x42dab7=''){const _0xc38758=_0x2fe4bb;try{const _0x42c182=_0x5a62c7[_0xc38758(0x30d)],_0x4423bf=(0x0,utils_1[_0xc38758(0x2a8)])(this[_0xc38758(0x205)]),{options:options={},prompt:_0x31623f,cusromPrompt:_0x40bc1e,assetsId:_0x32a8fd,autoVoice:_0x6aba99}=_0x695af6,{groupId:_0x120ebb,usingNetwork:_0x48fd4d,parentMessageId:_0x1a94a7,type:_0x5af5c8}=options;let _0x36c98c='';const {appId:_0x24c60b,modelConfig:_0x2cb056}=await this[_0xc38758(0x1a6)]({'type':_0x5af5c8,'groupId':_0x120ebb}),{systemMessage:_0x8db249,netWorkPrompt:_0x45ae97}=await this[_0xc38758(0x3dc)]({'type':_0x5af5c8,'appId':_0x24c60b,'prompt':_0x31623f,'usingNetwork':_0x48fd4d,'custom':_0x40bc1e,'systemMessage':_0x695af6[_0xc38758(0x1a4)],'customSystemMessage':_0x695af6[_0xc38758(0x249)]||_0x2cb056[_0xc38758(0x291)]['systemMessage']}),_0x62d889=await this['getCurrentModel']({'type':_0x5af5c8,'groupId':_0x120ebb,'modelConfig':_0x2cb056,'custom':_0x40bc1e});await this['validateBeforeChat']({'prompt':_0x31623f,'currentRequestModel':_0x62d889,'user':_0x5a62c7[_0xc38758(0x3bd)]});const _0x2562ad=await this['autoreplyService'][_0xc38758(0x23e)](_0x31623f);_0x92dd21&&_0x5f2ce0&&(!_0x695af6[_0xc38758(0x24d)]?_0x92dd21[_0xc38758(0x374)](_0xc38758(0x2be),_0xc38758(0x382)):(_0x92dd21[_0xc38758(0x374)](_0xc38758(0x3f9),_0xc38758(0x3ae)),_0x92dd21[_0xc38758(0x374)](_0xc38758(0x240),'chunked'),_0x92dd21[_0xc38758(0x374)](_0xc38758(0x3ce),'no-cache'),_0x92dd21[_0xc38758(0x374)](_0xc38758(0x2d6),'no'),_0x92dd21['setHeader']('Access-Control-Allow-Origin','*')));if(_0x2562ad){if(_0x92dd21&&_0x5f2ce0){const _0x1566d6={'message':_0x2562ad,'code':0x1f4};_0x92dd21['write'](JSON[_0xc38758(0x2d2)](_0x1566d6)),_0x92dd21[_0xc38758(0x2fc)]();return;}else return _0x2562ad;}const _0x3a101f=await this['buildOptions'](options[_0xc38758(0x2e4)],_0x8db249,_0x62d889);options[_0xc38758(0x1bf)]&&(_0x3a101f['completionParams'][_0xc38758(0x1bf)]=options[_0xc38758(0x1bf)]);let {model:_0x4ac922,rounds:_0x4712e0,keyType:_0x3190f5,modelType:_0x17060a,id:_0xcb5640,topN:_0x40c64c}=_0x2cb056['modelInfo'];const {key:_0x52d116,modelName:_0x5365a2,id:_0x3172a8,accessToken:_0x1aa88a}=_0x62d889;_0x4ac922=_0x3a101f['completionParams'][_0xc38758(0x1bf)];_0x92dd21&&_0x5f2ce0&&_0x92dd21[_0xc38758(0x2ff)](0xc8);let _0x157ec6=null,_0x221bd0=null;const _0x9d2151=(0x0,utils_1['getClientIp'])(_0x5a62c7),_0x23b89c={'appId':_0x24c60b,'curIp':_0x9d2151,'prompt':_0x31623f,'groupId':_0x120ebb,'modelId':_0xcb5640,'modelType':_0x17060a,'answer':'','model':_0x4ac922,'role':_0xc38758(0x3bd),'userId':_0x5a62c7[_0xc38758(0x3bd)]['id'],'completionTokens':0x0,'type':balance_constant_1['DeductionKey'][_0xc38758(0x327)],'logType':_0x5af5c8==='gpts'?0x2:0x1,'requestOptions':JSON[_0xc38758(0x2d2)]({'options':options,'prompt':_0x31623f}),'saasId':_0x4423bf,'modelSubType':_0x42dab7},_0x1e4105={..._0x23b89c,'role':'assistant','requestOptions':JSON[_0xc38758(0x2d2)]({'prompt':_0x31623f,'options':{'model':_0x4ac922,'temperature':_0x40c64c}})};try{if(_0x92dd21){let _0x1f0f95=null,_0x2c55f3=![];_0x92dd21['on']('close',async()=>{const _0x5ceb97=_0xc38758;if(_0x2c55f3)return;_0x42c182[_0x5ceb97(0x30c)]();const _0x2c620f=0x0,_0x18fb69=0x0,_0x5d8a3a=_0x2c620f+_0x18fb69;_0x23b89c[_0x5ceb97(0x352)]=_0x2c620f,_0x23b89c[_0x5ceb97(0x1d5)]=_0x2c620f,await this[_0x5ceb97(0x1ef)][_0x5ceb97(0x2f4)](_0x23b89c),_0x1e4105['answer']=_0x1f0f95?.['text'],_0x1e4105[_0x5ceb97(0x352)]=_0x5d8a3a,_0x1e4105[_0x5ceb97(0x1d5)]=_0x2c620f,_0x1e4105['completionTokens']=_0x18fb69,_0x1e4105[_0x5ceb97(0x238)]=JSON[_0x5ceb97(0x2d2)]({'conversationId':_0x1f0f95?.[_0x5ceb97(0x225)],'model':_0x4ac922,'parentMessageId':_0x1f0f95?.['id'],'temperature':_0x40c64c});const _0x555a72=await this['chatLogService'][_0x5ceb97(0x2f4)](_0x1e4105);if(_0x42dab7==_0x5ceb97(0x3c2)){const _0x988fc9=await this[_0x5ceb97(0x3b2)][_0x5ceb97(0x3ab)]({'id':_0x32a8fd,'userId':_0x555a72[_0x5ceb97(0x283)],'chatLogId':_0x555a72['id'],'prompt':_0x555a72[_0x5ceb97(0x35f)],'result':_0x1e4105[_0x5ceb97(0x401)],'status':0x1});_0x157ec6[_0x5ceb97(0x2ed)]=_0x988fc9['id'];}await this[_0x5ceb97(0x393)][_0x5ceb97(0x30a)](_0x5a62c7[_0x5ceb97(0x3bd)]['id'],_0x62d889,_0x555a72['id']);}),_0x92dd21['on'](_0xc38758(0x312),_0x5ae809=>{const _0x284d2e=_0xc38758;console[_0x284d2e(0x276)](_0x5ae809);});if(Number(_0x3190f5)===0x1){if(_0x62d889[_0xc38758(0x40a)]['toLowerCase']()[_0xc38758(0x1f3)](_0xc38758(0x35c))){let _0x15f635=!![];const _0x434f56=await this[_0xc38758(0x38f)][_0xc38758(0x341)](_0x48fd4d?_0x45ae97:_0x31623f,{'parentMessageId':_0x1a94a7,'maxRounds':(0x0,helper_1[_0xc38758(0x233)])(_0x4712e0)});_0x157ec6=await(0x0,zhipu_1[_0xc38758(0x323)])(_0x48fd4d?_0x45ae97:_0x434f56,{'key':_0x62d889[_0xc38758(0x350)],'chatId':this['gomaxAiStore'][_0xc38758(0x3df)](),'model':_0x4ac922,'apiUrl':_0x62d889[_0xc38758(0x1aa)],'onProgress':_0x5740a5=>{const _0xeb8dc1=_0xc38758;this[_0xeb8dc1(0x403)](_0x92dd21,_0x5740a5,_0x695af6[_0xeb8dc1(0x24d)],_0x5f2ce0,_0x15f635),_0x15f635=![],_0x1f0f95=_0x5740a5;}}),_0x2c55f3=!![];}else{let _0x7dd57b=!![];const _0xe42e13=await this[_0xc38758(0x2aa)](_0x62d889,_0x3a101f);_0x157ec6=await _0xe42e13[_0xc38758(0x37a)](_0x48fd4d?_0x45ae97:_0x31623f,{..._0x3a101f,'onProgress':_0x21dfa6=>{const _0x2cd20d=_0xc38758;let _0xe5691c=this[_0x2cd20d(0x2ec)](_0x92dd21,_0x21dfa6,_0x695af6[_0x2cd20d(0x24d)],_0x5f2ce0,_0x7dd57b);_0x36c98c+=_0xe5691c,_0x7dd57b=![],_0x1f0f95=_0x21dfa6;},'abortSignal':_0x42c182[_0xc38758(0x3fb)]}),_0x2c55f3=!![];}}if(Number(_0x3190f5)===0x2){let _0x59fcfb=!![];const _0xea1c01=await this[_0xc38758(0x38f)][_0xc38758(0x341)](_0x48fd4d?_0x45ae97:_0x31623f,{'parentMessageId':_0x1a94a7,'maxRounds':(0x0,helper_1[_0xc38758(0x233)])(_0x4712e0)});_0x157ec6=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x48fd4d?_0x45ae97:_0xea1c01,{'temperature':_0x40c64c,'accessToken':_0x1aa88a,'model':_0x4ac922,'onProgress':_0x53d57a=>{const _0x37747c=_0xc38758;this[_0x37747c(0x403)](_0x92dd21,_0x53d57a,_0x695af6[_0x37747c(0x24d)],_0x5f2ce0,_0x59fcfb),_0x59fcfb=![],_0x1f0f95=_0x53d57a;}}),_0x2c55f3=!![];}if(Number(_0x3190f5)===0x3){let _0x4a7f00=!![];const _0x16ab06=await this[_0xc38758(0x38f)][_0xc38758(0x341)](_0x48fd4d?_0x45ae97:_0x31623f,{'parentMessageId':_0x1a94a7,'maxRounds':(0x0,helper_1[_0xc38758(0x233)])(_0x4712e0)});console[_0xc38758(0x276)](_0x16ab06),_0x157ec6=await(0x0,zhipu_1[_0xc38758(0x272)])(_0x48fd4d?_0x45ae97:_0x16ab06,{'temperature':_0x40c64c,'key':_0x52d116,'model':_0x4ac922,'onProgress':_0x3deb4b=>{const _0x30ba38=_0xc38758;this[_0x30ba38(0x403)](_0x92dd21,_0x3deb4b,_0x695af6[_0x30ba38(0x24d)],_0x5f2ce0,_0x4a7f00),_0x4a7f00=![],_0x1f0f95=_0x3deb4b;}}),_0x2c55f3=!![];}if(Number(_0x3190f5)===0x4){let _0x4feafa=!![];const _0x1b1233=await this[_0xc38758(0x38f)][_0xc38758(0x341)](_0x48fd4d?_0x45ae97:_0x31623f,{'parentMessageId':_0x1a94a7,'maxRounds':(0x0,helper_1[_0xc38758(0x233)])(_0x4712e0)});_0x157ec6=await(0x0,spark_1[_0xc38758(0x3b5)])(_0x48fd4d?_0x45ae97:_0x1b1233,{'temperature':_0x40c64c,'key':_0x52d116,'model':_0x4ac922,'onProgress':_0xa9e6d7=>{const _0x1ce77f=_0xc38758;this[_0x1ce77f(0x403)](_0x92dd21,_0xa9e6d7,_0x695af6['stream'],_0x5f2ce0,_0x4feafa),_0x4feafa=![],_0x1f0f95=_0xa9e6d7;}}),_0x2c55f3=!![];}if(Number(_0x3190f5)===0x7){_0x157ec6={};const _0x1cc05c=await this['configKimiApi'](_0x62d889);let _0x29b248=!![],_0x2d958b=[],_0x3f3098=!![];const _0x25ebd7=[],_0x11cf61=[],_0x25478f=_0x31623f[_0xc38758(0x2fa)]('\x20');for(let _0x5699d5=0x0;_0x5699d5<_0x25478f[_0xc38758(0x2b8)];_0x5699d5++){_0x29b248&&/^[http:\/\/|https:\/\/]/[_0xc38758(0x3cd)](_0x25478f[_0x5699d5])?_0x25ebd7['push'](_0x25478f[_0x5699d5]):(_0x29b248=![],_0x25478f[_0x5699d5]&&_0x11cf61[_0xc38758(0x357)](_0x25478f[_0x5699d5]));}if(options[_0xc38758(0x2e4)]){const _0x31aa2f=await this[_0xc38758(0x1ef)][_0xc38758(0x257)](options[_0xc38758(0x33e)]);_0x2d958b=_0x31aa2f[_0xc38758(0x376)](_0x512544=>{const _0xaa4157=_0xc38758;return{'role':_0x512544[_0xaa4157(0x3c9)]===_0xaa4157(0x3bd)?_0xaa4157(0x3bd):_0xaa4157(0x1a8),'content':_0x512544[_0xaa4157(0x35f)]||_0x512544['answer']};});}const _0xac0d31=await this[_0xc38758(0x39f)](_0x1cc05c,_0x25ebd7),_0x2c9dcc=[..._0x2d958b,..._0xac0d31,{'role':_0xc38758(0x1a8),'content':_0xc38758(0x2e7)+_0xc38758(0x308)+'可翻译成其他语言。'},{'role':_0xc38758(0x3bd),'content':_0x11cf61[_0xc38758(0x3c1)]('\x20')}],_0x529c2e=await _0x1cc05c['chat']['completions'][_0xc38758(0x2c0)]({'stream':!![],..._0x3a101f,'messages':_0x2c9dcc,'model':_0x62d889['model']});for await(const _0x16e1f6 of _0x529c2e){const _0x21f9e1=_0x16e1f6?.[_0xc38758(0x27c)][0x0],_0x275ae0=_0x21f9e1?.[_0xc38758(0x3b8)];_0x157ec6[_0xc38758(0x39e)]=_0x16e1f6,_0x16e1f6['id']&&(_0x157ec6['id']=_0x16e1f6['id']),_0x275ae0['role']&&(_0x157ec6['role']=_0x275ae0['role']),_0x275ae0&&_0x275ae0[_0xc38758(0x2a9)]&&(_0x157ec6[_0xc38758(0x1ba)]+=_0x275ae0[_0xc38758(0x2a9)],_0x157ec6['delta']=_0x275ae0?.['content']),_0x21f9e1[_0xc38758(0x1ab)]&&(_0x157ec6[_0xc38758(0x1ba)]=_0x157ec6[_0xc38758(0x1ba)]['trim']()),this[_0xc38758(0x403)](_0x92dd21,_0x157ec6,_0x695af6[_0xc38758(0x24d)],_0x5f2ce0,_0x3f3098),_0x3f3098=![],_0x1f0f95=_0x16e1f6;}}if(Number(_0x3190f5)===0x8){_0x157ec6={'text':''};const _0x148684=await this[_0xc38758(0x3cf)](_0x62d889);let _0x6e5793=!![],_0xccc77=[],_0x5c2b98=!![];const _0x480a51=[],_0x265cd8=[],_0x962fbc=_0x31623f[_0xc38758(0x2fa)]('\x20');for(let _0x35128b=0x0;_0x35128b<_0x962fbc[_0xc38758(0x2b8)];_0x35128b++){_0x6e5793&&/^[http:\/\/|https:\/\/]/['test'](_0x962fbc[_0x35128b])?_0x480a51[_0xc38758(0x357)](_0x962fbc[_0x35128b]):(_0x6e5793=![],_0x962fbc[_0x35128b]&&_0x265cd8[_0xc38758(0x357)](_0x962fbc[_0x35128b]));}if(options[_0xc38758(0x2e4)]){const _0x435094=await this[_0xc38758(0x1ef)][_0xc38758(0x257)](options[_0xc38758(0x33e)]);_0xccc77=_0x435094[_0xc38758(0x376)](_0x422739=>{const _0x24db4a=_0xc38758;return{'role':_0x422739[_0x24db4a(0x3c9)]===_0x24db4a(0x3bd)?_0x24db4a(0x3bd):'system','content':_0x422739[_0x24db4a(0x35f)]||_0x422739[_0x24db4a(0x401)]};});}let _0x1925d9=[];for(const _0xf0ca61 of _0x480a51){_0x1925d9[_0xc38758(0x357)]({'type':_0xc38758(0x2a3),'image_url':{'url':_0xf0ca61}});}let _0x45142f=[];_0x1925d9[_0xc38758(0x2b8)]?_0x45142f=[..._0xccc77,{'role':_0xc38758(0x3bd),'content':[{'text':_0x265cd8[_0xc38758(0x3c1)]('\x20'),'type':'text'},..._0x1925d9]}]:_0x45142f=[..._0xccc77,{'role':_0xc38758(0x3bd),'content':_0x265cd8[_0xc38758(0x3c1)]('\x20')}];const _0x4c812c=await _0x148684['chat'][_0xc38758(0x333)]['create']({'stream':!![],..._0x3a101f,'messages':_0x45142f,'model':_0x62d889['model']});for await(const _0x278719 of _0x4c812c){const _0x55c9fb=_0x278719?.[_0xc38758(0x27c)][0x0],_0x48242d=_0x55c9fb?.[_0xc38758(0x3b8)];_0x157ec6[_0xc38758(0x39e)]=_0x278719;_0x278719['id']&&(_0x157ec6['id']=_0x278719['id']);_0x48242d[_0xc38758(0x3c9)]&&(_0x157ec6[_0xc38758(0x3c9)]=_0x48242d[_0xc38758(0x3c9)]);_0x48242d&&_0x48242d[_0xc38758(0x2a9)]&&(_0x157ec6[_0xc38758(0x1ba)]+=_0x48242d[_0xc38758(0x2a9)],_0x157ec6['delta']=_0x48242d?.['content']);_0x55c9fb[_0xc38758(0x1ab)]&&(_0x157ec6[_0xc38758(0x1ba)]=_0x157ec6['text'][_0xc38758(0x34f)]());let _0x50721c=this[_0xc38758(0x2ec)](_0x92dd21,_0x157ec6,_0x695af6[_0xc38758(0x24d)],_0x5f2ce0,_0x5c2b98);_0x36c98c+=_0x50721c,_0x5c2b98=![],_0x1f0f95=_0x278719;}_0x2c55f3=!![];}const _0x261d5e={'id':this['gomaxAiStore'][_0xc38758(0x3df)](),'text':_0x31623f,'role':_0xc38758(0x3bd),'name':undefined,'usage':null,'parentMessageId':_0x1a94a7,'conversationId':_0x157ec6?.[_0xc38758(0x225)]||null};_0x221bd0={'model':_0x4ac922,'parentMessageId':_0x1a94a7},await this[_0xc38758(0x38f)][_0xc38758(0x1c5)](_0x261d5e);const _0x117766={'id':_0x157ec6?.['id']||this[_0xc38758(0x38f)][_0xc38758(0x3df)](),'text':_0x157ec6[_0xc38758(0x1ba)],'role':_0xc38758(0x260),'name':undefined,'usage':_0x157ec6[_0xc38758(0x337)],'parentMessageId':_0x261d5e['id'],'conversationId':_0x157ec6?.[_0xc38758(0x225)]};await this['gomaxAiStore'][_0xc38758(0x1c5)](_0x117766),_0x221bd0={'model':_0x4ac922,'parentMessageId':_0x261d5e['id']};}else{console[_0xc38758(0x276)](_0xc38758(0x408));const _0x57299c=await this[_0xc38758(0x2aa)](_0x62d889,_0x3a101f);_0x157ec6=await _0x57299c['sendMessage'](_0x48fd4d?_0x45ae97:_0x31623f,_0x3a101f);}const _0x1a275b=(0x0,helper_1[_0xc38758(0x201)])(_0x3190f5,_0x157ec6,_0x221bd0),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x1a275b[_0xc38758(0x337)];_0x5af5c8==='gpts'?await this[_0xc38758(0x279)][_0xc38758(0x3f5)](_0x3172a8,total_tokens):await this[_0xc38758(0x21d)]['saveUseLog'](_0x3172a8,total_tokens);_0x23b89c[_0xc38758(0x352)]=total_tokens,await this[_0xc38758(0x1ef)]['saveChatLog'](_0x23b89c),_0x1e4105[_0xc38758(0x3ba)]=_0x36c98c,_0x1e4105[_0xc38758(0x401)]=_0x1a275b?.[_0xc38758(0x1ba)],_0x1e4105[_0xc38758(0x352)]=total_tokens,_0x1e4105[_0xc38758(0x1d5)]=prompt_tokens,_0x1e4105[_0xc38758(0x3dd)]=completion_tokens,_0x1e4105[_0xc38758(0x238)]=JSON[_0xc38758(0x2d2)]({'conversationId':_0x157ec6[_0xc38758(0x225)],'model':_0x4ac922,'parentMessageId':_0x157ec6['id'],'temperature':_0x40c64c});const _0x12d036=await this[_0xc38758(0x1ef)][_0xc38758(0x2f4)](_0x1e4105);common_1[_0xc38758(0x32f)]['debug'](_0xc38758(0x1d0)+_0x5a62c7[_0xc38758(0x3bd)]['id']+'\x20model:\x20'+_0x4ac922+'\x20key\x20->\x20'+_0x52d116+',\x20模型名称:\x20'+_0x5365a2,_0xc38758(0x1f4)),_0x157ec6[_0xc38758(0x34b)]&&(_0x157ec6[_0xc38758(0x34b)]=''),_0x157ec6[_0xc38758(0x292)]=!![],_0x157ec6[_0xc38758(0x1d9)]=_0x12d036['id'];_0x6aba99&&setTimeout(()=>{const _0x349aa4=_0xc38758;this[_0x349aa4(0x1c9)](_0x5a62c7,_0x12d036);},0x64);if(_0x42dab7==_0xc38758(0x3c2)){const _0x2f0839=await this['mindTaskService'][_0xc38758(0x3ab)]({'id':_0x32a8fd,'userId':_0x12d036['userId'],'chatLogId':_0x12d036['id'],'prompt':_0x12d036['prompt'],'result':_0x1e4105[_0xc38758(0x401)],'status':0x1});_0x157ec6[_0xc38758(0x2ed)]=_0x2f0839['id'];}if(_0x92dd21&&_0x5f2ce0)await this[_0xc38758(0x393)]['deductBalance4Chat'](_0x5a62c7[_0xc38758(0x3bd)]['id'],_0x62d889,_0x12d036['id']),_0x695af6['stream']?_0x92dd21[_0xc38758(0x3c6)](_0xc38758(0x2e3)+JSON[_0xc38758(0x2d2)](_0x157ec6)+'\x0a\x0a'):_0x92dd21[_0xc38758(0x3c6)]('\x0a'+JSON[_0xc38758(0x2d2)](_0x157ec6));else return _0x157ec6[_0xc38758(0x1ba)];}catch(_0x9f5a65){_0x1e4105[_0xc38758(0x401)]=_0x9f5a65[_0xc38758(0x31a)],_0x1e4105[_0xc38758(0x26c)]=_0x9f5a65[_0xc38758(0x31a)],_0x1e4105['conversationOptions']=JSON['stringify']({'conversationId':_0x157ec6?.[_0xc38758(0x225)],'model':_0x4ac922,'parentMessageId':_0x157ec6?.['id'],'temperature':_0x40c64c});const _0x5b6cb7=await this['chatLogService']['saveChatLog'](_0x1e4105);if(_0x42dab7==_0xc38758(0x3c2)){const _0x1be494=await this[_0xc38758(0x3b2)][_0xc38758(0x3ab)]({'id':_0x32a8fd,'userId':_0x5b6cb7[_0xc38758(0x283)],'prompt':_0x5b6cb7[_0xc38758(0x35f)],'chatLogId':_0x5b6cb7['id'],'result':_0x1e4105[_0xc38758(0x401)],'status':-0x1});_0x157ec6[_0xc38758(0x2ed)]=_0x1be494['id'];}const _0x29816e=_0x9f5a65[_0xc38758(0x2b7)];_0x29816e===0x190&&console[_0xc38758(0x276)]('400\x20error',_0x9f5a65,_0x9f5a65[_0xc38758(0x31a)]);if(_0x9f5a65[_0xc38758(0x2ff)]&&_0x9f5a65[_0xc38758(0x2ff)]===0x192){const _0x475ce4={'message':'Catch\x20Error\x20'+_0x9f5a65[_0xc38758(0x31a)],'code':0x192};if(_0x92dd21&&_0x5f2ce0){_0x695af6['stream']?_0x92dd21[_0xc38758(0x3c6)]('data:\x20'+JSON[_0xc38758(0x2d2)](_0x475ce4)+'\x0a\x0a'):_0x92dd21['write'](JSON[_0xc38758(0x2d2)](_0x475ce4));_0x92dd21['end']();return;}else throw new common_1[(_0xc38758(0x213))](_0x9f5a65[_0xc38758(0x31a)],common_1[_0xc38758(0x3d6)][_0xc38758(0x3b0)]);}if(!_0x29816e){if(_0x92dd21&&_0x5f2ce0){_0x695af6[_0xc38758(0x24d)]?_0x92dd21[_0xc38758(0x3c6)]('data:\x20'+JSON[_0xc38758(0x2d2)]({'message':_0x9f5a65[_0xc38758(0x31a)],'code':0x1f4})+'\x0a\x0a'):_0x92dd21[_0xc38758(0x3c6)](JSON[_0xc38758(0x2d2)]({'message':_0x9f5a65['message'],'code':0x1f4}));_0x92dd21[_0xc38758(0x2fc)]();return;}else throw new common_1[(_0xc38758(0x213))](_0x9f5a65[_0xc38758(0x31a)],common_1['HttpStatus'][_0xc38758(0x217)]);}const _0x4b2baa=await this[_0xc38758(0x398)](_0x9f5a65,_0x62d889),_0x11fe18={'message':_0x4b2baa||_0xc38758(0x2b0),'code':_0x29816e===0x191?0x191:_0x29816e||0x1f4};if(_0x92dd21&&_0x5f2ce0)_0x92dd21[_0xc38758(0x2b7)]=0x190,_0x695af6[_0xc38758(0x24d)]?_0x92dd21[_0xc38758(0x3c6)](_0xc38758(0x2e3)+JSON[_0xc38758(0x2d2)](_0x11fe18)+'\x0a\x0a'):_0x92dd21['write'](JSON[_0xc38758(0x2d2)](_0x11fe18));else throw new common_1[(_0xc38758(0x213))](_0x11fe18[_0xc38758(0x31a)],common_1['HttpStatus'][_0xc38758(0x217)]);}finally{_0x92dd21&&_0x5f2ce0&&_0x92dd21[_0xc38758(0x2fc)]();}}catch(_0x28fea5){if(_0x28fea5 instanceof common_1[_0xc38758(0x213)])throw _0x28fea5;else throw new common_1[(_0xc38758(0x213))](_0x28fea5[_0xc38758(0x31a)],common_1[_0xc38758(0x3d6)][_0xc38758(0x217)]);}}async[_0x2fe4bb(0x1c9)](_0x5af66b,_0x15dd3e){const _0x4cb075=_0x2fe4bb,_0x5a3460=await this[_0x4cb075(0x407)](_0x5af66b,{'request':{'text':_0x15dd3e[_0x4cb075(0x401)]}});_0x15dd3e['answerMp3']=_0x5a3460,this[_0x4cb075(0x1ef)][_0x4cb075(0x2f4)](_0x15dd3e);}async[_0x2fe4bb(0x32a)](_0x5c5922){const _0x1a3286=_0x2fe4bb;try{const _0x19ae54=['musicLyricsPrice',_0x1a3286(0x324),'musicCreatePrice',_0x1a3286(0x3d4),_0x1a3286(0x1c0),_0x1a3286(0x1d4)],_0x276af0=await this[_0x1a3286(0x34c)]['getConfigByKeys'](_0x19ae54);if(!_0x5c5922[_0x1a3286(0x3bd)]||!_0x5c5922[_0x1a3286(0x3bd)]['id'])throw new Error(_0x1a3286(0x360));const _0x27aecd=[_0x1a3286(0x1c2),_0x1a3286(0x23d),_0x1a3286(0x35a)],_0x436b13=await Promise['all'](_0x27aecd[_0x1a3286(0x376)](async _0x397c7b=>{const _0x4fe4e4=_0x1a3286,_0x4551e3=_0x276af0[_0x397c7b+_0x4fe4e4(0x3bf)],_0x198016=_0x276af0[_0x397c7b+_0x4fe4e4(0x2cd)],_0x147add=redisKey_constant_1['VIP_FREE']+'-'+_0x5c5922[_0x4fe4e4(0x3bd)]['id']+'-'+(_0x397c7b+'VipFree'),_0x18c57b=await this[_0x4fe4e4(0x393)][_0x4fe4e4(0x38d)](_0x5c5922[_0x4fe4e4(0x3bd)]['id'],_0x147add,_0x4551e3);return{'type':_0x397c7b,'remainCount':_0x18c57b,'freeCount':Number(_0x4551e3),'useIntegrate':Number(_0x198016)};}));return _0x436b13;}catch(_0x17ae4e){console[_0x1a3286(0x312)]('Error\x20in\x20pptConfig:',_0x17ae4e);throw _0x17ae4e;}}async[_0x2fe4bb(0x244)](_0x555afa){const _0x77e18e=_0x2fe4bb,{data:_0x122def,answerLogDTO:_0x215353,currentRequestModel:_0x53b43a,musicTaskType:_0x190908}=_0x555afa;try{let _0x386cb9=process[_0x77e18e(0x409)][_0x77e18e(0x373)];!/^http/[_0x77e18e(0x3cd)](_0x386cb9)&&(_0x386cb9='https://'+_0x386cb9);let _0x591958;if(_0x190908==music_constant_1[_0x77e18e(0x390)][_0x77e18e(0x1d8)])!_0x122def['isCustom']&&(_0x122def[_0x77e18e(0x3f2)]=_0x122def[_0x77e18e(0x35f)],delete _0x122def['prompt']),_0x591958=await this['sunoTaskService'][_0x77e18e(0x2c7)]({'data':_0x122def,'baseURL':_0x53b43a[_0x77e18e(0x1aa)],'headers':{'Authorization':_0x77e18e(0x26a)+_0x53b43a[_0x77e18e(0x350)]}});else _0x190908==music_constant_1['EMusicTaskType']['LYRICS']?(_0x122def['notify_hook']=_0x386cb9+(_0x77e18e(0x28d)+_0x215353['id']),_0x591958=await this[_0x77e18e(0x31f)][_0x77e18e(0x28b)]({'data':_0x122def,'baseURL':_0x53b43a[_0x77e18e(0x1aa)],'headers':{'Authorization':_0x77e18e(0x26a)+_0x53b43a[_0x77e18e(0x350)]}})):(_0x122def[_0x77e18e(0x2eb)]=_0x386cb9+(_0x77e18e(0x315)+_0x215353['id']),_0x591958=await this[_0x77e18e(0x31f)]['upload']({'data':_0x122def,'baseURL':_0x53b43a['proxyUrl'],'headers':{'Authorization':_0x77e18e(0x26a)+_0x53b43a['key']}}));await this[_0x77e18e(0x21d)][_0x77e18e(0x1d3)](_0x53b43a['id'],0x0),_0x215353[_0x77e18e(0x352)]=0x0,_0x215353[_0x77e18e(0x1d5)]=0x0,_0x215353[_0x77e18e(0x3dd)]=0x0,_0x215353[_0x77e18e(0x396)]=_0x591958[_0x77e18e(0x410)],_0x215353[_0x77e18e(0x349)]=_0x190908,_0x215353[_0x77e18e(0x238)]=JSON[_0x77e18e(0x2d2)]({'model':_0x53b43a['model'],'parentMessageId':_0x591958[_0x77e18e(0x410)]}),await this[_0x77e18e(0x1ef)][_0x77e18e(0x2f4)](_0x215353),common_1[_0x77e18e(0x32f)][_0x77e18e(0x347)](_0x77e18e(0x1d0)+_0x215353[_0x77e18e(0x283)]+_0x77e18e(0x3d1)+_0x53b43a[_0x77e18e(0x1bf)]+_0x77e18e(0x1c1)+_0x53b43a[_0x77e18e(0x350)]+',\x20模型名称:\x20'+_0x53b43a['modelName'],_0x77e18e(0x2bf));if(_0x591958[_0x77e18e(0x2de)]!==_0x77e18e(0x3da))throw new Error(_0x77e18e(0x364));}catch(_0x5489c6){console['log'](_0x77e18e(0x246),_0x53b43a[_0x77e18e(0x350)],_0x5489c6);const _0x742741=await this['openAiErrHandler'](_0x5489c6,_0x53b43a);_0x215353['errMsg']=_0x742741,await this[_0x77e18e(0x1ef)][_0x77e18e(0x2f4)](_0x215353),await this[_0x77e18e(0x393)]['debuctBalance4Muisc'](_0x215353[_0x77e18e(0x283)],_0x215353['id'],_0x190908,!![]);}}async[_0x2fe4bb(0x1a3)](_0xd396d8){const _0x22cc82=_0x2fe4bb,{data:_0x21f95d,answerLogDTO:_0x15995d,currentRequestModel:_0x523c1a}=_0xd396d8;try{let _0x28589a;await this[_0x22cc82(0x393)]['deductBalance4Chat'](_0x15995d['userId'],_0x523c1a,_0x15995d['id']);_0x21f95d[_0x22cc82(0x2a6)]?_0x28589a=await this[_0x22cc82(0x211)][_0x22cc82(0x2fe)]({'data':_0x21f95d,'baseURL':_0x523c1a[_0x22cc82(0x1aa)],'headers':{'Authorization':_0x22cc82(0x26a)+_0x523c1a[_0x22cc82(0x350)]}},_0x21f95d[_0x22cc82(0x2a6)]):_0x28589a=await this[_0x22cc82(0x211)][_0x22cc82(0x354)]({'data':_0x21f95d,'baseURL':_0x523c1a[_0x22cc82(0x1aa)],'headers':{'Authorization':_0x22cc82(0x26a)+_0x523c1a[_0x22cc82(0x350)]}});await this['modelsService'][_0x22cc82(0x1d3)](_0x523c1a['id'],0x0),_0x15995d[_0x22cc82(0x352)]=0x0,_0x15995d['promptTokens']=0x0,_0x15995d['completionTokens']=0x0,_0x15995d[_0x22cc82(0x401)]=_0x28589a['state'],_0x15995d[_0x22cc82(0x238)]=JSON[_0x22cc82(0x2d2)]({'model':_0x523c1a['model'],'parentMessageId':_0x28589a['id']}),await this[_0x22cc82(0x1ef)]['saveChatLog'](_0x15995d),common_1['Logger'][_0x22cc82(0x347)](_0x22cc82(0x1d0)+_0x15995d[_0x22cc82(0x283)]+_0x22cc82(0x3d1)+_0x523c1a[_0x22cc82(0x1bf)]+'\x20key\x20->\x20'+_0x523c1a[_0x22cc82(0x350)]+_0x22cc82(0x1cf)+_0x523c1a[_0x22cc82(0x40a)],_0x22cc82(0x1f4));if(!_0x15995d['answer'])throw new Error(_0x22cc82(0x1ec));await this[_0x22cc82(0x1ef)][_0x22cc82(0x226)](_0x15995d,{'id':_0x28589a['id'],'state':_0x28589a['state'],'completed':_0x28589a['state']===_0x22cc82(0x3d0),'videoUrl':_0x28589a[_0x22cc82(0x229)]?.[_0x22cc82(0x3af)]});}catch(_0x7c1a06){console[_0x22cc82(0x276)](_0x22cc82(0x2fb),_0x523c1a['key'],_0x7c1a06);const _0x2232d2=await this['openAiErrHandler'](_0x7c1a06,_0x523c1a);_0x15995d['errMsg']=_0x2232d2,await this['chatLogService'][_0x22cc82(0x2f4)](_0x15995d),await this['userService'][_0x22cc82(0x1ad)](_0x15995d['userId'],_0x523c1a,_0x15995d['id']);}}async[_0x2fe4bb(0x38b)](_0x3ea302){const _0x384b2e=_0x2fe4bb,{data:_0x3a9358,answerLogDTO:_0x4648a9,currentRequestModel:_0x35ee59}=_0x3ea302;try{let _0x4c7f58;await this[_0x384b2e(0x393)][_0x384b2e(0x30a)](_0x4648a9[_0x384b2e(0x283)],_0x35ee59,_0x4648a9['id']);const _0x467d48=_0x3a9358[_0x384b2e(0x39d)],_0x316516={'model':_0x3a9358[_0x384b2e(0x1bf)],'ratio':_0x3a9358[_0x384b2e(0x3b9)],'prompt':_0x3a9358['prompt'],'style':_0x3a9358[_0x384b2e(0x353)],'options':_0x467d48};_0x3a9358[_0x384b2e(0x1bb)]&&(_0x316516[_0x384b2e(0x1bb)]=_0x3a9358[_0x384b2e(0x1bb)]);_0x3a9358[_0x384b2e(0x305)]&&(_0x316516['last_image']=_0x3a9358[_0x384b2e(0x305)]);_0x4c7f58=await this[_0x384b2e(0x281)][_0x384b2e(0x354)]({'data':_0x316516,'baseURL':_0x35ee59['proxyUrl'],'headers':{'Authorization':_0x384b2e(0x26a)+_0x35ee59['key']}}),await this['modelsService'][_0x384b2e(0x1d3)](_0x35ee59['id'],0x0),_0x4648a9[_0x384b2e(0x352)]=0x0,_0x4648a9[_0x384b2e(0x1d5)]=0x0,_0x4648a9[_0x384b2e(0x3dd)]=0x0,_0x4648a9[_0x384b2e(0x26c)]=_0x4c7f58[_0x384b2e(0x3e1)],_0x4648a9[_0x384b2e(0x401)]=_0x4c7f58[_0x384b2e(0x2ff)]=='3'?_0x384b2e(0x28e):_0x4c7f58['status'],_0x4648a9[_0x384b2e(0x238)]=JSON[_0x384b2e(0x2d2)]({'model':_0x35ee59[_0x384b2e(0x1bf)],'parentMessageId':_0x4c7f58[_0x384b2e(0x2ae)]}),await this[_0x384b2e(0x1ef)][_0x384b2e(0x2f4)](_0x4648a9),common_1[_0x384b2e(0x32f)][_0x384b2e(0x347)](_0x384b2e(0x1d0)+_0x4648a9[_0x384b2e(0x283)]+'\x20model:\x20'+_0x35ee59[_0x384b2e(0x1bf)]+_0x384b2e(0x1c1)+_0x35ee59[_0x384b2e(0x350)]+_0x384b2e(0x1cf)+_0x35ee59[_0x384b2e(0x40a)],_0x384b2e(0x1f4));if(_0x4c7f58['msg'])throw new Error('视频生成失败，没有响应');await this[_0x384b2e(0x1ef)][_0x384b2e(0x226)](_0x4648a9,{'id':_0x4c7f58[_0x384b2e(0x2ae)],'state':_0x4c7f58[_0x384b2e(0x2ff)]=='3'?_0x384b2e(0x28e):_0x4c7f58[_0x384b2e(0x2ff)],'completed':_0x4c7f58[_0x384b2e(0x2ff)]==='3','videoUrl':_0x4c7f58[_0x384b2e(0x2d3)]});}catch(_0x1b4a02){console[_0x384b2e(0x276)](_0x384b2e(0x2fb),_0x35ee59[_0x384b2e(0x350)],_0x1b4a02);const _0xc10c59=await this[_0x384b2e(0x398)](_0x1b4a02,_0x35ee59);_0x4648a9[_0x384b2e(0x26c)]=_0xc10c59,await this[_0x384b2e(0x1ef)][_0x384b2e(0x2f4)](_0x4648a9),await this['userService'][_0x384b2e(0x1ad)](_0x4648a9['userId'],_0x35ee59,_0x4648a9['id']);}}async['klingVideoTask'](_0x24fda2){const _0x34c539=_0x2fe4bb,{data:_0x397c37,answerLogDTO:_0x451bc9,currentRequestModel:_0x5f1456}=_0x24fda2;try{let _0x3641aa;await this['userService'][_0x34c539(0x30a)](_0x451bc9[_0x34c539(0x283)],_0x5f1456,_0x451bc9['id']);!_0x397c37['model_name']?(_0x397c37[_0x34c539(0x237)]=_0x397c37['model'],delete _0x397c37['model']):delete _0x397c37[_0x34c539(0x1bf)];_0x397c37[_0x34c539(0x1bb)]?_0x3641aa=await this[_0x34c539(0x20d)]['i2v']({'data':_0x397c37,'baseURL':_0x5f1456['proxyUrl'],'headers':{'Authorization':_0x34c539(0x26a)+_0x5f1456[_0x34c539(0x350)]}}):_0x3641aa=await this['klingTaskService'][_0x34c539(0x37c)]({'data':_0x397c37,'baseURL':_0x5f1456['proxyUrl'],'headers':{'Authorization':_0x34c539(0x26a)+_0x5f1456[_0x34c539(0x350)]}});await this['modelsService'][_0x34c539(0x1d3)](_0x5f1456['id'],0x0),_0x451bc9[_0x34c539(0x352)]=0x0,_0x451bc9['promptTokens']=0x0,_0x451bc9['completionTokens']=0x0,_0x451bc9[_0x34c539(0x401)]=_0x3641aa['task_status'],_0x451bc9[_0x34c539(0x238)]=JSON[_0x34c539(0x2d2)]({'model':_0x5f1456[_0x34c539(0x1bf)],'parentMessageId':_0x3641aa['task_id']}),await this[_0x34c539(0x1ef)][_0x34c539(0x2f4)](_0x451bc9),common_1[_0x34c539(0x32f)][_0x34c539(0x347)](_0x34c539(0x1d0)+_0x451bc9[_0x34c539(0x283)]+_0x34c539(0x3d1)+_0x5f1456[_0x34c539(0x1bf)]+_0x34c539(0x1c1)+_0x5f1456['key']+_0x34c539(0x1cf)+_0x5f1456[_0x34c539(0x40a)],'ChatgptService');if(!_0x451bc9[_0x34c539(0x401)]||_0x451bc9['answer']===_0x34c539(0x1c6))throw new Error(_0x34c539(0x1ec));await this[_0x34c539(0x1ef)][_0x34c539(0x226)](_0x451bc9,{'id':_0x3641aa[_0x34c539(0x2ae)],'state':_0x3641aa[_0x34c539(0x30b)],'completed':_0x3641aa[_0x34c539(0x30b)]==='succeed','videoUrl':_0x3641aa['task_result']&&_0x3641aa[_0x34c539(0x250)]['videos']&&_0x3641aa[_0x34c539(0x250)][_0x34c539(0x29b)]['length']?_0x3641aa[_0x34c539(0x250)][_0x34c539(0x29b)][0x0]?.['url']:''});}catch(_0x1021d0){console[_0x34c539(0x276)](_0x34c539(0x2fb),_0x5f1456[_0x34c539(0x350)],_0x1021d0);const _0x346d05=await this['openAiErrHandler'](_0x1021d0,_0x5f1456);_0x451bc9['errMsg']=_0x346d05,await this['chatLogService']['saveChatLog'](_0x451bc9),await this[_0x34c539(0x393)][_0x34c539(0x1ad)](_0x451bc9[_0x34c539(0x283)],_0x5f1456,_0x451bc9['id']);}}async['klingImageTask'](_0x46bb34,_0x3e832d){const _0x2e1382=_0x2fe4bb;try{const _0x217f4c=(0x0,utils_1['getReqSaasId'])(this[_0x2e1382(0x205)]),_0x2f5b47=await this[_0x2e1382(0x1a6)]({'modelType':model_constant_1['EModelType'][_0x2e1382(0x3f0)],'keyType':'2'});let _0x42ccc7=_0x2f5b47[_0x2e1382(0x224)],_0x2480f7=_0x2f5b47[_0x2e1382(0x1e6)],_0x3c769b=await this[_0x2e1382(0x21d)][_0x2e1382(0x1c8)](model_constant_1[_0x2e1382(0x262)]['DRAW'],parseInt('2'));_0x3c769b[_0x2e1382(0x1bf)]=_0x46bb34[_0x2e1382(0x237)],_0x2480f7['modelInfo'][_0x2e1382(0x1bf)]=_0x46bb34[_0x2e1382(0x237)],await this[_0x2e1382(0x285)]({'prompt':_0x46bb34[_0x2e1382(0x35f)],'currentRequestModel':_0x3c769b,'user':_0x3e832d[_0x2e1382(0x3bd)],'count':_0x46bb34['n']});let {id:_0x1a7fd4,keyType:_0x528747}=_0x2480f7[_0x2e1382(0x291)];const _0x29b6a4=(0x0,utils_1[_0x2e1382(0x3e0)])(_0x3e832d),_0x1e4100={'appId':_0x42ccc7,'curIp':_0x29b6a4,'prompt':_0x46bb34[_0x2e1382(0x35f)],'modelId':_0x1a7fd4,'modelType':model_constant_1[_0x2e1382(0x262)]['DRAW'],'answer':'','model':_0x46bb34['model_name'],'role':_0x2e1382(0x3bd),'userId':_0x3e832d[_0x2e1382(0x3bd)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x2e1382(0x28f)][_0x2e1382(0x3f6)],'logType':0x1,'modelSubType':_0x528747[_0x2e1382(0x26e)](),'requestParams':_0x46bb34,'requestOptions':JSON[_0x2e1382(0x2d2)]({'options':null,'prompt':_0x46bb34[_0x2e1382(0x35f)]}),'saasId':_0x217f4c};await this[_0x2e1382(0x1ef)][_0x2e1382(0x2f4)](_0x1e4100);try{await this['userService'][_0x2e1382(0x2f1)](_0x1e4100[_0x2e1382(0x283)],_0x3c769b,_0x1e4100['id'],_0x46bb34['n']);const _0x151065=await this[_0x2e1382(0x20d)]['w2t']({'data':_0x46bb34,'baseURL':_0x3c769b[_0x2e1382(0x1aa)],'headers':{'Authorization':_0x2e1382(0x26a)+_0x3c769b[_0x2e1382(0x350)]}});_0x1e4100[_0x2e1382(0x339)]=_0x29b6a4,_0x1e4100[_0x2e1382(0x401)]=_0x151065[_0x2e1382(0x30b)],_0x1e4100['message_id']=_0x151065[_0x2e1382(0x2ae)],await this[_0x2e1382(0x1ef)][_0x2e1382(0x2f4)](_0x1e4100);if(!_0x1e4100[_0x2e1382(0x401)]||_0x1e4100[_0x2e1382(0x401)]==='failed')throw new Error(_0x2e1382(0x2b6));}catch(_0x59447e){console['log'](_0x2e1382(0x310),_0x3c769b['key'],_0x59447e);const _0x16e811=await this[_0x2e1382(0x398)](_0x59447e,_0x3c769b);_0x1e4100[_0x2e1382(0x26c)]=_0x16e811,await this[_0x2e1382(0x1ef)][_0x2e1382(0x2f4)](_0x1e4100),await this['userService'][_0x2e1382(0x1ad)](_0x1e4100[_0x2e1382(0x283)],_0x3c769b,_0x1e4100['id']);}return this[_0x2e1382(0x1ef)][_0x2e1382(0x1fe)](_0x1e4100);}catch(_0x3fdbda){if(_0x3fdbda instanceof common_1[_0x2e1382(0x213)])throw _0x3fdbda;else throw new common_1[(_0x2e1382(0x213))](_0x3fdbda[_0x2e1382(0x31a)],common_1['HttpStatus'][_0x2e1382(0x217)]);}}async['jmengVideoTask'](_0x1f81d7){const _0x1a2779=_0x2fe4bb,{data:_0x45ac63,answerLogDTO:_0x74cd1c,currentRequestModel:_0x4e91d2}=_0x1f81d7;try{await this[_0x1a2779(0x393)][_0x1a2779(0x30a)](_0x74cd1c[_0x1a2779(0x283)],_0x4e91d2,_0x74cd1c['id']);!_0x45ac63[_0x1a2779(0x237)]?(_0x45ac63[_0x1a2779(0x237)]=_0x45ac63['model'],delete _0x45ac63[_0x1a2779(0x1bf)]):delete _0x45ac63['model'];const _0x17682f=new openapi_1[(_0x1a2779(0x1dd))]({'serviceName':'cv','region':'cn-north-1','host':_0x4e91d2['proxyUrl'],'accessKeyId':_0x4e91d2[_0x1a2779(0x350)],'secretKey':_0x4e91d2['secret']}),_0x54f289=_0x17682f[_0x1a2779(0x338)](_0x1a2779(0x378),{'Version':_0x1a2779(0x22b),'method':_0x1a2779(0x268),'contentType':'json'}),_0x5968db={'req_key':_0x4e91d2[_0x1a2779(0x1bf)],'model_name':_0x45ac63['model_name'],'prompt':_0x45ac63[_0x1a2779(0x35f)],'seed':_0x45ac63['seed'],'aspect_ratio':_0x45ac63[_0x1a2779(0x2b3)],'image_urls':_0x45ac63['image_urls']},_0x2e8bef=await _0x54f289(_0x5968db);if(_0x2e8bef[_0x1a2779(0x2de)]!=0x2710)throw new Error(_0x1a2779(0x322)+_0x2e8bef['message']);await this['modelsService'][_0x1a2779(0x1d3)](_0x4e91d2['id'],0x0),_0x74cd1c[_0x1a2779(0x396)]=_0x2e8bef[_0x1a2779(0x410)][_0x1a2779(0x2ae)],_0x74cd1c[_0x1a2779(0x401)]=_0x2e8bef['status'],_0x74cd1c[_0x1a2779(0x238)]=JSON[_0x1a2779(0x2d2)]({'model':_0x4e91d2[_0x1a2779(0x1bf)],'parentMessageId':_0x2e8bef[_0x1a2779(0x410)][_0x1a2779(0x2ae)]}),await this[_0x1a2779(0x1ef)][_0x1a2779(0x2f4)](_0x74cd1c),await this[_0x1a2779(0x1ef)][_0x1a2779(0x226)](_0x74cd1c,{'id':_0x2e8bef[_0x1a2779(0x410)][_0x1a2779(0x2ae)],'state':_0x2e8bef[_0x1a2779(0x2ff)],'completed':![],'videoUrl':''});}catch(_0x395351){console['log'](_0x1a2779(0x2ad),_0x4e91d2[_0x1a2779(0x350)],_0x395351);const _0x7cc5db=await this[_0x1a2779(0x398)](_0x395351,_0x4e91d2);_0x74cd1c[_0x1a2779(0x26c)]=_0x7cc5db,_0x74cd1c[_0x1a2779(0x401)]=_0x1a2779(0x1c6),await this[_0x1a2779(0x1ef)][_0x1a2779(0x2f4)](_0x74cd1c),await this[_0x1a2779(0x393)]['refundBalance4Chat'](_0x74cd1c[_0x1a2779(0x283)],_0x4e91d2,_0x74cd1c['id']);}}async[_0x2fe4bb(0x2a0)](_0x1a5b9a,_0x1fd88b){const _0x454854=_0x2fe4bb;try{const _0x83b257=(0x0,utils_1[_0x454854(0x2a8)])(this[_0x454854(0x205)]),_0x1c363f=await this[_0x454854(0x1a6)]({'modelType':model_constant_1['EModelType'][_0x454854(0x3f0)],'keyType':'3'});let _0x4f9088=_0x1c363f[_0x454854(0x224)],_0x4bc5ff=_0x1c363f['modelConfig'],_0x2e3018=await this[_0x454854(0x21d)][_0x454854(0x1c8)](model_constant_1['EModelType'][_0x454854(0x3f0)],parseInt('3'));_0x2e3018[_0x454854(0x1bf)]=_0x1a5b9a[_0x454854(0x237)],_0x4bc5ff[_0x454854(0x291)][_0x454854(0x1bf)]=_0x1a5b9a['model_name'],await this['validateBeforeDraw']({'prompt':_0x1a5b9a[_0x454854(0x35f)],'currentRequestModel':_0x2e3018,'user':_0x1fd88b[_0x454854(0x3bd)]});let {id:_0x1597e7,keyType:_0x71dfe0}=_0x4bc5ff['modelInfo'];const _0x2ee71a=(0x0,utils_1['getClientIp'])(_0x1fd88b),_0xe6e471={'appId':_0x4f9088,'curIp':_0x2ee71a,'prompt':_0x1a5b9a[_0x454854(0x35f)],'modelId':_0x1597e7,'modelType':model_constant_1[_0x454854(0x262)]['DRAW'],'answer':'','model':_0x1a5b9a['model_name'],'role':_0x454854(0x3bd),'userId':_0x1fd88b[_0x454854(0x3bd)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x454854(0x28f)]['PAINT_TYPE'],'logType':0x1,'modelSubType':_0x71dfe0[_0x454854(0x26e)](),'requestParams':_0x1a5b9a,'requestOptions':JSON[_0x454854(0x2d2)]({'options':null,'prompt':_0x1a5b9a[_0x454854(0x35f)]}),'saasId':_0x83b257};await this[_0x454854(0x1ef)][_0x454854(0x2f4)](_0xe6e471);try{await this[_0x454854(0x393)][_0x454854(0x2f1)](_0xe6e471[_0x454854(0x283)],_0x2e3018,_0xe6e471['id']);const _0x1244df=new openapi_1['Service']({'serviceName':'cv','region':_0x454854(0x3f4),'host':_0x4bc5ff[_0x454854(0x291)][_0x454854(0x1aa)],'accessKeyId':_0x4bc5ff['modelInfo'][_0x454854(0x350)],'secretKey':_0x4bc5ff[_0x454854(0x291)][_0x454854(0x1ce)]}),_0x310e0a=_0x1244df['createAPI'](_0x454854(0x1f5),{'Version':_0x454854(0x22b),'method':'POST','contentType':_0x454854(0x202)}),_0x339119=await _0x310e0a({'req_key':_0x4bc5ff[_0x454854(0x291)][_0x454854(0x1bf)],..._0x1a5b9a});_0xe6e471[_0x454854(0x339)]=_0x2ee71a;if(_0x339119[_0x454854(0x2de)]==0x2710){const _0x3aa33b=[];_0xe6e471['requestParams']=_0x339119['data']['infer_ctx'][_0x454854(0x1e8)];for(const _0x1aae9e of _0x339119['data'][_0x454854(0x2b4)]){const _0x2273db=_0x1aae9e,_0x1b2daa=uuid['v4']()[_0x454854(0x320)](0x0,0xa)+_0x454854(0x1f2),_0xb8758=Buffer[_0x454854(0x335)](_0x2273db,'base64');_0x3aa33b[_0x454854(0x357)](this[_0x454854(0x3d8)]['uploadFile']({'filename':_0x1b2daa,'buffer':_0xb8758}));}const _0x4b16b5=await Promise[_0x454854(0x30e)](_0x3aa33b);_0xe6e471[_0x454854(0x3fe)]=JSON[_0x454854(0x2d2)](_0x4b16b5);}else throw new Error(_0x454854(0x2b6)+_0x339119[_0x454854(0x31a)]);await this[_0x454854(0x1ef)][_0x454854(0x2f4)](_0xe6e471);}catch(_0x1450d3){console[_0x454854(0x276)]('jmeng-draw-task',_0x2e3018[_0x454854(0x350)],_0x1450d3);const _0x705286=await this['openAiErrHandler'](_0x1450d3,_0x2e3018);_0xe6e471['errMsg']=_0x705286,await this[_0x454854(0x1ef)]['saveChatLog'](_0xe6e471),await this[_0x454854(0x393)]['refundBalance4Chat'](_0xe6e471[_0x454854(0x283)],_0x2e3018,_0xe6e471['id']);}return this[_0x454854(0x1ef)]['returnDrawDetail'](_0xe6e471);}catch(_0x27649c){if(_0x27649c instanceof common_1[_0x454854(0x213)])throw _0x27649c;else throw new common_1['HttpException'](_0x27649c[_0x454854(0x31a)],common_1[_0x454854(0x3d6)]['BAD_REQUEST']);}}async[_0x2fe4bb(0x334)](_0x6b6254){const _0x25eb43=_0x2fe4bb;try{const _0x3c1ce3=(0x0,utils_1['getReqSaasId'])(this['clsService']),{req:_0xed703a,model:_0x15386b,modelType:_0x56f3d8,datas:_0x444f09,requestBody:_0x159fa2,musicTaskType:_0x47c3ba}=_0x6b6254;let _0x2a6457,_0x2747d1;const _0x1dd19d=await this[_0x25eb43(0x1a6)]({'modelType':_0x56f3d8});_0x2a6457=_0x1dd19d['appId'],_0x2747d1=_0x1dd19d[_0x25eb43(0x1e6)];let _0x34c10e='';_0x25eb43(0x35f)in _0x444f09&&(_0x34c10e=_0x444f09[_0x25eb43(0x35f)]);const _0x3ed220=await this[_0x25eb43(0x21d)]['getRandomKey'](_0x56f3d8,_0x56f3d8===model_constant_1[_0x25eb43(0x262)][_0x25eb43(0x3c7)]?_0x15386b:'');_0x3ed220['model']=_0x15386b,_0x2747d1['modelInfo'][_0x25eb43(0x1bf)]=_0x15386b;_0x25eb43(0x35f)in _0x444f09&&await this[_0x25eb43(0x371)]({'prompt':_0x34c10e,'currentRequestModel':_0x3ed220,'user':_0xed703a[_0x25eb43(0x3bd)]});let {id:_0x4abba9,topN:_0x560408,keyType:_0x45a57f}=_0x2747d1['modelInfo'];const _0x6ff8a8=0x0,_0x27cd45=0x0,_0x488ebb=_0x6ff8a8+_0x27cd45,_0xf7ea6d=(0x0,utils_1['getClientIp'])(_0xed703a),_0x1e954e={'appId':_0x2a6457,'curIp':_0xf7ea6d,'prompt':_0x34c10e,'modelId':_0x4abba9,'modelType':_0x56f3d8,'answer':'','model':_0x15386b,'role':_0x25eb43(0x3bd),'userId':_0xed703a['user']['id'],'completionTokens':0x0,'totalTokens':_0x488ebb,'type':balance_constant_1[_0x25eb43(0x28f)][_0x25eb43(0x327)],'logType':0x1,'modelSubType':'','requestParams':_0x159fa2||_0x444f09,'requestOptions':JSON[_0x25eb43(0x2d2)]({'options':null,'prompt':_0x34c10e}),'saasId':_0x3c1ce3},_0x540443={..._0x1e954e,'role':'assistant','requestOptions':JSON[_0x25eb43(0x2d2)]({'prompt':_0x34c10e,'options':{'model':_0x15386b,'temperature':_0x560408}})};await this['chatLogService'][_0x25eb43(0x2f4)](_0x1e954e);const _0x35e57e=await this[_0x25eb43(0x1ef)][_0x25eb43(0x2f4)](_0x540443);return await this[_0x25eb43(0x393)][_0x25eb43(0x1eb)](_0xed703a['user']['id'],_0x35e57e['id'],_0x47c3ba),await this['sunoMusicTask']({'data':_0x444f09,'currentRequestModel':_0x3ed220,'answerLogDTO':_0x35e57e,'musicTaskType':_0x47c3ba}),_0x35e57e;}catch(_0x30c7a8){if(_0x30c7a8 instanceof common_1[_0x25eb43(0x213)])throw _0x30c7a8;else throw new common_1[(_0x25eb43(0x213))](_0x30c7a8[_0x25eb43(0x31a)],common_1[_0x25eb43(0x3d6)]['BAD_REQUEST']);}}async[_0x2fe4bb(0x2e5)](_0x9fab6){const _0x146f2e=_0x2fe4bb;try{const _0x395416=(0x0,utils_1[_0x146f2e(0x2a8)])(this[_0x146f2e(0x205)]),{req:_0x1a42f6,model:_0xbc77df,modelType:_0x19ffc1,datas:_0x3b43c3,requestBody:_0x46db6b}=_0x9fab6,{prompt:_0x1618f5,options:options={}}=_0x3b43c3,{groupId:_0x41e4bb,type:_0xa59c50}=options;let _0x57b884,_0x39d425,_0x170c7a;if(_0x19ffc1===model_constant_1[_0x146f2e(0x262)][_0x146f2e(0x3c7)]){const _0x4070d4=await this[_0x146f2e(0x1a6)]({'modelType':_0x19ffc1,'keyType':_0x9fab6['keyType']});_0x57b884=_0x4070d4[_0x146f2e(0x224)],_0x39d425=_0x4070d4['modelConfig'],_0x170c7a=await this[_0x146f2e(0x21d)][_0x146f2e(0x1c8)](_0x19ffc1,parseInt(_0x9fab6[_0x146f2e(0x23a)]));}else{const _0x172ba3=await this[_0x146f2e(0x1a6)]({'modelType':_0x19ffc1});_0x57b884=_0x172ba3[_0x146f2e(0x224)],_0x39d425=_0x172ba3['modelConfig'],_0x170c7a=await this['modelsService'][_0x146f2e(0x372)](_0x19ffc1);}_0x170c7a[_0x146f2e(0x1bf)]=_0xbc77df,_0x39d425[_0x146f2e(0x291)][_0x146f2e(0x1bf)]=_0xbc77df;_0x19ffc1===model_constant_1[_0x146f2e(0x262)][_0x146f2e(0x3c7)]?await this[_0x146f2e(0x1bd)]({'prompt':_0x1618f5,'currentRequestModel':_0x170c7a,'user':_0x1a42f6[_0x146f2e(0x3bd)],'requestParams':_0x46db6b}):await this['validateBeforeChat']({'prompt':_0x1618f5,'currentRequestModel':_0x170c7a,'user':_0x1a42f6['user']});let {id:_0x5edc75,topN:_0x5d0a06,keyType:_0x35c668}=_0x39d425['modelInfo'];const _0x17862c=0x0,_0x91e6a1=0x0,_0xf8e7a2=_0x17862c+_0x91e6a1,_0x6af0bf=(0x0,utils_1[_0x146f2e(0x3e0)])(_0x1a42f6),_0x5217f7={'appId':_0x57b884,'curIp':_0x6af0bf,'prompt':_0x1618f5,'groupId':_0x41e4bb,'modelId':_0x5edc75,'modelType':_0x19ffc1,'answer':'','model':_0xbc77df,'role':_0x146f2e(0x3bd),'userId':_0x1a42f6[_0x146f2e(0x3bd)]['id'],'completionTokens':0x0,'totalTokens':_0xf8e7a2,'type':balance_constant_1[_0x146f2e(0x28f)]['CHAT_TYPE'],'logType':_0xa59c50===_0x146f2e(0x384)?0x2:0x1,'modelSubType':_0x19ffc1===model_constant_1[_0x146f2e(0x262)][_0x146f2e(0x3c7)]?_0x35c668[_0x146f2e(0x26e)]():'','requestParams':_0x46db6b||_0x3b43c3,'requestOptions':JSON[_0x146f2e(0x2d2)]({'options':null,'prompt':_0x1618f5}),'saasId':_0x395416},_0x106909={..._0x5217f7,'role':'assistant','requestOptions':JSON[_0x146f2e(0x2d2)]({'prompt':_0x1618f5,'options':{'model':_0xbc77df,'temperature':_0x5d0a06}})};await this[_0x146f2e(0x1ef)]['saveChatLog'](_0x5217f7);const _0x25cec2=await this['chatLogService']['saveChatLog'](_0x106909);if(_0x19ffc1===model_constant_1['EModelType'][_0x146f2e(0x3c7)]){await this['userService'][_0x146f2e(0x342)](_0x1a42f6[_0x146f2e(0x3bd)]['id'],_0x170c7a,_0x46db6b,_0x25cec2['id']);switch(_0x35c668){case 0x2:this[_0x146f2e(0x38b)]({'data':_0x3b43c3,'currentRequestModel':_0x170c7a,'answerLogDTO':_0x25cec2});break;case 0x3:this[_0x146f2e(0x39a)]({'data':_0x3b43c3,'currentRequestModel':_0x170c7a,'answerLogDTO':_0x25cec2});break;case 0x5:this[_0x146f2e(0x1f8)]({'data':_0x3b43c3,'currentRequestModel':_0x170c7a,'answerLogDTO':_0x25cec2});break;default:this[_0x146f2e(0x1a3)]({'data':_0x3b43c3,'currentRequestModel':_0x170c7a,'answerLogDTO':_0x25cec2});}}else await this[_0x146f2e(0x393)][_0x146f2e(0x30a)](_0x1a42f6[_0x146f2e(0x3bd)]['id'],_0x170c7a,_0x25cec2['id']);return _0x25cec2;}catch(_0x502290){if(_0x502290 instanceof common_1[_0x146f2e(0x213)])throw _0x502290;else throw new common_1[(_0x146f2e(0x213))](_0x502290[_0x146f2e(0x31a)],common_1[_0x146f2e(0x3d6)][_0x146f2e(0x217)]);}}async[_0x2fe4bb(0x3a8)](_0x1f989b,_0x1799c8){const _0x5f12f1=_0x2fe4bb;let {mv:_0x457c7b}=_0x1f989b;return!_0x1f989b[_0x5f12f1(0x25b)]?_0x1f989b['make_instrumental']=![]:_0x1f989b[_0x5f12f1(0x25b)]=!![],this[_0x5f12f1(0x334)]({'req':_0x1799c8,'datas':_0x1f989b,'model':_0x457c7b||'suno-v3','modelType':model_constant_1[_0x5f12f1(0x262)][_0x5f12f1(0x2ab)],'musicTaskType':music_constant_1[_0x5f12f1(0x390)][_0x5f12f1(0x1d8)]});}async[_0x2fe4bb(0x245)](_0x43bc4c,_0x43847a){const _0x37e084=_0x2fe4bb,_0xba2e1f={'url':_0x43bc4c};return this[_0x37e084(0x334)]({'req':_0x43847a,'datas':_0xba2e1f,'model':_0x37e084(0x1ac),'modelType':model_constant_1[_0x37e084(0x262)][_0x37e084(0x2ab)],'musicTaskType':music_constant_1[_0x37e084(0x390)][_0x37e084(0x2c1)]});}async[_0x2fe4bb(0x2d1)](_0x22cb0f,_0x4651ae){const _0x2c87e5=_0x2fe4bb;return this[_0x2c87e5(0x334)]({'req':_0x4651ae,'datas':_0x22cb0f,'model':'suno-v3','modelType':model_constant_1[_0x2c87e5(0x262)][_0x2c87e5(0x2ab)],'musicTaskType':music_constant_1['EMusicTaskType']['LYRICS']});}async[_0x2fe4bb(0x3e8)](_0x6fc78c,_0x1f40e4){const _0x53cfc6=_0x2fe4bb,_0x39cb43=JSON['parse'](JSON['stringify'](_0x6fc78c));let {model:_0x2c52c4,prompt:_0x1b00b9,expand_prompt:_0x43906c,aspect_ratio:_0x41153c,image_url:_0x471740,image_end_url:_0x16be76}=_0x6fc78c,_0x3ed93e=_0x53cfc6(0x31d)+_0x1b00b9+_0x53cfc6(0x3f3)+_0x43906c+_0x53cfc6(0x2d8)+_0x41153c;return _0x471740&&(_0x3ed93e=_0x3ed93e+_0x53cfc6(0x367)+_0x471740),_0x16be76&&(_0x3ed93e=_0x3ed93e+_0x53cfc6(0x236)+_0x16be76),_0x6fc78c[_0x53cfc6(0x35f)]=_0x3ed93e,_0x6fc78c['user_prompt']=_0x1b00b9,this['chatTask']({'req':_0x1f40e4,'datas':_0x6fc78c,'requestBody':_0x39cb43,'model':_0x2c52c4||_0x53cfc6(0x40b),'keyType':'1','modelType':model_constant_1[_0x53cfc6(0x262)][_0x53cfc6(0x3c7)]});}async[_0x2fe4bb(0x1b8)](_0x580e42,_0xaad2cd){const _0x305576=_0x2fe4bb,_0x3026fd=JSON[_0x305576(0x273)](JSON['stringify'](_0x580e42));return this[_0x305576(0x2e5)]({'req':_0xaad2cd,'datas':_0x580e42,'requestBody':_0x3026fd,'model':_0x580e42[_0x305576(0x1bf)]||'gen2','keyType':'2','modelType':model_constant_1[_0x305576(0x262)]['VIDEO']});}async[_0x2fe4bb(0x30f)](_0x3393e4,_0x120581){const _0x116893=_0x2fe4bb,_0xc897df=JSON['parse'](JSON[_0x116893(0x2d2)](_0x3393e4));return!_0x3393e4[_0x116893(0x1bf)]&&(_0x3393e4[_0x116893(0x1bf)]=_0x3393e4[_0x116893(0x237)]),this[_0x116893(0x2e5)]({'req':_0x120581,'datas':_0x3393e4,'requestBody':_0xc897df,'model':_0x3393e4[_0x116893(0x1bf)]||_0x116893(0x3c5),'keyType':'5','modelType':model_constant_1[_0x116893(0x262)][_0x116893(0x3c7)]});}async['klingChatVideo'](_0x555091,_0x5c8a77){const _0x31244f=_0x2fe4bb,_0x36720f=JSON[_0x31244f(0x273)](JSON['stringify'](_0x555091));return this[_0x31244f(0x2e5)]({'req':_0x5c8a77,'datas':_0x555091,'requestBody':_0x36720f,'model':_0x555091[_0x31244f(0x1bf)]||_0x31244f(0x288),'keyType':'3','modelType':model_constant_1['EModelType'][_0x31244f(0x3c7)]});}async[_0x2fe4bb(0x406)](){const _0x620b83=_0x2fe4bb,_0x949da2=await this[_0x620b83(0x1ef)][_0x620b83(0x321)]();if(!_0x949da2[_0x620b83(0x2b8)])return;const _0x370261=[],_0x3b37b8=new Map();_0x949da2[_0x620b83(0x3c8)](_0x36fd8c=>{const _0x23d187=_0x620b83;_0x370261['push'](_0x36fd8c['id']),_0x3b37b8[_0x23d187(0x40d)](_0x36fd8c['id'],_0x36fd8c);});const _0xafca3b=await this[_0x620b83(0x1ef)][_0x620b83(0x20b)](_0x370261),_0x2ed37f=[],_0x307ce1=new Map();_0xafca3b[_0x620b83(0x3c8)](_0x3ce9c1=>{const _0x38260e=_0x620b83;_0x2ed37f[_0x38260e(0x357)](_0x3ce9c1[_0x38260e(0x385)]),_0x307ce1['set'](_0x3ce9c1[_0x38260e(0x385)],_0x3ce9c1);});const _0x11ba0=await this[_0x620b83(0x21d)][_0x620b83(0x372)](model_constant_1[_0x620b83(0x262)]['VIDEO']),_0x2bcd34=await this[_0x620b83(0x211)][_0x620b83(0x402)]({'baseURL':_0x11ba0[_0x620b83(0x1aa)],'headers':{'Authorization':_0x620b83(0x26a)+_0x11ba0['key']},'data':{'ids':_0x2ed37f}});for(let _0x36b079=0x0;_0x36b079<_0x2bcd34[_0x620b83(0x2b8)];_0x36b079++){const _0x3c987e=_0x2bcd34[_0x36b079],_0x261440=_0x307ce1['get'](_0x3c987e[_0x620b83(0x2ae)]),_0x116e5e=_0x3b37b8['get'](_0x261440[_0x620b83(0x1d9)]);await this[_0x620b83(0x1ef)][_0x620b83(0x226)](_0x116e5e,{'id':_0x3c987e[_0x620b83(0x410)]['id'],'state':_0x3c987e[_0x620b83(0x410)][_0x620b83(0x346)],'completed':_0x3c987e[_0x620b83(0x410)][_0x620b83(0x346)]===_0x620b83(0x3d0),'videoUrl':_0x3c987e[_0x620b83(0x410)]['video']?.['url']});}}async['requestFromGpt'](_0x1d6487){const _0x20ef22=_0x2fe4bb,{prompt:_0x1b4c1c,userId:_0x43e3e0,abortController:_0x13c403}=_0x1d6487,_0x208800=await this[_0x20ef22(0x21d)][_0x20ef22(0x2ce)](model_constant_1[_0x20ef22(0x262)]['CHAT']),_0x4d5f6c=_0x208800[_0x20ef22(0x291)],_0x4b923a=_0x208800[_0x20ef22(0x291)]['keyType'];if(!_0x4d5f6c)throw new common_1[(_0x20ef22(0x213))](_0x20ef22(0x2c5),common_1[_0x20ef22(0x3d6)]['BAD_REQUEST']);const {id:_0x2ff1dc}=_0x4d5f6c;let _0x4c5725=null,_0x2fdf07=null;try{const _0x39f569=await this[_0x20ef22(0x29d)]('','',_0x4d5f6c),_0x276764=await this[_0x20ef22(0x2aa)](_0x4d5f6c,_0x39f569);_0x4c5725=await _0x276764['sendMessage'](_0x1b4c1c,{..._0x39f569,'abortSignal':_0x13c403[_0x20ef22(0x3fb)]});const _0x2edc5d=(0x0,helper_1[_0x20ef22(0x201)])(_0x4b923a,_0x4c5725,_0x2fdf07),{total_tokens:total_tokens=0x0}=_0x2edc5d['usage'];return await this['modelsService'][_0x20ef22(0x1d3)](_0x2ff1dc,total_tokens),await this['userService'][_0x20ef22(0x30a)](_0x43e3e0,_0x4d5f6c,-0x1),_0x4c5725[_0x20ef22(0x1ba)];}catch(_0x51f695){common_1[_0x20ef22(0x32f)][_0x20ef22(0x276)](_0x51f695);const _0x3574b8=_0x51f695[_0x20ef22(0x2b7)];console[_0x20ef22(0x276)](_0x3574b8);if(_0x51f695['status']&&_0x51f695[_0x20ef22(0x2ff)]===0x192)throw new common_1[(_0x20ef22(0x213))](_0x51f695[_0x20ef22(0x31a)],common_1['HttpStatus'][_0x20ef22(0x3b0)]);if(!_0x3574b8)throw new common_1[(_0x20ef22(0x213))](_0x51f695[_0x20ef22(0x31a)],common_1['HttpStatus'][_0x20ef22(0x217)]);let _0x55a109=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x3574b8]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x3574b8]:_0x20ef22(0x2f6);_0x51f695?.['message'][_0x20ef22(0x1f3)](_0x20ef22(0x2d0))&&Number(_0x4b923a)===0x1&&(await this[_0x20ef22(0x21d)]['lockKey'](_0x2ff1dc,_0x20ef22(0x1a5),-0x1),_0x55a109='当前模型key已被封禁');_0x51f695?.[_0x20ef22(0x2b7)]===0x1ad&&_0x51f695['message'][_0x20ef22(0x1f3)](_0x20ef22(0x2bb))&&Number(_0x4b923a)===0x1&&(await this[_0x20ef22(0x21d)][_0x20ef22(0x231)](_0x2ff1dc,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x55a109=_0x20ef22(0x227));_0x51f695?.[_0x20ef22(0x2b7)]===0x191&&_0x51f695[_0x20ef22(0x31a)]['includes'](_0x20ef22(0x1db))&&Number(_0x4b923a)===0x1&&(await this[_0x20ef22(0x21d)]['lockKey'](_0x2ff1dc,_0x20ef22(0x370),-0x2),_0x55a109='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');_0x51f695?.[_0x20ef22(0x2b7)]===0x191&&_0x51f695['message'][_0x20ef22(0x1f3)](_0x20ef22(0x2e2))&&Number(_0x4b923a)===0x1&&(await this[_0x20ef22(0x21d)][_0x20ef22(0x231)](_0x2ff1dc,_0x20ef22(0x227),-0x2),_0x55a109=_0x20ef22(0x254));_0x51f695?.[_0x20ef22(0x2b7)]===0x194&&_0x51f695['message'][_0x20ef22(0x1f3)](_0x20ef22(0x258))&&Number(_0x4b923a)===0x1&&(await this[_0x20ef22(0x21d)][_0x20ef22(0x231)](_0x2ff1dc,_0x20ef22(0x20f),-0x4),_0x55a109=_0x20ef22(0x3fc));_0x51f695?.[_0x20ef22(0x2b7)]===0x133&&_0x51f695[_0x20ef22(0x31a)][_0x20ef22(0x1f3)]('bad\x20response\x20status\x20code\x20307')&&Number(_0x4b923a)===0x1&&(_0x55a109='\x20！');_0x3574b8===0x190&&console[_0x20ef22(0x276)]('400\x20error',_0x51f695,_0x51f695[_0x20ef22(0x31a)]);const _0x1f9314={'message':_0x55a109||'Please\x20check\x20the\x20back-end\x20console','code':_0x3574b8===0x191?0x191:_0x3574b8||0x1f4};throw new common_1[(_0x20ef22(0x213))](_0x1f9314['message'],common_1[_0x20ef22(0x3d6)][_0x20ef22(0x217)]);}}async['chatRealTime'](_0x519338,_0x258f4e,_0x1ed968){const _0x43bc07=_0x2fe4bb;try{const {audio:_0x396d6f,voice:_0x1250f9}=_0x519338,_0x3975b8=_0x258f4e[_0x43bc07(0x30d)],_0x5b0562=await this[_0x43bc07(0x21d)][_0x43bc07(0x241)]();if(!_0x5b0562)throw _0x43bc07(0x1e9);const {key:_0x1a213d,proxyUrl:_0x39be87}=_0x5b0562;await this[_0x43bc07(0x393)][_0x43bc07(0x230)](_0x258f4e[_0x43bc07(0x3bd)]),await this[_0x43bc07(0x393)][_0x43bc07(0x200)](_0x258f4e['user']['id'],_0x5b0562),console[_0x43bc07(0x276)]('key\x20%s,\x20proxy\x20%s',_0x1a213d,_0x39be87),this[_0x43bc07(0x214)][_0x43bc07(0x39c)]=_0x1a213d,this[_0x43bc07(0x214)]['baseURL']=(_0x39be87||this[_0x43bc07(0x36b)])+'/v1',this[_0x43bc07(0x214)][_0x43bc07(0x3de)]=0x989680;const _0x33f405=await this['openAi']['audio']['transcriptions']['create']({'file':(0x0,fs_1[_0x43bc07(0x22e)])((0x0,path_1[_0x43bc07(0x3ec)])(_0x396d6f[_0x43bc07(0x389)])),'model':_0x43bc07(0x2ba),'language':'zh','response_format':_0x43bc07(0x202),'temperature':0x0})[_0x43bc07(0x2cf)](_0x92bf51=>_0x92bf51[_0x43bc07(0x1ba)])['catch'](_0x121398=>{const _0x1fe0ee=_0x43bc07;common_1[_0x1fe0ee(0x32f)]['error'](_0x121398);});console['log'](_0x43bc07(0x22f),_0x33f405);if(!_0x33f405){this[_0x43bc07(0x24e)]((0x0,path_1[_0x43bc07(0x3ec)])(_0x396d6f[_0x43bc07(0x389)]));throw new common_1[(_0x43bc07(0x213))](_0x43bc07(0x21b),common_1['HttpStatus']['BAD_REQUEST']);}await this[_0x43bc07(0x393)][_0x43bc07(0x30a)](_0x258f4e[_0x43bc07(0x3bd)]['id'],_0x5b0562,-0x1);const _0xd9581c=await this['requestFromGpt']({'userId':_0x258f4e[_0x43bc07(0x3bd)]['id'],'prompt':_0x33f405,'abortController':_0x3975b8});console['log']('request\x20gpt\x20',_0xd9581c);if(!_0xd9581c){this['removeFile']((0x0,path_1[_0x43bc07(0x3ec)])(_0x396d6f[_0x43bc07(0x389)]));throw new common_1[(_0x43bc07(0x213))]('内容提取失败',common_1[_0x43bc07(0x3d6)]['BAD_REQUEST']);}console[_0x43bc07(0x276)](_0x43bc07(0x314),_0xd9581c[_0x43bc07(0x2b8)]);let _0x31b807=_0xd9581c['length']>0x1000?_0xd9581c[_0x43bc07(0x320)](0x0,0xfff):_0xd9581c;const _0x4304f2=await this[_0x43bc07(0x214)][_0x43bc07(0x255)][_0x43bc07(0x3fd)][_0x43bc07(0x2c0)]({'input':_0x31b807,'model':_0x43bc07(0x1fa),'response_format':_0x43bc07(0x2e6),'voice':_0x1250f9,'speed':0x1})['then'](_0xdc35f=>_0xdc35f[_0x43bc07(0x331)]())[_0x43bc07(0x2f2)](_0x4c9fc6=>{const _0x3da4c6=_0x43bc07;common_1[_0x3da4c6(0x32f)][_0x3da4c6(0x312)](_0x4c9fc6);});if(!_0x4304f2){this[_0x43bc07(0x24e)]((0x0,path_1[_0x43bc07(0x3ec)])(_0x396d6f[_0x43bc07(0x389)]));throw new common_1[(_0x43bc07(0x213))](_0x43bc07(0x2c4),common_1[_0x43bc07(0x3d6)][_0x43bc07(0x217)]);}await this[_0x43bc07(0x393)]['deductBalance4Chat'](_0x258f4e[_0x43bc07(0x3bd)]['id'],_0x5b0562,-0x1);const _0x50dec2=Buffer[_0x43bc07(0x335)](_0x4304f2);return _0x1ed968[_0x43bc07(0x374)](_0x43bc07(0x2be),_0x43bc07(0x2a5)),_0x1ed968['write'](_0x50dec2),_0x1ed968[_0x43bc07(0x2fc)](_0x50dec2),this[_0x43bc07(0x24e)]((0x0,path_1[_0x43bc07(0x3ec)])(_0x396d6f[_0x43bc07(0x389)])),_0x50dec2;}catch(_0x275333){if(_0x275333 instanceof common_1[_0x43bc07(0x213)])throw _0x275333;else throw new common_1[(_0x43bc07(0x213))](_0x275333[_0x43bc07(0x31a)],common_1['HttpStatus'][_0x43bc07(0x217)]);}}async[_0x2fe4bb(0x303)](_0xa7b1a7,_0x325df2){const _0x5eb15b=_0x2fe4bb;common_1[_0x5eb15b(0x32f)][_0x5eb15b(0x276)]('draw\x20paompt\x20info\x20<======*******======>\x20'+_0xa7b1a7[_0x5eb15b(0x35f)],'DrawService'),await this['badwordsService'][_0x5eb15b(0x330)](_0xa7b1a7['prompt'],_0x325df2[_0x5eb15b(0x3bd)]['id']),await this[_0x5eb15b(0x393)][_0x5eb15b(0x230)](_0x325df2[_0x5eb15b(0x3bd)]);let _0x596f7c=[];const _0x280cd3=await this[_0x5eb15b(0x21d)][_0x5eb15b(0x372)](model_constant_1[_0x5eb15b(0x262)][_0x5eb15b(0x3f0)],_0xa7b1a7[_0x5eb15b(0x1bf)]);await this[_0x5eb15b(0x393)][_0x5eb15b(0x37e)](_0x325df2[_0x5eb15b(0x3bd)]['id'],_0x280cd3,_0xa7b1a7['n']);const {key:_0xc6a5fb,model:_0x3fe265,proxyUrl:_0x15a89c}=await this[_0x5eb15b(0x37b)](_0x280cd3),_0x3a5d02=_0x15a89c+_0x5eb15b(0x20c);try{const _0x59c5d7=await axios_1[_0x5eb15b(0x1ae)][_0x5eb15b(0x2b1)](_0x3a5d02,{..._0xa7b1a7,'model':_0x3fe265,'response_format':'b64_json'},{'headers':{'Authorization':_0x5eb15b(0x26a)+_0xc6a5fb}});console[_0x5eb15b(0x276)](_0x5eb15b(0x383),_0x59c5d7),_0x596f7c=_0x59c5d7[_0x5eb15b(0x410)][_0x5eb15b(0x410)];}catch(_0x1f6de5){console[_0x5eb15b(0x276)](_0x5eb15b(0x263),_0x1f6de5?.[_0x5eb15b(0x1b2)]?.[_0x5eb15b(0x410)]?.[_0x5eb15b(0x312)]),console['log'](_0xa7b1a7);const _0xec3ed1=_0x1f6de5?.[_0x5eb15b(0x1b2)]?.['status']||0x1f4,_0x1f2313=_0x1f6de5?.[_0x5eb15b(0x1b2)]?.['data']?.[_0x5eb15b(0x312)]?.[_0x5eb15b(0x31a)];if(_0xec3ed1===0x1ad)throw new common_1['HttpException'](_0x5eb15b(0x2cc),common_1['HttpStatus'][_0x5eb15b(0x217)]);if(_0xec3ed1===0x190||_0x1f2313[_0x5eb15b(0x1f3)](_0x5eb15b(0x304)))throw new common_1['HttpException'](_0x5eb15b(0x28c),common_1[_0x5eb15b(0x3d6)][_0x5eb15b(0x217)]);if(_0xec3ed1===0x1f4)throw new common_1['HttpException'](_0x5eb15b(0x3b7),common_1[_0x5eb15b(0x3d6)][_0x5eb15b(0x217)]);if(_0xec3ed1===0x191)throw new common_1[(_0x5eb15b(0x213))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x5eb15b(0x3d6)][_0x5eb15b(0x217)]);throw new common_1['HttpException'](_0x5eb15b(0x3a9),common_1['HttpStatus'][_0x5eb15b(0x217)]);}const _0x4935bf=[];for(const _0x68c451 of _0x596f7c){const _0x345cdd=_0x68c451['b64_json'][_0x5eb15b(0x218)](/^data:image\/\w+;base64,/,''),_0x41b5eb=uuid['v4']()[_0x5eb15b(0x320)](0x0,0xa)+_0x5eb15b(0x1f2),_0x49bef5=Buffer[_0x5eb15b(0x335)](_0x345cdd,_0x5eb15b(0x2d7));_0x4935bf[_0x5eb15b(0x357)](this[_0x5eb15b(0x3d8)][_0x5eb15b(0x1e2)]({'filename':_0x41b5eb,'buffer':_0x49bef5}));}const _0x2a4c85=(0x0,utils_1['getClientIp'])(_0x325df2),_0x5103c6=await Promise[_0x5eb15b(0x30e)](_0x4935bf),[_0x2cbd2b,_0x160db5]=_0xa7b1a7['size'][_0x5eb15b(0x2fa)]('x'),_0x12148a=_0x5103c6[_0x5eb15b(0x376)](_0x95652e=>{const _0x4a30d2=_0x5eb15b;return this[_0x4a30d2(0x1ef)]['saveChatLog']({'curIp':_0x2a4c85,'logType':0x3,'answer':_0x95652e,'totalTokens':0x0,'promptTokens':0x0,'model':_0xa7b1a7[_0x4a30d2(0x1bf)],'userId':_0x325df2['user']['id'],'prompt':_0xa7b1a7[_0x4a30d2(0x35f)],'completionTokens':0x0,'modelSubType':'1','modelType':model_constant_1['EModelType'][_0x4a30d2(0x3f0)],'type':balance_constant_1[_0x4a30d2(0x28f)]['PAINT_TYPE'],'fileInfo':JSON[_0x4a30d2(0x2d2)]({'width':_0x2cbd2b,'height':_0x160db5,'cosUrl':_0x95652e})});}),_0x1cda3e=await Promise['all'](_0x12148a);return await this['userService'][_0x5eb15b(0x2f1)](_0x325df2[_0x5eb15b(0x3bd)]['id'],_0x280cd3,_0x1cda3e[0x0]['id'],_0xa7b1a7['n']),_0x5103c6;}async[_0x2fe4bb(0x37b)](_0x20c4b1){const _0x1e3422=_0x2fe4bb,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x1e3422(0x34c)][_0x1e3422(0x2ca)]([_0x1e3422(0x221),_0x1e3422(0x3c4),_0x1e3422(0x32c),'openaiModel3MaxTokens16kRes','openaiModel4MaxTokens','openaiModel4MaxTokensRes',_0x1e3422(0x32b),_0x1e3422(0x228),'openaiBaseUrl']);let _0x3bd2e6=null,_0x8e1eb9=null,_0x35035b=null;const {model:_0x5997e0,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x5bc53b,key:_0x251a2d}=_0x20c4b1;return _0x5997e0[_0x1e3422(0x328)]()['includes'](_0x1e3422(0x24f))&&(_0x5997e0['toLowerCase']()[_0x1e3422(0x1f3)](_0x1e3422(0x266))?(_0x3bd2e6=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x8e1eb9=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x3bd2e6=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x8e1eb9=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x5997e0[_0x1e3422(0x328)]()['includes'](_0x1e3422(0x1f7))&&(_0x5997e0[_0x1e3422(0x328)]()['includes'](_0x1e3422(0x3e3))?(_0x3bd2e6=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x8e1eb9=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x3bd2e6=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x8e1eb9=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x35035b=_0x5bc53b||openaiBaseUrl||_0x1e3422(0x32e),_0x8e1eb9>=_0x3bd2e6&&(_0x8e1eb9=Math[_0x1e3422(0x1d2)](_0x3bd2e6/0x2),common_1['Logger'][_0x1e3422(0x347)]('key:\x20'+_0x251a2d+_0x1e3422(0x1be)+_0x8e1eb9)),{'key':_0x251a2d,'model':_0x5997e0,'maxToken':_0x3bd2e6,'maxTokenRes':_0x8e1eb9,'proxyUrl':_0x35035b};}async['asyncPPTProgress'](_0x41c12c){const _0x2be5f0=_0x2fe4bb;try{const _0xd16e4a=await this[_0x2be5f0(0x33b)][_0x2be5f0(0x295)](_0x41c12c),_0x4a2da2=await this[_0x2be5f0(0x261)][_0x2be5f0(0x1b3)]({'where':{'yooTaskId':_0x41c12c['params']['id']}});if(!_0x4a2da2)throw new Error('PPT\x20任务不存在！');_0x4a2da2[_0x2be5f0(0x2ff)]=_0xd16e4a[_0x2be5f0(0x410)][_0x2be5f0(0x2ff)],_0x4a2da2['stateDesc']=_0xd16e4a[_0x2be5f0(0x410)][_0x2be5f0(0x340)],_0x4a2da2[_0x2be5f0(0x2f3)]=_0xd16e4a[_0x2be5f0(0x410)][_0x2be5f0(0x2f3)],_0x4a2da2[_0x2be5f0(0x394)]=_0xd16e4a['data'][_0x2be5f0(0x326)],_0x4a2da2[_0x2be5f0(0x3be)]=_0xd16e4a['data'][_0x2be5f0(0x311)],_0x4a2da2[_0x2be5f0(0x208)]=_0xd16e4a['data'][_0x2be5f0(0x22d)],_0x4a2da2['images']=_0xd16e4a['data']['images_url'],_0x4a2da2[_0x2be5f0(0x286)]=_0xd16e4a[_0x2be5f0(0x410)][_0x2be5f0(0x2f5)],_0x4a2da2[_0x2be5f0(0x36c)]=_0xd16e4a['data'][_0x2be5f0(0x2ac)],_0x4a2da2['previewUrl']=_0xd16e4a['data'][_0x2be5f0(0x264)],await this[_0x2be5f0(0x261)][_0x2be5f0(0x3d2)](_0x4a2da2);}catch(_0x4ac2bb){common_1[_0x2be5f0(0x32f)][_0x2be5f0(0x312)](_0x4ac2bb[_0x2be5f0(0x31a)],'同步PPT生成任务进度失败！');}}async[_0x2fe4bb(0x1b6)](_0x29e847,_0x1ba852){const _0x39c91e=_0x2fe4bb;try{return this['connection'][_0x39c91e(0x248)](async()=>{const _0x472851=_0x39c91e,_0x200d23=await this[_0x472851(0x21d)][_0x472851(0x2ce)](model_constant_1[_0x472851(0x262)][_0x472851(0x2d4)]);let _0x40132f={'userId':_0x29e847[_0x472851(0x3bd)]['id'],'type':ppt_constant_1[_0x472851(0x271)][_0x472851(0x1d6)],'title':_0x1ba852[_0x472851(0x3cb)],'text':_0x1ba852[_0x472851(0x1ba)],'theme':_0x1ba852['theme']};_0x40132f=await this[_0x472851(0x261)][_0x472851(0x3d2)](_0x40132f),await this['userService']['debuctBalance4PPT'](_0x29e847[_0x472851(0x3bd)]['id'],_0x40132f['id'],_0x40132f['type']);const _0xccbddc=await this['pptService']['pptStructure']({'data':_0x1ba852,'baseURL':_0x200d23['modelInfo'][_0x472851(0x1aa)],'headers':{'Authorization':_0x472851(0x26a)+_0x200d23[_0x472851(0x291)]['accessToken']}});return _0x40132f[_0x472851(0x3cb)]=_0xccbddc[_0x472851(0x410)][_0x472851(0x3cb)],_0x40132f[_0x472851(0x3b1)]=_0xccbddc[_0x472851(0x410)][_0x472851(0x3b1)],await this[_0x472851(0x261)][_0x472851(0x3d2)](_0x40132f),_0x40132f;});}catch(_0x1fa2bb){throw new common_1[(_0x39c91e(0x213))](_0x1fa2bb[_0x39c91e(0x31a)],common_1[_0x39c91e(0x3d6)]['BAD_REQUEST']);}}async[_0x2fe4bb(0x1f1)](_0x1d5bbb,_0x37c981){const _0x27797b=_0x2fe4bb,_0x206bf3=await this[_0x27797b(0x261)]['findOne']({'where':{'id':_0x37c981}});if(!_0x206bf3)throw new common_1[(_0x27797b(0x213))](_0x27797b(0x3fa),common_1[_0x27797b(0x3d6)]['BAD_REQUEST']);await this['userService'][_0x27797b(0x294)](_0x1d5bbb[_0x27797b(0x3bd)]['id'],_0x206bf3['id'],ppt_constant_1[_0x27797b(0x271)]['EDITOR']);const _0x650fd8=await this[_0x27797b(0x21d)]['getModelByType'](model_constant_1['EModelType'][_0x27797b(0x2d4)]),_0x450be8=await this[_0x27797b(0x33b)][_0x27797b(0x3f7)]({'baseURL':_0x650fd8[_0x27797b(0x291)][_0x27797b(0x1aa)],'headers':{'Authorization':_0x27797b(0x27b)+_0x650fd8[_0x27797b(0x291)][_0x27797b(0x33d)]},'data':{'id':_0x206bf3['yooTaskId'],'expire':0x83d600}});return _0x450be8[_0x27797b(0x2de)]==_0x27797b(0x2dd)&&_0x450be8[_0x27797b(0x410)][_0x27797b(0x3af)]&&(_0x206bf3['editorUrl']=_0x450be8[_0x27797b(0x410)][_0x27797b(0x3af)],await this['pptTaskEntity'][_0x27797b(0x298)]({'id':_0x206bf3['id']},{'editorUrl':_0x206bf3[_0x27797b(0x300)]})),_0x206bf3;}async[_0x2fe4bb(0x23f)](_0x26a847,_0x3c163b){const _0x595f81=_0x2fe4bb,_0x61e851=await this[_0x595f81(0x261)][_0x595f81(0x1b3)]({'where':{'id':_0x3c163b}});if(!_0x61e851)throw new common_1['HttpException'](_0x595f81(0x3fa),common_1['HttpStatus'][_0x595f81(0x217)]);await this[_0x595f81(0x393)][_0x595f81(0x294)](_0x26a847[_0x595f81(0x3bd)]['id'],_0x61e851['id'],ppt_constant_1[_0x595f81(0x271)][_0x595f81(0x3e2)]);const _0x4b94a9=await this['modelsService']['getModelByType'](model_constant_1[_0x595f81(0x262)][_0x595f81(0x2d4)]),_0x2893b5=await this[_0x595f81(0x33b)]['pptDownload']({'baseURL':_0x4b94a9[_0x595f81(0x291)][_0x595f81(0x1aa)],'headers':{'Authorization':_0x595f81(0x27b)+_0x4b94a9['modelInfo']['accessToken']},'params':{'id':_0x61e851[_0x595f81(0x1dc)],'type':_0x595f81(0x3e5)}});return _0x2893b5[_0x595f81(0x2de)]=='200'&&_0x2893b5['data'][_0x595f81(0x348)]&&(_0x61e851[_0x595f81(0x208)]=_0x2893b5[_0x595f81(0x410)][_0x595f81(0x348)],await this[_0x595f81(0x261)]['update']({'id':_0x61e851['id']},{'downUrl':_0x61e851['downUrl']})),_0x61e851;}[_0x2fe4bb(0x2cb)](_0x37918c,_0x43ca57){const _0x3d60c2=_0x2fe4bb;try{return this['connection'][_0x3d60c2(0x248)](async()=>{const _0x323621=_0x3d60c2,_0x5c11aa=await this[_0x323621(0x21d)]['getModelByType'](model_constant_1[_0x323621(0x262)][_0x323621(0x2d4)]);let _0x45473d={'userId':_0x37918c[_0x323621(0x3bd)]['id'],'type':ppt_constant_1[_0x323621(0x271)][_0x323621(0x21e)],'title':_0x43ca57[_0x323621(0x3cb)],'text':_0x43ca57[_0x323621(0x1ba)],'author':_0x43ca57['author'],'color':_0x43ca57[_0x323621(0x36a)],'style':_0x43ca57[_0x323621(0x353)]};_0x45473d=await this[_0x323621(0x261)]['save'](_0x45473d),await this[_0x323621(0x393)]['debuctBalance4PPT'](_0x37918c[_0x323621(0x3bd)]['id'],_0x45473d['id'],_0x45473d[_0x323621(0x1bc)]);const _0x543b8f=await this[_0x323621(0x33b)][_0x323621(0x2cb)]({'data':{'title':_0x43ca57[_0x323621(0x3cb)],'count':_0x43ca57[_0x323621(0x1ba)],'user_name':_0x43ca57[_0x323621(0x2a1)],'color':_0x43ca57[_0x323621(0x36a)],'style':_0x43ca57[_0x323621(0x353)]},'baseURL':_0x5c11aa[_0x323621(0x291)]['proxyUrl'],'headers':{'Authorization':_0x323621(0x27b)+_0x5c11aa[_0x323621(0x291)][_0x323621(0x33d)]}});return _0x45473d[_0x323621(0x34d)]=_0x543b8f['data'],await this[_0x323621(0x261)][_0x323621(0x3d2)](_0x45473d),_0x45473d;});}catch(_0x2022ba){throw new common_1[(_0x3d60c2(0x213))](_0x2022ba[_0x3d60c2(0x31a)],common_1[_0x3d60c2(0x3d6)][_0x3d60c2(0x217)]);}}[_0x2fe4bb(0x2a2)](_0x25cd53,_0x19c43d){const _0x55aeb4=_0x2fe4bb;try{return this[_0x55aeb4(0x358)][_0x55aeb4(0x248)](async()=>{const _0xd23f4f=_0x55aeb4,_0x529000=await this[_0xd23f4f(0x21d)]['getModelByType'](model_constant_1[_0xd23f4f(0x262)][_0xd23f4f(0x2d4)]);let _0x509854={'userId':_0x25cd53['user']['id'],'type':ppt_constant_1[_0xd23f4f(0x271)][_0xd23f4f(0x1e3)],'title':_0x19c43d[_0xd23f4f(0x3cb)],'text':_0x19c43d['text'],'author':_0x19c43d[_0xd23f4f(0x2a1)],'coverId':_0x19c43d[_0xd23f4f(0x395)]};_0x509854=await this[_0xd23f4f(0x261)][_0xd23f4f(0x3d2)](_0x509854),await this[_0xd23f4f(0x393)][_0xd23f4f(0x294)](_0x25cd53[_0xd23f4f(0x3bd)]['id'],_0x509854['id'],_0x509854[_0xd23f4f(0x1bc)]);const _0x5bb997=await this[_0xd23f4f(0x33b)]['pptReCover']({'data':{'title':_0x19c43d['title'],'count':_0x19c43d[_0xd23f4f(0x1ba)],'user_name':_0x19c43d['author'],'cover_id':_0x19c43d['coverId']},'baseURL':_0x529000['modelInfo']['proxyUrl'],'headers':{'Authorization':_0xd23f4f(0x27b)+_0x529000[_0xd23f4f(0x291)]['accessToken']}});return _0x509854[_0xd23f4f(0x34d)]=_0x5bb997['data'],await this[_0xd23f4f(0x261)][_0xd23f4f(0x3d2)](_0x509854),_0x509854;});}catch(_0x136909){throw new common_1[(_0x55aeb4(0x213))](_0x136909[_0x55aeb4(0x31a)],common_1[_0x55aeb4(0x3d6)]['BAD_REQUEST']);}}async[_0x2fe4bb(0x40f)](_0x83760e){const _0x19107b=_0x2fe4bb;try{const _0x3952f9=['pptOutlinePrice',_0x19107b(0x1cb),_0x19107b(0x1e5),_0x19107b(0x38a),_0x19107b(0x1e0),_0x19107b(0x2f0)],_0x5aabef=await this[_0x19107b(0x34c)][_0x19107b(0x2ca)](_0x3952f9);if(!_0x83760e[_0x19107b(0x3bd)]||!_0x83760e[_0x19107b(0x3bd)]['id'])throw new Error('Invalid\x20user\x20information');const _0x4c684c=['pptOutline',_0x19107b(0x31b),_0x19107b(0x3f7)],_0x425bf2=await Promise['all'](_0x4c684c[_0x19107b(0x376)](async _0x19eca6=>{const _0x534c82=_0x19107b,_0x547d8f=_0x5aabef[_0x19eca6+_0x534c82(0x3bf)],_0x2011c7=_0x5aabef[_0x19eca6+_0x534c82(0x2cd)],_0x462ed7=redisKey_constant_1['VIP_FREE']+'-'+_0x83760e[_0x534c82(0x3bd)]['id']+'-'+(_0x19eca6+_0x534c82(0x3bf)),_0x2b38ba=await this['userService'][_0x534c82(0x38d)](_0x83760e['user']['id'],_0x462ed7,_0x547d8f);return{'type':_0x19eca6,'remainCount':_0x2b38ba,'freeCount':Number(_0x547d8f),'useIntegrate':Number(_0x2011c7)};}));return _0x425bf2;}catch(_0x123488){console[_0x19107b(0x312)](_0x19107b(0x365),_0x123488);throw _0x123488;}}[_0x2fe4bb(0x31b)](_0x4017d8,_0x2236f8){const _0x1d75a=_0x2fe4bb;try{return this['connection'][_0x1d75a(0x248)](async()=>{const _0x41fbc1=_0x1d75a;let _0x2408b5;const _0x23c7be=await this[_0x41fbc1(0x21d)][_0x41fbc1(0x2ce)](model_constant_1[_0x41fbc1(0x262)][_0x41fbc1(0x2d4)]);if(_0x2236f8[_0x41fbc1(0x2da)]){_0x2408b5=await this[_0x41fbc1(0x261)][_0x41fbc1(0x1b3)]({'where':{'id':_0x2236f8[_0x41fbc1(0x2da)]}});if(!_0x2408b5)throw new Error(_0x41fbc1(0x2dc));}let _0x51e3ab={'userId':_0x4017d8[_0x41fbc1(0x3bd)]['id'],'type':ppt_constant_1[_0x41fbc1(0x271)][_0x41fbc1(0x1d8)],'title':_0x2236f8[_0x41fbc1(0x3cb)],'subTitle':_0x2236f8['subTitle'],'text':_0x2236f8['text'],'catalogs':_0x2236f8[_0x41fbc1(0x3b1)],'contents':_0x2236f8[_0x41fbc1(0x1f6)],'author':_0x2236f8[_0x41fbc1(0x2a1)],'fontName':_0x2236f8[_0x41fbc1(0x274)],'transition':_0x2236f8[_0x41fbc1(0x21c)],'complex':_0x2236f8[_0x41fbc1(0x259)],'coverId':_0x2236f8[_0x41fbc1(0x395)],'originId':_0x2236f8['originTaskId']};_0x51e3ab=await this['pptTaskEntity'][_0x41fbc1(0x3d2)](_0x51e3ab),await this['userService'][_0x41fbc1(0x294)](_0x4017d8['user']['id'],_0x51e3ab['id'],_0x51e3ab['type']);try{const _0x3a34a8=await this[_0x41fbc1(0x33b)][_0x41fbc1(0x31b)]({'data':{'text':_0x2236f8[_0x41fbc1(0x1ba)],'custom_data':{'title':_0x2236f8[_0x41fbc1(0x3cb)],'sub_title':_0x2236f8[_0x41fbc1(0x309)],'author':_0x2236f8[_0x41fbc1(0x2a1)],'catalogs':_0x2236f8[_0x41fbc1(0x3b1)],'contents':_0x2236f8[_0x41fbc1(0x1f6)]},'cover_id':_0x2236f8[_0x41fbc1(0x395)],'font_name':_0x2236f8[_0x41fbc1(0x274)],'transition':_0x2236f8[_0x41fbc1(0x21c)],'complex':_0x2236f8[_0x41fbc1(0x259)],'user_name':_0x2236f8[_0x41fbc1(0x2a1)],'id':_0x2408b5?.[_0x41fbc1(0x1dc)]},'baseURL':_0x23c7be['modelInfo'][_0x41fbc1(0x1aa)],'headers':{'Authorization':_0x41fbc1(0x27b)+_0x23c7be['modelInfo'][_0x41fbc1(0x33d)]}});return _0x51e3ab[_0x41fbc1(0x1dc)]=_0x3a34a8[_0x41fbc1(0x410)]['id'],await this[_0x41fbc1(0x261)][_0x41fbc1(0x3d2)](_0x51e3ab),_0x51e3ab;}catch(_0x2875fa){await this[_0x41fbc1(0x393)][_0x41fbc1(0x294)](_0x4017d8[_0x41fbc1(0x3bd)]['id'],_0x51e3ab['id'],_0x51e3ab[_0x41fbc1(0x1bc)],!![]);throw new common_1[(_0x41fbc1(0x213))](_0x2875fa[_0x41fbc1(0x31a)],common_1[_0x41fbc1(0x3d6)]['BAD_REQUEST']);}});}catch(_0x7fbaa7){throw new common_1[(_0x1d75a(0x213))](_0x7fbaa7[_0x1d75a(0x31a)],common_1[_0x1d75a(0x3d6)][_0x1d75a(0x217)]);}}[_0x2fe4bb(0x3cc)](_0x9a2cc6,_0x3567f3){const _0xb8163f=_0x2fe4bb;try{return this['connection'][_0xb8163f(0x248)](async()=>{const _0xe82d1f=_0xb8163f,_0x2a1a3a=await this[_0xe82d1f(0x21d)]['getModelByType'](model_constant_1[_0xe82d1f(0x262)][_0xe82d1f(0x2d4)]);let _0x58ef99={'userId':_0x9a2cc6[_0xe82d1f(0x3bd)]['id'],'type':ppt_constant_1[_0xe82d1f(0x271)][_0xe82d1f(0x1ff)],'title':_0x3567f3['title'],'color':_0x3567f3[_0xe82d1f(0x36a)],'style':_0x3567f3['style'],'fileUrl':_0x3567f3[_0xe82d1f(0x307)],'pleader':_0x3567f3[_0xe82d1f(0x25e)],'advisor':_0x3567f3[_0xe82d1f(0x222)],'school':_0x3567f3[_0xe82d1f(0x2c2)],'schoolLogo':_0x3567f3[_0xe82d1f(0x332)],'schoolPicture':_0x3567f3['schoolPicture']};_0x58ef99=await this[_0xe82d1f(0x261)][_0xe82d1f(0x3d2)](_0x58ef99),await this['userService'][_0xe82d1f(0x294)](_0x9a2cc6[_0xe82d1f(0x3bd)]['id'],_0x58ef99['id'],_0x58ef99[_0xe82d1f(0x1bc)]);const _0xd339d8=await this[_0xe82d1f(0x33b)][_0xe82d1f(0x3cc)]({'data':{'file_key':_0x3567f3['fileUrl'],'title':_0x3567f3['title'],'color':_0x3567f3[_0xe82d1f(0x36a)],'style':_0x3567f3[_0xe82d1f(0x353)],'pleader':_0x3567f3[_0xe82d1f(0x25e)],'advisor':_0x3567f3[_0xe82d1f(0x222)],'school':_0x3567f3[_0xe82d1f(0x2c2)],'school_logo':_0x3567f3[_0xe82d1f(0x332)],'school_picture':_0x3567f3[_0xe82d1f(0x24b)]},'baseURL':_0x2a1a3a[_0xe82d1f(0x291)]['proxyUrl'],'headers':{'Authorization':_0xe82d1f(0x27b)+_0x2a1a3a['modelInfo']['accessToken']}});return _0x58ef99[_0xe82d1f(0x1dc)]=_0xd339d8[_0xe82d1f(0x410)]['id'],await this[_0xe82d1f(0x261)][_0xe82d1f(0x3d2)](_0x58ef99),setTimeout(()=>this[_0xe82d1f(0x203)]({'baseURL':_0x2a1a3a[_0xe82d1f(0x291)]['proxyUrl'],'headers':{'Authorization':_0xe82d1f(0x27b)+_0x2a1a3a[_0xe82d1f(0x291)][_0xe82d1f(0x33d)]},'params':{'id':_0x58ef99['yooTaskId']}}),0xbb8),_0x58ef99;});}catch(_0x271153){throw new common_1['HttpException'](_0x271153[_0xb8163f(0x31a)],common_1['HttpStatus'][_0xb8163f(0x217)]);}}[_0x2fe4bb(0x366)](_0x11acf6,_0x3b8917){const _0x5e1d2a=_0x2fe4bb;try{return this[_0x5e1d2a(0x358)][_0x5e1d2a(0x248)](async()=>{const _0x48cd98=_0x5e1d2a,_0x1e815d=await this[_0x48cd98(0x21d)][_0x48cd98(0x2ce)](model_constant_1[_0x48cd98(0x262)][_0x48cd98(0x2d4)]);let _0x35e7ed={'userId':_0x11acf6[_0x48cd98(0x3bd)]['id'],'type':ppt_constant_1[_0x48cd98(0x271)][_0x48cd98(0x1ea)],'fileUrl':_0x3b8917[_0x48cd98(0x307)],'coverId':_0x3b8917[_0x48cd98(0x395)],'author':_0x3b8917['author']};_0x35e7ed=await this['pptTaskEntity']['save'](_0x35e7ed),await this[_0x48cd98(0x393)][_0x48cd98(0x294)](_0x11acf6['user']['id'],_0x35e7ed['id'],_0x35e7ed[_0x48cd98(0x1bc)]);const _0x183b1a=await this[_0x48cd98(0x33b)][_0x48cd98(0x366)]({'data':{'file_url':_0x3b8917[_0x48cd98(0x307)],'cover_id':_0x3b8917[_0x48cd98(0x395)],'user_name':_0x3b8917[_0x48cd98(0x2a1)]},'baseURL':_0x1e815d[_0x48cd98(0x291)][_0x48cd98(0x1aa)],'headers':{'Authorization':'Beare\x20'+_0x1e815d['modelInfo'][_0x48cd98(0x33d)]}});return _0x35e7ed['yooTaskId']=_0x183b1a[_0x48cd98(0x410)]['id'],await this['pptTaskEntity'][_0x48cd98(0x3d2)](_0x35e7ed),setTimeout(()=>this[_0x48cd98(0x203)]({'baseURL':_0x1e815d['modelInfo'][_0x48cd98(0x1aa)],'headers':{'Authorization':_0x48cd98(0x27b)+_0x1e815d[_0x48cd98(0x291)][_0x48cd98(0x33d)]},'params':{'id':_0x35e7ed[_0x48cd98(0x1dc)]}}),0xbb8),_0x35e7ed;});}catch(_0x21f958){throw new common_1[(_0x5e1d2a(0x213))](_0x21f958[_0x5e1d2a(0x31a)],common_1[_0x5e1d2a(0x3d6)][_0x5e1d2a(0x217)]);}}[_0x2fe4bb(0x391)](_0x485de0){const _0x4eecce=_0x2fe4bb;return this[_0x4eecce(0x261)]['findOne']({'where':{'id':_0x485de0}});}['pptChangeTheme'](_0x335769,_0x2f18e6){const _0x3d7ac1=_0x2fe4bb;try{return this[_0x3d7ac1(0x358)][_0x3d7ac1(0x248)](async()=>{const _0x4a36be=_0x3d7ac1,_0x3069d0=await this['pptTaskEntity'][_0x4a36be(0x1b3)]({'where':{'id':_0x2f18e6[_0x4a36be(0x2da)]}});if(!_0x3069d0)throw new Error(_0x4a36be(0x2dc));const _0x2acb3e=await this[_0x4a36be(0x21d)][_0x4a36be(0x2ce)](model_constant_1['EModelType'][_0x4a36be(0x2d4)]);let _0x188e6d={'userId':_0x335769[_0x4a36be(0x3bd)]['id'],'type':ppt_constant_1['EPPTTaskType']['THEME'],'originId':_0x2f18e6[_0x4a36be(0x2da)],'coverId':_0x2f18e6[_0x4a36be(0x395)],'fontName':_0x2f18e6[_0x4a36be(0x274)],'transition':_0x2f18e6[_0x4a36be(0x21c)]};_0x188e6d=await this[_0x4a36be(0x261)][_0x4a36be(0x3d2)](_0x188e6d),await this[_0x4a36be(0x393)][_0x4a36be(0x294)](_0x335769[_0x4a36be(0x3bd)]['id'],_0x188e6d['id'],_0x188e6d[_0x4a36be(0x1bc)]);const _0x188cba=await this[_0x4a36be(0x33b)][_0x4a36be(0x405)]({'data':{'id':_0x3069d0[_0x4a36be(0x1dc)],'cover_id':_0x2f18e6[_0x4a36be(0x395)],'font_name':_0x2f18e6[_0x4a36be(0x274)],'transition':_0x2f18e6[_0x4a36be(0x21c)]},'baseURL':_0x2acb3e['modelInfo'][_0x4a36be(0x1aa)],'headers':{'Authorization':'Beare\x20'+_0x2acb3e[_0x4a36be(0x291)][_0x4a36be(0x33d)]}});return _0x188e6d['yooTaskId']=_0x188cba[_0x4a36be(0x410)]['id'],await this[_0x4a36be(0x261)][_0x4a36be(0x3d2)](_0x188e6d),setTimeout(()=>this[_0x4a36be(0x203)]({'baseURL':_0x2acb3e['modelInfo'][_0x4a36be(0x1aa)],'headers':{'Authorization':'Beare\x20'+_0x2acb3e['modelInfo'][_0x4a36be(0x33d)]},'params':{'id':_0x188e6d['yooTaskId']}}),0xbb8),_0x188e6d;});}catch(_0x10bc87){throw new common_1[(_0x3d7ac1(0x213))](_0x10bc87[_0x3d7ac1(0x31a)],common_1[_0x3d7ac1(0x3d6)][_0x3d7ac1(0x217)]);}}[_0x2fe4bb(0x38c)](_0xaf3ba0,_0x2db078){const _0x42865f=_0x2fe4bb;try{return this[_0x42865f(0x358)][_0x42865f(0x248)](async()=>{const _0x1a9b28=_0x42865f,_0x46b7cc=await this[_0x1a9b28(0x261)][_0x1a9b28(0x1b3)]({'where':{'id':_0x2db078[_0x1a9b28(0x2da)]}});if(!_0x46b7cc)throw new Error(_0x1a9b28(0x2dc));const _0x50fced=await this[_0x1a9b28(0x21d)][_0x1a9b28(0x2ce)](model_constant_1['EModelType'][_0x1a9b28(0x2d4)]);let _0x4872c8={'userId':_0xaf3ba0['user']['id'],'type':ppt_constant_1['EPPTTaskType'][_0x1a9b28(0x351)],'originId':_0x2db078[_0x1a9b28(0x2da)],'theme':_0x2db078[_0x1a9b28(0x1da)],'text':_0x2db078['text'],'complex':_0x2db078[_0x1a9b28(0x259)]?String(_0x2db078['complex']):'1','author':_0x2db078[_0x1a9b28(0x2a1)],'fontName':_0x2db078[_0x1a9b28(0x274)],'transition':_0x2db078['transition'],'slideNumber':_0x2db078[_0x1a9b28(0x3ac)],'slideType':_0x2db078['slideType']};_0x4872c8=await this['pptTaskEntity'][_0x1a9b28(0x3d2)](_0x4872c8),await this['userService'][_0x1a9b28(0x294)](_0xaf3ba0[_0x1a9b28(0x3bd)]['id'],_0x4872c8['id'],_0x4872c8[_0x1a9b28(0x1bc)]);const _0x1fb215=await this[_0x1a9b28(0x33b)]['pptAddPage']({'data':{'id':_0x46b7cc[_0x1a9b28(0x1dc)],'text':_0x2db078['text'],'complex':_0x2db078['complex'],'user_name':_0x2db078[_0x1a9b28(0x2a1)],'font_name':_0x2db078[_0x1a9b28(0x274)],'transition':_0x2db078[_0x1a9b28(0x21c)],'slide_number':_0x2db078[_0x1a9b28(0x3ac)],'slide_type':_0x2db078[_0x1a9b28(0x329)],'theme':_0x2db078['theme']},'baseURL':_0x50fced[_0x1a9b28(0x291)][_0x1a9b28(0x1aa)],'headers':{'Authorization':_0x1a9b28(0x27b)+_0x50fced[_0x1a9b28(0x291)][_0x1a9b28(0x33d)]}});return _0x4872c8[_0x1a9b28(0x1dc)]=_0x1fb215[_0x1a9b28(0x410)]['id'],await this[_0x1a9b28(0x261)][_0x1a9b28(0x3d2)](_0x4872c8),setTimeout(()=>this[_0x1a9b28(0x203)]({'baseURL':_0x50fced[_0x1a9b28(0x291)]['proxyUrl'],'headers':{'Authorization':_0x1a9b28(0x27b)+_0x50fced['modelInfo'][_0x1a9b28(0x33d)]},'params':{'id':_0x4872c8[_0x1a9b28(0x1dc)]}}),0xbb8),_0x4872c8;});}catch(_0x117a08){throw new common_1[(_0x42865f(0x213))](_0x117a08[_0x42865f(0x31a)],common_1['HttpStatus'][_0x42865f(0x217)]);}}[_0x2fe4bb(0x29f)](_0x1f7ffa,_0x4da911){const _0x574680=_0x2fe4bb;try{return this[_0x574680(0x358)][_0x574680(0x248)](async()=>{const _0x5558c5=_0x574680,_0x44660e=await this[_0x5558c5(0x261)][_0x5558c5(0x1b3)]({'where':{'id':_0x4da911[_0x5558c5(0x2da)]}});if(!_0x44660e)throw new Error('原始任务不存在！');const _0x4902a2=await this[_0x5558c5(0x21d)][_0x5558c5(0x2ce)](model_constant_1[_0x5558c5(0x262)]['PPT']);let _0x2de545={'userId':_0x1f7ffa['user']['id'],'type':ppt_constant_1[_0x5558c5(0x271)][_0x5558c5(0x37f)],'originId':_0x4da911[_0x5558c5(0x2da)],'notes':_0x4da911};_0x2de545=await this[_0x5558c5(0x261)]['save'](_0x2de545),await this[_0x5558c5(0x393)][_0x5558c5(0x294)](_0x1f7ffa[_0x5558c5(0x3bd)]['id'],_0x2de545['id'],_0x2de545[_0x5558c5(0x1bc)]);const _0x580d13=await this[_0x5558c5(0x33b)][_0x5558c5(0x3e6)]({'data':{..._0x4da911,'id':_0x44660e[_0x5558c5(0x1dc)]},'baseURL':_0x4902a2[_0x5558c5(0x291)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x4902a2[_0x5558c5(0x291)][_0x5558c5(0x33d)]}});return _0x2de545[_0x5558c5(0x1dc)]=_0x580d13[_0x5558c5(0x410)]['id'],await this[_0x5558c5(0x261)][_0x5558c5(0x3d2)](_0x2de545),setTimeout(()=>this[_0x5558c5(0x203)]({'baseURL':_0x4902a2[_0x5558c5(0x291)][_0x5558c5(0x1aa)],'headers':{'Authorization':_0x5558c5(0x27b)+_0x4902a2[_0x5558c5(0x291)]['accessToken']},'params':{'id':_0x2de545[_0x5558c5(0x1dc)]}}),0xbb8),_0x2de545;});}catch(_0x3808da){throw new common_1[(_0x574680(0x213))](_0x3808da[_0x574680(0x31a)],common_1[_0x574680(0x3d6)]['BAD_REQUEST']);}}async[_0x2fe4bb(0x1b1)](_0x2bf297,_0x2d179f){const _0x42c11b=_0x2fe4bb,{page:page=0x1,size:size=0x14,keyword:_0x50e967}=_0x2bf297,_0x5a339d=[{'delFlag':0x0,'publishFlag':0x1,'type':(0x0,typeorm_1['In'])([ppt_constant_1['EPPTTaskType'][_0x42c11b(0x1d8)],ppt_constant_1['EPPTTaskType']['FILE']])}];_0x50e967&&_0x5a339d[_0x42c11b(0x357)]({'title':(0x0,typeorm_1[_0x42c11b(0x232)])('%'+_0x50e967+'%'),'delFlag':0x0},{'subTitle':(0x0,typeorm_1[_0x42c11b(0x232)])('%'+_0x50e967+'%'),'delFlag':0x0});const [_0x6c9329,_0x4ca455]=await this['pptTaskEntity'][_0x42c11b(0x3a2)]({'where':_0x5a339d,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':'DESC'}}),_0x497308=await this[_0x42c11b(0x393)][_0x42c11b(0x3d3)](_0x6c9329,_0x2d179f);return{'rows':_0x497308,'count':_0x4ca455};}async['pptPage'](_0x264756,_0x51eafd){const _0x315ca7=_0x2fe4bb,_0x79f42b=_0x51eafd[_0x315ca7(0x3bd)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x4c4cbd}=_0x264756,_0x543719=_0x315ca7(0x344)+(_0x4c4cbd?_0x315ca7(0x1af)+_0x4c4cbd+_0x315ca7(0x404)+_0x4c4cbd+_0x315ca7(0x3b3):'')+'\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x79f42b?'\x20AND\x20p.user_id\x20=\x20'+_0x79f42b:'')+_0x315ca7(0x23b),_0x125cef=await this['connection']['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x543719+_0x315ca7(0x23b)),_0x2d51bd=await this[_0x315ca7(0x358)][_0x315ca7(0x359)](_0x315ca7(0x3ea)+_0x543719+_0x315ca7(0x243)+size+_0x315ca7(0x219)+(page-0x1)*size+_0x315ca7(0x23b));!(0x0,utils_1[_0x315ca7(0x27a)])(this[_0x315ca7(0x205)])&&_0x2d51bd[_0x315ca7(0x3c8)](_0x45e89d=>{const _0x336a3b=_0x315ca7;_0x45e89d[_0x336a3b(0x242)]=(0x0,utils_1[_0x336a3b(0x39b)])(_0x45e89d[_0x336a3b(0x242)]),_0x45e89d['phone']=(0x0,utils_1['maskEmail'])(_0x45e89d[_0x336a3b(0x267)]);});const _0x484054=await this[_0x315ca7(0x393)][_0x315ca7(0x3d3)](_0x2d51bd,_0x51eafd);return{'rows':_0x484054,'count':Number(_0x125cef[0x0]?.[_0x315ca7(0x2ef)]||0x0)};}async[_0x2fe4bb(0x35d)](_0x309d06,_0x2b2034=0x1,_0x18bffd=0xa){const _0x585e40=_0x2fe4bb,{rows:_0x2b8cfd,count:_0x31d4a8}=await this[_0x585e40(0x393)][_0x585e40(0x2f9)](_0x2b2034,_0x18bffd,_0x309d06[_0x585e40(0x3bd)]['id'],collectType_constant_1[_0x585e40(0x3bb)]['PPT']),_0x2b67e3=await this[_0x585e40(0x261)][_0x585e40(0x1c4)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2b8cfd[_0x585e40(0x376)](_0x4e302a=>_0x4e302a[_0x585e40(0x1b0)]))}});return{'rows':_0x2b67e3,'count':_0x31d4a8};}async[_0x2fe4bb(0x2a4)](_0xf47c,_0x3ed2b6){const _0x4a631e=_0x2fe4bb;if(!_0xf47c[_0x4a631e(0x31e)]||!_0xf47c[_0x4a631e(0x31e)]['length'])return!![];const _0x4001ce={'id':(0x0,typeorm_1['In'])(_0xf47c[_0x4a631e(0x31e)])};return _0x3ed2b6&&(_0x4001ce[_0x4a631e(0x283)]=_0x3ed2b6),await this[_0x4a631e(0x261)]['update'](_0x4001ce,{'delFlag':0x1}),await this['userService'][_0x4a631e(0x28a)](_0xf47c[_0x4a631e(0x31e)],collectType_constant_1[_0x4a631e(0x3bb)]['PPT']),!![];}async[_0x2fe4bb(0x407)](_0x22b827,_0x5df564){const _0x265f83=_0x2fe4bb;try{let _0x3e9e55='';return await this[_0x265f83(0x358)]['transaction'](async()=>{const _0x10aa93=_0x265f83,_0x2e8231=(0x0,utils_1[_0x10aa93(0x2a8)])(this[_0x10aa93(0x205)]),{modelInfo:_0x10c219}=await this[_0x10aa93(0x21d)][_0x10aa93(0x2ce)](model_constant_1[_0x10aa93(0x262)][_0x10aa93(0x3e4)],_0x10aa93(0x2f8));await this[_0x10aa93(0x371)]({'prompt':_0x5df564[_0x10aa93(0x3a3)][_0x10aa93(0x1ba)],'user':_0x22b827[_0x10aa93(0x3bd)],'currentRequestModel':_0x10c219});const _0x179a4f={'curIp':(0x0,utils_1[_0x10aa93(0x3e0)])(_0x22b827),'prompt':_0x5df564[_0x10aa93(0x3a3)]['text'],'modelId':_0x10c219['id'],'modelType':_0x10c219['modelType'],'answer':'','model':_0x10c219['model'],'role':'user','userId':_0x22b827[_0x10aa93(0x3bd)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1['DeductionKey'][_0x10aa93(0x327)],'logType':0x1,'requestOptions':JSON[_0x10aa93(0x2d2)](_0x5df564),'saasId':_0x2e8231},_0x3c41e2={..._0x179a4f,'role':_0x10aa93(0x260),'requestOptions':JSON[_0x10aa93(0x2d2)]({'prompt':_0x5df564[_0x10aa93(0x3a3)][_0x10aa93(0x1ba)],'options':{'model':_0x10c219[_0x10aa93(0x1bf)]}})};await this[_0x10aa93(0x1ef)][_0x10aa93(0x2f4)](_0x179a4f),await this[_0x10aa93(0x1ef)][_0x10aa93(0x2f4)](_0x3c41e2),await this[_0x10aa93(0x393)][_0x10aa93(0x30a)](_0x22b827[_0x10aa93(0x3bd)]['id'],_0x10c219,_0x3c41e2['id']);const _0x595e45={'app':{'appid':_0x10c219[_0x10aa93(0x296)],'token':_0x10c219['appid'],'cluster':_0x10aa93(0x2c9)},'user':{'uid':String(_0x22b827[_0x10aa93(0x3bd)]['id'])},'audio':{'voice_type':'BV700_streaming','encoding':_0x10aa93(0x1b7)},'request':{'reqid':(0x0,crypto_1[_0x10aa93(0x1e7)])(),'text':_0x5df564[_0x10aa93(0x3a3)][_0x10aa93(0x1ba)],'operation':_0x10aa93(0x359)}},_0x826504=await this['doubaoService'][_0x10aa93(0x407)]({'data':_0x595e45,'headers':{'Authorization':'Bearer;'+_0x10c219[_0x10aa93(0x33d)]}}),_0x177aa4=chat_constant_1[_0x10aa93(0x377)]['TTS']+'-'+_0x2e8231+'-'+_0x22b827[_0x10aa93(0x3bd)]['id']+'-'+new Date()[_0x10aa93(0x36d)]()+'.mp3';let _0x13fc2c=(0x0,path_1[_0x10aa93(0x3c1)])(process[_0x10aa93(0x2df)](),_0x10aa93(0x1cc),_0x10aa93(0x21f)),_0x13525d=_0x10aa93(0x3d5);_0x13525d=_0x13525d+'/'+_0x177aa4;!(0x0,fs_1[_0x10aa93(0x216)])(_0x13fc2c)&&(0x0,fs_1[_0x10aa93(0x2e8)])(_0x13fc2c,{'recursive':!![]});_0x13fc2c=(0x0,path_1[_0x10aa93(0x3c1)])(_0x13fc2c,_0x177aa4),(0x0,fs_1[_0x10aa93(0x33a)])(_0x13fc2c,_0x826504[_0x10aa93(0x410)],_0x10aa93(0x2d7));let _0x168892=process[_0x10aa93(0x409)][_0x10aa93(0x373)];_0x168892[_0x10aa93(0x2e9)](_0x10aa93(0x1b9))?_0x3e9e55=_0x168892+_0x13525d:_0x3e9e55=_0x10aa93(0x397)+_0x168892+_0x13525d,_0x3c41e2[_0x10aa93(0x401)]=_0x3e9e55,await this[_0x10aa93(0x1ef)][_0x10aa93(0x2f4)](_0x3c41e2);}),_0x3e9e55;}catch(_0x33212d){throw new common_1[(_0x265f83(0x213))](_0x33212d[_0x265f83(0x31a)],common_1['HttpStatus'][_0x265f83(0x217)]);}}async['asr'](_0x5d7557,_0x3b38ac,_0x2d51ed){const _0x2e74e7=_0x2fe4bb;try{let _0x173596,_0x571dda;return await this[_0x2e74e7(0x358)][_0x2e74e7(0x248)](async()=>{const _0x5c0485=_0x2e74e7,_0x51026b=(0x0,utils_1['getReqSaasId'])(this['clsService']),{modelInfo:_0x61b6a6}=await this[_0x5c0485(0x21d)][_0x5c0485(0x2ce)](model_constant_1[_0x5c0485(0x262)][_0x5c0485(0x2ee)],_0x5c0485(0x29e));await this[_0x5c0485(0x393)]['validateBalance4Chat'](_0x5d7557[_0x5c0485(0x3bd)]['id'],_0x61b6a6);const _0xab9186={'groupId':_0x2d51ed,'curIp':(0x0,utils_1[_0x5c0485(0x3e0)])(_0x5d7557),'prompt':_0x3b38ac,'modelId':_0x61b6a6['id'],'modelType':_0x61b6a6[_0x5c0485(0x29c)],'answer':'','model':_0x61b6a6[_0x5c0485(0x1bf)],'role':_0x5c0485(0x3bd),'userId':_0x5d7557['user']['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x5c0485(0x28f)]['CHAT_TYPE'],'logType':0x1,'requestOptions':JSON[_0x5c0485(0x2d2)]({'url':_0x3b38ac}),'saasId':_0x51026b},_0x345166={..._0xab9186,'role':_0x5c0485(0x260),'requestOptions':JSON[_0x5c0485(0x2d2)]({'prompt':_0x3b38ac,'options':{'model':_0x61b6a6[_0x5c0485(0x1bf)]}})};await this[_0x5c0485(0x1ef)][_0x5c0485(0x2f4)](_0xab9186),await this[_0x5c0485(0x1ef)]['saveChatLog'](_0x345166),await this['userService']['deductBalance4Chat'](_0x5d7557[_0x5c0485(0x3bd)]['id'],_0x61b6a6,_0x345166['id']);let _0x3ea256=process[_0x5c0485(0x409)][_0x5c0485(0x373)];!/^http/[_0x5c0485(0x3cd)](_0x3ea256)&&(_0x3ea256=_0x5c0485(0x397)+_0x3ea256);const _0x53cbc4={'app':{'appid':_0x61b6a6['appid'],'token':_0x61b6a6[_0x5c0485(0x296)],'cluster':_0x5c0485(0x20a)},'user':{'uid':String(_0x5d7557[_0x5c0485(0x3bd)]['id'])},'audio':{'url':_0x3b38ac,'format':_0x3b38ac['split']('.')[_0x5c0485(0x388)]()},'request':{'callback':_0x3ea256+_0x5c0485(0x361)}},_0x23d750=await this[_0x5c0485(0x356)][_0x5c0485(0x278)]({'data':_0x53cbc4,'headers':{'Authorization':_0x5c0485(0x400)+_0x61b6a6[_0x5c0485(0x33d)]}});_0x173596=_0x23d750['id'],_0x571dda=await this[_0x5c0485(0x1ef)][_0x5c0485(0x2f4)](_0x345166);}),new Promise(_0x12ebc2=>{const _0xb2555b=_0x2e74e7;utils_1['EE'][_0xb2555b(0x3db)](chat_constant_1['EChatType'][_0xb2555b(0x2ee)]+'-'+_0x173596,async _0x48a47d=>{const _0x3b099f=_0xb2555b;_0x571dda['answer']=_0x48a47d[_0x3b099f(0x1ba)],_0x571dda=await this[_0x3b099f(0x1ef)][_0x3b099f(0x2f4)](_0x571dda),_0x12ebc2(_0x571dda);});});}catch(_0x5244d5){throw new common_1['HttpException'](_0x5244d5[_0x2e74e7(0x31a)],common_1[_0x2e74e7(0x3d6)][_0x2e74e7(0x217)]);}}[_0x2fe4bb(0x2c6)](_0x41c317){const _0x22f836=_0x2fe4bb;_0x41c317['code']===0x3e8&&utils_1['EE']['emit'](chat_constant_1[_0x22f836(0x377)][_0x22f836(0x2ee)]+'-'+_0x41c317['id'],_0x41c317);}async[_0x2fe4bb(0x25d)](_0x514d00,_0x431572,_0x36e365,_0x289683){const _0x363ff8=_0x2fe4bb;try{let _0x2ca980=await this[_0x363ff8(0x358)]['transaction'](async()=>{const _0x4ff99f=_0x363ff8;let _0x3c4e30=new Date()['getTime'](),_0xe654eb=new Date()[_0x4ff99f(0x36d)]();const _0x480352=_0x514d00[_0x4ff99f(0x3bd)]['id'],_0x1da0aa=(0x0,utils_1[_0x4ff99f(0x2a8)])(this['clsService']),_0x4bb4d6=chat_constant_1[_0x4ff99f(0x377)][_0x4ff99f(0x2ee)]+'-'+_0x1da0aa+'-'+_0x480352+'-'+new Date()['getTime']()+'.mp3',_0x264e4a=await this[_0x4ff99f(0x3d8)]['upload2Local']({'filename':_0x4bb4d6,'buffer':_0x289683[_0x4ff99f(0x2d9)]});_0xe654eb=new Date()['getTime'](),console[_0x4ff99f(0x276)]('[耗时打印]保存文件耗时：',_0xe654eb-_0x3c4e30);const _0x3e8282=await this[_0x4ff99f(0x278)](_0x514d00,_0x264e4a,_0x36e365?.['options']?.[_0x4ff99f(0x33e)]);_0x3c4e30=new Date()[_0x4ff99f(0x36d)](),console[_0x4ff99f(0x276)]('[耗时打印]语音转文字耗时：',_0x3c4e30-_0xe654eb),_0x36e365[_0x4ff99f(0x35f)]=_0x3e8282[_0x4ff99f(0x401)];typeof _0x36e365[_0x4ff99f(0x253)]===_0x4ff99f(0x37d)&&(_0x36e365['options']=JSON['parse'](_0x36e365[_0x4ff99f(0x253)]));const _0x287981=await this[_0x4ff99f(0x40e)](_0x36e365,_0x514d00,_0x431572,![]);_0xe654eb=new Date()[_0x4ff99f(0x36d)](),console[_0x4ff99f(0x276)](_0x4ff99f(0x280),_0xe654eb-_0x3c4e30);const _0x82fac4=await this[_0x4ff99f(0x407)](_0x514d00,{'request':{'text':_0x287981['answer']}});_0x287981[_0x4ff99f(0x3a0)]=_0x82fac4,this['chatLogService'][_0x4ff99f(0x2f4)](_0x287981),_0x3c4e30=new Date()['getTime'](),console[_0x4ff99f(0x276)](_0x4ff99f(0x1ca),_0x3c4e30-_0xe654eb);const {prompt:_0x1634c3,role:_0x123341,answer:_0x140b91,createdAt:_0x1c6dfd,conversationOptions:_0x1e9ea4,requestOptions:_0x31404e,id:_0x49c453,answerMp3:_0xb14553}=_0x287981;return{'chatId':_0x49c453,'dateTime':(0x0,utils_1['formatDate'])(_0x1c6dfd),'text':_0x123341===_0x4ff99f(0x3bd)?_0x1634c3:_0x140b91,'textMp3':_0xb14553,'inversion':_0x123341==='user','error':![],'conversationOptions':_0x1e9ea4?JSON[_0x4ff99f(0x273)](_0x1e9ea4):null,'requestOptions':_0x31404e?JSON[_0x4ff99f(0x273)](_0x31404e):null};});_0x431572[_0x363ff8(0x2ff)](0xc8)['json'](result_1[_0x363ff8(0x21a)][_0x363ff8(0x3da)](_0x2ca980));}catch(_0x390164){throw new common_1[(_0x363ff8(0x213))](_0x390164[_0x363ff8(0x31a)],common_1['HttpStatus'][_0x363ff8(0x217)]);}}async[_0x2fe4bb(0x23c)](_0x163f92,_0x24e0aa){const _0x530459=_0x2fe4bb,_0x501c85=_0x24e0aa['user']['id'],_0x3939d6=await this[_0x530459(0x21d)][_0x530459(0x36e)](_0x163f92);return{'remainCount':await this['userService'][_0x530459(0x3bc)](_0x501c85,_0x3939d6),'freeCount':_0x3939d6[_0x530459(0x256)],'isVipFree':_0x3939d6[_0x530459(0x256)]==-0x1,'useIntegrate':_0x3939d6['deduct']};}async[_0x2fe4bb(0x1a9)](_0x52c5bf){const _0x310c59=_0x2fe4bb,_0x1d1a3e=_0x52c5bf[_0x310c59(0x3bd)]?.['id'],_0x315f59=await this[_0x310c59(0x21d)][_0x310c59(0x207)](model_constant_1[_0x310c59(0x262)][_0x310c59(0x3c7)]),_0x120972=[];if(_0x1d1a3e)for(const _0x1e57a6 of _0x315f59){_0x120972[_0x310c59(0x357)]({'id':_0x1e57a6['id'],'keyType':_0x1e57a6[_0x310c59(0x23a)],'model':_0x1e57a6[_0x310c59(0x1bf)],'name':_0x1e57a6[_0x310c59(0x40a)],'modelType':_0x1e57a6[_0x310c59(0x29c)],'remainCount':await this['userService'][_0x310c59(0x3bc)](_0x1d1a3e,_0x1e57a6),'freeCount':_0x1e57a6[_0x310c59(0x256)],'isVipFree':_0x1e57a6['vipFreeNum']==-0x1,'useIntegrate':_0x1e57a6[_0x310c59(0x40c)]});}else _0x315f59[_0x310c59(0x3c8)](_0x35e73d=>{const _0x1f4a0a=_0x310c59;_0x120972[_0x1f4a0a(0x357)]({'id':_0x35e73d['id'],'keyType':_0x35e73d['keyType'],'model':_0x35e73d[_0x1f4a0a(0x1bf)],'name':_0x35e73d[_0x1f4a0a(0x40a)],'modelType':_0x35e73d[_0x1f4a0a(0x29c)],'remainCount':0x0,'freeCount':_0x35e73d['vipFreeNum'],'isVipFree':_0x35e73d['vipFreeNum']==-0x1,'useIntegrate':_0x35e73d[_0x1f4a0a(0x40c)]});});return _0x120972;}async['getVideoFree'](_0x5a5e22,_0x196509){const _0x1b1bb7=_0x2fe4bb,_0x4ea874=_0x5a5e22[_0x1b1bb7(0x3bd)]?.['id'];let _0x4fabb8=_0x196509[_0x1b1bb7(0x23a)];const _0x504339=await this[_0x1b1bb7(0x21d)][_0x1b1bb7(0x3d9)](model_constant_1[_0x1b1bb7(0x262)]['VIDEO'],_0x4fabb8);if(!_0x504339)throw new common_1[(_0x1b1bb7(0x213))](_0x1b1bb7(0x2e0),common_1[_0x1b1bb7(0x3d6)]['BAD_REQUEST']);const _0x579be4=await this[_0x1b1bb7(0x393)][_0x1b1bb7(0x3aa)](_0x504339,_0x196509);if(!_0x4ea874)return{'remainCount':0x0,'freeCount':_0x504339[_0x1b1bb7(0x256)]>0x0?_0x504339[_0x1b1bb7(0x256)]:_0x579be4?.['vipFreeNum']||0x0,'isVipFree':_0x504339[_0x1b1bb7(0x256)]==-0x1||_0x579be4?.[_0x1b1bb7(0x256)]==-0x1,'useIntegrate':_0x504339['deduct']>0x0?_0x504339[_0x1b1bb7(0x40c)]:_0x579be4?.[_0x1b1bb7(0x2a7)]||0x0};return{'remainCount':await this['userService']['getVideoModelVipFree'](_0x4ea874,_0x504339,_0x196509),'freeCount':_0x504339['vipFreeNum']>0x0?_0x504339[_0x1b1bb7(0x256)]:_0x579be4?.['vipFreeNum']||0x0,'isVipFree':_0x504339[_0x1b1bb7(0x256)]==-0x1||_0x579be4?.[_0x1b1bb7(0x256)]==-0x1,'useIntegrate':_0x504339[_0x1b1bb7(0x40c)]>0x0?_0x504339[_0x1b1bb7(0x40c)]:_0x579be4?.['price']||0x0};}async[_0x2fe4bb(0x306)](_0x517c56,_0x3f300b){const _0x1a8383=_0x2fe4bb,_0x2c8d78=this['userService'][_0x1a8383(0x1fb)](_0x517c56),_0x40a152=_0x2c8d78?.['id'];let _0x1c6e05=_0x3f300b[_0x1a8383(0x237)],_0x6cd6de=_0x3f300b['n']||0x1;const _0x34ff60=await this[_0x1a8383(0x21d)][_0x1a8383(0x35b)](model_constant_1[_0x1a8383(0x262)][_0x1a8383(0x3f0)],_0x1c6e05);if(!_0x34ff60)throw new common_1['HttpException'](_0x1a8383(0x2e0),common_1[_0x1a8383(0x3d6)][_0x1a8383(0x217)]);if(!_0x40a152)return{'remainCount':0x0,'freeCount':_0x34ff60[_0x1a8383(0x256)]>0x0?_0x34ff60[_0x1a8383(0x256)]:0x0,'isVipFree':_0x34ff60[_0x1a8383(0x256)]==-0x1,'useIntegrate':_0x34ff60[_0x1a8383(0x40c)]>0x0?_0x34ff60['deduct']:0x0};return{'remainCount':await this[_0x1a8383(0x393)][_0x1a8383(0x3a5)](_0x40a152,_0x34ff60),'freeCount':_0x34ff60[_0x1a8383(0x256)]>0x0?_0x34ff60[_0x1a8383(0x256)]:0x0,'isVipFree':_0x34ff60[_0x1a8383(0x256)]==-0x1,'useIntegrate':_0x34ff60[_0x1a8383(0x40c)]>0x0?_0x34ff60['deduct']*_0x6cd6de:0x0};}async['batchPPTResult'](){const _0x540de2=_0x2fe4bb,_0x1a1ae8=await this[_0x540de2(0x21d)][_0x540de2(0x2ce)](model_constant_1['EModelType'][_0x540de2(0x2d4)]),_0x2c5855=await this[_0x540de2(0x261)][_0x540de2(0x359)](_0x540de2(0x1ee));_0x2c5855[_0x540de2(0x2b8)]&&_0x2c5855[_0x540de2(0x3c8)](async _0x49e279=>{const _0x1412a0=_0x540de2;this[_0x1412a0(0x203)]({'baseURL':_0x1a1ae8[_0x1412a0(0x291)]['proxyUrl'],'headers':{'Authorization':_0x1412a0(0x27b)+_0x1a1ae8[_0x1412a0(0x291)][_0x1412a0(0x33d)]},'params':{'id':_0x49e279['yoo_task_id']}});});const _0xea2151=await this[_0x540de2(0x261)][_0x540de2(0x359)](_0x540de2(0x27d));_0xea2151[_0x540de2(0x2b8)]&&_0xea2151['forEach'](async _0x41abcc=>{const _0x2a66b3=_0x540de2,_0x536d52=await this[_0x2a66b3(0x33b)][_0x2a66b3(0x23f)]({'baseURL':_0x1a1ae8[_0x2a66b3(0x291)]['proxyUrl'],'headers':{'Authorization':_0x2a66b3(0x27b)+_0x1a1ae8[_0x2a66b3(0x291)][_0x2a66b3(0x33d)]},'params':{'id':_0x41abcc[_0x2a66b3(0x25f)],'type':'pdf'}});_0x536d52[_0x2a66b3(0x2de)]=='200'&&_0x536d52[_0x2a66b3(0x410)][_0x2a66b3(0x348)]&&(_0x41abcc[_0x2a66b3(0x282)]=_0x536d52[_0x2a66b3(0x410)][_0x2a66b3(0x348)],await this[_0x2a66b3(0x261)][_0x2a66b3(0x298)]({'id':_0x41abcc['id']},{'pdfDownUrl':_0x41abcc[_0x2a66b3(0x282)]}));});const _0x35360e=await this[_0x540de2(0x261)]['query']('select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20png_down_url\x20is\x20null');_0x35360e['length']&&_0x35360e[_0x540de2(0x3c8)](async _0x255d2c=>{const _0xc0a38f=_0x540de2,_0x579866=await this['pptService'][_0xc0a38f(0x23f)]({'baseURL':_0x1a1ae8[_0xc0a38f(0x291)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x1a1ae8[_0xc0a38f(0x291)][_0xc0a38f(0x33d)]},'params':{'id':_0x255d2c[_0xc0a38f(0x25f)],'type':_0xc0a38f(0x27e)}});_0x579866[_0xc0a38f(0x2de)]=='200'&&_0x579866[_0xc0a38f(0x410)]['download_url']&&(_0x255d2c['png_down_url']=_0x579866['data']['download_url'],await this[_0xc0a38f(0x261)][_0xc0a38f(0x298)]({'id':_0x255d2c['id']},{'pngDownUrl':_0x255d2c[_0xc0a38f(0x25c)]}));});try{const _0x524b31=store_2[_0x540de2(0x287)]['pptTimeoutMs']||0x5,_0x1f1351=[{'status':0x1,'type':ppt_constant_1['EPPTTaskType'][_0x540de2(0x1d8)],'updatedAt':(0x0,typeorm_1[_0x540de2(0x36f)])(new Date(Date['now']()-_0x524b31*0x3c*0x3e8))}],_0x378bca=await this['pptTaskEntity'][_0x540de2(0x1c4)]({'where':_0x1f1351});_0x378bca[_0x540de2(0x3c8)](async _0x4af601=>{const _0x45a6f7=_0x540de2;_0x4af601[_0x45a6f7(0x3ef)]=_0x45a6f7(0x3de),_0x4af601[_0x45a6f7(0x2ff)]=0x3,this['pptTaskEntity']['save'](_0x4af601),this[_0x45a6f7(0x393)]['debuctBalance4PPT'](_0x4af601[_0x45a6f7(0x283)],_0x4af601['id'],_0x4af601[_0x45a6f7(0x1bc)],!![]);});}catch(_0x43f22f){common_1[_0x540de2(0x32f)]['error'](_0x43f22f);}}};ChatgptService=__decorate([(0x0,common_1[_0x2fe4bb(0x392)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(pptTask_entity_1['PPTTaskEntity'])),__metadata(_0x2fe4bb(0x362),[typeorm_1[_0x2fe4bb(0x2ea)],nestjs_cls_1[_0x2fe4bb(0x299)],user_service_1['UserService'],file_service_1['FileService'],gpts_service_1[_0x2fe4bb(0x26d)],yooPPT_service_1[_0x2fe4bb(0x38e)],doubao_service_1['DoubaoService'],models_service_1[_0x2fe4bb(0x2db)],chatLog_service_1['ChatLogService'],lumaTask_service_1[_0x2fe4bb(0x1d7)],runwayTask_service_1[_0x2fe4bb(0x1c7)],klingTask_service_1[_0x2fe4bb(0x1c3)],sunoTask_service_1[_0x2fe4bb(0x22c)],badwords_service_1['BadwordsService'],autoreply_service_1['AutoreplyService'],chatGroup_service_1[_0x2fe4bb(0x210)],globalConfig_service_1[_0x2fe4bb(0x1de)],typeorm_1[_0x2fe4bb(0x22a)],mindTask_service_1[_0x2fe4bb(0x2b9)]])],ChatgptService),exports['ChatgptService']=ChatgptService;