'use strict';const _0x2b658d=_0xea1f;(function(_0x346b63,_0xd2ac75){const _0x321436=_0xea1f,_0x2fa5e2=_0x346b63();while(!![]){try{const _0x2f60b3=-parseInt(_0x321436(0x38d))/0x1+parseInt(_0x321436(0x2d2))/0x2*(-parseInt(_0x321436(0x311))/0x3)+parseInt(_0x321436(0x20b))/0x4*(parseInt(_0x321436(0x3e4))/0x5)+-parseInt(_0x321436(0x27f))/0x6*(parseInt(_0x321436(0x1e1))/0x7)+parseInt(_0x321436(0x28a))/0x8*(-parseInt(_0x321436(0x249))/0x9)+-parseInt(_0x321436(0x28e))/0xa+parseInt(_0x321436(0x234))/0xb*(parseInt(_0x321436(0x2c1))/0xc);if(_0x2f60b3===_0xd2ac75)break;else _0x2fa5e2['push'](_0x2fa5e2['shift']());}catch(_0x480d90){_0x2fa5e2['push'](_0x2fa5e2['shift']());}}}(_0x4375,0x97064));function _0xea1f(_0x1ae540,_0x3c9ac5){const _0x43756d=_0x4375();return _0xea1f=function(_0xea1fc3,_0x4718ab){_0xea1fc3=_0xea1fc3-0x1b5;let _0x3f0c76=_0x43756d[_0xea1fc3];return _0x3f0c76;},_0xea1f(_0x1ae540,_0x3c9ac5);}var __decorate=this&&this[_0x2b658d(0x1fd)]||function(_0x77c09b,_0x1d5b67,_0x55f447,_0xad5b6c){const _0x2a02e5=_0x2b658d;var _0x889a5f=arguments[_0x2a02e5(0x1d7)],_0xa3f2ab=_0x889a5f<0x3?_0x1d5b67:_0xad5b6c===null?_0xad5b6c=Object['getOwnPropertyDescriptor'](_0x1d5b67,_0x55f447):_0xad5b6c,_0x57173b;if(typeof Reflect===_0x2a02e5(0x290)&&typeof Reflect['decorate']===_0x2a02e5(0x3ba))_0xa3f2ab=Reflect[_0x2a02e5(0x3ef)](_0x77c09b,_0x1d5b67,_0x55f447,_0xad5b6c);else{for(var _0x437ae9=_0x77c09b[_0x2a02e5(0x1d7)]-0x1;_0x437ae9>=0x0;_0x437ae9--)if(_0x57173b=_0x77c09b[_0x437ae9])_0xa3f2ab=(_0x889a5f<0x3?_0x57173b(_0xa3f2ab):_0x889a5f>0x3?_0x57173b(_0x1d5b67,_0x55f447,_0xa3f2ab):_0x57173b(_0x1d5b67,_0x55f447))||_0xa3f2ab;}return _0x889a5f>0x3&&_0xa3f2ab&&Object[_0x2a02e5(0x20d)](_0x1d5b67,_0x55f447,_0xa3f2ab),_0xa3f2ab;},__metadata=this&&this[_0x2b658d(0x230)]||function(_0x99ad2a,_0x2892fb){const _0x3fcc65=_0x2b658d;if(typeof Reflect===_0x3fcc65(0x290)&&typeof Reflect[_0x3fcc65(0x3c5)]===_0x3fcc65(0x3ba))return Reflect[_0x3fcc65(0x3c5)](_0x99ad2a,_0x2892fb);},__param=this&&this[_0x2b658d(0x2f8)]||function(_0x287b97,_0x5d34ba){return function(_0x132e83,_0x154bc2){_0x5d34ba(_0x132e83,_0x154bc2,_0x287b97);};};Object[_0x2b658d(0x20d)](exports,_0x2b658d(0x1ef),{'value':!![]}),exports[_0x2b658d(0x313)]=void 0x0;const file_service_1=require(_0x2b658d(0x332)),user_service_1=require(_0x2b658d(0x3ae)),openai_1=require(_0x2b658d(0x240)),common_1=require(_0x2b658d(0x1f9)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x2b658d(0x2f2)),axios_1=require(_0x2b658d(0x1eb)),balance_constant_1=require(_0x2b658d(0x2e0)),chatLog_service_1=require(_0x2b658d(0x389)),uuid=require(_0x2b658d(0x299)),fs=require('fs'),typeorm_1=require(_0x2b658d(0x3cb)),typeorm_2=require(_0x2b658d(0x2ed)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require('../autoreply/autoreply.service'),globalConfig_service_1=require(_0x2b658d(0x2d9)),chatGroup_service_1=require(_0x2b658d(0x344)),models_service_1=require('../models/models.service'),baidu_1=require(_0x2b658d(0x3d8)),helper_1=require(_0x2b658d(0x1d0)),store_1=require(_0x2b658d(0x26f)),zhipu_1=require(_0x2b658d(0x2af)),spark_1=require(_0x2b658d(0x22c)),model_constant_1=require('../../common/constants/model.constant'),fs_1=require('fs'),path_1=require(_0x2b658d(0x38c)),gpts_service_1=require('../gpts/gpts.service'),yooPPT_service_1=require(_0x2b658d(0x2d1)),pptTask_entity_1=require('./entity/pptTask.entity'),ppt_constant_1=require(_0x2b658d(0x356)),lumaTask_service_1=require(_0x2b658d(0x284)),nestjs_cls_1=require(_0x2b658d(0x3b0)),doubao_service_1=require('../api/doubao.service'),crypto_1=require('crypto'),chat_constant_1=require(_0x2b658d(0x3cd)),result_1=require(_0x2b658d(0x2b2)),runwayTask_service_1=require(_0x2b658d(0x3c3)),klingTask_service_1=require(_0x2b658d(0x3ea)),sunoTask_service_1=require(_0x2b658d(0x32a)),mindTask_service_1=require(_0x2b658d(0x206)),collectType_constant_1=require(_0x2b658d(0x1e5)),redisKey_constant_1=require(_0x2b658d(0x30f)),store_2=require(_0x2b658d(0x368)),music_constant_1=require('../../common/constants/music.constant');let ChatgptService=class ChatgptService{constructor(_0x2d8bbc,_0x190884,_0x4647f3,_0x3d4518,_0x483b8f,_0x4c42f5,_0x57ff45,_0x259580,_0x42b2d5,_0xb137da,_0x2e858f,_0x2575c8,_0x5d45aa,_0x33dd5e,_0x23a732,_0x54d07a,_0x50a212,_0x4c40b2,_0x2239a0){const _0x52ed4=_0x2b658d;this['pptTaskEntity']=_0x2d8bbc,this['clsService']=_0x190884,this[_0x52ed4(0x2d8)]=_0x4647f3,this[_0x52ed4(0x2c7)]=_0x3d4518,this[_0x52ed4(0x287)]=_0x483b8f,this[_0x52ed4(0x33c)]=_0x4c42f5,this[_0x52ed4(0x1d2)]=_0x57ff45,this[_0x52ed4(0x1da)]=_0x259580,this['chatLogService']=_0x42b2d5,this['lumaTaskService']=_0xb137da,this[_0x52ed4(0x247)]=_0x2e858f,this[_0x52ed4(0x229)]=_0x2575c8,this[_0x52ed4(0x327)]=_0x5d45aa,this[_0x52ed4(0x1fa)]=_0x33dd5e,this['autoreplyService']=_0x23a732,this[_0x52ed4(0x31d)]=_0x54d07a,this['globalConfigService']=_0x50a212,this[_0x52ed4(0x2e6)]=_0x4c40b2,this[_0x52ed4(0x269)]=_0x2239a0,this[_0x52ed4(0x2e5)]='https://api.openai.com',this['messageStore']=null,this[_0x52ed4(0x3b3)]=null,this[_0x52ed4(0x1c3)]=_0x4f3d97=>{const _0x28123f=_0x52ed4;return fs[_0x28123f(0x2e1)](_0x4f3d97,_0x5c1aae=>{const _0xc0373b=_0x28123f;_0x5c1aae?console[_0xc0373b(0x212)]('remove\x20file\x20',_0x5c1aae):console[_0xc0373b(0x212)](_0xc0373b(0x21a),_0x4f3d97);});};}async['onModuleInit'](){const _0x25fa8a=_0x2b658d;let _0x35cb24=await(0x0,utils_1[_0x25fa8a(0x2c0)])(_0x25fa8a(0x3da));_0x35cb24=_0x35cb24?.[_0x25fa8a(0x3ce)]?_0x35cb24['default']:_0x35cb24,this['api']=_0x35cb24['ChatGPTAPI'];let _0x5e9ddb=await(0x0,utils_1[_0x25fa8a(0x2c0)])(_0x25fa8a(0x331));_0x5e9ddb=_0x5e9ddb?.[_0x25fa8a(0x3ce)]?_0x5e9ddb[_0x25fa8a(0x3ce)]:_0x5e9ddb;let _0x2e381e=await(0x0,utils_1[_0x25fa8a(0x2c0)])(_0x25fa8a(0x3e2));_0x2e381e=_0x2e381e?.[_0x25fa8a(0x3ce)]?_0x2e381e[_0x25fa8a(0x3ce)]:_0x2e381e;const _0x193fee=+process['env'][_0x25fa8a(0x3a6)],_0x329092=process[_0x25fa8a(0x1b9)][_0x25fa8a(0x321)],_0x8ec4d=process['env'][_0x25fa8a(0x2bf)],_0x57f8f0=process[_0x25fa8a(0x1b9)][_0x25fa8a(0x2aa)],_0x21dd04=_0x25fa8a(0x26b)+(_0x57f8f0||'')+':'+(_0x8ec4d||'')+'@'+_0x329092+':'+_0x193fee,_0x7bfd9b=new _0x2e381e(_0x21dd04);this[_0x25fa8a(0x25d)]=new _0x5e9ddb({'store':_0x7bfd9b,'namespace':_0x25fa8a(0x245)}),this[_0x25fa8a(0x3b3)]=new store_1[(_0x25fa8a(0x2ca))]({'store':this[_0x25fa8a(0x25d)],'namespace':_0x25fa8a(0x3cc)}),!this[_0x25fa8a(0x2d4)]&&this[_0x25fa8a(0x2e7)]();}[_0x2b658d(0x2e7)](){const _0x860668=_0x2b658d;this['openAi']=new openai_1[(_0x860668(0x3ce))]({'apiKey':_0x860668(0x308),'baseURL':this[_0x860668(0x2e5)]+_0x860668(0x3b2)});}async['getModelConfig'](_0x5975a4){const _0x10f9b0=_0x2b658d,{type:_0x40888d,groupId:_0x2a931d,modelType:_0x36d0fd,officialModel:_0x28d098}=_0x5975a4;let _0x524f91,_0x14c5db;_0x40888d&&_0x40888d==='gpts'?(_0x14c5db=await this['gptsService'][_0x10f9b0(0x2ae)](_0x2a931d),_0x524f91=_0x14c5db[_0x10f9b0(0x33f)]):_0x14c5db=await this[_0x10f9b0(0x31d)][_0x10f9b0(0x2ae)](_0x2a931d);let _0x56deda;if(_0x14c5db)_0x56deda=JSON[_0x10f9b0(0x31e)](_0x14c5db[_0x10f9b0(0x20f)]);else _0x36d0fd?_0x56deda=await this[_0x10f9b0(0x1da)][_0x10f9b0(0x30e)](_0x36d0fd,_0x28d098):_0x56deda=await this[_0x10f9b0(0x1da)][_0x10f9b0(0x30e)](model_constant_1[_0x10f9b0(0x2eb)][_0x10f9b0(0x358)]);if(!_0x56deda)throw new common_1[(_0x10f9b0(0x202))](_0x10f9b0(0x36b),common_1[_0x10f9b0(0x27e)][_0x10f9b0(0x2a6)]);return{'appId':_0x524f91,'modelConfig':_0x56deda};}async['buildSystemMessage'](_0x58f7e0){const _0xa99e7=_0x2b658d,_0x2fe9cd=this;let _0x2f0fb2='',_0x18a2da='',{type:_0x524445,appId:_0x92031a,prompt:_0x2ba57f,custom:_0x43cbb8,usingNetwork:_0x21afe9,systemMessage:_0x3dff5a,customSystemMessage:_0x828613}=_0x58f7e0;const _0x27d996=async function(){const _0x2d2463=_0xea1f,_0x3446d8=new Date()[_0x2d2463(0x242)]()[_0x2d2463(0x207)]('T')[0x0];return _0x18a2da=await _0x2fe9cd[_0x2d2463(0x25f)]['getConfigByKeys']([_0x2d2463(0x20e)]),_0x18a2da+(_0x2d2463(0x24c)+_0x3446d8);};if(_0x92031a){const _0x3e7b28=await this[_0xa99e7(0x287)]['getAppById'](_0x92031a,0x1);if(!_0x3e7b28)throw new common_1['HttpException'](_0xa99e7(0x264),common_1[_0xa99e7(0x27e)]['BAD_REQUEST']);_0x3e7b28[_0xa99e7(0x334)]&&(_0x3dff5a=_0x3e7b28[_0xa99e7(0x334)]);}else{if(_0x43cbb8)_0x3dff5a=_0x3dff5a;else _0x828613?_0x3dff5a=_0x828613:_0x524445!==_0xa99e7(0x2b7)&&(_0x3dff5a=await _0x27d996());}return _0x21afe9&&(_0x2f0fb2=await(0x0,utils_1[_0xa99e7(0x318)])(_0x2ba57f),!_0x18a2da&&(_0x3dff5a=await _0x27d996())),{'systemMessage':_0x3dff5a,'netWorkPrompt':_0x2f0fb2};}async[_0x2b658d(0x3ab)](_0x3a2be3){const _0x19e70a=_0x2b658d,{type:_0x436207,custom:_0x24ef64,groupId:_0x4a5126,modelConfig:_0x5bd09b}=_0x3a2be3;let _0x27a862=null;if(!_0x24ef64&&!_0x436207){const _0x2d4976=await this['modelsService'][_0x19e70a(0x30e)](model_constant_1[_0x19e70a(0x2eb)][_0x19e70a(0x3d1)],_0x5bd09b[_0x19e70a(0x280)][_0x19e70a(0x34c)]);_0x27a862=_0x2d4976['modelInfo'];}else{if(_0x436207===_0x19e70a(0x2b7))_0x27a862=await this['gptsService']['getCurrentModelByChatGroupId'](_0x4a5126);else{if(_0x436207==='file'){const _0x36e6cc=await this['modelsService'][_0x19e70a(0x30e)](model_constant_1['EModelType'][_0x19e70a(0x246)],_0x5bd09b[_0x19e70a(0x280)][_0x19e70a(0x34c)]);_0x27a862=_0x36e6cc[_0x19e70a(0x280)];}else _0x24ef64?_0x27a862=await this[_0x19e70a(0x1da)][_0x19e70a(0x3e7)](model_constant_1['EModelType'][_0x19e70a(0x358)]):_0x27a862=await this[_0x19e70a(0x1da)][_0x19e70a(0x3e7)](model_constant_1[_0x19e70a(0x2eb)][_0x19e70a(0x3d1)]);}}if(!_0x27a862)throw new common_1['HttpException'](_0x19e70a(0x361),common_1[_0x19e70a(0x27e)][_0x19e70a(0x2a6)]);return _0x436207===_0x19e70a(0x2b7)?_0x5bd09b[_0x19e70a(0x280)][_0x19e70a(0x34c)]=_0x27a862[_0x19e70a(0x34c)]:_0x27a862[_0x19e70a(0x34c)]=_0x5bd09b[_0x19e70a(0x280)][_0x19e70a(0x34c)],_0x27a862;}async[_0x2b658d(0x366)](_0x232f5e){const _0x45c639=_0x2b658d,{user:_0xa79680,prompt:_0x1da1e1,currentRequestModel:_0x2f3850}=_0x232f5e;await this[_0x45c639(0x2d8)]['checkUserStatus'](_0xa79680),await this['badwordsService'][_0x45c639(0x29b)](_0x1da1e1,_0xa79680['id']),await this[_0x45c639(0x2d8)][_0x45c639(0x340)](_0xa79680['id'],_0x2f3850);}async[_0x2b658d(0x2ea)](_0x531e95,_0x2eb5a3,_0xd13558){const _0x13d426=_0x2b658d,_0x59d6bf=await this[_0x13d426(0x25f)][_0x13d426(0x397)]([_0x13d426(0x1f4)]),_0x66b80f=Number(_0x59d6bf)||0x493e0,_0x341699={'timeoutMs':+_0x66b80f,'systemMessage':_0x2eb5a3||'','parentMessageId':_0x531e95||'','completionParams':{'temperature':0.8,'model':_0xd13558[_0x13d426(0x34c)]}};return _0x341699;}async[_0x2b658d(0x2c4)](_0x26d6e8,_0x3c1ee2){const _0x679215=_0x2b658d;let _0x21ba31=_0x26d6e8['proxyUrl'];if(!_0x21ba31){const _0x68dbad=await this['globalConfigService'][_0x679215(0x397)]([_0x679215(0x297)]);_0x68dbad?_0x21ba31=_0x68dbad:_0x21ba31=_0x679215(0x37f);}const _0x37d4e0=0x1f40,_0xca46fb=0x1000;console['log'](_0x679215(0x32d),_0x26d6e8);const _0x4b998e=new this['api']({'maxModelTokens':_0x37d4e0,'apiBaseUrl':_0x21ba31+_0x679215(0x3b2),'messageStore':this[_0x679215(0x25d)],'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x26d6e8['key']),'maxResponseTokens':_0xca46fb>=_0x37d4e0?Math[_0x679215(0x1c7)](Math['floor'](_0x37d4e0/0x2)):_0xca46fb});return console[_0x679215(0x212)](_0x679215(0x24b),_0x4b998e[_0x679215(0x24b)]),console[_0x679215(0x212)](_0x679215(0x23a),_0x3c1ee2),console['log'](_0x679215(0x336),_0x21ba31+'/v1'),_0x4b998e;}async[_0x2b658d(0x2cd)](_0x4c1533){const _0x9e9f44=_0x2b658d,_0x4db0b0=new openai_1[(_0x9e9f44(0x3ce))]({'baseURL':_0x4c1533[_0x9e9f44(0x382)]+_0x9e9f44(0x3b2)||_0x9e9f44(0x3a0),'apiKey':_0x4c1533[_0x9e9f44(0x39e)]});return _0x4db0b0;}async[_0x2b658d(0x302)](_0x5234b5,_0x2c5483){const _0x3c019f=_0x2b658d;let _0x1e8a14=_0x5234b5['proxyUrl']||'https://ark.cn-beijing.volces.com';const _0x50af84=0x1f40,_0x1ff0bf=0x1000,_0x266337=new this['api']({'maxModelTokens':_0x50af84,'apiBaseUrl':_0x1e8a14+_0x3c019f(0x278),'messageStore':this[_0x3c019f(0x25d)],'apiKey':(0x0,utils_1[_0x3c019f(0x232)])(_0x5234b5[_0x3c019f(0x39e)]),'maxResponseTokens':_0x1ff0bf>=_0x50af84?Math[_0x3c019f(0x1c7)](Math['floor'](_0x50af84/0x2)):_0x1ff0bf});return console[_0x3c019f(0x212)](_0x3c019f(0x24b),_0x266337[_0x3c019f(0x24b)]),console[_0x3c019f(0x212)](_0x3c019f(0x23a),_0x2c5483),console[_0x3c019f(0x212)](_0x3c019f(0x336),_0x1e8a14+_0x3c019f(0x278)),_0x266337;}async[_0x2b658d(0x3f3)](_0x3a27bd,_0x304abd,_0x22dcd2=null){const _0x248ac2=_0x2b658d;let _0x1bc26d=[];for(const _0x34cb45 of _0x304abd){const _0x18a22b=new URL(_0x34cb45);let _0x12053a=(0x0,path_1[_0x248ac2(0x362)])(process['cwd'](),_0x248ac2(0x2e8),_0x18a22b[_0x248ac2(0x1ce)]);_0x12053a=decodeURIComponent(_0x12053a);const _0x4dd18a=await _0x3a27bd[_0x248ac2(0x27a)][_0x248ac2(0x28d)]({'file':fs[_0x248ac2(0x345)](_0x12053a),'purpose':_0x248ac2(0x1ee)});let _0x342271=await(await _0x3a27bd[_0x248ac2(0x27a)][_0x248ac2(0x304)](_0x4dd18a['id']))[_0x248ac2(0x1e0)]();_0x1bc26d['push']({'role':'system','content':_0x342271});}return _0x1bc26d;}async[_0x2b658d(0x2dc)](_0x3bb9f2,_0x16a977){const _0x1dc97b=_0x2b658d;let _0x428b4e='',_0x37903b=_0x3bb9f2[_0x1dc97b(0x1cd)];return!_0x428b4e&&(_0x428b4e=errorMessage_constant_1[_0x1dc97b(0x253)][_0x37903b]?errorMessage_constant_1[_0x1dc97b(0x253)][_0x37903b]:_0x1dc97b(0x1c1)),_0x3bb9f2?.[_0x1dc97b(0x294)][_0x1dc97b(0x2f1)](_0x1dc97b(0x2cb))&&(await this[_0x1dc97b(0x1da)][_0x1dc97b(0x2be)](_0x16a977['id'],_0x1dc97b(0x2bb),-0x1),_0x428b4e=_0x1dc97b(0x3a1)),_0x3bb9f2?.[_0x1dc97b(0x1cd)]===0x1ad&&_0x3bb9f2[_0x1dc97b(0x294)][_0x1dc97b(0x2f1)]('You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.')&&(await this[_0x1dc97b(0x1da)][_0x1dc97b(0x2be)](_0x16a977['id'],'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x428b4e=_0x1dc97b(0x216)),_0x3bb9f2?.[_0x1dc97b(0x1cd)]===0x191&&_0x3bb9f2['message'][_0x1dc97b(0x2f1)](_0x1dc97b(0x38a))&&(await this[_0x1dc97b(0x1da)][_0x1dc97b(0x2be)](_0x16a977['id'],_0x1dc97b(0x37b),-0x2),_0x428b4e=_0x1dc97b(0x1e4)),_0x3bb9f2?.['statusCode']===0x191&&(_0x428b4e='模型秘钥错误或模型金额不足，请联系管理员！'),_0x3bb9f2?.[_0x1dc97b(0x1cd)]===0x191&&_0x3bb9f2[_0x1dc97b(0x294)][_0x1dc97b(0x2f1)](_0x1dc97b(0x31c))&&(await this['modelsService'][_0x1dc97b(0x2be)](_0x16a977['id'],_0x1dc97b(0x37b),-0x2),_0x428b4e=_0x1dc97b(0x1e4)),_0x3bb9f2?.['statusCode']===0x194&&_0x3bb9f2[_0x1dc97b(0x294)][_0x1dc97b(0x2f1)](_0x1dc97b(0x1dc))&&(await this[_0x1dc97b(0x1da)][_0x1dc97b(0x2be)](_0x16a977['id'],_0x1dc97b(0x32f),-0x4),_0x428b4e=_0x1dc97b(0x2ba)),_0x428b4e;}async[_0x2b658d(0x363)](_0x111a66,_0x5e3820,_0x2e3b7c,_0x3d4b3f=!![],_0x5c3d6=''){const _0x7cb3ec=_0x2b658d;try{const _0x388227=_0x5e3820['abortController'],_0x4a0343=(0x0,utils_1[_0x7cb3ec(0x2d3)])(this[_0x7cb3ec(0x228)]),{options:options={},prompt:_0x387cde,cusromPrompt:_0x2b7232,assetsId:_0x1107b9}=_0x111a66,{groupId:_0x25938e,usingNetwork:_0x5dc83a,parentMessageId:_0x372438,type:_0x1fd463}=options,{appId:_0x2b1beb,modelConfig:_0x122125}=await this[_0x7cb3ec(0x3c2)]({'type':_0x1fd463,'groupId':_0x25938e}),{systemMessage:_0x2018f3,netWorkPrompt:_0x56284e}=await this[_0x7cb3ec(0x316)]({'type':_0x1fd463,'appId':_0x2b1beb,'prompt':_0x387cde,'usingNetwork':_0x5dc83a,'custom':_0x2b7232,'systemMessage':_0x111a66[_0x7cb3ec(0x225)],'customSystemMessage':_0x122125[_0x7cb3ec(0x280)]['systemMessage']}),_0x599d30=await this[_0x7cb3ec(0x3ab)]({'type':_0x1fd463,'groupId':_0x25938e,'modelConfig':_0x122125,'custom':_0x2b7232});await this[_0x7cb3ec(0x366)]({'prompt':_0x387cde,'currentRequestModel':_0x599d30,'user':_0x5e3820[_0x7cb3ec(0x36e)]});const _0x320958=await this['autoreplyService'][_0x7cb3ec(0x3e5)](_0x387cde);_0x2e3b7c&&_0x3d4b3f&&_0x2e3b7c['setHeader'](_0x7cb3ec(0x3a8),_0x7cb3ec(0x369));if(_0x320958){if(_0x2e3b7c&&_0x3d4b3f){const _0x3f9037={'message':_0x320958,'code':0x1f4};_0x2e3b7c[_0x7cb3ec(0x1d3)](JSON[_0x7cb3ec(0x261)](_0x3f9037)),_0x2e3b7c[_0x7cb3ec(0x1cf)]();return;}else return _0x320958;}const _0x4e3c05=await this[_0x7cb3ec(0x2ea)](options['parentMessageId'],_0x2018f3,_0x599d30);options[_0x7cb3ec(0x34c)]&&(_0x4e3c05[_0x7cb3ec(0x376)]['model']=options[_0x7cb3ec(0x34c)]);let {model:_0x578440,rounds:_0x46d0c2,keyType:_0x275f3d,modelType:_0x4b4f81,id:_0x5c25c9,topN:_0x3e68e9}=_0x122125[_0x7cb3ec(0x280)];const {key:_0x1c5f68,modelName:_0x21d567,id:_0x15d38a,accessToken:_0x2036d5}=_0x599d30;_0x578440=_0x4e3c05['completionParams'][_0x7cb3ec(0x34c)];_0x2e3b7c&&_0x3d4b3f&&_0x2e3b7c[_0x7cb3ec(0x1e2)](0xc8);let _0x455d59=null,_0x25ac6a=null;const _0x5c8fba=(0x0,utils_1[_0x7cb3ec(0x1fb)])(_0x5e3820),_0x21cbfa={'appId':_0x2b1beb,'curIp':_0x5c8fba,'prompt':_0x387cde,'groupId':_0x25938e,'modelId':_0x5c25c9,'modelType':_0x4b4f81,'answer':'','model':_0x578440,'role':_0x7cb3ec(0x36e),'userId':_0x5e3820[_0x7cb3ec(0x36e)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x7cb3ec(0x1b5)]['CHAT_TYPE'],'logType':_0x1fd463===_0x7cb3ec(0x2b7)?0x2:0x1,'requestOptions':JSON['stringify']({'options':options,'prompt':_0x387cde}),'saasId':_0x4a0343,'modelSubType':_0x5c3d6},_0x10dfd0={..._0x21cbfa,'role':_0x7cb3ec(0x29a),'requestOptions':JSON[_0x7cb3ec(0x261)]({'prompt':_0x387cde,'options':{'model':_0x578440,'temperature':_0x3e68e9}})};try{if(_0x2e3b7c){let _0x1e7e78=null,_0x52e13b=![];_0x2e3b7c['on'](_0x7cb3ec(0x23e),async()=>{const _0x5077ff=_0x7cb3ec;if(_0x52e13b)return;_0x388227[_0x5077ff(0x31f)]();const _0x3a2b0a=0x0,_0x1f4422=0x0,_0x4a0e6a=_0x3a2b0a+_0x1f4422;_0x21cbfa['totalTokens']=_0x3a2b0a,_0x21cbfa[_0x5077ff(0x325)]=_0x3a2b0a,await this[_0x5077ff(0x317)][_0x5077ff(0x243)](_0x21cbfa),_0x10dfd0[_0x5077ff(0x2a2)]=_0x1e7e78?.[_0x5077ff(0x1e0)],_0x10dfd0['totalTokens']=_0x4a0e6a,_0x10dfd0[_0x5077ff(0x325)]=_0x3a2b0a,_0x10dfd0['completionTokens']=_0x1f4422,_0x10dfd0[_0x5077ff(0x2da)]=JSON[_0x5077ff(0x261)]({'conversationId':_0x1e7e78?.[_0x5077ff(0x3ed)],'model':_0x578440,'parentMessageId':_0x1e7e78?.['id'],'temperature':_0x3e68e9});const _0x2b8280=await this[_0x5077ff(0x317)]['saveChatLog'](_0x10dfd0);if(_0x5c3d6=='mind'){const _0x3f055b=await this['mindTaskService'][_0x5077ff(0x3d9)]({'id':_0x1107b9,'userId':_0x2b8280[_0x5077ff(0x3b8)],'chatLogId':_0x2b8280['id'],'prompt':_0x2b8280[_0x5077ff(0x1db)],'result':_0x10dfd0[_0x5077ff(0x2a2)],'status':0x1});_0x455d59[_0x5077ff(0x2b4)]=_0x3f055b['id'];}await this[_0x5077ff(0x2d8)][_0x5077ff(0x396)](_0x5e3820[_0x5077ff(0x36e)]['id'],_0x599d30,_0x2b8280['id']);}),_0x2e3b7c['on'](_0x7cb3ec(0x2fd),_0x1e5f6b=>{const _0x587b8d=_0x7cb3ec;console[_0x587b8d(0x212)](_0x1e5f6b);});if(Number(_0x275f3d)===0x1){let _0xc39213=!![];const _0x399deb=await this['configChatGptApi'](_0x599d30,_0x4e3c05);_0x455d59=await _0x399deb[_0x7cb3ec(0x390)](_0x5dc83a?_0x56284e:_0x387cde,{..._0x4e3c05,'onProgress':_0x1aa46f=>{const _0x2a715a=_0x7cb3ec;_0x3d4b3f&&_0x2e3b7c[_0x2a715a(0x1d3)](_0xc39213?JSON[_0x2a715a(0x261)](_0x1aa46f):'\x0a'+JSON[_0x2a715a(0x261)](_0x1aa46f)),_0xc39213=![],_0x1e7e78=_0x1aa46f;},'abortSignal':_0x388227['signal']}),_0x52e13b=!![];}if(Number(_0x275f3d)===0x2){let _0x2dd7c2=!![];const _0x716d1e=await this[_0x7cb3ec(0x3b3)][_0x7cb3ec(0x1c5)](_0x5dc83a?_0x56284e:_0x387cde,{'parentMessageId':_0x372438,'maxRounds':(0x0,helper_1[_0x7cb3ec(0x38e)])(_0x46d0c2)});_0x455d59=await(0x0,baidu_1[_0x7cb3ec(0x341)])(_0x5dc83a?_0x56284e:_0x716d1e,{'temperature':_0x3e68e9,'accessToken':_0x2036d5,'model':_0x578440,'onProgress':_0x5eb406=>{const _0x3afd64=_0x7cb3ec;_0x3d4b3f&&_0x2e3b7c[_0x3afd64(0x1d3)](_0x2dd7c2?JSON[_0x3afd64(0x261)](_0x5eb406):'\x0a'+JSON[_0x3afd64(0x261)](_0x5eb406)),_0x2dd7c2=![],_0x1e7e78=_0x5eb406;}}),_0x52e13b=!![];}if(Number(_0x275f3d)===0x3){let _0x3df658=!![];const _0xbe610e=await this[_0x7cb3ec(0x3b3)][_0x7cb3ec(0x1c5)](_0x5dc83a?_0x56284e:_0x387cde,{'parentMessageId':_0x372438,'maxRounds':(0x0,helper_1[_0x7cb3ec(0x38e)])(_0x46d0c2)});_0x455d59=await(0x0,zhipu_1['sendMessageFromZhipu'])(_0x5dc83a?_0x56284e:_0xbe610e,{'temperature':_0x3e68e9,'key':_0x1c5f68,'model':_0x578440,'onProgress':_0x4aad78=>{const _0x4bbe87=_0x7cb3ec;_0x3d4b3f&&_0x2e3b7c['write'](_0x3df658?JSON[_0x4bbe87(0x261)](_0x4aad78):'\x0a'+JSON[_0x4bbe87(0x261)](_0x4aad78)),_0x3df658=![],_0x1e7e78=_0x4aad78;}}),_0x52e13b=!![];}if(Number(_0x275f3d)===0x4){let _0x17a969=!![];const {key:_0x45cf6e,appid:_0xa1e936,secret:_0x295abf,model:_0x4dfeef}=_0x599d30,_0xa0ade=await this[_0x7cb3ec(0x3b3)][_0x7cb3ec(0x1c5)](_0x5dc83a?_0x56284e:_0x387cde,{'parentMessageId':_0x372438,'maxRounds':(0x0,helper_1[_0x7cb3ec(0x38e)])(_0x46d0c2)}),_0x22b383=new spark_1[(_0x7cb3ec(0x38b))]({'appid':_0xa1e936,'secret':_0x295abf,'key':_0x45cf6e});_0x455d59=await _0x22b383[_0x7cb3ec(0x214)](_0x5dc83a?_0x56284e:_0xa0ade,{'temperature':_0x3e68e9,'model':_0x4dfeef,'onProgress':_0x2b1856=>{const _0x51d21d=_0x7cb3ec;_0x3d4b3f&&_0x2e3b7c['write'](_0x17a969?JSON['stringify'](_0x2b1856):'\x0a'+JSON[_0x51d21d(0x261)](_0x2b1856)),_0x17a969=![],_0x1e7e78=_0x2b1856;},'abortController':_0x388227}),_0x52e13b=!![];}if(Number(_0x275f3d)===0x7){_0x455d59={};const _0xba6225=await this[_0x7cb3ec(0x2cd)](_0x599d30);let _0x15c8ff=!![],_0x160ddf=[],_0xdf6e5=!![];const _0x5f1bcb=[],_0x5e112a=[],_0x1a1d0b=_0x387cde[_0x7cb3ec(0x207)]('\x20');for(let _0x12a757=0x0;_0x12a757<_0x1a1d0b[_0x7cb3ec(0x1d7)];_0x12a757++){_0x15c8ff&&/^[http:\/\/|https:\/\/]/['test'](_0x1a1d0b[_0x12a757])?_0x5f1bcb[_0x7cb3ec(0x3ca)](_0x1a1d0b[_0x12a757]):(_0x15c8ff=![],_0x1a1d0b[_0x12a757]&&_0x5e112a[_0x7cb3ec(0x3ca)](_0x1a1d0b[_0x12a757]));}if(options[_0x7cb3ec(0x34a)]){const _0x31e935=await this[_0x7cb3ec(0x317)][_0x7cb3ec(0x22d)](options[_0x7cb3ec(0x1b8)]);_0x160ddf=_0x31e935[_0x7cb3ec(0x351)](_0x5a18d6=>{const _0x5cbe11=_0x7cb3ec;return{'role':_0x5a18d6['role']===_0x5cbe11(0x36e)?_0x5cbe11(0x36e):'system','content':_0x5a18d6[_0x5cbe11(0x1db)]||_0x5a18d6[_0x5cbe11(0x2a2)]};});}const _0x5e2d05=await this[_0x7cb3ec(0x3f3)](_0xba6225,_0x5f1bcb),_0x4fe696=[..._0x160ddf,..._0x5e2d05,{'role':_0x7cb3ec(0x3c4),'content':_0x7cb3ec(0x27b)+_0x7cb3ec(0x347)+_0x7cb3ec(0x1e6)},{'role':_0x7cb3ec(0x36e),'content':_0x5e112a[_0x7cb3ec(0x362)]('\x20')}];console[_0x7cb3ec(0x212)](_0x7cb3ec(0x24b),_0xba6225['apiKey']),console[_0x7cb3ec(0x212)]('mergedOptions',options),console[_0x7cb3ec(0x212)](_0x7cb3ec(0x336),_0xba6225[_0x7cb3ec(0x323)]+_0x7cb3ec(0x3b2)),console[_0x7cb3ec(0x212)]('messages',JSON[_0x7cb3ec(0x261)](_0x4fe696));const _0x334e32=await _0xba6225[_0x7cb3ec(0x3cc)][_0x7cb3ec(0x2de)][_0x7cb3ec(0x28d)]({'stream':!![],..._0x4e3c05,'messages':_0x4fe696,'model':_0x599d30[_0x7cb3ec(0x34c)]});for await(const _0x2332a7 of _0x334e32){const _0x279fc1=_0x2332a7?.[_0x7cb3ec(0x3d4)][0x0],_0x6493f1=_0x279fc1?.[_0x7cb3ec(0x320)];_0x455d59['detail']=_0x2332a7,_0x2332a7['id']&&(_0x455d59['id']=_0x2332a7['id']),_0x6493f1[_0x7cb3ec(0x2a4)]&&(_0x455d59[_0x7cb3ec(0x2a4)]=_0x6493f1[_0x7cb3ec(0x2a4)]),_0x6493f1&&_0x6493f1['content']&&(_0x455d59[_0x7cb3ec(0x1e0)]+=_0x6493f1[_0x7cb3ec(0x304)],_0x455d59[_0x7cb3ec(0x320)]=_0x6493f1?.[_0x7cb3ec(0x304)]),_0x279fc1[_0x7cb3ec(0x2d6)]&&(_0x455d59[_0x7cb3ec(0x1e0)]=_0x455d59[_0x7cb3ec(0x1e0)][_0x7cb3ec(0x3b4)]()),_0x334e32&&_0x2e3b7c[_0x7cb3ec(0x1d3)](_0xdf6e5?JSON[_0x7cb3ec(0x261)](_0x455d59):'\x0a'+JSON[_0x7cb3ec(0x261)](_0x455d59)),_0xdf6e5=![],_0x1e7e78=_0x2332a7;}}if(Number(_0x275f3d)===0x8){let _0x4ccf52=!![];const _0x251786=await this[_0x7cb3ec(0x302)](_0x599d30,_0x4e3c05);_0x455d59=await _0x251786[_0x7cb3ec(0x390)](_0x5dc83a?_0x56284e:_0x387cde,{..._0x4e3c05,'onProgress':_0x2aa5ea=>{const _0x699549=_0x7cb3ec;_0x3d4b3f&&_0x2e3b7c['write'](_0x4ccf52?JSON['stringify'](_0x2aa5ea):'\x0a'+JSON[_0x699549(0x261)](_0x2aa5ea)),_0x4ccf52=![],_0x1e7e78=_0x2aa5ea;},'abortSignal':_0x388227[_0x7cb3ec(0x260)]}),_0x52e13b=!![];}const _0x232a97={'id':this[_0x7cb3ec(0x3b3)]['getUuid'](),'text':_0x387cde,'role':_0x7cb3ec(0x36e),'name':undefined,'usage':null,'parentMessageId':_0x372438,'conversationId':_0x455d59?.['conversationId']||null};_0x25ac6a={'model':_0x578440,'parentMessageId':_0x372438},await this['gomaxAiStore'][_0x7cb3ec(0x1fe)](_0x232a97);const _0x1e8e5c={'id':_0x455d59?.['id']||this[_0x7cb3ec(0x3b3)]['getUuid'](),'text':_0x455d59[_0x7cb3ec(0x1e0)],'role':_0x7cb3ec(0x29a),'name':undefined,'usage':_0x455d59[_0x7cb3ec(0x1b7)],'parentMessageId':_0x232a97['id'],'conversationId':_0x455d59?.['conversationId']};await this['gomaxAiStore'][_0x7cb3ec(0x1fe)](_0x1e8e5c),_0x25ac6a={'model':_0x578440,'parentMessageId':_0x232a97['id']};}else{console[_0x7cb3ec(0x212)]('fanyi\x20mj-associate');const _0x5bfb71=await this[_0x7cb3ec(0x2c4)](_0x599d30,_0x4e3c05);_0x455d59=await _0x5bfb71[_0x7cb3ec(0x390)](_0x5dc83a?_0x56284e:_0x387cde,_0x4e3c05);}const _0x4bfe3a=(0x0,helper_1[_0x7cb3ec(0x3ac)])(_0x275f3d,_0x455d59,_0x25ac6a),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x4bfe3a[_0x7cb3ec(0x1b7)];_0x1fd463===_0x7cb3ec(0x2b7)?await this['gptsService'][_0x7cb3ec(0x1f2)](_0x15d38a,total_tokens):await this[_0x7cb3ec(0x1da)]['saveUseLog'](_0x15d38a,total_tokens);console[_0x7cb3ec(0x212)](_0x7cb3ec(0x33b)),_0x21cbfa[_0x7cb3ec(0x21f)]=total_tokens,await this[_0x7cb3ec(0x317)][_0x7cb3ec(0x243)](_0x21cbfa),_0x10dfd0[_0x7cb3ec(0x2a2)]=_0x4bfe3a?.['text'],_0x10dfd0['totalTokens']=total_tokens,_0x10dfd0[_0x7cb3ec(0x325)]=prompt_tokens,_0x10dfd0['completionTokens']=completion_tokens,_0x10dfd0['conversationOptions']=JSON[_0x7cb3ec(0x261)]({'conversationId':_0x455d59[_0x7cb3ec(0x3ed)],'model':_0x578440,'parentMessageId':_0x455d59['id'],'temperature':_0x3e68e9});const _0x486e8e=await this[_0x7cb3ec(0x317)]['saveChatLog'](_0x10dfd0);common_1[_0x7cb3ec(0x352)][_0x7cb3ec(0x378)](_0x7cb3ec(0x3db)+_0x5e3820[_0x7cb3ec(0x36e)]['id']+_0x7cb3ec(0x1f7)+_0x578440+_0x7cb3ec(0x32c)+_0x1c5f68+_0x7cb3ec(0x24d)+_0x21d567,_0x7cb3ec(0x313)),_0x455d59[_0x7cb3ec(0x371)]&&(_0x455d59[_0x7cb3ec(0x371)]=''),_0x455d59[_0x7cb3ec(0x3d5)]=!![],_0x455d59[_0x7cb3ec(0x1cc)]=_0x486e8e['id'];if(_0x5c3d6==_0x7cb3ec(0x222)){const _0x4f2ad5=await this[_0x7cb3ec(0x269)]['saveMindTask']({'id':_0x1107b9,'userId':_0x486e8e[_0x7cb3ec(0x3b8)],'chatLogId':_0x486e8e['id'],'prompt':_0x486e8e[_0x7cb3ec(0x1db)],'result':_0x10dfd0[_0x7cb3ec(0x2a2)],'status':0x1});_0x455d59['mindTaskId']=_0x4f2ad5['id'],console['log'](_0x7cb3ec(0x3d2),_0x4f2ad5);}if(_0x2e3b7c&&_0x3d4b3f)await this[_0x7cb3ec(0x2d8)]['deductBalance4Chat'](_0x5e3820[_0x7cb3ec(0x36e)]['id'],_0x599d30,_0x486e8e['id']),_0x2e3b7c[_0x7cb3ec(0x1d3)]('\x0a'+JSON[_0x7cb3ec(0x261)](_0x455d59));else return _0x455d59['text'];}catch(_0x372690){_0x10dfd0['answer']=_0x372690[_0x7cb3ec(0x294)],_0x10dfd0['errMsg']=_0x372690[_0x7cb3ec(0x294)],_0x10dfd0['conversationOptions']=JSON[_0x7cb3ec(0x261)]({'conversationId':_0x455d59?.[_0x7cb3ec(0x3ed)],'model':_0x578440,'parentMessageId':_0x455d59?.['id'],'temperature':_0x3e68e9});const _0x8199fb=await this[_0x7cb3ec(0x317)][_0x7cb3ec(0x243)](_0x10dfd0);if(_0x5c3d6==_0x7cb3ec(0x222)){const _0x4e7206=await this[_0x7cb3ec(0x269)][_0x7cb3ec(0x3d9)]({'id':_0x1107b9,'userId':_0x8199fb[_0x7cb3ec(0x3b8)],'prompt':_0x8199fb['prompt'],'chatLogId':_0x8199fb['id'],'result':_0x10dfd0['answer'],'status':-0x1});_0x455d59[_0x7cb3ec(0x2b4)]=_0x4e7206['id'];}console[_0x7cb3ec(0x212)](_0x7cb3ec(0x3b9),_0x1c5f68,_0x372690);const _0x585af4=_0x372690[_0x7cb3ec(0x1cd)];_0x585af4===0x190&&console[_0x7cb3ec(0x212)](_0x7cb3ec(0x285),_0x372690,_0x372690[_0x7cb3ec(0x294)]);if(_0x372690[_0x7cb3ec(0x1e2)]&&_0x372690['status']===0x192){const _0x3f47cc={'message':_0x7cb3ec(0x309)+_0x372690[_0x7cb3ec(0x294)],'code':0x192};if(_0x2e3b7c&&_0x3d4b3f){_0x2e3b7c[_0x7cb3ec(0x1d3)](JSON[_0x7cb3ec(0x261)](_0x3f47cc)),_0x2e3b7c['end']();return;}else throw new common_1[(_0x7cb3ec(0x202))](_0x372690[_0x7cb3ec(0x294)],common_1[_0x7cb3ec(0x27e)]['PAYMENT_REQUIRED']);}if(!_0x585af4){if(_0x2e3b7c&&_0x3d4b3f){_0x2e3b7c[_0x7cb3ec(0x1d3)](JSON[_0x7cb3ec(0x261)]({'message':_0x372690[_0x7cb3ec(0x294)],'code':0x1f4})),_0x2e3b7c['end']();return;}else throw new common_1[(_0x7cb3ec(0x202))](_0x372690[_0x7cb3ec(0x294)],common_1[_0x7cb3ec(0x27e)][_0x7cb3ec(0x2a6)]);}const _0x55e501=await this['openAiErrHandler'](_0x372690,_0x599d30),_0x362dd6={'message':_0x55e501||'Please\x20check\x20the\x20back-end\x20console','code':_0x585af4===0x191?0x191:_0x585af4||0x1f4};if(_0x2e3b7c&&_0x3d4b3f)_0x2e3b7c[_0x7cb3ec(0x1cd)]=0x190,_0x2e3b7c['write'](JSON['stringify'](_0x362dd6));else throw new common_1['HttpException'](_0x362dd6[_0x7cb3ec(0x294)],common_1[_0x7cb3ec(0x27e)][_0x7cb3ec(0x2a6)]);}finally{_0x2e3b7c&&_0x3d4b3f&&_0x2e3b7c[_0x7cb3ec(0x1cf)]();}}catch(_0x41d475){if(_0x41d475 instanceof common_1[_0x7cb3ec(0x202)])throw _0x41d475;else throw new common_1[(_0x7cb3ec(0x202))](_0x41d475[_0x7cb3ec(0x294)],common_1[_0x7cb3ec(0x27e)][_0x7cb3ec(0x2a6)]);}}async['musicConfig'](_0x3efcbd){const _0x326afc=_0x2b658d;try{const _0x288436=['musicLyricsPrice',_0x326afc(0x23d),'musicCreatePrice',_0x326afc(0x37e),_0x326afc(0x2c9),_0x326afc(0x1e7)],_0x1fd6ab=await this[_0x326afc(0x25f)][_0x326afc(0x397)](_0x288436);if(!_0x3efcbd[_0x326afc(0x36e)]||!_0x3efcbd[_0x326afc(0x36e)]['id'])throw new Error('Invalid\x20user\x20information');const _0x56cea4=['musicLyrics',_0x326afc(0x2f7),_0x326afc(0x30b)],_0x199e63=await Promise['all'](_0x56cea4[_0x326afc(0x351)](async _0x244eb1=>{const _0x19c52b=_0x326afc,_0x58416c=_0x1fd6ab[_0x244eb1+_0x19c52b(0x3d7)],_0x490e00=_0x1fd6ab[_0x244eb1+_0x19c52b(0x286)],_0x5ddd14=redisKey_constant_1[_0x19c52b(0x27c)]+'-'+_0x3efcbd[_0x19c52b(0x36e)]['id']+'-'+(_0x244eb1+_0x19c52b(0x3d7)),_0x1bbc75=await this[_0x19c52b(0x2d8)]['getKeyFree'](_0x3efcbd[_0x19c52b(0x36e)]['id'],_0x5ddd14,_0x58416c);return{'type':_0x244eb1,'remainCount':_0x1bbc75,'freeCount':Number(_0x58416c),'useIntegrate':Number(_0x490e00)};}));return _0x199e63;}catch(_0x17d849){console[_0x326afc(0x2fd)]('Error\x20in\x20pptConfig:',_0x17d849);throw _0x17d849;}}async['sunoMusicTask'](_0x14a0da){const _0x57683d=_0x2b658d,{data:_0x24abc1,answerLogDTO:_0x1cbff1,currentRequestModel:_0x3045b6,musicTaskType:_0x41ab63}=_0x14a0da;try{let _0x3a6bcb=process['env'][_0x57683d(0x3b7)];!/^http/[_0x57683d(0x24e)](_0x3a6bcb)&&(_0x3a6bcb='https://'+_0x3a6bcb);let _0x2c6436;if(_0x41ab63==music_constant_1[_0x57683d(0x2ec)][_0x57683d(0x3aa)])!_0x24abc1[_0x57683d(0x3bb)]&&(_0x24abc1[_0x57683d(0x384)]=_0x24abc1['prompt'],delete _0x24abc1[_0x57683d(0x1db)]),_0x2c6436=await this[_0x57683d(0x327)][_0x57683d(0x1f0)]({'data':_0x24abc1,'baseURL':_0x3045b6[_0x57683d(0x382)],'headers':{'Authorization':_0x57683d(0x3d0)+_0x3045b6[_0x57683d(0x39e)]}});else _0x41ab63==music_constant_1['EMusicTaskType'][_0x57683d(0x213)]?(_0x24abc1[_0x57683d(0x233)]=_0x3a6bcb+(_0x57683d(0x237)+_0x1cbff1['id']),_0x2c6436=await this[_0x57683d(0x327)]['lyrics']({'data':_0x24abc1,'baseURL':_0x3045b6[_0x57683d(0x382)],'headers':{'Authorization':_0x57683d(0x3d0)+_0x3045b6[_0x57683d(0x39e)]}})):(_0x24abc1[_0x57683d(0x233)]=_0x3a6bcb+(_0x57683d(0x372)+_0x1cbff1['id']),_0x2c6436=await this['sunoTaskService'][_0x57683d(0x386)]({'data':_0x24abc1,'baseURL':_0x3045b6['proxyUrl'],'headers':{'Authorization':_0x57683d(0x3d0)+_0x3045b6[_0x57683d(0x39e)]}}));await this[_0x57683d(0x1da)][_0x57683d(0x3b5)](_0x3045b6['id'],0x0),_0x1cbff1[_0x57683d(0x21f)]=0x0,_0x1cbff1[_0x57683d(0x325)]=0x0,_0x1cbff1[_0x57683d(0x21d)]=0x0,_0x1cbff1[_0x57683d(0x277)]=_0x2c6436[_0x57683d(0x1d1)],_0x1cbff1[_0x57683d(0x395)]=_0x41ab63,_0x1cbff1[_0x57683d(0x2da)]=JSON[_0x57683d(0x261)]({'model':_0x3045b6[_0x57683d(0x34c)],'parentMessageId':_0x2c6436[_0x57683d(0x1d1)]}),await this[_0x57683d(0x317)][_0x57683d(0x243)](_0x1cbff1),common_1[_0x57683d(0x352)][_0x57683d(0x378)](_0x57683d(0x3db)+_0x1cbff1[_0x57683d(0x3b8)]+_0x57683d(0x1f7)+_0x3045b6[_0x57683d(0x34c)]+_0x57683d(0x32c)+_0x3045b6[_0x57683d(0x39e)]+_0x57683d(0x24d)+_0x3045b6[_0x57683d(0x357)],'SunoMusicTask');if(_0x2c6436[_0x57683d(0x339)]!==_0x57683d(0x235))throw new Error(_0x57683d(0x2cc));}catch(_0x372db6){console[_0x57683d(0x212)](_0x57683d(0x2f3),_0x3045b6[_0x57683d(0x39e)],_0x372db6);const _0x471fdd=await this[_0x57683d(0x2dc)](_0x372db6,_0x3045b6);_0x1cbff1['errMsg']=_0x471fdd,await this[_0x57683d(0x317)]['saveChatLog'](_0x1cbff1),await this['userService'][_0x57683d(0x1c6)](_0x1cbff1[_0x57683d(0x3b8)],_0x1cbff1['id'],_0x41ab63,!![]);}}async[_0x2b658d(0x39b)](_0xe3b570){const _0x44c3d5=_0x2b658d,{data:_0x43fea5,answerLogDTO:_0x5d67c0,currentRequestModel:_0x4cf338}=_0xe3b570;try{let _0x5e26d3;await this['userService']['deductBalance4Chat'](_0x5d67c0[_0x44c3d5(0x3b8)],_0x4cf338,_0x5d67c0['id']);_0x43fea5[_0x44c3d5(0x21b)]?_0x5e26d3=await this[_0x44c3d5(0x2ff)][_0x44c3d5(0x3df)]({'data':_0x43fea5,'baseURL':_0x4cf338[_0x44c3d5(0x382)],'headers':{'Authorization':_0x44c3d5(0x3d0)+_0x4cf338[_0x44c3d5(0x39e)]}},_0x43fea5[_0x44c3d5(0x21b)]):_0x5e26d3=await this['lumaTaskService'][_0x44c3d5(0x385)]({'data':_0x43fea5,'baseURL':_0x4cf338[_0x44c3d5(0x382)],'headers':{'Authorization':_0x44c3d5(0x3d0)+_0x4cf338[_0x44c3d5(0x39e)]}});await this['modelsService'][_0x44c3d5(0x3b5)](_0x4cf338['id'],0x0),_0x5d67c0[_0x44c3d5(0x21f)]=0x0,_0x5d67c0['promptTokens']=0x0,_0x5d67c0[_0x44c3d5(0x21d)]=0x0,_0x5d67c0[_0x44c3d5(0x2a2)]=_0x5e26d3[_0x44c3d5(0x250)],_0x5d67c0[_0x44c3d5(0x2da)]=JSON[_0x44c3d5(0x261)]({'model':_0x4cf338[_0x44c3d5(0x34c)],'parentMessageId':_0x5e26d3['id']}),await this[_0x44c3d5(0x317)]['saveChatLog'](_0x5d67c0),common_1[_0x44c3d5(0x352)][_0x44c3d5(0x378)](_0x44c3d5(0x3db)+_0x5d67c0[_0x44c3d5(0x3b8)]+_0x44c3d5(0x1f7)+_0x4cf338['model']+'\x20key\x20->\x20'+_0x4cf338[_0x44c3d5(0x39e)]+_0x44c3d5(0x24d)+_0x4cf338[_0x44c3d5(0x357)],_0x44c3d5(0x313));if(!_0x5d67c0[_0x44c3d5(0x2a2)])throw new Error('视频生成失败，没有响应');await this['chatLogService']['parseAndSaveVideo'](_0x5d67c0,{'id':_0x5e26d3['id'],'state':_0x5e26d3['state'],'completed':_0x5e26d3[_0x44c3d5(0x250)]===_0x44c3d5(0x375),'videoUrl':_0x5e26d3[_0x44c3d5(0x342)]?.[_0x44c3d5(0x37d)]});}catch(_0x4e2bcf){console[_0x44c3d5(0x212)]('video-task',_0x4cf338[_0x44c3d5(0x39e)],_0x4e2bcf);const _0x14b6f8=await this[_0x44c3d5(0x2dc)](_0x4e2bcf,_0x4cf338);_0x5d67c0['errMsg']=_0x14b6f8,await this[_0x44c3d5(0x317)][_0x44c3d5(0x243)](_0x5d67c0),await this[_0x44c3d5(0x2d8)][_0x44c3d5(0x1f3)](_0x5d67c0[_0x44c3d5(0x3b8)],_0x4cf338,_0x5d67c0['id']);}}async[_0x2b658d(0x281)](_0x46d3ab){const _0x2bbfe9=_0x2b658d,{data:_0xedd8f8,answerLogDTO:_0x4813eb,currentRequestModel:_0x142d4f}=_0x46d3ab;try{let _0x1cafdf;await this['userService'][_0x2bbfe9(0x396)](_0x4813eb[_0x2bbfe9(0x3b8)],_0x142d4f,_0x4813eb['id']);const _0x2ba6b0=_0xedd8f8[_0x2bbfe9(0x36f)],_0x406d5e={'model':_0xedd8f8[_0x2bbfe9(0x34c)],'ratio':_0xedd8f8[_0x2bbfe9(0x2a7)],'prompt':_0xedd8f8[_0x2bbfe9(0x1db)],'style':_0xedd8f8[_0x2bbfe9(0x2a3)],'options':_0x2ba6b0};_0xedd8f8[_0x2bbfe9(0x25c)]&&(_0x406d5e[_0x2bbfe9(0x25c)]=_0xedd8f8[_0x2bbfe9(0x25c)]);_0xedd8f8[_0x2bbfe9(0x28b)]&&(_0x406d5e['last_image']=_0xedd8f8['last_image']);_0x1cafdf=await this[_0x2bbfe9(0x247)][_0x2bbfe9(0x385)]({'data':_0x406d5e,'baseURL':_0x142d4f[_0x2bbfe9(0x382)],'headers':{'Authorization':_0x2bbfe9(0x3d0)+_0x142d4f[_0x2bbfe9(0x39e)]}}),await this[_0x2bbfe9(0x1da)][_0x2bbfe9(0x3b5)](_0x142d4f['id'],0x0),_0x4813eb[_0x2bbfe9(0x21f)]=0x0,_0x4813eb[_0x2bbfe9(0x325)]=0x0,_0x4813eb['completionTokens']=0x0,_0x4813eb[_0x2bbfe9(0x275)]=_0x1cafdf[_0x2bbfe9(0x1d8)],_0x4813eb[_0x2bbfe9(0x2a2)]=_0x1cafdf[_0x2bbfe9(0x1e2)]=='3'?_0x2bbfe9(0x324):_0x1cafdf[_0x2bbfe9(0x1e2)],_0x4813eb[_0x2bbfe9(0x2da)]=JSON[_0x2bbfe9(0x261)]({'model':_0x142d4f[_0x2bbfe9(0x34c)],'parentMessageId':_0x1cafdf[_0x2bbfe9(0x343)]}),await this['chatLogService'][_0x2bbfe9(0x243)](_0x4813eb),common_1[_0x2bbfe9(0x352)][_0x2bbfe9(0x378)]('本次调用:\x20'+_0x4813eb[_0x2bbfe9(0x3b8)]+_0x2bbfe9(0x1f7)+_0x142d4f[_0x2bbfe9(0x34c)]+'\x20key\x20->\x20'+_0x142d4f['key']+_0x2bbfe9(0x24d)+_0x142d4f['modelName'],_0x2bbfe9(0x313));if(_0x1cafdf['msg'])throw new Error('视频生成失败，没有响应');await this[_0x2bbfe9(0x317)][_0x2bbfe9(0x1c4)](_0x4813eb,{'id':_0x1cafdf[_0x2bbfe9(0x343)],'state':_0x1cafdf[_0x2bbfe9(0x1e2)]=='3'?_0x2bbfe9(0x324):_0x1cafdf[_0x2bbfe9(0x1e2)],'completed':_0x1cafdf[_0x2bbfe9(0x1e2)]==='3','videoUrl':_0x1cafdf[_0x2bbfe9(0x282)]});}catch(_0x28d2d3){console['log']('video-task',_0x142d4f['key'],_0x28d2d3);const _0x207622=await this[_0x2bbfe9(0x2dc)](_0x28d2d3,_0x142d4f);_0x4813eb['errMsg']=_0x207622,await this[_0x2bbfe9(0x317)][_0x2bbfe9(0x243)](_0x4813eb),await this[_0x2bbfe9(0x2d8)][_0x2bbfe9(0x1f3)](_0x4813eb[_0x2bbfe9(0x3b8)],_0x142d4f,_0x4813eb['id']);}}async[_0x2b658d(0x398)](_0x1dbc35){const _0xde6e0e=_0x2b658d,{data:_0x14619e,answerLogDTO:_0x3c4093,currentRequestModel:_0x539dd1}=_0x1dbc35;try{let _0xfb7c29;await this[_0xde6e0e(0x2d8)]['deductBalance4Chat'](_0x3c4093['userId'],_0x539dd1,_0x3c4093['id']);_0x14619e[_0xde6e0e(0x25c)]?_0xfb7c29=await this[_0xde6e0e(0x229)][_0xde6e0e(0x33d)]({'data':_0x14619e,'baseURL':_0x539dd1['proxyUrl'],'headers':{'Authorization':_0xde6e0e(0x3d0)+_0x539dd1[_0xde6e0e(0x39e)]}}):_0xfb7c29=await this['klingTaskService']['t2v']({'data':_0x14619e,'baseURL':_0x539dd1[_0xde6e0e(0x382)],'headers':{'Authorization':_0xde6e0e(0x3d0)+_0x539dd1['key']}});await this['modelsService'][_0xde6e0e(0x3b5)](_0x539dd1['id'],0x0),_0x3c4093['totalTokens']=0x0,_0x3c4093[_0xde6e0e(0x325)]=0x0,_0x3c4093['completionTokens']=0x0,_0x3c4093[_0xde6e0e(0x2a2)]=_0xfb7c29['task_status'],_0x3c4093['conversationOptions']=JSON['stringify']({'model':_0x539dd1[_0xde6e0e(0x34c)],'parentMessageId':_0xfb7c29[_0xde6e0e(0x343)]}),await this[_0xde6e0e(0x317)]['saveChatLog'](_0x3c4093),common_1[_0xde6e0e(0x352)][_0xde6e0e(0x378)](_0xde6e0e(0x3db)+_0x3c4093[_0xde6e0e(0x3b8)]+'\x20model:\x20'+_0x539dd1[_0xde6e0e(0x34c)]+_0xde6e0e(0x32c)+_0x539dd1[_0xde6e0e(0x39e)]+_0xde6e0e(0x24d)+_0x539dd1[_0xde6e0e(0x357)],'ChatgptService');if(!_0x3c4093[_0xde6e0e(0x2a2)]||_0x3c4093[_0xde6e0e(0x2a2)]===_0xde6e0e(0x203))throw new Error(_0xde6e0e(0x3bf));await this['chatLogService']['parseAndSaveVideo'](_0x3c4093,{'id':_0xfb7c29[_0xde6e0e(0x343)],'state':_0xfb7c29[_0xde6e0e(0x2a5)],'completed':_0xfb7c29[_0xde6e0e(0x2a5)]===_0xde6e0e(0x300),'videoUrl':_0xfb7c29['task_result']&&_0xfb7c29[_0xde6e0e(0x208)]['videos']&&_0xfb7c29[_0xde6e0e(0x208)]['videos'][_0xde6e0e(0x1d7)]?_0xfb7c29['task_result'][_0xde6e0e(0x39a)][0x0]?.[_0xde6e0e(0x37d)]:''});}catch(_0x825eb8){console[_0xde6e0e(0x212)](_0xde6e0e(0x2b8),_0x539dd1[_0xde6e0e(0x39e)],_0x825eb8);const _0x1b65fd=await this[_0xde6e0e(0x2dc)](_0x825eb8,_0x539dd1);_0x3c4093[_0xde6e0e(0x275)]=_0x1b65fd,await this[_0xde6e0e(0x317)]['saveChatLog'](_0x3c4093),await this[_0xde6e0e(0x2d8)][_0xde6e0e(0x1f3)](_0x3c4093[_0xde6e0e(0x3b8)],_0x539dd1,_0x3c4093['id']);}}async[_0x2b658d(0x1ba)](_0x5d3f2c){const _0x12a46a=_0x2b658d;try{const _0x30c309=(0x0,utils_1[_0x12a46a(0x2d3)])(this[_0x12a46a(0x228)]),{req:_0x54c36f,model:_0x17df28,modelType:_0x36ed13,datas:_0x397ad3,requestBody:_0x4dba4c,musicTaskType:_0x408d6e}=_0x5d3f2c;let _0x5b5740,_0x12464a;const _0x4e75b0=await this[_0x12a46a(0x3c2)]({'modelType':_0x36ed13});_0x5b5740=_0x4e75b0[_0x12a46a(0x3dc)],_0x12464a=_0x4e75b0[_0x12a46a(0x2b5)];let _0xc04584='';_0x12a46a(0x1db)in _0x397ad3&&(_0xc04584=_0x397ad3['prompt']);const _0x473672=await this[_0x12a46a(0x1da)]['getRandomKey'](_0x36ed13,_0x36ed13===model_constant_1[_0x12a46a(0x2eb)][_0x12a46a(0x2e3)]?_0x17df28:'');_0x473672[_0x12a46a(0x34c)]=_0x17df28,_0x12464a[_0x12a46a(0x280)][_0x12a46a(0x34c)]=_0x17df28;_0x12a46a(0x1db)in _0x397ad3&&await this[_0x12a46a(0x366)]({'prompt':_0xc04584,'currentRequestModel':_0x473672,'user':_0x54c36f[_0x12a46a(0x36e)]});let {id:_0x4a0e63,topN:_0x1e2ae1,keyType:_0x5883b0}=_0x12464a[_0x12a46a(0x280)];const _0xa148dc=0x0,_0x10976e=0x0,_0x2dee05=_0xa148dc+_0x10976e,_0x3e4375=(0x0,utils_1[_0x12a46a(0x1fb)])(_0x54c36f),_0x31699b={'appId':_0x5b5740,'curIp':_0x3e4375,'prompt':_0xc04584,'modelId':_0x4a0e63,'modelType':_0x36ed13,'answer':'','model':_0x17df28,'role':_0x12a46a(0x36e),'userId':_0x54c36f['user']['id'],'completionTokens':0x0,'totalTokens':_0x2dee05,'type':balance_constant_1['DeductionKey'][_0x12a46a(0x1c9)],'logType':0x1,'modelSubType':'','requestParams':_0x4dba4c||_0x397ad3,'requestOptions':JSON[_0x12a46a(0x261)]({'options':null,'prompt':_0xc04584}),'saasId':_0x30c309},_0x9a3b70={..._0x31699b,'role':_0x12a46a(0x29a),'requestOptions':JSON[_0x12a46a(0x261)]({'prompt':_0xc04584,'options':{'model':_0x17df28,'temperature':_0x1e2ae1}})};await this[_0x12a46a(0x317)]['saveChatLog'](_0x31699b);const _0xbb3679=await this['chatLogService'][_0x12a46a(0x243)](_0x9a3b70);return await this[_0x12a46a(0x2d8)][_0x12a46a(0x1c6)](_0x54c36f['user']['id'],_0xbb3679['id'],_0x408d6e),await this[_0x12a46a(0x204)]({'data':_0x397ad3,'currentRequestModel':_0x473672,'answerLogDTO':_0xbb3679,'musicTaskType':_0x408d6e}),_0xbb3679;}catch(_0x7a52f){if(_0x7a52f instanceof common_1[_0x12a46a(0x202)])throw _0x7a52f;else throw new common_1['HttpException'](_0x7a52f['message'],common_1[_0x12a46a(0x27e)][_0x12a46a(0x2a6)]);}}async[_0x2b658d(0x1c2)](_0x315be1){const _0x2d6f2b=_0x2b658d;try{const _0x2d2429=(0x0,utils_1['getReqSaasId'])(this[_0x2d6f2b(0x228)]),{req:_0x36dce9,model:_0x2677ea,modelType:_0x1dce93,datas:_0x17b647,requestBody:_0x53df0d}=_0x315be1,{prompt:_0x2e007a,options:options={}}=_0x17b647,{groupId:_0x4a96a2,type:_0x2716fb}=options;let _0x596abd,_0x5367b0;if(_0x1dce93===model_constant_1[_0x2d6f2b(0x2eb)][_0x2d6f2b(0x2e3)]){const _0x5b0726=await this['getModelConfig']({'modelType':_0x1dce93,'officialModel':_0x2677ea});_0x596abd=_0x5b0726[_0x2d6f2b(0x3dc)],_0x5367b0=_0x5b0726[_0x2d6f2b(0x2b5)];}else{const _0x494421=await this[_0x2d6f2b(0x3c2)]({'modelType':_0x1dce93});_0x596abd=_0x494421[_0x2d6f2b(0x3dc)],_0x5367b0=_0x494421[_0x2d6f2b(0x2b5)];}const _0xc53c88=await this[_0x2d6f2b(0x1da)][_0x2d6f2b(0x3e7)](_0x1dce93,_0x1dce93===model_constant_1[_0x2d6f2b(0x2eb)][_0x2d6f2b(0x2e3)]?_0x2677ea:'');_0xc53c88[_0x2d6f2b(0x34c)]=_0x2677ea,_0x5367b0['modelInfo']['model']=_0x2677ea,await this['validateBeforeChat']({'prompt':_0x2e007a,'currentRequestModel':_0xc53c88,'user':_0x36dce9[_0x2d6f2b(0x36e)]});let {id:_0x312be7,topN:_0x367eba,keyType:_0x5f5bb4}=_0x5367b0[_0x2d6f2b(0x280)];const _0x183fee=0x0,_0x1c50bc=0x0,_0x44bc97=_0x183fee+_0x1c50bc,_0x260e08=(0x0,utils_1[_0x2d6f2b(0x1fb)])(_0x36dce9),_0x4cbc36={'appId':_0x596abd,'curIp':_0x260e08,'prompt':_0x2e007a,'groupId':_0x4a96a2,'modelId':_0x312be7,'modelType':_0x1dce93,'answer':'','model':_0x2677ea,'role':'user','userId':_0x36dce9[_0x2d6f2b(0x36e)]['id'],'completionTokens':0x0,'totalTokens':_0x44bc97,'type':balance_constant_1[_0x2d6f2b(0x1b5)][_0x2d6f2b(0x1c9)],'logType':_0x2716fb===_0x2d6f2b(0x2b7)?0x2:0x1,'modelSubType':_0x1dce93===model_constant_1[_0x2d6f2b(0x2eb)][_0x2d6f2b(0x2e3)]?_0x5f5bb4[_0x2d6f2b(0x22b)]():'','requestParams':_0x53df0d||_0x17b647,'requestOptions':JSON[_0x2d6f2b(0x261)]({'options':null,'prompt':_0x2e007a}),'saasId':_0x2d2429},_0x48ab72={..._0x4cbc36,'role':_0x2d6f2b(0x29a),'requestOptions':JSON[_0x2d6f2b(0x261)]({'prompt':_0x2e007a,'options':{'model':_0x2677ea,'temperature':_0x367eba}})};await this['chatLogService'][_0x2d6f2b(0x243)](_0x4cbc36);const _0x169adc=await this[_0x2d6f2b(0x317)][_0x2d6f2b(0x243)](_0x48ab72);await this[_0x2d6f2b(0x2d8)][_0x2d6f2b(0x396)](_0x36dce9[_0x2d6f2b(0x36e)]['id'],_0xc53c88,_0x169adc['id']);if(_0x1dce93===model_constant_1[_0x2d6f2b(0x2eb)][_0x2d6f2b(0x2e3)])switch(_0x5f5bb4){case 0x2:this[_0x2d6f2b(0x281)]({'data':_0x17b647,'currentRequestModel':_0xc53c88,'answerLogDTO':_0x169adc});break;case 0x3:this[_0x2d6f2b(0x398)]({'data':_0x17b647,'currentRequestModel':_0xc53c88,'answerLogDTO':_0x169adc});break;default:this[_0x2d6f2b(0x39b)]({'data':_0x17b647,'currentRequestModel':_0xc53c88,'answerLogDTO':_0x169adc});}return _0x169adc;}catch(_0xa3e2c4){if(_0xa3e2c4 instanceof common_1[_0x2d6f2b(0x202)])throw _0xa3e2c4;else throw new common_1[(_0x2d6f2b(0x202))](_0xa3e2c4[_0x2d6f2b(0x294)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2b658d(0x36c)](_0x1744a8,_0x4e41e2){const _0xc5f169=_0x2b658d;let {mv:_0x5a14e6}=_0x1744a8;return!_0x1744a8['make_instrumental']?_0x1744a8[_0xc5f169(0x37c)]=![]:_0x1744a8['make_instrumental']=!![],this[_0xc5f169(0x1ba)]({'req':_0x4e41e2,'datas':_0x1744a8,'model':_0x5a14e6||_0xc5f169(0x283),'modelType':model_constant_1[_0xc5f169(0x2eb)][_0xc5f169(0x1f6)],'musicTaskType':music_constant_1[_0xc5f169(0x2ec)][_0xc5f169(0x3aa)]});}async[_0x2b658d(0x1bc)](_0x579cac,_0x11a5d6){const _0x4cfe29=_0x2b658d,_0x5ced82={'url':_0x579cac};return this[_0x4cfe29(0x1ba)]({'req':_0x11a5d6,'datas':_0x5ced82,'model':_0x4cfe29(0x283),'modelType':model_constant_1['EModelType'][_0x4cfe29(0x1f6)],'musicTaskType':music_constant_1[_0x4cfe29(0x2ec)][_0x4cfe29(0x380)]});}async[_0x2b658d(0x387)](_0x1dc11f,_0x2a11fe){const _0x58ef=_0x2b658d;return this['chatMuiscTask']({'req':_0x2a11fe,'datas':_0x1dc11f,'model':_0x58ef(0x283),'modelType':model_constant_1[_0x58ef(0x2eb)][_0x58ef(0x1f6)],'musicTaskType':music_constant_1[_0x58ef(0x2ec)][_0x58ef(0x213)]});}async['lumaChatVideo'](_0x106e6b,_0x312a4c){const _0x2d997f=_0x2b658d,_0x3a1fe9=JSON[_0x2d997f(0x31e)](JSON[_0x2d997f(0x261)](_0x106e6b));let {model:_0x292642,prompt:_0x3d3767,expand_prompt:_0x32514a,aspect_ratio:_0x1dfb9d,image_url:_0x3d01e9,image_end_url:_0x5bd708}=_0x106e6b,_0x122570=_0x2d997f(0x2e2)+_0x3d3767+_0x2d997f(0x388)+_0x32514a+_0x2d997f(0x374)+_0x1dfb9d;return _0x3d01e9&&(_0x122570=_0x122570+_0x2d997f(0x3c1)+_0x3d01e9),_0x5bd708&&(_0x122570=_0x122570+_0x2d997f(0x248)+_0x5bd708),_0x106e6b[_0x2d997f(0x1db)]=_0x122570,_0x106e6b[_0x2d997f(0x354)]=_0x3d3767,this[_0x2d997f(0x1c2)]({'req':_0x312a4c,'datas':_0x106e6b,'requestBody':_0x3a1fe9,'model':_0x292642||'luma-video','modelType':model_constant_1[_0x2d997f(0x2eb)][_0x2d997f(0x2e3)]});}async[_0x2b658d(0x295)](_0x48c053,_0x55f4dd){const _0x11055d=_0x2b658d,_0x4a8d73=JSON[_0x11055d(0x31e)](JSON[_0x11055d(0x261)](_0x48c053));return this['chatTask']({'req':_0x55f4dd,'datas':_0x48c053,'requestBody':_0x4a8d73,'model':_0x48c053['model']||_0x11055d(0x2ee),'modelType':model_constant_1[_0x11055d(0x2eb)][_0x11055d(0x2e3)]});}async['klingChatVideo'](_0x4cc35d,_0x354577){const _0x43db7b=_0x2b658d,_0x2d0172=JSON[_0x43db7b(0x31e)](JSON[_0x43db7b(0x261)](_0x4cc35d));return this['chatTask']({'req':_0x354577,'datas':_0x4cc35d,'requestBody':_0x2d0172,'model':_0x4cc35d['model']||_0x43db7b(0x3e9),'modelType':model_constant_1[_0x43db7b(0x2eb)][_0x43db7b(0x2e3)]});}async[_0x2b658d(0x314)](){const _0x57c60c=_0x2b658d,_0x2dd5fc=await this['chatLogService'][_0x57c60c(0x392)]();if(!_0x2dd5fc['length'])return;const _0x5e9fe7=[],_0x830664=new Map();_0x2dd5fc[_0x57c60c(0x364)](_0x281d80=>{const _0xfd786d=_0x57c60c;_0x5e9fe7[_0xfd786d(0x3ca)](_0x281d80['id']),_0x830664[_0xfd786d(0x346)](_0x281d80['id'],_0x281d80);});const _0x1f70e4=await this['chatLogService'][_0x57c60c(0x370)](_0x5e9fe7),_0x38adaf=[],_0x45e417=new Map();_0x1f70e4[_0x57c60c(0x364)](_0x59ad38=>{const _0x1fa84e=_0x57c60c;_0x38adaf['push'](_0x59ad38[_0x1fa84e(0x2ac)]),_0x45e417['set'](_0x59ad38[_0x1fa84e(0x2ac)],_0x59ad38);});const _0x46eb4d=await this['modelsService']['getRandomKey'](model_constant_1['EModelType'][_0x57c60c(0x2e3)]),_0xe80b98=await this['lumaTaskService'][_0x57c60c(0x221)]({'baseURL':_0x46eb4d[_0x57c60c(0x382)],'headers':{'Authorization':'Bearer\x20'+_0x46eb4d[_0x57c60c(0x39e)]},'data':{'ids':_0x38adaf}});for(let _0x1a3bfe=0x0;_0x1a3bfe<_0xe80b98[_0x57c60c(0x1d7)];_0x1a3bfe++){const _0x4fcfc0=_0xe80b98[_0x1a3bfe],_0x265fca=_0x45e417[_0x57c60c(0x3e6)](_0x4fcfc0[_0x57c60c(0x343)]),_0x29947f=_0x830664['get'](_0x265fca[_0x57c60c(0x1cc)]);await this[_0x57c60c(0x317)][_0x57c60c(0x1c4)](_0x29947f,{'id':_0x4fcfc0['data']['id'],'state':_0x4fcfc0[_0x57c60c(0x1d1)]['state'],'completed':_0x4fcfc0[_0x57c60c(0x1d1)][_0x57c60c(0x250)]===_0x57c60c(0x375),'videoUrl':_0x4fcfc0['data'][_0x57c60c(0x342)]?.[_0x57c60c(0x37d)]});}}async[_0x2b658d(0x21e)](_0x40a094){const _0xac03f1=_0x2b658d,{prompt:_0x2b06d8,userId:_0x14a4ce,abortController:_0x4504c1}=_0x40a094,_0x31d173=await this['modelsService']['getModelByType'](model_constant_1[_0xac03f1(0x2eb)][_0xac03f1(0x3d1)]),_0x2d37fd=_0x31d173[_0xac03f1(0x280)],_0x580a66=_0x31d173['modelInfo'][_0xac03f1(0x28c)];if(!_0x2d37fd)throw new common_1[(_0xac03f1(0x202))](_0xac03f1(0x361),common_1['HttpStatus'][_0xac03f1(0x2a6)]);const {id:_0x715c1}=_0x2d37fd;let _0x1bb9c5=null,_0x2b014d=null;try{const _0x3329f0=await this['buildOptions']('','',_0x2d37fd),_0x2a546e=await this[_0xac03f1(0x2c4)](_0x2d37fd,_0x3329f0);_0x1bb9c5=await _0x2a546e['sendMessage'](_0x2b06d8,{..._0x3329f0,'abortSignal':_0x4504c1[_0xac03f1(0x260)]});const _0x515a85=(0x0,helper_1[_0xac03f1(0x3ac)])(_0x580a66,_0x1bb9c5,_0x2b014d),{total_tokens:total_tokens=0x0}=_0x515a85[_0xac03f1(0x1b7)];return await this[_0xac03f1(0x1da)][_0xac03f1(0x3b5)](_0x715c1,total_tokens),await this['userService'][_0xac03f1(0x396)](_0x14a4ce,_0x2d37fd,-0x1),_0x1bb9c5[_0xac03f1(0x1e0)];}catch(_0x1ee8d2){common_1[_0xac03f1(0x352)][_0xac03f1(0x212)](_0x1ee8d2);const _0x4da48d=_0x1ee8d2['statusCode'];console[_0xac03f1(0x212)](_0x4da48d);if(_0x1ee8d2[_0xac03f1(0x1e2)]&&_0x1ee8d2[_0xac03f1(0x1e2)]===0x192)throw new common_1[(_0xac03f1(0x202))](_0x1ee8d2[_0xac03f1(0x294)],common_1[_0xac03f1(0x27e)]['PAYMENT_REQUIRED']);if(!_0x4da48d)throw new common_1[(_0xac03f1(0x202))](_0x1ee8d2[_0xac03f1(0x294)],common_1[_0xac03f1(0x27e)]['BAD_REQUEST']);let _0x51bc20=errorMessage_constant_1[_0xac03f1(0x253)][_0x4da48d]?errorMessage_constant_1[_0xac03f1(0x253)][_0x4da48d]:'服务异常、请重新试试吧！！！';_0x1ee8d2?.['message'][_0xac03f1(0x2f1)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&Number(_0x580a66)===0x1&&(await this[_0xac03f1(0x1da)][_0xac03f1(0x2be)](_0x715c1,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x51bc20=_0xac03f1(0x3a1));_0x1ee8d2?.[_0xac03f1(0x1cd)]===0x1ad&&_0x1ee8d2['message'][_0xac03f1(0x2f1)](_0xac03f1(0x32e))&&Number(_0x580a66)===0x1&&(await this[_0xac03f1(0x1da)]['lockKey'](_0x715c1,_0xac03f1(0x244),-0x3),_0x51bc20=_0xac03f1(0x216));_0x1ee8d2?.[_0xac03f1(0x1cd)]===0x191&&_0x1ee8d2[_0xac03f1(0x294)][_0xac03f1(0x2f1)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x580a66)===0x1&&(await this[_0xac03f1(0x1da)][_0xac03f1(0x2be)](_0x715c1,'提供了错误的模型秘钥',-0x2),_0x51bc20=_0xac03f1(0x2fa));_0x1ee8d2?.[_0xac03f1(0x1cd)]===0x191&&_0x1ee8d2[_0xac03f1(0x294)][_0xac03f1(0x2f1)]('Unauthorized')&&Number(_0x580a66)===0x1&&(await this[_0xac03f1(0x1da)][_0xac03f1(0x2be)](_0x715c1,_0xac03f1(0x216),-0x2),_0x51bc20=_0xac03f1(0x30a));_0x1ee8d2?.[_0xac03f1(0x1cd)]===0x194&&_0x1ee8d2[_0xac03f1(0x294)]['includes'](_0xac03f1(0x1dc))&&Number(_0x580a66)===0x1&&(await this['modelsService'][_0xac03f1(0x2be)](_0x715c1,_0xac03f1(0x32f),-0x4),_0x51bc20=_0xac03f1(0x2ba));_0x1ee8d2?.[_0xac03f1(0x1cd)]===0x133&&_0x1ee8d2[_0xac03f1(0x294)]['includes']('bad\x20response\x20status\x20code\x20307')&&Number(_0x580a66)===0x1&&(console[_0xac03f1(0x212)](_0xac03f1(0x252)),_0x51bc20='\x20！');_0x4da48d===0x190&&console[_0xac03f1(0x212)]('400\x20error',_0x1ee8d2,_0x1ee8d2[_0xac03f1(0x294)]);const _0x535e3c={'message':_0x51bc20||'Please\x20check\x20the\x20back-end\x20console','code':_0x4da48d===0x191?0x191:_0x4da48d||0x1f4};throw new common_1[(_0xac03f1(0x202))](_0x535e3c['message'],common_1[_0xac03f1(0x27e)]['BAD_REQUEST']);}}async['chatRealTime'](_0xdfa12d,_0x391982,_0x214fd4){const _0x531d91=_0x2b658d;try{const {audio:_0x315d7b,voice:_0x249ef0}=_0xdfa12d,_0x5093de=_0x391982[_0x531d91(0x3a2)],_0x33ee32=await this[_0x531d91(0x1da)][_0x531d91(0x3f1)]();if(!_0x33ee32)throw _0x531d91(0x30c);const {key:_0x2e7afa,proxyUrl:_0x15ba36}=_0x33ee32;await this['userService'][_0x531d91(0x205)](_0x391982[_0x531d91(0x36e)]),await this[_0x531d91(0x2d8)][_0x531d91(0x340)](_0x391982['user']['id'],_0x33ee32),console[_0x531d91(0x212)](_0x531d91(0x279),_0x2e7afa,_0x15ba36),this[_0x531d91(0x2d4)][_0x531d91(0x24b)]=_0x2e7afa,this[_0x531d91(0x2d4)][_0x531d91(0x323)]=(_0x15ba36||this['defaultBaseUrl'])+'/v1',this[_0x531d91(0x2d4)][_0x531d91(0x333)]=0x989680;const _0x4569a2=await this[_0x531d91(0x2d4)][_0x531d91(0x3bd)][_0x531d91(0x39f)][_0x531d91(0x28d)]({'file':(0x0,fs_1[_0x531d91(0x345)])((0x0,path_1['resolve'])(_0x315d7b[_0x531d91(0x38c)])),'model':_0x531d91(0x218),'language':'zh','response_format':_0x531d91(0x262),'temperature':0x0})[_0x531d91(0x322)](_0x294ec8=>_0x294ec8['text'])[_0x531d91(0x3b1)](_0x56ad5c=>{const _0x36fd8e=_0x531d91;common_1[_0x36fd8e(0x352)]['error'](_0x56ad5c);});console['log']('audio2text\x20',_0x4569a2);if(!_0x4569a2){this[_0x531d91(0x1c3)]((0x0,path_1['resolve'])(_0x315d7b[_0x531d91(0x38c)]));throw new common_1[(_0x531d91(0x202))](_0x531d91(0x1bf),common_1[_0x531d91(0x27e)][_0x531d91(0x2a6)]);}await this['userService'][_0x531d91(0x396)](_0x391982[_0x531d91(0x36e)]['id'],_0x33ee32,-0x1);const _0x32f158=await this[_0x531d91(0x21e)]({'userId':_0x391982[_0x531d91(0x36e)]['id'],'prompt':_0x4569a2,'abortController':_0x5093de});console['log'](_0x531d91(0x34b),_0x32f158);if(!_0x32f158){this['removeFile']((0x0,path_1['resolve'])(_0x315d7b[_0x531d91(0x38c)]));throw new common_1['HttpException'](_0x531d91(0x319),common_1['HttpStatus'][_0x531d91(0x2a6)]);}console['log'](_0x531d91(0x1f5),_0x32f158[_0x531d91(0x1d7)]);let _0x1bdf41=_0x32f158[_0x531d91(0x1d7)]>0x1000?_0x32f158['slice'](0x0,0xfff):_0x32f158;const _0x1824cd=await this[_0x531d91(0x2d4)]['audio'][_0x531d91(0x29e)][_0x531d91(0x28d)]({'input':_0x1bdf41,'model':_0x531d91(0x273),'response_format':_0x531d91(0x20a),'voice':_0x249ef0,'speed':0x1})[_0x531d91(0x322)](_0x5cd021=>_0x5cd021[_0x531d91(0x3c7)]())['catch'](_0xcec5f3=>{const _0x2070f9=_0x531d91;common_1['Logger'][_0x2070f9(0x2fd)](_0xcec5f3);});if(!_0x1824cd){this['removeFile']((0x0,path_1[_0x531d91(0x35f)])(_0x315d7b['path']));throw new common_1[(_0x531d91(0x202))](_0x531d91(0x3a3),common_1['HttpStatus'][_0x531d91(0x2a6)]);}await this[_0x531d91(0x2d8)][_0x531d91(0x396)](_0x391982[_0x531d91(0x36e)]['id'],_0x33ee32,-0x1);const _0x252ca7=Buffer[_0x531d91(0x2c5)](_0x1824cd);return _0x214fd4[_0x531d91(0x1c8)]('Content-type',_0x531d91(0x3cf)),_0x214fd4[_0x531d91(0x1d3)](_0x252ca7),_0x214fd4['end'](_0x252ca7),this[_0x531d91(0x1c3)]((0x0,path_1[_0x531d91(0x35f)])(_0x315d7b[_0x531d91(0x38c)])),_0x252ca7;}catch(_0xd4730d){if(_0xd4730d instanceof common_1[_0x531d91(0x202)])throw _0xd4730d;else throw new common_1[(_0x531d91(0x202))](_0xd4730d[_0x531d91(0x294)],common_1[_0x531d91(0x27e)]['BAD_REQUEST']);}}async['chatDraw'](_0x20056f,_0x3add6a){const _0xb13e9f=_0x2b658d;common_1['Logger']['log'](_0xb13e9f(0x2d7)+_0x20056f['prompt'],_0xb13e9f(0x291)),await this[_0xb13e9f(0x1fa)]['checkBadWords'](_0x20056f[_0xb13e9f(0x1db)],_0x3add6a[_0xb13e9f(0x36e)]['id']),await this[_0xb13e9f(0x2d8)][_0xb13e9f(0x205)](_0x3add6a['user']);let _0x41e0d8=[];const _0x165e63=await this[_0xb13e9f(0x1da)][_0xb13e9f(0x3e7)](model_constant_1[_0xb13e9f(0x2eb)][_0xb13e9f(0x255)]);await this[_0xb13e9f(0x2d8)][_0xb13e9f(0x340)](_0x3add6a[_0xb13e9f(0x36e)]['id'],_0x165e63);const {key:_0x4cd78c,model:_0x19cc40,proxyUrl:_0x10cdf6}=await this['formatModelToken'](_0x165e63),_0x1c8c14=_0x10cdf6+'/v1/images/generations';try{const _0x17bb57=await axios_1['default'][_0xb13e9f(0x2fe)](_0x1c8c14,{..._0x20056f,'model':_0x19cc40,'response_format':_0xb13e9f(0x303)},{'headers':{'Authorization':_0xb13e9f(0x3d0)+_0x4cd78c}});_0x41e0d8=_0x17bb57[_0xb13e9f(0x1d1)]['data'];}catch(_0x2ff32d){console['log'](_0xb13e9f(0x3c8),_0x2ff32d);const _0x24fdf4=_0x2ff32d?.[_0xb13e9f(0x2f0)]?.['status']||0x1f4,_0x47d69d=_0x2ff32d?.[_0xb13e9f(0x2f0)]?.[_0xb13e9f(0x1d1)]?.[_0xb13e9f(0x2fd)]?.[_0xb13e9f(0x294)];if(_0x24fdf4===0x1ad)throw new common_1[(_0xb13e9f(0x202))](_0xb13e9f(0x306),common_1[_0xb13e9f(0x27e)][_0xb13e9f(0x2a6)]);if(_0x24fdf4===0x190||_0x47d69d['includes'](_0xb13e9f(0x29f)))throw new common_1[(_0xb13e9f(0x202))](_0xb13e9f(0x265),common_1[_0xb13e9f(0x27e)][_0xb13e9f(0x2a6)]);if(_0x24fdf4===0x1f4)throw new common_1[(_0xb13e9f(0x202))](_0xb13e9f(0x335),common_1[_0xb13e9f(0x27e)][_0xb13e9f(0x2a6)]);if(_0x24fdf4===0x191)throw new common_1[(_0xb13e9f(0x202))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0xb13e9f(0x27e)]['BAD_REQUEST']);throw new common_1[(_0xb13e9f(0x202))]('绘制图片失败，请稍后试试吧！',common_1[_0xb13e9f(0x27e)]['BAD_REQUEST']);}const _0x1db672=[];for(const _0x26a978 of _0x41e0d8){const _0x2f59e5=_0x26a978[_0xb13e9f(0x303)][_0xb13e9f(0x2b0)](/^data:image\/\w+;base64,/,''),_0x4bc432=uuid['v4']()['slice'](0x0,0xa)+_0xb13e9f(0x3ec),_0x2b9129=Buffer[_0xb13e9f(0x2c5)](_0x2f59e5,'base64');_0x1db672[_0xb13e9f(0x3ca)](this[_0xb13e9f(0x2c7)][_0xb13e9f(0x350)]({'filename':_0x4bc432,'buffer':_0x2b9129}));}const _0x5e336a=(0x0,utils_1[_0xb13e9f(0x1fb)])(_0x3add6a),_0xd48908=await Promise[_0xb13e9f(0x3af)](_0x1db672),[_0xe9831a,_0x2e7eda]=_0x20056f[_0xb13e9f(0x2a0)]['split']('x'),_0x238c9c=_0xd48908[_0xb13e9f(0x351)](_0x1ce941=>{const _0xa571b=_0xb13e9f;return this[_0xa571b(0x317)][_0xa571b(0x243)]({'curIp':_0x5e336a,'logType':0x3,'answer':_0x1ce941,'totalTokens':0x0,'promptTokens':0x0,'model':_0xa571b(0x219),'userId':_0x3add6a[_0xa571b(0x36e)]['id'],'prompt':_0x20056f['prompt'],'completionTokens':0x0,'modelType':model_constant_1[_0xa571b(0x2eb)]['DRAW'],'type':balance_constant_1[_0xa571b(0x1b5)][_0xa571b(0x38f)],'fileInfo':JSON[_0xa571b(0x261)]({'width':_0xe9831a,'height':_0x2e7eda,'cosUrl':_0x1ce941})});}),_0x53b7f5=await Promise['all'](_0x238c9c);return await this[_0xb13e9f(0x2d8)][_0xb13e9f(0x396)](_0x3add6a[_0xb13e9f(0x36e)]['id'],_0x165e63,_0x53b7f5[0x0]['id']),_0xd48908;}async[_0x2b658d(0x2c3)](_0x4b3eb8){const _0x3e8fd4=_0x2b658d,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x3e8fd4(0x25f)][_0x3e8fd4(0x397)]([_0x3e8fd4(0x2f4),'openaiModel3MaxTokensRes',_0x3e8fd4(0x263),_0x3e8fd4(0x399),_0x3e8fd4(0x24f),_0x3e8fd4(0x34d),'openaiModel4MaxTokens32k',_0x3e8fd4(0x272),'openaiBaseUrl']);let _0x2681cf=null,_0x4f9982=null,_0x2bef64=null;const {model:_0x200fb3,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x4f6e6c,key:_0x49d80c}=_0x4b3eb8;return _0x200fb3[_0x3e8fd4(0x22e)]()['includes'](_0x3e8fd4(0x270))&&(_0x200fb3[_0x3e8fd4(0x22e)]()[_0x3e8fd4(0x2f1)]('32k')?(_0x2681cf=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x4f9982=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x2681cf=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x4f9982=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x200fb3[_0x3e8fd4(0x22e)]()[_0x3e8fd4(0x2f1)](_0x3e8fd4(0x33e))&&(_0x200fb3[_0x3e8fd4(0x22e)]()[_0x3e8fd4(0x2f1)](_0x3e8fd4(0x200))?(_0x2681cf=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x4f9982=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x2681cf=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x4f9982=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x2bef64=_0x4f6e6c||openaiBaseUrl||_0x3e8fd4(0x37f),_0x4f9982>=_0x2681cf&&(_0x4f9982=Math[_0x3e8fd4(0x27d)](_0x2681cf/0x2),common_1['Logger'][_0x3e8fd4(0x378)](_0x3e8fd4(0x36a)+_0x49d80c+'\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20'+_0x4f9982)),{'key':_0x49d80c,'model':_0x200fb3,'maxToken':_0x2681cf,'maxTokenRes':_0x4f9982,'proxyUrl':_0x2bef64};}async[_0x2b658d(0x2db)](_0x4b20f1){const _0x43ab67=_0x2b658d;try{const _0x3af782=await this['pptService'][_0x43ab67(0x24a)](_0x4b20f1),_0x5f0f3e=await this[_0x43ab67(0x22a)]['findOne']({'where':{'yooTaskId':_0x4b20f1['params']['id']}});if(!_0x5f0f3e)throw new Error(_0x43ab67(0x210));_0x5f0f3e[_0x43ab67(0x1e2)]=_0x3af782['data'][_0x43ab67(0x1e2)],_0x5f0f3e[_0x43ab67(0x2f6)]=_0x3af782['data']['state_description'],_0x5f0f3e[_0x43ab67(0x271)]=_0x3af782[_0x43ab67(0x1d1)]['progress'],_0x5f0f3e['progressUrl']=_0x3af782[_0x43ab67(0x1d1)][_0x43ab67(0x2ab)],_0x5f0f3e[_0x43ab67(0x2f9)]=_0x3af782[_0x43ab67(0x1d1)][_0x43ab67(0x238)],_0x5f0f3e[_0x43ab67(0x34f)]=_0x3af782[_0x43ab67(0x1d1)]['pptx_url'],_0x5f0f3e[_0x43ab67(0x2b1)]=_0x3af782[_0x43ab67(0x1d1)]['images_url'],_0x5f0f3e['startTime']=_0x3af782['data'][_0x43ab67(0x3e1)],_0x5f0f3e[_0x43ab67(0x258)]=_0x3af782['data'][_0x43ab67(0x338)],_0x5f0f3e[_0x43ab67(0x3a5)]=_0x3af782[_0x43ab67(0x1d1)]['preview_url'],await this[_0x43ab67(0x22a)][_0x43ab67(0x1de)](_0x5f0f3e);}catch(_0x565bfa){common_1[_0x43ab67(0x352)][_0x43ab67(0x2fd)](_0x565bfa['message'],_0x43ab67(0x29d));}}async[_0x2b658d(0x274)](_0x3412f7,_0x1c828e){const _0x30e902=_0x2b658d;try{return this[_0x30e902(0x2e6)][_0x30e902(0x1ff)](async()=>{const _0x2c13d5=_0x30e902,_0x1e0ee8=await this[_0x2c13d5(0x1da)]['getModelByType'](model_constant_1[_0x2c13d5(0x2eb)][_0x2c13d5(0x1d5)]);let _0x4ed57a={'userId':_0x3412f7[_0x2c13d5(0x36e)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x2c13d5(0x35b)],'title':_0x1c828e[_0x2c13d5(0x29c)],'text':_0x1c828e[_0x2c13d5(0x1e0)],'theme':_0x1c828e[_0x2c13d5(0x20c)]};_0x4ed57a=await this[_0x2c13d5(0x22a)]['save'](_0x4ed57a),await this['userService'][_0x2c13d5(0x26e)](_0x3412f7[_0x2c13d5(0x36e)]['id'],_0x4ed57a['id'],_0x4ed57a[_0x2c13d5(0x26d)]);const _0x3a9f91=await this[_0x2c13d5(0x33c)]['pptStructure']({'data':_0x1c828e,'baseURL':_0x1e0ee8['modelInfo'][_0x2c13d5(0x382)],'headers':{'Authorization':_0x2c13d5(0x3d0)+_0x1e0ee8['modelInfo'][_0x2c13d5(0x1df)]}});return _0x4ed57a['title']=_0x3a9f91['data']['title'],_0x4ed57a[_0x2c13d5(0x2dd)]=_0x3a9f91['data'][_0x2c13d5(0x2dd)],await this[_0x2c13d5(0x22a)][_0x2c13d5(0x1de)](_0x4ed57a),_0x4ed57a;});}catch(_0x109d11){throw new common_1[(_0x30e902(0x202))](_0x109d11['message'],common_1[_0x30e902(0x27e)]['BAD_REQUEST']);}}async['pptOnlineEditor'](_0x375741,_0x436802){const _0x1a3dea=_0x2b658d,_0x16ebfe=await this[_0x1a3dea(0x22a)][_0x1a3dea(0x2a1)]({'where':{'id':_0x436802}});if(!_0x16ebfe)throw new common_1['HttpException']('PPT不存在',common_1[_0x1a3dea(0x27e)][_0x1a3dea(0x2a6)]);await this[_0x1a3dea(0x2d8)][_0x1a3dea(0x26e)](_0x375741[_0x1a3dea(0x36e)]['id'],_0x16ebfe['id'],ppt_constant_1[_0x1a3dea(0x365)][_0x1a3dea(0x348)]);const _0x378244=await this[_0x1a3dea(0x1da)]['getModelByType'](model_constant_1['EModelType'][_0x1a3dea(0x1d5)]),_0x3397e2=await this['pptService'][_0x1a3dea(0x292)]({'baseURL':_0x378244[_0x1a3dea(0x280)][_0x1a3dea(0x382)],'headers':{'Authorization':_0x1a3dea(0x359)+_0x378244[_0x1a3dea(0x280)]['accessToken']},'data':{'id':_0x16ebfe[_0x1a3dea(0x1d6)],'expire':0x83d600}});return _0x3397e2[_0x1a3dea(0x339)]==_0x1a3dea(0x1d4)&&_0x3397e2[_0x1a3dea(0x1d1)][_0x1a3dea(0x37d)]&&(_0x16ebfe[_0x1a3dea(0x337)]=_0x3397e2['data'][_0x1a3dea(0x37d)],await this['pptTaskEntity'][_0x1a3dea(0x266)]({'id':_0x16ebfe['id']},{'editorUrl':_0x16ebfe[_0x1a3dea(0x337)]})),_0x16ebfe;}async[_0x2b658d(0x25a)](_0x45f8da,_0x5a56bd){const _0x4e6ca9=_0x2b658d,_0x556baf=await this[_0x4e6ca9(0x22a)][_0x4e6ca9(0x2a1)]({'where':{'id':_0x5a56bd}});if(!_0x556baf)throw new common_1[(_0x4e6ca9(0x202))](_0x4e6ca9(0x1be),common_1[_0x4e6ca9(0x27e)][_0x4e6ca9(0x2a6)]);await this['userService'][_0x4e6ca9(0x26e)](_0x45f8da['user']['id'],_0x556baf['id'],ppt_constant_1[_0x4e6ca9(0x365)][_0x4e6ca9(0x393)]);const _0x15849a=await this[_0x4e6ca9(0x1da)]['getModelByType'](model_constant_1[_0x4e6ca9(0x2eb)][_0x4e6ca9(0x1d5)]),_0x5897e2=await this[_0x4e6ca9(0x33c)]['pptDownload']({'baseURL':_0x15849a['modelInfo'][_0x4e6ca9(0x382)],'headers':{'Authorization':_0x4e6ca9(0x359)+_0x15849a[_0x4e6ca9(0x280)][_0x4e6ca9(0x1df)]},'params':{'id':_0x556baf[_0x4e6ca9(0x1d6)],'type':'pptx'}});return _0x5897e2[_0x4e6ca9(0x339)]==_0x4e6ca9(0x1d4)&&_0x5897e2[_0x4e6ca9(0x1d1)]['download_url']&&(_0x556baf[_0x4e6ca9(0x34f)]=_0x5897e2[_0x4e6ca9(0x1d1)][_0x4e6ca9(0x329)],await this[_0x4e6ca9(0x22a)][_0x4e6ca9(0x266)]({'id':_0x556baf['id']},{'downUrl':_0x556baf[_0x4e6ca9(0x34f)]})),_0x556baf;}[_0x2b658d(0x201)](_0x2617a7,_0x472bb3){const _0x498f0b=_0x2b658d;try{return this['connection'][_0x498f0b(0x1ff)](async()=>{const _0x2d1afc=_0x498f0b,_0x460a21=await this[_0x2d1afc(0x1da)]['getModelByType'](model_constant_1['EModelType']['PPT']);let _0x5aed35={'userId':_0x2617a7[_0x2d1afc(0x36e)]['id'],'type':ppt_constant_1[_0x2d1afc(0x365)]['COVER'],'title':_0x472bb3[_0x2d1afc(0x29c)],'text':_0x472bb3['text'],'author':_0x472bb3[_0x2d1afc(0x23f)],'color':_0x472bb3[_0x2d1afc(0x3b6)],'style':_0x472bb3[_0x2d1afc(0x2a3)]};_0x5aed35=await this[_0x2d1afc(0x22a)][_0x2d1afc(0x1de)](_0x5aed35),await this[_0x2d1afc(0x2d8)][_0x2d1afc(0x26e)](_0x2617a7[_0x2d1afc(0x36e)]['id'],_0x5aed35['id'],_0x5aed35[_0x2d1afc(0x26d)]);const _0x519ccd=await this['pptService']['pptCover']({'data':{'title':_0x472bb3[_0x2d1afc(0x29c)],'count':_0x472bb3[_0x2d1afc(0x1e0)],'user_name':_0x472bb3[_0x2d1afc(0x23f)],'color':_0x472bb3[_0x2d1afc(0x3b6)],'style':_0x472bb3[_0x2d1afc(0x2a3)]},'baseURL':_0x460a21[_0x2d1afc(0x280)][_0x2d1afc(0x382)],'headers':{'Authorization':_0x2d1afc(0x359)+_0x460a21[_0x2d1afc(0x280)][_0x2d1afc(0x1df)]}});return _0x5aed35['resCover']=_0x519ccd[_0x2d1afc(0x1d1)],await this[_0x2d1afc(0x22a)][_0x2d1afc(0x1de)](_0x5aed35),_0x5aed35;});}catch(_0x59b351){throw new common_1['HttpException'](_0x59b351[_0x498f0b(0x294)],common_1['HttpStatus'][_0x498f0b(0x2a6)]);}}['pptReCover'](_0x4dcdf8,_0x22c960){const _0x402d12=_0x2b658d;try{return this[_0x402d12(0x2e6)][_0x402d12(0x1ff)](async()=>{const _0x5449d6=_0x402d12,_0x1d3419=await this['modelsService']['getModelByType'](model_constant_1[_0x5449d6(0x2eb)][_0x5449d6(0x1d5)]);let _0x571a36={'userId':_0x4dcdf8[_0x5449d6(0x36e)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x5449d6(0x37a)],'title':_0x22c960[_0x5449d6(0x29c)],'text':_0x22c960['text'],'author':_0x22c960[_0x5449d6(0x23f)],'coverId':_0x22c960[_0x5449d6(0x3dd)]};_0x571a36=await this[_0x5449d6(0x22a)][_0x5449d6(0x1de)](_0x571a36),await this['userService'][_0x5449d6(0x26e)](_0x4dcdf8[_0x5449d6(0x36e)]['id'],_0x571a36['id'],_0x571a36[_0x5449d6(0x26d)]);const _0x451660=await this[_0x5449d6(0x33c)][_0x5449d6(0x383)]({'data':{'title':_0x22c960[_0x5449d6(0x29c)],'count':_0x22c960['text'],'user_name':_0x22c960[_0x5449d6(0x23f)],'cover_id':_0x22c960[_0x5449d6(0x3dd)]},'baseURL':_0x1d3419['modelInfo'][_0x5449d6(0x382)],'headers':{'Authorization':_0x5449d6(0x359)+_0x1d3419['modelInfo']['accessToken']}});return _0x571a36[_0x5449d6(0x312)]=_0x451660[_0x5449d6(0x1d1)],await this[_0x5449d6(0x22a)][_0x5449d6(0x1de)](_0x571a36),_0x571a36;});}catch(_0x25cefb){throw new common_1[(_0x402d12(0x202))](_0x25cefb['message'],common_1[_0x402d12(0x27e)][_0x402d12(0x2a6)]);}}async[_0x2b658d(0x26a)](_0x1299d1){const _0xd29e43=_0x2b658d;try{const _0x52d96e=[_0xd29e43(0x3ad),_0xd29e43(0x315),_0xd29e43(0x1ed),_0xd29e43(0x328),_0xd29e43(0x394),'pptEditorVipFree'],_0x3d166a=await this[_0xd29e43(0x25f)][_0xd29e43(0x397)](_0x52d96e);if(!_0x1299d1[_0xd29e43(0x36e)]||!_0x1299d1[_0xd29e43(0x36e)]['id'])throw new Error('Invalid\x20user\x20information');const _0x3945d5=[_0xd29e43(0x293),_0xd29e43(0x254),'pptEditor'],_0x2f886a=await Promise[_0xd29e43(0x3af)](_0x3945d5[_0xd29e43(0x351)](async _0x56b54a=>{const _0x35c564=_0xd29e43,_0x2f7e88=_0x3d166a[_0x56b54a+_0x35c564(0x3d7)],_0x282a88=_0x3d166a[_0x56b54a+_0x35c564(0x286)],_0x4649d5=redisKey_constant_1[_0x35c564(0x27c)]+'-'+_0x1299d1[_0x35c564(0x36e)]['id']+'-'+(_0x56b54a+_0x35c564(0x3d7)),_0x253d5e=await this['userService'][_0x35c564(0x3be)](_0x1299d1[_0x35c564(0x36e)]['id'],_0x4649d5,_0x2f7e88);return{'type':_0x56b54a,'remainCount':_0x253d5e,'freeCount':Number(_0x2f7e88),'useIntegrate':Number(_0x282a88)};}));return _0x2f886a;}catch(_0x225009){console[_0xd29e43(0x2fd)](_0xd29e43(0x2c8),_0x225009);throw _0x225009;}}[_0x2b658d(0x254)](_0x42e09c,_0x12b912){const _0x113182=_0x2b658d;try{return this[_0x113182(0x2e6)][_0x113182(0x1ff)](async()=>{const _0x360ea1=_0x113182;let _0x1783f2;const _0xbe401e=await this['modelsService'][_0x360ea1(0x30e)](model_constant_1[_0x360ea1(0x2eb)]['PPT']);if(_0x12b912[_0x360ea1(0x33a)]){_0x1783f2=await this[_0x360ea1(0x22a)][_0x360ea1(0x2a1)]({'where':{'id':_0x12b912[_0x360ea1(0x33a)]}});if(!_0x1783f2)throw new Error(_0x360ea1(0x257));}let _0x3e4680={'userId':_0x42e09c[_0x360ea1(0x36e)]['id'],'type':ppt_constant_1[_0x360ea1(0x365)]['CREATE'],'title':_0x12b912[_0x360ea1(0x29c)],'subTitle':_0x12b912[_0x360ea1(0x224)],'text':_0x12b912[_0x360ea1(0x1e0)],'catalogs':_0x12b912[_0x360ea1(0x2dd)],'contents':_0x12b912[_0x360ea1(0x30d)],'author':_0x12b912[_0x360ea1(0x23f)],'fontName':_0x12b912[_0x360ea1(0x2fc)],'transition':_0x12b912[_0x360ea1(0x326)],'complex':_0x12b912[_0x360ea1(0x241)],'coverId':_0x12b912[_0x360ea1(0x3dd)],'originId':_0x12b912[_0x360ea1(0x33a)]};_0x3e4680=await this[_0x360ea1(0x22a)][_0x360ea1(0x1de)](_0x3e4680),await this[_0x360ea1(0x2d8)]['debuctBalance4PPT'](_0x42e09c['user']['id'],_0x3e4680['id'],_0x3e4680['type']);try{const _0x1cc42b=await this[_0x360ea1(0x33c)]['pptCreate']({'data':{'text':_0x12b912[_0x360ea1(0x1e0)],'custom_data':{'title':_0x12b912['title'],'sub_title':_0x12b912[_0x360ea1(0x224)],'author':_0x12b912[_0x360ea1(0x23f)],'catalogs':_0x12b912[_0x360ea1(0x2dd)],'contents':_0x12b912[_0x360ea1(0x30d)]},'cover_id':_0x12b912[_0x360ea1(0x3dd)],'font_name':_0x12b912[_0x360ea1(0x2fc)],'transition':_0x12b912[_0x360ea1(0x326)],'complex':_0x12b912[_0x360ea1(0x241)],'user_name':_0x12b912[_0x360ea1(0x23f)],'id':_0x1783f2?.[_0x360ea1(0x1d6)]},'baseURL':_0xbe401e[_0x360ea1(0x280)]['proxyUrl'],'headers':{'Authorization':_0x360ea1(0x359)+_0xbe401e[_0x360ea1(0x280)][_0x360ea1(0x1df)]}});return _0x3e4680[_0x360ea1(0x1d6)]=_0x1cc42b[_0x360ea1(0x1d1)]['id'],await this['pptTaskEntity'][_0x360ea1(0x1de)](_0x3e4680),_0x3e4680;}catch(_0x198d42){await this[_0x360ea1(0x2d8)][_0x360ea1(0x26e)](_0x42e09c[_0x360ea1(0x36e)]['id'],_0x3e4680['id'],_0x3e4680['type'],!![]);throw new common_1[(_0x360ea1(0x202))](_0x198d42['message'],common_1[_0x360ea1(0x27e)][_0x360ea1(0x2a6)]);}});}catch(_0x543cba){throw new common_1[(_0x113182(0x202))](_0x543cba['message'],common_1['HttpStatus']['BAD_REQUEST']);}}[_0x2b658d(0x379)](_0x2d663b,_0x12f97e){const _0x4e8c0c=_0x2b658d;try{return this[_0x4e8c0c(0x2e6)]['transaction'](async()=>{const _0x361564=_0x4e8c0c,_0x6eeb51=await this[_0x361564(0x1da)]['getModelByType'](model_constant_1[_0x361564(0x2eb)]['PPT']);let _0x2e4025={'userId':_0x2d663b['user']['id'],'type':ppt_constant_1[_0x361564(0x365)]['THESIS'],'title':_0x12f97e[_0x361564(0x29c)],'color':_0x12f97e['color'],'style':_0x12f97e[_0x361564(0x2a3)],'fileUrl':_0x12f97e[_0x361564(0x288)],'pleader':_0x12f97e['pleader'],'advisor':_0x12f97e['advisor'],'school':_0x12f97e[_0x361564(0x3e8)],'schoolLogo':_0x12f97e[_0x361564(0x2e9)],'schoolPicture':_0x12f97e[_0x361564(0x236)]};_0x2e4025=await this[_0x361564(0x22a)][_0x361564(0x1de)](_0x2e4025),await this[_0x361564(0x2d8)][_0x361564(0x26e)](_0x2d663b[_0x361564(0x36e)]['id'],_0x2e4025['id'],_0x2e4025[_0x361564(0x26d)]);const _0x317930=await this[_0x361564(0x33c)][_0x361564(0x379)]({'data':{'file_key':_0x12f97e[_0x361564(0x288)],'title':_0x12f97e[_0x361564(0x29c)],'color':_0x12f97e[_0x361564(0x3b6)],'style':_0x12f97e[_0x361564(0x2a3)],'pleader':_0x12f97e[_0x361564(0x2bc)],'advisor':_0x12f97e[_0x361564(0x2ce)],'school':_0x12f97e[_0x361564(0x3e8)],'school_logo':_0x12f97e[_0x361564(0x2e9)],'school_picture':_0x12f97e[_0x361564(0x236)]},'baseURL':_0x6eeb51[_0x361564(0x280)][_0x361564(0x382)],'headers':{'Authorization':_0x361564(0x359)+_0x6eeb51[_0x361564(0x280)][_0x361564(0x1df)]}});return _0x2e4025[_0x361564(0x1d6)]=_0x317930[_0x361564(0x1d1)]['id'],await this[_0x361564(0x22a)]['save'](_0x2e4025),setTimeout(()=>this[_0x361564(0x2db)]({'baseURL':_0x6eeb51['modelInfo'][_0x361564(0x382)],'headers':{'Authorization':_0x361564(0x359)+_0x6eeb51[_0x361564(0x280)][_0x361564(0x1df)]},'params':{'id':_0x2e4025[_0x361564(0x1d6)]}}),0xbb8),_0x2e4025;});}catch(_0x22e06e){throw new common_1[(_0x4e8c0c(0x202))](_0x22e06e[_0x4e8c0c(0x294)],common_1['HttpStatus'][_0x4e8c0c(0x2a6)]);}}['pptCreateFile'](_0x48af30,_0x951fba){const _0x296cb4=_0x2b658d;try{return this[_0x296cb4(0x2e6)][_0x296cb4(0x1ff)](async()=>{const _0x22f4bc=_0x296cb4,_0xa48c52=await this[_0x22f4bc(0x1da)][_0x22f4bc(0x30e)](model_constant_1[_0x22f4bc(0x2eb)][_0x22f4bc(0x1d5)]);let _0x1a3b11={'userId':_0x48af30['user']['id'],'type':ppt_constant_1['EPPTTaskType'][_0x22f4bc(0x246)],'fileUrl':_0x951fba[_0x22f4bc(0x288)],'coverId':_0x951fba[_0x22f4bc(0x3dd)],'author':_0x951fba[_0x22f4bc(0x23f)]};_0x1a3b11=await this[_0x22f4bc(0x22a)][_0x22f4bc(0x1de)](_0x1a3b11),await this[_0x22f4bc(0x2d8)][_0x22f4bc(0x26e)](_0x48af30[_0x22f4bc(0x36e)]['id'],_0x1a3b11['id'],_0x1a3b11[_0x22f4bc(0x26d)]);const _0x5e5c85=await this[_0x22f4bc(0x33c)]['pptCreateFile']({'data':{'file_url':_0x951fba[_0x22f4bc(0x288)],'cover_id':_0x951fba[_0x22f4bc(0x3dd)],'user_name':_0x951fba['author']},'baseURL':_0xa48c52[_0x22f4bc(0x280)][_0x22f4bc(0x382)],'headers':{'Authorization':'Beare\x20'+_0xa48c52[_0x22f4bc(0x280)][_0x22f4bc(0x1df)]}});return _0x1a3b11['yooTaskId']=_0x5e5c85[_0x22f4bc(0x1d1)]['id'],await this[_0x22f4bc(0x22a)][_0x22f4bc(0x1de)](_0x1a3b11),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0xa48c52[_0x22f4bc(0x280)][_0x22f4bc(0x382)],'headers':{'Authorization':'Beare\x20'+_0xa48c52[_0x22f4bc(0x280)][_0x22f4bc(0x1df)]},'params':{'id':_0x1a3b11[_0x22f4bc(0x1d6)]}}),0xbb8),_0x1a3b11;});}catch(_0x20d3ff){throw new common_1[(_0x296cb4(0x202))](_0x20d3ff[_0x296cb4(0x294)],common_1[_0x296cb4(0x27e)][_0x296cb4(0x2a6)]);}}[_0x2b658d(0x3c0)](_0x4f6890){const _0x482dc0=_0x2b658d;return this[_0x482dc0(0x22a)][_0x482dc0(0x2a1)]({'where':{'id':_0x4f6890}});}[_0x2b658d(0x3f2)](_0x48f288,_0x35dce6){const _0x6d0955=_0x2b658d;try{return this[_0x6d0955(0x2e6)][_0x6d0955(0x1ff)](async()=>{const _0x5e514e=_0x6d0955,_0x2e3c0a=await this[_0x5e514e(0x22a)]['findOne']({'where':{'id':_0x35dce6[_0x5e514e(0x33a)]}});if(!_0x2e3c0a)throw new Error('原始任务不存在！');const _0x17b129=await this[_0x5e514e(0x1da)]['getModelByType'](model_constant_1['EModelType'][_0x5e514e(0x1d5)]);let _0x23e17a={'userId':_0x48f288[_0x5e514e(0x36e)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x5e514e(0x211)],'originId':_0x35dce6['originTaskId'],'coverId':_0x35dce6[_0x5e514e(0x3dd)],'fontName':_0x35dce6[_0x5e514e(0x2fc)],'transition':_0x35dce6['transition']};_0x23e17a=await this[_0x5e514e(0x22a)][_0x5e514e(0x1de)](_0x23e17a),await this[_0x5e514e(0x2d8)]['debuctBalance4PPT'](_0x48f288['user']['id'],_0x23e17a['id'],_0x23e17a['type']);const _0x11ed3e=await this['pptService'][_0x5e514e(0x3f2)]({'data':{'id':_0x2e3c0a['yooTaskId'],'cover_id':_0x35dce6[_0x5e514e(0x3dd)],'font_name':_0x35dce6['fontName'],'transition':_0x35dce6[_0x5e514e(0x326)]},'baseURL':_0x17b129[_0x5e514e(0x280)]['proxyUrl'],'headers':{'Authorization':_0x5e514e(0x359)+_0x17b129[_0x5e514e(0x280)][_0x5e514e(0x1df)]}});return _0x23e17a['yooTaskId']=_0x11ed3e[_0x5e514e(0x1d1)]['id'],await this[_0x5e514e(0x22a)][_0x5e514e(0x1de)](_0x23e17a),setTimeout(()=>this[_0x5e514e(0x2db)]({'baseURL':_0x17b129['modelInfo'][_0x5e514e(0x382)],'headers':{'Authorization':'Beare\x20'+_0x17b129[_0x5e514e(0x280)]['accessToken']},'params':{'id':_0x23e17a[_0x5e514e(0x1d6)]}}),0xbb8),_0x23e17a;});}catch(_0x144cb0){throw new common_1['HttpException'](_0x144cb0['message'],common_1[_0x6d0955(0x27e)][_0x6d0955(0x2a6)]);}}['pptAddPage'](_0x2c1042,_0x59adb2){const _0x33fb89=_0x2b658d;try{return this[_0x33fb89(0x2e6)][_0x33fb89(0x1ff)](async()=>{const _0x4d3da0=_0x33fb89,_0x2b166f=await this['pptTaskEntity'][_0x4d3da0(0x2a1)]({'where':{'id':_0x59adb2[_0x4d3da0(0x33a)]}});if(!_0x2b166f)throw new Error('原始任务不存在！');const _0x2d764d=await this[_0x4d3da0(0x1da)]['getModelByType'](model_constant_1[_0x4d3da0(0x2eb)]['PPT']);let _0x385144={'userId':_0x2c1042[_0x4d3da0(0x36e)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x4d3da0(0x2a9)],'originId':_0x59adb2[_0x4d3da0(0x33a)],'theme':_0x59adb2[_0x4d3da0(0x20c)],'text':_0x59adb2[_0x4d3da0(0x1e0)],'complex':_0x59adb2[_0x4d3da0(0x241)]?String(_0x59adb2[_0x4d3da0(0x241)]):'1','author':_0x59adb2[_0x4d3da0(0x23f)],'fontName':_0x59adb2['fontName'],'transition':_0x59adb2[_0x4d3da0(0x326)],'slideNumber':_0x59adb2[_0x4d3da0(0x3e0)],'slideType':_0x59adb2[_0x4d3da0(0x301)]};_0x385144=await this[_0x4d3da0(0x22a)][_0x4d3da0(0x1de)](_0x385144),await this[_0x4d3da0(0x2d8)]['debuctBalance4PPT'](_0x2c1042[_0x4d3da0(0x36e)]['id'],_0x385144['id'],_0x385144[_0x4d3da0(0x26d)]);const _0x3771f1=await this[_0x4d3da0(0x33c)][_0x4d3da0(0x3eb)]({'data':{'id':_0x2b166f[_0x4d3da0(0x1d6)],'text':_0x59adb2['text'],'complex':_0x59adb2['complex'],'user_name':_0x59adb2[_0x4d3da0(0x23f)],'font_name':_0x59adb2[_0x4d3da0(0x2fc)],'transition':_0x59adb2[_0x4d3da0(0x326)],'slide_number':_0x59adb2[_0x4d3da0(0x3e0)],'slide_type':_0x59adb2[_0x4d3da0(0x301)],'theme':_0x59adb2[_0x4d3da0(0x20c)]},'baseURL':_0x2d764d['modelInfo'][_0x4d3da0(0x382)],'headers':{'Authorization':_0x4d3da0(0x359)+_0x2d764d[_0x4d3da0(0x280)][_0x4d3da0(0x1df)]}});return _0x385144['yooTaskId']=_0x3771f1[_0x4d3da0(0x1d1)]['id'],await this[_0x4d3da0(0x22a)][_0x4d3da0(0x1de)](_0x385144),setTimeout(()=>this[_0x4d3da0(0x2db)]({'baseURL':_0x2d764d[_0x4d3da0(0x280)][_0x4d3da0(0x382)],'headers':{'Authorization':'Beare\x20'+_0x2d764d[_0x4d3da0(0x280)][_0x4d3da0(0x1df)]},'params':{'id':_0x385144[_0x4d3da0(0x1d6)]}}),0xbb8),_0x385144;});}catch(_0x298860){throw new common_1[(_0x33fb89(0x202))](_0x298860[_0x33fb89(0x294)],common_1[_0x33fb89(0x27e)][_0x33fb89(0x2a6)]);}}[_0x2b658d(0x2b3)](_0x4810b0,_0x3f1f49){const _0x2ea0f2=_0x2b658d;try{return this[_0x2ea0f2(0x2e6)]['transaction'](async()=>{const _0x5f21ff=_0x2ea0f2,_0x42a8b7=await this['pptTaskEntity'][_0x5f21ff(0x2a1)]({'where':{'id':_0x3f1f49[_0x5f21ff(0x33a)]}});if(!_0x42a8b7)throw new Error(_0x5f21ff(0x257));const _0x58060e=await this['modelsService'][_0x5f21ff(0x30e)](model_constant_1[_0x5f21ff(0x2eb)]['PPT']);let _0x3f4ef8={'userId':_0x4810b0[_0x5f21ff(0x36e)]['id'],'type':ppt_constant_1[_0x5f21ff(0x365)][_0x5f21ff(0x23b)],'originId':_0x3f1f49[_0x5f21ff(0x33a)],'notes':_0x3f1f49};_0x3f4ef8=await this[_0x5f21ff(0x22a)]['save'](_0x3f4ef8),await this['userService'][_0x5f21ff(0x26e)](_0x4810b0['user']['id'],_0x3f4ef8['id'],_0x3f4ef8[_0x5f21ff(0x26d)]);const _0xe349e1=await this[_0x5f21ff(0x33c)][_0x5f21ff(0x1b6)]({'data':{..._0x3f1f49,'id':_0x42a8b7[_0x5f21ff(0x1d6)]},'baseURL':_0x58060e[_0x5f21ff(0x280)][_0x5f21ff(0x382)],'headers':{'Authorization':_0x5f21ff(0x359)+_0x58060e[_0x5f21ff(0x280)]['accessToken']}});return _0x3f4ef8[_0x5f21ff(0x1d6)]=_0xe349e1[_0x5f21ff(0x1d1)]['id'],await this[_0x5f21ff(0x22a)]['save'](_0x3f4ef8),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x58060e[_0x5f21ff(0x280)][_0x5f21ff(0x382)],'headers':{'Authorization':_0x5f21ff(0x359)+_0x58060e[_0x5f21ff(0x280)]['accessToken']},'params':{'id':_0x3f4ef8['yooTaskId']}}),0xbb8),_0x3f4ef8;});}catch(_0x1ca069){throw new common_1[(_0x2ea0f2(0x202))](_0x1ca069[_0x2ea0f2(0x294)],common_1[_0x2ea0f2(0x27e)][_0x2ea0f2(0x2a6)]);}}async[_0x2b658d(0x391)](_0x597ce9,_0xd71fac){const _0x25118c=_0x2b658d,{page:page=0x1,size:size=0x14,keyword:_0x7d5977}=_0x597ce9,_0x30de2e=[{'delFlag':0x0,'publishFlag':0x1,'type':(0x0,typeorm_1['In'])([ppt_constant_1[_0x25118c(0x365)][_0x25118c(0x3aa)],ppt_constant_1[_0x25118c(0x365)]['FILE']])}];_0x7d5977&&_0x30de2e['push']({'title':(0x0,typeorm_1[_0x25118c(0x3e3)])('%'+_0x7d5977+'%'),'delFlag':0x0},{'subTitle':(0x0,typeorm_1[_0x25118c(0x3e3)])('%'+_0x7d5977+'%'),'delFlag':0x0});const [_0x8fc28b,_0x59cc33]=await this['pptTaskEntity']['findAndCount']({'where':_0x30de2e,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':_0x25118c(0x330)}}),_0x40440d=await this[_0x25118c(0x2d8)][_0x25118c(0x373)](_0x8fc28b,_0xd71fac);return{'rows':_0x40440d,'count':_0x59cc33};}async[_0x2b658d(0x215)](_0xc506ba,_0x2473f0){const _0x125379=_0x2b658d,_0x68f66f=_0x2473f0[_0x125379(0x36e)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x5c5451}=_0xc506ba,_0x491b1f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x20and\x20(type=\x27create\x27\x20or\x20type=\x27file\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x5c5451?_0x125379(0x296)+_0x5c5451+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%'+_0x5c5451+'%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20':'')+_0x125379(0x25b)+(_0x68f66f?_0x125379(0x31b)+_0x68f66f:'')+'\x0a\x20\x20\x20\x20\x20\x20',_0x5f03c2=await this[_0x125379(0x2e6)][_0x125379(0x1ea)](_0x125379(0x1f1)+_0x491b1f+_0x125379(0x3c9)),_0x314d9d=await this[_0x125379(0x2e6)][_0x125379(0x1ea)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.state_desc\x20as\x20stateDesc,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.editor_url\x20as\x20editorUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.images,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.preview_url\x20as\x20previewUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pdf_down_url\x20as\x20pdfDownUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.png_down_url\x20as\x20pngDownUrl\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x491b1f+_0x125379(0x35a)+size+_0x125379(0x3d6)+(page-0x1)*size+_0x125379(0x3c9));!(0x0,utils_1['isSuper'])(this['clsService'])&&_0x314d9d[_0x125379(0x364)](_0x44b22f=>{const _0x4f2165=_0x125379;_0x44b22f[_0x4f2165(0x25e)]=(0x0,utils_1[_0x4f2165(0x298)])(_0x44b22f[_0x4f2165(0x25e)]),_0x44b22f[_0x4f2165(0x2ad)]=(0x0,utils_1[_0x4f2165(0x298)])(_0x44b22f['phone']);});const _0x5333e3=await this[_0x125379(0x2d8)][_0x125379(0x373)](_0x314d9d,_0x2473f0);return{'rows':_0x5333e3,'count':Number(_0x5f03c2[0x0]?.[_0x125379(0x223)]||0x0)};}async[_0x2b658d(0x310)](_0x3caf84,_0x41b996=0x1,_0x22abb0=0xa){const _0x5324ac=_0x2b658d,{rows:_0x6f17b6,count:_0x3a5c33}=await this[_0x5324ac(0x2d8)][_0x5324ac(0x226)](_0x41b996,_0x22abb0,_0x3caf84[_0x5324ac(0x36e)]['id'],collectType_constant_1[_0x5324ac(0x367)]['PPT']),_0x2695af=await this[_0x5324ac(0x22a)][_0x5324ac(0x2b6)]({'where':{'id':(0x0,typeorm_1['In'])(_0x6f17b6[_0x5324ac(0x351)](_0x4f0d19=>_0x4f0d19['relId']))}});return{'rows':_0x2695af,'count':_0x3a5c33};}async[_0x2b658d(0x35c)](_0x2d18d0,_0x1a5100){const _0x4bcfa4=_0x2b658d;if(!_0x2d18d0['ids']||!_0x2d18d0[_0x4bcfa4(0x377)]['length'])return!![];const _0x3f9b9e={'id':(0x0,typeorm_1['In'])(_0x2d18d0['ids'])};return _0x1a5100&&(_0x3f9b9e[_0x4bcfa4(0x3b8)]=_0x1a5100),await this['pptTaskEntity'][_0x4bcfa4(0x266)](_0x3f9b9e,{'delFlag':0x1}),await this['userService'][_0x4bcfa4(0x3a7)](_0x2d18d0[_0x4bcfa4(0x377)],collectType_constant_1[_0x4bcfa4(0x367)][_0x4bcfa4(0x1d5)]),!![];}async[_0x2b658d(0x2df)](_0x14d633,_0x55510f){const _0x535584=_0x2b658d;try{let _0xd6ad1c='';return await this[_0x535584(0x2e6)][_0x535584(0x1ff)](async()=>{const _0x1c0a3d=_0x535584,_0x37654f=(0x0,utils_1[_0x1c0a3d(0x2d3)])(this['clsService']),{modelInfo:_0x339fc9}=await this['modelsService'][_0x1c0a3d(0x30e)](model_constant_1['EModelType'][_0x1c0a3d(0x256)],_0x1c0a3d(0x305));await this['validateBeforeChat']({'prompt':_0x55510f[_0x1c0a3d(0x1bb)]['text'],'user':_0x14d633[_0x1c0a3d(0x36e)],'currentRequestModel':_0x339fc9});const _0x7a49f2={'curIp':(0x0,utils_1[_0x1c0a3d(0x1fb)])(_0x14d633),'prompt':_0x55510f[_0x1c0a3d(0x1bb)]['text'],'modelId':_0x339fc9['id'],'modelType':_0x339fc9[_0x1c0a3d(0x276)],'answer':'','model':_0x339fc9['model'],'role':_0x1c0a3d(0x36e),'userId':_0x14d633[_0x1c0a3d(0x36e)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x1c0a3d(0x1b5)][_0x1c0a3d(0x1c9)],'logType':0x1,'requestOptions':JSON[_0x1c0a3d(0x261)](_0x55510f),'saasId':_0x37654f},_0x87015={..._0x7a49f2,'role':_0x1c0a3d(0x29a),'requestOptions':JSON[_0x1c0a3d(0x261)]({'prompt':_0x55510f[_0x1c0a3d(0x1bb)][_0x1c0a3d(0x1e0)],'options':{'model':_0x339fc9[_0x1c0a3d(0x34c)]}})};await this[_0x1c0a3d(0x317)][_0x1c0a3d(0x243)](_0x7a49f2),await this[_0x1c0a3d(0x317)][_0x1c0a3d(0x243)](_0x87015),await this[_0x1c0a3d(0x2d8)][_0x1c0a3d(0x396)](_0x14d633[_0x1c0a3d(0x36e)]['id'],_0x339fc9,_0x87015['id']);const _0x7ac4b2={'app':{'appid':_0x339fc9['appid'],'token':_0x339fc9[_0x1c0a3d(0x22f)],'cluster':'volcano_tts'},'user':{'uid':String(_0x14d633[_0x1c0a3d(0x36e)]['id'])},'audio':{'voice_type':_0x1c0a3d(0x2d0),'encoding':_0x1c0a3d(0x1f8)},'request':{'reqid':(0x0,crypto_1[_0x1c0a3d(0x39c)])(),'text':_0x55510f[_0x1c0a3d(0x1bb)]['text'],'operation':_0x1c0a3d(0x1ea)}},_0x199359=await this[_0x1c0a3d(0x1d2)][_0x1c0a3d(0x2df)]({'data':_0x7ac4b2,'headers':{'Authorization':_0x1c0a3d(0x21c)+_0x339fc9[_0x1c0a3d(0x1df)]}}),_0x10aa0e=chat_constant_1['EChatType']['TTS']+'-'+_0x37654f+'-'+_0x14d633['user']['id']+'-'+new Date()[_0x1c0a3d(0x36d)]()+_0x1c0a3d(0x1fc);let _0xae4b8c=(0x0,path_1[_0x1c0a3d(0x362)])(process[_0x1c0a3d(0x34e)](),_0x1c0a3d(0x2e8),_0x1c0a3d(0x386)),_0x2fd136=_0x1c0a3d(0x31a);_0x2fd136=_0x2fd136+'/'+_0x10aa0e;!(0x0,fs_1[_0x1c0a3d(0x23c)])(_0xae4b8c)&&(0x0,fs_1[_0x1c0a3d(0x268)])(_0xae4b8c,{'recursive':!![]});_0xae4b8c=(0x0,path_1[_0x1c0a3d(0x362)])(_0xae4b8c,_0x10aa0e),(0x0,fs_1['writeFileSync'])(_0xae4b8c,_0x199359[_0x1c0a3d(0x1d1)],'base64');let _0x207709=process['env'][_0x1c0a3d(0x3b7)];_0x207709[_0x1c0a3d(0x3bc)](_0x1c0a3d(0x1ca))?_0xd6ad1c=_0x207709+_0x2fd136:_0xd6ad1c=_0x1c0a3d(0x35e)+_0x207709+_0x2fd136,_0x87015[_0x1c0a3d(0x2a2)]=_0xd6ad1c,await this[_0x1c0a3d(0x317)][_0x1c0a3d(0x243)](_0x87015);}),_0xd6ad1c;}catch(_0xd76e54){throw new common_1[(_0x535584(0x202))](_0xd76e54[_0x535584(0x294)],common_1[_0x535584(0x27e)][_0x535584(0x2a6)]);}}async[_0x2b658d(0x3d3)](_0x70344e,_0x5e5b2f,_0xbef8f8){const _0x10dd77=_0x2b658d;try{let _0x191997,_0x4c0aee;return await this['connection'][_0x10dd77(0x1ff)](async()=>{const _0x41fd54=_0x10dd77,_0x10def6=(0x0,utils_1[_0x41fd54(0x2d3)])(this[_0x41fd54(0x228)]),{modelInfo:_0x442f1c}=await this['modelsService']['getModelByType'](model_constant_1[_0x41fd54(0x2eb)]['ASR'],_0x41fd54(0x349));await this['userService'][_0x41fd54(0x340)](_0x70344e['user']['id'],_0x442f1c);const _0x239bba={'groupId':_0xbef8f8,'curIp':(0x0,utils_1[_0x41fd54(0x1fb)])(_0x70344e),'prompt':_0x5e5b2f,'modelId':_0x442f1c['id'],'modelType':_0x442f1c[_0x41fd54(0x276)],'answer':'','model':_0x442f1c[_0x41fd54(0x34c)],'role':_0x41fd54(0x36e),'userId':_0x70344e[_0x41fd54(0x36e)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1['DeductionKey'][_0x41fd54(0x1c9)],'logType':0x1,'requestOptions':JSON[_0x41fd54(0x261)]({'url':_0x5e5b2f}),'saasId':_0x10def6},_0x993a6a={..._0x239bba,'role':_0x41fd54(0x29a),'requestOptions':JSON[_0x41fd54(0x261)]({'prompt':_0x5e5b2f,'options':{'model':_0x442f1c[_0x41fd54(0x34c)]}})};await this[_0x41fd54(0x317)]['saveChatLog'](_0x239bba),await this[_0x41fd54(0x317)]['saveChatLog'](_0x993a6a),await this[_0x41fd54(0x2d8)][_0x41fd54(0x396)](_0x70344e[_0x41fd54(0x36e)]['id'],_0x442f1c,_0x993a6a['id']);let _0x4f76fa=process['env'][_0x41fd54(0x3b7)];!/^http/[_0x41fd54(0x24e)](_0x4f76fa)&&(_0x4f76fa='https://'+_0x4f76fa);const _0x43ec55={'app':{'appid':_0x442f1c[_0x41fd54(0x22f)],'token':_0x442f1c[_0x41fd54(0x22f)],'cluster':'volc_auc_common'},'user':{'uid':String(_0x70344e[_0x41fd54(0x36e)]['id'])},'audio':{'url':_0x5e5b2f,'format':_0x5e5b2f['split']('.')['pop']()},'request':{'callback':_0x4f76fa+'/api/chatgpt/notify-asr'}},_0x576388=await this[_0x41fd54(0x1d2)]['asr']({'data':_0x43ec55,'headers':{'Authorization':_0x41fd54(0x21c)+_0x442f1c[_0x41fd54(0x1df)]}});_0x191997=_0x576388['id'],_0x4c0aee=await this[_0x41fd54(0x317)][_0x41fd54(0x243)](_0x993a6a);}),new Promise(_0x4ecdfd=>{const _0xf815f2=_0x10dd77;utils_1['EE'][_0xf815f2(0x1cb)](chat_constant_1[_0xf815f2(0x2b9)][_0xf815f2(0x259)]+'-'+_0x191997,async _0xb1317e=>{const _0x22d912=_0xf815f2;_0x4c0aee[_0x22d912(0x2a2)]=_0xb1317e[_0x22d912(0x1e0)],_0x4c0aee=await this[_0x22d912(0x317)]['saveChatLog'](_0x4c0aee),_0x4ecdfd(_0x4c0aee);});});}catch(_0x3268f6){throw new common_1[(_0x10dd77(0x202))](_0x3268f6[_0x10dd77(0x294)],common_1[_0x10dd77(0x27e)][_0x10dd77(0x2a6)]);}}[_0x2b658d(0x217)](_0x46170d){const _0x1c79a0=_0x2b658d;_0x46170d[_0x1c79a0(0x339)]===0x3e8&&utils_1['EE'][_0x1c79a0(0x239)](chat_constant_1['EChatType']['ASR']+'-'+_0x46170d['id'],_0x46170d);}async[_0x2b658d(0x2d5)](_0x4e03d5,_0xae7121,_0x11518c,_0xce6264){const _0x2087a3=_0x2b658d;try{let _0x122110=_0x2087a3(0x227);await this['connection'][_0x2087a3(0x1ff)](async()=>{const _0xb5689a=_0x2087a3;let _0x55437e=new Date()[_0xb5689a(0x36d)](),_0x288520=new Date()[_0xb5689a(0x36d)]();const _0x30ed12=_0x4e03d5[_0xb5689a(0x36e)]['id'],_0x332fad=(0x0,utils_1[_0xb5689a(0x2d3)])(this[_0xb5689a(0x228)]),_0x4153d7=chat_constant_1[_0xb5689a(0x2b9)][_0xb5689a(0x259)]+'-'+_0x332fad+'-'+_0x30ed12+'-'+new Date()[_0xb5689a(0x36d)]()+_0xb5689a(0x1fc),_0x1f5a86=await this[_0xb5689a(0x2c7)]['upload2Local']({'filename':_0x4153d7,'buffer':_0xce6264[_0xb5689a(0x209)]});_0x288520=new Date()['getTime'](),console[_0xb5689a(0x212)](_0xb5689a(0x3de),_0x288520-_0x55437e),_0x122110=_0x1f5a86||_0x1f5a86;const _0x1d54a7=await this[_0xb5689a(0x3d3)](_0x4e03d5,_0x1f5a86,_0x11518c?.['options']?.['groupId']);_0x55437e=new Date()['getTime'](),console['log']('[耗时打印]语音转文字耗时：',_0x55437e-_0x288520),_0x11518c[_0xb5689a(0x1db)]=_0x1d54a7['answer'];typeof _0x11518c['options']===_0xb5689a(0x1e3)&&(_0x11518c[_0xb5689a(0x2c6)]=JSON[_0xb5689a(0x31e)](_0x11518c[_0xb5689a(0x2c6)]));const _0x24f7cc=await this[_0xb5689a(0x363)](_0x11518c,_0x4e03d5,_0xae7121,![]);_0x288520=new Date()['getTime'](),console[_0xb5689a(0x212)]('[耗时打印]文字对话耗时：',_0x288520-_0x55437e);const _0x34a255=await this[_0xb5689a(0x2df)](_0x4e03d5,{'request':{'text':_0x24f7cc}});return _0x55437e=new Date()[_0xb5689a(0x36d)](),console[_0xb5689a(0x212)](_0xb5689a(0x2f5),_0x55437e-_0x288520),_0x34a255;}),_0xae7121[_0x2087a3(0x1e2)](0xc8)[_0x2087a3(0x262)](result_1[_0x2087a3(0x28f)]['success'](_0x122110));}catch(_0x4d240c){throw new common_1[(_0x2087a3(0x202))](_0x4d240c[_0x2087a3(0x294)],common_1['HttpStatus'][_0x2087a3(0x2a6)]);}}async[_0x2b658d(0x35d)](_0x198aa1,_0x3680e4){const _0x506b03=_0x2b658d,_0x18dcda=_0x3680e4[_0x506b03(0x36e)]['id'],_0x59168a=await this[_0x506b03(0x1da)][_0x506b03(0x2e4)](_0x198aa1);return{'remainCount':await this[_0x506b03(0x2d8)][_0x506b03(0x220)](_0x18dcda,_0x59168a),'freeCount':_0x59168a[_0x506b03(0x1d9)],'isVipFree':_0x59168a[_0x506b03(0x1d9)]==-0x1,'useIntegrate':_0x59168a[_0x506b03(0x251)]};}async[_0x2b658d(0x360)](_0x8d033d){const _0x5f3cc1=_0x2b658d,_0x2f2b1c=_0x8d033d['user']?.['id'],_0x174a24=await this['modelsService'][_0x5f3cc1(0x1dd)](model_constant_1[_0x5f3cc1(0x2eb)]['VIDEO']),_0xf31109=[];if(_0x2f2b1c)for(const _0x4fbe04 of _0x174a24){_0xf31109['push']({'id':_0x4fbe04['id'],'keyType':_0x4fbe04[_0x5f3cc1(0x28c)],'model':_0x4fbe04[_0x5f3cc1(0x34c)],'name':_0x4fbe04[_0x5f3cc1(0x357)],'modelType':_0x4fbe04[_0x5f3cc1(0x276)],'remainCount':await this[_0x5f3cc1(0x2d8)]['getModelVipFree'](_0x2f2b1c,_0x4fbe04),'freeCount':_0x4fbe04[_0x5f3cc1(0x1d9)],'isVipFree':_0x4fbe04[_0x5f3cc1(0x1d9)]==-0x1,'useIntegrate':_0x4fbe04[_0x5f3cc1(0x251)]});}else _0x174a24[_0x5f3cc1(0x364)](_0x4f1cd2=>{const _0x53d860=_0x5f3cc1;_0xf31109[_0x53d860(0x3ca)]({'id':_0x4f1cd2['id'],'keyType':_0x4f1cd2[_0x53d860(0x28c)],'model':_0x4f1cd2[_0x53d860(0x34c)],'name':_0x4f1cd2[_0x53d860(0x357)],'modelType':_0x4f1cd2[_0x53d860(0x276)],'remainCount':0x0,'freeCount':_0x4f1cd2[_0x53d860(0x1d9)],'isVipFree':_0x4f1cd2[_0x53d860(0x1d9)]==-0x1,'useIntegrate':_0x4f1cd2[_0x53d860(0x251)]});});return _0xf31109;}async['batchPPTResult'](){const _0x66ab94=_0x2b658d,_0x351572=await this[_0x66ab94(0x1da)][_0x66ab94(0x30e)](model_constant_1[_0x66ab94(0x2eb)][_0x66ab94(0x1d5)]),_0x1bebbd=await this['pptTaskEntity'][_0x66ab94(0x1ea)](_0x66ab94(0x3c6));_0x1bebbd['length']&&_0x1bebbd[_0x66ab94(0x364)](async _0x229e77=>{const _0xafe1f0=_0x66ab94;this['asyncPPTProgress']({'baseURL':_0x351572[_0xafe1f0(0x280)][_0xafe1f0(0x382)],'headers':{'Authorization':'Beare\x20'+_0x351572['modelInfo'][_0xafe1f0(0x1df)]},'params':{'id':_0x229e77[_0xafe1f0(0x355)]}});});const _0x2b8f4e=await this[_0x66ab94(0x22a)]['query']('select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20pdf_down_url\x20is\x20null');_0x2b8f4e[_0x66ab94(0x1d7)]&&_0x2b8f4e[_0x66ab94(0x364)](async _0x14bbf9=>{const _0x55293b=_0x66ab94,_0x2c4e78=await this[_0x55293b(0x33c)][_0x55293b(0x25a)]({'baseURL':_0x351572['modelInfo'][_0x55293b(0x382)],'headers':{'Authorization':'Beare\x20'+_0x351572[_0x55293b(0x280)][_0x55293b(0x1df)]},'params':{'id':_0x14bbf9[_0x55293b(0x355)],'type':_0x55293b(0x3a4)}});_0x2c4e78[_0x55293b(0x339)]==_0x55293b(0x1d4)&&_0x2c4e78[_0x55293b(0x1d1)][_0x55293b(0x329)]&&(_0x14bbf9[_0x55293b(0x289)]=_0x2c4e78[_0x55293b(0x1d1)][_0x55293b(0x329)],await this[_0x55293b(0x22a)]['update']({'id':_0x14bbf9['id']},{'pdfDownUrl':_0x14bbf9[_0x55293b(0x289)]}));});const _0x39c88e=await this[_0x66ab94(0x22a)][_0x66ab94(0x1ea)](_0x66ab94(0x3ee));_0x39c88e[_0x66ab94(0x1d7)]&&_0x39c88e[_0x66ab94(0x364)](async _0x21630f=>{const _0x269e4b=_0x66ab94,_0x507b47=await this[_0x269e4b(0x33c)]['pptDownload']({'baseURL':_0x351572[_0x269e4b(0x280)]['proxyUrl'],'headers':{'Authorization':_0x269e4b(0x359)+_0x351572[_0x269e4b(0x280)][_0x269e4b(0x1df)]},'params':{'id':_0x21630f[_0x269e4b(0x355)],'type':_0x269e4b(0x267)}});_0x507b47[_0x269e4b(0x339)]==_0x269e4b(0x1d4)&&_0x507b47[_0x269e4b(0x1d1)]['download_url']&&(_0x21630f[_0x269e4b(0x2ef)]=_0x507b47[_0x269e4b(0x1d1)][_0x269e4b(0x329)],await this[_0x269e4b(0x22a)][_0x269e4b(0x266)]({'id':_0x21630f['id']},{'pngDownUrl':_0x21630f[_0x269e4b(0x2ef)]}));});try{const _0x3f5ab7=store_2[_0x66ab94(0x353)][_0x66ab94(0x26c)]||0x5,_0x23e7df=[{'status':0x1,'type':ppt_constant_1['EPPTTaskType'][_0x66ab94(0x3aa)],'updatedAt':(0x0,typeorm_1['LessThan'])(new Date(Date['now']()-_0x3f5ab7*0x3c*0x3e8))}],_0x17f0b4=await this[_0x66ab94(0x22a)][_0x66ab94(0x2b6)]({'where':_0x23e7df});_0x17f0b4[_0x66ab94(0x364)](async _0x5de59a=>{const _0xe26cd9=_0x66ab94;_0x5de59a[_0xe26cd9(0x2f6)]=_0xe26cd9(0x333),_0x5de59a[_0xe26cd9(0x1e2)]=0x3,this[_0xe26cd9(0x22a)]['save'](_0x5de59a),this[_0xe26cd9(0x2d8)][_0xe26cd9(0x26e)](_0x5de59a[_0xe26cd9(0x3b8)],_0x5de59a['id'],_0x5de59a['type'],!![]);});}catch(_0x42fd7c){common_1[_0x66ab94(0x352)][_0x66ab94(0x2fd)](_0x42fd7c);}}};ChatgptService=__decorate([(0x0,common_1[_0x2b658d(0x1e8)])(),__param(0x0,(0x0,typeorm_2[_0x2b658d(0x231)])(pptTask_entity_1[_0x2b658d(0x2bd)])),__metadata(_0x2b658d(0x1bd),[typeorm_1[_0x2b658d(0x2c2)],nestjs_cls_1[_0x2b658d(0x2cf)],user_service_1[_0x2b658d(0x2fb)],file_service_1['FileService'],gpts_service_1['GptsService'],yooPPT_service_1[_0x2b658d(0x32b)],doubao_service_1[_0x2b658d(0x381)],models_service_1['ModelsService'],chatLog_service_1['ChatLogService'],lumaTask_service_1[_0x2b658d(0x1e9)],runwayTask_service_1[_0x2b658d(0x3f0)],klingTask_service_1[_0x2b658d(0x307)],sunoTask_service_1[_0x2b658d(0x2a8)],badwords_service_1['BadwordsService'],autoreply_service_1[_0x2b658d(0x3a9)],chatGroup_service_1['ChatGroupService'],globalConfig_service_1[_0x2b658d(0x1ec)],typeorm_1[_0x2b658d(0x39d)],mindTask_service_1[_0x2b658d(0x1c0)]])],ChatgptService),exports['ChatgptService']=ChatgptService;function _0x4375(){const _0x586791=['object','DrawService','pptEditor','pptOutline','message','runwayChatVideo','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','openaiBaseUrl','maskEmail','uuid','assistant','checkBadWords','title','同步PPT生成任务进度失败！','speech','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','size','findOne','answer','style','role','task_status','BAD_REQUEST','ratio','SunoTaskService','ADDPAGE','REDIS_USER','process_url','sunoMusicId','phone','getGroupInfoFromId','./zhipu','replace','images','../../common/result','pptAddNote','mindTaskId','modelConfig','find','gpts','video-task','EChatType','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','pleader','PPTTaskEntity','lockKey','REDIS_PASSWORD','importDynamic','852OAlxiG','Repository','formatModelToken','configChatGptApi','from','options','fileService','Error\x20in\x20pptConfig:','musicUploadPrice','NineStore','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','音乐生成失败，没有响应','configKimiApi','advisor','ClsService','BV700_streaming','../api/yooPPT.service','1147790LWxZVW','getReqSaasId','openAi','voiceChat','finish_reason','draw\x20paompt\x20info\x20<======*******======>\x20','userService','../globalConfig/globalConfig.service','conversationOptions','asyncPPTProgress','openAiErrHandler','catalogs','completions','tts','../../common/constants/balance.constant','unlink','prompt\x20','VIDEO','getModelById','defaultBaseUrl','connection','initOpenAi','webroot','schoolLogo','buildOptions','EModelType','EMusicTaskType','@nestjs/typeorm','gen2','png_down_url','response','includes','../../common/utils','music-task','openaiModel3MaxTokens','[耗时打印]文字转语音耗时：','stateDesc','musicCreate','__param','pageCount','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','UserService','fontName','error','post','lumaTaskService','succeed','slideType','configDoubaoApi','b64_json','content','Speech_Synthesis7418877984234656063','当前请求已过载、请稍等会儿再试试吧！','KLingTaskService','gomaxai-default-key','Catch\x20Error\x20','当前模型key余额已耗尽，请充值！','musicUpload','未配置语音模型或语音模型key，请配置并启用语音功能！','contents','getModelByType','../../common/constants/redisKey.constant','pptCollectPage','3UfbHXC','resCover','ChatgptService','syncLumaTask','pptOutlineVipFree','buildSystemMessage','chatLogService','compileNetwork','内容提取失败','/upload','\x20AND\x20p.user_id\x20=\x20','Unauthorized','chatGroupService','parse','abort','delta','REDIS_HOST','then','baseURL','SUCCEEDED','promptTokens','transition','sunoTaskService','pptCreateVipFree','download_url','../api/sunoTask.service','YooPPTService','\x20key\x20->\x20','------------------------DEBUG-----------------------------','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','当前模型不是聊天模型','DESC','keyv','../file/file.service','timeout','preset','绘制图片失败，请检查你的提示词是否有非法描述！','apiBaseUrl','editorUrl','updated_at','code','originTaskId','----------------------DDDD2---------------------','pptService','i2v','gpt-3','modelId','validateBalance4Chat','sendMessageFromBaidu','video','task_id','../chatGroup/chatGroup.service','createReadStream','set','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','EDITOR','AUC7419233800922468658','parentMessageId','request\x20gpt\x20','model','openaiModel4MaxTokensRes','cwd','downUrl','uploadFile','map','Logger','PPTConfig','user_prompt','yoo_task_id','../../common/constants/ppt.constant','modelName','OTHER','Beare\x20','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','STRUCTURE','pptDel','getUserModelFree','https://','resolve','getVideoModelFree','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','join','chatProcess','forEach','EPPTTaskType','validateBeforeChat','UserCollectType','../../common/store','application/octet-stream;\x20charset=utf-8','key:\x20','未获取到模型基础配置，请前往后台配置并启用','chatMusic','getTime','user','modelOptions','listAssetsBychatLogIds','result','/api/chatLog/notify-Suno-upload?id=','mergeCollectData','\x20--aspect_ratio\x20','completed','completionParams','ids','debug','pptCreateThesis','RECOVER','模型秘钥错误或模型余额不足','make_instrumental','url','musicCreateVipFree','https://api.openai.com','UPLOAD','DoubaoService','proxyUrl','pptReCover','gpt_description_prompt','creat','upload','chatMusicLyrics','\x20--expand_prompt\x20','../chatLog/chatLog.service','Incorrect\x20API\x20key\x20provided','XunFeiSpark','path','1202139wKHUqx','addOneIfOdd','PAINT_TYPE','sendMessage','pptRecPage','listUndoneVideo','Download','pptEditorPrice','modelSubType','deductBalance4Chat','getConfigByKeys','klingVideoTask','openaiModel3MaxTokens16kRes','videos','lumaVideoTask','randomUUID','Connection','key','transcriptions','https://api.moonshot.cn/v1','当前模型key已被封禁','abortController','语音转换失败','pdf','previewUrl','REDIS_PORT','uncollectByRelIds','Content-type','AutoreplyService','CREATE','getCurrentModel','unifiedFormattingResponse','pptOutlinePrice','./../user/user.service','all','nestjs-cls','catch','/v1','gomaxAiStore','trim','saveUseLog','color','GOMAXAI_HOST','userId','chat-error','function','isCustom','startsWith','audio','getKeyFree','视频生成失败，没有响应','pptDetail','\x20image_url\x20','getModelConfig','../api/runwayTask.service','system','metadata','select\x20*\x20from\x20ppt_task\x20where\x20\x20(status<>2\x20or\x20status\x20is\x20null\x20)and\x20yoo_task_id\x20is\x20not\x20null','arrayBuffer','openai-draw','\x0a\x20\x20\x20\x20\x20\x20','push','typeorm','chat','../../common/constants/chat.constant','default','application/octet-stream','Bearer\x20','CHAT','-----------------------------mindTask--------------------------','asr','choices','is_end','\x20OFFSET\x20','VipFree','./baidu','saveMindTask','chatgpt','本次调用:\x20','appId','coverId','[耗时打印]保存文件耗时：','extend','slideNumber','created_at','@keyv/redis','Like','140HHctes','checkAutoReply','get','getRandomKey','school','kling-video_std_5','../api/klingTask.service','pptAddPage','.png','conversationId','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20png_down_url\x20is\x20null','decorate','RunwayTaskService','getRandomAudioKey','pptChangeTheme','kimiUpload','DeductionKey','pptNote','usage','groupId','env','chatMuiscTask','request','chatMusicUpload','design:paramtypes','PPT不存在','语音转文本失败','MindTaskService','服务异常、请重新试试吧！！！','chatTask','removeFile','parseAndSaveVideo','buildMessageFromParentMessageId','debuctBalance4Muisc','abs','setHeader','CHAT_TYPE','http','once','chatLogId','statusCode','pathname','end','./helper','data','doubaoService','write','200','PPT','yooTaskId','length','msg','vipFreeNum','modelsService','prompt','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','getModelsByModelType','save','accessToken','text','7ULggyc','status','string','模型秘钥错误或模型金额不足，请联系管理员！','../../common/constants/collectType.constant','可翻译成其他语言。','musicUploadVipFree','Injectable','LumaTaskService','query','axios','GlobalConfigService','pptCreatePrice','file-extract','__esModule','music','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','saveGptsUseLog','refundBalance4Chat','openaiTimeoutMs','response.length','MUSIC','\x20model:\x20','mp3','@nestjs/common','badwordsService','getClientIp','.mp3','__decorate','setData','transaction','16k','pptCover','HttpException','failed','sunoMusicTask','checkUserStatus','../mindTask/mindTask.service','split','task_result','buffer','aac','157536LIciMy','theme','defineProperty','systemPreMessage','config','PPT\x20任务不存在！','THEME','log','LYRICS','sendMessageFromXunFei','pptPage','当前模型key余额已耗尽','notifyAsr','whisper-1','DALL-E2','remove\x20file\x20%s\x20success','thirdId','Bearer;','completionTokens','requestFromGpt','totalTokens','getModelVipFree','listTaskByIds','mind','count','subTitle','systemMessage','collectPage','https://yuyin.qumao518.vip/upload/0001-0-45-1727599485154.mp3','clsService','klingTaskService','pptTaskEntity','toString','./spark','listByGroupId','toLowerCase','appid','__metadata','InjectRepository','removeSpecialCharacters','notify_hook','454674YJyCMX','success','schoolPicture','/api/chatLog/notify-Suno-lyrics?id=','page_count','emit','mergedOptions','ADDNOTES','existsSync','musicLyricsVipFree','close','author','openai','complex','toISOString','saveChatLog','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','gomaxai-chatlog','FILE','runwayTaskService','\x20image_end_url\x20','1377189LmujuH','pptResult','apiKey','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20',',\x20模型名称:\x20','test','openaiModel4MaxTokens','state','deduct','333333333333333','OpenAiErrorCodeMessage','pptCreate','DRAW','TTS','原始任务不存在！','endTime','ASR','pptDownload','\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','image','messageStore','email','globalConfigService','signal','stringify','json','openaiModel3MaxTokens16k','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','update','png','mkdirSync','mindTaskService','pptConfig','redis://','pptTimeoutMs','type','debuctBalance4PPT','./store','gpt-4','progress','openaiModel4MaxTokens32kRes','tts-1','pptStructure','errMsg','modelType','message_id','/api/v3','key\x20%s,\x20proxy\x20%s','files','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','VIP_FREE','floor','HttpStatus','1237254XHQqnF','modelInfo','runwayVideoTask','video_url','suno-v3','../api/lumaTask.service','400\x20error','Price','gptsService','fileUrl','pdf_down_url','56PHoRNC','last_image','keyType','create','3654800edaeRO','Result'];_0x4375=function(){return _0x586791;};return _0x4375();}