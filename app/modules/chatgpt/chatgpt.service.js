'use strict';function _0x1a8d(){const _0x4c92d6=['application/octet-stream','213023vcmGcz','log','gomaxAiStore','removeSpecialCharacters','floor','user_prompt','51lroDNe','debug','unifiedFormattingResponse','extend','chatRealTime','uploadFile','Please\x20check\x20the\x20back-end\x20console','sendMessageFromZhipu','VIDEO','toFixed','openaiModel3MaxTokensRes','type','pageCount','user','当前模型不是聊天模型','THESIS','Connection','all','EModelType','importDynamic','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','resCover','YYYY年M月D日','Repository','saveChatLog','pptCreate','key','slice','design:paramtypes','/v1/images/generations','asyncPPTProgress','is_end','maskEmail','sendMessageFromBaidu','initOpenAi',',\x20mv\x20','secret','remove\x20file\x20%s\x20success',',\x20continue_at\x20','application/octet-stream;\x20charset=utf-8','created_at','data','模型秘钥错误或模型金额不足，请联系管理员！','object','修改白名单成功','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','slideNumber','pptx_url','forEach','PPT','remove\x20file\x20','.png','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','complex','当前记录不存在！','findOne','conversationOptions','author','json','Catch\x20Error\x20','../gpts/gpts.service','openaiBaseUrl','answer','fanyi\x20mj-associate','pptCreateThesis','NineStore','then','getKeyDetail','setData','set','当前请求已过载、请稍等会儿再试试吧！','progress','usage','gomaxai-default-key','catch','stateDesc','addOneIfOdd','end','school','createReadStream','\x20key\x20->\x20','gptsService','addWhiteUser','getClientIp','images_url','PAYMENT_REQUIRED','提供了错误的模型秘钥','lockKey','\x20model:\x20','function','GlobalConfigService','GptsService','color','pptTaskEntity','message','ADDPAGE','endTime','prompt','ChatgptService','../autoreply/autoreply.service','pleader','keyv','pptResult','completionTokens','redis://','chatProcess','debuctBalance4PPT','originTaskId','systemMessage','userService','buildSystemMessage','video-task','模型秘钥错误或模型余额不足','creat','bad\x20response\x20status\x20code\x20307','/v1','progressUrl','gpt-4','videoTask','ids','UserEntity','size','style','downUrl','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','\x20OFFSET\x20','sunoMusicId','preset','pptStructure','syncLumaTask','./../user/user.service','defineProperty','../api/yooPPT.service','state','REDIS_PORT','gomaxai-chatlog','\x0a\x20\x20\x20\x20\x20\x20','page_count','https://api.openai.com','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','filter','../file/file.service','schoolLogo','modelInfo','saveGptsUseLog','base64','../chatLog/chatLog.service','修改白名单失败','gpt-3','chatMusic','params','uuid','modelsService','defaultBaseUrl','RECOVER','pptCreateFile','65684FReYSo','conversationId','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','pptAddPage','totalTokens','../badwords/badwords.service','model','abortController','getGptModelList','YYYY-MM-DD','34752762IPdtog','../chatGroup/chatGroup.service','333333333333333','PPT\x20任务不存在！','/v1/dashboard/billing/subscription','chatLogService','../models/models.service','gpts','error','chatTask','同步PPT生成任务进度失败！','format','username',',\x20模型名称:\x20','write','COVER','/v1/models','buildOptions','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','sendMessage','getUuid','draw\x20paompt\x20info\x20<======*******======>\x20','fileUrl','key:\x20','keyType','findAndCount','HttpException','onModuleInit','./zhipu','env','text','音乐生成失败，没有响应','modelName','openaiTimeoutMs','parseAndSaveVideo','response','saveUseLog','path','InjectRepository','default','5053506BWkVlj','userId','DESC','绘制图片失败，请检查你的提示词是否有非法描述！','post','proxyUrl','luma-video','未配置语音模型或语音模型key，请配置并启用语音功能！','completionParams','5337512twiPeo','push','fileService','setHeader','Method\x20not\x20implemented.','removeFile','Unauthorized','./baidu','/v1/dashboard/billing/usage?start_date=','绘制图片失败，此次绘画被拒绝了！','total_usage','__decorate','transaction','role','abort','pptCover','本次调用:\x20','decorate','Logger','openaiModel3MaxTokens16k','musicTask','assistant','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','STRUCTURE','16k','state_description','map','response.length','refundBalance4Chat','openai-draw','slideType','openaiModel3MaxTokens','openaiModel4MaxTokens','DALL-E2','prompt\x20','chatgpt','checkUserStatus','find','\x20image_end_url\x20','__param','formatModelToken','checkBadWords','openaiModel4MaxTokensRes','DRAW','getCurrentModel','userEntity','getRandomKey','chatLogId','FileService','&end_date=','原始任务不存在！','advisor',',\x20continue_clip_id\x20','toLowerCase','count','UserService','32k','./pptTask.entity','当前模型key余额已耗尽，请充值！','statusCode','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.nickname\x20LIKE\x20(\x27%','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','theme','MUSIC','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','YooPPTService','key\x20%s,\x20proxy\x20%s','includes','用户已在白名单中！','__metadata','MoreThan','pptChangeTheme','systemPreMessage','accessToken','transcriptions','get','./store','MODEL_LIST','subtract','ChatGroupService','getModelProxyUrl','lumaTaskService','result','modelId','HttpStatus','config','../../common/constants/errorMessage.constant','signal','save','getCurrentModelByChatGroupId','Incorrect\x20API\x20key\x20provided','autoreplyService','toISOString','THEME','parseAndSaveMusic','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','DrawService','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','baseURL','length','unlink','b64_json','apiKey','validateBeforeChat','CHAT','__esModule','suno-v3','listTaskByIds','openAiErrHandler','super','transition','pptAddNote','getConfigs','contents','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.phone\x20LIKE\x20(\x27%','971978pTFlXg','pptService','BadwordsService','query','\x20AND\x20p.user_id\x20=\x20','Content-type',',\x20make_instrumental\x20','PPTTaskEntity','fileAnalysis','../../common/utils/date','OTHER','globalConfigService','服务异常、请重新试试吧！！！','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','400\x20error','badwordsService','create','../../common/utils','绘制图片失败，请稍后试试吧！','email','BAD_REQUEST','当前模型key已被封禁','CHAT_TYPE','catalogs','ChatGPTAPI','resolve','chatGroupService','当前模型key余额已耗尽','requestFromGpt','schoolPicture','validateBalance4Chat','7PYCHwx','getUserWhiteList','parentMessageId','pptReCover','getModelConfig','coverId','whiteListEntity','../../common/constants/balance.constant','获取模型列表失败，请检查你的key是否正确！','update','affected','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','thirdId','checkAutoReply','audio2text\x20','openAi','EPPTTaskType','status','stringify','../globalConfig/globalConfig.service','compileNetwork','getAppById','buildMessageFromParentMessageId','messageStore','deductBalance4Chat','from','\x20--aspect_ratio\x20','split','Bearer\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','AutoreplyService','./spark','XunFeiSpark','errMsg','DeductionKey','openai','fontName','ModelsService','connection','getGroupInfoFromId','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../../common/constants/ppt.constant','tts-1',',\x20tags\x20','replace','promptTokens','4439990vdRZJh','yooTaskId','\x20--expand_prompt\x20','@nestjs/common','title','temperature','audio','pptDel','whisper-1','语音转换失败','openaiModel4MaxTokens32k','OpenAiErrorCodeMessage','getModelByType'];_0x1a8d=function(){return _0x4c92d6;};return _0x1a8d();}const _0x940958=_0x4fb8;(function(_0x4de9d,_0x4d826d){const _0x46d394=_0x4fb8,_0x305c47=_0x4de9d();while(!![]){try{const _0x5aada0=-parseInt(_0x46d394(0x14e))/0x1+-parseInt(_0x46d394(0x29e))/0x2+-parseInt(_0x46d394(0x154))/0x3*(parseInt(_0x46d394(0x1f0))/0x4)+-parseInt(_0x46d394(0x140))/0x5+-parseInt(_0x46d394(0x222))/0x6+-parseInt(_0x46d394(0x112))/0x7*(parseInt(_0x46d394(0x22b))/0x8)+parseInt(_0x46d394(0x1fa))/0x9;if(_0x5aada0===_0x4d826d)break;else _0x305c47['push'](_0x305c47['shift']());}catch(_0x3b7dde){_0x305c47['push'](_0x305c47['shift']());}}}(_0x1a8d,0x769b3));var __decorate=this&&this[_0x940958(0x236)]||function(_0x4453b6,_0x3b891d,_0x5a94b5,_0xcf71c){const _0x30cbaa=_0x940958;var _0x1b1065=arguments[_0x30cbaa(0x28e)],_0x28cc5f=_0x1b1065<0x3?_0x3b891d:_0xcf71c===null?_0xcf71c=Object['getOwnPropertyDescriptor'](_0x3b891d,_0x5a94b5):_0xcf71c,_0x20cb57;if(typeof Reflect===_0x30cbaa(0x17f)&&typeof Reflect[_0x30cbaa(0x23c)]===_0x30cbaa(0x1ad))_0x28cc5f=Reflect['decorate'](_0x4453b6,_0x3b891d,_0x5a94b5,_0xcf71c);else{for(var _0x614b10=_0x4453b6[_0x30cbaa(0x28e)]-0x1;_0x614b10>=0x0;_0x614b10--)if(_0x20cb57=_0x4453b6[_0x614b10])_0x28cc5f=(_0x1b1065<0x3?_0x20cb57(_0x28cc5f):_0x1b1065>0x3?_0x20cb57(_0x3b891d,_0x5a94b5,_0x28cc5f):_0x20cb57(_0x3b891d,_0x5a94b5))||_0x28cc5f;}return _0x1b1065>0x3&&_0x28cc5f&&Object[_0x30cbaa(0x1d7)](_0x3b891d,_0x5a94b5,_0x28cc5f),_0x28cc5f;},__metadata=this&&this[_0x940958(0x270)]||function(_0x484c40,_0x33a169){const _0x4a8b89=_0x940958;if(typeof Reflect===_0x4a8b89(0x17f)&&typeof Reflect['metadata']===_0x4a8b89(0x1ad))return Reflect['metadata'](_0x484c40,_0x33a169);},__param=this&&this[_0x940958(0x252)]||function(_0x3aa2b4,_0x3fcee8){return function(_0x41f246,_0x1312a1){_0x3fcee8(_0x41f246,_0x1312a1,_0x3aa2b4);};};function _0x4fb8(_0x3452af,_0x1836e1){const _0x1a8d24=_0x1a8d();return _0x4fb8=function(_0x4fb870,_0x3928f7){_0x4fb870=_0x4fb870-0x104;let _0x45255c=_0x1a8d24[_0x4fb870];return _0x45255c;},_0x4fb8(_0x3452af,_0x1836e1);}Object['defineProperty'](exports,_0x940958(0x294),{'value':!![]}),exports[_0x940958(0x1b6)]=void 0x0;const file_service_1=require(_0x940958(0x1e1)),user_service_1=require(_0x940958(0x1d6)),openai_1=require(_0x940958(0x135)),common_1=require(_0x940958(0x143)),errorMessage_constant_1=require(_0x940958(0x281)),utils_1=require(_0x940958(0x104)),axios_1=require('axios'),balance_constant_1=require(_0x940958(0x119)),chatLog_service_1=require(_0x940958(0x1e6)),uuid=require(_0x940958(0x1eb)),fs_1=require('fs'),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x940958(0x1f5)),autoreply_service_1=require(_0x940958(0x1b7)),globalConfig_service_1=require(_0x940958(0x125)),whiteList_entity_1=require('./whiteList.entity'),user_entity_1=require('../user/user.entity'),chatGroup_service_1=require(_0x940958(0x1fb)),models_service_1=require(_0x940958(0x200)),baidu_1=require(_0x940958(0x232)),helper_1=require('./helper'),store_1=require(_0x940958(0x277)),zhipu_1=require(_0x940958(0x216)),spark_1=require(_0x940958(0x131)),model_constant_1=require('../../common/constants/model.constant'),fs_2=require('fs'),path_1=require(_0x940958(0x21f)),gpts_service_1=require(_0x940958(0x190)),date_1=require(_0x940958(0x2a7)),yooPPT_service_1=require(_0x940958(0x1d8)),pptTask_entity_1=require(_0x940958(0x264)),ppt_constant_1=require(_0x940958(0x13b)),lumaTask_service_1=require('../api/lumaTask.service');let ChatgptService=class ChatgptService{constructor(_0x4a6bfc,_0x272468,_0x3bba0b,_0x3a2b3b,_0x23159e,_0xe4f27d,_0x20dfc2,_0x1d5aca,_0x21afc1,_0x20b8f4,_0x3ed031,_0x1813d8,_0x1bce8e,_0x5c6a93,_0x4db86f){const _0x49d30f=_0x940958;this[_0x49d30f(0x258)]=_0x4a6bfc,this[_0x49d30f(0x1b1)]=_0x272468,this[_0x49d30f(0x118)]=_0x3bba0b,this['chatLogService']=_0x3a2b3b,this['userService']=_0x23159e,this[_0x49d30f(0x22d)]=_0xe4f27d,this[_0x49d30f(0x2ad)]=_0x20dfc2,this[_0x49d30f(0x286)]=_0x1d5aca,this[_0x49d30f(0x2a9)]=_0x21afc1,this[_0x49d30f(0x10d)]=_0x20b8f4,this[_0x49d30f(0x1ec)]=_0x3ed031,this[_0x49d30f(0x1a5)]=_0x1813d8,this['pptService']=_0x1bce8e,this[_0x49d30f(0x27c)]=_0x5c6a93,this[_0x49d30f(0x138)]=_0x4db86f,this['defaultBaseUrl']=_0x49d30f(0x1de),this['messageStore']=null,this[_0x49d30f(0x150)]=null,this[_0x49d30f(0x230)]=_0x122ef0=>{const _0x363a1e=_0x49d30f;return fs_1[_0x363a1e(0x221)][_0x363a1e(0x28f)](_0x122ef0,_0x1b2ada=>{const _0x302007=_0x363a1e;_0x1b2ada?console[_0x302007(0x14f)](_0x302007(0x186),_0x1b2ada):console[_0x302007(0x14f)](_0x302007(0x179),_0x122ef0);});};}async[_0x940958(0x215)](){const _0x46c30b=_0x940958;let _0x1c3f7a=await(0x0,utils_1[_0x46c30b(0x167)])(_0x46c30b(0x24e));_0x1c3f7a=_0x1c3f7a?.[_0x46c30b(0x221)]?_0x1c3f7a[_0x46c30b(0x221)]:_0x1c3f7a,this['api']=_0x1c3f7a[_0x46c30b(0x10b)];let _0xae858=await(0x0,utils_1[_0x46c30b(0x167)])(_0x46c30b(0x1b9));_0xae858=_0xae858?.['default']?_0xae858[_0x46c30b(0x221)]:_0xae858;let _0x3c5386=await(0x0,utils_1[_0x46c30b(0x167)])('@keyv/redis');_0x3c5386=_0x3c5386?.[_0x46c30b(0x221)]?_0x3c5386[_0x46c30b(0x221)]:_0x3c5386;const _0x24108e=+process['env'][_0x46c30b(0x1da)],_0xe3f5dd=process['env']['REDIS_HOST'],_0x2c12a8=process['env']['REDIS_PASSWORD'],_0xcc2cc5=process[_0x46c30b(0x217)]['REDIS_USER'],_0x177743=_0x46c30b(0x1bc)+(_0xcc2cc5||'')+':'+(_0x2c12a8||'')+'@'+_0xe3f5dd+':'+_0x24108e,_0x101dfa=new _0x3c5386(_0x177743);this[_0x46c30b(0x129)]=new _0xae858({'store':_0x101dfa,'namespace':_0x46c30b(0x1db)}),this[_0x46c30b(0x150)]=new store_1[(_0x46c30b(0x195))]({'store':this['messageStore'],'namespace':'chat'}),!this[_0x46c30b(0x121)]&&this[_0x46c30b(0x176)]();}['initOpenAi'](){const _0x41c2c4=_0x940958;this['openAi']=new openai_1['default']({'apiKey':_0x41c2c4(0x19d),'baseURL':this[_0x41c2c4(0x1ed)]+_0x41c2c4(0x1c7)});}async[_0x940958(0x116)](_0xc748ba){const _0x495925=_0x940958,{type:_0x172043,groupId:_0x28c5c2,modelType:_0x310b16}=_0xc748ba;let _0x38380f,_0x1afebf;_0x172043&&_0x172043===_0x495925(0x201)?(_0x1afebf=await this[_0x495925(0x1a5)][_0x495925(0x139)](_0x28c5c2),_0x38380f=_0x1afebf[_0x495925(0x27e)]):_0x1afebf=await this[_0x495925(0x10d)]['getGroupInfoFromId'](_0x28c5c2);let _0x5a298d;if(_0x1afebf)_0x5a298d=JSON['parse'](_0x1afebf[_0x495925(0x280)]);else _0x310b16?_0x5a298d=await this[_0x495925(0x1ec)][_0x495925(0x14c)](_0x310b16):_0x5a298d=await this[_0x495925(0x1ec)][_0x495925(0x14c)](model_constant_1[_0x495925(0x166)][_0x495925(0x2a8)]);if(!_0x5a298d)throw new common_1['HttpException']('未获取到模型基础配置，请前往后台配置并启用',common_1[_0x495925(0x27f)][_0x495925(0x107)]);return{'appId':_0x38380f,'modelConfig':_0x5a298d};}async[_0x940958(0x1c2)](_0xcc22a1){const _0x134c31=_0x940958,_0xd4611f=this;let _0x252824='',_0x3872fa='',{type:_0x3581b6,appId:_0x3533d8,prompt:_0x3aa888,custom:_0x43a8ac,usingNetwork:_0x5b9963,systemMessage:_0x346505,customSystemMessage:_0x366b43}=_0xcc22a1;const _0x3cbf84=async function(){const _0x4989ed=_0x4fb8,_0x181faa=new Date()[_0x4989ed(0x287)]()[_0x4989ed(0x12d)]('T')[0x0];return _0x3872fa=await _0xd4611f[_0x4989ed(0x2a9)][_0x4989ed(0x29b)]([_0x4989ed(0x273)]),_0x3872fa+('\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'+_0x181faa);};if(_0x3533d8){const _0x2168fd=await this[_0x134c31(0x1a5)][_0x134c31(0x127)](_0x3533d8,0x1);if(!_0x2168fd)throw new common_1[(_0x134c31(0x214))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x134c31(0x27f)]['BAD_REQUEST']);_0x2168fd['preset']&&(_0x346505=_0x2168fd[_0x134c31(0x1d3)]);}else{if(_0x43a8ac)_0x346505=_0x346505;else _0x366b43?_0x346505=_0x366b43:_0x3581b6!==_0x134c31(0x201)&&(_0x346505=await _0x3cbf84());}return _0x5b9963&&(_0x252824=await(0x0,utils_1[_0x134c31(0x126)])(_0x3aa888),!_0x3872fa&&(_0x346505=await _0x3cbf84())),{'systemMessage':_0x346505,'netWorkPrompt':_0x252824};}async[_0x940958(0x257)](_0x24d680){const _0x5e6d08=_0x940958,{type:_0x15b96f,custom:_0x132b37,groupId:_0x290eec,modelConfig:_0x26f316}=_0x24d680;let _0x121fb4=null;if(!_0x132b37&&!_0x15b96f){const _0x1c3eb=await this[_0x5e6d08(0x1ec)][_0x5e6d08(0x14c)](model_constant_1[_0x5e6d08(0x166)][_0x5e6d08(0x293)],_0x26f316['modelInfo'][_0x5e6d08(0x1f6)]);_0x121fb4=_0x1c3eb['modelInfo'];}else{if(_0x15b96f===_0x5e6d08(0x201))_0x121fb4=await this[_0x5e6d08(0x1a5)][_0x5e6d08(0x284)](_0x290eec);else _0x132b37?_0x121fb4=await this[_0x5e6d08(0x1ec)][_0x5e6d08(0x259)](model_constant_1['EModelType']['OTHER']):_0x121fb4=await this[_0x5e6d08(0x1ec)][_0x5e6d08(0x259)](model_constant_1[_0x5e6d08(0x166)][_0x5e6d08(0x293)]);}if(!_0x121fb4)throw new common_1[(_0x5e6d08(0x214))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x5e6d08(0x27f)][_0x5e6d08(0x107)]);return _0x15b96f==='gpts'?_0x26f316[_0x5e6d08(0x1e3)]['model']=_0x121fb4[_0x5e6d08(0x1f6)]:_0x121fb4[_0x5e6d08(0x1f6)]=_0x26f316[_0x5e6d08(0x1e3)][_0x5e6d08(0x1f6)],_0x121fb4;}async[_0x940958(0x292)](_0x3bfbaf){const _0x39b88f=_0x940958,{user:_0x3219b9,prompt:_0x2cb629,currentRequestModel:_0x198d90}=_0x3bfbaf;await this[_0x39b88f(0x1c1)]['checkUserStatus'](_0x3219b9),await this[_0x39b88f(0x2ad)][_0x39b88f(0x254)](_0x2cb629,_0x3219b9['id']),await this['userService']['validateBalance4Chat'](_0x3219b9['id'],_0x198d90);}async[_0x940958(0x20b)](_0x40bbfa,_0x13be67,_0x376ddb){const _0x1c31e4=_0x940958,_0xc0f24e=await this[_0x1c31e4(0x2a9)][_0x1c31e4(0x29b)]([_0x1c31e4(0x21b)]),_0x45f0d5=_0xc0f24e||0x493e0,_0xcdf432={'timeoutMs':+_0x45f0d5,'systemMessage':_0x13be67||'','parentMessageId':_0x40bbfa||'','completionParams':{'temperature':0.8,'model':_0x376ddb[_0x1c31e4(0x1f6)]}},_0x2a7888=await this[_0x1c31e4(0x27b)](_0x376ddb['proxyUrl']),_0x5d1f20=0x1f40,_0x1ce124=0x1000,_0x412b86=new this['api']({'maxModelTokens':_0x5d1f20,'apiBaseUrl':_0x2a7888+_0x1c31e4(0x1c7),'messageStore':this[_0x1c31e4(0x129)],'apiKey':(0x0,utils_1[_0x1c31e4(0x151)])(_0x376ddb[_0x1c31e4(0x16e)]),'maxResponseTokens':_0x1ce124>=_0x5d1f20?Math['abs'](Math[_0x1c31e4(0x152)](_0x5d1f20/0x2)):_0x1ce124});return console[_0x1c31e4(0x14f)]('apiKey',_0x412b86['apiKey']),console[_0x1c31e4(0x14f)]('mergedOptions',_0xcdf432),console[_0x1c31e4(0x14f)]('apiBaseUrl',_0x2a7888+_0x1c31e4(0x1c7)),{'api':_0x412b86,'options':_0xcdf432};}async[_0x940958(0x297)](_0x20ed28,_0x3d2abe){const _0x3b79c6=_0x940958;let _0x2588d3='',_0x4afcf0=_0x20ed28[_0x3b79c6(0x266)];return!_0x2588d3&&(_0x2588d3=errorMessage_constant_1[_0x3b79c6(0x14b)][_0x4afcf0]?errorMessage_constant_1[_0x3b79c6(0x14b)][_0x4afcf0]:_0x3b79c6(0x2aa)),_0x20ed28?.[_0x3b79c6(0x1b2)][_0x3b79c6(0x26e)](_0x3b79c6(0x11d))&&(await this[_0x3b79c6(0x1ec)]['lockKey'](_0x3d2abe['id'],_0x3b79c6(0x20c),-0x1),_0x2588d3=_0x3b79c6(0x108)),_0x20ed28?.[_0x3b79c6(0x266)]===0x1ad&&_0x20ed28[_0x3b79c6(0x1b2)][_0x3b79c6(0x26e)](_0x3b79c6(0x26b))&&(await this[_0x3b79c6(0x1ec)][_0x3b79c6(0x1ab)](_0x3d2abe['id'],_0x3b79c6(0x268),-0x3),_0x2588d3=_0x3b79c6(0x10e)),_0x20ed28?.[_0x3b79c6(0x266)]===0x191&&_0x20ed28[_0x3b79c6(0x1b2)]['includes'](_0x3b79c6(0x285))&&(await this['modelsService'][_0x3b79c6(0x1ab)](_0x3d2abe['id'],'模型秘钥错误或模型余额不足',-0x2),_0x2588d3='模型秘钥错误或模型金额不足，请联系管理员！'),_0x20ed28?.['statusCode']===0x191&&(_0x2588d3=_0x3b79c6(0x17e)),_0x20ed28?.['statusCode']===0x191&&_0x20ed28[_0x3b79c6(0x1b2)]['includes']('Unauthorized')&&(await this[_0x3b79c6(0x1ec)][_0x3b79c6(0x1ab)](_0x3d2abe['id'],_0x3b79c6(0x1c4),-0x2),_0x2588d3=_0x3b79c6(0x17e)),_0x20ed28?.[_0x3b79c6(0x266)]===0x194&&_0x20ed28[_0x3b79c6(0x1b2)]['includes'](_0x3b79c6(0x181))&&(await this['modelsService'][_0x3b79c6(0x1ab)](_0x3d2abe['id'],'当前模型不是聊天模型',-0x4),_0x2588d3=_0x3b79c6(0x2ab)),_0x2588d3;}async[_0x940958(0x1bd)](_0x5d2eb7,_0x43cd48,_0x1508fe){const _0x24878e=_0x940958;try{const _0x36181f=_0x43cd48['abortController'],{options:options={},prompt:_0x4d559d,cusromPrompt:_0x3c104d}=_0x5d2eb7,{groupId:_0x23fbe4,usingNetwork:_0x5033e4,parentMessageId:_0x2bc067,type:_0x687b53}=options,{appId:_0x1eff8a,modelConfig:_0x490834}=await this['getModelConfig']({'type':_0x687b53,'groupId':_0x23fbe4}),{systemMessage:_0x4e7e9d,netWorkPrompt:_0x205c94}=await this['buildSystemMessage']({'type':_0x687b53,'appId':_0x1eff8a,'prompt':_0x4d559d,'usingNetwork':_0x5033e4,'custom':_0x3c104d,'systemMessage':_0x5d2eb7[_0x24878e(0x1c0)],'customSystemMessage':_0x490834[_0x24878e(0x1e3)][_0x24878e(0x1c0)]}),_0x55ff40=await this[_0x24878e(0x257)]({'type':_0x687b53,'groupId':_0x23fbe4,'modelConfig':_0x490834,'custom':_0x3c104d});await this[_0x24878e(0x292)]({'prompt':_0x4d559d,'currentRequestModel':_0x55ff40,'user':_0x43cd48[_0x24878e(0x161)]});const _0x2c19b1=await this[_0x24878e(0x286)][_0x24878e(0x11f)](_0x4d559d);_0x1508fe&&_0x1508fe[_0x24878e(0x22e)](_0x24878e(0x2a3),_0x24878e(0x17b));if(_0x2c19b1&&_0x1508fe){const _0x3ae0aa={'message':_0x2c19b1,'code':0x1f4};return _0x1508fe[_0x24878e(0x208)](JSON[_0x24878e(0x124)](_0x3ae0aa)),_0x1508fe[_0x24878e(0x1a1)]();}const {api:_0x2cccbb,options:_0x3c503a}=await this[_0x24878e(0x20b)](options[_0x24878e(0x114)],_0x4e7e9d,_0x55ff40);options[_0x24878e(0x1f6)]&&(_0x3c503a[_0x24878e(0x22a)]['model']=options['model']);let {model:_0x2a0b40,rounds:_0x55cc9c,keyType:_0x570d9a,modelType:_0x15c13a,id:_0x546dd3,topN:_0x413b62}=_0x490834[_0x24878e(0x1e3)];const {key:_0x343f57,modelName:_0x2be4d1,id:_0x177701,accessToken:_0x126971}=_0x55ff40;_0x2a0b40=_0x3c503a[_0x24878e(0x22a)][_0x24878e(0x1f6)],_0x1508fe&&_0x1508fe['status'](0xc8);let _0x3f328e=null,_0x275cce=null;const _0x4aab64=(0x0,utils_1[_0x24878e(0x1a7)])(_0x43cd48),_0x3d492c={'appId':_0x1eff8a,'curIp':_0x4aab64,'prompt':_0x4d559d,'groupId':_0x23fbe4,'modelId':_0x546dd3,'modelType':_0x15c13a,'answer':'','model':_0x2a0b40,'role':_0x24878e(0x161),'userId':_0x43cd48['user']['id'],'completionTokens':0x0,'type':balance_constant_1['DeductionKey'][_0x24878e(0x109)],'logType':_0x687b53===_0x24878e(0x201)?0x2:0x1,'requestOptions':JSON[_0x24878e(0x124)]({'options':null,'prompt':_0x4d559d})},_0x370d29={..._0x3d492c,'role':_0x24878e(0x240),'requestOptions':JSON[_0x24878e(0x124)]({'prompt':_0x4d559d,'options':{'model':_0x2a0b40,'temperature':_0x413b62}})};try{if(_0x1508fe){let _0x50bb8c=null,_0x5cf0ed=![];_0x1508fe['on']('close',async()=>{const _0x4ccc15=_0x24878e;if(_0x5cf0ed)return;_0x36181f[_0x4ccc15(0x239)]();const _0x597823=0x0,_0x3ebec2=0x0,_0x5177f3=_0x597823+_0x3ebec2;_0x3d492c[_0x4ccc15(0x1f4)]=_0x597823,_0x3d492c[_0x4ccc15(0x13f)]=_0x597823,await this[_0x4ccc15(0x1ff)][_0x4ccc15(0x16c)](_0x3d492c),_0x370d29['answer']=_0x50bb8c?.['text'],_0x370d29[_0x4ccc15(0x1f4)]=_0x5177f3,_0x370d29[_0x4ccc15(0x13f)]=_0x597823,_0x370d29[_0x4ccc15(0x1bb)]=_0x3ebec2,_0x370d29[_0x4ccc15(0x18c)]=JSON[_0x4ccc15(0x124)]({'conversationId':_0x50bb8c?.[_0x4ccc15(0x1f1)],'model':_0x2a0b40,'parentMessageId':_0x50bb8c?.['id'],'temperature':_0x413b62});const _0x21baed=await this['chatLogService']['saveChatLog'](_0x370d29);await this[_0x4ccc15(0x1c1)][_0x4ccc15(0x12a)](_0x43cd48[_0x4ccc15(0x161)]['id'],_0x55ff40,_0x21baed['id']);}),_0x1508fe['on'](_0x24878e(0x202),_0x2400f3=>{const _0x1f64e3=_0x24878e;console[_0x1f64e3(0x14f)](_0x2400f3);});if(Number(_0x570d9a)===0x1){let _0x451d8a=!![];_0x3f328e=await _0x2cccbb['sendMessage'](_0x5033e4?_0x205c94:_0x4d559d,{..._0x3c503a,'onProgress':_0x2530aa=>{const _0x343927=_0x24878e;_0x1508fe[_0x343927(0x208)](_0x451d8a?JSON[_0x343927(0x124)](_0x2530aa):'\x0a'+JSON[_0x343927(0x124)](_0x2530aa)),_0x451d8a=![],_0x50bb8c=_0x2530aa;},'abortSignal':_0x36181f[_0x24878e(0x282)]}),_0x5cf0ed=!![];}if(Number(_0x570d9a)===0x2){let _0xafc694=!![];const _0x41fcff=await this['gomaxAiStore'][_0x24878e(0x128)](_0x5033e4?_0x205c94:_0x4d559d,{'parentMessageId':_0x2bc067,'maxRounds':(0x0,helper_1[_0x24878e(0x1a0)])(_0x55cc9c)});_0x3f328e=await(0x0,baidu_1[_0x24878e(0x175)])(_0x5033e4?_0x205c94:_0x41fcff,{'temperature':_0x413b62,'accessToken':_0x126971,'model':_0x2a0b40,'onProgress':_0x12393f=>{const _0x3d8da3=_0x24878e;_0x1508fe[_0x3d8da3(0x208)](_0xafc694?JSON[_0x3d8da3(0x124)](_0x12393f):'\x0a'+JSON[_0x3d8da3(0x124)](_0x12393f)),_0xafc694=![],_0x50bb8c=_0x12393f;}}),_0x5cf0ed=!![];}if(Number(_0x570d9a)===0x3){let _0x23e89e=!![];const _0x9ed2e5=await this[_0x24878e(0x150)][_0x24878e(0x128)](_0x5033e4?_0x205c94:_0x4d559d,{'parentMessageId':_0x2bc067,'maxRounds':(0x0,helper_1[_0x24878e(0x1a0)])(_0x55cc9c)});_0x3f328e=await(0x0,zhipu_1[_0x24878e(0x15b)])(_0x5033e4?_0x205c94:_0x9ed2e5,{'temperature':_0x413b62,'key':_0x343f57,'model':_0x2a0b40,'onProgress':_0x324a46=>{const _0x202979=_0x24878e;_0x1508fe[_0x202979(0x208)](_0x23e89e?JSON[_0x202979(0x124)](_0x324a46):'\x0a'+JSON[_0x202979(0x124)](_0x324a46)),_0x23e89e=![],_0x50bb8c=_0x324a46;}}),_0x5cf0ed=!![];}if(Number(_0x570d9a)===0x4){let _0x580ed9=!![];const {key:_0x8a53c2,appid:_0x4e6987,secret:_0x39a9cb,model:_0x2410f5}=_0x55ff40,_0x5c0d7f=await this['gomaxAiStore']['buildMessageFromParentMessageId'](_0x5033e4?_0x205c94:_0x4d559d,{'parentMessageId':_0x2bc067,'maxRounds':(0x0,helper_1[_0x24878e(0x1a0)])(_0x55cc9c)}),_0xec9198=new spark_1[(_0x24878e(0x132))]({'appid':_0x4e6987,'secret':_0x39a9cb,'key':_0x8a53c2});_0x3f328e=await _0xec9198['sendMessageFromXunFei'](_0x5033e4?_0x205c94:_0x5c0d7f,{'temperature':_0x413b62,'model':_0x2410f5,'onProgress':_0x4f0b9a=>{const _0x5a5f50=_0x24878e;_0x1508fe[_0x5a5f50(0x208)](_0x580ed9?JSON[_0x5a5f50(0x124)](_0x4f0b9a):'\x0a'+JSON['stringify'](_0x4f0b9a)),_0x580ed9=![],_0x50bb8c=_0x4f0b9a;},'abortController':_0x36181f}),_0x5cf0ed=!![];}const _0x2bef7e={'id':this['gomaxAiStore']['getUuid'](),'text':_0x4d559d,'role':_0x24878e(0x161),'name':undefined,'usage':null,'parentMessageId':_0x2bc067,'conversationId':_0x3f328e?.[_0x24878e(0x1f1)]||null};_0x275cce={'model':_0x2a0b40,'parentMessageId':_0x2bc067},await this[_0x24878e(0x150)][_0x24878e(0x198)](_0x2bef7e);const _0x2eb1de={'id':_0x3f328e?.['id']||this[_0x24878e(0x150)][_0x24878e(0x20e)](),'text':_0x3f328e[_0x24878e(0x218)],'role':_0x24878e(0x240),'name':undefined,'usage':_0x3f328e['usage'],'parentMessageId':_0x2bef7e['id'],'conversationId':_0x3f328e?.['conversationId']};await this['gomaxAiStore'][_0x24878e(0x198)](_0x2eb1de),_0x275cce={'model':_0x2a0b40,'parentMessageId':_0x2bef7e['id']};}else console[_0x24878e(0x14f)](_0x24878e(0x193)),_0x3f328e=await _0x2cccbb[_0x24878e(0x20d)](_0x5033e4?_0x205c94:_0x4d559d,_0x3c503a);const _0x478fb8=(0x0,helper_1['unifiedFormattingResponse'])(_0x570d9a,_0x3f328e,_0x275cce),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x478fb8['usage'];_0x687b53===_0x24878e(0x201)?await this[_0x24878e(0x1a5)][_0x24878e(0x1e4)](_0x177701,total_tokens):await this['modelsService'][_0x24878e(0x21e)](_0x177701,total_tokens);_0x3d492c[_0x24878e(0x1f4)]=total_tokens,await this[_0x24878e(0x1ff)]['saveChatLog'](_0x3d492c),_0x370d29[_0x24878e(0x192)]=_0x478fb8?.[_0x24878e(0x218)],_0x370d29['totalTokens']=total_tokens,_0x370d29[_0x24878e(0x13f)]=prompt_tokens,_0x370d29['completionTokens']=completion_tokens,_0x370d29['conversationOptions']=JSON['stringify']({'conversationId':_0x3f328e['conversationId'],'model':_0x2a0b40,'parentMessageId':_0x3f328e['id'],'temperature':_0x413b62});const _0x44c01e=await this[_0x24878e(0x1ff)][_0x24878e(0x16c)](_0x370d29);return common_1[_0x24878e(0x23d)][_0x24878e(0x155)](_0x24878e(0x23b)+_0x43cd48['user']['id']+_0x24878e(0x1ac)+_0x2a0b40+'\x20key\x20->\x20'+_0x343f57+_0x24878e(0x207)+_0x2be4d1,_0x24878e(0x1b6)),_0x3f328e[_0x24878e(0x27d)]&&(_0x3f328e['result']=''),_0x3f328e[_0x24878e(0x173)]=!![],_0x3f328e[_0x24878e(0x25a)]=_0x44c01e['id'],_0x1508fe?(await this[_0x24878e(0x1c1)]['deductBalance4Chat'](_0x43cd48['user']['id'],_0x55ff40,_0x44c01e['id']),_0x1508fe[_0x24878e(0x208)]('\x0a'+JSON[_0x24878e(0x124)](_0x3f328e))):_0x3f328e['text'];}catch(_0x43056a){_0x370d29['answer']=_0x43056a[_0x24878e(0x1b2)],_0x370d29[_0x24878e(0x133)]=_0x43056a[_0x24878e(0x1b2)],_0x370d29['conversationOptions']=JSON[_0x24878e(0x124)]({'conversationId':_0x3f328e?.['conversationId'],'model':_0x2a0b40,'parentMessageId':_0x3f328e?.['id'],'temperature':_0x413b62}),await this['chatLogService'][_0x24878e(0x16c)](_0x370d29),console[_0x24878e(0x14f)]('chat-error',_0x343f57,_0x43056a);const _0x26c5b5=_0x43056a['statusCode'];_0x26c5b5===0x190&&console[_0x24878e(0x14f)](_0x24878e(0x2ac),_0x43056a,_0x43056a[_0x24878e(0x1b2)]);if(_0x43056a[_0x24878e(0x123)]&&_0x43056a[_0x24878e(0x123)]===0x192){const _0x1c3169={'message':_0x24878e(0x18f)+_0x43056a[_0x24878e(0x1b2)],'code':0x192};if(_0x1508fe)return _0x1508fe[_0x24878e(0x208)](JSON[_0x24878e(0x124)](_0x1c3169));else throw new common_1[(_0x24878e(0x214))](_0x43056a['message'],common_1[_0x24878e(0x27f)][_0x24878e(0x1a9)]);}if(!_0x26c5b5){if(_0x1508fe)return _0x1508fe[_0x24878e(0x208)](JSON[_0x24878e(0x124)]({'message':_0x43056a['message'],'code':0x1f4}));else throw new common_1[(_0x24878e(0x214))](_0x43056a[_0x24878e(0x1b2)],common_1[_0x24878e(0x27f)]['BAD_REQUEST']);}const _0x393b7b=await this[_0x24878e(0x297)](_0x43056a,_0x55ff40),_0x548c3f={'message':_0x393b7b||'Please\x20check\x20the\x20back-end\x20console','code':_0x26c5b5===0x191?0x191:_0x26c5b5||0x1f4};if(_0x1508fe)_0x1508fe['statusCode']=0x190,_0x1508fe[_0x24878e(0x208)](JSON['stringify'](_0x548c3f));else throw new common_1[(_0x24878e(0x214))](_0x548c3f[_0x24878e(0x1b2)],common_1['HttpStatus'][_0x24878e(0x107)]);}finally{_0x1508fe&&_0x1508fe[_0x24878e(0x1a1)]();}}catch(_0x19f0ad){if(_0x19f0ad instanceof common_1[_0x24878e(0x214)])throw _0x19f0ad;else throw new common_1[(_0x24878e(0x214))](_0x19f0ad[_0x24878e(0x1b2)],common_1[_0x24878e(0x27f)][_0x24878e(0x107)]);}}async[_0x940958(0x23f)](_0x12eecb){const _0x594f3d=_0x940958,{api:_0x44151a,userId:_0xfdd1f4,prompt:_0x3fd054,options:_0x58061c,answerLogDTO:_0x404f40,currentRequestModel:_0x1d5cd5}=_0x12eecb;try{const _0x3b2280=await _0x44151a[_0x594f3d(0x20d)](_0x3fd054,{..._0x58061c,'onProgress':_0x1ca346=>{}});let _0xd4c81b={'model':_0x58061c['completionParams'][_0x594f3d(0x1f6)],'parentMessageId':_0x58061c[_0x594f3d(0x114)]};const _0x3657bf=(0x0,helper_1[_0x594f3d(0x156)])(0x1,_0x3b2280,_0xd4c81b),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x3657bf[_0x594f3d(0x19c)];await this[_0x594f3d(0x1ec)][_0x594f3d(0x21e)](_0x1d5cd5['id'],total_tokens),_0x404f40[_0x594f3d(0x192)]=_0x3657bf?.[_0x594f3d(0x218)],_0x404f40[_0x594f3d(0x1f4)]=total_tokens,_0x404f40[_0x594f3d(0x13f)]=prompt_tokens,_0x404f40['completionTokens']=completion_tokens,_0x404f40[_0x594f3d(0x18c)]=JSON[_0x594f3d(0x124)]({'conversationId':_0x3b2280[_0x594f3d(0x1f1)],'model':_0x3657bf['model'],'parentMessageId':_0x3b2280['id'],'temperature':_0x58061c[_0x594f3d(0x22a)][_0x594f3d(0x145)]}),await this['chatLogService']['saveChatLog'](_0x404f40),common_1[_0x594f3d(0x23d)][_0x594f3d(0x155)]('本次调用:\x20'+_0xfdd1f4+_0x594f3d(0x1ac)+_0x1d5cd5[_0x594f3d(0x1f6)]+'\x20key\x20->\x20'+_0x1d5cd5[_0x594f3d(0x16e)]+_0x594f3d(0x207)+_0x1d5cd5[_0x594f3d(0x21a)],_0x594f3d(0x1b6));if(!_0x404f40['answer'])throw new Error(_0x594f3d(0x219));await this['chatLogService'][_0x594f3d(0x289)](_0x404f40);}catch(_0x187b55){console[_0x594f3d(0x14f)]('music-task',_0x1d5cd5[_0x594f3d(0x16e)],_0x187b55);const _0x445975=await this[_0x594f3d(0x297)](_0x187b55,_0x1d5cd5);_0x404f40['errMsg']=_0x445975,await this[_0x594f3d(0x1ff)]['saveChatLog'](_0x404f40),await this[_0x594f3d(0x1c1)]['refundBalance4Chat'](_0xfdd1f4,_0x1d5cd5,_0x404f40['id']);}}async[_0x940958(0x1ca)](_0x2abc5a){const _0x4a8ab9=_0x940958,{data:_0x17e5b3,answerLogDTO:_0xbec319,currentRequestModel:_0xb00010}=_0x2abc5a;try{let _0x334161;await this[_0x4a8ab9(0x1c1)][_0x4a8ab9(0x12a)](_0xbec319[_0x4a8ab9(0x223)],_0xb00010,_0xbec319['id']);_0x17e5b3[_0x4a8ab9(0x11e)]?_0x334161=await this[_0x4a8ab9(0x27c)][_0x4a8ab9(0x157)]({'data':_0x17e5b3,'baseURL':_0xb00010['proxyUrl'],'headers':{'Authorization':_0x4a8ab9(0x12e)+_0xb00010[_0x4a8ab9(0x16e)]}},_0x17e5b3[_0x4a8ab9(0x11e)]):_0x334161=await this[_0x4a8ab9(0x27c)][_0x4a8ab9(0x1c5)]({'data':_0x17e5b3,'baseURL':_0xb00010['proxyUrl'],'headers':{'Authorization':_0x4a8ab9(0x12e)+_0xb00010[_0x4a8ab9(0x16e)]}});await this['modelsService'][_0x4a8ab9(0x21e)](_0xb00010['id'],0x0),_0xbec319[_0x4a8ab9(0x1f4)]=0x0,_0xbec319[_0x4a8ab9(0x13f)]=0x0,_0xbec319[_0x4a8ab9(0x1bb)]=0x0,_0xbec319[_0x4a8ab9(0x192)]=_0x334161[_0x4a8ab9(0x1d9)],_0xbec319[_0x4a8ab9(0x18c)]=JSON[_0x4a8ab9(0x124)]({'model':_0xb00010[_0x4a8ab9(0x1f6)],'parentMessageId':_0x334161['id']}),await this[_0x4a8ab9(0x1ff)]['saveChatLog'](_0xbec319),common_1[_0x4a8ab9(0x23d)]['debug'](_0x4a8ab9(0x23b)+_0xbec319[_0x4a8ab9(0x223)]+_0x4a8ab9(0x1ac)+_0xb00010[_0x4a8ab9(0x1f6)]+_0x4a8ab9(0x1a4)+_0xb00010[_0x4a8ab9(0x16e)]+_0x4a8ab9(0x207)+_0xb00010[_0x4a8ab9(0x21a)],_0x4a8ab9(0x1b6));if(!_0xbec319[_0x4a8ab9(0x192)])throw new Error('视频生成失败，没有响应');await this['chatLogService'][_0x4a8ab9(0x21c)](_0xbec319,_0x334161);}catch(_0x466b1f){console[_0x4a8ab9(0x14f)](_0x4a8ab9(0x1c3),_0xb00010[_0x4a8ab9(0x16e)],_0x466b1f);const _0x4c6728=await this[_0x4a8ab9(0x297)](_0x466b1f,_0xb00010);_0xbec319[_0x4a8ab9(0x133)]=_0x4c6728,await this['chatLogService'][_0x4a8ab9(0x16c)](_0xbec319),await this[_0x4a8ab9(0x1c1)][_0x4a8ab9(0x247)](_0xbec319['userId'],_0xb00010,_0xbec319['id']);}}async[_0x940958(0x203)](_0x2a04ac){const _0x17b08e=_0x940958;try{const {req:_0x45992e,model:_0xa08a7b,modelType:_0x3136ac,datas:_0x530e71}=_0x2a04ac,{prompt:_0xa82829,options:options={},cusromPrompt:_0x1bc6a1}=_0x530e71,{groupId:_0x2bf25b,usingNetwork:_0x1c7aaf,type:_0x3215bd}=options,{appId:_0x2948b0,modelConfig:_0x428079}=await this['getModelConfig']({'modelType':_0x3136ac}),{systemMessage:_0x6ecabf,netWorkPrompt:_0x400f9c}=await this['buildSystemMessage']({'type':_0x3215bd,'appId':_0x2948b0,'prompt':_0xa82829,'usingNetwork':_0x1c7aaf,'custom':_0x1bc6a1,'systemMessage':_0x530e71[_0x17b08e(0x1c0)],'customSystemMessage':_0x428079[_0x17b08e(0x1e3)]['systemMessage']}),_0x5df833=await this[_0x17b08e(0x1ec)]['getRandomKey'](_0x3136ac);_0x5df833[_0x17b08e(0x1f6)]=_0xa08a7b,_0x428079[_0x17b08e(0x1e3)][_0x17b08e(0x1f6)]=_0xa08a7b,await this[_0x17b08e(0x292)]({'prompt':_0xa82829,'currentRequestModel':_0x5df833,'user':_0x45992e[_0x17b08e(0x161)]});const {api:_0x3a1844,options:_0x48b8e9}=await this['buildOptions'](options['parentMessageId'],_0x6ecabf,_0x5df833);let {id:_0x573f31,topN:_0x4d4eac}=_0x428079[_0x17b08e(0x1e3)];const _0x11c4c3=0x0,_0xee78b1=0x0,_0xd8a311=_0x11c4c3+_0xee78b1,_0x489da0=(0x0,utils_1[_0x17b08e(0x1a7)])(_0x45992e),_0x4404fa={'appId':_0x2948b0,'curIp':_0x489da0,'prompt':_0xa82829,'groupId':_0x2bf25b,'modelId':_0x573f31,'modelType':_0x3136ac,'answer':'','model':_0xa08a7b,'role':_0x17b08e(0x161),'userId':_0x45992e[_0x17b08e(0x161)]['id'],'completionTokens':0x0,'totalTokens':_0xd8a311,'type':balance_constant_1[_0x17b08e(0x134)][_0x17b08e(0x109)],'logType':_0x3215bd===_0x17b08e(0x201)?0x2:0x1,'requestOptions':JSON[_0x17b08e(0x124)]({'options':null,'prompt':_0xa82829})},_0x4922c2={..._0x4404fa,'role':'assistant','requestOptions':JSON[_0x17b08e(0x124)]({'prompt':_0xa82829,'options':{'model':_0xa08a7b,'temperature':_0x4d4eac}})};await this[_0x17b08e(0x1ff)][_0x17b08e(0x16c)](_0x4404fa);const _0x454466=await this['chatLogService']['saveChatLog'](_0x4922c2);await this[_0x17b08e(0x1c1)]['deductBalance4Chat'](_0x45992e[_0x17b08e(0x161)]['id'],_0x5df833,_0x454466['id']);if(_0x3136ac===model_constant_1[_0x17b08e(0x166)][_0x17b08e(0x26a)])this[_0x17b08e(0x23f)]({'api':_0x3a1844,'userId':_0x45992e['user']['id'],'currentRequestModel':_0x5df833,'options':_0x48b8e9,'answerLogDTO':_0x454466,'prompt':_0x1c7aaf?_0x400f9c:_0xa82829});else _0x3136ac===model_constant_1[_0x17b08e(0x166)][_0x17b08e(0x15c)]&&this['videoTask']({'data':_0x530e71,'currentRequestModel':_0x5df833,'answerLogDTO':_0x454466});return _0x454466;}catch(_0x460adb){if(_0x460adb instanceof common_1[_0x17b08e(0x214)])throw _0x460adb;else throw new common_1[(_0x17b08e(0x214))](_0x460adb[_0x17b08e(0x1b2)],common_1[_0x17b08e(0x27f)][_0x17b08e(0x107)]);}}async[_0x940958(0x1e9)](_0xc0b586,_0x57edff){const _0x597da9=_0x940958;let {mv:_0xd0d785,tags:_0x538329,title:_0x144ab0,prompt:_0xf58a6,continue_at:_0x1223a1,continue_clip_id:_0x3ca516,make_instrumental:_0xad19bc}=_0xc0b586,_0x4a57cb=_0x597da9(0x24d)+_0xf58a6;return _0xd0d785&&(_0x4a57cb=_0x4a57cb+_0x597da9(0x177)+_0xd0d785),_0x538329&&(_0x4a57cb=_0x4a57cb+_0x597da9(0x13d)+_0x538329),_0x144ab0&&(_0x4a57cb=_0x4a57cb+',\x20title\x20'+_0x144ab0),_0x1223a1&&(_0x4a57cb=_0x4a57cb+_0x597da9(0x17a)+_0x1223a1),_0x3ca516&&(_0x4a57cb=_0x4a57cb+_0x597da9(0x25f)+_0x3ca516),_0x4a57cb=_0x4a57cb+_0x597da9(0x2a4)+_0xad19bc,_0xc0b586['prompt']=_0x4a57cb,_0xf58a6=_0x4a57cb,this[_0x597da9(0x203)]({'req':_0x57edff,'datas':_0xc0b586,'model':_0xd0d785||_0x597da9(0x295),'modelType':model_constant_1[_0x597da9(0x166)][_0x597da9(0x26a)]});}async['chatVideo'](_0x3f5344,_0x489dd0){const _0x216228=_0x940958;let {model:_0x24fa61,prompt:_0x28f36e,expand_prompt:_0x57c4ba,aspect_ratio:_0x41df3f,image_url:_0x2fafcb,image_end_url:_0x51629e}=_0x3f5344,_0x10bfc9=_0x216228(0x24d)+_0x28f36e+_0x216228(0x142)+_0x57c4ba+_0x216228(0x12c)+_0x41df3f;return _0x2fafcb&&(_0x10bfc9=_0x10bfc9+'\x20image_url\x20'+_0x2fafcb),_0x51629e&&(_0x10bfc9=_0x10bfc9+_0x216228(0x251)+_0x51629e),_0x3f5344[_0x216228(0x1b5)]=_0x10bfc9,_0x3f5344[_0x216228(0x153)]=_0x28f36e,this[_0x216228(0x203)]({'req':_0x489dd0,'datas':_0x3f5344,'model':_0x24fa61||_0x216228(0x228),'modelType':model_constant_1[_0x216228(0x166)][_0x216228(0x15c)]});}async[_0x940958(0x1d5)](){const _0xed9a06=_0x940958,_0xc9a6a6=await this[_0xed9a06(0x1ff)]['listUndoneVideo']();if(!_0xc9a6a6['length'])return;const _0x30304a=[],_0x117361=new Map();_0xc9a6a6[_0xed9a06(0x184)](_0x5a2b72=>{const _0x42d78e=_0xed9a06;_0x30304a[_0x42d78e(0x22c)](_0x5a2b72['id']),_0x117361[_0x42d78e(0x199)](_0x5a2b72['id'],_0x5a2b72);});const _0x2dfa2d=await this[_0xed9a06(0x1ff)]['listAssetsBychatLogIds'](_0x30304a),_0x2c7215=[],_0x47694c=new Map();_0x2dfa2d['forEach'](_0x286911=>{const _0x67682=_0xed9a06;_0x2c7215[_0x67682(0x22c)](_0x286911[_0x67682(0x1d2)]),_0x47694c[_0x67682(0x199)](_0x286911[_0x67682(0x1d2)],_0x286911);});const _0x2f6691=await this[_0xed9a06(0x1ec)][_0xed9a06(0x259)](model_constant_1[_0xed9a06(0x166)][_0xed9a06(0x15c)]),_0x142314=await this[_0xed9a06(0x27c)][_0xed9a06(0x296)]({'baseURL':_0x2f6691[_0xed9a06(0x227)],'headers':{'Authorization':_0xed9a06(0x12e)+_0x2f6691['key']},'data':{'ids':_0x2c7215}});for(let _0x1d8cf4=0x0;_0x1d8cf4<_0x142314[_0xed9a06(0x28e)];_0x1d8cf4++){const _0x3a907b=_0x142314[_0x1d8cf4],_0x5d15f3=_0x47694c[_0xed9a06(0x276)](_0x3a907b['task_id']),_0x22852a=_0x117361['get'](_0x5d15f3[_0xed9a06(0x25a)]);await this[_0xed9a06(0x1ff)][_0xed9a06(0x21c)](_0x22852a,_0x3a907b[_0xed9a06(0x17d)]);}}async[_0x940958(0x158)](_0x18b000,_0x2b3fe1,_0x213eb6){const _0x27ab51=_0x940958;try{const {audio:_0x36e344,voice:_0x581288}=_0x18b000,_0x2cf011=_0x2b3fe1[_0x27ab51(0x1f7)],_0x3f2594=await this['modelsService']['getRandomAudioKey']();if(!_0x3f2594)throw _0x27ab51(0x229);const {key:_0x3425d5,proxyUrl:_0x581d04}=_0x3f2594;await this[_0x27ab51(0x1c1)][_0x27ab51(0x24f)](_0x2b3fe1[_0x27ab51(0x161)]),await this[_0x27ab51(0x1c1)][_0x27ab51(0x111)](_0x2b3fe1[_0x27ab51(0x161)]['id'],_0x3f2594),console[_0x27ab51(0x14f)](_0x27ab51(0x26d),_0x3425d5,_0x581d04),this[_0x27ab51(0x121)][_0x27ab51(0x291)]=_0x3425d5,this['openAi'][_0x27ab51(0x28d)]=(_0x581d04||this[_0x27ab51(0x1ed)])+_0x27ab51(0x1c7),this[_0x27ab51(0x121)]['timeout']=0x989680;const _0x3febb0=await this[_0x27ab51(0x121)][_0x27ab51(0x146)][_0x27ab51(0x275)][_0x27ab51(0x2ae)]({'file':(0x0,fs_2[_0x27ab51(0x1a3)])((0x0,path_1[_0x27ab51(0x10c)])(_0x36e344[_0x27ab51(0x21f)])),'model':_0x27ab51(0x148),'language':'zh','response_format':_0x27ab51(0x18e),'temperature':0x0})[_0x27ab51(0x196)](_0xc1e43f=>_0xc1e43f['text'])[_0x27ab51(0x19e)](_0x57d58d=>{const _0x270aa5=_0x27ab51;common_1['Logger'][_0x270aa5(0x202)](_0x57d58d);});console[_0x27ab51(0x14f)](_0x27ab51(0x120),_0x3febb0);if(!_0x3febb0){this['removeFile']((0x0,path_1[_0x27ab51(0x10c)])(_0x36e344[_0x27ab51(0x21f)]));throw new common_1[(_0x27ab51(0x214))]('语音转文本失败',common_1[_0x27ab51(0x27f)]['BAD_REQUEST']);}await this[_0x27ab51(0x1c1)][_0x27ab51(0x12a)](_0x2b3fe1[_0x27ab51(0x161)]['id'],_0x3f2594,-0x1);const _0x961e94=await this[_0x27ab51(0x10f)]({'userId':_0x2b3fe1[_0x27ab51(0x161)]['id'],'prompt':_0x3febb0,'abortController':_0x2cf011});console['log']('request\x20gpt\x20',_0x961e94);if(!_0x961e94){this[_0x27ab51(0x230)]((0x0,path_1['resolve'])(_0x36e344[_0x27ab51(0x21f)]));throw new common_1[(_0x27ab51(0x214))]('内容提取失败',common_1[_0x27ab51(0x27f)][_0x27ab51(0x107)]);}console[_0x27ab51(0x14f)](_0x27ab51(0x246),_0x961e94[_0x27ab51(0x28e)]);let _0x5b9556=_0x961e94[_0x27ab51(0x28e)]>0x1000?_0x961e94[_0x27ab51(0x16f)](0x0,0xfff):_0x961e94;const _0x5d46fc=await this[_0x27ab51(0x121)][_0x27ab51(0x146)]['speech'][_0x27ab51(0x2ae)]({'input':_0x5b9556,'model':_0x27ab51(0x13c),'response_format':'aac','voice':_0x581288,'speed':0x1})[_0x27ab51(0x196)](_0x366648=>_0x366648['arrayBuffer']())['catch'](_0x5ebccd=>{const _0x16138e=_0x27ab51;common_1['Logger'][_0x16138e(0x202)](_0x5ebccd);});if(!_0x5d46fc){this['removeFile']((0x0,path_1[_0x27ab51(0x10c)])(_0x36e344[_0x27ab51(0x21f)]));throw new common_1[(_0x27ab51(0x214))](_0x27ab51(0x149),common_1[_0x27ab51(0x27f)][_0x27ab51(0x107)]);}await this[_0x27ab51(0x1c1)]['deductBalance4Chat'](_0x2b3fe1[_0x27ab51(0x161)]['id'],_0x3f2594,-0x1);const _0x226b0b=Buffer[_0x27ab51(0x12b)](_0x5d46fc);return _0x213eb6['setHeader'](_0x27ab51(0x2a3),_0x27ab51(0x14d)),_0x213eb6['write'](_0x226b0b),_0x213eb6['end'](_0x226b0b),this[_0x27ab51(0x230)]((0x0,path_1[_0x27ab51(0x10c)])(_0x36e344[_0x27ab51(0x21f)])),_0x226b0b;}catch(_0x5d1aed){if(_0x5d1aed instanceof common_1[_0x27ab51(0x214)])throw _0x5d1aed;else throw new common_1['HttpException'](_0x5d1aed['message'],common_1['HttpStatus'][_0x27ab51(0x107)]);}}async[_0x940958(0x10f)](_0x37d4d3){const _0x32625a=_0x940958,{prompt:_0x4a8bf1,userId:_0x228611,abortController:_0x32d91a}=_0x37d4d3,_0x2981c5=await this[_0x32625a(0x1ec)][_0x32625a(0x14c)](model_constant_1[_0x32625a(0x166)][_0x32625a(0x293)]),_0x201b39=_0x2981c5[_0x32625a(0x1e3)],_0x5647bb=_0x2981c5['modelInfo'][_0x32625a(0x212)];if(!_0x201b39)throw new common_1['HttpException'](_0x32625a(0x28a),common_1[_0x32625a(0x27f)][_0x32625a(0x107)]);const {id:_0xb5afa7}=_0x201b39;let _0x20df6d=null,_0x468a1e=null;try{const {api:_0x28a716,options:_0x143678}=await this[_0x32625a(0x20b)]('','',_0x201b39);_0x20df6d=await _0x28a716[_0x32625a(0x20d)](_0x4a8bf1,{..._0x143678,'abortSignal':_0x32d91a[_0x32625a(0x282)]});const _0x248c03=(0x0,helper_1[_0x32625a(0x156)])(_0x5647bb,_0x20df6d,_0x468a1e),{total_tokens:total_tokens=0x0}=_0x248c03[_0x32625a(0x19c)];return await this['modelsService'][_0x32625a(0x21e)](_0xb5afa7,total_tokens),await this['userService'][_0x32625a(0x12a)](_0x228611,_0x201b39,-0x1),_0x20df6d[_0x32625a(0x218)];}catch(_0x2fe127){common_1['Logger'][_0x32625a(0x14f)](_0x2fe127);const _0x45daee=_0x2fe127['statusCode'];console[_0x32625a(0x14f)](_0x45daee);if(_0x2fe127['status']&&_0x2fe127[_0x32625a(0x123)]===0x192)throw new common_1[(_0x32625a(0x214))](_0x2fe127['message'],common_1[_0x32625a(0x27f)][_0x32625a(0x1a9)]);if(!_0x45daee)throw new common_1[(_0x32625a(0x214))](_0x2fe127[_0x32625a(0x1b2)],common_1['HttpStatus'][_0x32625a(0x107)]);let _0xb408f7=errorMessage_constant_1[_0x32625a(0x14b)][_0x45daee]?errorMessage_constant_1[_0x32625a(0x14b)][_0x45daee]:_0x32625a(0x2aa);_0x2fe127?.[_0x32625a(0x1b2)][_0x32625a(0x26e)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&Number(_0x5647bb)===0x1&&(await this['modelsService'][_0x32625a(0x1ab)](_0xb5afa7,_0x32625a(0x20c),-0x1),_0xb408f7=_0x32625a(0x108));_0x2fe127?.[_0x32625a(0x266)]===0x1ad&&_0x2fe127[_0x32625a(0x1b2)]['includes'](_0x32625a(0x26b))&&Number(_0x5647bb)===0x1&&(await this[_0x32625a(0x1ec)][_0x32625a(0x1ab)](_0xb5afa7,_0x32625a(0x268),-0x3),_0xb408f7=_0x32625a(0x10e));_0x2fe127?.['statusCode']===0x191&&_0x2fe127[_0x32625a(0x1b2)]['includes'](_0x32625a(0x285))&&Number(_0x5647bb)===0x1&&(await this[_0x32625a(0x1ec)]['lockKey'](_0xb5afa7,_0x32625a(0x1aa),-0x2),_0xb408f7='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');_0x2fe127?.[_0x32625a(0x266)]===0x191&&_0x2fe127['message']['includes'](_0x32625a(0x231))&&Number(_0x5647bb)===0x1&&(await this[_0x32625a(0x1ec)][_0x32625a(0x1ab)](_0xb5afa7,_0x32625a(0x10e),-0x2),_0xb408f7=_0x32625a(0x265));_0x2fe127?.['statusCode']===0x194&&_0x2fe127[_0x32625a(0x1b2)][_0x32625a(0x26e)](_0x32625a(0x181))&&Number(_0x5647bb)===0x1&&(await this[_0x32625a(0x1ec)][_0x32625a(0x1ab)](_0xb5afa7,_0x32625a(0x162),-0x4),_0xb408f7=_0x32625a(0x2ab));_0x2fe127?.[_0x32625a(0x266)]===0x133&&_0x2fe127['message'][_0x32625a(0x26e)](_0x32625a(0x1c6))&&Number(_0x5647bb)===0x1&&(console[_0x32625a(0x14f)](_0x32625a(0x1fc)),_0xb408f7='\x20！');_0x45daee===0x190&&console[_0x32625a(0x14f)](_0x32625a(0x2ac),_0x2fe127,_0x2fe127[_0x32625a(0x1b2)]);const _0x2b5faf={'message':_0xb408f7||_0x32625a(0x15a),'code':_0x45daee===0x191?0x191:_0x45daee||0x1f4};throw new common_1[(_0x32625a(0x214))](_0x2b5faf[_0x32625a(0x1b2)],common_1[_0x32625a(0x27f)][_0x32625a(0x107)]);}}async['draw'](_0xd8243c,_0x3b537a){const _0xf0beb5=_0x940958;common_1[_0xf0beb5(0x23d)][_0xf0beb5(0x14f)](_0xf0beb5(0x20f)+_0xd8243c[_0xf0beb5(0x1b5)],_0xf0beb5(0x28b)),await this[_0xf0beb5(0x2ad)][_0xf0beb5(0x254)](_0xd8243c[_0xf0beb5(0x1b5)],_0x3b537a[_0xf0beb5(0x161)]['id']),await this['userService']['checkUserStatus'](_0x3b537a[_0xf0beb5(0x161)]);let _0x335336=[];const _0x2f0758=await this[_0xf0beb5(0x1ec)][_0xf0beb5(0x259)](model_constant_1[_0xf0beb5(0x166)][_0xf0beb5(0x256)]);await this[_0xf0beb5(0x1c1)][_0xf0beb5(0x111)](_0x3b537a[_0xf0beb5(0x161)]['id'],_0x2f0758);const {key:_0x126da6,model:_0x29b9ba,proxyUrl:_0x62ce25}=await this[_0xf0beb5(0x253)](_0x2f0758),_0x27e0df=_0x62ce25+_0xf0beb5(0x171);try{const _0x6bd5cc=await axios_1[_0xf0beb5(0x221)][_0xf0beb5(0x226)](_0x27e0df,{..._0xd8243c,'model':_0x29b9ba,'response_format':_0xf0beb5(0x290)},{'headers':{'Authorization':_0xf0beb5(0x12e)+_0x126da6}});_0x335336=_0x6bd5cc['data']['data'];}catch(_0x2a37a0){console['log'](_0xf0beb5(0x248),_0x2a37a0);const _0x584730=_0x2a37a0?.[_0xf0beb5(0x21d)]?.[_0xf0beb5(0x123)]||0x1f4,_0x40bb6b=_0x2a37a0?.[_0xf0beb5(0x21d)]?.['data']?.[_0xf0beb5(0x202)]?.['message'];if(_0x584730===0x1ad)throw new common_1[(_0xf0beb5(0x214))](_0xf0beb5(0x19a),common_1['HttpStatus'][_0xf0beb5(0x107)]);if(_0x584730===0x190||_0x40bb6b[_0xf0beb5(0x26e)](_0xf0beb5(0x28c)))throw new common_1[(_0xf0beb5(0x214))](_0xf0beb5(0x1d0),common_1[_0xf0beb5(0x27f)]['BAD_REQUEST']);if(_0x584730===0x1f4)throw new common_1[(_0xf0beb5(0x214))](_0xf0beb5(0x225),common_1[_0xf0beb5(0x27f)][_0xf0beb5(0x107)]);if(_0x584730===0x191)throw new common_1[(_0xf0beb5(0x214))](_0xf0beb5(0x234),common_1[_0xf0beb5(0x27f)]['BAD_REQUEST']);throw new common_1['HttpException'](_0xf0beb5(0x105),common_1[_0xf0beb5(0x27f)][_0xf0beb5(0x107)]);}const _0x35207e=[];for(const _0x1f2726 of _0x335336){const _0x511a2e=_0x1f2726[_0xf0beb5(0x290)][_0xf0beb5(0x13e)](/^data:image\/\w+;base64,/,''),_0x21ab50=uuid['v4']()[_0xf0beb5(0x16f)](0x0,0xa)+_0xf0beb5(0x187),_0x37b839=Buffer[_0xf0beb5(0x12b)](_0x511a2e,_0xf0beb5(0x1e5));_0x35207e[_0xf0beb5(0x22c)](this['fileService'][_0xf0beb5(0x159)]({'filename':_0x21ab50,'buffer':_0x37b839}));}const _0x4153c1=(0x0,utils_1[_0xf0beb5(0x1a7)])(_0x3b537a),_0x4215d4=await Promise[_0xf0beb5(0x165)](_0x35207e),[_0x208081,_0xf8e444]=_0xd8243c[_0xf0beb5(0x1cd)]['split']('x'),_0x5c41bd=_0x4215d4[_0xf0beb5(0x245)](_0x4df8e7=>{const _0x55fb4c=_0xf0beb5;return this['chatLogService'][_0x55fb4c(0x16c)]({'curIp':_0x4153c1,'logType':0x3,'answer':_0x4df8e7,'totalTokens':0x0,'promptTokens':0x0,'model':_0x55fb4c(0x24c),'userId':_0x3b537a['user']['id'],'prompt':_0xd8243c[_0x55fb4c(0x1b5)],'completionTokens':0x0,'modelType':model_constant_1[_0x55fb4c(0x166)][_0x55fb4c(0x256)],'type':balance_constant_1[_0x55fb4c(0x134)]['PAINT_TYPE'],'fileInfo':JSON['stringify']({'width':_0x208081,'height':_0xf8e444,'cosUrl':_0x4df8e7})});}),_0x901e95=await Promise[_0xf0beb5(0x165)](_0x5c41bd);return await this[_0xf0beb5(0x1c1)]['deductBalance4Chat'](_0x3b537a['user']['id'],_0x2f0758,_0x901e95[0x0]['id']),_0x4215d4;}async[_0x940958(0x2a6)](_0x5b73a1,_0x41511c){const _0x5cfb3b=_0x940958;throw new Error(_0x5cfb3b(0x22f));}async[_0x940958(0x197)](_0x7e0a61){const _0x5095e4=_0x940958,_0x171832=await this[_0x5095e4(0x2a9)][_0x5095e4(0x29b)](['openaiBaseUrl'])||'https://api.openai.com';try{const _0x4237d3={'Content-Type':'application/json','Authorization':_0x5095e4(0x12e)+_0x7e0a61},_0x3eb18f=(0x0,date_1['default'])()[_0x5095e4(0x205)](_0x5095e4(0x1f9)),_0x476e37=(0x0,date_1['default'])()[_0x5095e4(0x279)](0x63,'day')[_0x5095e4(0x205)](_0x5095e4(0x1f9)),_0x6f7c31=await axios_1[_0x5095e4(0x221)]['get'](_0x171832+_0x5095e4(0x233)+_0x476e37+_0x5095e4(0x25c)+_0x3eb18f,{'headers':_0x4237d3}),_0x80836f=_0x6f7c31?.[_0x5095e4(0x17d)][_0x5095e4(0x235)]??0x0,_0x103931=await axios_1[_0x5095e4(0x221)][_0x5095e4(0x276)](_0x171832+_0x5095e4(0x1fe),{'headers':_0x4237d3}),{has_payment_method:_0x5064f0,hard_limit_usd:_0x403e9e,access_until:_0x4a7332}=_0x103931[_0x5095e4(0x17d)],_0x4996c7=(_0x80836f/0x64)['toFixed'](0x2),_0x1c09a9=Number(_0x403e9e)[_0x5095e4(0x15d)](0x0);return{'totalAmount':_0x1c09a9+'$','useAmount':_0x4996c7+'$','balance':(Number(_0x1c09a9)-Number(_0x4996c7))[_0x5095e4(0x15d)](0x2)+'$','isBindCard':_0x5064f0,'expirDate':(0x0,date_1[_0x5095e4(0x221)])(_0x4a7332*0x3e8)[_0x5095e4(0x205)](_0x5095e4(0x16a)),'status':0x1};}catch(_0x1000d7){return{'status':-0x1};}}async[_0x940958(0x1f8)](_0x3554eb){const _0x1622c4=_0x940958,_0x490695=await this[_0x1622c4(0x2a9)][_0x1622c4(0x29b)]([_0x1622c4(0x191)])||'https://api.openai.com',_0x4e5345=_0x490695+_0x1622c4(0x20a);try{const _0x1a3914=await axios_1[_0x1622c4(0x221)][_0x1622c4(0x276)](_0x4e5345,{'headers':{'Authorization':_0x1622c4(0x12e)+_0x3554eb}}),_0xb11278=_0x1a3914[_0x1622c4(0x17d)]['data'][_0x1622c4(0x245)](_0x2a985d=>_0x2a985d['id']);return model_constant_1[_0x1622c4(0x278)][_0x1622c4(0x1e0)](_0x1a22f0=>_0xb11278[_0x1622c4(0x26e)](_0x1a22f0));}catch(_0x3c6b1c){throw new common_1[(_0x1622c4(0x214))](_0x1622c4(0x11a),common_1[_0x1622c4(0x27f)]['BAD_REQUEST']);}}async[_0x940958(0x113)](){const _0x5dcb71=_0x940958;return await this[_0x5dcb71(0x118)][_0x5dcb71(0x250)]({'where':{'status':0x1,'count':(0x0,typeorm_1[_0x5dcb71(0x271)])(0x0)},'select':[_0x5dcb71(0x223)]});}async[_0x940958(0x1a6)](_0x1db3d9){const _0x3455a4=_0x940958,{userId:_0x571d0d}=_0x1db3d9,_0x5663d9=await this[_0x3455a4(0x118)][_0x3455a4(0x18b)]({'where':{'userId':_0x571d0d}});if(_0x5663d9)throw new common_1[(_0x3455a4(0x214))](_0x3455a4(0x26f),common_1[_0x3455a4(0x27f)]['BAD_REQUEST']);const _0x3ba69d=await this[_0x3455a4(0x118)][_0x3455a4(0x283)](_0x1db3d9);return await this[_0x3455a4(0x113)](),_0x3ba69d;}async['updateWhiteUser'](_0x1ceb1e){const _0x21edc9=_0x940958,{id:_0x30794d}=_0x1ceb1e,_0x33c3ab=await this['whiteListEntity'][_0x21edc9(0x18b)]({'where':{'id':_0x30794d}});if(!_0x33c3ab)throw new common_1[(_0x21edc9(0x214))](_0x21edc9(0x18a),common_1['HttpStatus']['BAD_REQUEST']);const _0x379a2c=await this['whiteListEntity'][_0x21edc9(0x11b)]({'id':_0x30794d},_0x1ceb1e);if(_0x379a2c[_0x21edc9(0x11c)]>0x0)return await this['getUserWhiteList'](),_0x21edc9(0x180);else throw new common_1['HttpException'](_0x21edc9(0x1e7),common_1[_0x21edc9(0x27f)][_0x21edc9(0x107)]);}async['getWhiteListUser'](_0xdda81b,_0xccd19c){const _0x4a1e99=_0x940958,{page:page=0x1,size:size=0xa}=_0xdda81b,[_0x5872d9,_0x555cbe]=await this[_0x4a1e99(0x118)][_0x4a1e99(0x213)]({'skip':(page-0x1)*size,'take':size,'order':{'id':_0x4a1e99(0x224)}}),_0xb9bacb=_0x5872d9['map'](_0x5473d1=>_0x5473d1[_0x4a1e99(0x223)]),_0x560706=await this[_0x4a1e99(0x258)][_0x4a1e99(0x250)]({'where':{'id':(0x0,typeorm_1['In'])(_0xb9bacb)}});return _0x5872d9[_0x4a1e99(0x184)](_0x40b766=>{const _0x252b7b=_0x4a1e99,_0x5ec7de=_0x560706[_0x252b7b(0x250)](_0x13f4f4=>_0x13f4f4['id']===_0x40b766[_0x252b7b(0x223)]);_0x40b766[_0x252b7b(0x206)]=_0x5ec7de?.['username']??'',_0x40b766[_0x252b7b(0x106)]=_0x5ec7de?.[_0x252b7b(0x106)]??'';}),_0xccd19c[_0x4a1e99(0x161)][_0x4a1e99(0x238)]!==_0x4a1e99(0x298)&&_0x5872d9[_0x4a1e99(0x184)](_0x273b96=>_0x273b96[_0x4a1e99(0x106)]=(0x0,utils_1[_0x4a1e99(0x174)])(_0x273b96[_0x4a1e99(0x106)])),{'rows':_0x5872d9,'count':_0x555cbe};}async[_0x940958(0x27b)](_0x3047e5){const _0x49579d=_0x940958;if(_0x3047e5)return _0x3047e5;const _0x2b226a=await this[_0x49579d(0x2a9)][_0x49579d(0x29b)]([_0x49579d(0x191)]);if(_0x2b226a)return _0x2b226a;return _0x49579d(0x1de);}async[_0x940958(0x253)](_0x1c9a0e){const _0x2f89ad=_0x940958,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x2f89ad(0x2a9)][_0x2f89ad(0x29b)]([_0x2f89ad(0x24a),_0x2f89ad(0x15e),_0x2f89ad(0x23e),'openaiModel3MaxTokens16kRes',_0x2f89ad(0x24b),_0x2f89ad(0x255),_0x2f89ad(0x14a),'openaiModel4MaxTokens32kRes','openaiBaseUrl']);let _0x596bc2=null,_0x6e1451=null,_0x51e286=null;const {model:_0x4b76bf,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x4b5c74,key:_0x5aae6f}=_0x1c9a0e;return _0x4b76bf[_0x2f89ad(0x260)]()[_0x2f89ad(0x26e)](_0x2f89ad(0x1c9))&&(_0x4b76bf[_0x2f89ad(0x260)]()[_0x2f89ad(0x26e)](_0x2f89ad(0x263))?(_0x596bc2=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x6e1451=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x596bc2=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x6e1451=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x4b76bf['toLowerCase']()[_0x2f89ad(0x26e)](_0x2f89ad(0x1e8))&&(_0x4b76bf[_0x2f89ad(0x260)]()[_0x2f89ad(0x26e)](_0x2f89ad(0x243))?(_0x596bc2=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x6e1451=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x596bc2=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x6e1451=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x51e286=_0x4b5c74||openaiBaseUrl||_0x2f89ad(0x1de),_0x6e1451>=_0x596bc2&&(_0x6e1451=Math[_0x2f89ad(0x152)](_0x596bc2/0x2),common_1['Logger'][_0x2f89ad(0x155)](_0x2f89ad(0x211)+_0x5aae6f+_0x2f89ad(0x241)+_0x6e1451)),{'key':_0x5aae6f,'model':_0x4b76bf,'maxToken':_0x596bc2,'maxTokenRes':_0x6e1451,'proxyUrl':_0x51e286};}async['asyncPPTProgress'](_0x530d89){const _0x10027f=_0x940958;try{const _0x230cef=await this[_0x10027f(0x29f)][_0x10027f(0x1ba)](_0x530d89),_0x4ec663=await this[_0x10027f(0x1b1)][_0x10027f(0x18b)]({'where':{'yooTaskId':_0x530d89[_0x10027f(0x1ea)]['id']}});if(!_0x4ec663)throw new Error(_0x10027f(0x1fd));_0x4ec663['status']=_0x230cef['data']['status'],_0x4ec663[_0x10027f(0x19f)]=_0x230cef[_0x10027f(0x17d)][_0x10027f(0x244)],_0x4ec663[_0x10027f(0x19b)]=_0x230cef[_0x10027f(0x17d)]['progress'],_0x4ec663[_0x10027f(0x1c8)]=_0x230cef[_0x10027f(0x17d)]['process_url'],_0x4ec663[_0x10027f(0x160)]=_0x230cef[_0x10027f(0x17d)][_0x10027f(0x1dd)],_0x4ec663[_0x10027f(0x1cf)]=_0x230cef[_0x10027f(0x17d)][_0x10027f(0x183)],_0x4ec663['images']=_0x230cef[_0x10027f(0x17d)][_0x10027f(0x1a8)],_0x4ec663['startTime']=_0x230cef[_0x10027f(0x17d)][_0x10027f(0x17c)],_0x4ec663[_0x10027f(0x1b4)]=_0x230cef[_0x10027f(0x17d)]['updated_at'],await this[_0x10027f(0x1b1)][_0x10027f(0x283)](_0x4ec663),_0x230cef['data'][_0x10027f(0x123)]===0x1&&setTimeout(()=>this[_0x10027f(0x172)](_0x530d89),0xbb8);}catch(_0x55e080){common_1[_0x10027f(0x23d)][_0x10027f(0x202)](_0x55e080[_0x10027f(0x1b2)],_0x10027f(0x204));}}async[_0x940958(0x1d4)](_0x6046c9,_0x45be31){const _0x57803a=_0x940958;try{return this[_0x57803a(0x138)][_0x57803a(0x237)](async()=>{const _0xe602ae=_0x57803a,_0x124614=await this[_0xe602ae(0x1ec)]['getModelByType'](model_constant_1['EModelType'][_0xe602ae(0x185)]);let _0x3adb1a={'userId':_0x6046c9['user']['id'],'type':ppt_constant_1[_0xe602ae(0x122)][_0xe602ae(0x242)],'title':_0x45be31[_0xe602ae(0x144)],'text':_0x45be31[_0xe602ae(0x218)],'theme':_0x45be31[_0xe602ae(0x269)]};_0x3adb1a=await this[_0xe602ae(0x1b1)][_0xe602ae(0x283)](_0x3adb1a),await this['userService'][_0xe602ae(0x1be)](_0x6046c9[_0xe602ae(0x161)]['id'],_0x3adb1a['id'],_0x3adb1a[_0xe602ae(0x15f)]);const _0x58639d=await this[_0xe602ae(0x29f)][_0xe602ae(0x1d4)]({'data':_0x45be31,'baseURL':_0x124614[_0xe602ae(0x1e3)][_0xe602ae(0x227)],'headers':{'AccessToken':_0x124614['modelInfo']['accessToken'],'AccessSecret':_0x124614[_0xe602ae(0x1e3)][_0xe602ae(0x178)]}});return _0x3adb1a['title']=_0x58639d[_0xe602ae(0x17d)]['title'],_0x3adb1a[_0xe602ae(0x10a)]=_0x58639d[_0xe602ae(0x17d)][_0xe602ae(0x10a)],await this[_0xe602ae(0x1b1)][_0xe602ae(0x283)](_0x3adb1a),_0x3adb1a;});}catch(_0xcbdc39){throw new common_1[(_0x57803a(0x214))](_0xcbdc39['message'],common_1[_0x57803a(0x27f)][_0x57803a(0x107)]);}}[_0x940958(0x23a)](_0x553df0,_0x273f4f){const _0x44aa5e=_0x940958;try{return this[_0x44aa5e(0x138)][_0x44aa5e(0x237)](async()=>{const _0x1e9f46=_0x44aa5e,_0x5be695=await this[_0x1e9f46(0x1ec)][_0x1e9f46(0x14c)](model_constant_1[_0x1e9f46(0x166)][_0x1e9f46(0x185)]);let _0x2707bc={'userId':_0x553df0[_0x1e9f46(0x161)]['id'],'type':ppt_constant_1[_0x1e9f46(0x122)][_0x1e9f46(0x209)],'title':_0x273f4f[_0x1e9f46(0x144)],'text':_0x273f4f[_0x1e9f46(0x218)],'author':_0x273f4f[_0x1e9f46(0x18d)],'color':_0x273f4f[_0x1e9f46(0x1b0)],'style':_0x273f4f[_0x1e9f46(0x1ce)]};_0x2707bc=await this['pptTaskEntity'][_0x1e9f46(0x283)](_0x2707bc),await this['userService'][_0x1e9f46(0x1be)](_0x553df0[_0x1e9f46(0x161)]['id'],_0x2707bc['id'],_0x2707bc['type']);const _0x421199=await this['pptService'][_0x1e9f46(0x23a)]({'data':{'title':_0x273f4f[_0x1e9f46(0x144)],'count':_0x273f4f['text'],'user_name':_0x273f4f[_0x1e9f46(0x18d)],'color':_0x273f4f['color'],'style':_0x273f4f['style']},'baseURL':_0x5be695[_0x1e9f46(0x1e3)][_0x1e9f46(0x227)],'headers':{'AccessToken':_0x5be695[_0x1e9f46(0x1e3)][_0x1e9f46(0x274)],'AccessSecret':_0x5be695[_0x1e9f46(0x1e3)][_0x1e9f46(0x178)]}});return _0x2707bc[_0x1e9f46(0x169)]=_0x421199['data'],await this[_0x1e9f46(0x1b1)][_0x1e9f46(0x283)](_0x2707bc),_0x2707bc;});}catch(_0x4568c6){throw new common_1['HttpException'](_0x4568c6[_0x44aa5e(0x1b2)],common_1[_0x44aa5e(0x27f)][_0x44aa5e(0x107)]);}}[_0x940958(0x115)](_0x5f10f9,_0x594170){const _0x1ee239=_0x940958;try{return this[_0x1ee239(0x138)]['transaction'](async()=>{const _0x4d9100=_0x1ee239,_0x1cf21a=await this[_0x4d9100(0x1ec)][_0x4d9100(0x14c)](model_constant_1['EModelType']['PPT']);let _0x4288ff={'userId':_0x5f10f9[_0x4d9100(0x161)]['id'],'type':ppt_constant_1[_0x4d9100(0x122)][_0x4d9100(0x1ee)],'title':_0x594170[_0x4d9100(0x144)],'text':_0x594170[_0x4d9100(0x218)],'author':_0x594170[_0x4d9100(0x18d)],'coverId':_0x594170['coverId']};_0x4288ff=await this['pptTaskEntity'][_0x4d9100(0x283)](_0x4288ff),await this[_0x4d9100(0x1c1)][_0x4d9100(0x1be)](_0x5f10f9[_0x4d9100(0x161)]['id'],_0x4288ff['id'],_0x4288ff['type']);const _0x231fde=await this[_0x4d9100(0x29f)][_0x4d9100(0x115)]({'data':{'title':_0x594170[_0x4d9100(0x144)],'count':_0x594170[_0x4d9100(0x218)],'user_name':_0x594170[_0x4d9100(0x18d)],'cover_id':_0x594170[_0x4d9100(0x117)]},'baseURL':_0x1cf21a['modelInfo'][_0x4d9100(0x227)],'headers':{'AccessToken':_0x1cf21a[_0x4d9100(0x1e3)]['accessToken'],'AccessSecret':_0x1cf21a[_0x4d9100(0x1e3)][_0x4d9100(0x178)]}});return _0x4288ff[_0x4d9100(0x169)]=_0x231fde[_0x4d9100(0x17d)],await this[_0x4d9100(0x1b1)][_0x4d9100(0x283)](_0x4288ff),_0x4288ff;});}catch(_0x1cad44){throw new common_1[(_0x1ee239(0x214))](_0x1cad44[_0x1ee239(0x1b2)],common_1['HttpStatus']['BAD_REQUEST']);}}[_0x940958(0x16d)](_0x18d4d1,_0xa07d2d){const _0x4dcdf7=_0x940958;try{return this[_0x4dcdf7(0x138)][_0x4dcdf7(0x237)](async()=>{const _0x5cf480=_0x4dcdf7;let _0x1bffbc;const _0x35e087=await this[_0x5cf480(0x1ec)][_0x5cf480(0x14c)](model_constant_1[_0x5cf480(0x166)][_0x5cf480(0x185)]);if(_0xa07d2d['originTaskId']){_0x1bffbc=await this[_0x5cf480(0x1b1)][_0x5cf480(0x18b)]({'where':{'id':_0xa07d2d['originTaskId']}});if(!_0x1bffbc)throw new Error(_0x5cf480(0x25d));}let _0x4cded2={'userId':_0x18d4d1[_0x5cf480(0x161)]['id'],'type':ppt_constant_1[_0x5cf480(0x122)]['CREATE'],'title':_0xa07d2d[_0x5cf480(0x144)],'subTitle':_0xa07d2d['subTitle'],'text':_0xa07d2d[_0x5cf480(0x218)],'catalogs':_0xa07d2d[_0x5cf480(0x10a)],'contents':_0xa07d2d['contents'],'author':_0xa07d2d[_0x5cf480(0x18d)],'fontName':_0xa07d2d[_0x5cf480(0x136)],'transition':_0xa07d2d['transition'],'complex':_0xa07d2d['complex'],'coverId':_0xa07d2d['coverId'],'originId':_0xa07d2d['originTaskId']};_0x4cded2=await this[_0x5cf480(0x1b1)][_0x5cf480(0x283)](_0x4cded2),await this[_0x5cf480(0x1c1)][_0x5cf480(0x1be)](_0x18d4d1[_0x5cf480(0x161)]['id'],_0x4cded2['id'],_0x4cded2[_0x5cf480(0x15f)]);const _0x451d47=await this[_0x5cf480(0x29f)]['pptCreate']({'data':{'text':_0xa07d2d[_0x5cf480(0x218)],'custom_data':{'title':_0xa07d2d[_0x5cf480(0x144)],'sub_title':_0xa07d2d['subTitle'],'author':_0xa07d2d[_0x5cf480(0x18d)],'catalogs':_0xa07d2d[_0x5cf480(0x10a)],'contents':_0xa07d2d[_0x5cf480(0x29c)]},'cover_id':_0xa07d2d[_0x5cf480(0x117)],'font_name':_0xa07d2d[_0x5cf480(0x136)],'transition':_0xa07d2d[_0x5cf480(0x299)],'complex':_0xa07d2d[_0x5cf480(0x189)],'user_name':_0xa07d2d['author'],'id':_0x1bffbc['yooTaskId']},'baseURL':_0x35e087[_0x5cf480(0x1e3)][_0x5cf480(0x227)],'headers':{'AccessToken':_0x35e087[_0x5cf480(0x1e3)]['accessToken'],'AccessSecret':_0x35e087[_0x5cf480(0x1e3)][_0x5cf480(0x178)]}});return _0x4cded2['yooTaskId']=_0x451d47[_0x5cf480(0x17d)]['id'],await this[_0x5cf480(0x1b1)]['save'](_0x4cded2),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x35e087[_0x5cf480(0x1e3)]['proxyUrl'],'headers':{'AccessToken':_0x35e087[_0x5cf480(0x1e3)][_0x5cf480(0x274)],'AccessSecret':_0x35e087[_0x5cf480(0x1e3)][_0x5cf480(0x178)]},'params':{'id':_0x4cded2[_0x5cf480(0x141)]}}),0xbb8),_0x4cded2;});}catch(_0x187b6d){throw new common_1[(_0x4dcdf7(0x214))](_0x187b6d[_0x4dcdf7(0x1b2)],common_1[_0x4dcdf7(0x27f)][_0x4dcdf7(0x107)]);}}[_0x940958(0x194)](_0x5b51b2,_0x68c245){const _0x3d9b46=_0x940958;try{return this['connection']['transaction'](async()=>{const _0x2f6d12=_0x4fb8,_0x32b5ad=await this[_0x2f6d12(0x1ec)]['getModelByType'](model_constant_1['EModelType'][_0x2f6d12(0x185)]);let _0x53b817={'userId':_0x5b51b2[_0x2f6d12(0x161)]['id'],'type':ppt_constant_1[_0x2f6d12(0x122)][_0x2f6d12(0x163)],'title':_0x68c245[_0x2f6d12(0x144)],'color':_0x68c245[_0x2f6d12(0x1b0)],'style':_0x68c245[_0x2f6d12(0x1ce)],'fileUrl':_0x68c245[_0x2f6d12(0x210)],'pleader':_0x68c245[_0x2f6d12(0x1b8)],'advisor':_0x68c245[_0x2f6d12(0x25e)],'school':_0x68c245[_0x2f6d12(0x1a2)],'schoolLogo':_0x68c245[_0x2f6d12(0x1e2)],'schoolPicture':_0x68c245[_0x2f6d12(0x110)]};_0x53b817=await this[_0x2f6d12(0x1b1)][_0x2f6d12(0x283)](_0x53b817),await this[_0x2f6d12(0x1c1)][_0x2f6d12(0x1be)](_0x5b51b2[_0x2f6d12(0x161)]['id'],_0x53b817['id'],_0x53b817[_0x2f6d12(0x15f)]);const _0x4aa082=await this[_0x2f6d12(0x29f)][_0x2f6d12(0x194)]({'data':{'file_key':_0x68c245[_0x2f6d12(0x210)],'title':_0x68c245['title'],'color':_0x68c245[_0x2f6d12(0x1b0)],'style':_0x68c245[_0x2f6d12(0x1ce)],'pleader':_0x68c245[_0x2f6d12(0x1b8)],'advisor':_0x68c245[_0x2f6d12(0x25e)],'school':_0x68c245['school'],'school_logo':_0x68c245[_0x2f6d12(0x1e2)],'school_picture':_0x68c245['schoolPicture']},'baseURL':_0x32b5ad[_0x2f6d12(0x1e3)][_0x2f6d12(0x227)],'headers':{'AccessToken':_0x32b5ad[_0x2f6d12(0x1e3)][_0x2f6d12(0x274)],'AccessSecret':_0x32b5ad[_0x2f6d12(0x1e3)]['secret']}});return _0x53b817[_0x2f6d12(0x141)]=_0x4aa082['data']['id'],await this['pptTaskEntity'][_0x2f6d12(0x283)](_0x53b817),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x32b5ad['modelInfo'][_0x2f6d12(0x227)],'headers':{'AccessToken':_0x32b5ad[_0x2f6d12(0x1e3)][_0x2f6d12(0x274)],'AccessSecret':_0x32b5ad['modelInfo'][_0x2f6d12(0x178)]},'params':{'id':_0x53b817['yooTaskId']}}),0xbb8),_0x53b817;});}catch(_0x69d482){throw new common_1[(_0x3d9b46(0x214))](_0x69d482[_0x3d9b46(0x1b2)],common_1[_0x3d9b46(0x27f)][_0x3d9b46(0x107)]);}}[_0x940958(0x1ef)](_0x5569a5,_0x581b5e){const _0x427364=_0x940958;try{return this[_0x427364(0x138)]['transaction'](async()=>{const _0x5dc957=_0x427364,_0x468049=await this[_0x5dc957(0x1ec)][_0x5dc957(0x14c)](model_constant_1[_0x5dc957(0x166)][_0x5dc957(0x185)]);let _0x5a65e8={'userId':_0x5569a5['user']['id'],'type':ppt_constant_1['EPPTTaskType']['FILE'],'fileUrl':_0x581b5e['fileUrl'],'coverId':_0x581b5e['coverId'],'author':_0x581b5e[_0x5dc957(0x18d)]};_0x5a65e8=await this['pptTaskEntity'][_0x5dc957(0x283)](_0x5a65e8),await this[_0x5dc957(0x1c1)][_0x5dc957(0x1be)](_0x5569a5['user']['id'],_0x5a65e8['id'],_0x5a65e8[_0x5dc957(0x15f)]);const _0x27fc9f=await this[_0x5dc957(0x29f)][_0x5dc957(0x1ef)]({'data':{'file_url':_0x581b5e[_0x5dc957(0x210)],'cover_id':_0x581b5e[_0x5dc957(0x117)],'user_name':_0x581b5e[_0x5dc957(0x18d)]},'baseURL':_0x468049[_0x5dc957(0x1e3)][_0x5dc957(0x227)],'headers':{'AccessToken':_0x468049[_0x5dc957(0x1e3)]['accessToken'],'AccessSecret':_0x468049[_0x5dc957(0x1e3)][_0x5dc957(0x178)]}});return _0x5a65e8[_0x5dc957(0x141)]=_0x27fc9f['data']['id'],await this[_0x5dc957(0x1b1)][_0x5dc957(0x283)](_0x5a65e8),setTimeout(()=>this[_0x5dc957(0x172)]({'baseURL':_0x468049['modelInfo'][_0x5dc957(0x227)],'headers':{'AccessToken':_0x468049['modelInfo']['accessToken'],'AccessSecret':_0x468049[_0x5dc957(0x1e3)][_0x5dc957(0x178)]},'params':{'id':_0x5a65e8[_0x5dc957(0x141)]}}),0xbb8),_0x5a65e8;});}catch(_0x2d9c37){throw new common_1[(_0x427364(0x214))](_0x2d9c37[_0x427364(0x1b2)],common_1['HttpStatus'][_0x427364(0x107)]);}}['pptDetail'](_0x4cd094){const _0x567645=_0x940958;return this['pptTaskEntity'][_0x567645(0x18b)]({'where':{'id':_0x4cd094}});}['pptChangeTheme'](_0x10f8e2,_0x59f018){const _0x6f0668=_0x940958;try{return this[_0x6f0668(0x138)]['transaction'](async()=>{const _0x49ac04=_0x6f0668,_0x1a6a6d=await this[_0x49ac04(0x1b1)][_0x49ac04(0x18b)]({'where':{'id':_0x59f018[_0x49ac04(0x1bf)]}});if(!_0x1a6a6d)throw new Error('原始任务不存在！');const _0x19845f=await this[_0x49ac04(0x1ec)]['getModelByType'](model_constant_1['EModelType']['PPT']);let _0x5e2d6a={'userId':_0x10f8e2[_0x49ac04(0x161)]['id'],'type':ppt_constant_1[_0x49ac04(0x122)][_0x49ac04(0x288)],'originId':_0x59f018['originTaskId'],'coverId':_0x59f018[_0x49ac04(0x117)],'fontName':_0x59f018[_0x49ac04(0x136)],'transition':_0x59f018[_0x49ac04(0x299)]};_0x5e2d6a=await this[_0x49ac04(0x1b1)][_0x49ac04(0x283)](_0x5e2d6a),await this[_0x49ac04(0x1c1)][_0x49ac04(0x1be)](_0x10f8e2[_0x49ac04(0x161)]['id'],_0x5e2d6a['id'],_0x5e2d6a['type']);const _0x5dd41d=await this[_0x49ac04(0x29f)][_0x49ac04(0x272)]({'data':{'id':_0x1a6a6d[_0x49ac04(0x141)],'cover_id':_0x59f018[_0x49ac04(0x117)],'font_name':_0x59f018[_0x49ac04(0x136)],'transition':_0x59f018['transition']},'baseURL':_0x19845f[_0x49ac04(0x1e3)]['proxyUrl'],'headers':{'AccessToken':_0x19845f['modelInfo']['accessToken'],'AccessSecret':_0x19845f[_0x49ac04(0x1e3)]['secret']}});return _0x5e2d6a[_0x49ac04(0x141)]=_0x5dd41d[_0x49ac04(0x17d)]['id'],await this['pptTaskEntity'][_0x49ac04(0x283)](_0x5e2d6a),setTimeout(()=>this[_0x49ac04(0x172)]({'baseURL':_0x19845f[_0x49ac04(0x1e3)][_0x49ac04(0x227)],'headers':{'AccessToken':_0x19845f[_0x49ac04(0x1e3)]['accessToken'],'AccessSecret':_0x19845f[_0x49ac04(0x1e3)]['secret']},'params':{'id':_0x5e2d6a[_0x49ac04(0x141)]}}),0xbb8),_0x5e2d6a;});}catch(_0x424a19){throw new common_1[(_0x6f0668(0x214))](_0x424a19[_0x6f0668(0x1b2)],common_1[_0x6f0668(0x27f)]['BAD_REQUEST']);}}['pptAddPage'](_0x2c3e0f,_0x5e8b71){const _0x505f64=_0x940958;try{return this['connection'][_0x505f64(0x237)](async()=>{const _0x2ec0c1=_0x505f64,_0x2483ec=await this['pptTaskEntity']['findOne']({'where':{'id':_0x5e8b71['originTaskId']}});if(!_0x2483ec)throw new Error(_0x2ec0c1(0x25d));const _0xa411b8=await this[_0x2ec0c1(0x1ec)][_0x2ec0c1(0x14c)](model_constant_1[_0x2ec0c1(0x166)][_0x2ec0c1(0x185)]);let _0x58560c={'userId':_0x2c3e0f[_0x2ec0c1(0x161)]['id'],'type':ppt_constant_1[_0x2ec0c1(0x122)][_0x2ec0c1(0x1b3)],'originId':_0x5e8b71['originTaskId'],'theme':_0x5e8b71[_0x2ec0c1(0x269)],'text':_0x5e8b71[_0x2ec0c1(0x218)],'complex':_0x5e8b71[_0x2ec0c1(0x189)]?String(_0x5e8b71['complex']):'1','author':_0x5e8b71[_0x2ec0c1(0x18d)],'fontName':_0x5e8b71[_0x2ec0c1(0x136)],'transition':_0x5e8b71[_0x2ec0c1(0x299)],'slideNumber':_0x5e8b71[_0x2ec0c1(0x182)],'slideType':_0x5e8b71[_0x2ec0c1(0x249)]};_0x58560c=await this[_0x2ec0c1(0x1b1)][_0x2ec0c1(0x283)](_0x58560c),await this[_0x2ec0c1(0x1c1)]['debuctBalance4PPT'](_0x2c3e0f[_0x2ec0c1(0x161)]['id'],_0x58560c['id'],_0x58560c[_0x2ec0c1(0x15f)]);const _0x102869=await this[_0x2ec0c1(0x29f)][_0x2ec0c1(0x1f3)]({'data':{'id':_0x2483ec[_0x2ec0c1(0x141)],'text':_0x5e8b71[_0x2ec0c1(0x218)],'complex':_0x5e8b71['complex'],'user_name':_0x5e8b71[_0x2ec0c1(0x18d)],'font_name':_0x5e8b71[_0x2ec0c1(0x136)],'transition':_0x5e8b71[_0x2ec0c1(0x299)],'slide_number':_0x5e8b71[_0x2ec0c1(0x182)],'slide_type':_0x5e8b71[_0x2ec0c1(0x249)],'theme':_0x5e8b71['theme']},'baseURL':_0xa411b8[_0x2ec0c1(0x1e3)][_0x2ec0c1(0x227)],'headers':{'AccessToken':_0xa411b8[_0x2ec0c1(0x1e3)][_0x2ec0c1(0x274)],'AccessSecret':_0xa411b8[_0x2ec0c1(0x1e3)][_0x2ec0c1(0x178)]}});return _0x58560c[_0x2ec0c1(0x141)]=_0x102869[_0x2ec0c1(0x17d)]['id'],await this['pptTaskEntity']['save'](_0x58560c),setTimeout(()=>this[_0x2ec0c1(0x172)]({'baseURL':_0xa411b8[_0x2ec0c1(0x1e3)][_0x2ec0c1(0x227)],'headers':{'AccessToken':_0xa411b8[_0x2ec0c1(0x1e3)][_0x2ec0c1(0x274)],'AccessSecret':_0xa411b8[_0x2ec0c1(0x1e3)]['secret']},'params':{'id':_0x58560c[_0x2ec0c1(0x141)]}}),0xbb8),_0x58560c;});}catch(_0x2992e0){throw new common_1['HttpException'](_0x2992e0[_0x505f64(0x1b2)],common_1[_0x505f64(0x27f)][_0x505f64(0x107)]);}}[_0x940958(0x29a)](_0x3b798e,_0x56a30c){const _0x5a2315=_0x940958;try{return this[_0x5a2315(0x138)][_0x5a2315(0x237)](async()=>{const _0x420660=_0x5a2315,_0x4a6042=await this[_0x420660(0x1b1)][_0x420660(0x18b)]({'where':{'id':_0x56a30c[_0x420660(0x1bf)]}});if(!_0x4a6042)throw new Error(_0x420660(0x25d));const _0x295f97=await this[_0x420660(0x1ec)][_0x420660(0x14c)](model_constant_1[_0x420660(0x166)]['PPT']);let _0x591126={'userId':_0x3b798e[_0x420660(0x161)]['id'],'type':ppt_constant_1[_0x420660(0x122)]['ADDNOTES'],'originId':_0x56a30c[_0x420660(0x1bf)],'notes':_0x56a30c};_0x591126=await this['pptTaskEntity']['save'](_0x591126),await this[_0x420660(0x1c1)]['debuctBalance4PPT'](_0x3b798e[_0x420660(0x161)]['id'],_0x591126['id'],_0x591126['type']);const _0x1a443e=await this['pptService']['pptNote']({'data':{..._0x56a30c,'id':_0x4a6042['yooTaskId']},'baseURL':_0x295f97[_0x420660(0x1e3)][_0x420660(0x227)],'headers':{'AccessToken':_0x295f97['modelInfo'][_0x420660(0x274)],'AccessSecret':_0x295f97[_0x420660(0x1e3)][_0x420660(0x178)]}});return _0x591126[_0x420660(0x141)]=_0x1a443e[_0x420660(0x17d)]['id'],await this[_0x420660(0x1b1)]['save'](_0x591126),setTimeout(()=>this[_0x420660(0x172)]({'baseURL':_0x295f97[_0x420660(0x1e3)][_0x420660(0x227)],'headers':{'AccessToken':_0x295f97[_0x420660(0x1e3)][_0x420660(0x274)],'AccessSecret':_0x295f97[_0x420660(0x1e3)][_0x420660(0x178)]},'params':{'id':_0x591126[_0x420660(0x141)]}}),0xbb8),_0x591126;});}catch(_0x541548){throw new common_1['HttpException'](_0x541548[_0x5a2315(0x1b2)],common_1[_0x5a2315(0x27f)][_0x5a2315(0x107)]);}}async['pptPage'](_0x303a67,_0x4dcad8){const _0x314def=_0x940958,_0x1b1142=_0x4dcad8[_0x314def(0x161)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x402116,userKeyword:_0x3182f3}=_0x303a67,_0x5649df='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x402116?_0x314def(0x188)+_0x402116+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%'+_0x402116+_0x314def(0x1f2):'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3182f3?'\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username\x20LIKE\x20(\x27%'+_0x3182f3+_0x314def(0x267)+_0x3182f3+_0x314def(0x29d)+_0x3182f3+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.email\x20LIKE\x20(\x27%'+_0x3182f3+'%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20':'')+_0x314def(0x1df)+(_0x1b1142?_0x314def(0x2a2)+_0x1b1142:'')+_0x314def(0x1dc),_0x45cc8e=await this[_0x314def(0x138)][_0x314def(0x2a1)](_0x314def(0x12f)+_0x5649df+_0x314def(0x1dc)),_0x17d979=await this['connection'][_0x314def(0x2a1)](_0x314def(0x13a)+_0x5649df+_0x314def(0x168)+size+_0x314def(0x1d1)+(page-0x1)*size+_0x314def(0x1dc));return _0x4dcad8['user'][_0x314def(0x238)]!=='super'&&_0x17d979[_0x314def(0x184)](_0x504198=>{const _0x4bf487=_0x314def;_0x504198[_0x4bf487(0x106)]=(0x0,utils_1['maskEmail'])(_0x504198['email']),_0x504198['phone']=(0x0,utils_1['maskEmail'])(_0x504198['phone']);}),{'rows':_0x17d979,'count':Number(_0x45cc8e[0x0]?.[_0x314def(0x261)]||0x0)};}async[_0x940958(0x147)](_0x28ea6d,_0x5e02b0){const _0x5ab9e0=_0x940958;if(!_0x28ea6d[_0x5ab9e0(0x1cb)]||!_0x28ea6d[_0x5ab9e0(0x1cb)][_0x5ab9e0(0x28e)])return!![];const _0x623480={'id':(0x0,typeorm_1['In'])(_0x28ea6d['ids'])};return _0x5e02b0&&(_0x623480[_0x5ab9e0(0x223)]=_0x5e02b0),await this['pptTaskEntity'][_0x5ab9e0(0x11b)](_0x623480,{'delFlag':0x1}),!![];}};ChatgptService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x940958(0x220)])(user_entity_1[_0x940958(0x1cc)])),__param(0x1,(0x0,typeorm_2[_0x940958(0x220)])(pptTask_entity_1[_0x940958(0x2a5)])),__param(0x2,(0x0,typeorm_2[_0x940958(0x220)])(whiteList_entity_1['WhiteListEntity'])),__metadata(_0x940958(0x170),[typeorm_1[_0x940958(0x16b)],typeorm_1[_0x940958(0x16b)],typeorm_1[_0x940958(0x16b)],chatLog_service_1['ChatLogService'],user_service_1[_0x940958(0x262)],file_service_1[_0x940958(0x25b)],badwords_service_1[_0x940958(0x2a0)],autoreply_service_1[_0x940958(0x130)],globalConfig_service_1[_0x940958(0x1ae)],chatGroup_service_1[_0x940958(0x27a)],models_service_1[_0x940958(0x137)],gpts_service_1[_0x940958(0x1af)],yooPPT_service_1[_0x940958(0x26c)],lumaTask_service_1['LumaTaskService'],typeorm_1[_0x940958(0x164)]])],ChatgptService),exports[_0x940958(0x1b6)]=ChatgptService;