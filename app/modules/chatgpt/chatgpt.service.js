'use strict';const _0x3f82f6=_0x32c0;(function(_0x5c7873,_0x210c63){const _0x2a9390=_0x32c0,_0x41219a=_0x5c7873();while(!![]){try{const _0x54d8f5=parseInt(_0x2a9390(0x1a6))/0x1+-parseInt(_0x2a9390(0x2ef))/0x2+-parseInt(_0x2a9390(0x1d0))/0x3+-parseInt(_0x2a9390(0x1cd))/0x4+parseInt(_0x2a9390(0x1e1))/0x5+parseInt(_0x2a9390(0x2a0))/0x6*(parseInt(_0x2a9390(0xf4))/0x7)+parseInt(_0x2a9390(0xce))/0x8;if(_0x54d8f5===_0x210c63)break;else _0x41219a['push'](_0x41219a['shift']());}catch(_0x57808f){_0x41219a['push'](_0x41219a['shift']());}}}(_0x2f4d,0x282a0));var __decorate=this&&this[_0x3f82f6(0x215)]||function(_0x53733a,_0x5917b9,_0x196030,_0x41e861){const _0x48343e=_0x3f82f6;var _0x3868ee=arguments[_0x48343e(0x229)],_0x20ac79=_0x3868ee<0x3?_0x5917b9:_0x41e861===null?_0x41e861=Object[_0x48343e(0x2a2)](_0x5917b9,_0x196030):_0x41e861,_0x2a4acb;if(typeof Reflect===_0x48343e(0x281)&&typeof Reflect['decorate']===_0x48343e(0x12b))_0x20ac79=Reflect['decorate'](_0x53733a,_0x5917b9,_0x196030,_0x41e861);else{for(var _0x2a5e6e=_0x53733a['length']-0x1;_0x2a5e6e>=0x0;_0x2a5e6e--)if(_0x2a4acb=_0x53733a[_0x2a5e6e])_0x20ac79=(_0x3868ee<0x3?_0x2a4acb(_0x20ac79):_0x3868ee>0x3?_0x2a4acb(_0x5917b9,_0x196030,_0x20ac79):_0x2a4acb(_0x5917b9,_0x196030))||_0x20ac79;}return _0x3868ee>0x3&&_0x20ac79&&Object[_0x48343e(0x1b1)](_0x5917b9,_0x196030,_0x20ac79),_0x20ac79;},__metadata=this&&this['__metadata']||function(_0x99120b,_0x37867c){const _0x4e8491=_0x3f82f6;if(typeof Reflect===_0x4e8491(0x281)&&typeof Reflect[_0x4e8491(0x243)]===_0x4e8491(0x12b))return Reflect[_0x4e8491(0x243)](_0x99120b,_0x37867c);},__param=this&&this['__param']||function(_0x108aef,_0x374042){return function(_0x27af5f,_0x4ec233){_0x374042(_0x27af5f,_0x4ec233,_0x108aef);};};Object['defineProperty'](exports,_0x3f82f6(0x301),{'value':!![]}),exports[_0x3f82f6(0x1d1)]=void 0x0;const file_service_1=require('../file/file.service'),user_service_1=require(_0x3f82f6(0x1eb)),openai_1=require('openai'),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x3f82f6(0x1c2)),utils_1=require(_0x3f82f6(0x1b3)),axios_1=require(_0x3f82f6(0x2dd)),balance_constant_1=require(_0x3f82f6(0x2eb)),chatLog_service_1=require(_0x3f82f6(0x30d)),uuid=require('uuid'),fs=require('fs'),typeorm_1=require(_0x3f82f6(0x165)),typeorm_2=require(_0x3f82f6(0x2ce)),badwords_service_1=require('../badwords/badwords.service'),autoreply_service_1=require(_0x3f82f6(0x115)),globalConfig_service_1=require(_0x3f82f6(0xf0)),chatGroup_service_1=require('../chatGroup/chatGroup.service'),models_service_1=require(_0x3f82f6(0x125)),baidu_1=require(_0x3f82f6(0x1ae)),helper_1=require('./helper'),store_1=require('./store'),zhipu_1=require('./zhipu'),spark_1=require(_0x3f82f6(0x114)),model_constant_1=require('../../common/constants/model.constant'),fs_1=require('fs'),path_1=require(_0x3f82f6(0x109)),gpts_service_1=require('../gpts/gpts.service'),yooPPT_service_1=require('../api/yooPPT.service'),pptTask_entity_1=require('./entity/pptTask.entity'),ppt_constant_1=require(_0x3f82f6(0x27a)),lumaTask_service_1=require(_0x3f82f6(0x14b)),nestjs_cls_1=require('nestjs-cls'),doubao_service_1=require(_0x3f82f6(0xc4)),crypto_1=require(_0x3f82f6(0x23c)),chat_constant_1=require('../../common/constants/chat.constant'),result_1=require(_0x3f82f6(0x15c)),runwayTask_service_1=require('../api/runwayTask.service'),klingTask_service_1=require(_0x3f82f6(0x20c)),sunoTask_service_1=require('../api/sunoTask.service'),mindTask_service_1=require(_0x3f82f6(0x157)),collectType_constant_1=require(_0x3f82f6(0x1e2)),redisKey_constant_1=require(_0x3f82f6(0x28f)),store_2=require(_0x3f82f6(0x21d)),music_constant_1=require(_0x3f82f6(0x213)),openapi_1=require('@volcengine/openapi'),veoTask_service_1=require(_0x3f82f6(0xe9)),FormData=require(_0x3f82f6(0x27c));let ChatgptService=class ChatgptService{constructor(_0x3524c0,_0x2e00c4,_0x15f235,_0x511659,_0x1710fc,_0x470d88,_0x3d5a4f,_0x460430,_0x534f89,_0x398af5,_0x543a7c,_0x4f0a89,_0x8d9c0c,_0x342765,_0xb1cbc8,_0x1e6ab6,_0x7db016,_0x43d49f,_0x2afa41,_0x1475d7){const _0x222e00=_0x3f82f6;this[_0x222e00(0x10f)]=_0x3524c0,this['clsService']=_0x2e00c4,this[_0x222e00(0x214)]=_0x15f235,this[_0x222e00(0x10b)]=_0x511659,this[_0x222e00(0x9c)]=_0x1710fc,this[_0x222e00(0x1b2)]=_0x470d88,this['doubaoService']=_0x3d5a4f,this[_0x222e00(0xb0)]=_0x460430,this[_0x222e00(0x1ec)]=_0x534f89,this['lumaTaskService']=_0x398af5,this[_0x222e00(0x1c1)]=_0x543a7c,this[_0x222e00(0x22b)]=_0x4f0a89,this['sunoTaskService']=_0x8d9c0c,this[_0x222e00(0xad)]=_0x342765,this[_0x222e00(0x239)]=_0xb1cbc8,this[_0x222e00(0x1dd)]=_0x1e6ab6,this[_0x222e00(0x2e6)]=_0x7db016,this[_0x222e00(0x20f)]=_0x43d49f,this[_0x222e00(0x1fd)]=_0x2afa41,this[_0x222e00(0xb6)]=_0x1475d7,this[_0x222e00(0x10d)]='https://api.openai.com',this[_0x222e00(0x18c)]=null,this[_0x222e00(0x19c)]=null,this[_0x222e00(0xff)]=_0x3fb1c7=>{const _0x4b411e=_0x222e00;return fs[_0x4b411e(0x222)](_0x3fb1c7,_0x11ee29=>{const _0x1218eb=_0x4b411e;_0x11ee29?console[_0x1218eb(0x26c)](_0x1218eb(0x2ee),_0x11ee29):console[_0x1218eb(0x26c)]('remove\x20file\x20%s\x20success',_0x3fb1c7);});};}async['onModuleInit'](){const _0x339571=_0x3f82f6;let _0x4feedd=await(0x0,utils_1[_0x339571(0x190)])(_0x339571(0x194));_0x4feedd=_0x4feedd?.['default']?_0x4feedd[_0x339571(0xf6)]:_0x4feedd,this[_0x339571(0x112)]=_0x4feedd[_0x339571(0x15b)];let _0x980ebf=await(0x0,utils_1['importDynamic'])(_0x339571(0x1e4));_0x980ebf=_0x980ebf?.[_0x339571(0xf6)]?_0x980ebf[_0x339571(0xf6)]:_0x980ebf;let _0x262de4=await(0x0,utils_1[_0x339571(0x190)])(_0x339571(0x2b2));_0x262de4=_0x262de4?.['default']?_0x262de4['default']:_0x262de4;const _0x4674b9=+process[_0x339571(0x302)][_0x339571(0x210)],_0x19a957=process[_0x339571(0x302)][_0x339571(0x26d)],_0x29ab2f=process['env'][_0x339571(0x18e)],_0x4a57ff=process['env'][_0x339571(0x161)],_0x18958c=_0x339571(0xbe)+(_0x4a57ff||'')+':'+(_0x29ab2f||'')+'@'+_0x19a957+':'+_0x4674b9,_0x325391=new _0x262de4(_0x18958c);this[_0x339571(0x18c)]=new _0x980ebf({'store':_0x325391,'namespace':_0x339571(0x16f)}),this[_0x339571(0x19c)]=new store_1[(_0x339571(0x267))]({'store':this['messageStore'],'namespace':_0x339571(0x1c3)}),!this[_0x339571(0xaf)]&&this[_0x339571(0x113)]();}[_0x3f82f6(0x113)](){const _0x2e4804=_0x3f82f6;this[_0x2e4804(0xaf)]=new openai_1[(_0x2e4804(0xf6))]({'apiKey':_0x2e4804(0x14d),'baseURL':this[_0x2e4804(0x10d)]+_0x2e4804(0x212)});}async['getModelConfig'](_0x56fc5b){const _0x34f19c=_0x3f82f6,{type:_0x1227a6,groupId:_0x43cbf9,modelType:_0x1579ef,officialModel:_0x2ecf5f,keyType:_0x2b6f2c}=_0x56fc5b;console[_0x34f19c(0x26c)](_0x34f19c(0x10e),_0x56fc5b);let _0x3d7b1c,_0x38936c;_0x1227a6&&_0x1227a6===_0x34f19c(0x220)?(_0x38936c=await this[_0x34f19c(0x9c)][_0x34f19c(0x103)](_0x43cbf9),_0x3d7b1c=_0x38936c[_0x34f19c(0x163)]):_0x38936c=await this[_0x34f19c(0x2e6)][_0x34f19c(0x103)](_0x43cbf9);let _0x32b5b5;if(_0x38936c)_0x32b5b5=JSON['parse'](_0x38936c['config']);else{if(_0x2b6f2c)_0x32b5b5=await this['modelsService'][_0x34f19c(0x235)](_0x1579ef,_0x2b6f2c);else _0x1579ef?_0x32b5b5=await this[_0x34f19c(0xb0)]['getModelByType'](_0x1579ef,_0x2ecf5f):_0x32b5b5=await this[_0x34f19c(0xb0)][_0x34f19c(0x2fa)](model_constant_1[_0x34f19c(0x15a)][_0x34f19c(0x1f3)]);}if(!_0x32b5b5)throw new common_1[(_0x34f19c(0x2d6))]('未获取到模型基础配置，请前往后台配置并启用',common_1[_0x34f19c(0x11a)][_0x34f19c(0xcf)]);return{'appId':_0x3d7b1c,'modelConfig':_0x32b5b5};}async[_0x3f82f6(0xeb)](_0x18447b){const _0x573149=_0x3f82f6,_0x4dc66e=this;let _0x4956d9='',_0x14994b='',{type:_0xf41fd1,appId:_0x3b808b,prompt:_0x5bbe9f,custom:_0x21faad,usingNetwork:_0x3d1e6f,systemMessage:_0x51f16b,customSystemMessage:_0x1d12d2}=_0x18447b;const _0x547733=async function(){const _0x127780=_0x32c0,_0x826f11=new Date()[_0x127780(0x25f)]()[_0x127780(0x2d9)]('T')[0x0];return _0x14994b=await _0x4dc66e[_0x127780(0x20f)][_0x127780(0x2f4)]([_0x127780(0x150)]),_0x14994b+('\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20'+_0x826f11);};if(_0x3b808b){const _0x426d10=await this[_0x573149(0x9c)]['getAppById'](_0x3b808b,0x1);if(!_0x426d10)throw new common_1[(_0x573149(0x2d6))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1['HttpStatus']['BAD_REQUEST']);_0x426d10[_0x573149(0x12e)]&&(_0x51f16b=_0x426d10[_0x573149(0x12e)]);}else{if(_0x21faad)_0x51f16b=_0x51f16b;else _0x1d12d2?_0x51f16b=_0x1d12d2:_0xf41fd1!==_0x573149(0x220)&&(_0x51f16b=await _0x547733());}return _0x3d1e6f&&(_0x4956d9=await(0x0,utils_1['compileNetwork'])(_0x5bbe9f),!_0x14994b&&(_0x51f16b=await _0x547733())),{'systemMessage':_0x51f16b,'netWorkPrompt':_0x4956d9};}async['getCurrentModel'](_0xaaa5da){const _0x4934c4=_0x3f82f6,{type:_0x493b1f,custom:_0x3ab6d0,groupId:_0x9e3573,modelConfig:_0x46f751}=_0xaaa5da;let _0x47559d=null;if(!_0x3ab6d0&&!_0x493b1f){const _0x21da9d=await this[_0x4934c4(0xb0)][_0x4934c4(0x2fa)](model_constant_1[_0x4934c4(0x15a)][_0x4934c4(0x1f8)],_0x46f751[_0x4934c4(0x216)][_0x4934c4(0x198)]);_0x47559d=_0x21da9d[_0x4934c4(0x216)];}else{if(_0x493b1f==='gpts')_0x47559d=await this[_0x4934c4(0x9c)][_0x4934c4(0x2a9)](_0x9e3573);else{if(_0x493b1f===_0x4934c4(0xba)){const _0x4b81b5=await this[_0x4934c4(0xb0)][_0x4934c4(0x2fa)](model_constant_1[_0x4934c4(0x15a)][_0x4934c4(0x1d9)],_0x46f751[_0x4934c4(0x216)]['model']);_0x47559d=_0x4b81b5[_0x4934c4(0x216)];}else _0x3ab6d0?_0x47559d=await this[_0x4934c4(0xb0)]['getRandomKey'](model_constant_1[_0x4934c4(0x15a)]['OTHER']):_0x47559d=await this['modelsService']['getRandomKey'](model_constant_1[_0x4934c4(0x15a)][_0x4934c4(0x1f8)]);}}if(!_0x47559d)throw new common_1['HttpException'](_0x4934c4(0x22d),common_1[_0x4934c4(0x11a)][_0x4934c4(0xcf)]);return _0x493b1f===_0x4934c4(0x220)?_0x46f751[_0x4934c4(0x216)][_0x4934c4(0x198)]=_0x47559d[_0x4934c4(0x198)]:_0x47559d[_0x4934c4(0x198)]=_0x46f751[_0x4934c4(0x216)]['model'],_0x47559d;}async['validateVideoBeforeChat'](_0x3e4a05){const _0x1d8ebd=_0x3f82f6,{user:_0x167850,prompt:_0x2cd64b,currentRequestModel:_0x4e8ff5,requestParams:_0x28ffb8}=_0x3e4a05;await this[_0x1d8ebd(0x214)][_0x1d8ebd(0x1ba)](_0x167850),await this['badwordsService'][_0x1d8ebd(0x2d7)](_0x2cd64b,_0x167850['id']),await this[_0x1d8ebd(0x214)][_0x1d8ebd(0x20b)](_0x167850['id'],_0x4e8ff5,_0x28ffb8),await this[_0x1d8ebd(0x214)]['validateUserType'](_0x167850['id'],_0x4e8ff5['userType']);}async[_0x3f82f6(0x24d)](_0x168e4d){const _0x5431f0=_0x3f82f6,{user:_0x547132,prompt:_0x2ec0c6,currentRequestModel:_0x593e81}=_0x168e4d;await this[_0x5431f0(0x214)][_0x5431f0(0x1ba)](_0x547132),await this['badwordsService'][_0x5431f0(0x2d7)](_0x2ec0c6,_0x547132['id']),await this[_0x5431f0(0x214)][_0x5431f0(0x1c8)](_0x547132['id'],_0x593e81),await this[_0x5431f0(0x214)][_0x5431f0(0x1b6)](_0x547132['id'],_0x593e81[_0x5431f0(0x1ea)]);}async[_0x3f82f6(0xaa)](_0x3bd22a){const _0x11174d=_0x3f82f6,{user:_0x4d63e6,prompt:_0x35de46,currentRequestModel:_0x2b8cbe,count:_0x937990}=_0x3bd22a;await this[_0x11174d(0x214)]['checkUserStatus'](_0x4d63e6),await this[_0x11174d(0x239)][_0x11174d(0x2d7)](_0x35de46,_0x4d63e6['id']),await this['userService']['validateBalance4Draw'](_0x4d63e6['id'],_0x2b8cbe,_0x937990||0x1),await this['userService']['validateUserType'](_0x4d63e6['id'],_0x2b8cbe[_0x11174d(0x1ea)]);}async[_0x3f82f6(0x126)](_0x998e63,_0x4fba49,_0x5995b1){const _0x5a29e9=_0x3f82f6,_0x3ae232=await this[_0x5a29e9(0x20f)][_0x5a29e9(0x2f4)](['openaiTimeoutMs']),_0x1ff536=Number(_0x3ae232)||0x493e0,_0x4620fa={'timeoutMs':+_0x1ff536,'systemMessage':_0x4fba49||'','parentMessageId':_0x998e63||'','completionParams':{'temperature':0.8,'model':_0x5995b1[_0x5a29e9(0x198)]}};return _0x4620fa;}async[_0x3f82f6(0xf9)](_0x4a762a,_0x5487d1){const _0x10faa7=_0x3f82f6;let _0x1104b3=_0x4a762a[_0x10faa7(0xfe)];if(!_0x1104b3){const _0x781326=await this[_0x10faa7(0x20f)][_0x10faa7(0x2f4)]([_0x10faa7(0x142)]);_0x781326?_0x1104b3=_0x781326:_0x1104b3='https://api.openai.com';}const _0x3edc31=0x1f40,_0x526eb8=0x1000;let _0x7d1c47='v1';_0x1104b3['indexOf']('v2')==-0x1&&(_0x1104b3=_0x1104b3+'/'+_0x7d1c47);const _0x22ca84=new this['api']({'maxModelTokens':_0x3edc31,'apiBaseUrl':_0x1104b3,'messageStore':this[_0x10faa7(0x18c)],'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x4a762a['key']),'maxResponseTokens':_0x526eb8>=_0x3edc31?Math[_0x10faa7(0xd1)](Math['floor'](_0x3edc31/0x2)):_0x526eb8});return _0x22ca84;}async[_0x3f82f6(0x25c)](_0x1c514f){const _0x34bfcd=_0x3f82f6,_0x50b8fb=new openai_1[(_0x34bfcd(0xf6))]({'baseURL':_0x1c514f['proxyUrl']+_0x34bfcd(0x212)||_0x34bfcd(0xd6),'apiKey':_0x1c514f[_0x34bfcd(0x29d)]});return _0x50b8fb;}async[_0x3f82f6(0x175)](_0x212cb3){const _0x1cb793=_0x3f82f6;let _0x56f481=_0x212cb3[_0x1cb793(0xfe)]||_0x1cb793(0x1df);const _0x4dd497=new openai_1[(_0x1cb793(0xf6))]({'baseURL':_0x56f481+_0x1cb793(0x1bd),'apiKey':(0x0,utils_1[_0x1cb793(0xe5)])(_0x212cb3[_0x1cb793(0x29d)])});return _0x4dd497;}async['kimiUpload'](_0x3e21d0,_0xaae72c,_0x55d349=null){const _0x5ba088=_0x3f82f6;let _0x3d20ab=[];for(const _0x24f54c of _0xaae72c){const _0xad934=new URL(_0x24f54c);let _0x4dc4ff=(0x0,path_1['join'])(process[_0x5ba088(0x101)](),_0x5ba088(0x93),_0xad934['pathname']);_0x4dc4ff=decodeURIComponent(_0x4dc4ff);const _0xe8dcb8=await _0x3e21d0[_0x5ba088(0x2ba)][_0x5ba088(0x2cd)]({'file':fs[_0x5ba088(0xcd)](_0x4dc4ff),'purpose':_0x5ba088(0x139)});let _0x424641=await(await _0x3e21d0[_0x5ba088(0x2ba)][_0x5ba088(0xb7)](_0xe8dcb8['id']))[_0x5ba088(0x116)]();_0x3d20ab[_0x5ba088(0x2d0)]({'role':'system','content':_0x424641});}return _0x3d20ab;}async[_0x3f82f6(0x141)](_0x54e498,_0x580906){const _0x283ee5=_0x3f82f6;console['log'](_0x283ee5(0x110),_0x54e498);let _0x4304b2='',_0x1b4fc6=_0x54e498[_0x283ee5(0x240)];return!_0x4304b2&&(_0x4304b2=errorMessage_constant_1[_0x283ee5(0x21c)][_0x1b4fc6]?errorMessage_constant_1[_0x283ee5(0x21c)][_0x1b4fc6]:_0x283ee5(0xb5)),_0x54e498?.[_0x283ee5(0xd8)]['includes'](_0x283ee5(0x1bf))&&(await this['modelsService'][_0x283ee5(0x201)](_0x580906['id'],_0x283ee5(0x231),-0x1),_0x4304b2=_0x283ee5(0x226)),_0x54e498?.[_0x283ee5(0x240)]===0x1ad&&_0x54e498['message'][_0x283ee5(0xc6)](_0x283ee5(0x248))&&(await this['modelsService'][_0x283ee5(0x201)](_0x580906['id'],'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x4304b2='当前模型key余额已耗尽'),_0x54e498?.[_0x283ee5(0x240)]===0x191&&_0x54e498[_0x283ee5(0xd8)][_0x283ee5(0xc6)](_0x283ee5(0xc2))&&(await this[_0x283ee5(0xb0)][_0x283ee5(0x201)](_0x580906['id'],_0x283ee5(0xa8),-0x2),_0x4304b2=_0x283ee5(0x186)),_0x54e498?.['statusCode']===0x191&&(_0x4304b2=_0x283ee5(0x186)),_0x54e498?.[_0x283ee5(0x240)]===0x191&&_0x54e498[_0x283ee5(0xd8)][_0x283ee5(0xc6)](_0x283ee5(0x15f))&&(await this[_0x283ee5(0xb0)][_0x283ee5(0x201)](_0x580906['id'],'模型秘钥错误或模型余额不足',-0x2),_0x4304b2=_0x283ee5(0x186)),_0x54e498?.[_0x283ee5(0x240)]===0x194&&_0x54e498[_0x283ee5(0xd8)][_0x283ee5(0xc6)](_0x283ee5(0x9e))&&(await this[_0x283ee5(0xb0)]['lockKey'](_0x580906['id'],_0x283ee5(0xa7),-0x4),_0x4304b2=_0x283ee5(0x17e)),_0x4304b2;}[_0x3f82f6(0x266)](_0x1e5f30,_0x196b46,_0x3512d5,_0x436c50,_0x170ff9){const _0x5d1e9f=_0x3f82f6;let _0x5da00e='';_0x196b46['detail']['choices'][_0x5d1e9f(0x229)]&&_0x196b46[_0x5d1e9f(0x1d7)][_0x5d1e9f(0x106)][_0x5d1e9f(0x207)](_0x645bcc=>{const _0x3140db=_0x5d1e9f;_0x645bcc[_0x3140db(0x2e4)]?.[_0x3140db(0x2b3)]&&(_0x5da00e+=_0x645bcc[_0x3140db(0x2e4)][_0x3140db(0x2b3)]);});_0x196b46['think']=_0x5da00e;if(_0x3512d5)_0x1e5f30[_0x5d1e9f(0x2ff)](_0x5d1e9f(0x14f)+JSON[_0x5d1e9f(0x122)](_0x196b46)+'\x0a\x0a');else _0x436c50&&_0x1e5f30['write'](_0x170ff9?JSON['stringify'](_0x196b46):'\x0a'+JSON[_0x5d1e9f(0x122)](_0x196b46));return _0x5da00e;}[_0x3f82f6(0x270)](_0xb8a9e3,_0x361f09,_0x41139c,_0x75788e,_0x1c0b6d){const _0x232fca=_0x3f82f6;if(_0x41139c)console[_0x232fca(0x26c)](_0x232fca(0xe2),_0x361f09),_0xb8a9e3['write'](_0x232fca(0x14f)+JSON[_0x232fca(0x122)](_0x361f09)+'\x0a\x0a');else _0x75788e&&(console['log'](_0x232fca(0xe2),_0x361f09),_0xb8a9e3['write'](_0x1c0b6d?JSON['stringify'](_0x361f09):'\x0a'+JSON[_0x232fca(0x122)](_0x361f09)));}async[_0x3f82f6(0x285)](_0xc2f1c8,_0x30ba88){const _0x487bbb=_0x3f82f6,{options:options={},prompt:_0x534513,cusromPrompt:_0x4d6530}=_0xc2f1c8,{groupId:_0x2e5298,type:_0x558733}=options,{modelConfig:_0x12ae8d}=await this[_0x487bbb(0x276)]({'type':_0x558733,'groupId':_0x2e5298}),_0x353ebf=await this['getCurrentModel']({'type':_0x558733,'groupId':_0x2e5298,'modelConfig':_0x12ae8d,'custom':_0x4d6530});return await this[_0x487bbb(0x24d)]({'prompt':_0x534513,'currentRequestModel':_0x353ebf,'user':_0x30ba88['user']}),!![];}async[_0x3f82f6(0x208)](_0x4d8660,_0x582546,_0x326d1c,_0x199fc0=!![],_0x463404=''){const _0x340452=_0x3f82f6;try{const _0x270116=_0x582546[_0x340452(0x2c7)],_0x5aaef8=(0x0,utils_1[_0x340452(0xb2)])(this[_0x340452(0x1ee)]),{options:options={},prompt:_0x2592d0,cusromPrompt:_0xc8e6b,assetsId:_0x845e1c,autoVoice:_0x1bff53}=_0x4d8660,{groupId:_0x26347d,usingNetwork:_0x1f9cd9,parentMessageId:_0x1db7b9,type:_0x64ddbd}=options,{appId:_0x19267c,modelConfig:_0x16af55}=await this[_0x340452(0x276)]({'type':_0x64ddbd,'groupId':_0x26347d}),{systemMessage:_0x53f9ce,netWorkPrompt:_0x4a9f8f}=await this[_0x340452(0xeb)]({'type':_0x64ddbd,'appId':_0x19267c,'prompt':_0x2592d0,'usingNetwork':_0x1f9cd9,'custom':_0xc8e6b,'systemMessage':_0x4d8660['systemMessage'],'customSystemMessage':_0x4d8660['customSystemMessage']||_0x16af55['modelInfo'][_0x340452(0x1d5)]}),_0x3e2373=await this[_0x340452(0x2b7)]({'type':_0x64ddbd,'groupId':_0x26347d,'modelConfig':_0x16af55,'custom':_0xc8e6b});await this[_0x340452(0x24d)]({'prompt':_0x2592d0,'currentRequestModel':_0x3e2373,'user':_0x582546['user']});let _0x449359='';const _0x5ca4e0=await this['autoreplyService'][_0x340452(0x138)](_0x2592d0);_0x326d1c&&_0x199fc0&&(!_0x4d8660[_0x340452(0x184)]?_0x326d1c['setHeader']('Content-type',_0x340452(0x24e)):(_0x326d1c[_0x340452(0x2d5)](_0x340452(0x105),_0x340452(0x24c)),_0x326d1c[_0x340452(0x2d5)]('Transfer-Encoding',_0x340452(0x265)),_0x326d1c[_0x340452(0x2d5)](_0x340452(0x9a),_0x340452(0x1fb)),_0x326d1c['setHeader']('X-Accel-Buffering','no'),_0x326d1c['setHeader']('Access-Control-Allow-Origin','*')));if(_0x5ca4e0){if(_0x326d1c&&_0x199fc0){const _0x3143c2={'message':_0x5ca4e0,'code':0x1f4};_0x326d1c['write'](JSON['stringify'](_0x3143c2)),_0x326d1c[_0x340452(0x117)]();return;}else return _0x5ca4e0;}const _0x2a45c5=await this['buildOptions'](options[_0x340452(0x180)],_0x53f9ce,_0x3e2373);options[_0x340452(0x198)]&&(_0x2a45c5['completionParams'][_0x340452(0x198)]=options[_0x340452(0x198)]);let {model:_0x1c93af,rounds:_0x47c947,keyType:_0x117c72,modelType:_0x1960b0,id:_0x10363c,topN:_0x357cfe}=_0x16af55['modelInfo'];const {key:_0x225fc9,modelName:_0x5a877a,id:_0x1b6c87,accessToken:_0x4d3da8}=_0x3e2373;_0x1c93af=_0x2a45c5['completionParams']['model'];_0x326d1c&&_0x199fc0&&_0x326d1c[_0x340452(0x269)](0xc8);let _0x3a9667=null,_0x5d823b=null;const _0x177c1c=(0x0,utils_1[_0x340452(0x289)])(_0x582546),_0x1adc5e={'appId':_0x19267c,'curIp':_0x177c1c,'prompt':_0x2592d0,'groupId':_0x26347d,'modelId':_0x10363c,'modelType':_0x1960b0,'answer':'','model':_0x1c93af,'role':_0x340452(0x28b),'userId':_0x582546[_0x340452(0x28b)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x340452(0x2c8)][_0x340452(0x177)],'logType':_0x64ddbd==='gpts'?0x2:0x1,'requestOptions':JSON[_0x340452(0x122)]({'options':options,'prompt':_0x2592d0}),'saasId':_0x5aaef8,'modelSubType':_0x463404},_0x25a5c3={..._0x1adc5e,'role':_0x340452(0x1c9),'requestOptions':JSON['stringify']({'prompt':_0x2592d0,'options':{'model':_0x1c93af,'temperature':_0x357cfe}})};try{if(_0x326d1c){let _0x9d83d9=null,_0x472b85=![];_0x326d1c['on']('close',async()=>{const _0x35d271=_0x340452;if(_0x472b85)return;_0x270116[_0x35d271(0x288)]();const _0x5d5e6f=0x0,_0x3e8e62=0x0,_0x4ed3e5=_0x5d5e6f+_0x3e8e62;_0x1adc5e[_0x35d271(0xe0)]=_0x5d5e6f,_0x1adc5e['promptTokens']=_0x5d5e6f,await this['chatLogService'][_0x35d271(0x136)](_0x1adc5e),_0x25a5c3[_0x35d271(0x21f)]=_0x9d83d9?.[_0x35d271(0x116)],_0x25a5c3[_0x35d271(0xe0)]=_0x4ed3e5,_0x25a5c3['promptTokens']=_0x5d5e6f,_0x25a5c3['completionTokens']=_0x3e8e62,_0x25a5c3['conversationOptions']=JSON['stringify']({'conversationId':_0x9d83d9?.[_0x35d271(0x137)],'model':_0x1c93af,'parentMessageId':_0x9d83d9?.['id'],'temperature':_0x357cfe});const _0x16e7ee=await this['chatLogService'][_0x35d271(0x136)](_0x25a5c3);if(_0x463404==_0x35d271(0x2c0)){const _0x46b93e=await this[_0x35d271(0xb6)][_0x35d271(0xbb)]({'id':_0x845e1c,'userId':_0x16e7ee['userId'],'chatLogId':_0x16e7ee['id'],'prompt':_0x16e7ee['prompt'],'result':_0x25a5c3[_0x35d271(0x21f)],'status':0x1});_0x3a9667[_0x35d271(0x1cb)]=_0x46b93e['id'];}await this[_0x35d271(0x214)][_0x35d271(0xd5)](_0x582546[_0x35d271(0x28b)]['id'],_0x3e2373,_0x16e7ee['id']);}),_0x326d1c['on'](_0x340452(0x2fb),_0x4c93ff=>{console['log'](_0x4c93ff);});if(Number(_0x117c72)===0x1){if(_0x3e2373[_0x340452(0x2fd)][_0x340452(0x1f7)]()['includes'](_0x340452(0x2e8))||_0x3e2373['modelName'][_0x340452(0x1f7)]()[_0x340452(0xc6)](_0x340452(0xdf))||_0x3e2373[_0x340452(0x2fd)][_0x340452(0x1f7)]()[_0x340452(0xc6)](_0x340452(0x179))){let _0x5bdbc1=_0x3e2373['proxyUrl'];if(!_0x5bdbc1){const _0x5914c0=await this[_0x340452(0x20f)][_0x340452(0x2f4)]([_0x340452(0x142)]);_0x5914c0?_0x5bdbc1=_0x5914c0:_0x5bdbc1=_0x340452(0x167);}let _0x1ecc47='v1';_0x5bdbc1[_0x340452(0x2b4)]('v2')==-0x1&&(_0x5bdbc1=_0x5bdbc1+'/'+_0x1ecc47);let _0x186465=!![];const _0x382a2a=await this[_0x340452(0x19c)]['buildMessageFromParentMessageId'](_0x1f9cd9?_0x4a9f8f:_0x2592d0,{'parentMessageId':_0x1db7b9,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x47c947)});_0x3a9667=await(0x0,zhipu_1['sendMessageFromFastgpt'])(_0x1f9cd9?_0x4a9f8f:_0x382a2a,{'key':_0x3e2373['key'],'chatId':this['gomaxAiStore'][_0x340452(0x2f1)](),'model':_0x1c93af,'apiUrl':_0x5bdbc1,'onProgress':_0x4a7dc0=>{const _0x232dce=_0x340452;let _0x2cb2a9=this[_0x232dce(0x266)](_0x326d1c,_0x4a7dc0,_0x4d8660[_0x232dce(0x184)],_0x199fc0,_0x186465);_0x449359+=_0x2cb2a9,_0x186465=![],_0x9d83d9=_0x4a7dc0;}}),_0x472b85=!![];}else{let _0x563505=!![];const _0x4aa5fe=await this[_0x340452(0xf9)](_0x3e2373,_0x2a45c5);_0x3a9667=await _0x4aa5fe[_0x340452(0x278)](_0x1f9cd9?_0x4a9f8f:_0x2592d0,{..._0x2a45c5,'onProgress':_0x2cf4a9=>{const _0x3f63a3=_0x340452;let _0x556342=this['responseMessageWithThink'](_0x326d1c,_0x2cf4a9,_0x4d8660[_0x3f63a3(0x184)],_0x199fc0,_0x563505);_0x449359+=_0x556342,_0x563505=![],_0x9d83d9=_0x2cf4a9;},'abortSignal':_0x270116[_0x340452(0x17b)]}),_0x472b85=!![];}}if(Number(_0x117c72)===0x2){let _0x513a8e=!![];const _0x44b316=await this[_0x340452(0x19c)][_0x340452(0x1f4)](_0x1f9cd9?_0x4a9f8f:_0x2592d0,{'parentMessageId':_0x1db7b9,'maxRounds':(0x0,helper_1[_0x340452(0x271)])(_0x47c947)});_0x3a9667=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x1f9cd9?_0x4a9f8f:_0x44b316,{'temperature':_0x357cfe,'accessToken':_0x4d3da8,'model':_0x1c93af,'onProgress':_0x205835=>{const _0x3f5f95=_0x340452;this['responseMessage'](_0x326d1c,_0x205835,_0x4d8660[_0x3f5f95(0x184)],_0x199fc0,_0x513a8e),_0x513a8e=![],_0x9d83d9=_0x205835;}}),_0x472b85=!![];}if(Number(_0x117c72)===0x3){let _0x2c9a43=!![];const _0x19c2c8=await this[_0x340452(0x19c)][_0x340452(0x1f4)](_0x1f9cd9?_0x4a9f8f:_0x2592d0,{'parentMessageId':_0x1db7b9,'maxRounds':(0x0,helper_1[_0x340452(0x271)])(_0x47c947)});console['log'](_0x19c2c8),_0x3a9667=await(0x0,zhipu_1[_0x340452(0xc3)])(_0x1f9cd9?_0x4a9f8f:_0x19c2c8,{'temperature':_0x357cfe,'key':_0x225fc9,'model':_0x1c93af,'onProgress':_0x4b18b3=>{const _0x2757a0=_0x340452;this['responseMessage'](_0x326d1c,_0x4b18b3,_0x4d8660[_0x2757a0(0x184)],_0x199fc0,_0x2c9a43),_0x2c9a43=![],_0x9d83d9=_0x4b18b3;}}),_0x472b85=!![];}if(Number(_0x117c72)===0x4){let _0x2d8cc3=!![];const _0x243b0c=await this['gomaxAiStore'][_0x340452(0x1f4)](_0x1f9cd9?_0x4a9f8f:_0x2592d0,{'parentMessageId':_0x1db7b9,'maxRounds':(0x0,helper_1[_0x340452(0x271)])(_0x47c947)});_0x3a9667=await(0x0,spark_1[_0x340452(0x262)])(_0x1f9cd9?_0x4a9f8f:_0x243b0c,{'temperature':_0x357cfe,'key':_0x225fc9,'model':_0x1c93af,'onProgress':_0x1f2db0=>{const _0x44f65c=_0x340452;this[_0x44f65c(0x270)](_0x326d1c,_0x1f2db0,_0x4d8660[_0x44f65c(0x184)],_0x199fc0,_0x2d8cc3),_0x2d8cc3=![],_0x9d83d9=_0x1f2db0;}}),_0x472b85=!![];}if(Number(_0x117c72)===0x7){_0x3a9667={};const _0x28924d=await this[_0x340452(0x25c)](_0x3e2373);let _0x1c509f=!![],_0x1c06fa=[],_0x5651cf=!![];const _0x5df7ae=[],_0x255d9b=[],_0x365181=_0x2592d0[_0x340452(0x2d9)]('\x20');for(let _0x22bc00=0x0;_0x22bc00<_0x365181['length'];_0x22bc00++){_0x1c509f&&/^[http:\/\/|https:\/\/]/[_0x340452(0xdc)](_0x365181[_0x22bc00])?_0x5df7ae[_0x340452(0x2d0)](_0x365181[_0x22bc00]):(_0x1c509f=![],_0x365181[_0x22bc00]&&_0x255d9b['push'](_0x365181[_0x22bc00]));}if(options[_0x340452(0x180)]){const _0x1c14be=await this['chatLogService']['listByGroupId'](options[_0x340452(0x18a)]);_0x1c06fa=_0x1c14be[_0x340452(0x1f2)](_0x1b2bff=>{const _0xa9f7bd=_0x340452;return{'role':_0x1b2bff[_0xa9f7bd(0x135)]===_0xa9f7bd(0x28b)?'user':_0xa9f7bd(0x249),'content':_0x1b2bff[_0xa9f7bd(0x2df)]||_0x1b2bff[_0xa9f7bd(0x21f)]};});}const _0x302a53=await this[_0x340452(0x143)](_0x28924d,_0x5df7ae),_0x224c13=[..._0x1c06fa,..._0x302a53,{'role':_0x340452(0x249),'content':_0x340452(0xb4)+_0x340452(0x15e)+_0x340452(0x227)},{'role':_0x340452(0x28b),'content':_0x255d9b['join']('\x20')}],_0x23cdb1=await _0x28924d['chat'][_0x340452(0x2e0)][_0x340452(0x2cd)]({'stream':!![],..._0x2a45c5,'messages':_0x224c13,'model':_0x3e2373[_0x340452(0x198)]});for await(const _0x5dc8d0 of _0x23cdb1){const _0x248844=_0x5dc8d0?.[_0x340452(0x106)][0x0],_0x1eb731=_0x248844?.['delta'];_0x3a9667[_0x340452(0x1d7)]=_0x5dc8d0,_0x5dc8d0['id']&&(_0x3a9667['id']=_0x5dc8d0['id']),_0x1eb731[_0x340452(0x135)]&&(_0x3a9667['role']=_0x1eb731[_0x340452(0x135)]),_0x1eb731&&_0x1eb731[_0x340452(0xb7)]&&(_0x3a9667[_0x340452(0x116)]+=_0x1eb731[_0x340452(0xb7)],_0x3a9667['delta']=_0x1eb731?.['content']),_0x248844[_0x340452(0x2d2)]&&(_0x3a9667['text']=_0x3a9667[_0x340452(0x116)][_0x340452(0x233)]()),this['responseMessage'](_0x326d1c,_0x3a9667,_0x4d8660[_0x340452(0x184)],_0x199fc0,_0x5651cf),_0x5651cf=![],_0x9d83d9=_0x5dc8d0;}}if(Number(_0x117c72)===0x8){_0x3a9667={'text':''};const _0x2d7c35=await this[_0x340452(0x175)](_0x3e2373);let _0x33fc9b=!![],_0x3a7f1e=[],_0x3c68fc=!![];const _0x589c76=[],_0x43123e=[],_0x5ee298=_0x2592d0[_0x340452(0x2d9)]('\x20');for(let _0x5bade7=0x0;_0x5bade7<_0x5ee298['length'];_0x5bade7++){_0x33fc9b&&/^[http:\/\/|https:\/\/]/[_0x340452(0xdc)](_0x5ee298[_0x5bade7])?_0x589c76[_0x340452(0x2d0)](_0x5ee298[_0x5bade7]):(_0x33fc9b=![],_0x5ee298[_0x5bade7]&&_0x43123e[_0x340452(0x2d0)](_0x5ee298[_0x5bade7]));}if(options['parentMessageId']){const _0x602901=await this[_0x340452(0x1ec)]['listByGroupId'](options[_0x340452(0x18a)]);_0x3a7f1e=_0x602901[_0x340452(0x1f2)](_0x4e7423=>{const _0x147fd4=_0x340452;return{'role':_0x4e7423[_0x147fd4(0x135)]===_0x147fd4(0x28b)?'user':'system','content':_0x4e7423['prompt']||_0x4e7423[_0x147fd4(0x21f)]};});}let _0x5c7780=[];for(const _0x4f82b7 of _0x589c76){_0x5c7780[_0x340452(0x2d0)]({'type':_0x340452(0x22a),'image_url':{'url':_0x4f82b7}});}let _0x16e35c=[];_0x5c7780['length']?_0x16e35c=[..._0x3a7f1e,{'role':'user','content':[{'text':_0x43123e[_0x340452(0x2c3)]('\x20'),'type':'text'},..._0x5c7780]}]:_0x16e35c=[..._0x3a7f1e,{'role':_0x340452(0x28b),'content':_0x43123e['join']('\x20')}];const _0x40ab78=await _0x2d7c35[_0x340452(0x1c3)][_0x340452(0x2e0)][_0x340452(0x2cd)]({'stream':!![],..._0x2a45c5,'messages':_0x16e35c,'model':_0x3e2373['model']});for await(const _0x116272 of _0x40ab78){const _0x36aea9=_0x116272?.[_0x340452(0x106)][0x0],_0x3759a5=_0x36aea9?.[_0x340452(0x2e4)];_0x3a9667['detail']=_0x116272;_0x116272['id']&&(_0x3a9667['id']=_0x116272['id']);_0x3759a5[_0x340452(0x135)]&&(_0x3a9667['role']=_0x3759a5[_0x340452(0x135)]);_0x3759a5&&_0x3759a5['content']&&(_0x3a9667['text']+=_0x3759a5[_0x340452(0xb7)],_0x3a9667[_0x340452(0x2e4)]=_0x3759a5?.['content']);_0x36aea9[_0x340452(0x2d2)]&&(_0x3a9667['text']=_0x3a9667[_0x340452(0x116)][_0x340452(0x233)]());let _0x23cd4c=this['responseMessageWithThink'](_0x326d1c,_0x3a9667,_0x4d8660[_0x340452(0x184)],_0x199fc0,_0x3c68fc);_0x449359+=_0x23cd4c,_0x3c68fc=![],_0x9d83d9=_0x116272;}_0x472b85=!![];}const _0xb154c={'id':this[_0x340452(0x19c)][_0x340452(0x2f1)](),'text':_0x2592d0,'role':_0x340452(0x28b),'name':undefined,'usage':null,'parentMessageId':_0x1db7b9,'conversationId':_0x3a9667?.[_0x340452(0x137)]||null};_0x5d823b={'model':_0x1c93af,'parentMessageId':_0x1db7b9},await this[_0x340452(0x19c)]['setData'](_0xb154c);const _0x1db753={'id':_0x3a9667?.['id']||this[_0x340452(0x19c)][_0x340452(0x2f1)](),'text':_0x3a9667[_0x340452(0x116)],'role':_0x340452(0x1c9),'name':undefined,'usage':_0x3a9667[_0x340452(0xab)],'parentMessageId':_0xb154c['id'],'conversationId':_0x3a9667?.['conversationId']};await this[_0x340452(0x19c)][_0x340452(0x291)](_0x1db753),_0x5d823b={'model':_0x1c93af,'parentMessageId':_0xb154c['id']};}else{console[_0x340452(0x26c)](_0x340452(0xfa));const _0x41055e=await this[_0x340452(0xf9)](_0x3e2373,_0x2a45c5);_0x3a9667=await _0x41055e[_0x340452(0x278)](_0x1f9cd9?_0x4a9f8f:_0x2592d0,_0x2a45c5);}const _0x4da550=(0x0,helper_1[_0x340452(0x2ad)])(_0x117c72,_0x3a9667,_0x5d823b),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x4da550[_0x340452(0xab)];_0x64ddbd===_0x340452(0x220)?await this[_0x340452(0x9c)][_0x340452(0x241)](_0x1b6c87,total_tokens):await this[_0x340452(0xb0)]['saveUseLog'](_0x1b6c87,total_tokens);_0x1adc5e[_0x340452(0xe0)]=total_tokens,await this[_0x340452(0x1ec)][_0x340452(0x136)](_0x1adc5e),_0x25a5c3[_0x340452(0x268)]=_0x449359,_0x25a5c3['answer']=_0x4da550?.[_0x340452(0x116)],_0x25a5c3[_0x340452(0xe0)]=total_tokens,_0x25a5c3[_0x340452(0x29f)]=prompt_tokens,_0x25a5c3[_0x340452(0x160)]=completion_tokens,_0x25a5c3[_0x340452(0x98)]=JSON['stringify']({'conversationId':_0x3a9667[_0x340452(0x137)],'model':_0x1c93af,'parentMessageId':_0x3a9667['id'],'temperature':_0x357cfe});const _0x3f3e2c=await this['chatLogService']['saveChatLog'](_0x25a5c3);common_1[_0x340452(0x217)]['debug'](_0x340452(0xd9)+_0x582546['user']['id']+'\x20model:\x20'+_0x1c93af+_0x340452(0x1de)+_0x225fc9+_0x340452(0xdb)+_0x5a877a,_0x340452(0x1d1)),await this[_0x340452(0x2e6)][_0x340452(0x1f5)](_0x64ddbd,_0x26347d,_0x582546,_0x25a5c3[_0x340452(0x21f)]),_0x3a9667[_0x340452(0x30a)]&&(_0x3a9667[_0x340452(0x30a)]=''),_0x3a9667[_0x340452(0x13d)]=!![],_0x3a9667[_0x340452(0xa2)]=_0x3f3e2c['id'];_0x1bff53&&setTimeout(()=>{const _0x53d6f7=_0x340452;this[_0x53d6f7(0xd2)](_0x582546,_0x3f3e2c);},0x64);if(_0x463404==_0x340452(0x2c0)){const _0x758760=await this[_0x340452(0xb6)][_0x340452(0xbb)]({'id':_0x845e1c,'userId':_0x3f3e2c[_0x340452(0x1a9)],'chatLogId':_0x3f3e2c['id'],'prompt':_0x3f3e2c[_0x340452(0x2df)],'result':_0x25a5c3['answer'],'status':0x1});_0x3a9667['mindTaskId']=_0x758760['id'];}if(_0x326d1c&&_0x199fc0)await this[_0x340452(0x214)]['deductBalance4Chat'](_0x582546[_0x340452(0x28b)]['id'],_0x3e2373,_0x3f3e2c['id']),_0x4d8660[_0x340452(0x184)]?_0x326d1c[_0x340452(0x2ff)](_0x340452(0x14f)+JSON['stringify'](_0x3a9667)+'\x0a\x0a'):_0x326d1c['write']('\x0a'+JSON[_0x340452(0x122)](_0x3a9667));else return _0x3a9667[_0x340452(0x116)];}catch(_0xce23fb){_0x25a5c3[_0x340452(0x21f)]=_0xce23fb['message'],_0x25a5c3['errMsg']=_0xce23fb[_0x340452(0xd8)],_0x25a5c3[_0x340452(0x98)]=JSON[_0x340452(0x122)]({'conversationId':_0x3a9667?.[_0x340452(0x137)],'model':_0x1c93af,'parentMessageId':_0x3a9667?.['id'],'temperature':_0x357cfe});const _0x2adcc4=await this[_0x340452(0x1ec)]['saveChatLog'](_0x25a5c3);if(_0x463404==_0x340452(0x2c0)){const _0x291f3d=await this[_0x340452(0xb6)][_0x340452(0xbb)]({'id':_0x845e1c,'userId':_0x2adcc4['userId'],'prompt':_0x2adcc4[_0x340452(0x2df)],'chatLogId':_0x2adcc4['id'],'result':_0x25a5c3[_0x340452(0x21f)],'status':-0x1});_0x3a9667[_0x340452(0x1cb)]=_0x291f3d['id'];}const _0x4b4747=_0xce23fb['statusCode'];_0x4b4747===0x190&&console[_0x340452(0x26c)]('400\x20error',_0xce23fb,_0xce23fb[_0x340452(0xd8)]);if(_0xce23fb['status']&&_0xce23fb[_0x340452(0x269)]===0x192){const _0x452bd0={'message':_0x340452(0x1a8)+_0xce23fb[_0x340452(0xd8)],'code':0x192};if(_0x326d1c&&_0x199fc0){_0x4d8660[_0x340452(0x184)]?_0x326d1c[_0x340452(0x2ff)](_0x340452(0x14f)+JSON[_0x340452(0x122)](_0x452bd0)+'\x0a\x0a'):_0x326d1c[_0x340452(0x2ff)](JSON[_0x340452(0x122)](_0x452bd0));_0x326d1c[_0x340452(0x117)]();return;}else throw new common_1[(_0x340452(0x2d6))](_0xce23fb[_0x340452(0xd8)],common_1[_0x340452(0x11a)][_0x340452(0x23e)]);}if(!_0x4b4747){if(_0x326d1c&&_0x199fc0){_0x4d8660[_0x340452(0x184)]?_0x326d1c[_0x340452(0x2ff)](_0x340452(0x14f)+JSON[_0x340452(0x122)]({'message':_0xce23fb['message'],'code':0x1f4})+'\x0a\x0a'):_0x326d1c['write'](JSON[_0x340452(0x122)]({'message':_0xce23fb['message'],'code':0x1f4}));_0x326d1c[_0x340452(0x117)]();return;}else throw new common_1['HttpException'](_0xce23fb[_0x340452(0xd8)],common_1[_0x340452(0x11a)][_0x340452(0xcf)]);}const _0x487c42=await this[_0x340452(0x141)](_0xce23fb,_0x3e2373),_0x4e055f={'message':_0x487c42||'Please\x20check\x20the\x20back-end\x20console','code':_0x4b4747===0x191?0x191:_0x4b4747||0x1f4};if(_0x326d1c&&_0x199fc0)_0x326d1c['statusCode']=0x190,_0x4d8660[_0x340452(0x184)]?_0x326d1c['write']('data:\x20'+JSON[_0x340452(0x122)](_0x4e055f)+'\x0a\x0a'):_0x326d1c[_0x340452(0x2ff)](JSON[_0x340452(0x122)](_0x4e055f));else throw new common_1[(_0x340452(0x2d6))](_0x4e055f[_0x340452(0xd8)],common_1[_0x340452(0x11a)][_0x340452(0xcf)]);}finally{_0x326d1c&&_0x199fc0&&_0x326d1c[_0x340452(0x117)]();}}catch(_0x2922f9){if(_0x2922f9 instanceof common_1[_0x340452(0x2d6)])throw _0x2922f9;else throw new common_1[(_0x340452(0x2d6))](_0x2922f9['message'],common_1[_0x340452(0x11a)]['BAD_REQUEST']);}}async[_0x3f82f6(0xd2)](_0x36e2a2,_0x20cf42){const _0x8a73e0=_0x3f82f6,_0x13031a=await this[_0x8a73e0(0x169)](_0x36e2a2,{'request':{'text':_0x20cf42[_0x8a73e0(0x21f)]}});_0x20cf42[_0x8a73e0(0x11b)]=_0x13031a,this[_0x8a73e0(0x1ec)][_0x8a73e0(0x136)](_0x20cf42);}async[_0x3f82f6(0x2ed)](_0x2f0b73){const _0x45fc54=_0x3f82f6;try{const _0x2d5524=['musicLyricsPrice',_0x45fc54(0x28c),_0x45fc54(0x1a4),_0x45fc54(0x274),_0x45fc54(0x16c),_0x45fc54(0x154),'musicUserType'],_0x4667c5=await this[_0x45fc54(0x20f)][_0x45fc54(0x2f4)](_0x2d5524);if(!_0x2f0b73[_0x45fc54(0x28b)]||!_0x2f0b73[_0x45fc54(0x28b)]['id'])throw new Error(_0x45fc54(0x9d));const _0x24a2db=[_0x45fc54(0xde),_0x45fc54(0x1ef),'musicUpload'],_0x512e6e=await Promise[_0x45fc54(0x275)](_0x24a2db[_0x45fc54(0x1f2)](async _0x2a743b=>{const _0x348a4e=_0x45fc54,_0x1e2b9c=_0x4667c5[_0x2a743b+_0x348a4e(0x191)],_0x4e0c25=_0x4667c5[_0x2a743b+_0x348a4e(0x25d)],_0x1fdfcf=redisKey_constant_1[_0x348a4e(0x181)]+'-'+_0x2f0b73[_0x348a4e(0x28b)]['id']+'-'+(_0x2a743b+_0x348a4e(0x191)),_0x255c09=await this[_0x348a4e(0x214)][_0x348a4e(0x26b)](_0x2f0b73[_0x348a4e(0x28b)]['id'],_0x1fdfcf,_0x1e2b9c);return{'type':_0x2a743b,'remainCount':_0x255c09,'freeCount':Number(_0x1e2b9c),'useIntegrate':Number(_0x4e0c25),'isVipUsed':_0x4667c5['musicUserType']?!![]:![],'userType':_0x4667c5[_0x348a4e(0x203)]};}));return _0x512e6e;}catch(_0x52f5fe){console['error'](_0x45fc54(0x168),_0x52f5fe);throw _0x52f5fe;}}async[_0x3f82f6(0x28a)](_0x1d9f09){const _0x1261c2=_0x3f82f6,{data:_0x514256,answerLogDTO:_0x1c271c,currentRequestModel:_0x154be6,musicTaskType:_0x190748}=_0x1d9f09;try{let _0x145d33=process[_0x1261c2(0x302)][_0x1261c2(0x1aa)];!/^http/[_0x1261c2(0xdc)](_0x145d33)&&(_0x145d33=_0x1261c2(0x211)+_0x145d33);let _0x5dc68b;if(_0x190748==music_constant_1['EMusicTaskType']['CREATE'])!_0x514256[_0x1261c2(0x1f1)]&&(_0x514256[_0x1261c2(0x1f0)]=_0x514256[_0x1261c2(0x2df)],delete _0x514256[_0x1261c2(0x2df)]),_0x5dc68b=await this[_0x1261c2(0x1af)][_0x1261c2(0x1b4)]({'data':_0x514256,'baseURL':_0x154be6[_0x1261c2(0xfe)],'headers':{'Authorization':_0x1261c2(0x120)+_0x154be6['key']}});else _0x190748==music_constant_1[_0x1261c2(0x134)]['LYRICS']?(_0x514256[_0x1261c2(0x256)]=_0x145d33+(_0x1261c2(0x96)+_0x1c271c['id']),_0x5dc68b=await this[_0x1261c2(0x1af)]['lyrics']({'data':_0x514256,'baseURL':_0x154be6['proxyUrl'],'headers':{'Authorization':_0x1261c2(0x120)+_0x154be6['key']}})):(_0x514256[_0x1261c2(0x256)]=_0x145d33+('/api/chatLog/notify-Suno-upload?id='+_0x1c271c['id']),_0x5dc68b=await this[_0x1261c2(0x1af)][_0x1261c2(0x27e)]({'data':_0x514256,'baseURL':_0x154be6['proxyUrl'],'headers':{'Authorization':_0x1261c2(0x120)+_0x154be6['key']}}));await this[_0x1261c2(0xb0)]['saveUseLog'](_0x154be6['id'],0x0),_0x1c271c[_0x1261c2(0xe0)]=0x0,_0x1c271c['promptTokens']=0x0,_0x1c271c['completionTokens']=0x0,_0x1c271c[_0x1261c2(0x2ab)]=_0x5dc68b[_0x1261c2(0xf3)],_0x1c271c[_0x1261c2(0x144)]=_0x190748,_0x1c271c[_0x1261c2(0x98)]=JSON[_0x1261c2(0x122)]({'model':_0x154be6[_0x1261c2(0x198)],'parentMessageId':_0x5dc68b[_0x1261c2(0xf3)]}),await this['chatLogService'][_0x1261c2(0x136)](_0x1c271c),common_1[_0x1261c2(0x217)]['debug'](_0x1261c2(0xd9)+_0x1c271c['userId']+'\x20model:\x20'+_0x154be6[_0x1261c2(0x198)]+_0x1261c2(0x1de)+_0x154be6[_0x1261c2(0x29d)]+_0x1261c2(0xdb)+_0x154be6[_0x1261c2(0x2fd)],_0x1261c2(0x171));if(_0x5dc68b[_0x1261c2(0x264)]!=='success')throw new Error('音乐生成失败，没有响应');}catch(_0x1c0c74){console['log'](_0x1261c2(0x25e),_0x154be6[_0x1261c2(0x29d)],_0x1c0c74);const _0x1b26bf=await this[_0x1261c2(0x141)](_0x1c0c74,_0x154be6);_0x1c271c[_0x1261c2(0x1a5)]=_0x1b26bf,await this[_0x1261c2(0x1ec)][_0x1261c2(0x136)](_0x1c271c),await this[_0x1261c2(0x214)][_0x1261c2(0x1c7)](_0x1c271c[_0x1261c2(0x1a9)],_0x1c271c['id'],_0x190748,!![]);}}async[_0x3f82f6(0x156)](_0x13af9f){const _0x5104de=_0x3f82f6,{data:_0x59bd6f,answerLogDTO:_0x9f29f7,currentRequestModel:_0x3fbc9d,requestBody:_0x29b51c}=_0x13af9f;await this[_0x5104de(0x214)]['deductBalance4Video'](_0x9f29f7['userId'],_0x3fbc9d,_0x29b51c,_0x9f29f7['id'],balance_constant_1[_0x5104de(0x11d)][_0x5104de(0x2c5)]);try{let _0x583073;await this[_0x5104de(0x214)][_0x5104de(0xd5)](_0x9f29f7[_0x5104de(0x1a9)],_0x3fbc9d,_0x9f29f7['id']);_0x59bd6f[_0x5104de(0x308)]?_0x583073=await this[_0x5104de(0x1cc)][_0x5104de(0x1a1)]({'data':_0x59bd6f,'baseURL':_0x3fbc9d[_0x5104de(0xfe)],'headers':{'Authorization':_0x5104de(0x120)+_0x3fbc9d[_0x5104de(0x29d)]}},_0x59bd6f[_0x5104de(0x308)]):_0x583073=await this[_0x5104de(0x1cc)]['creat']({'data':_0x59bd6f,'baseURL':_0x3fbc9d[_0x5104de(0xfe)],'headers':{'Authorization':_0x5104de(0x120)+_0x3fbc9d['key']}});await this[_0x5104de(0xb0)][_0x5104de(0x1a0)](_0x3fbc9d['id'],0x0),_0x9f29f7['totalTokens']=0x0,_0x9f29f7[_0x5104de(0x29f)]=0x0,_0x9f29f7[_0x5104de(0x160)]=0x0,_0x9f29f7[_0x5104de(0x21f)]=_0x583073[_0x5104de(0x1c4)],_0x9f29f7[_0x5104de(0x98)]=JSON[_0x5104de(0x122)]({'model':_0x3fbc9d['model'],'parentMessageId':_0x583073['id']}),await this['chatLogService'][_0x5104de(0x136)](_0x9f29f7),common_1[_0x5104de(0x217)][_0x5104de(0x209)](_0x5104de(0xd9)+_0x9f29f7[_0x5104de(0x1a9)]+'\x20model:\x20'+_0x3fbc9d[_0x5104de(0x198)]+_0x5104de(0x1de)+_0x3fbc9d[_0x5104de(0x29d)]+_0x5104de(0xdb)+_0x3fbc9d[_0x5104de(0x2fd)],_0x5104de(0x1d1));if(!_0x9f29f7['answer'])throw new Error(_0x5104de(0x30b));await this[_0x5104de(0x1ec)][_0x5104de(0x200)](_0x9f29f7,{'id':_0x583073['id'],'state':_0x583073[_0x5104de(0x1c4)],'completed':_0x583073[_0x5104de(0x1c4)]===_0x5104de(0xa0),'videoUrl':_0x583073[_0x5104de(0x1fc)]?.[_0x5104de(0x1c6)]});}catch(_0x524ed6){console[_0x5104de(0x26c)](_0x5104de(0x13c),_0x3fbc9d[_0x5104de(0x29d)],_0x524ed6);const _0x2d15d1=await this[_0x5104de(0x141)](_0x524ed6,_0x3fbc9d);_0x9f29f7['errMsg']=_0x2d15d1,await this[_0x5104de(0x1ec)][_0x5104de(0x136)](_0x9f29f7),await this[_0x5104de(0x214)]['refundBalance4Video'](_0x9f29f7[_0x5104de(0x1a9)],_0x3fbc9d,_0x29b51c,_0x9f29f7['id'],balance_constant_1[_0x5104de(0x11d)]['VIDEO']);}}async['runwayVideoTask'](_0x404fec){const _0x2129e5=_0x3f82f6,{data:_0x5ee2d4,answerLogDTO:_0x4e5cf4,currentRequestModel:_0x1c2ff9,requestBody:_0x29a157}=_0x404fec;await this[_0x2129e5(0x214)][_0x2129e5(0x2e9)](_0x4e5cf4['userId'],_0x1c2ff9,_0x29a157,_0x4e5cf4['id'],balance_constant_1['EChangeType']['RUNWAYVIDEO']);try{let _0x15757e;const _0x39a47c=_0x5ee2d4[_0x2129e5(0x2b8)],_0x1ef061={'model':_0x5ee2d4['model'],'ratio':_0x5ee2d4[_0x2129e5(0x2cf)],'prompt':_0x5ee2d4[_0x2129e5(0x2df)],'style':_0x5ee2d4['style'],'options':_0x39a47c};_0x5ee2d4['image']&&(_0x1ef061[_0x2129e5(0x280)]=_0x5ee2d4[_0x2129e5(0x280)]);_0x5ee2d4['last_image']&&(_0x1ef061['last_image']=_0x5ee2d4[_0x2129e5(0x1d8)]);_0x15757e=await this[_0x2129e5(0x1c1)][_0x2129e5(0x1da)]({'data':_0x1ef061,'baseURL':_0x1c2ff9[_0x2129e5(0xfe)],'headers':{'Authorization':_0x2129e5(0x120)+_0x1c2ff9[_0x2129e5(0x29d)]}}),await this[_0x2129e5(0xb0)]['saveUseLog'](_0x1c2ff9['id'],0x0),_0x4e5cf4[_0x2129e5(0xe0)]=0x0,_0x4e5cf4[_0x2129e5(0x29f)]=0x0,_0x4e5cf4[_0x2129e5(0x160)]=0x0,_0x4e5cf4[_0x2129e5(0x1a5)]=_0x15757e[_0x2129e5(0x259)],_0x4e5cf4['answer']=_0x15757e['status']=='3'?_0x2129e5(0x224):_0x15757e[_0x2129e5(0x269)],_0x4e5cf4[_0x2129e5(0x98)]=JSON[_0x2129e5(0x122)]({'model':_0x1c2ff9[_0x2129e5(0x198)],'parentMessageId':_0x15757e[_0x2129e5(0x102)]}),await this[_0x2129e5(0x1ec)][_0x2129e5(0x136)](_0x4e5cf4),common_1[_0x2129e5(0x217)]['debug'](_0x2129e5(0xd9)+_0x4e5cf4[_0x2129e5(0x1a9)]+_0x2129e5(0x128)+_0x1c2ff9[_0x2129e5(0x198)]+'\x20key\x20->\x20'+_0x1c2ff9[_0x2129e5(0x29d)]+',\x20模型名称:\x20'+_0x1c2ff9['modelName'],_0x2129e5(0x1d1));if(_0x15757e[_0x2129e5(0x259)])throw new Error(_0x2129e5(0x30b));await this['chatLogService'][_0x2129e5(0x200)](_0x4e5cf4,{'id':_0x15757e['task_id'],'state':_0x15757e[_0x2129e5(0x269)]=='3'?_0x2129e5(0x224):_0x15757e['status'],'completed':_0x15757e[_0x2129e5(0x269)]==='3','videoUrl':_0x15757e[_0x2129e5(0x12d)]});}catch(_0x2a457d){console[_0x2129e5(0x26c)]('video-task',_0x1c2ff9[_0x2129e5(0x29d)],_0x2a457d);const _0x1bd37f=await this[_0x2129e5(0x141)](_0x2a457d,_0x1c2ff9);_0x4e5cf4[_0x2129e5(0x1a5)]=_0x1bd37f,await this[_0x2129e5(0x1ec)]['saveChatLog'](_0x4e5cf4),await this['userService'][_0x2129e5(0x2f2)](_0x4e5cf4[_0x2129e5(0x1a9)],_0x1c2ff9,_0x29a157,_0x4e5cf4['id'],balance_constant_1[_0x2129e5(0x11d)][_0x2129e5(0x284)]);}}async[_0x3f82f6(0x148)](_0x5e09a5){const _0x4a5669=_0x3f82f6,{data:_0x4c3540,answerLogDTO:_0x102b7d,currentRequestModel:_0x10f4b9,requestBody:_0x15b094}=_0x5e09a5;await this['userService'][_0x4a5669(0x2e9)](_0x102b7d['userId'],_0x10f4b9,_0x15b094,_0x102b7d['id'],balance_constant_1['EChangeType'][_0x4a5669(0x1e3)]);try{let _0x2a8b1f;await this[_0x4a5669(0x214)][_0x4a5669(0xd5)](_0x102b7d[_0x4a5669(0x1a9)],_0x10f4b9,_0x102b7d['id']);!_0x4c3540[_0x4a5669(0xb1)]?(_0x4c3540[_0x4a5669(0xb1)]=_0x4c3540['model'],delete _0x4c3540[_0x4a5669(0x198)]):delete _0x4c3540['model'];_0x4c3540[_0x4a5669(0x280)]?_0x2a8b1f=await this[_0x4a5669(0x22b)][_0x4a5669(0xf2)]({'data':_0x4c3540,'baseURL':_0x10f4b9[_0x4a5669(0xfe)],'headers':{'Authorization':'Bearer\x20'+_0x10f4b9[_0x4a5669(0x29d)]}}):_0x2a8b1f=await this['klingTaskService'][_0x4a5669(0x11c)]({'data':_0x4c3540,'baseURL':_0x10f4b9[_0x4a5669(0xfe)],'headers':{'Authorization':_0x4a5669(0x120)+_0x10f4b9['key']}});await this[_0x4a5669(0xb0)][_0x4a5669(0x1a0)](_0x10f4b9['id'],0x0),_0x102b7d['totalTokens']=0x0,_0x102b7d['promptTokens']=0x0,_0x102b7d[_0x4a5669(0x160)]=0x0,_0x102b7d[_0x4a5669(0x21f)]=_0x2a8b1f['task_status'],_0x102b7d[_0x4a5669(0x98)]=JSON[_0x4a5669(0x122)]({'model':_0x10f4b9['model'],'parentMessageId':_0x2a8b1f[_0x4a5669(0x102)]}),await this[_0x4a5669(0x1ec)][_0x4a5669(0x136)](_0x102b7d),common_1[_0x4a5669(0x217)][_0x4a5669(0x209)](_0x4a5669(0xd9)+_0x102b7d[_0x4a5669(0x1a9)]+_0x4a5669(0x128)+_0x10f4b9['model']+_0x4a5669(0x1de)+_0x10f4b9['key']+_0x4a5669(0xdb)+_0x10f4b9['modelName'],_0x4a5669(0x1d1));if(!_0x102b7d[_0x4a5669(0x21f)]||_0x102b7d[_0x4a5669(0x21f)]===_0x4a5669(0x173))throw new Error(_0x4a5669(0x30b));await this[_0x4a5669(0x1ec)]['parseAndSaveVideo'](_0x102b7d,{'id':_0x2a8b1f[_0x4a5669(0x102)],'state':_0x2a8b1f['task_status'],'completed':_0x2a8b1f[_0x4a5669(0x254)]===_0x4a5669(0x1ca),'videoUrl':_0x2a8b1f[_0x4a5669(0x30e)]&&_0x2a8b1f[_0x4a5669(0x30e)][_0x4a5669(0xa4)]&&_0x2a8b1f[_0x4a5669(0x30e)][_0x4a5669(0xa4)][_0x4a5669(0x229)]?_0x2a8b1f['task_result'][_0x4a5669(0xa4)][0x0]?.[_0x4a5669(0x1c6)]:''});}catch(_0x21556b){console['log'](_0x4a5669(0x13c),_0x10f4b9[_0x4a5669(0x29d)],_0x21556b);const _0x181c4b=await this['openAiErrHandler'](_0x21556b,_0x10f4b9);_0x102b7d[_0x4a5669(0x1a5)]=_0x181c4b,await this['chatLogService'][_0x4a5669(0x136)](_0x102b7d),await this[_0x4a5669(0x214)]['refundBalance4Video'](_0x102b7d[_0x4a5669(0x1a9)],_0x10f4b9,_0x15b094,_0x102b7d['id'],balance_constant_1[_0x4a5669(0x11d)][_0x4a5669(0x1e3)]);}}async['klingImageTask'](_0x56a40b,_0x5d6fab){const _0x3c1a62=_0x3f82f6;try{const _0x380cbc=(0x0,utils_1['getReqSaasId'])(this[_0x3c1a62(0x1ee)]),_0x560578=await this[_0x3c1a62(0x276)]({'modelType':model_constant_1[_0x3c1a62(0x15a)][_0x3c1a62(0x298)],'officialModel':_0x56a40b[_0x3c1a62(0xb1)]});let _0xf6f521=_0x560578[_0x3c1a62(0x196)],_0x422937=_0x560578[_0x3c1a62(0x29c)],_0x12a0b0=await this[_0x3c1a62(0xb0)][_0x3c1a62(0x166)](model_constant_1[_0x3c1a62(0x15a)][_0x3c1a62(0x298)],_0x56a40b['model_name']);_0x12a0b0[_0x3c1a62(0x198)]=_0x56a40b[_0x3c1a62(0xb1)],_0x422937[_0x3c1a62(0x216)][_0x3c1a62(0x198)]=_0x56a40b[_0x3c1a62(0xb1)],await this[_0x3c1a62(0xaa)]({'prompt':_0x56a40b[_0x3c1a62(0x2df)],'currentRequestModel':_0x12a0b0,'user':_0x5d6fab['user'],'count':_0x56a40b['n']});let {id:_0x42759d,keyType:_0x3b3701}=_0x422937[_0x3c1a62(0x216)];const _0x324b62=(0x0,utils_1[_0x3c1a62(0x289)])(_0x5d6fab),_0x2e52a8={'appId':_0xf6f521,'curIp':_0x324b62,'prompt':_0x56a40b[_0x3c1a62(0x2df)],'modelId':_0x42759d,'modelType':model_constant_1[_0x3c1a62(0x15a)]['DRAW'],'answer':'','model':_0x56a40b['model_name'],'role':_0x3c1a62(0x28b),'userId':_0x5d6fab['user']['id'],'completionTokens':0x0,'type':balance_constant_1[_0x3c1a62(0x2c8)][_0x3c1a62(0x306)],'logType':0x1,'modelSubType':_0x3b3701[_0x3c1a62(0x204)](),'requestParams':_0x56a40b,'requestOptions':JSON[_0x3c1a62(0x122)]({'options':null,'prompt':_0x56a40b[_0x3c1a62(0x2df)]}),'saasId':_0x380cbc};await this[_0x3c1a62(0x1ec)]['saveChatLog'](_0x2e52a8);try{await this[_0x3c1a62(0x214)][_0x3c1a62(0x17d)](_0x2e52a8[_0x3c1a62(0x1a9)],_0x12a0b0,_0x2e52a8['id'],_0x56a40b['n'],balance_constant_1[_0x3c1a62(0x11d)][_0x3c1a62(0x258)]);const _0x429afb=await this[_0x3c1a62(0x22b)][_0x3c1a62(0x140)]({'data':_0x56a40b,'baseURL':_0x12a0b0[_0x3c1a62(0xfe)],'headers':{'Authorization':_0x3c1a62(0x120)+_0x12a0b0[_0x3c1a62(0x29d)]}});_0x2e52a8['curIp']=_0x324b62,_0x2e52a8[_0x3c1a62(0x21f)]=_0x429afb[_0x3c1a62(0x254)],_0x2e52a8[_0x3c1a62(0x2ab)]=_0x429afb['task_id'],await this[_0x3c1a62(0x1ec)][_0x3c1a62(0x136)](_0x2e52a8);if(!_0x2e52a8[_0x3c1a62(0x21f)]||_0x2e52a8[_0x3c1a62(0x21f)]==='failed')throw new Error('图片生成失败');}catch(_0xc72018){console[_0x3c1a62(0x26c)](_0x3c1a62(0x2d8),_0x12a0b0[_0x3c1a62(0x29d)],_0xc72018);const _0x2fbc70=await this[_0x3c1a62(0x141)](_0xc72018,_0x12a0b0);_0x2e52a8[_0x3c1a62(0x1a5)]=_0x2fbc70,await this[_0x3c1a62(0x1ec)][_0x3c1a62(0x136)](_0x2e52a8),await this[_0x3c1a62(0x214)][_0x3c1a62(0x2d3)](_0x2e52a8[_0x3c1a62(0x1a9)],_0x12a0b0,_0x2e52a8['id'],balance_constant_1[_0x3c1a62(0x11d)]['KLDraw']);}return this[_0x3c1a62(0x1ec)][_0x3c1a62(0x28e)](_0x2e52a8);}catch(_0x40a20e){if(_0x40a20e instanceof common_1['HttpException'])throw _0x40a20e;else throw new common_1[(_0x3c1a62(0x2d6))](_0x40a20e[_0x3c1a62(0xd8)],common_1[_0x3c1a62(0x11a)][_0x3c1a62(0xcf)]);}}async['jmengVideoTask'](_0x16b91f){const _0x150344=_0x3f82f6,{data:_0x123cbd,answerLogDTO:_0x2d4524,currentRequestModel:_0x4e25bb,requestBody:_0x224b69}=_0x16b91f;await this[_0x150344(0x214)]['deductBalance4Video'](_0x2d4524[_0x150344(0x1a9)],_0x4e25bb,_0x224b69,_0x2d4524['id'],balance_constant_1[_0x150344(0x11d)][_0x150344(0x247)]);try{!_0x123cbd[_0x150344(0xb1)]?(_0x123cbd[_0x150344(0xb1)]=_0x123cbd['model'],delete _0x123cbd[_0x150344(0x198)]):delete _0x123cbd[_0x150344(0x198)];const _0x461638=new openapi_1[(_0x150344(0x26a))]({'serviceName':'cv','region':_0x150344(0x17c),'host':_0x4e25bb[_0x150344(0xfe)],'accessKeyId':_0x4e25bb['key'],'secretKey':_0x4e25bb['secret']}),_0xf3eda=_0x461638['createAPI'](_0x150344(0xbf),{'Version':_0x150344(0x26e),'method':_0x150344(0x1bc),'contentType':'json'}),_0x140f5e={'req_key':_0x4e25bb[_0x150344(0x198)],'model_name':_0x123cbd[_0x150344(0xb1)],'prompt':_0x123cbd[_0x150344(0x2df)],'seed':_0x123cbd[_0x150344(0xd7)],'aspect_ratio':_0x123cbd[_0x150344(0x2bc)],'image_urls':_0x123cbd[_0x150344(0x1ff)]},_0x40dd50=await _0xf3eda(_0x140f5e);if(_0x40dd50[_0x150344(0x264)]!=0x2710)throw new Error(_0x150344(0x12c)+_0x40dd50[_0x150344(0xd8)]);await this[_0x150344(0xb0)][_0x150344(0x1a0)](_0x4e25bb['id'],0x0),_0x2d4524[_0x150344(0x2ab)]=_0x40dd50[_0x150344(0xf3)]['task_id'],_0x2d4524[_0x150344(0x21f)]=_0x40dd50[_0x150344(0x269)],_0x2d4524[_0x150344(0x98)]=JSON[_0x150344(0x122)]({'model':_0x4e25bb[_0x150344(0x198)],'parentMessageId':_0x40dd50['data']['task_id']}),await this[_0x150344(0x1ec)][_0x150344(0x136)](_0x2d4524),await this['chatLogService'][_0x150344(0x200)](_0x2d4524,{'id':_0x40dd50[_0x150344(0xf3)][_0x150344(0x102)],'state':_0x40dd50['status'],'completed':![],'videoUrl':''});}catch(_0x54ddea){console[_0x150344(0x26c)](_0x150344(0x17f),_0x4e25bb[_0x150344(0x29d)],_0x54ddea);const _0x121ffa=await this[_0x150344(0x141)](_0x54ddea,_0x4e25bb);_0x2d4524[_0x150344(0x1a5)]=_0x121ffa,_0x2d4524[_0x150344(0x21f)]='failed',await this[_0x150344(0x1ec)][_0x150344(0x136)](_0x2d4524),await this[_0x150344(0x214)][_0x150344(0x2f2)](_0x2d4524[_0x150344(0x1a9)],_0x4e25bb,_0x224b69,_0x2d4524['id'],balance_constant_1[_0x150344(0x11d)][_0x150344(0x247)]);}}async[_0x3f82f6(0x1bb)](_0x318abc){const _0x34985f=_0x3f82f6,{data:_0x10ef68,answerLogDTO:_0x2f9d9e,currentRequestModel:_0x41b90c,requestBody:_0x52e80b}=_0x318abc;await this[_0x34985f(0x214)][_0x34985f(0x2e9)](_0x2f9d9e['userId'],_0x41b90c,_0x52e80b,_0x2f9d9e['id'],balance_constant_1[_0x34985f(0x11d)][_0x34985f(0xf7)]);try{let _0x4cf7ee;await this['userService'][_0x34985f(0xd5)](_0x2f9d9e['userId'],_0x41b90c,_0x2f9d9e['id']);(!_0x10ef68['images']||_0x10ef68[_0x34985f(0xc7)][_0x34985f(0x229)]==0x0)&&delete _0x10ef68[_0x34985f(0xc7)];const _0x2f948f={..._0x10ef68};_0x2f948f[_0x34985f(0x251)]=!![],console[_0x34985f(0x26c)]('--------------VEO\x20视频任务开始------------------',_0x2f948f),_0x4cf7ee=await this['veoTaskService'][_0x34985f(0x2cd)]({'data':_0x2f948f,'baseURL':_0x41b90c[_0x34985f(0xfe)],'headers':{'Authorization':_0x34985f(0x120)+_0x41b90c[_0x34985f(0x29d)]}}),await this[_0x34985f(0xb0)][_0x34985f(0x1a0)](_0x41b90c['id'],0x0),_0x2f9d9e[_0x34985f(0xe0)]=0x0,_0x2f9d9e['promptTokens']=0x0,_0x2f9d9e['completionTokens']=0x0,_0x2f9d9e[_0x34985f(0x21f)]=_0x4cf7ee['status'],_0x2f9d9e[_0x34985f(0x2ab)]=_0x4cf7ee['id'],_0x2f9d9e[_0x34985f(0x98)]=JSON[_0x34985f(0x122)]({'model':_0x41b90c['model'],'parentMessageId':_0x4cf7ee['id']}),await this[_0x34985f(0x1ec)][_0x34985f(0x136)](_0x2f9d9e),common_1[_0x34985f(0x217)][_0x34985f(0x209)](_0x34985f(0xd9)+_0x2f9d9e[_0x34985f(0x1a9)]+_0x34985f(0x128)+_0x41b90c['model']+_0x34985f(0x1de)+_0x41b90c[_0x34985f(0x29d)]+_0x34985f(0xdb)+_0x41b90c[_0x34985f(0x2fd)],_0x34985f(0x1d1));if(!_0x2f9d9e[_0x34985f(0x21f)]||_0x2f9d9e['answer']==='failed')throw new Error('视频生成失败，没有响应');await this[_0x34985f(0x1ec)][_0x34985f(0x200)](_0x2f9d9e,{'id':_0x4cf7ee['id'],'state':_0x4cf7ee[_0x34985f(0x269)],'completed':_0x4cf7ee[_0x34985f(0x269)]===_0x34985f(0xa0),'videoUrl':''});}catch(_0x239ea1){console[_0x34985f(0x26c)](_0x34985f(0x13c),_0x41b90c[_0x34985f(0x29d)],_0x239ea1);const _0x373919=await this['openAiErrHandler'](_0x239ea1,_0x41b90c);_0x2f9d9e[_0x34985f(0x1a5)]=_0x373919,await this[_0x34985f(0x1ec)][_0x34985f(0x136)](_0x2f9d9e),await this[_0x34985f(0x214)][_0x34985f(0x2f2)](_0x2f9d9e[_0x34985f(0x1a9)],_0x41b90c,_0x52e80b,_0x2f9d9e['id'],balance_constant_1[_0x34985f(0x11d)][_0x34985f(0xf7)]);}}async['jmengImageTask'](_0x5a3df5,_0x17c9fd){const _0x4ce2ee=_0x3f82f6;try{const _0x23ac33=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x672b78=await this[_0x4ce2ee(0x276)]({'modelType':model_constant_1[_0x4ce2ee(0x15a)][_0x4ce2ee(0x298)],'officialModel':_0x5a3df5[_0x4ce2ee(0xb1)]});let _0x2d5aa1=_0x672b78['appId'],_0x3afd8d=_0x672b78[_0x4ce2ee(0x29c)],_0xe63167=await this['modelsService'][_0x4ce2ee(0x166)](model_constant_1['EModelType'][_0x4ce2ee(0x298)],_0x5a3df5[_0x4ce2ee(0xb1)]);_0xe63167[_0x4ce2ee(0x198)]=_0x5a3df5[_0x4ce2ee(0xb1)],_0x3afd8d[_0x4ce2ee(0x216)][_0x4ce2ee(0x198)]=_0x5a3df5[_0x4ce2ee(0xb1)],await this['validateBeforeDraw']({'prompt':_0x5a3df5['prompt'],'currentRequestModel':_0xe63167,'user':_0x17c9fd[_0x4ce2ee(0x28b)]});let {id:_0x54c83c,keyType:_0x4a67f2}=_0x3afd8d[_0x4ce2ee(0x216)];const _0x30b05c=(0x0,utils_1[_0x4ce2ee(0x289)])(_0x17c9fd),_0x15a572={'appId':_0x2d5aa1,'curIp':_0x30b05c,'prompt':_0x5a3df5[_0x4ce2ee(0x2df)],'modelId':_0x54c83c,'modelType':model_constant_1['EModelType'][_0x4ce2ee(0x298)],'answer':'','model':_0x5a3df5['model_name'],'role':_0x4ce2ee(0x28b),'userId':_0x17c9fd[_0x4ce2ee(0x28b)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x4ce2ee(0x2c8)][_0x4ce2ee(0x306)],'logType':0x1,'modelSubType':_0x4a67f2['toString'](),'requestParams':_0x5a3df5,'requestOptions':JSON[_0x4ce2ee(0x122)]({'options':null,'prompt':_0x5a3df5[_0x4ce2ee(0x2df)]}),'saasId':_0x23ac33};await this['chatLogService'][_0x4ce2ee(0x136)](_0x15a572);try{await this[_0x4ce2ee(0x214)][_0x4ce2ee(0x17d)](_0x15a572[_0x4ce2ee(0x1a9)],_0xe63167,_0x15a572['id'],0x1,balance_constant_1[_0x4ce2ee(0x11d)][_0x4ce2ee(0x146)]);const _0x34319d=new openapi_1['Service']({'serviceName':'cv','region':_0x4ce2ee(0x17c),'host':_0x3afd8d[_0x4ce2ee(0x216)][_0x4ce2ee(0xfe)],'accessKeyId':_0x3afd8d[_0x4ce2ee(0x216)]['key'],'secretKey':_0x3afd8d[_0x4ce2ee(0x216)]['secret']}),_0x39d5ce=_0x34319d[_0x4ce2ee(0x225)](_0x4ce2ee(0x2bb),{'Version':_0x4ce2ee(0x26e),'method':'POST','contentType':_0x4ce2ee(0xd0)}),_0x17ed50=await _0x39d5ce({'req_key':_0x3afd8d[_0x4ce2ee(0x216)]['model'],..._0x5a3df5});_0x15a572[_0x4ce2ee(0xc9)]=_0x30b05c;if(_0x17ed50['code']==0x2710){const _0xe554df=[];for(const _0x12918d of _0x17ed50[_0x4ce2ee(0xf3)][_0x4ce2ee(0x297)]){const _0x1451e1=_0x12918d,_0x278384=uuid['v4']()['slice'](0x0,0xa)+_0x4ce2ee(0x228),_0xc68ff9=Buffer[_0x4ce2ee(0x303)](_0x1451e1,_0x4ce2ee(0x100));_0xe554df[_0x4ce2ee(0x2d0)](this[_0x4ce2ee(0x10b)][_0x4ce2ee(0x294)]({'filename':_0x278384,'buffer':_0xc68ff9}));}const _0x3b9680=await Promise[_0x4ce2ee(0x275)](_0xe554df);_0x15a572[_0x4ce2ee(0x1ac)]=JSON[_0x4ce2ee(0x122)](_0x3b9680);}else throw new Error(_0x4ce2ee(0xc0)+_0x17ed50[_0x4ce2ee(0xd8)]);await this[_0x4ce2ee(0x1ec)][_0x4ce2ee(0x136)](_0x15a572);}catch(_0x38cfdb){console[_0x4ce2ee(0x26c)]('jmeng-draw-task',_0xe63167[_0x4ce2ee(0x29d)],_0x38cfdb);const _0x52cd4f=await this[_0x4ce2ee(0x141)](_0x38cfdb,_0xe63167);_0x15a572[_0x4ce2ee(0x1a5)]=_0x52cd4f,await this['chatLogService'][_0x4ce2ee(0x136)](_0x15a572),await this[_0x4ce2ee(0x214)][_0x4ce2ee(0x2d3)](_0x15a572['userId'],_0xe63167,_0x15a572['id'],balance_constant_1['EChangeType'][_0x4ce2ee(0x146)]);}return this[_0x4ce2ee(0x1ec)][_0x4ce2ee(0x28e)](_0x15a572);}catch(_0x473164){if(_0x473164 instanceof common_1[_0x4ce2ee(0x2d6)])throw _0x473164;else throw new common_1[(_0x4ce2ee(0x2d6))](_0x473164[_0x4ce2ee(0xd8)],common_1[_0x4ce2ee(0x11a)][_0x4ce2ee(0xcf)]);}}async['chatMuiscTask'](_0xb68a67){const _0x5487ff=_0x3f82f6;try{const _0x1067fb=(0x0,utils_1[_0x5487ff(0xb2)])(this[_0x5487ff(0x1ee)]),{req:_0x4623e0,model:_0x2d1743,modelType:_0x1a28a6,datas:_0x35a134,requestBody:_0x3aabaa,musicTaskType:_0x2e2ca3}=_0xb68a67;let _0x1f1eed,_0x4658cd;const _0x39571f=await this[_0x5487ff(0x276)]({'modelType':_0x1a28a6});_0x1f1eed=_0x39571f['appId'],_0x4658cd=_0x39571f[_0x5487ff(0x29c)];let _0x5ba786='';'prompt'in _0x35a134&&(_0x5ba786=_0x35a134[_0x5487ff(0x2df)]);const _0x3bef76=await this[_0x5487ff(0xb0)]['getRandomKey'](_0x1a28a6,_0x1a28a6===model_constant_1['EModelType'][_0x5487ff(0x2c5)]?_0x2d1743:'');_0x3bef76['model']=_0x2d1743,_0x4658cd['modelInfo'][_0x5487ff(0x198)]=_0x2d1743;_0x5487ff(0x2df)in _0x35a134&&await this[_0x5487ff(0x24d)]({'prompt':_0x5ba786,'currentRequestModel':_0x3bef76,'user':_0x4623e0[_0x5487ff(0x28b)]});let {id:_0x14b149,topN:_0xbcecbf,keyType:_0x23f2ac}=_0x4658cd[_0x5487ff(0x216)];const _0x576c62=0x0,_0x13c5e3=0x0,_0x5e311b=_0x576c62+_0x13c5e3,_0x3ebaf3=(0x0,utils_1[_0x5487ff(0x289)])(_0x4623e0),_0x4d4382={'appId':_0x1f1eed,'curIp':_0x3ebaf3,'prompt':_0x5ba786,'modelId':_0x14b149,'modelType':_0x1a28a6,'answer':'','model':_0x2d1743,'role':'user','userId':_0x4623e0['user']['id'],'completionTokens':0x0,'totalTokens':_0x5e311b,'type':balance_constant_1[_0x5487ff(0x2c8)][_0x5487ff(0x177)],'logType':0x1,'modelSubType':'','requestParams':_0x3aabaa||_0x35a134,'requestOptions':JSON[_0x5487ff(0x122)]({'options':null,'prompt':_0x5ba786}),'saasId':_0x1067fb},_0x43f1f2={..._0x4d4382,'role':_0x5487ff(0x1c9),'requestOptions':JSON['stringify']({'prompt':_0x5ba786,'options':{'model':_0x2d1743,'temperature':_0xbcecbf}})};await this[_0x5487ff(0x1ec)][_0x5487ff(0x136)](_0x4d4382);const _0x3abc4b=await this['chatLogService'][_0x5487ff(0x136)](_0x43f1f2);return await this[_0x5487ff(0x214)][_0x5487ff(0x1c7)](_0x4623e0[_0x5487ff(0x28b)]['id'],_0x3abc4b['id'],_0x2e2ca3),await this['sunoMusicTask']({'data':_0x35a134,'currentRequestModel':_0x3bef76,'answerLogDTO':_0x3abc4b,'musicTaskType':_0x2e2ca3}),_0x3abc4b;}catch(_0x22d03c){if(_0x22d03c instanceof common_1[_0x5487ff(0x2d6)])throw _0x22d03c;else throw new common_1[(_0x5487ff(0x2d6))](_0x22d03c[_0x5487ff(0xd8)],common_1[_0x5487ff(0x11a)][_0x5487ff(0xcf)]);}}async[_0x3f82f6(0x18b)](_0x37db3f){const _0x3c3f31=_0x3f82f6;try{const _0x5667ad=(0x0,utils_1[_0x3c3f31(0xb2)])(this[_0x3c3f31(0x1ee)]),{req:_0x475625,model:_0x3d979f,modelType:_0x14a6c4,datas:_0x13fd12,requestBody:_0x533ae1}=_0x37db3f,{prompt:_0x8425a9,options:options={}}=_0x13fd12,{groupId:_0x139cd2,type:_0x4aac15}=options;let _0x5e06a1,_0x169ccf,_0xfc886b;if(_0x14a6c4===model_constant_1['EModelType'][_0x3c3f31(0x2c5)]){const _0xdac291=await this['getModelConfig']({'modelType':_0x14a6c4,'keyType':_0x37db3f[_0x3c3f31(0x131)]});_0x5e06a1=_0xdac291[_0x3c3f31(0x196)],_0x169ccf=_0xdac291[_0x3c3f31(0x29c)],_0xfc886b=await this[_0x3c3f31(0xb0)][_0x3c3f31(0x246)](_0x14a6c4,parseInt(_0x37db3f['keyType']));}else{const _0x275782=await this[_0x3c3f31(0x276)]({'modelType':_0x14a6c4});_0x5e06a1=_0x275782['appId'],_0x169ccf=_0x275782[_0x3c3f31(0x29c)],_0xfc886b=await this[_0x3c3f31(0xb0)][_0x3c3f31(0xc5)](_0x14a6c4);}_0xfc886b[_0x3c3f31(0x198)]=_0x3d979f,_0x169ccf[_0x3c3f31(0x216)][_0x3c3f31(0x198)]=_0x3d979f;_0x14a6c4===model_constant_1[_0x3c3f31(0x15a)][_0x3c3f31(0x2c5)]?await this['validateVideoBeforeChat']({'prompt':_0x8425a9,'currentRequestModel':_0xfc886b,'user':_0x475625[_0x3c3f31(0x28b)],'requestParams':_0x533ae1}):await this[_0x3c3f31(0x24d)]({'prompt':_0x8425a9,'currentRequestModel':_0xfc886b,'user':_0x475625['user']});let {id:_0x2c1941,topN:_0x751b98,keyType:_0x4e32e4}=_0x169ccf[_0x3c3f31(0x216)];const _0x524f26=0x0,_0x20730e=0x0,_0x4bd886=_0x524f26+_0x20730e,_0x34ef67=(0x0,utils_1[_0x3c3f31(0x289)])(_0x475625),_0x1ed445={'appId':_0x5e06a1,'curIp':_0x34ef67,'prompt':_0x8425a9,'groupId':_0x139cd2,'modelId':_0x2c1941,'modelType':_0x14a6c4,'answer':'','model':_0x3d979f,'role':'user','userId':_0x475625[_0x3c3f31(0x28b)]['id'],'completionTokens':0x0,'totalTokens':_0x4bd886,'type':balance_constant_1['DeductionKey'][_0x3c3f31(0x177)],'logType':_0x4aac15==='gpts'?0x2:0x1,'modelSubType':_0x14a6c4===model_constant_1['EModelType'][_0x3c3f31(0x2c5)]?_0x4e32e4[_0x3c3f31(0x204)]():'','requestParams':_0x533ae1||_0x13fd12,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x8425a9}),'saasId':_0x5667ad},_0xb74064={..._0x1ed445,'role':_0x3c3f31(0x1c9),'requestOptions':JSON[_0x3c3f31(0x122)]({'prompt':_0x8425a9,'options':{'model':_0x3d979f,'temperature':_0x751b98}})};await this[_0x3c3f31(0x1ec)][_0x3c3f31(0x136)](_0x1ed445);const _0x123bec=await this[_0x3c3f31(0x1ec)][_0x3c3f31(0x136)](_0xb74064);if(_0x14a6c4===model_constant_1[_0x3c3f31(0x15a)][_0x3c3f31(0x2c5)])switch(_0x4e32e4){case 0x2:this[_0x3c3f31(0xa1)]({'data':_0x13fd12,'currentRequestModel':_0xfc886b,'answerLogDTO':_0x123bec,'requestBody':_0x533ae1});break;case 0x3:this[_0x3c3f31(0x148)]({'data':_0x13fd12,'currentRequestModel':_0xfc886b,'answerLogDTO':_0x123bec,'requestBody':_0x533ae1});break;case 0x5:this[_0x3c3f31(0x19e)]({'data':_0x13fd12,'currentRequestModel':_0xfc886b,'answerLogDTO':_0x123bec,'requestBody':_0x533ae1});break;case 0x6:this[_0x3c3f31(0x1bb)]({'data':_0x13fd12,'currentRequestModel':_0xfc886b,'answerLogDTO':_0x123bec,'requestBody':_0x533ae1});break;default:this[_0x3c3f31(0x156)]({'data':_0x13fd12,'currentRequestModel':_0xfc886b,'answerLogDTO':_0x123bec,'requestBody':_0x533ae1});}else await this['userService'][_0x3c3f31(0xd5)](_0x475625[_0x3c3f31(0x28b)]['id'],_0xfc886b,_0x123bec['id']);return _0x123bec;}catch(_0x497829){if(_0x497829 instanceof common_1[_0x3c3f31(0x2d6)])throw _0x497829;else throw new common_1[(_0x3c3f31(0x2d6))](_0x497829['message'],common_1[_0x3c3f31(0x11a)]['BAD_REQUEST']);}}async[_0x3f82f6(0xd4)](_0x2983ae,_0x3e6df5){const _0x119e68=_0x3f82f6;let {mv:_0x4a8aa4}=_0x2983ae;return!_0x2983ae[_0x119e68(0x199)]?_0x2983ae[_0x119e68(0x199)]=![]:_0x2983ae[_0x119e68(0x199)]=!![],this[_0x119e68(0x22c)]({'req':_0x3e6df5,'datas':_0x2983ae,'model':_0x4a8aa4||'suno-v3','modelType':model_constant_1[_0x119e68(0x15a)][_0x119e68(0x2af)],'musicTaskType':music_constant_1[_0x119e68(0x134)]['CREATE']});}async[_0x3f82f6(0x255)](_0x5ce9c8,_0x1fb641){const _0x2e1a55=_0x3f82f6,_0x2420af={'url':_0x5ce9c8};return this[_0x2e1a55(0x22c)]({'req':_0x1fb641,'datas':_0x2420af,'model':_0x2e1a55(0x2b6),'modelType':model_constant_1['EModelType'][_0x2e1a55(0x2af)],'musicTaskType':music_constant_1[_0x2e1a55(0x134)][_0x2e1a55(0x197)]});}async[_0x3f82f6(0x232)](_0x5f298b,_0x5865ad){const _0x3a7b0b=_0x3f82f6;return this['chatMuiscTask']({'req':_0x5865ad,'datas':_0x5f298b,'model':_0x3a7b0b(0x2b6),'modelType':model_constant_1[_0x3a7b0b(0x15a)][_0x3a7b0b(0x2af)],'musicTaskType':music_constant_1[_0x3a7b0b(0x134)][_0x3a7b0b(0x147)]});}async[_0x3f82f6(0x2c2)](_0x4099f0,_0x1964dd){const _0x31dad9=_0x3f82f6,_0x37530f=JSON[_0x31dad9(0x28d)](JSON[_0x31dad9(0x122)](_0x4099f0));let {model:_0x5d2671,prompt:_0x26641b,expand_prompt:_0x5046e1,aspect_ratio:_0x1ba47c,image_url:_0x21fa09,image_end_url:_0x1f5f03}=_0x4099f0,_0x2d84cc=_0x31dad9(0x23f)+_0x26641b+_0x31dad9(0x20e)+_0x5046e1+_0x31dad9(0x307)+_0x1ba47c;return _0x21fa09&&(_0x2d84cc=_0x2d84cc+_0x31dad9(0x1b0)+_0x21fa09),_0x1f5f03&&(_0x2d84cc=_0x2d84cc+_0x31dad9(0x119)+_0x1f5f03),_0x4099f0[_0x31dad9(0x2df)]=_0x2d84cc,_0x4099f0[_0x31dad9(0x13b)]=_0x26641b,this['chatTask']({'req':_0x1964dd,'datas':_0x4099f0,'requestBody':_0x37530f,'model':_0x5d2671||'luma-video','keyType':'1','modelType':model_constant_1[_0x31dad9(0x15a)][_0x31dad9(0x2c5)]});}async[_0x3f82f6(0xdd)](_0x380333,_0x2cd493){const _0x5eed21=_0x3f82f6,_0x37e154=JSON[_0x5eed21(0x28d)](JSON[_0x5eed21(0x122)](_0x380333));return this[_0x5eed21(0x18b)]({'req':_0x2cd493,'datas':_0x380333,'requestBody':_0x37e154,'model':_0x380333[_0x5eed21(0x198)]||_0x5eed21(0x30c),'keyType':'2','modelType':model_constant_1[_0x5eed21(0x15a)]['VIDEO']});}async['jmengChatVideo'](_0xcc4ae,_0x296a56){const _0x5c64af=_0x3f82f6,_0x4b6454=JSON[_0x5c64af(0x28d)](JSON['stringify'](_0xcc4ae));return!_0xcc4ae['model']&&(_0xcc4ae[_0x5c64af(0x198)]=_0xcc4ae[_0x5c64af(0xb1)]),this['chatTask']({'req':_0x296a56,'datas':_0xcc4ae,'requestBody':_0x4b6454,'model':_0xcc4ae['model']||_0x5c64af(0x10a),'keyType':'5','modelType':model_constant_1[_0x5c64af(0x15a)][_0x5c64af(0x2c5)]});}async[_0x3f82f6(0x2be)](_0x2e3f08,_0x2d27af){const _0x1b7737=_0x3f82f6,_0x365278=JSON[_0x1b7737(0x28d)](JSON[_0x1b7737(0x122)](_0x2e3f08));return this[_0x1b7737(0x18b)]({'req':_0x2d27af,'datas':_0x2e3f08,'requestBody':_0x365278,'model':_0x2e3f08[_0x1b7737(0x198)]||'kling-video_std_5','keyType':'3','modelType':model_constant_1[_0x1b7737(0x15a)][_0x1b7737(0x2c5)]});}async['veoChatVideo'](_0x5c8d12,_0x5ffa55){const _0xcaa41a=_0x3f82f6,_0x46af0c=JSON['parse'](JSON['stringify'](_0x5c8d12));return this[_0xcaa41a(0x18b)]({'req':_0x5ffa55,'datas':_0x5c8d12,'requestBody':_0x46af0c,'model':_0x5c8d12[_0xcaa41a(0x198)]||_0xcaa41a(0x27b),'keyType':'6','modelType':model_constant_1[_0xcaa41a(0x15a)][_0xcaa41a(0x2c5)]});}async[_0x3f82f6(0x299)](){const _0x3aaf5d=_0x3f82f6,_0x2e3d48=await this[_0x3aaf5d(0x1ec)]['listUndoneVideoForLuma']();if(!_0x2e3d48[_0x3aaf5d(0x229)])return;const _0x7ad92f=[],_0x56f183=new Map();_0x2e3d48[_0x3aaf5d(0x207)](_0x2927db=>{const _0x126324=_0x3aaf5d;_0x7ad92f[_0x126324(0x2d0)](_0x2927db['id']),_0x56f183[_0x126324(0x296)](_0x2927db['id'],_0x2927db);});const _0xf09d02=await this[_0x3aaf5d(0x1ec)][_0x3aaf5d(0x252)](_0x7ad92f),_0x135c00=[],_0x166a93=new Map();_0xf09d02['forEach'](_0x2e1cd5=>{const _0x4853b4=_0x3aaf5d;_0x135c00[_0x4853b4(0x2d0)](_0x2e1cd5[_0x4853b4(0x253)]),_0x166a93[_0x4853b4(0x296)](_0x2e1cd5[_0x4853b4(0x253)],_0x2e1cd5);});const _0x4cc92a=await this['modelsService'][_0x3aaf5d(0xc5)](model_constant_1[_0x3aaf5d(0x15a)][_0x3aaf5d(0x2c5)]),_0x2d6cbb=await this[_0x3aaf5d(0x1cc)]['listTaskByIds']({'baseURL':_0x4cc92a[_0x3aaf5d(0xfe)],'headers':{'Authorization':'Bearer\x20'+_0x4cc92a['key']},'data':{'ids':_0x135c00}});for(let _0x4c8456=0x0;_0x4c8456<_0x2d6cbb[_0x3aaf5d(0x229)];_0x4c8456++){const _0x5ad210=_0x2d6cbb[_0x4c8456],_0x3a7488=_0x166a93[_0x3aaf5d(0x219)](_0x5ad210[_0x3aaf5d(0x102)]),_0x47d735=_0x56f183[_0x3aaf5d(0x219)](_0x3a7488[_0x3aaf5d(0xa2)]);await this['chatLogService'][_0x3aaf5d(0x200)](_0x47d735,{'id':_0x5ad210[_0x3aaf5d(0xf3)]['id'],'state':_0x5ad210['data'][_0x3aaf5d(0x1c4)],'completed':_0x5ad210[_0x3aaf5d(0xf3)]['state']===_0x3aaf5d(0xa0),'videoUrl':_0x5ad210[_0x3aaf5d(0xf3)][_0x3aaf5d(0x1fc)]?.[_0x3aaf5d(0x1c6)]});}}async[_0x3f82f6(0x1e0)](_0x4812ed){const _0x453592=_0x3f82f6,{prompt:_0x3c3afc,userId:_0x59ddfd,abortController:_0x74531b}=_0x4812ed,_0x4be013=await this[_0x453592(0xb0)]['getModelByType'](model_constant_1[_0x453592(0x15a)][_0x453592(0x1f8)]),_0xc5d93f=_0x4be013[_0x453592(0x216)],_0x2c0537=_0x4be013[_0x453592(0x216)][_0x453592(0x131)];if(!_0xc5d93f)throw new common_1[(_0x453592(0x2d6))](_0x453592(0x22d),common_1['HttpStatus'][_0x453592(0xcf)]);const {id:_0x1eb0ee}=_0xc5d93f;let _0x135a02=null,_0xd7f67d=null;try{const _0x10ef31=await this['buildOptions']('','',_0xc5d93f),_0x5d6ef9=await this[_0x453592(0xf9)](_0xc5d93f,_0x10ef31);_0x135a02=await _0x5d6ef9[_0x453592(0x278)](_0x3c3afc,{..._0x10ef31,'abortSignal':_0x74531b[_0x453592(0x17b)]});const _0x59eef8=(0x0,helper_1[_0x453592(0x2ad)])(_0x2c0537,_0x135a02,_0xd7f67d),{total_tokens:total_tokens=0x0}=_0x59eef8['usage'];return await this['modelsService'][_0x453592(0x1a0)](_0x1eb0ee,total_tokens),await this[_0x453592(0x214)]['deductBalance4Chat'](_0x59ddfd,_0xc5d93f,-0x1),_0x135a02[_0x453592(0x116)];}catch(_0x24058a){common_1[_0x453592(0x217)][_0x453592(0x26c)](_0x24058a);const _0x55df4a=_0x24058a[_0x453592(0x240)];console['log'](_0x55df4a);if(_0x24058a[_0x453592(0x269)]&&_0x24058a[_0x453592(0x269)]===0x192)throw new common_1[(_0x453592(0x2d6))](_0x24058a[_0x453592(0xd8)],common_1[_0x453592(0x11a)]['PAYMENT_REQUIRED']);if(!_0x55df4a)throw new common_1[(_0x453592(0x2d6))](_0x24058a[_0x453592(0xd8)],common_1[_0x453592(0x11a)][_0x453592(0xcf)]);let _0x36dad2=errorMessage_constant_1[_0x453592(0x21c)][_0x55df4a]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x55df4a]:'服务异常、请重新试试吧！！！';_0x24058a?.['message'][_0x453592(0xc6)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&Number(_0x2c0537)===0x1&&(await this['modelsService'][_0x453592(0x201)](_0x1eb0ee,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x36dad2=_0x453592(0x226));_0x24058a?.[_0x453592(0x240)]===0x1ad&&_0x24058a[_0x453592(0xd8)][_0x453592(0xc6)](_0x453592(0x248))&&Number(_0x2c0537)===0x1&&(await this[_0x453592(0xb0)][_0x453592(0x201)](_0x1eb0ee,_0x453592(0x13e),-0x3),_0x36dad2=_0x453592(0x152));_0x24058a?.[_0x453592(0x240)]===0x191&&_0x24058a[_0x453592(0xd8)][_0x453592(0xc6)](_0x453592(0xc2))&&Number(_0x2c0537)===0x1&&(await this[_0x453592(0xb0)][_0x453592(0x201)](_0x1eb0ee,'提供了错误的模型秘钥',-0x2),_0x36dad2=_0x453592(0x133));_0x24058a?.['statusCode']===0x191&&_0x24058a['message'][_0x453592(0xc6)](_0x453592(0x15f))&&Number(_0x2c0537)===0x1&&(await this[_0x453592(0xb0)]['lockKey'](_0x1eb0ee,'当前模型key余额已耗尽',-0x2),_0x36dad2=_0x453592(0x178));_0x24058a?.['statusCode']===0x194&&_0x24058a[_0x453592(0xd8)][_0x453592(0xc6)](_0x453592(0x9e))&&Number(_0x2c0537)===0x1&&(await this['modelsService'][_0x453592(0x201)](_0x1eb0ee,_0x453592(0xa7),-0x4),_0x36dad2=_0x453592(0x17e));_0x24058a?.[_0x453592(0x240)]===0x133&&_0x24058a[_0x453592(0xd8)][_0x453592(0xc6)](_0x453592(0xf5))&&Number(_0x2c0537)===0x1&&(_0x36dad2='\x20！');_0x55df4a===0x190&&console['log'](_0x453592(0x145),_0x24058a,_0x24058a[_0x453592(0xd8)]);const _0x841474={'message':_0x36dad2||_0x453592(0x287),'code':_0x55df4a===0x191?0x191:_0x55df4a||0x1f4};throw new common_1['HttpException'](_0x841474[_0x453592(0xd8)],common_1[_0x453592(0x11a)][_0x453592(0xcf)]);}}async[_0x3f82f6(0x2c4)](_0x4ecac0,_0x1e309c,_0x248c9a){const _0x43cc5e=_0x3f82f6;try{const {audio:_0x3eeff3,voice:_0x352ff5}=_0x4ecac0,_0x32cba7=_0x1e309c[_0x43cc5e(0x2c7)],_0x147dc8=await this['modelsService'][_0x43cc5e(0x20a)]();if(!_0x147dc8)throw _0x43cc5e(0xe6);const {key:_0x2fcb27,proxyUrl:_0x2e7152}=_0x147dc8;await this[_0x43cc5e(0x214)][_0x43cc5e(0x1ba)](_0x1e309c[_0x43cc5e(0x28b)]),await this[_0x43cc5e(0x214)][_0x43cc5e(0x1c8)](_0x1e309c['user']['id'],_0x147dc8),console['log'](_0x43cc5e(0x187),_0x2fcb27,_0x2e7152),this[_0x43cc5e(0xaf)]['apiKey']=_0x2fcb27,this['openAi']['baseURL']=(_0x2e7152||this['defaultBaseUrl'])+'/v1',this[_0x43cc5e(0xaf)][_0x43cc5e(0x2ae)]=0x989680;const _0x440454=await this[_0x43cc5e(0xaf)]['audio'][_0x43cc5e(0x2a6)][_0x43cc5e(0x2cd)]({'file':(0x0,fs_1['createReadStream'])((0x0,path_1['resolve'])(_0x3eeff3[_0x43cc5e(0x109)])),'model':_0x43cc5e(0x1e7),'language':'zh','response_format':_0x43cc5e(0xd0),'temperature':0x0})[_0x43cc5e(0x2c1)](_0x21434b=>_0x21434b[_0x43cc5e(0x116)])['catch'](_0x388acc=>{const _0x5a5091=_0x43cc5e;common_1[_0x5a5091(0x217)][_0x5a5091(0x2fb)](_0x388acc);});console[_0x43cc5e(0x26c)](_0x43cc5e(0x236),_0x440454);if(!_0x440454){this[_0x43cc5e(0xff)]((0x0,path_1[_0x43cc5e(0x1c0)])(_0x3eeff3[_0x43cc5e(0x109)]));throw new common_1[(_0x43cc5e(0x2d6))]('语音转文本失败',common_1['HttpStatus'][_0x43cc5e(0xcf)]);}await this['userService']['deductBalance4Chat'](_0x1e309c[_0x43cc5e(0x28b)]['id'],_0x147dc8,-0x1);const _0x3465ff=await this[_0x43cc5e(0x1e0)]({'userId':_0x1e309c['user']['id'],'prompt':_0x440454,'abortController':_0x32cba7});console[_0x43cc5e(0x26c)]('request\x20gpt\x20',_0x3465ff);if(!_0x3465ff){this[_0x43cc5e(0xff)]((0x0,path_1[_0x43cc5e(0x1c0)])(_0x3eeff3[_0x43cc5e(0x109)]));throw new common_1[(_0x43cc5e(0x2d6))]('内容提取失败',common_1[_0x43cc5e(0x11a)][_0x43cc5e(0xcf)]);}console['log'](_0x43cc5e(0x2f9),_0x3465ff[_0x43cc5e(0x229)]);let _0xf31e99=_0x3465ff[_0x43cc5e(0x229)]>0x1000?_0x3465ff['slice'](0x0,0xfff):_0x3465ff;const _0x1a0c25=await this[_0x43cc5e(0xaf)][_0x43cc5e(0x2b0)][_0x43cc5e(0x1ad)][_0x43cc5e(0x2cd)]({'input':_0xf31e99,'model':_0x43cc5e(0x24f),'response_format':_0x43cc5e(0x9f),'voice':_0x352ff5,'speed':0x1})[_0x43cc5e(0x2c1)](_0x243dd5=>_0x243dd5[_0x43cc5e(0x1dc)]())['catch'](_0x50c2b4=>{const _0x3b8442=_0x43cc5e;common_1[_0x3b8442(0x217)][_0x3b8442(0x2fb)](_0x50c2b4);});if(!_0x1a0c25){this[_0x43cc5e(0xff)]((0x0,path_1[_0x43cc5e(0x1c0)])(_0x3eeff3[_0x43cc5e(0x109)]));throw new common_1[(_0x43cc5e(0x2d6))](_0x43cc5e(0xb3),common_1[_0x43cc5e(0x11a)][_0x43cc5e(0xcf)]);}await this[_0x43cc5e(0x214)]['deductBalance4Chat'](_0x1e309c['user']['id'],_0x147dc8,-0x1);const _0x4ae3ca=Buffer[_0x43cc5e(0x303)](_0x1a0c25);return _0x248c9a['setHeader'](_0x43cc5e(0xf1),_0x43cc5e(0xe3)),_0x248c9a['write'](_0x4ae3ca),_0x248c9a[_0x43cc5e(0x117)](_0x4ae3ca),this[_0x43cc5e(0xff)]((0x0,path_1['resolve'])(_0x3eeff3[_0x43cc5e(0x109)])),_0x4ae3ca;}catch(_0x5532d4){if(_0x5532d4 instanceof common_1[_0x43cc5e(0x2d6)])throw _0x5532d4;else throw new common_1['HttpException'](_0x5532d4[_0x43cc5e(0xd8)],common_1[_0x43cc5e(0x11a)][_0x43cc5e(0xcf)]);}}async[_0x3f82f6(0x21a)](_0x2c4b4c){const _0x13e30e=_0x3f82f6;try{const _0x46e33e=await(0x0,axios_1[_0x13e30e(0xf6)])({'url':_0x2c4b4c,'method':_0x13e30e(0xc8),'responseType':_0x13e30e(0x184)});return _0x46e33e['data'];}catch(_0x337335){throw new Error(_0x13e30e(0x16d)+_0x2c4b4c+_0x13e30e(0xca)+_0x337335[_0x13e30e(0xd8)]);}}async[_0x3f82f6(0x2dc)](_0x54d2b3,_0x174e9e){const _0x3b2229=_0x3f82f6;common_1[_0x3b2229(0x217)][_0x3b2229(0x26c)](_0x3b2229(0x19d)+_0x54d2b3['prompt'],_0x3b2229(0x1d3)),await this[_0x3b2229(0x239)][_0x3b2229(0x2d7)](_0x54d2b3[_0x3b2229(0x2df)],_0x174e9e[_0x3b2229(0x28b)]['id']),await this[_0x3b2229(0x214)]['checkUserStatus'](_0x174e9e[_0x3b2229(0x28b)]);let _0x307509=[];const _0x29daf8=await this[_0x3b2229(0xb0)][_0x3b2229(0xc5)](model_constant_1[_0x3b2229(0x15a)]['DRAW'],_0x54d2b3[_0x3b2229(0x198)]);await this[_0x3b2229(0x214)][_0x3b2229(0x174)](_0x174e9e['user']['id'],_0x29daf8,_0x54d2b3['n']);const {key:_0x7d636c,model:_0x2ddd0f,proxyUrl:_0x3c9b53}=await this[_0x3b2229(0x272)](_0x29daf8);let _0x51c714=_0x3c9b53+'/v1/images/generations';_0x54d2b3['image']&&(_0x51c714=_0x3c9b53+'/v1/images/edits');try{let _0x3534ee;if(_0x54d2b3[_0x3b2229(0x280)]){const _0x5a7be9=new FormData();for(let _0x100d0d=0x0;_0x100d0d<_0x54d2b3[_0x3b2229(0x280)]['length'];_0x100d0d++){const _0x5c91d7=await this[_0x3b2229(0x21a)](_0x54d2b3[_0x3b2229(0x280)][_0x100d0d]),_0x363187=_0x3b2229(0x11e)+_0x54d2b3[_0x3b2229(0x280)][_0x100d0d]+'-'+Date['now']()+'.png';_0x5a7be9['append'](_0x3b2229(0x280),_0x5c91d7,{'filename':_0x363187});}_0x5a7be9[_0x3b2229(0xa6)](_0x3b2229(0x2df),_0x54d2b3[_0x3b2229(0x2df)]),_0x5a7be9[_0x3b2229(0xa6)]('n',_0x54d2b3['n'][_0x3b2229(0x204)]()),_0x5a7be9[_0x3b2229(0xa6)](_0x3b2229(0x97),_0x54d2b3[_0x3b2229(0x97)]),_0x5a7be9['append'](_0x3b2229(0x2ea),_0x3b2229(0x2c9)),_0x5a7be9[_0x3b2229(0xa6)](_0x3b2229(0x198),_0x54d2b3[_0x3b2229(0x198)]),_0x3534ee=await(0x0,axios_1[_0x3b2229(0xf6)])({'method':'post','url':_0x51c714,'headers':{'Authorization':'Bearer\x20'+_0x7d636c,..._0x5a7be9[_0x3b2229(0x118)]()},'data':_0x5a7be9,'maxContentLength':Infinity,'maxBodyLength':Infinity});}else _0x3534ee=await axios_1[_0x3b2229(0xf6)]['post'](_0x51c714,{..._0x54d2b3,'model':_0x2ddd0f,'response_format':_0x3b2229(0x2c9)},{'headers':{'Authorization':_0x3b2229(0x120)+_0x7d636c}});_0x307509=_0x3534ee[_0x3b2229(0xf3)][_0x3b2229(0xf3)];}catch(_0x175938){console[_0x3b2229(0x26c)](_0x3b2229(0x218),_0x175938);const _0x433dc6=_0x175938?.[_0x3b2229(0x2f5)]?.[_0x3b2229(0x269)]||0x1f4,_0xf7b6eb=_0x175938?.[_0x3b2229(0x2f5)]?.['data']?.['error']?.[_0x3b2229(0xd8)];if(_0x433dc6===0x1ad)throw new common_1[(_0x3b2229(0x2d6))](_0x3b2229(0x1b5),common_1[_0x3b2229(0x11a)][_0x3b2229(0xcf)]);if(_0x433dc6===0x190||_0xf7b6eb[_0x3b2229(0xc6)](_0x3b2229(0x277)))throw new common_1['HttpException']('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0x3b2229(0x11a)][_0x3b2229(0xcf)]);if(_0x433dc6===0x1f4)throw new common_1[(_0x3b2229(0x2d6))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1['HttpStatus']['BAD_REQUEST']);if(_0x433dc6===0x191)throw new common_1[(_0x3b2229(0x2d6))](_0x3b2229(0xe1),common_1[_0x3b2229(0x11a)][_0x3b2229(0xcf)]);throw new common_1[(_0x3b2229(0x2d6))](_0x3b2229(0x2e3),common_1[_0x3b2229(0x11a)][_0x3b2229(0xcf)]);}const _0x1f7f6b=[];for(const _0x2e664e of _0x307509){const _0x13bbbd=_0x2e664e[_0x3b2229(0x2c9)]['replace'](/^data:image\/\w+;base64,/,''),_0x232541=uuid['v4']()[_0x3b2229(0x221)](0x0,0xa)+_0x3b2229(0x228),_0x30103f=Buffer['from'](_0x13bbbd,_0x3b2229(0x100));_0x1f7f6b[_0x3b2229(0x2d0)](this['fileService'][_0x3b2229(0x294)]({'filename':_0x232541,'buffer':_0x30103f}));}const _0x13b4d9=(0x0,utils_1['getClientIp'])(_0x174e9e),_0x17e7cd=await Promise['all'](_0x1f7f6b),[_0x49ca77,_0x2f7825]=_0x54d2b3[_0x3b2229(0x97)]['split']('x'),_0x5e4aa2=_0x17e7cd[_0x3b2229(0x1f2)](_0x4a05d5=>{const _0x1ff3ae=_0x3b2229;return this['chatLogService'][_0x1ff3ae(0x136)]({'curIp':_0x13b4d9,'logType':0x3,'answer':_0x4a05d5,'totalTokens':0x0,'promptTokens':0x0,'model':_0x54d2b3['model'],'userId':_0x174e9e[_0x1ff3ae(0x28b)]['id'],'prompt':_0x54d2b3['prompt'],'completionTokens':0x0,'modelSubType':'1','modelType':model_constant_1[_0x1ff3ae(0x15a)][_0x1ff3ae(0x298)],'type':balance_constant_1[_0x1ff3ae(0x2c8)]['PAINT_TYPE'],'fileInfo':JSON[_0x1ff3ae(0x122)]({'width':_0x49ca77,'height':_0x2f7825,'cosUrl':_0x4a05d5})});}),_0x1c5f76=await Promise[_0x3b2229(0x275)](_0x5e4aa2);return await this['userService']['deductBalance4Draw'](_0x174e9e[_0x3b2229(0x28b)]['id'],_0x29daf8,_0x1c5f76[0x0]['id'],_0x54d2b3['n']),_0x17e7cd;}async[_0x3f82f6(0x272)](_0x3b9e20){const _0x325929=_0x3f82f6,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x325929(0x20f)][_0x325929(0x2f4)]([_0x325929(0x192),_0x325929(0xae),_0x325929(0x25a),'openaiModel3MaxTokens16kRes',_0x325929(0x127),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k',_0x325929(0x104),_0x325929(0x142)]);let _0x5d62bc=null,_0x51929a=null,_0x207f6a=null;const {model:_0x55f63d,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x3c693f,key:_0xf5ffc9}=_0x3b9e20;return _0x55f63d['toLowerCase']()[_0x325929(0xc6)](_0x325929(0x129))&&(_0x55f63d[_0x325929(0x1f7)]()['includes'](_0x325929(0x293))?(_0x5d62bc=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x51929a=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x5d62bc=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x51929a=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x55f63d[_0x325929(0x1f7)]()[_0x325929(0xc6)](_0x325929(0x27f))&&(_0x55f63d['toLowerCase']()[_0x325929(0xc6)](_0x325929(0x14c))?(_0x5d62bc=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x51929a=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x5d62bc=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x51929a=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x207f6a=_0x3c693f||openaiBaseUrl||_0x325929(0x167),_0x51929a>=_0x5d62bc&&(_0x51929a=Math[_0x325929(0x2a8)](_0x5d62bc/0x2),common_1[_0x325929(0x217)][_0x325929(0x209)](_0x325929(0x2cc)+_0xf5ffc9+_0x325929(0xa5)+_0x51929a)),{'key':_0xf5ffc9,'model':_0x55f63d,'maxToken':_0x5d62bc,'maxTokenRes':_0x51929a,'proxyUrl':_0x207f6a};}async[_0x3f82f6(0xda)](_0x4f5125){const _0x2b071c=_0x3f82f6;try{const _0x40af37=await this[_0x2b071c(0x1b2)][_0x2b071c(0x2d4)](_0x4f5125),_0x16c016=await this[_0x2b071c(0x10f)][_0x2b071c(0xfc)]({'where':{'yooTaskId':_0x4f5125['params']['id']}});if(!_0x16c016)throw new Error(_0x2b071c(0x24a));_0x16c016[_0x2b071c(0x269)]=_0x40af37[_0x2b071c(0xf3)]['status'],_0x16c016['stateDesc']=_0x40af37[_0x2b071c(0xf3)]['state_description'],_0x16c016[_0x2b071c(0x2bd)]=_0x40af37[_0x2b071c(0xf3)][_0x2b071c(0x2bd)],_0x16c016['progressUrl']=_0x40af37[_0x2b071c(0xf3)][_0x2b071c(0x2a7)],_0x16c016['pageCount']=_0x40af37[_0x2b071c(0xf3)]['page_count'],_0x16c016[_0x2b071c(0x14e)]=_0x40af37[_0x2b071c(0xf3)]['pptx_url'],_0x16c016[_0x2b071c(0xc7)]=_0x40af37[_0x2b071c(0xf3)][_0x2b071c(0x1cf)],_0x16c016['startTime']=_0x40af37['data'][_0x2b071c(0x1db)],_0x16c016[_0x2b071c(0x304)]=_0x40af37[_0x2b071c(0xf3)][_0x2b071c(0x2a5)],_0x16c016[_0x2b071c(0x20d)]=_0x40af37[_0x2b071c(0xf3)][_0x2b071c(0x250)],await this[_0x2b071c(0x10f)]['save'](_0x16c016);}catch(_0x466293){common_1['Logger']['error'](_0x466293[_0x2b071c(0xd8)],_0x2b071c(0x132));}}async[_0x3f82f6(0x1ce)](_0x4b16d2,_0x3ec2ea){const _0x136335=_0x3f82f6;try{return this[_0x136335(0x1fd)]['transaction'](async()=>{const _0x280570=_0x136335,_0x227b04=await this[_0x280570(0xb0)][_0x280570(0x2fa)](model_constant_1['EModelType'][_0x280570(0x2f6)]);let _0x5ee082={'userId':_0x4b16d2['user']['id'],'type':ppt_constant_1[_0x280570(0x25b)]['STRUCTURE'],'title':_0x3ec2ea['title'],'text':_0x3ec2ea[_0x280570(0x116)],'theme':_0x3ec2ea[_0x280570(0xe7)]};_0x5ee082=await this[_0x280570(0x10f)][_0x280570(0x202)](_0x5ee082),await this[_0x280570(0x214)][_0x280570(0x2fe)](_0x4b16d2[_0x280570(0x28b)]['id'],_0x5ee082['id'],_0x5ee082[_0x280570(0xb9)]);const _0x15a3b1=await this[_0x280570(0x1b2)]['pptStructure']({'data':_0x3ec2ea,'baseURL':_0x227b04[_0x280570(0x216)][_0x280570(0xfe)],'headers':{'Authorization':_0x280570(0x120)+_0x227b04[_0x280570(0x216)]['accessToken']}});return _0x5ee082['title']=_0x15a3b1['data']['title'],_0x5ee082[_0x280570(0x18f)]=_0x15a3b1[_0x280570(0xf3)][_0x280570(0x18f)],await this[_0x280570(0x10f)][_0x280570(0x202)](_0x5ee082),_0x5ee082;});}catch(_0x3c4772){throw new common_1[(_0x136335(0x2d6))](_0x3c4772[_0x136335(0xd8)],common_1[_0x136335(0x11a)][_0x136335(0xcf)]);}}async[_0x3f82f6(0x2b1)](_0x1a1b63,_0x45ad00){const _0x41851f=_0x3f82f6,_0x5acd6a=await this[_0x41851f(0x10f)][_0x41851f(0xfc)]({'where':{'id':_0x45ad00}});if(!_0x5acd6a)throw new common_1[(_0x41851f(0x2d6))](_0x41851f(0x263),common_1[_0x41851f(0x11a)][_0x41851f(0xcf)]);await this[_0x41851f(0x214)][_0x41851f(0x2fe)](_0x1a1b63[_0x41851f(0x28b)]['id'],_0x5acd6a['id'],ppt_constant_1['EPPTTaskType']['EDITOR']);const _0x40d083=await this[_0x41851f(0xb0)][_0x41851f(0x2fa)](model_constant_1['EModelType']['PPT']),_0x575b27=await this['pptService'][_0x41851f(0x1f6)]({'baseURL':_0x40d083[_0x41851f(0x216)]['proxyUrl'],'headers':{'Authorization':_0x41851f(0x19f)+_0x40d083[_0x41851f(0x216)][_0x41851f(0x237)]},'data':{'id':_0x5acd6a[_0x41851f(0x12f)],'expire':0x83d600}});return _0x575b27[_0x41851f(0x264)]==_0x41851f(0x292)&&_0x575b27[_0x41851f(0xf3)][_0x41851f(0x1c6)]&&(_0x5acd6a[_0x41851f(0x1a2)]=_0x575b27[_0x41851f(0xf3)][_0x41851f(0x1c6)],await this['pptTaskEntity']['update']({'id':_0x5acd6a['id']},{'editorUrl':_0x5acd6a['editorUrl']})),_0x5acd6a;}async[_0x3f82f6(0x10c)](_0x10d6d6,_0x412791){const _0xc3ad9d=_0x3f82f6,_0x38d65c=await this[_0xc3ad9d(0x10f)][_0xc3ad9d(0xfc)]({'where':{'id':_0x412791}});if(!_0x38d65c)throw new common_1[(_0xc3ad9d(0x2d6))](_0xc3ad9d(0x263),common_1[_0xc3ad9d(0x11a)]['BAD_REQUEST']);await this[_0xc3ad9d(0x214)][_0xc3ad9d(0x2fe)](_0x10d6d6['user']['id'],_0x38d65c['id'],ppt_constant_1['EPPTTaskType']['Download']);const _0x3e5a9f=await this[_0xc3ad9d(0xb0)][_0xc3ad9d(0x2fa)](model_constant_1[_0xc3ad9d(0x15a)]['PPT']),_0x477cc4=await this['pptService']['pptDownload']({'baseURL':_0x3e5a9f[_0xc3ad9d(0x216)]['proxyUrl'],'headers':{'Authorization':_0xc3ad9d(0x19f)+_0x3e5a9f[_0xc3ad9d(0x216)][_0xc3ad9d(0x237)]},'params':{'id':_0x38d65c[_0xc3ad9d(0x12f)],'type':_0xc3ad9d(0x295)}});return _0x477cc4[_0xc3ad9d(0x264)]=='200'&&_0x477cc4['data'][_0xc3ad9d(0xe4)]&&(_0x38d65c['downUrl']=_0x477cc4[_0xc3ad9d(0xf3)][_0xc3ad9d(0xe4)],await this[_0xc3ad9d(0x10f)]['update']({'id':_0x38d65c['id']},{'downUrl':_0x38d65c[_0xc3ad9d(0x14e)]})),_0x38d65c;}[_0x3f82f6(0x24b)](_0x27fcc6,_0x5a240b){const _0x2c52b6=_0x3f82f6;try{return this[_0x2c52b6(0x1fd)][_0x2c52b6(0x164)](async()=>{const _0x4e1a03=_0x2c52b6,_0x2566f9=await this[_0x4e1a03(0xb0)]['getModelByType'](model_constant_1[_0x4e1a03(0x15a)][_0x4e1a03(0x2f6)]);let _0x593ab1={'userId':_0x27fcc6[_0x4e1a03(0x28b)]['id'],'type':ppt_constant_1[_0x4e1a03(0x25b)]['COVER'],'title':_0x5a240b[_0x4e1a03(0x149)],'text':_0x5a240b[_0x4e1a03(0x116)],'author':_0x5a240b['author'],'color':_0x5a240b[_0x4e1a03(0x1d6)],'style':_0x5a240b['style']};_0x593ab1=await this['pptTaskEntity']['save'](_0x593ab1),await this[_0x4e1a03(0x214)][_0x4e1a03(0x2fe)](_0x27fcc6[_0x4e1a03(0x28b)]['id'],_0x593ab1['id'],_0x593ab1[_0x4e1a03(0xb9)]);const _0x3e3c44=await this['pptService']['pptCover']({'data':{'title':_0x5a240b['title'],'count':_0x5a240b['text'],'user_name':_0x5a240b[_0x4e1a03(0x1a7)],'color':_0x5a240b[_0x4e1a03(0x1d6)],'style':_0x5a240b[_0x4e1a03(0x13a)]},'baseURL':_0x2566f9['modelInfo'][_0x4e1a03(0xfe)],'headers':{'Authorization':'Beare\x20'+_0x2566f9['modelInfo']['accessToken']}});return _0x593ab1[_0x4e1a03(0x21b)]=_0x3e3c44[_0x4e1a03(0xf3)],await this[_0x4e1a03(0x10f)][_0x4e1a03(0x202)](_0x593ab1),_0x593ab1;});}catch(_0x2173ef){throw new common_1['HttpException'](_0x2173ef[_0x2c52b6(0xd8)],common_1[_0x2c52b6(0x11a)][_0x2c52b6(0xcf)]);}}[_0x3f82f6(0x2e1)](_0x7041d,_0x502f0c){const _0x3bba48=_0x3f82f6;try{return this[_0x3bba48(0x1fd)][_0x3bba48(0x164)](async()=>{const _0x314521=_0x3bba48,_0x2cf24a=await this['modelsService'][_0x314521(0x2fa)](model_constant_1[_0x314521(0x15a)]['PPT']);let _0x271fd3={'userId':_0x7041d[_0x314521(0x28b)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x314521(0x172)],'title':_0x502f0c[_0x314521(0x149)],'text':_0x502f0c[_0x314521(0x116)],'author':_0x502f0c[_0x314521(0x1a7)],'coverId':_0x502f0c[_0x314521(0x19b)]};_0x271fd3=await this[_0x314521(0x10f)][_0x314521(0x202)](_0x271fd3),await this[_0x314521(0x214)][_0x314521(0x2fe)](_0x7041d[_0x314521(0x28b)]['id'],_0x271fd3['id'],_0x271fd3[_0x314521(0xb9)]);const _0x591387=await this[_0x314521(0x1b2)][_0x314521(0x2e1)]({'data':{'title':_0x502f0c[_0x314521(0x149)],'count':_0x502f0c['text'],'user_name':_0x502f0c[_0x314521(0x1a7)],'cover_id':_0x502f0c[_0x314521(0x19b)]},'baseURL':_0x2cf24a[_0x314521(0x216)][_0x314521(0xfe)],'headers':{'Authorization':_0x314521(0x19f)+_0x2cf24a[_0x314521(0x216)]['accessToken']}});return _0x271fd3[_0x314521(0x21b)]=_0x591387['data'],await this[_0x314521(0x10f)]['save'](_0x271fd3),_0x271fd3;});}catch(_0x2c6c9f){throw new common_1[(_0x3bba48(0x2d6))](_0x2c6c9f['message'],common_1[_0x3bba48(0x11a)][_0x3bba48(0xcf)]);}}async[_0x3f82f6(0x23d)](_0x394a61){const _0x291722=_0x3f82f6;try{const _0x3d190c=['pptOutlinePrice','pptOutlineVipFree',_0x291722(0x230),_0x291722(0x238),'pptEditorPrice',_0x291722(0x16b),_0x291722(0x13f)],_0x180cd9=await this[_0x291722(0x20f)][_0x291722(0x2f4)](_0x3d190c);if(!_0x394a61[_0x291722(0x28b)]||!_0x394a61[_0x291722(0x28b)]['id'])throw new Error(_0x291722(0x9d));const _0x57276d=[_0x291722(0x158),_0x291722(0x2e2),_0x291722(0x1f6)],_0x305f18=await Promise[_0x291722(0x275)](_0x57276d[_0x291722(0x1f2)](async _0x55d8bc=>{const _0x5b14d4=_0x291722,_0xfaffa9=_0x180cd9[_0x55d8bc+_0x5b14d4(0x191)],_0x13f5dd=_0x180cd9[_0x55d8bc+_0x5b14d4(0x25d)],_0x57c5b9=redisKey_constant_1['VIP_FREE']+'-'+_0x394a61['user']['id']+'-'+(_0x55d8bc+'VipFree'),_0x1ff105=await this[_0x5b14d4(0x214)][_0x5b14d4(0x26b)](_0x394a61['user']['id'],_0x57c5b9,_0xfaffa9);return{'type':_0x55d8bc,'remainCount':_0x1ff105,'freeCount':Number(_0xfaffa9),'useIntegrate':Number(_0x13f5dd),'userType':_0x180cd9['pptUserType'],'isVipUsed':_0x180cd9[_0x5b14d4(0x13f)]?!![]:![]};}));return _0x305f18;}catch(_0x489449){console[_0x291722(0x2fb)]('Error\x20in\x20pptConfig:',_0x489449);throw _0x489449;}}[_0x3f82f6(0x2e2)](_0x3ab088,_0x542641){const _0x20b276=_0x3f82f6;try{return this[_0x20b276(0x1fd)][_0x20b276(0x164)](async()=>{const _0x34e712=_0x20b276;let _0x541679;const _0x4e9daa=await this[_0x34e712(0xb0)][_0x34e712(0x2fa)](model_constant_1[_0x34e712(0x15a)][_0x34e712(0x2f6)]);if(_0x542641[_0x34e712(0x305)]){_0x541679=await this[_0x34e712(0x10f)][_0x34e712(0xfc)]({'where':{'id':_0x542641[_0x34e712(0x305)]}});if(!_0x541679)throw new Error('原始任务不存在！');}let _0x52aa41={'userId':_0x3ab088[_0x34e712(0x28b)]['id'],'type':ppt_constant_1[_0x34e712(0x25b)][_0x34e712(0x130)],'title':_0x542641[_0x34e712(0x149)],'subTitle':_0x542641[_0x34e712(0x257)],'text':_0x542641[_0x34e712(0x116)],'catalogs':_0x542641[_0x34e712(0x18f)],'contents':_0x542641[_0x34e712(0x11f)],'author':_0x542641['author'],'fontName':_0x542641[_0x34e712(0x273)],'transition':_0x542641[_0x34e712(0x242)],'complex':_0x542641[_0x34e712(0x2a4)],'coverId':_0x542641[_0x34e712(0x19b)],'originId':_0x542641[_0x34e712(0x305)]};_0x52aa41=await this[_0x34e712(0x10f)][_0x34e712(0x202)](_0x52aa41),await this['userService'][_0x34e712(0x2fe)](_0x3ab088[_0x34e712(0x28b)]['id'],_0x52aa41['id'],_0x52aa41[_0x34e712(0xb9)]);try{const _0x583a34=await this[_0x34e712(0x1b2)][_0x34e712(0x2e2)]({'data':{'text':_0x542641[_0x34e712(0x116)],'custom_data':{'title':_0x542641['title'],'sub_title':_0x542641[_0x34e712(0x257)],'author':_0x542641[_0x34e712(0x1a7)],'catalogs':_0x542641[_0x34e712(0x18f)],'contents':_0x542641[_0x34e712(0x11f)]},'cover_id':_0x542641[_0x34e712(0x19b)],'font_name':_0x542641['fontName'],'transition':_0x542641['transition'],'complex':_0x542641[_0x34e712(0x2a4)],'user_name':_0x542641[_0x34e712(0x1a7)],'id':_0x541679?.[_0x34e712(0x12f)]},'baseURL':_0x4e9daa[_0x34e712(0x216)][_0x34e712(0xfe)],'headers':{'Authorization':_0x34e712(0x19f)+_0x4e9daa['modelInfo'][_0x34e712(0x237)]}});return _0x52aa41['yooTaskId']=_0x583a34[_0x34e712(0xf3)]['id'],await this[_0x34e712(0x10f)]['save'](_0x52aa41),_0x52aa41;}catch(_0x1651d9){await this['userService']['debuctBalance4PPT'](_0x3ab088['user']['id'],_0x52aa41['id'],_0x52aa41[_0x34e712(0xb9)],!![]);throw new common_1[(_0x34e712(0x2d6))](_0x1651d9[_0x34e712(0xd8)],common_1[_0x34e712(0x11a)][_0x34e712(0xcf)]);}});}catch(_0x560181){throw new common_1['HttpException'](_0x560181[_0x20b276(0xd8)],common_1[_0x20b276(0x11a)][_0x20b276(0xcf)]);}}[_0x3f82f6(0xed)](_0x370cf8,_0x16210a){const _0x446dd1=_0x3f82f6;try{return this[_0x446dd1(0x1fd)][_0x446dd1(0x164)](async()=>{const _0x137b9a=_0x446dd1,_0x4ce81d=await this[_0x137b9a(0xb0)][_0x137b9a(0x2fa)](model_constant_1[_0x137b9a(0x15a)][_0x137b9a(0x2f6)]);let _0x5a1b86={'userId':_0x370cf8[_0x137b9a(0x28b)]['id'],'type':ppt_constant_1[_0x137b9a(0x25b)][_0x137b9a(0x124)],'title':_0x16210a[_0x137b9a(0x149)],'color':_0x16210a['color'],'style':_0x16210a[_0x137b9a(0x13a)],'fileUrl':_0x16210a[_0x137b9a(0x23a)],'pleader':_0x16210a[_0x137b9a(0x155)],'advisor':_0x16210a[_0x137b9a(0xb8)],'school':_0x16210a[_0x137b9a(0x205)],'schoolLogo':_0x16210a[_0x137b9a(0x2f3)],'schoolPicture':_0x16210a[_0x137b9a(0x2ac)]};_0x5a1b86=await this[_0x137b9a(0x10f)][_0x137b9a(0x202)](_0x5a1b86),await this[_0x137b9a(0x214)][_0x137b9a(0x2fe)](_0x370cf8['user']['id'],_0x5a1b86['id'],_0x5a1b86[_0x137b9a(0xb9)]);const _0x35e9e9=await this[_0x137b9a(0x1b2)][_0x137b9a(0xed)]({'data':{'file_key':_0x16210a[_0x137b9a(0x23a)],'title':_0x16210a[_0x137b9a(0x149)],'color':_0x16210a[_0x137b9a(0x1d6)],'style':_0x16210a[_0x137b9a(0x13a)],'pleader':_0x16210a[_0x137b9a(0x155)],'advisor':_0x16210a['advisor'],'school':_0x16210a['school'],'school_logo':_0x16210a['schoolLogo'],'school_picture':_0x16210a[_0x137b9a(0x2ac)]},'baseURL':_0x4ce81d['modelInfo'][_0x137b9a(0xfe)],'headers':{'Authorization':_0x137b9a(0x19f)+_0x4ce81d[_0x137b9a(0x216)][_0x137b9a(0x237)]}});return _0x5a1b86['yooTaskId']=_0x35e9e9[_0x137b9a(0xf3)]['id'],await this[_0x137b9a(0x10f)][_0x137b9a(0x202)](_0x5a1b86),setTimeout(()=>this[_0x137b9a(0xda)]({'baseURL':_0x4ce81d[_0x137b9a(0x216)][_0x137b9a(0xfe)],'headers':{'Authorization':_0x137b9a(0x19f)+_0x4ce81d[_0x137b9a(0x216)]['accessToken']},'params':{'id':_0x5a1b86[_0x137b9a(0x12f)]}}),0xbb8),_0x5a1b86;});}catch(_0xd85e03){throw new common_1[(_0x446dd1(0x2d6))](_0xd85e03[_0x446dd1(0xd8)],common_1[_0x446dd1(0x11a)][_0x446dd1(0xcf)]);}}[_0x3f82f6(0xac)](_0x555fa7,_0x49ee1f){const _0x54848c=_0x3f82f6;try{return this[_0x54848c(0x1fd)][_0x54848c(0x164)](async()=>{const _0x532030=_0x54848c,_0x8269d9=await this[_0x532030(0xb0)][_0x532030(0x2fa)](model_constant_1[_0x532030(0x15a)]['PPT']);let _0x5b0a1f={'userId':_0x555fa7[_0x532030(0x28b)]['id'],'type':ppt_constant_1[_0x532030(0x25b)][_0x532030(0x1d9)],'fileUrl':_0x49ee1f[_0x532030(0x23a)],'coverId':_0x49ee1f[_0x532030(0x19b)],'author':_0x49ee1f[_0x532030(0x1a7)]};_0x5b0a1f=await this[_0x532030(0x10f)]['save'](_0x5b0a1f),await this[_0x532030(0x214)]['debuctBalance4PPT'](_0x555fa7[_0x532030(0x28b)]['id'],_0x5b0a1f['id'],_0x5b0a1f['type']);const _0x39521c=await this[_0x532030(0x1b2)][_0x532030(0xac)]({'data':{'file_url':_0x49ee1f['fileUrl'],'cover_id':_0x49ee1f[_0x532030(0x19b)],'user_name':_0x49ee1f[_0x532030(0x1a7)]},'baseURL':_0x8269d9[_0x532030(0x216)]['proxyUrl'],'headers':{'Authorization':_0x532030(0x19f)+_0x8269d9[_0x532030(0x216)][_0x532030(0x237)]}});return _0x5b0a1f[_0x532030(0x12f)]=_0x39521c['data']['id'],await this[_0x532030(0x10f)][_0x532030(0x202)](_0x5b0a1f),setTimeout(()=>this[_0x532030(0xda)]({'baseURL':_0x8269d9[_0x532030(0x216)]['proxyUrl'],'headers':{'Authorization':_0x532030(0x19f)+_0x8269d9[_0x532030(0x216)][_0x532030(0x237)]},'params':{'id':_0x5b0a1f[_0x532030(0x12f)]}}),0xbb8),_0x5b0a1f;});}catch(_0x2088e8){throw new common_1[(_0x54848c(0x2d6))](_0x2088e8[_0x54848c(0xd8)],common_1[_0x54848c(0x11a)][_0x54848c(0xcf)]);}}['pptDetail'](_0xe6e477){const _0x299509=_0x3f82f6;return this[_0x299509(0x10f)][_0x299509(0xfc)]({'where':{'id':_0xe6e477}});}[_0x3f82f6(0x1be)](_0x55a5ac,_0x37b8da){const _0x4060aa=_0x3f82f6;try{return this['connection'][_0x4060aa(0x164)](async()=>{const _0x42e2ee=_0x4060aa,_0x422e8c=await this[_0x42e2ee(0x10f)][_0x42e2ee(0xfc)]({'where':{'id':_0x37b8da[_0x42e2ee(0x305)]}});if(!_0x422e8c)throw new Error(_0x42e2ee(0x153));const _0x1a1c64=await this[_0x42e2ee(0xb0)]['getModelByType'](model_constant_1[_0x42e2ee(0x15a)][_0x42e2ee(0x2f6)]);let _0x4c4436={'userId':_0x55a5ac[_0x42e2ee(0x28b)]['id'],'type':ppt_constant_1[_0x42e2ee(0x25b)][_0x42e2ee(0x279)],'originId':_0x37b8da['originTaskId'],'coverId':_0x37b8da[_0x42e2ee(0x19b)],'fontName':_0x37b8da[_0x42e2ee(0x273)],'transition':_0x37b8da[_0x42e2ee(0x242)]};_0x4c4436=await this[_0x42e2ee(0x10f)][_0x42e2ee(0x202)](_0x4c4436),await this[_0x42e2ee(0x214)][_0x42e2ee(0x2fe)](_0x55a5ac['user']['id'],_0x4c4436['id'],_0x4c4436[_0x42e2ee(0xb9)]);const _0x31237c=await this['pptService']['pptChangeTheme']({'data':{'id':_0x422e8c[_0x42e2ee(0x12f)],'cover_id':_0x37b8da[_0x42e2ee(0x19b)],'font_name':_0x37b8da[_0x42e2ee(0x273)],'transition':_0x37b8da['transition']},'baseURL':_0x1a1c64[_0x42e2ee(0x216)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x1a1c64[_0x42e2ee(0x216)][_0x42e2ee(0x237)]}});return _0x4c4436['yooTaskId']=_0x31237c[_0x42e2ee(0xf3)]['id'],await this[_0x42e2ee(0x10f)]['save'](_0x4c4436),setTimeout(()=>this[_0x42e2ee(0xda)]({'baseURL':_0x1a1c64[_0x42e2ee(0x216)]['proxyUrl'],'headers':{'Authorization':_0x42e2ee(0x19f)+_0x1a1c64[_0x42e2ee(0x216)]['accessToken']},'params':{'id':_0x4c4436[_0x42e2ee(0x12f)]}}),0xbb8),_0x4c4436;});}catch(_0x1e9e05){throw new common_1['HttpException'](_0x1e9e05[_0x4060aa(0xd8)],common_1['HttpStatus'][_0x4060aa(0xcf)]);}}['pptAddPage'](_0x26cbb7,_0x35e92f){const _0x217e84=_0x3f82f6;try{return this[_0x217e84(0x1fd)]['transaction'](async()=>{const _0xcdfac6=_0x217e84,_0xb1ef18=await this[_0xcdfac6(0x10f)][_0xcdfac6(0xfc)]({'where':{'id':_0x35e92f[_0xcdfac6(0x305)]}});if(!_0xb1ef18)throw new Error(_0xcdfac6(0x153));const _0x4fb9d7=await this[_0xcdfac6(0xb0)][_0xcdfac6(0x2fa)](model_constant_1[_0xcdfac6(0x15a)][_0xcdfac6(0x2f6)]);let _0x83090c={'userId':_0x26cbb7[_0xcdfac6(0x28b)]['id'],'type':ppt_constant_1[_0xcdfac6(0x25b)][_0xcdfac6(0x261)],'originId':_0x35e92f[_0xcdfac6(0x305)],'theme':_0x35e92f[_0xcdfac6(0xe7)],'text':_0x35e92f[_0xcdfac6(0x116)],'complex':_0x35e92f['complex']?String(_0x35e92f[_0xcdfac6(0x2a4)]):'1','author':_0x35e92f['author'],'fontName':_0x35e92f['fontName'],'transition':_0x35e92f[_0xcdfac6(0x242)],'slideNumber':_0x35e92f[_0xcdfac6(0x29a)],'slideType':_0x35e92f['slideType']};_0x83090c=await this[_0xcdfac6(0x10f)][_0xcdfac6(0x202)](_0x83090c),await this[_0xcdfac6(0x214)][_0xcdfac6(0x2fe)](_0x26cbb7[_0xcdfac6(0x28b)]['id'],_0x83090c['id'],_0x83090c[_0xcdfac6(0xb9)]);const _0x573f78=await this['pptService']['pptAddPage']({'data':{'id':_0xb1ef18[_0xcdfac6(0x12f)],'text':_0x35e92f[_0xcdfac6(0x116)],'complex':_0x35e92f[_0xcdfac6(0x2a4)],'user_name':_0x35e92f['author'],'font_name':_0x35e92f[_0xcdfac6(0x273)],'transition':_0x35e92f[_0xcdfac6(0x242)],'slide_number':_0x35e92f[_0xcdfac6(0x29a)],'slide_type':_0x35e92f[_0xcdfac6(0x21e)],'theme':_0x35e92f[_0xcdfac6(0xe7)]},'baseURL':_0x4fb9d7[_0xcdfac6(0x216)][_0xcdfac6(0xfe)],'headers':{'Authorization':_0xcdfac6(0x19f)+_0x4fb9d7['modelInfo'][_0xcdfac6(0x237)]}});return _0x83090c[_0xcdfac6(0x12f)]=_0x573f78[_0xcdfac6(0xf3)]['id'],await this[_0xcdfac6(0x10f)][_0xcdfac6(0x202)](_0x83090c),setTimeout(()=>this[_0xcdfac6(0xda)]({'baseURL':_0x4fb9d7['modelInfo'][_0xcdfac6(0xfe)],'headers':{'Authorization':'Beare\x20'+_0x4fb9d7['modelInfo']['accessToken']},'params':{'id':_0x83090c['yooTaskId']}}),0xbb8),_0x83090c;});}catch(_0x605935){throw new common_1[(_0x217e84(0x2d6))](_0x605935[_0x217e84(0xd8)],common_1[_0x217e84(0x11a)][_0x217e84(0xcf)]);}}['pptAddNote'](_0x2bc15c,_0x37360b){const _0x475c6e=_0x3f82f6;try{return this[_0x475c6e(0x1fd)][_0x475c6e(0x164)](async()=>{const _0xe22399=_0x475c6e,_0x313e59=await this['pptTaskEntity'][_0xe22399(0xfc)]({'where':{'id':_0x37360b[_0xe22399(0x305)]}});if(!_0x313e59)throw new Error('原始任务不存在！');const _0x34d5a1=await this[_0xe22399(0xb0)]['getModelByType'](model_constant_1['EModelType'][_0xe22399(0x2f6)]);let _0x333244={'userId':_0x2bc15c['user']['id'],'type':ppt_constant_1[_0xe22399(0x25b)][_0xe22399(0x188)],'originId':_0x37360b[_0xe22399(0x305)],'notes':_0x37360b};_0x333244=await this[_0xe22399(0x10f)][_0xe22399(0x202)](_0x333244),await this[_0xe22399(0x214)][_0xe22399(0x2fe)](_0x2bc15c[_0xe22399(0x28b)]['id'],_0x333244['id'],_0x333244[_0xe22399(0xb9)]);const _0x263ebe=await this[_0xe22399(0x1b2)][_0xe22399(0xa3)]({'data':{..._0x37360b,'id':_0x313e59[_0xe22399(0x12f)]},'baseURL':_0x34d5a1[_0xe22399(0x216)]['proxyUrl'],'headers':{'Authorization':_0xe22399(0x19f)+_0x34d5a1[_0xe22399(0x216)]['accessToken']}});return _0x333244['yooTaskId']=_0x263ebe[_0xe22399(0xf3)]['id'],await this[_0xe22399(0x10f)][_0xe22399(0x202)](_0x333244),setTimeout(()=>this[_0xe22399(0xda)]({'baseURL':_0x34d5a1[_0xe22399(0x216)][_0xe22399(0xfe)],'headers':{'Authorization':_0xe22399(0x19f)+_0x34d5a1['modelInfo']['accessToken']},'params':{'id':_0x333244[_0xe22399(0x12f)]}}),0xbb8),_0x333244;});}catch(_0x1e338b){throw new common_1[(_0x475c6e(0x2d6))](_0x1e338b['message'],common_1[_0x475c6e(0x11a)]['BAD_REQUEST']);}}async[_0x3f82f6(0x121)](_0x16ccfd,_0x13fb9a){const _0x3115de=_0x3f82f6,{page:page=0x1,size:size=0x14,keyword:_0x5a3150}=_0x16ccfd,_0x20aa0c=[{'delFlag':0x0,'publishFlag':0x1,'type':(0x0,typeorm_1['In'])([ppt_constant_1[_0x3115de(0x25b)][_0x3115de(0x130)],ppt_constant_1[_0x3115de(0x25b)][_0x3115de(0x1d9)]])}];_0x5a3150&&_0x20aa0c['push']({'title':(0x0,typeorm_1['Like'])('%'+_0x5a3150+'%'),'delFlag':0x0},{'subTitle':(0x0,typeorm_1['Like'])('%'+_0x5a3150+'%'),'delFlag':0x0});const [_0x1ab0e9,_0x270cef]=await this['pptTaskEntity'][_0x3115de(0x2ec)]({'where':_0x20aa0c,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':'DESC'}}),_0x2af5bf=await this[_0x3115de(0x214)][_0x3115de(0x1b8)](_0x1ab0e9,_0x13fb9a);return{'rows':_0x2af5bf,'count':_0x270cef};}async[_0x3f82f6(0x22f)](_0x56c069,_0x3d7793){const _0x40ffdc=_0x3f82f6,_0x46c3ce=_0x3d7793[_0x40ffdc(0x28b)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x4acc8b}=_0x56c069,_0x10ca2a='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x20and\x20(type=\x27create\x27\x20or\x20type=\x27file\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4acc8b?'\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%'+_0x4acc8b+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%'+_0x4acc8b+_0x40ffdc(0x286):'')+_0x40ffdc(0x170)+(_0x46c3ce?'\x20AND\x20p.user_id\x20=\x20'+_0x46c3ce:'')+'\x0a\x20\x20\x20\x20\x20\x20',_0x5cf780=await this[_0x40ffdc(0x1fd)]['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x10ca2a+_0x40ffdc(0x2c6)),_0x898332=await this['connection']['query'](_0x40ffdc(0x2da)+_0x10ca2a+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x40ffdc(0x2c6));!(0x0,utils_1[_0x40ffdc(0x94)])(this[_0x40ffdc(0x1ee)])&&_0x898332['forEach'](_0x1647b8=>{_0x1647b8['email']=(0x0,utils_1['maskEmail'])(_0x1647b8['email']),_0x1647b8['phone']=(0x0,utils_1['maskEmail'])(_0x1647b8['phone']);});const _0x34999a=await this[_0x40ffdc(0x214)][_0x40ffdc(0x1b8)](_0x898332,_0x3d7793);return{'rows':_0x34999a,'count':Number(_0x5cf780[0x0]?.[_0x40ffdc(0x245)]||0x0)};}async[_0x3f82f6(0x1f9)](_0x47b1dd,_0x208ca0=0x1,_0x358717=0xa){const _0x20058b=_0x3f82f6,{rows:_0x3f459a,count:_0x17222b}=await this[_0x20058b(0x214)][_0x20058b(0x1e8)](_0x208ca0,_0x358717,_0x47b1dd['user']['id'],collectType_constant_1[_0x20058b(0x2a1)][_0x20058b(0x2f6)]),_0xd5d40f=await this['pptTaskEntity'][_0x20058b(0x14a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x3f459a[_0x20058b(0x1f2)](_0x267eb0=>_0x267eb0[_0x20058b(0x2de)]))}});return{'rows':_0xd5d40f,'count':_0x17222b};}async[_0x3f82f6(0x290)](_0x1cccab,_0x52da1a){const _0x3a324e=_0x3f82f6;if(!_0x1cccab['ids']||!_0x1cccab[_0x3a324e(0xbd)][_0x3a324e(0x229)])return!![];const _0x58bf2e={'id':(0x0,typeorm_1['In'])(_0x1cccab[_0x3a324e(0xbd)])};return _0x52da1a&&(_0x58bf2e['userId']=_0x52da1a),await this[_0x3a324e(0x10f)][_0x3a324e(0x162)](_0x58bf2e,{'delFlag':0x1}),await this[_0x3a324e(0x214)][_0x3a324e(0x2b5)](_0x1cccab[_0x3a324e(0xbd)],collectType_constant_1[_0x3a324e(0x2a1)][_0x3a324e(0x2f6)]),!![];}async['tts'](_0x46ea4c,_0x12b5d7){const _0x1f5320=_0x3f82f6;try{let _0x4d5ab9='';return await this[_0x1f5320(0x1fd)][_0x1f5320(0x164)](async()=>{const _0x476fb7=_0x1f5320,_0x2ba2aa=(0x0,utils_1['getReqSaasId'])(this['clsService']),{modelInfo:_0x233c04}=await this[_0x476fb7(0xb0)]['getModelByType'](model_constant_1[_0x476fb7(0x15a)][_0x476fb7(0x27d)],_0x476fb7(0x244));await this[_0x476fb7(0x24d)]({'prompt':_0x12b5d7['request'][_0x476fb7(0x116)],'user':_0x46ea4c['user'],'currentRequestModel':_0x233c04});const _0x3932a6={'curIp':(0x0,utils_1[_0x476fb7(0x289)])(_0x46ea4c),'prompt':_0x12b5d7[_0x476fb7(0xe8)][_0x476fb7(0x116)],'modelId':_0x233c04['id'],'modelType':_0x233c04[_0x476fb7(0x195)],'answer':'','model':_0x233c04[_0x476fb7(0x198)],'role':_0x476fb7(0x28b),'userId':_0x46ea4c[_0x476fb7(0x28b)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x476fb7(0x2c8)]['CHAT_TYPE'],'logType':0x1,'requestOptions':JSON[_0x476fb7(0x122)](_0x12b5d7),'saasId':_0x2ba2aa},_0xee60d4={..._0x3932a6,'role':_0x476fb7(0x1c9),'requestOptions':JSON['stringify']({'prompt':_0x12b5d7[_0x476fb7(0xe8)][_0x476fb7(0x116)],'options':{'model':_0x233c04[_0x476fb7(0x198)]}})};await this[_0x476fb7(0x1ec)][_0x476fb7(0x136)](_0x3932a6),await this['chatLogService'][_0x476fb7(0x136)](_0xee60d4),await this['userService'][_0x476fb7(0xd5)](_0x46ea4c['user']['id'],_0x233c04,_0xee60d4['id']);const _0x3346ad={'app':{'appid':_0x233c04[_0x476fb7(0xef)],'token':_0x233c04['accessToken'],'cluster':_0x476fb7(0x2a3)},'user':{'uid':String(_0x46ea4c[_0x476fb7(0x28b)]['id'])},'audio':{'voice_type':_0x476fb7(0x12a),'encoding':_0x476fb7(0x15d),'speed_ratio':0x1},'request':{'reqid':(0x0,crypto_1['randomUUID'])(),'text':_0x12b5d7[_0x476fb7(0xe8)][_0x476fb7(0x116)],'operation':'query'}},_0x4a40b1=await this['doubaoService']['tts']({'data':_0x3346ad,'headers':{'Authorization':_0x476fb7(0xee)+_0x233c04[_0x476fb7(0x237)]}}),_0x5cf3ef=chat_constant_1[_0x476fb7(0x309)][_0x476fb7(0x27d)]+'-'+_0x2ba2aa+'-'+_0x46ea4c[_0x476fb7(0x28b)]['id']+'-'+new Date()['getTime']()+_0x476fb7(0x1ab);let _0x3bc6c0=(0x0,path_1[_0x476fb7(0x2c3)])(process[_0x476fb7(0x101)](),'webroot','upload'),_0x4d8b0b='/upload';_0x4d8b0b=_0x4d8b0b+'/'+_0x5cf3ef;!(0x0,fs_1[_0x476fb7(0x1e6)])(_0x3bc6c0)&&(0x0,fs_1[_0x476fb7(0xcc)])(_0x3bc6c0,{'recursive':!![]});_0x3bc6c0=(0x0,path_1[_0x476fb7(0x2c3)])(_0x3bc6c0,_0x5cf3ef),(0x0,fs_1['writeFileSync'])(_0x3bc6c0,_0x4a40b1[_0x476fb7(0xf3)],_0x476fb7(0x100));let _0x1f88c3=process[_0x476fb7(0x302)][_0x476fb7(0x1aa)];_0x1f88c3[_0x476fb7(0x176)](_0x476fb7(0x1b9))?_0x4d5ab9=_0x1f88c3+_0x4d8b0b:_0x4d5ab9=_0x476fb7(0x211)+_0x1f88c3+_0x4d8b0b,_0xee60d4[_0x476fb7(0x21f)]=_0x4d5ab9,await this[_0x476fb7(0x1ec)][_0x476fb7(0x136)](_0xee60d4);}),_0x4d5ab9;}catch(_0x488224){console[_0x1f5320(0x26c)](_0x1f5320(0x29e),_0x488224);throw new common_1[(_0x1f5320(0x2d6))](_0x488224[_0x1f5320(0xd8)],common_1[_0x1f5320(0x11a)][_0x1f5320(0xcf)]);}}async[_0x3f82f6(0x2f0)](_0x50f6d3,_0x16f5e4,_0x19d446){const _0x5f26f3=_0x3f82f6;try{let _0xd4d9,_0x3eadae;return await this[_0x5f26f3(0x1fd)][_0x5f26f3(0x164)](async()=>{const _0x46a5ed=_0x5f26f3,_0x4440b4=(0x0,utils_1[_0x46a5ed(0xb2)])(this[_0x46a5ed(0x1ee)]),{modelInfo:_0x4f4994}=await this[_0x46a5ed(0xb0)][_0x46a5ed(0x2fa)](model_constant_1[_0x46a5ed(0x15a)]['ASR'],'AUC7419233800922468658');await this[_0x46a5ed(0x214)][_0x46a5ed(0x1c8)](_0x50f6d3[_0x46a5ed(0x28b)]['id'],_0x4f4994);const _0x45c4d0={'groupId':_0x19d446,'curIp':(0x0,utils_1[_0x46a5ed(0x289)])(_0x50f6d3),'prompt':_0x16f5e4,'modelId':_0x4f4994['id'],'modelType':_0x4f4994[_0x46a5ed(0x195)],'answer':'','model':_0x4f4994[_0x46a5ed(0x198)],'role':'user','userId':_0x50f6d3[_0x46a5ed(0x28b)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x46a5ed(0x2c8)][_0x46a5ed(0x177)],'logType':0x1,'requestOptions':JSON['stringify']({'url':_0x16f5e4}),'saasId':_0x4440b4},_0x4e4df8={..._0x45c4d0,'role':'assistant','requestOptions':JSON['stringify']({'prompt':_0x16f5e4,'options':{'model':_0x4f4994[_0x46a5ed(0x198)]}})};await this[_0x46a5ed(0x1ec)]['saveChatLog'](_0x45c4d0),await this[_0x46a5ed(0x1ec)][_0x46a5ed(0x136)](_0x4e4df8),await this[_0x46a5ed(0x214)][_0x46a5ed(0xd5)](_0x50f6d3[_0x46a5ed(0x28b)]['id'],_0x4f4994,_0x4e4df8['id']);let _0x30983e=process[_0x46a5ed(0x302)][_0x46a5ed(0x1aa)];!/^http/[_0x46a5ed(0xdc)](_0x30983e)&&(_0x30983e=_0x46a5ed(0x211)+_0x30983e);const _0x36c962={'app':{'appid':_0x4f4994[_0x46a5ed(0xef)],'token':_0x4f4994[_0x46a5ed(0x237)],'cluster':'volc_auc_common'},'user':{'uid':String(_0x50f6d3[_0x46a5ed(0x28b)]['id'])},'audio':{'url':_0x16f5e4,'format':_0x16f5e4[_0x46a5ed(0x2d9)]('.')[_0x46a5ed(0x1d4)]()},'request':{'callback':_0x30983e+'/api/chatgpt/notify-asr'}},_0x3a0a91=await this[_0x46a5ed(0x95)]['asr']({'data':_0x36c962,'headers':{'Authorization':'Bearer;'+_0x4f4994[_0x46a5ed(0x237)]}});console[_0x46a5ed(0x26c)]('---------------------ASR---------------------',_0x3a0a91),_0xd4d9=_0x3a0a91['id'],_0x3eadae=await this['chatLogService'][_0x46a5ed(0x136)](_0x4e4df8);}),new Promise(_0x415f68=>{const _0x3c4cf9=_0x5f26f3;utils_1['EE'][_0x3c4cf9(0xec)](chat_constant_1[_0x3c4cf9(0x309)][_0x3c4cf9(0x2d1)]+'-'+_0xd4d9,async _0x1bdafe=>{const _0x5aa7ba=_0x3c4cf9;_0x3eadae[_0x5aa7ba(0x21f)]=_0x1bdafe[_0x5aa7ba(0x116)],_0x3eadae=await this[_0x5aa7ba(0x1ec)][_0x5aa7ba(0x136)](_0x3eadae),_0x415f68(_0x3eadae);});});}catch(_0x23e12f){console[_0x5f26f3(0x26c)](_0x5f26f3(0x151),_0x23e12f);throw new common_1[(_0x5f26f3(0x2d6))](_0x23e12f[_0x5f26f3(0xd8)],common_1[_0x5f26f3(0x11a)][_0x5f26f3(0xcf)]);}}[_0x3f82f6(0x99)](_0x108f44){const _0x544c6c=_0x3f82f6;_0x108f44[_0x544c6c(0x264)]===0x3e8&&utils_1['EE'][_0x544c6c(0x2e7)](chat_constant_1[_0x544c6c(0x309)][_0x544c6c(0x2d1)]+'-'+_0x108f44['id'],_0x108f44);}async[_0x3f82f6(0x1c5)](_0x3bcf3c,_0x514e72,_0x2cea8b,_0x48dedb){const _0x185c84=_0x3f82f6;try{let _0x149208=await this[_0x185c84(0x1fd)]['transaction'](async()=>{const _0x456245=_0x185c84;let _0x4ee6cb=new Date()[_0x456245(0xfd)](),_0x1d045e=new Date()[_0x456245(0xfd)]();const _0x207838=_0x3bcf3c[_0x456245(0x28b)]['id'],_0x1a3216=(0x0,utils_1[_0x456245(0xb2)])(this[_0x456245(0x1ee)]),_0x398ba8=chat_constant_1[_0x456245(0x309)]['ASR']+'-'+_0x1a3216+'-'+_0x207838+'-'+new Date()[_0x456245(0xfd)]()+'.mp3',_0x26989d=await this[_0x456245(0x10b)][_0x456245(0x23b)]({'filename':_0x398ba8,'buffer':_0x48dedb['buffer']});_0x1d045e=new Date()[_0x456245(0xfd)](),console[_0x456245(0x26c)](_0x456245(0x234),_0x1d045e-_0x4ee6cb);const _0x47d6b9=await this['asr'](_0x3bcf3c,_0x26989d,_0x2cea8b?.[_0x456245(0x2cb)]?.[_0x456245(0x18a)]);_0x4ee6cb=new Date()['getTime'](),console['log'](_0x456245(0xbc),_0x4ee6cb-_0x1d045e),_0x2cea8b[_0x456245(0x2df)]=_0x47d6b9['answer'];typeof _0x2cea8b[_0x456245(0x2cb)]===_0x456245(0x206)&&(_0x2cea8b[_0x456245(0x2cb)]=JSON[_0x456245(0x28d)](_0x2cea8b[_0x456245(0x2cb)]));const _0x389e4a=await this[_0x456245(0x208)](_0x2cea8b,_0x3bcf3c,_0x514e72,![]);_0x1d045e=new Date()['getTime'](),console[_0x456245(0x26c)](_0x456245(0x17a),_0x1d045e-_0x4ee6cb);const _0x3e6a6f=await this[_0x456245(0x169)](_0x3bcf3c,{'request':{'text':_0x389e4a['answer']}});_0x389e4a['answerMp3']=_0x3e6a6f,this['chatLogService']['saveChatLog'](_0x389e4a),_0x4ee6cb=new Date()[_0x456245(0xfd)](),console[_0x456245(0x26c)](_0x456245(0xfb),_0x4ee6cb-_0x1d045e);const {prompt:_0x411147,role:_0x25ef6d,answer:_0x223eee,createdAt:_0x452bf3,conversationOptions:_0x3b188a,requestOptions:_0x340245,id:_0x458a77,answerMp3:_0x2a3891}=_0x389e4a;return{'chatId':_0x458a77,'dateTime':(0x0,utils_1[_0x456245(0x16a)])(_0x452bf3),'text':_0x25ef6d===_0x456245(0x28b)?_0x411147:_0x223eee,'textMp3':_0x2a3891,'inversion':_0x25ef6d===_0x456245(0x28b),'error':![],'conversationOptions':_0x3b188a?JSON[_0x456245(0x28d)](_0x3b188a):null,'requestOptions':_0x340245?JSON[_0x456245(0x28d)](_0x340245):null};});_0x514e72[_0x185c84(0x269)](0xc8)['json'](result_1[_0x185c84(0x2aa)]['success'](_0x149208));}catch(_0x2b8b49){throw new common_1[(_0x185c84(0x2d6))](_0x2b8b49[_0x185c84(0xd8)],common_1[_0x185c84(0x11a)][_0x185c84(0xcf)]);}}async[_0x3f82f6(0x223)](_0x587760,_0x3a4f5c){const _0x59a894=_0x3f82f6,_0x502b8b=_0x3a4f5c[_0x59a894(0x28b)]['id'],_0x276ac5=await this[_0x59a894(0xb0)][_0x59a894(0x2bf)](_0x587760);return{'remainCount':await this['userService']['getModelVipFree'](_0x502b8b,_0x276ac5),'freeCount':_0x276ac5[_0x59a894(0x19a)],'isVipFree':_0x276ac5[_0x59a894(0x19a)]==-0x1,'useIntegrate':_0x276ac5[_0x59a894(0x189)]};}async[_0x3f82f6(0x1d2)](_0x3740de){const _0x570883=_0x3f82f6,_0xe87486=_0x3740de[_0x570883(0x28b)]?.['id'],_0x4f57cb=await this[_0x570883(0xb0)][_0x570883(0x283)](model_constant_1[_0x570883(0x15a)][_0x570883(0x2c5)]),_0x3d375c=[];if(_0xe87486)for(const _0x2ddebb of _0x4f57cb){_0x3d375c[_0x570883(0x2d0)]({'id':_0x2ddebb['id'],'keyType':_0x2ddebb[_0x570883(0x131)],'model':_0x2ddebb[_0x570883(0x198)],'name':_0x2ddebb[_0x570883(0x2fd)],'modelType':_0x2ddebb[_0x570883(0x195)],'remainCount':await this[_0x570883(0x214)][_0x570883(0x193)](_0xe87486,_0x2ddebb),'freeCount':_0x2ddebb[_0x570883(0x19a)],'isVipFree':_0x2ddebb[_0x570883(0x19a)]==-0x1,'useIntegrate':_0x2ddebb[_0x570883(0x189)]});}else _0x4f57cb[_0x570883(0x207)](_0x5f174a=>{const _0x2486cb=_0x570883;_0x3d375c[_0x2486cb(0x2d0)]({'id':_0x5f174a['id'],'keyType':_0x5f174a[_0x2486cb(0x131)],'model':_0x5f174a['model'],'name':_0x5f174a[_0x2486cb(0x2fd)],'modelType':_0x5f174a[_0x2486cb(0x195)],'remainCount':0x0,'freeCount':_0x5f174a[_0x2486cb(0x19a)],'isVipFree':_0x5f174a['vipFreeNum']==-0x1,'useIntegrate':_0x5f174a[_0x2486cb(0x189)]});});return _0x3d375c;}async[_0x3f82f6(0x1ed)](_0x324c9a,_0x12af92){const _0x3173c3=_0x3f82f6,_0x1b4515=_0x324c9a[_0x3173c3(0x28b)]?.['id'];let _0x56983f=_0x12af92['keyType'];const _0x3404eb=await this[_0x3173c3(0xb0)][_0x3173c3(0x2e5)](model_constant_1[_0x3173c3(0x15a)]['VIDEO'],_0x56983f);if(!_0x3404eb)throw new common_1[(_0x3173c3(0x2d6))](_0x3173c3(0x185),common_1[_0x3173c3(0x11a)][_0x3173c3(0xcf)]);const _0x415fa3=await this[_0x3173c3(0x214)][_0x3173c3(0xd3)](_0x3404eb,_0x12af92);if(!_0x1b4515)return{'remainCount':0x0,'freeCount':_0x3404eb[_0x3173c3(0x19a)]>0x0?_0x3404eb['vipFreeNum']:_0x415fa3?.[_0x3173c3(0x19a)]||0x0,'isVipFree':_0x3404eb['vipFreeNum']==-0x1||_0x415fa3?.['vipFreeNum']==-0x1,'useIntegrate':_0x3404eb[_0x3173c3(0x189)]>0x0?_0x3404eb['deduct']:_0x415fa3?.[_0x3173c3(0x182)]||0x0,'isVipUsed':_0x3404eb['userType']?!![]:![],'userType':_0x3404eb[_0x3173c3(0x1ea)]};return{'remainCount':await this[_0x3173c3(0x214)][_0x3173c3(0xf8)](_0x1b4515,_0x3404eb,_0x12af92),'freeCount':_0x3404eb[_0x3173c3(0x19a)]>0x0?_0x3404eb[_0x3173c3(0x19a)]:_0x415fa3?.[_0x3173c3(0x19a)]||0x0,'isVipFree':_0x3404eb[_0x3173c3(0x19a)]==-0x1||_0x415fa3?.[_0x3173c3(0x19a)]==-0x1,'useIntegrate':_0x3404eb['deduct']>0x0?_0x3404eb['deduct']:_0x415fa3?.[_0x3173c3(0x182)]||0x0,'isVipUsed':_0x3404eb[_0x3173c3(0x1ea)]?!![]:![],'userType':_0x3404eb[_0x3173c3(0x1ea)]};}async[_0x3f82f6(0x300)](_0x14b7f6,_0x116044){const _0x1e5d9b=_0x3f82f6,_0x42bd07=this['userService'][_0x1e5d9b(0x1b7)](_0x14b7f6),_0x5ebbdd=_0x42bd07?.['id'];let _0x251877=_0x116044[_0x1e5d9b(0xb1)]||_0x116044[_0x1e5d9b(0x198)],_0x3e2791=_0x116044['n']||0x1;const _0x319dd1=await this[_0x1e5d9b(0xb0)][_0x1e5d9b(0x166)](model_constant_1[_0x1e5d9b(0x15a)]['DRAW'],_0x251877);if(!_0x319dd1)throw new common_1['HttpException'](_0x1e5d9b(0x185),common_1[_0x1e5d9b(0x11a)][_0x1e5d9b(0xcf)]);if(!_0x5ebbdd)return{'remainCount':0x0,'freeCount':_0x319dd1[_0x1e5d9b(0x19a)]>0x0?_0x319dd1['vipFreeNum']:0x0,'isVipFree':_0x319dd1[_0x1e5d9b(0x19a)]==-0x1,'useIntegrate':_0x319dd1[_0x1e5d9b(0x189)]>0x0?_0x319dd1[_0x1e5d9b(0x189)]:0x0,'isVipUsed':_0x319dd1[_0x1e5d9b(0x1ea)]?!![]:![],'userType':_0x319dd1['userType']};return{'remainCount':await this[_0x1e5d9b(0x214)]['getDrawModelVipFree'](_0x5ebbdd,_0x319dd1),'freeCount':_0x319dd1[_0x1e5d9b(0x19a)]>0x0?_0x319dd1[_0x1e5d9b(0x19a)]:0x0,'isVipFree':_0x319dd1['vipFreeNum']==-0x1,'useIntegrate':_0x319dd1[_0x1e5d9b(0x189)]>0x0?_0x319dd1[_0x1e5d9b(0x189)]*_0x3e2791:0x0,'isVipUsed':_0x319dd1[_0x1e5d9b(0x1ea)]?!![]:![],'userType':_0x319dd1[_0x1e5d9b(0x1ea)]};}async[_0x3f82f6(0xa9)](){const _0x1215de=_0x3f82f6,_0x147de9=await this[_0x1215de(0xb0)][_0x1215de(0x2fa)](model_constant_1[_0x1215de(0x15a)][_0x1215de(0x2f6)]),_0x499893=await this[_0x1215de(0x10f)][_0x1215de(0x2db)](_0x1215de(0x1e9));_0x499893[_0x1215de(0x229)]&&_0x499893[_0x1215de(0x207)](async _0x54c160=>{const _0x2091a1=_0x1215de;this[_0x2091a1(0xda)]({'baseURL':_0x147de9[_0x2091a1(0x216)][_0x2091a1(0xfe)],'headers':{'Authorization':_0x2091a1(0x19f)+_0x147de9[_0x2091a1(0x216)][_0x2091a1(0x237)]},'params':{'id':_0x54c160[_0x2091a1(0x22e)]}});});const _0x50436c=await this[_0x1215de(0x10f)][_0x1215de(0x2db)](_0x1215de(0xcb));_0x50436c[_0x1215de(0x229)]&&_0x50436c[_0x1215de(0x207)](async _0x473a3c=>{const _0x45ddc5=_0x1215de,_0x274f32=await this[_0x45ddc5(0x1b2)][_0x45ddc5(0x10c)]({'baseURL':_0x147de9[_0x45ddc5(0x216)][_0x45ddc5(0xfe)],'headers':{'Authorization':'Beare\x20'+_0x147de9['modelInfo']['accessToken']},'params':{'id':_0x473a3c[_0x45ddc5(0x22e)],'type':_0x45ddc5(0x123)}});_0x274f32['code']=='200'&&_0x274f32['data'][_0x45ddc5(0xe4)]&&(_0x473a3c[_0x45ddc5(0xc1)]=_0x274f32[_0x45ddc5(0xf3)][_0x45ddc5(0xe4)],await this[_0x45ddc5(0x10f)][_0x45ddc5(0x162)]({'id':_0x473a3c['id']},{'pdfDownUrl':_0x473a3c[_0x45ddc5(0xc1)]}));});const _0x251391=await this[_0x1215de(0x10f)][_0x1215de(0x2db)](_0x1215de(0x29b));_0x251391[_0x1215de(0x229)]&&_0x251391['forEach'](async _0x43b29d=>{const _0xe5e1c4=_0x1215de,_0x3facce=await this[_0xe5e1c4(0x1b2)][_0xe5e1c4(0x10c)]({'baseURL':_0x147de9[_0xe5e1c4(0x216)][_0xe5e1c4(0xfe)],'headers':{'Authorization':_0xe5e1c4(0x19f)+_0x147de9[_0xe5e1c4(0x216)][_0xe5e1c4(0x237)]},'params':{'id':_0x43b29d[_0xe5e1c4(0x22e)],'type':_0xe5e1c4(0x16e)}});_0x3facce[_0xe5e1c4(0x264)]==_0xe5e1c4(0x292)&&_0x3facce[_0xe5e1c4(0xf3)][_0xe5e1c4(0xe4)]&&(_0x43b29d[_0xe5e1c4(0x111)]=_0x3facce[_0xe5e1c4(0xf3)][_0xe5e1c4(0xe4)],await this['pptTaskEntity'][_0xe5e1c4(0x162)]({'id':_0x43b29d['id']},{'pngDownUrl':_0x43b29d[_0xe5e1c4(0x111)]}));});try{const _0x1fe630=store_2[_0x1215de(0x1fa)]['pptTimeoutMs']||0x5,_0x5c58ef=[{'status':0x1,'type':ppt_constant_1['EPPTTaskType'][_0x1215de(0x130)],'updatedAt':(0x0,typeorm_1['LessThan'])(new Date(Date[_0x1215de(0x9b)]()-_0x1fe630*0x3c*0x3e8))}],_0xc6f6f1=await this[_0x1215de(0x10f)]['find']({'where':_0x5c58ef});_0xc6f6f1[_0x1215de(0x207)](async _0x1508cb=>{const _0x36734f=_0x1215de;_0x1508cb[_0x36734f(0x2ca)]=_0x36734f(0x2ae),_0x1508cb[_0x36734f(0x269)]=0x3,this['pptTaskEntity']['save'](_0x1508cb),this[_0x36734f(0x214)][_0x36734f(0x2fe)](_0x1508cb['userId'],_0x1508cb['id'],_0x1508cb['type'],!![]);});}catch(_0x446958){common_1[_0x1215de(0x217)][_0x1215de(0x2fb)](_0x446958);}}};ChatgptService=__decorate([(0x0,common_1[_0x3f82f6(0x183)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(pptTask_entity_1[_0x3f82f6(0x2b9)])),__metadata(_0x3f82f6(0xea),[typeorm_1['Repository'],nestjs_cls_1[_0x3f82f6(0x108)],user_service_1['UserService'],file_service_1[_0x3f82f6(0x2fc)],gpts_service_1['GptsService'],yooPPT_service_1['YooPPTService'],doubao_service_1['DoubaoService'],models_service_1[_0x3f82f6(0x2f8)],chatLog_service_1[_0x3f82f6(0x2f7)],lumaTask_service_1['LumaTaskService'],runwayTask_service_1[_0x3f82f6(0x107)],klingTask_service_1[_0x3f82f6(0x1a3)],sunoTask_service_1['SunoTaskService'],veoTask_service_1[_0x3f82f6(0x26f)],badwords_service_1[_0x3f82f6(0x282)],autoreply_service_1[_0x3f82f6(0x1fe)],chatGroup_service_1[_0x3f82f6(0x260)],globalConfig_service_1[_0x3f82f6(0x159)],typeorm_1[_0x3f82f6(0x18d)],mindTask_service_1[_0x3f82f6(0x1e5)]])],ChatgptService),exports[_0x3f82f6(0x1d1)]=ChatgptService;function _0x32c0(_0x41c1e8,_0x506c1f){const _0x2f4dc5=_0x2f4d();return _0x32c0=function(_0x32c027,_0x2db333){_0x32c027=_0x32c027-0x93;let _0x5141be=_0x2f4dc5[_0x32c027];return _0x5141be;},_0x32c0(_0x41c1e8,_0x506c1f);}function _0x2f4d(){const _0x48b1b3=['../../common/constants/ppt.constant','veo2','form-data','TTS','upload','gpt-3','image','object','BadwordsService','getModelsByModelType','RUNWAYVIDEO','beforeChatProcess','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Please\x20check\x20the\x20back-end\x20console','abort','getClientIp','sunoMusicTask','user','musicLyricsVipFree','parse','returnDrawDetail','../../common/constants/redisKey.constant','pptDel','setData','200','32k','uploadFile','pptx','set','binary_data_base64','DRAW','syncLumaTask','slideNumber','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20png_down_url\x20is\x20null','modelConfig','key','---------------------TTS\x20ERROR---------------------','promptTokens','6JnyvTY','UserCollectType','getOwnPropertyDescriptor','volcano_tts','complex','updated_at','transcriptions','process_url','floor','getCurrentModelByChatGroupId','Result','message_id','schoolPicture','unifiedFormattingResponse','timeout','MUSIC','audio','pptOnlineEditor','@keyv/redis','reasoning_content','indexOf','uncollectByRelIds','suno-v3','getCurrentModel','modelOptions','PPTTaskEntity','files','CVProcess','aspect_ratio','progress','klingChatVideo','getModelById','mind','then','lumaChatVideo','join','chatRealTime','VIDEO','\x0a\x20\x20\x20\x20\x20\x20','abortController','DeductionKey','b64_json','stateDesc','options','key:\x20','create','@nestjs/typeorm','ratio','push','ASR','finish_reason','refundBalance4Draw','pptResult','setHeader','HttpException','checkBadWords','kling-draw-task','split','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.state_desc\x20as\x20stateDesc,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.editor_url\x20as\x20editorUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.images,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.preview_url\x20as\x20previewUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pdf_down_url\x20as\x20pdfDownUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.png_down_url\x20as\x20pngDownUrl\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','query','chatDraw','axios','relId','prompt','completions','pptReCover','pptCreate','绘制图片失败，请稍后试试吧！','delta','getModelByKeyType','chatGroupService','emit','fastgpt','deductBalance4Video','response_format','../../common/constants/balance.constant','findAndCount','musicConfig','remove\x20file\x20','443032YDaznv','asr','getUuid','refundBalance4Video','schoolLogo','getConfigByKeys','response','PPT','ChatLogService','ModelsService','response.length','getModelByType','error','FileService','modelName','debuctBalance4PPT','write','getDrawFree','__esModule','env','from','endTime','originTaskId','PAINT_TYPE','\x20--aspect_ratio\x20','thirdId','EChatType','result','视频生成失败，没有响应','gen2','../chatLog/chatLog.service','task_result','webroot','isSuper','doubaoService','/api/chatLog/notify-Suno-lyrics?id=','size','conversationOptions','notifyAsr','Cache-Control','now','gptsService','Invalid\x20user\x20information','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','aac','completed','runwayVideoTask','chatLogId','pptNote','videos','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','append','当前模型不是聊天模型','模型秘钥错误或模型余额不足','batchPPTResult','validateBeforeDraw','usage','pptCreateFile','veoTaskService','openaiModel3MaxTokensRes','openAi','modelsService','model_name','getReqSaasId','语音转换失败','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','服务异常、请重新试试吧！！！','mindTaskService','content','advisor','type','file','saveMindTask','[耗时打印]语音转文字耗时：','ids','redis://','CVSync2AsyncSubmitTask','图片生成失败','pdf_down_url','Incorrect\x20API\x20key\x20provided','sendMessageFromZhipu','../api/doubao.service','getRandomKey','includes','images','GET','curIp',',\x20错误:\x20','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20pdf_down_url\x20is\x20null','mkdirSync','createReadStream','1408920qhXhFY','BAD_REQUEST','json','abs','saveVoiceChat','getVideoConfig','chatMusic','deductBalance4Chat','https://api.moonshot.cn/v1','seed','message','本次调用:\x20','asyncPPTProgress',',\x20模型名称:\x20','test','runwayChatVideo','musicLyrics','clauda','totalTokens','绘制图片失败，此次绘画被拒绝了！','----------Doubao---------','application/octet-stream','download_url','removeSpecialCharacters','未配置语音模型或语音模型key，请配置并启用语音功能！','theme','request','../api/veoTask.service','design:paramtypes','buildSystemMessage','once','pptCreateThesis','Bearer;','appid','../globalConfig/globalConfig.service','Content-type','i2v','data','1561245MrExdG','bad\x20response\x20status\x20code\x20307','default','VeoVideo','getVideoModelVipFree','configChatGptApi','fanyi\x20mj-associate','[耗时打印]文字转语音耗时：','findOne','getTime','proxyUrl','removeFile','base64','cwd','task_id','getGroupInfoFromId','openaiModel4MaxTokens32kRes','Content-Type','choices','RunwayTaskService','ClsService','path','jimeng_vgfm_i2v_l20','fileService','pptDownload','defaultBaseUrl','--------------------------------------------------------','pptTaskEntity','-------------openAiErrHandler--------------','png_down_url','api','initOpenAi','./spark','../autoreply/autoreply.service','text','end','getHeaders','\x20image_end_url\x20','HttpStatus','answerMp3','t2v','EChangeType','image-','contents','Bearer\x20','pptRecPage','stringify','pdf','THESIS','../models/models.service','buildOptions','openaiModel4MaxTokens','\x20model:\x20','gpt-4','zh_female_vv_mars_bigtts','function','视频生成失败','video_url','preset','yooTaskId','CREATE','keyType','同步PPT生成任务进度失败！','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','EMusicTaskType','role','saveChatLog','conversationId','checkAutoReply','file-extract','style','user_prompt','video-task','is_end','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','pptUserType','w2t','openAiErrHandler','openaiBaseUrl','kimiUpload','modelSubType','400\x20error','JMDraw','LYRICS','klingVideoTask','title','find','../api/lumaTask.service','16k','gomaxai-default-key','downUrl','data:\x20','systemPreMessage','---------------------ASRError---------------------','当前模型key余额已耗尽','原始任务不存在！','musicUploadVipFree','pleader','lumaVideoTask','../mindTask/mindTask.service','pptOutline','GlobalConfigService','EModelType','ChatGPTAPI','../../common/result','mp3','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','Unauthorized','completionTokens','REDIS_USER','update','modelId','transaction','typeorm','getModelByKeyModel','https://api.openai.com','Error\x20in\x20pptConfig:','tts','formatDate','pptEditorVipFree','musicUploadPrice','无法从URL获取图片:\x20','png','gomaxai-chatlog','\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','SunoMusicTask','RECOVER','failed','validateBalance4Draw','configDoubaoApi','startsWith','CHAT_TYPE','当前模型key余额已耗尽，请充值！','grok','[耗时打印]文字对话耗时：','signal','cn-north-1','deductBalance4Draw','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','jmengvideo-task','parentMessageId','VIP_FREE','price','Injectable','stream','模型类型不存在','模型秘钥错误或模型金额不足，请联系管理员！','key\x20%s,\x20proxy\x20%s','ADDNOTES','deduct','groupId','chatTask','messageStore','Connection','REDIS_PASSWORD','catalogs','importDynamic','VipFree','openaiModel3MaxTokens','getModelVipFree','chatgpt','modelType','appId','UPLOAD','model','make_instrumental','vipFreeNum','coverId','gomaxAiStore','draw\x20paompt\x20info\x20<======*******======>\x20','jmengVideoTask','Beare\x20','saveUseLog','extend','editorUrl','KLingTaskService','musicCreatePrice','errMsg','160318TopOZc','author','Catch\x20Error\x20','userId','GOMAXAI_HOST','.mp3','fileInfo','speech','./baidu','sunoTaskService','\x20image_url\x20','defineProperty','pptService','../../common/utils','music','当前请求已过载、请稍等会儿再试试吧！','validateUserType','getUserInfoFromHeader','mergeCollectData','http','checkUserStatus','veoVideoTask','POST','/api/v3','pptChangeTheme','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','resolve','runwayTaskService','../../common/constants/errorMessage.constant','chat','state','voiceChat','url','debuctBalance4Muisc','validateBalance4Chat','assistant','succeed','mindTaskId','lumaTaskService','738456YgueXB','pptStructure','images_url','506517TPaZyO','ChatgptService','getVideoModelFree','DrawService','pop','systemMessage','color','detail','last_image','FILE','creat','created_at','arrayBuffer','autoreplyService','\x20key\x20->\x20','https://ark.cn-beijing.volces.com','requestFromGpt','900065fWaSjI','../../common/constants/collectType.constant','KLVIDEO','keyv','MindTaskService','existsSync','whisper-1','collectPage','select\x20*\x20from\x20ppt_task\x20where\x20\x20(status<>2\x20or\x20status\x20is\x20null\x20)and\x20yoo_task_id\x20is\x20not\x20null','userType','./../user/user.service','chatLogService','getVideoFree','clsService','musicCreate','gpt_description_prompt','isCustom','map','OTHER','buildMessageFromParentMessageId','updateLastMessage','pptEditor','toLowerCase','CHAT','pptCollectPage','PPTConfig','no-cache','video','connection','AutoreplyService','image_urls','parseAndSaveVideo','lockKey','save','musicUserType','toString','school','string','forEach','chatProcess','debug','getRandomAudioKey','validateBalance4Video','../api/klingTask.service','previewUrl','\x20--expand_prompt\x20','globalConfigService','REDIS_PORT','https://','/v1','../../common/constants/music.constant','userService','__decorate','modelInfo','Logger','openai-draw','get','getImageStreamFromUrl','resCover','OpenAiErrorCodeMessage','../../common/store','slideType','answer','gpts','slice','unlink','getUserModelFree','SUCCEEDED','createAPI','当前模型key已被封禁','可翻译成其他语言。','.png','length','image_url','klingTaskService','chatMuiscTask','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','yoo_task_id','pptPage','pptCreatePrice','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','chatMusicLyrics','trim','[耗时打印]保存文件耗时：','getModelInfoByKeyType','audio2text\x20','accessToken','pptCreateVipFree','badwordsService','fileUrl','upload2Local','crypto','pptConfig','PAYMENT_REQUIRED','prompt\x20','statusCode','saveGptsUseLog','transition','metadata','Speech_Synthesis7418877984234656063','count','getRandomKeyForKeyType','JMVIDEO','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','system','PPT\x20任务不存在！','pptCover','text/event-stream','validateBeforeChat','application/octet-stream;\x20charset=utf-8','tts-1','preview_url','enhance_prompt','listAssetsBychatLogIds','sunoMusicId','task_status','chatMusicUpload','notify_hook','subTitle','KLDraw','msg','openaiModel3MaxTokens16k','EPPTTaskType','configKimiApi','Price','music-task','toISOString','ChatGroupService','ADDPAGE','sendMessageFromSpark','PPT不存在','code','chunked','responseMessageWithThink','NineStore','think','status','Service','getKeyFree','log','REDIS_HOST','2022-08-31','VeoTaskService','responseMessage','addOneIfOdd','formatModelToken','fontName','musicCreateVipFree','all','getModelConfig','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','sendMessage','THEME'];_0x2f4d=function(){return _0x48b1b3;};return _0x2f4d();}