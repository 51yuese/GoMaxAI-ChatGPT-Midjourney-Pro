'use strict';function _0x3268(_0x51cef8,_0x288251){const _0x376718=_0x3767();return _0x3268=function(_0x326846,_0x5ea18a){_0x326846=_0x326846-0x1c5;let _0x430fec=_0x376718[_0x326846];return _0x430fec;},_0x3268(_0x51cef8,_0x288251);}const _0x10c797=_0x3268;(function(_0x24dd73,_0x2cc9ef){const _0x5f12c6=_0x3268,_0x27d9a9=_0x24dd73();while(!![]){try{const _0x43568a=parseInt(_0x5f12c6(0x368))/0x1+-parseInt(_0x5f12c6(0x287))/0x2*(parseInt(_0x5f12c6(0x39a))/0x3)+-parseInt(_0x5f12c6(0x2f1))/0x4*(-parseInt(_0x5f12c6(0x37d))/0x5)+parseInt(_0x5f12c6(0x218))/0x6*(-parseInt(_0x5f12c6(0x420))/0x7)+-parseInt(_0x5f12c6(0x1e2))/0x8+parseInt(_0x5f12c6(0x21a))/0x9+parseInt(_0x5f12c6(0x389))/0xa*(parseInt(_0x5f12c6(0x440))/0xb);if(_0x43568a===_0x2cc9ef)break;else _0x27d9a9['push'](_0x27d9a9['shift']());}catch(_0xc7cc6a){_0x27d9a9['push'](_0x27d9a9['shift']());}}}(_0x3767,0x7225b));function _0x3767(){const _0x2cd84c=['准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','pptOutline','GptsService','getClientIp','@keyv/redis','JMVIDEO','lockKey','modelName','userId','ids','validateUserType','image_url','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','YooPPTService','listByGroupId','THEME','axios','removeFile','__esModule','last_image','VeoVideo','status','set','Bearer;','buildOptions','#\x20你是一名具备上下文感知能力的对话辅助助手，需在完成用户问题解答后，自动生成3个相关推荐问题。请严格遵循以下规则执行：\x0a1.\x20**先精准解答用户问题**：基于用户当前提问，提供逻辑清晰、内容准确的主回复，确保覆盖核心需求，语言通俗易懂，不遗漏关键信息。\x0a2.\x20**再生成3个推荐问题**：完全基于你给出的主回复内容创作，需满足：\x0a\x20\x20\x20-\x20与主回复主题高度相关，不偏离当前对话方向，避免提出主回复中未涉及的无关话题；\x0a\x20\x20\x20-\x20符合用户潜在追问逻辑（比如主回复提到“两种实现方式”，可追问某一种方式的细节）；\x0a\x20\x20\x20-\x20每个问题字数控制在15-30字之间，表述简洁明确，无语法错误；\x0a#\x20注意请严格按照以下格式输出，不要遗漏任何标记：\x0a1.\x203个推荐问题，必须用<sug>和</sug>包裹\x0a3.\x20每个推荐问题单独一行，不要编号\x0a示例输出：\x0a这是对当前问题的详细回答内容，\x0a可以包含多行文本和各种标点符号。\x0a即使内容中包含特殊符号也不会影响解析。\x0a<sug>\x0a如何进一步优化这个方案？\x0a这个方法有什么潜在的局限性？\x0a实际应用中需要注意哪些细节？\x0a</sug>','map','/api/chatgpt/notify-asr','validateBalance4Chat','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','globalConfigService','clsService','-------------------NanoResult----------','getRandomAudioKey','promptTokens','--------------------------------------------------------','toLowerCase','VIDEO','split','b64_json','finish_reason','modelType','fileInfo','update','endTime','7dtoiPn','../file/file.service','getModelByType','\x20key\x20->\x20','./../user/user.service','KLVIDEO','VipFree','luma-video','choices','../../common/constants/collectType.constant','Result','then','videos','createReadStream','decorate','kimiUpload','voiceChat','proxyUrl','veoVideoTask','ClsService','file-extract','unlink','MindTaskService','openaiModel3MaxTokens16k','当前模型key余额已耗尽','detail','\x20image_end_url\x20','CHAT_TYPE','debuctBalance4Muisc','https://api.moonshot.cn/v1','klingTaskService','视频生成失败，没有响应','4529173TMDIAY','DoubaoService','musicUpload','user','LessThan','UserService','pathname','completionTokens','push','fileUrl','musicUploadPrice','apiKey','create','openaiModel3MaxTokensRes','test','success','startsWith','16k','SunoMusicTask','usage','audio2text\x20','pptCreatePrice','https://api.openai.com','yooTaskId','isSuper','@nestjs/typeorm','../mindTask/mindTask.service','pptOnlineEditor','images_url','succeed','responseMessage','school','json','./spark','JMDraw','Error\x20in\x20pptConfig:','whisper-1','creat','openaiBaseUrl','runwayTaskService','GOMAXAI_HOST','failed','uncollectByRelIds','base64','result','png','图片生成失败','lumaTaskService','pptx','answer','------------------ChatDrawEnd---------------','saveVoiceChat','getRandomKeyForKeyType','length','task_status','path','jimeng_vgfm_i2v_l20','modelSubType','MUSIC','audio','mp3','model','suno-v3','FILE','../api/yooPPT.service','内容提取失败','form-data','code','chat','unifiedFormattingResponse','cwd','musicCreatePrice','runwayChatVideo','completions','replace','data','Injectable','musicCreate','title','veo2','2323800RyrQmh','music','KLingTaskService','key','metadata','state_description','modelsService','../globalConfig/globalConfig.service','getModelById','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20pdf_down_url\x20is\x20null','isCustom','gomaxai-chatlog','fileService','Cache-Control','pptCreateFile','sendMessageFromBaidu','pptEditor','openai','jmengVideoTask','REDIS_HOST','RUNWAYVIDEO','price','../../common/constants/chat.constant','getTime','Content-Type','getConfigByKeys','value','asyncPPTProgress','url','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','validateBeforeChat','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','openAiErrHandler','--------------VEO\x20视频任务开始------------------','SUCCEEDED','object','updated_at','../gpts/gpts.service','default','pdf_down_url','pptCollectPage','getOwnPropertyDescriptor','pptNote','InjectRepository','webroot','DeductionKey','---------------------TTS\x20ERROR---------------------','[耗时打印]保存文件耗时：','sendMessage','__metadata','getAppById','tts','saveUseLog','fontName','2706522aHasTB','PAYMENT_REQUIRED','6975468oHlSgJ','HttpStatus','chatMusicUpload','previewUrl','resCover','chatLogId','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','assistant','style','chatLogService','模型秘钥错误或模型余额不足','pleader','getUserInfoFromHeader','configDoubaoApi','sendMessageFromZhipu','slideType','crypto','deduct','parseAndSaveVideo','parentMessageId','../autoreply/autoreply.service','tts-1','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','提供了错误的模型秘钥','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','[耗时打印]文字对话耗时：','notifyAsr','pptTimeoutMs','notify_hook','initOpenAi','Beare\x20','syncLumaTask','totalTokens','../../common/utils','maskEmail','PPT','ratio','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%','TTS','onModuleInit','__param','key:\x20','getUuid','VeoTaskService','userType','/upload','ADDNOTES','save','音乐生成失败，没有响应','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','getKeyFree','images','task_id','pptPage','transition','message','compileNetwork','Service','POST','../api/veoTask.service','/api/chatLog/notify-Suno-lyrics?id=','chatGroupService','musicCreateVipFree','deductBalance4Video','role','refundBalance4Draw','reasoning_content','pptDownload','validateBalance4Draw','cn-north-1','gpts','slice','log','ADDPAGE','Invalid\x20user\x20information','defineProperty','400\x20error','chatDrawAsync','AutoreplyService','klingVideoTask','EChangeType','jmengImageTaskAsync','error','Price','未配置语音模型或语音模型key，请配置并启用语音功能！','openAi','badwordsService','response_format','服务异常、请重新试试吧！！！','all','[耗时打印]文字转语音耗时：','author','upload2Local','getHeaders','mergeCollectData','complex','appId','validateBeforeDraw','modelConfig','vipFreeNum','pptService','config','LYRICS','-------------------askLogDTOError--------------------','query','baseURL','\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../badwords/badwords.service','formatModelToken','14422qyCIyt','png_down_url','is_end','system','\x0a\x20\x20\x20\x20\x20\x20','post','chatMuiscTask','includes','text','errMsg','debug','ChatgptService','contents','relId','resolve','arrayBuffer','children','image_urls','gomaxAiStore','upload','image-','pptUserType','../../common/constants/ppt.constant','lumaVideoTask','Speech_Synthesis7418877984234656063','Please\x20check\x20the\x20back-end\x20console','think','defaultBaseUrl','---------------------ASRError---------------------','setHeader','getUserModelFree','checkUserStatus','klingImageTask','toString','extend','response.length','Content-type','accessToken','getImageStreamFromUrl','binary_data_base64','\x20--expand_prompt\x20','musicUploadVipFree','response','pptAddPage','groupId','../chatLog/chatLog.service','pdf','findOne','nestjs-cls','floor','env','writeFileSync','pptx_url','pptCreateVipFree','systemPreMessage','preview_url','image','doubaoService','Download','../../common/store','remove\x20file\x20','Catch\x20Error\x20','Incorrect\x20API\x20key\x20provided','video','getGroupInfoFromId',',\x20模型名称:\x20','无法从URL获取图片:\x20','musicLyrics','X-Accel-Buffering','state','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','forEach','200','refundBalance4Video','text/event-stream','当前模型key已被封禁','existsSync','slideNumber','lyrics','----------Doubao---------','append','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','sendMessageFromFastgpt','curIp','options','sunoMusicTask','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','emit','progressUrl','w2t','editorUrl','draw\x20paompt\x20info\x20<======*******======>\x20','size','collectPage','sendMessageFromSpark','formatDate','PAINT_TYPE','\x20image_url\x20','openaiModel4MaxTokensRes','BAD_REQUEST','../../common/constants/redisKey.constant','prompt','string','@nestjs/common','当前请求已过载、请稍等会儿再试试吧！','379216JbgtoP','THESIS','PPT\x20任务不存在！','BadwordsService','getModelsByModelType','/api/chatLog/notify-Suno-upload?id=','RunwayTaskService','video_url','downUrl','responseResult','pptReCover','./store','ASR','buildMessageFromParentMessageId','Unauthorized','本次调用:\x20','-------------openAiErrHandler--------------','stringify','GlobalConfigService','file','getReqSaasId','openaiModel4MaxTokens32k','delta','catalogs','OTHER','绘制图片失败，此次绘画被拒绝了！','./baidu','未获取到模型基础配置，请前往后台配置并启用','saveMindTask','NineStore','saveChatLog','signal','lumaChatVideo','DrawService','typeorm','__decorate','openaiModel3MaxTokens16kRes','pptCover','color','zh_female_vv_mars_bigtts','conversationId','https://','pptOutlineVipFree','connection','count','OpenAiErrorCodeMessage','userService','Like','schoolLogo','getCurrentModel','customSystemMessage','FileService','modelInfo','jmengvideo-task','EChatType','语音转文本失败','statusCode','checkAutoReply','toISOString','GET','validateBalance4Video','gpt-4','completed','remove\x20file\x20%s\x20success','EMusicTaskType','returnDrawDetail','getVideoFree','chatDraw','make_instrumental','configChatGptApi','getRandomKey','模型类型不存在','Draw','chunked','可翻译成其他语言。','REDIS_PASSWORD','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','join','catch','design:paramtypes','../api/sunoTask.service','keyType','当前模型不是聊天模型','model_name','DESC','download_url','phone','yoo_task_id','kling-video_std_5','saveGptsUseLog','当前模型key余额已耗尽，请充值！','get','buffer','getDrawModelVipFree','api','jmeng-draw-task','.png','veoTaskService','files','../api/doubao.service','sunoMusicId','request','application/octet-stream;\x20charset=utf-8','importDynamic','STRUCTURE','requestFromGpt','message_id','seed','CHAT','pptStructure','function','getModelByKeyType','configKimiApi','setData','getModelChild','------------Nano-error-----------','------------------ChatDrawPost---------------','removeSpecialCharacters','.mp3','655821wMOeGj','UserCollectType','musicUserType','stateDesc','pptCreateThesis','email','\x20--aspect_ratio\x20','schoolPicture','uploadFile','CVProcess','getVideoModelVipFree','mind','视频生成失败','EModelType','indexOf','pptAddNote','end','openaiModel4MaxTokens','/v1','width','trim','5GOfaoc','messageStore','pptChangeTheme','mindTaskService','completionParams','process_url','chatMusicLyrics','createAPI','addOneIfOdd','/v1/images/edits','pageCount','originTaskId','10MiOlPo','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20png_down_url\x20is\x20null','/v1/images/generations','------------------ChatDrawStart---------------','listTaskByIds','task_result','aspect_ratio','abort','NanoDraw','content','Logger','now','fanyi\x20mj-associate','runwayVideoTask','\x20model:\x20','findAndCount','pptEditorVipFree','303xufaRR','modelOptions','2022-08-31','pptTaskEntity','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','musicLyricsVipFree','语音转换失败','../../common/result','deductBalance4Draw','gen2','responseMessageWithThink','pptEditorPrice','KLDraw','write','getModelConfig','Access-Control-Allow-Origin','data:\x20','conversationOptions','close','绘制图片失败，请稍后试试吧！','模型秘钥错误或模型金额不足，请联系管理员！','ChatLogService','stream','../api/runwayTask.service','HttpException','Bearer\x20','原始任务不存在！','REDIS_USER','parse','UPLOAD','abs','jmengImageTask','systemMessage','同步PPT生成任务进度失败！','LumaTaskService','gptsService','checkBadWords','advisor','sunoTaskService','asr','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','mkdirSync','theme','msg','deductBalance4Chat','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','buildSystemMessage','coverId','PPTTaskEntity','image-size','video-task','volcano_tts','prompt\x20','appid','pptCreate','gpt_description_prompt','CVSync2AsyncSubmitTask','getModelInfoByKeyType','EPPTTaskType','preset','subTitle','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','transaction','pptOutlinePrice','updateLastMessage','speech','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','PPT不存在','fastgpt','chatTask','debuctBalance4PPT','gomaxai-default-key','abortController','batchPPTResult','volc_auc_common','CREATE','height','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.state_desc\x20as\x20stateDesc,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.editor_url\x20as\x20editorUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.images,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.preview_url\x20as\x20previewUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pdf_down_url\x20as\x20pdfDownUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.png_down_url\x20as\x20pngDownUrl\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','aac','autoreplyService','musicConfig','DRAW','../chatGroup/chatGroup.service','type','application/octet-stream','pptRecPage','thirdId','find','from'];_0x3767=function(){return _0x2cd84c;};return _0x3767();}var __decorate=this&&this[_0x10c797(0x314)]||function(_0x4cb243,_0x3faef4,_0x2769ea,_0x57992c){const _0xb003c0=_0x10c797;var _0x2f7ca5=arguments[_0xb003c0(0x1c7)],_0x4969f5=_0x2f7ca5<0x3?_0x3faef4:_0x57992c===null?_0x57992c=Object[_0xb003c0(0x20b)](_0x3faef4,_0x2769ea):_0x57992c,_0x4ebd22;if(typeof Reflect===_0xb003c0(0x205)&&typeof Reflect[_0xb003c0(0x42e)]===_0xb003c0(0x35f))_0x4969f5=Reflect[_0xb003c0(0x42e)](_0x4cb243,_0x3faef4,_0x2769ea,_0x57992c);else{for(var _0x41cd80=_0x4cb243[_0xb003c0(0x1c7)]-0x1;_0x41cd80>=0x0;_0x41cd80--)if(_0x4ebd22=_0x4cb243[_0x41cd80])_0x4969f5=(_0x2f7ca5<0x3?_0x4ebd22(_0x4969f5):_0x2f7ca5>0x3?_0x4ebd22(_0x3faef4,_0x2769ea,_0x4969f5):_0x4ebd22(_0x3faef4,_0x2769ea))||_0x4969f5;}return _0x2f7ca5>0x3&&_0x4969f5&&Object['defineProperty'](_0x3faef4,_0x2769ea,_0x4969f5),_0x4969f5;},__metadata=this&&this[_0x10c797(0x213)]||function(_0x1dda2a,_0x3dd04c){const _0xe5a658=_0x10c797;if(typeof Reflect===_0xe5a658(0x205)&&typeof Reflect[_0xe5a658(0x1e6)]==='function')return Reflect[_0xe5a658(0x1e6)](_0x1dda2a,_0x3dd04c);},__param=this&&this[_0x10c797(0x242)]||function(_0xb2af88,_0x4bf13e){return function(_0x379db4,_0x34d06d){_0x4bf13e(_0x379db4,_0x34d06d,_0xb2af88);};};Object[_0x10c797(0x265)](exports,_0x10c797(0x405),{'value':!![]}),exports[_0x10c797(0x292)]=void 0x0;const file_service_1=require(_0x10c797(0x421)),user_service_1=require(_0x10c797(0x424)),openai_1=require(_0x10c797(0x1f3)),common_1=require(_0x10c797(0x2ef)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x10c797(0x23b)),axios_1=require(_0x10c797(0x403)),balance_constant_1=require('../../common/constants/balance.constant'),chatLog_service_1=require(_0x10c797(0x2b4)),uuid=require('uuid'),fs=require('fs'),typeorm_1=require(_0x10c797(0x313)),typeorm_2=require(_0x10c797(0x459)),badwords_service_1=require(_0x10c797(0x285)),autoreply_service_1=require(_0x10c797(0x22e)),globalConfig_service_1=require(_0x10c797(0x1e9)),chatGroup_service_1=require(_0x10c797(0x3ec)),models_service_1=require('../models/models.service'),baidu_1=require(_0x10c797(0x30b)),helper_1=require('./helper'),store_1=require(_0x10c797(0x2fc)),zhipu_1=require('./zhipu'),spark_1=require(_0x10c797(0x461)),model_constant_1=require('../../common/constants/model.constant'),fs_1=require('fs'),path_1=require(_0x10c797(0x1c9)),gpts_service_1=require(_0x10c797(0x207)),yooPPT_service_1=require(_0x10c797(0x1d2)),pptTask_entity_1=require('./entity/pptTask.entity'),ppt_constant_1=require(_0x10c797(0x29d)),lumaTask_service_1=require('../api/lumaTask.service'),nestjs_cls_1=require(_0x10c797(0x2b7)),doubao_service_1=require(_0x10c797(0x354)),crypto_1=require(_0x10c797(0x22a)),chat_constant_1=require(_0x10c797(0x1f8)),result_1=require(_0x10c797(0x3a1)),runwayTask_service_1=require(_0x10c797(0x3b1)),klingTask_service_1=require('../api/klingTask.service'),sunoTask_service_1=require(_0x10c797(0x341)),mindTask_service_1=require(_0x10c797(0x45a)),collectType_constant_1=require(_0x10c797(0x429)),redisKey_constant_1=require(_0x10c797(0x2ec)),store_2=require(_0x10c797(0x2c2)),music_constant_1=require('../../common/constants/music.constant'),openapi_1=require('@volcengine/openapi'),veoTask_service_1=require(_0x10c797(0x255)),FormData=require(_0x10c797(0x1d4)),image_size_1=require(_0x10c797(0x3cb));let ChatgptService=class ChatgptService{constructor(_0x142b7d,_0x4f9391,_0x6e02af,_0x4bf6b0,_0xe31a51,_0x379067,_0x52848a,_0x4009a4,_0x5d40bf,_0x1eeebd,_0x1684f7,_0xaf7614,_0x1eea4e,_0x1fe55,_0x3f8830,_0x5670fe,_0x496329,_0x58b0f1,_0x8826a2,_0xc185d3){const _0x190e29=_0x10c797;this[_0x190e29(0x39d)]=_0x142b7d,this[_0x190e29(0x412)]=_0x4f9391,this[_0x190e29(0x31f)]=_0x6e02af,this['fileService']=_0x4bf6b0,this[_0x190e29(0x3bd)]=_0xe31a51,this['pptService']=_0x379067,this['doubaoService']=_0x52848a,this[_0x190e29(0x1e8)]=_0x4009a4,this[_0x190e29(0x223)]=_0x5d40bf,this['lumaTaskService']=_0x1eeebd,this[_0x190e29(0x467)]=_0x1684f7,this[_0x190e29(0x43e)]=_0xaf7614,this['sunoTaskService']=_0x1eea4e,this[_0x190e29(0x352)]=_0x1fe55,this[_0x190e29(0x270)]=_0x3f8830,this[_0x190e29(0x3e9)]=_0x5670fe,this['chatGroupService']=_0x496329,this[_0x190e29(0x411)]=_0x58b0f1,this[_0x190e29(0x31c)]=_0x8826a2,this[_0x190e29(0x380)]=_0xc185d3,this[_0x190e29(0x2a2)]=_0x190e29(0x456),this[_0x190e29(0x37e)]=null,this[_0x190e29(0x299)]=null,this[_0x190e29(0x404)]=_0x4cbeb1=>{const _0x2f9c3e=_0x190e29;return fs[_0x2f9c3e(0x435)](_0x4cbeb1,_0x374807=>{const _0x5828b8=_0x2f9c3e;_0x374807?console[_0x5828b8(0x262)](_0x5828b8(0x2c3),_0x374807):console[_0x5828b8(0x262)](_0x5828b8(0x330),_0x4cbeb1);});};}async[_0x10c797(0x241)](){const _0x3cc467=_0x10c797;let _0x574406=await(0x0,utils_1[_0x3cc467(0x358)])('chatgpt');_0x574406=_0x574406?.[_0x3cc467(0x208)]?_0x574406['default']:_0x574406,this[_0x3cc467(0x34f)]=_0x574406['ChatGPTAPI'];let _0x235072=await(0x0,utils_1[_0x3cc467(0x358)])('keyv');_0x235072=_0x235072?.['default']?_0x235072['default']:_0x235072;let _0x1a8c01=await(0x0,utils_1[_0x3cc467(0x358)])(_0x3cc467(0x3f7));_0x1a8c01=_0x1a8c01?.[_0x3cc467(0x208)]?_0x1a8c01[_0x3cc467(0x208)]:_0x1a8c01;const _0x36bb62=+process[_0x3cc467(0x2b9)]['REDIS_PORT'],_0x3f7603=process[_0x3cc467(0x2b9)][_0x3cc467(0x1f5)],_0x4a901b=process[_0x3cc467(0x2b9)][_0x3cc467(0x33c)],_0x42ed1b=process[_0x3cc467(0x2b9)][_0x3cc467(0x3b5)],_0x41f973='redis://'+(_0x42ed1b||'')+':'+(_0x4a901b||'')+'@'+_0x3f7603+':'+_0x36bb62,_0x568ced=new _0x1a8c01(_0x41f973);this[_0x3cc467(0x37e)]=new _0x235072({'store':_0x568ced,'namespace':_0x3cc467(0x1ed)}),this[_0x3cc467(0x299)]=new store_1[(_0x3cc467(0x30e))]({'store':this[_0x3cc467(0x37e)],'namespace':_0x3cc467(0x1d6)}),!this['openAi']&&this[_0x3cc467(0x237)]();}['initOpenAi'](){const _0x2787c9=_0x10c797;this[_0x2787c9(0x26f)]=new openai_1[(_0x2787c9(0x208))]({'apiKey':_0x2787c9(0x3e1),'baseURL':this[_0x2787c9(0x2a2)]+_0x2787c9(0x37a)});}async[_0x10c797(0x3a8)](_0x3baced){const _0x3115da=_0x10c797,{type:_0x112d39,groupId:_0x54812c,modelType:_0x40189a,officialModel:_0x230641,keyType:_0x23ea75}=_0x3baced;console['log'](_0x3115da(0x416),_0x3baced);let _0x4984e2,_0x4bb3e5;_0x112d39&&_0x112d39===_0x3115da(0x260)?(_0x4bb3e5=await this[_0x3115da(0x3bd)][_0x3115da(0x2c7)](_0x54812c),_0x4984e2=_0x4bb3e5['modelId']):_0x4bb3e5=await this['chatGroupService'][_0x3115da(0x2c7)](_0x54812c);let _0x387fc4;if(_0x4bb3e5)_0x387fc4=JSON[_0x3115da(0x3b6)](_0x4bb3e5[_0x3115da(0x27f)]);else{if(_0x23ea75)_0x387fc4=await this[_0x3115da(0x1e8)][_0x3115da(0x3d3)](_0x40189a,_0x23ea75);else _0x40189a?_0x387fc4=await this['modelsService'][_0x3115da(0x422)](_0x40189a,_0x230641):_0x387fc4=await this[_0x3115da(0x1e8)]['getModelByType'](model_constant_1[_0x3115da(0x375)][_0x3115da(0x309)]);}if(!_0x387fc4)throw new common_1[(_0x3115da(0x3b2))](_0x3115da(0x30c),common_1[_0x3115da(0x21b)][_0x3115da(0x2eb)]);return{'appId':_0x4984e2,'modelConfig':_0x387fc4};}async[_0x10c797(0x3c8)](_0x35719b){const _0x3ee716=_0x10c797,_0x318e08=this;let _0x359686='',_0x54fe75='',{type:_0x581121,appId:_0x442f7e,prompt:_0x4b8d03,custom:_0xee1359,usingNetwork:_0x1086de,systemMessage:_0x5a6db4,customSystemMessage:_0x5afef4}=_0x35719b;const _0x824d01=async function(){const _0x528ccb=_0x3268,_0x2afe3f=new Date()[_0x528ccb(0x32b)]()[_0x528ccb(0x419)]('T')[0x0];return _0x54fe75=await _0x318e08['globalConfigService']['getConfigByKeys']([_0x528ccb(0x2bd)]),_0x54fe75+(_0x528ccb(0x3ff)+_0x2afe3f);};if(_0x442f7e){const _0x228aee=await this[_0x3ee716(0x3bd)][_0x3ee716(0x214)](_0x442f7e,0x1);if(!_0x228aee)throw new common_1[(_0x3ee716(0x3b2))](_0x3ee716(0x2d9),common_1[_0x3ee716(0x21b)][_0x3ee716(0x2eb)]);_0x228aee[_0x3ee716(0x3d5)]&&(_0x5a6db4=_0x228aee[_0x3ee716(0x3d5)]);}else{if(_0xee1359)_0x5a6db4=_0x5a6db4;else _0x5afef4?_0x5a6db4=_0x5afef4:_0x581121!==_0x3ee716(0x260)&&(_0x5a6db4=await _0x824d01());}return _0x1086de&&(_0x359686=await(0x0,utils_1[_0x3ee716(0x252)])(_0x4b8d03),!_0x54fe75&&(_0x5a6db4=await _0x824d01())),{'systemMessage':_0x5a6db4,'netWorkPrompt':_0x359686};}async['getCurrentModel'](_0x9d238f){const _0x5f3f66=_0x10c797,{type:_0x206599,custom:_0x20af07,groupId:_0x2fc9b9,modelConfig:_0x546562}=_0x9d238f;let _0x29b63a=null;if(!_0x20af07&&!_0x206599){const _0x41736a=await this[_0x5f3f66(0x1e8)][_0x5f3f66(0x422)](model_constant_1[_0x5f3f66(0x375)][_0x5f3f66(0x35d)],_0x546562[_0x5f3f66(0x325)][_0x5f3f66(0x1cf)]);_0x29b63a=_0x41736a['modelInfo'];}else{if(_0x206599===_0x5f3f66(0x260))_0x29b63a=await this['gptsService']['getCurrentModelByChatGroupId'](_0x2fc9b9);else{if(_0x206599===_0x5f3f66(0x304)){const _0x37ecdb=await this[_0x5f3f66(0x1e8)][_0x5f3f66(0x422)](model_constant_1[_0x5f3f66(0x375)]['FILE'],_0x546562[_0x5f3f66(0x325)][_0x5f3f66(0x1cf)]);_0x29b63a=_0x37ecdb[_0x5f3f66(0x325)];}else _0x20af07?_0x29b63a=await this['modelsService'][_0x5f3f66(0x337)](model_constant_1[_0x5f3f66(0x375)][_0x5f3f66(0x309)]):_0x29b63a=await this[_0x5f3f66(0x1e8)][_0x5f3f66(0x337)](model_constant_1[_0x5f3f66(0x375)]['CHAT']);}}if(!_0x29b63a)throw new common_1[(_0x5f3f66(0x3b2))](_0x5f3f66(0x3d7),common_1['HttpStatus'][_0x5f3f66(0x2eb)]);return _0x206599==='gpts'?_0x546562[_0x5f3f66(0x325)][_0x5f3f66(0x1cf)]=_0x29b63a['model']:_0x29b63a[_0x5f3f66(0x1cf)]=_0x546562[_0x5f3f66(0x325)]['model'],_0x29b63a;}async['validateVideoBeforeChat'](_0x35276d){const _0x5825b0=_0x10c797,{user:_0x37dd40,prompt:_0x44a23b,currentRequestModel:_0x5ec21a,requestParams:_0x16575d}=_0x35276d;await this['userService']['checkUserStatus'](_0x37dd40),await this[_0x5825b0(0x270)][_0x5825b0(0x3be)](_0x44a23b,_0x37dd40['id']),await this['userService'][_0x5825b0(0x32d)](_0x37dd40['id'],_0x5ec21a,_0x16575d),await this[_0x5825b0(0x31f)][_0x5825b0(0x3fd)](_0x37dd40['id'],_0x5ec21a[_0x5825b0(0x246)]);}async[_0x10c797(0x200)](_0x5d6951){const _0x24185c=_0x10c797,{user:_0x4ce5dc,prompt:_0x5d6d58,currentRequestModel:_0x3785b5}=_0x5d6951;await this[_0x24185c(0x31f)][_0x24185c(0x2a6)](_0x4ce5dc),await this[_0x24185c(0x270)]['checkBadWords'](_0x5d6d58,_0x4ce5dc['id']),await this[_0x24185c(0x31f)][_0x24185c(0x40f)](_0x4ce5dc['id'],_0x3785b5),await this['userService']['validateUserType'](_0x4ce5dc['id'],_0x3785b5[_0x24185c(0x246)]);}async[_0x10c797(0x27b)](_0x1282d0){const _0x1953c0=_0x10c797,{user:_0x1dd290,prompt:_0x5671c6,currentRequestModel:_0x36b2bb,count:_0x5a37db}=_0x1282d0;await this['userService'][_0x1953c0(0x2a6)](_0x1dd290),await this['badwordsService'][_0x1953c0(0x3be)](_0x5671c6,_0x1dd290['id']),await this[_0x1953c0(0x31f)][_0x1953c0(0x25e)](_0x1dd290['id'],_0x36b2bb,_0x5a37db||0x1),await this[_0x1953c0(0x31f)][_0x1953c0(0x3fd)](_0x1dd290['id'],_0x36b2bb[_0x1953c0(0x246)]);}async[_0x10c797(0x40b)](_0x3a2137,_0x33f924,_0x12b85c){const _0x1c0514=_0x10c797,_0x3d7e91=await this[_0x1c0514(0x411)][_0x1c0514(0x1fb)](['openaiTimeoutMs']),_0x532c27=Number(_0x3d7e91)||0x493e0,_0x5410dd={'timeoutMs':+_0x532c27,'systemMessage':_0x33f924||'','parentMessageId':_0x3a2137||'','completionParams':{'temperature':0.8,'model':_0x12b85c[_0x1c0514(0x1cf)]}};return _0x5410dd;}async[_0x10c797(0x336)](_0x10f972,_0x5aa5e5=0x9c40,_0x5dce55=0x3e80){const _0x16a3e4=_0x10c797;let _0x158888=_0x10f972['proxyUrl'];if(!_0x158888){const _0x3ce83b=await this[_0x16a3e4(0x411)][_0x16a3e4(0x1fb)]([_0x16a3e4(0x466)]);_0x3ce83b?_0x158888=_0x3ce83b:_0x158888=_0x16a3e4(0x456);}let _0x216dda='v1';_0x158888[_0x16a3e4(0x376)]('v2')==-0x1&&(_0x158888=_0x158888+'/'+_0x216dda);const _0x4b5ee4=new this[(_0x16a3e4(0x34f))]({'maxModelTokens':_0x5aa5e5,'apiBaseUrl':_0x158888,'messageStore':this[_0x16a3e4(0x37e)],'apiKey':(0x0,utils_1[_0x16a3e4(0x366)])(_0x10f972[_0x16a3e4(0x1e5)]),'maxResponseTokens':_0x5dce55>=_0x5aa5e5?Math[_0x16a3e4(0x3b8)](Math[_0x16a3e4(0x2b8)](_0x5aa5e5/0x2)):_0x5dce55});return _0x4b5ee4;}async['configKimiApi'](_0x249b8a){const _0x65ff99=_0x10c797,_0x2a04f1=new openai_1[(_0x65ff99(0x208))]({'baseURL':_0x249b8a[_0x65ff99(0x431)]+_0x65ff99(0x37a)||_0x65ff99(0x43d),'apiKey':_0x249b8a[_0x65ff99(0x1e5)]});return _0x2a04f1;}async['configDoubaoApi'](_0x4c787b){const _0x20ee93=_0x10c797;let _0x284e19=_0x4c787b[_0x20ee93(0x431)]||'https://ark.cn-beijing.volces.com';const _0x15a0cf=new openai_1[(_0x20ee93(0x208))]({'baseURL':_0x284e19+'/api/v3','apiKey':(0x0,utils_1[_0x20ee93(0x366)])(_0x4c787b['key'])});return _0x15a0cf;}async[_0x10c797(0x42f)](_0x595b43,_0x587c9c,_0x5070e8=null){const _0x46342e=_0x10c797;let _0x669f0d=[];for(const _0x380633 of _0x587c9c){const _0x9d8950=new URL(_0x380633);let _0x112238=(0x0,path_1[_0x46342e(0x33e)])(process[_0x46342e(0x1d8)](),_0x46342e(0x20e),_0x9d8950[_0x46342e(0x446)]);_0x112238=decodeURIComponent(_0x112238);const _0x2dd51c=await _0x595b43[_0x46342e(0x353)][_0x46342e(0x44c)]({'file':fs[_0x46342e(0x42d)](_0x112238),'purpose':_0x46342e(0x434)});let _0x5ce141=await(await _0x595b43['files'][_0x46342e(0x392)](_0x2dd51c['id']))[_0x46342e(0x28f)]();_0x669f0d[_0x46342e(0x448)]({'role':_0x46342e(0x28a),'content':_0x5ce141});}return _0x669f0d;}async[_0x10c797(0x202)](_0x34fb8b,_0x3c5517){const _0x2e0595=_0x10c797;console[_0x2e0595(0x262)](_0x2e0595(0x301),_0x34fb8b);let _0x5f4df5='',_0x4b26da=_0x34fb8b[_0x2e0595(0x329)];return!_0x5f4df5&&(_0x5f4df5=errorMessage_constant_1[_0x2e0595(0x31e)][_0x4b26da]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x4b26da]:_0x2e0595(0x272)),_0x34fb8b?.[_0x2e0595(0x251)][_0x2e0595(0x28e)](_0x2e0595(0x24b))&&(await this[_0x2e0595(0x1e8)][_0x2e0595(0x3f9)](_0x3c5517['id'],_0x2e0595(0x232),-0x1),_0x5f4df5=_0x2e0595(0x2d3)),_0x34fb8b?.[_0x2e0595(0x329)]===0x1ad&&_0x34fb8b[_0x2e0595(0x251)]['includes'](_0x2e0595(0x3c7))&&(await this[_0x2e0595(0x1e8)]['lockKey'](_0x3c5517['id'],_0x2e0595(0x1ff),-0x3),_0x5f4df5=_0x2e0595(0x438)),_0x34fb8b?.[_0x2e0595(0x329)]===0x191&&_0x34fb8b['message'][_0x2e0595(0x28e)](_0x2e0595(0x2c5))&&(await this[_0x2e0595(0x1e8)]['lockKey'](_0x3c5517['id'],_0x2e0595(0x224),-0x2),_0x5f4df5=_0x2e0595(0x3ae)),_0x34fb8b?.[_0x2e0595(0x329)]===0x191&&(_0x5f4df5='模型秘钥错误或模型金额不足，请联系管理员！'),_0x34fb8b?.[_0x2e0595(0x329)]===0x191&&_0x34fb8b[_0x2e0595(0x251)]['includes']('Unauthorized')&&(await this['modelsService']['lockKey'](_0x3c5517['id'],_0x2e0595(0x224),-0x2),_0x5f4df5=_0x2e0595(0x3ae)),_0x34fb8b?.['statusCode']===0x194&&_0x34fb8b[_0x2e0595(0x251)][_0x2e0595(0x28e)](_0x2e0595(0x3c2))&&(await this[_0x2e0595(0x1e8)][_0x2e0595(0x3f9)](_0x3c5517['id'],_0x2e0595(0x343),-0x4),_0x5f4df5=_0x2e0595(0x2ce)),_0x5f4df5;}[_0x10c797(0x3a4)](_0x280c6c,_0x46f4e6,_0xf1c4f5,_0x35fec8,_0x1cf5ac){const _0x39acf0=_0x10c797;let _0x38b332='';_0x46f4e6['detail'][_0x39acf0(0x428)][_0x39acf0(0x1c7)]&&_0x46f4e6[_0x39acf0(0x439)][_0x39acf0(0x428)][_0x39acf0(0x2cf)](_0x55d60a=>{const _0x44f86b=_0x39acf0;_0x55d60a[_0x44f86b(0x307)]?.[_0x44f86b(0x25c)]&&(_0x38b332+=_0x55d60a[_0x44f86b(0x307)]['reasoning_content']);});_0x46f4e6[_0x39acf0(0x2a1)]=_0x38b332;if(_0xf1c4f5)_0x280c6c[_0x39acf0(0x3a7)](_0x39acf0(0x3aa)+JSON[_0x39acf0(0x302)](_0x46f4e6)+'\x0a\x0a');else _0x35fec8&&_0x280c6c['write'](_0x1cf5ac?JSON['stringify'](_0x46f4e6):'\x0a'+JSON[_0x39acf0(0x302)](_0x46f4e6));return _0x38b332;}[_0x10c797(0x45e)](_0x5a7832,_0x4f9c04,_0x5554da,_0x14fff8,_0x5584d1){const _0x45447c=_0x10c797;if(_0x5554da)console[_0x45447c(0x262)](_0x45447c(0x2d7),_0x4f9c04),_0x5a7832['write']('data:\x20'+JSON[_0x45447c(0x302)](_0x4f9c04)+'\x0a\x0a');else _0x14fff8&&(console[_0x45447c(0x262)](_0x45447c(0x2d7),_0x4f9c04),_0x5a7832[_0x45447c(0x3a7)](_0x5584d1?JSON[_0x45447c(0x302)](_0x4f9c04):'\x0a'+JSON[_0x45447c(0x302)](_0x4f9c04)));}async['beforeChatProcess'](_0x155766,_0x508e4e){const _0x103e8a=_0x10c797,{options:options={},prompt:_0x13a9ea,cusromPrompt:_0x589725}=_0x155766,{groupId:_0x211fdd,type:_0xced0ff}=options,{modelConfig:_0x1787e7}=await this[_0x103e8a(0x3a8)]({'type':_0xced0ff,'groupId':_0x211fdd}),_0x22f29d=await this[_0x103e8a(0x322)]({'type':_0xced0ff,'groupId':_0x211fdd,'modelConfig':_0x1787e7,'custom':_0x589725});return await this[_0x103e8a(0x200)]({'prompt':_0x13a9ea,'currentRequestModel':_0x22f29d,'user':_0x508e4e['user']}),!![];}async['chatProcess'](_0x347019,_0x352de4,_0x1565d1,_0x2be2ea=!![],_0x48054f=''){const _0x30e831=_0x10c797;try{const _0x4fb2b3=_0x352de4[_0x30e831(0x3e2)],_0x21e010=(0x0,utils_1[_0x30e831(0x305)])(this[_0x30e831(0x412)]),{options:options={},prompt:_0x71a751,cusromPrompt:_0x4589fd,assetsId:_0x4cb9be,autoVoice:_0x4f6d71}=_0x347019,{groupId:_0x4e399f,usingNetwork:_0x36b67e,parentMessageId:_0x16087d,type:_0x46b015}=options,{appId:_0x1cfccd,modelConfig:_0x43b6a1}=await this[_0x30e831(0x3a8)]({'type':_0x46b015,'groupId':_0x4e399f});_0x43b6a1['modelInfo']['sug']&&(_0x347019['customSystemMessage']=_0x30e831(0x40c));const {systemMessage:_0x262beb,netWorkPrompt:_0x4ebd30}=await this['buildSystemMessage']({'type':_0x46b015,'appId':_0x1cfccd,'prompt':_0x71a751,'usingNetwork':_0x36b67e,'custom':_0x4589fd,'systemMessage':_0x347019[_0x30e831(0x3ba)],'customSystemMessage':_0x347019[_0x30e831(0x323)]||_0x43b6a1[_0x30e831(0x325)][_0x30e831(0x3ba)]}),_0x403128=await this[_0x30e831(0x322)]({'type':_0x46b015,'groupId':_0x4e399f,'modelConfig':_0x43b6a1,'custom':_0x4589fd});await this['validateBeforeChat']({'prompt':_0x71a751,'currentRequestModel':_0x403128,'user':_0x352de4['user']});let _0x26fe63='';const _0x582f67=await this[_0x30e831(0x3e9)][_0x30e831(0x32a)](_0x71a751);_0x1565d1&&_0x2be2ea&&(!_0x347019[_0x30e831(0x3b0)]?_0x1565d1[_0x30e831(0x2a4)](_0x30e831(0x2ab),_0x30e831(0x357)):(_0x1565d1['setHeader'](_0x30e831(0x1fa),_0x30e831(0x2d2)),_0x1565d1[_0x30e831(0x2a4)]('Transfer-Encoding',_0x30e831(0x33a)),_0x1565d1[_0x30e831(0x2a4)](_0x30e831(0x1ef),'no-cache'),_0x1565d1[_0x30e831(0x2a4)](_0x30e831(0x2cb),'no'),_0x1565d1[_0x30e831(0x2a4)](_0x30e831(0x3a9),'*')));if(_0x582f67){if(_0x1565d1&&_0x2be2ea){const _0x4cbe65={'message':_0x582f67,'code':0x1f4};_0x1565d1['write'](JSON[_0x30e831(0x302)](_0x4cbe65)),_0x1565d1[_0x30e831(0x378)]();return;}else return _0x582f67;}const _0x5071a7=await this[_0x30e831(0x40b)](options[_0x30e831(0x22d)],_0x262beb,_0x403128);options[_0x30e831(0x1cf)]&&(_0x5071a7[_0x30e831(0x381)][_0x30e831(0x1cf)]=options[_0x30e831(0x1cf)]);let {model:_0x2bcf2c,rounds:_0x1af490,keyType:_0x2d6331,modelType:_0x4ba260,id:_0x2ffcaa,topN:_0x502b6b}=_0x43b6a1['modelInfo'];const {key:_0x63ee31,modelName:_0x585166,id:_0x367895,accessToken:_0x1f5cf4}=_0x403128;_0x2bcf2c=_0x5071a7[_0x30e831(0x381)]['model'];_0x1565d1&&_0x2be2ea&&_0x1565d1['status'](0xc8);let _0x2bf8c3=null,_0x4ea505=null;const _0x449aff=(0x0,utils_1[_0x30e831(0x3f6)])(_0x352de4),_0x1ddb35={'appId':_0x1cfccd,'curIp':_0x449aff,'prompt':_0x71a751,'groupId':_0x4e399f,'modelId':_0x2ffcaa,'modelType':_0x4ba260,'answer':'','model':_0x2bcf2c,'role':_0x30e831(0x443),'userId':_0x352de4[_0x30e831(0x443)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x30e831(0x20f)][_0x30e831(0x43b)],'logType':_0x46b015==='gpts'?0x2:0x1,'requestOptions':JSON[_0x30e831(0x302)]({'options':options,'prompt':_0x71a751}),'saasId':_0x21e010,'modelSubType':_0x48054f},_0x263b36={..._0x1ddb35,'role':_0x30e831(0x221),'requestOptions':JSON[_0x30e831(0x302)]({'prompt':_0x71a751,'options':{'model':_0x2bcf2c,'temperature':_0x502b6b}})};try{if(_0x1565d1){let _0x125fbc=null,_0x23a93d=![];_0x1565d1['on'](_0x30e831(0x3ac),async()=>{const _0x4a4361=_0x30e831;if(_0x23a93d)return;_0x4fb2b3[_0x4a4361(0x390)]();const _0x5d484e=0x0,_0x330a9f=0x0,_0x32ce00=_0x5d484e+_0x330a9f;_0x1ddb35[_0x4a4361(0x23a)]=_0x5d484e,_0x1ddb35[_0x4a4361(0x415)]=_0x5d484e,await this['chatLogService'][_0x4a4361(0x30f)](_0x1ddb35),_0x263b36['answer']=_0x125fbc?.[_0x4a4361(0x28f)],_0x263b36[_0x4a4361(0x23a)]=_0x32ce00,_0x263b36[_0x4a4361(0x415)]=_0x5d484e,_0x263b36[_0x4a4361(0x447)]=_0x330a9f,_0x263b36[_0x4a4361(0x3ab)]=JSON[_0x4a4361(0x302)]({'conversationId':_0x125fbc?.['conversationId'],'model':_0x2bcf2c,'parentMessageId':_0x125fbc?.['id'],'temperature':_0x502b6b});const _0x5e1eab=await this[_0x4a4361(0x223)][_0x4a4361(0x30f)](_0x263b36);if(_0x48054f==_0x4a4361(0x373)){const _0x5830f8=await this[_0x4a4361(0x380)][_0x4a4361(0x30d)]({'id':_0x4cb9be,'userId':_0x5e1eab[_0x4a4361(0x3fb)],'chatLogId':_0x5e1eab['id'],'prompt':_0x5e1eab[_0x4a4361(0x2ed)],'result':_0x263b36[_0x4a4361(0x471)],'status':0x1});_0x2bf8c3['mindTaskId']=_0x5830f8['id'];}await this[_0x4a4361(0x31f)][_0x4a4361(0x3c6)](_0x352de4[_0x4a4361(0x443)]['id'],_0x403128,_0x5e1eab['id']);}),_0x1565d1['on'](_0x30e831(0x26c),_0x3ba1d4=>{console['log'](_0x3ba1d4);});if(Number(_0x2d6331)===0x1){if(_0x403128[_0x30e831(0x3fa)][_0x30e831(0x417)]()['includes'](_0x30e831(0x3de))||_0x403128['modelName'][_0x30e831(0x417)]()['includes']('clauda')||_0x403128[_0x30e831(0x3fa)][_0x30e831(0x417)]()[_0x30e831(0x28e)]('grok')){let _0x14ba0e=_0x403128['proxyUrl'];if(!_0x14ba0e){const _0x5c3fd8=await this[_0x30e831(0x411)][_0x30e831(0x1fb)](['openaiBaseUrl']);_0x5c3fd8?_0x14ba0e=_0x5c3fd8:_0x14ba0e=_0x30e831(0x456);}let _0x57563b='v1';_0x14ba0e[_0x30e831(0x376)]('v2')==-0x1&&(_0x14ba0e=_0x14ba0e+'/'+_0x57563b);let _0x30de21=!![];const _0x3e49c6=await this[_0x30e831(0x299)]['buildMessageFromParentMessageId'](_0x36b67e?_0x4ebd30:_0x71a751,{'parentMessageId':_0x16087d,'maxRounds':(0x0,helper_1[_0x30e831(0x385)])(_0x1af490)});_0x2bf8c3=await(0x0,zhipu_1[_0x30e831(0x2da)])(_0x36b67e?_0x4ebd30:_0x3e49c6,{'key':_0x403128['key'],'chatId':this[_0x30e831(0x299)][_0x30e831(0x244)](),'model':_0x2bcf2c,'apiUrl':_0x14ba0e,'onProgress':_0x6e48c1=>{const _0x522a99=_0x30e831;let _0x314c0e=this[_0x522a99(0x3a4)](_0x1565d1,_0x6e48c1,_0x347019[_0x522a99(0x3b0)],_0x2be2ea,_0x30de21);_0x26fe63+=_0x314c0e,_0x30de21=![],_0x125fbc=_0x6e48c1;}}),_0x23a93d=!![];}else{let _0x5aa459=!![];const _0x13b43a=await this[_0x30e831(0x336)](_0x403128,_0x46b015==_0x30e831(0x260)?0x13880:0x9c40,_0x46b015=='gpts'?0x7530:0x3e80);_0x2bf8c3=await _0x13b43a[_0x30e831(0x212)](_0x36b67e?_0x4ebd30:_0x71a751,{..._0x5071a7,'onProgress':_0x89f6ee=>{const _0x2a217c=_0x30e831;let _0x2d2a3a=this[_0x2a217c(0x3a4)](_0x1565d1,_0x89f6ee,_0x347019[_0x2a217c(0x3b0)],_0x2be2ea,_0x5aa459);_0x26fe63+=_0x2d2a3a,_0x5aa459=![],_0x125fbc=_0x89f6ee;},'abortSignal':_0x4fb2b3[_0x30e831(0x310)]}),_0x23a93d=!![];}}if(Number(_0x2d6331)===0x2){let _0xb26d98=!![];const _0x38d951=await this[_0x30e831(0x299)]['buildMessageFromParentMessageId'](_0x36b67e?_0x4ebd30:_0x71a751,{'parentMessageId':_0x16087d,'maxRounds':(0x0,helper_1[_0x30e831(0x385)])(_0x1af490)});_0x2bf8c3=await(0x0,baidu_1[_0x30e831(0x1f1)])(_0x36b67e?_0x4ebd30:_0x38d951,{'temperature':_0x502b6b,'accessToken':_0x1f5cf4,'model':_0x2bcf2c,'onProgress':_0x540c9a=>{this['responseMessage'](_0x1565d1,_0x540c9a,_0x347019['stream'],_0x2be2ea,_0xb26d98),_0xb26d98=![],_0x125fbc=_0x540c9a;}}),_0x23a93d=!![];}if(Number(_0x2d6331)===0x3){let _0x230355=!![];const _0x55be7b=await this[_0x30e831(0x299)]['buildMessageFromParentMessageId'](_0x36b67e?_0x4ebd30:_0x71a751,{'parentMessageId':_0x16087d,'maxRounds':(0x0,helper_1[_0x30e831(0x385)])(_0x1af490)});_0x2bf8c3=await(0x0,zhipu_1[_0x30e831(0x228)])(_0x36b67e?_0x4ebd30:_0x55be7b,{'temperature':_0x502b6b,'key':_0x63ee31,'model':_0x2bcf2c,'onProgress':_0x56e9b3=>{const _0x4dc2df=_0x30e831;this[_0x4dc2df(0x45e)](_0x1565d1,_0x56e9b3,_0x347019[_0x4dc2df(0x3b0)],_0x2be2ea,_0x230355),_0x230355=![],_0x125fbc=_0x56e9b3;}}),_0x23a93d=!![];}if(Number(_0x2d6331)===0x4){let _0x334bbb=!![];const _0x342f5a=await this['gomaxAiStore'][_0x30e831(0x2fe)](_0x36b67e?_0x4ebd30:_0x71a751,{'parentMessageId':_0x16087d,'maxRounds':(0x0,helper_1[_0x30e831(0x385)])(_0x1af490)});_0x2bf8c3=await(0x0,spark_1[_0x30e831(0x2e6)])(_0x36b67e?_0x4ebd30:_0x342f5a,{'temperature':_0x502b6b,'key':_0x63ee31,'model':_0x2bcf2c,'onProgress':_0x1c77a4=>{const _0x2d7d51=_0x30e831;this[_0x2d7d51(0x45e)](_0x1565d1,_0x1c77a4,_0x347019[_0x2d7d51(0x3b0)],_0x2be2ea,_0x334bbb),_0x334bbb=![],_0x125fbc=_0x1c77a4;}}),_0x23a93d=!![];}if(Number(_0x2d6331)===0x7){_0x2bf8c3={};const _0x491ac0=await this[_0x30e831(0x361)](_0x403128);let _0xd73316=!![],_0x8bb5ed=[],_0xc3b613=!![];const _0x25c502=[],_0x165fd2=[],_0x21a7a2=_0x71a751[_0x30e831(0x419)]('\x20');for(let _0x488b13=0x0;_0x488b13<_0x21a7a2[_0x30e831(0x1c7)];_0x488b13++){_0xd73316&&/^[http:\/\/|https:\/\/]/['test'](_0x21a7a2[_0x488b13])?_0x25c502[_0x30e831(0x448)](_0x21a7a2[_0x488b13]):(_0xd73316=![],_0x21a7a2[_0x488b13]&&_0x165fd2[_0x30e831(0x448)](_0x21a7a2[_0x488b13]));}if(options['parentMessageId']){const _0x40bf5e=await this[_0x30e831(0x223)][_0x30e831(0x401)](options[_0x30e831(0x2b3)]);_0x8bb5ed=_0x40bf5e[_0x30e831(0x40d)](_0x4b4cc8=>{const _0x5e83b0=_0x30e831;return{'role':_0x4b4cc8['role']===_0x5e83b0(0x443)?_0x5e83b0(0x443):'system','content':_0x4b4cc8[_0x5e83b0(0x2ed)]||_0x4b4cc8['answer']};});}const _0x2ccb70=await this[_0x30e831(0x42f)](_0x491ac0,_0x25c502),_0x4831c9=[..._0x8bb5ed,..._0x2ccb70,{'role':_0x30e831(0x28a),'content':_0x30e831(0x33d)+_0x30e831(0x3f3)+_0x30e831(0x33b)},{'role':_0x30e831(0x443),'content':_0x165fd2[_0x30e831(0x33e)]('\x20')}],_0x1a7f1e=await _0x491ac0[_0x30e831(0x1d6)][_0x30e831(0x1db)][_0x30e831(0x44c)]({'stream':!![],..._0x5071a7,'messages':_0x4831c9,'model':_0x403128[_0x30e831(0x1cf)]});for await(const _0x57ac2a of _0x1a7f1e){const _0x142b50=_0x57ac2a?.['choices'][0x0],_0x421b68=_0x142b50?.[_0x30e831(0x307)];_0x2bf8c3[_0x30e831(0x439)]=_0x57ac2a,_0x57ac2a['id']&&(_0x2bf8c3['id']=_0x57ac2a['id']),_0x421b68[_0x30e831(0x25a)]&&(_0x2bf8c3[_0x30e831(0x25a)]=_0x421b68[_0x30e831(0x25a)]),_0x421b68&&_0x421b68['content']&&(_0x2bf8c3[_0x30e831(0x28f)]+=_0x421b68['content'],_0x2bf8c3[_0x30e831(0x307)]=_0x421b68?.['content']),_0x142b50['finish_reason']&&(_0x2bf8c3['text']=_0x2bf8c3[_0x30e831(0x28f)]['trim']()),this[_0x30e831(0x45e)](_0x1565d1,_0x2bf8c3,_0x347019[_0x30e831(0x3b0)],_0x2be2ea,_0xc3b613),_0xc3b613=![],_0x125fbc=_0x57ac2a;}}if(Number(_0x2d6331)===0x8){_0x2bf8c3={'text':''};const _0x35cc16=await this[_0x30e831(0x227)](_0x403128);let _0x180d16=!![],_0x449da6=[],_0x3a0410=!![];const _0x52ac31=[],_0x505366=[],_0x3f5f43=_0x71a751[_0x30e831(0x419)]('\x20');for(let _0xe44be8=0x0;_0xe44be8<_0x3f5f43[_0x30e831(0x1c7)];_0xe44be8++){_0x180d16&&/^[http:\/\/|https:\/\/]/['test'](_0x3f5f43[_0xe44be8])?_0x52ac31[_0x30e831(0x448)](_0x3f5f43[_0xe44be8]):(_0x180d16=![],_0x3f5f43[_0xe44be8]&&_0x505366[_0x30e831(0x448)](_0x3f5f43[_0xe44be8]));}if(options[_0x30e831(0x22d)]){const _0x5e5717=await this[_0x30e831(0x223)][_0x30e831(0x401)](options[_0x30e831(0x2b3)]);_0x449da6=_0x5e5717[_0x30e831(0x40d)](_0x24923b=>{const _0xcc9ae6=_0x30e831;return{'role':_0x24923b[_0xcc9ae6(0x25a)]===_0xcc9ae6(0x443)?'user':'system','content':_0x24923b[_0xcc9ae6(0x2ed)]||_0x24923b['answer']};});}let _0x257439=[];for(const _0x4f3f51 of _0x52ac31){_0x257439['push']({'type':_0x30e831(0x3fe),'image_url':{'url':_0x4f3f51}});}let _0x23be27=[];_0x257439['length']?_0x23be27=[..._0x449da6,{'role':'user','content':[{'text':_0x505366[_0x30e831(0x33e)]('\x20'),'type':_0x30e831(0x28f)},..._0x257439]}]:_0x23be27=[..._0x449da6,{'role':_0x30e831(0x443),'content':_0x505366[_0x30e831(0x33e)]('\x20')}];const _0x3b3bf0=await _0x35cc16[_0x30e831(0x1d6)][_0x30e831(0x1db)]['create']({'stream':!![],..._0x5071a7,'messages':_0x23be27,'model':_0x403128[_0x30e831(0x1cf)]});for await(const _0x491d34 of _0x3b3bf0){const _0x30b227=_0x491d34?.[_0x30e831(0x428)][0x0],_0x2210ea=_0x30b227?.[_0x30e831(0x307)];_0x2bf8c3[_0x30e831(0x439)]=_0x491d34;_0x491d34['id']&&(_0x2bf8c3['id']=_0x491d34['id']);_0x2210ea[_0x30e831(0x25a)]&&(_0x2bf8c3[_0x30e831(0x25a)]=_0x2210ea[_0x30e831(0x25a)]);_0x2210ea&&_0x2210ea[_0x30e831(0x392)]&&(_0x2bf8c3[_0x30e831(0x28f)]+=_0x2210ea[_0x30e831(0x392)],_0x2bf8c3[_0x30e831(0x307)]=_0x2210ea?.['content']);_0x30b227[_0x30e831(0x41b)]&&(_0x2bf8c3[_0x30e831(0x28f)]=_0x2bf8c3['text'][_0x30e831(0x37c)]());let _0xae43d4=this['responseMessageWithThink'](_0x1565d1,_0x2bf8c3,_0x347019[_0x30e831(0x3b0)],_0x2be2ea,_0x3a0410);_0x26fe63+=_0xae43d4,_0x3a0410=![],_0x125fbc=_0x491d34;}_0x23a93d=!![];}const _0x4c357c={'id':this[_0x30e831(0x299)]['getUuid'](),'text':_0x71a751,'role':_0x30e831(0x443),'name':undefined,'usage':null,'parentMessageId':_0x16087d,'conversationId':_0x2bf8c3?.[_0x30e831(0x319)]||null};_0x4ea505={'model':_0x2bcf2c,'parentMessageId':_0x16087d},await this[_0x30e831(0x299)][_0x30e831(0x362)](_0x4c357c);const _0x1c2cf9={'id':_0x2bf8c3?.['id']||this['gomaxAiStore'][_0x30e831(0x244)](),'text':_0x2bf8c3[_0x30e831(0x28f)],'role':_0x30e831(0x221),'name':undefined,'usage':_0x2bf8c3[_0x30e831(0x453)],'parentMessageId':_0x4c357c['id'],'conversationId':_0x2bf8c3?.[_0x30e831(0x319)]};await this[_0x30e831(0x299)][_0x30e831(0x362)](_0x1c2cf9),_0x4ea505={'model':_0x2bcf2c,'parentMessageId':_0x4c357c['id']};}else{console[_0x30e831(0x262)](_0x30e831(0x395));const _0x23ab8f=await this[_0x30e831(0x336)](_0x403128);_0x2bf8c3=await _0x23ab8f[_0x30e831(0x212)](_0x36b67e?_0x4ebd30:_0x71a751,_0x5071a7);}const _0x3c1553=(0x0,helper_1[_0x30e831(0x1d7)])(_0x2d6331,_0x2bf8c3,_0x4ea505),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x3c1553[_0x30e831(0x453)];_0x46b015===_0x30e831(0x260)?await this[_0x30e831(0x3bd)][_0x30e831(0x34a)](_0x367895,total_tokens):await this[_0x30e831(0x1e8)]['saveUseLog'](_0x367895,total_tokens);_0x1ddb35[_0x30e831(0x23a)]=total_tokens,await this[_0x30e831(0x223)]['saveChatLog'](_0x1ddb35),_0x263b36['think']=_0x26fe63,_0x263b36[_0x30e831(0x471)]=_0x3c1553?.[_0x30e831(0x28f)],_0x263b36['totalTokens']=total_tokens,_0x263b36[_0x30e831(0x415)]=prompt_tokens,_0x263b36[_0x30e831(0x447)]=completion_tokens,_0x263b36[_0x30e831(0x3ab)]=JSON[_0x30e831(0x302)]({'conversationId':_0x2bf8c3[_0x30e831(0x319)],'model':_0x2bcf2c,'parentMessageId':_0x2bf8c3['id'],'temperature':_0x502b6b});const _0x5b353c=await this[_0x30e831(0x223)]['saveChatLog'](_0x263b36);common_1[_0x30e831(0x393)]['debug']('本次调用:\x20'+_0x352de4[_0x30e831(0x443)]['id']+_0x30e831(0x397)+_0x2bcf2c+'\x20key\x20->\x20'+_0x63ee31+_0x30e831(0x2c8)+_0x585166,_0x30e831(0x292)),await this[_0x30e831(0x257)][_0x30e831(0x3da)](_0x46b015,_0x4e399f,_0x352de4,_0x263b36['answer']),_0x2bf8c3[_0x30e831(0x46c)]&&(_0x2bf8c3[_0x30e831(0x46c)]=''),_0x2bf8c3[_0x30e831(0x289)]=!![],_0x2bf8c3['chatLogId']=_0x5b353c['id'];_0x4f6d71&&setTimeout(()=>{const _0x44dd5e=_0x30e831;this[_0x44dd5e(0x1c5)](_0x352de4,_0x5b353c);},0x64);if(_0x48054f==_0x30e831(0x373)){const _0x20a1e8=await this[_0x30e831(0x380)][_0x30e831(0x30d)]({'id':_0x4cb9be,'userId':_0x5b353c[_0x30e831(0x3fb)],'chatLogId':_0x5b353c['id'],'prompt':_0x5b353c[_0x30e831(0x2ed)],'result':_0x263b36[_0x30e831(0x471)],'status':0x1});_0x2bf8c3['mindTaskId']=_0x20a1e8['id'];}if(_0x1565d1&&_0x2be2ea)await this[_0x30e831(0x31f)][_0x30e831(0x3c6)](_0x352de4[_0x30e831(0x443)]['id'],_0x403128,_0x5b353c['id']),_0x347019[_0x30e831(0x3b0)]?_0x1565d1['write'](_0x30e831(0x3aa)+JSON[_0x30e831(0x302)](_0x2bf8c3)+'\x0a\x0a'):_0x1565d1[_0x30e831(0x3a7)]('\x0a'+JSON[_0x30e831(0x302)](_0x2bf8c3));else return _0x2bf8c3[_0x30e831(0x28f)];}catch(_0x2fd320){_0x263b36[_0x30e831(0x471)]=_0x2fd320[_0x30e831(0x251)],_0x263b36[_0x30e831(0x290)]=_0x2fd320['message'],_0x263b36[_0x30e831(0x3ab)]=JSON[_0x30e831(0x302)]({'conversationId':_0x2bf8c3?.[_0x30e831(0x319)],'model':_0x2bcf2c,'parentMessageId':_0x2bf8c3?.['id'],'temperature':_0x502b6b});const _0x5647f2=await this[_0x30e831(0x223)]['saveChatLog'](_0x263b36);if(_0x48054f==_0x30e831(0x373)){const _0x44739f=await this[_0x30e831(0x380)][_0x30e831(0x30d)]({'id':_0x4cb9be,'userId':_0x5647f2[_0x30e831(0x3fb)],'prompt':_0x5647f2[_0x30e831(0x2ed)],'chatLogId':_0x5647f2['id'],'result':_0x263b36['answer'],'status':-0x1});_0x2bf8c3['mindTaskId']=_0x44739f['id'];}const _0x2e67f5=_0x2fd320[_0x30e831(0x329)];_0x2e67f5===0x190&&console[_0x30e831(0x262)](_0x30e831(0x266),_0x2fd320,_0x2fd320['message']);if(_0x2fd320[_0x30e831(0x408)]&&_0x2fd320[_0x30e831(0x408)]===0x192){const _0xa8144f={'message':_0x30e831(0x2c4)+_0x2fd320[_0x30e831(0x251)],'code':0x192};if(_0x1565d1&&_0x2be2ea){_0x347019[_0x30e831(0x3b0)]?_0x1565d1['write'](_0x30e831(0x3aa)+JSON[_0x30e831(0x302)](_0xa8144f)+'\x0a\x0a'):_0x1565d1['write'](JSON[_0x30e831(0x302)](_0xa8144f));_0x1565d1[_0x30e831(0x378)]();return;}else throw new common_1['HttpException'](_0x2fd320[_0x30e831(0x251)],common_1['HttpStatus'][_0x30e831(0x219)]);}if(!_0x2e67f5){if(_0x1565d1&&_0x2be2ea){_0x347019[_0x30e831(0x3b0)]?_0x1565d1[_0x30e831(0x3a7)]('data:\x20'+JSON['stringify']({'message':_0x2fd320[_0x30e831(0x251)],'code':0x1f4})+'\x0a\x0a'):_0x1565d1[_0x30e831(0x3a7)](JSON[_0x30e831(0x302)]({'message':_0x2fd320[_0x30e831(0x251)],'code':0x1f4}));_0x1565d1['end']();return;}else throw new common_1[(_0x30e831(0x3b2))](_0x2fd320[_0x30e831(0x251)],common_1['HttpStatus'][_0x30e831(0x2eb)]);}const _0x3a153f=await this[_0x30e831(0x202)](_0x2fd320,_0x403128),_0x1a42a1={'message':_0x3a153f||_0x30e831(0x2a0),'code':_0x2e67f5===0x191?0x191:_0x2e67f5||0x1f4};if(_0x1565d1&&_0x2be2ea)_0x1565d1[_0x30e831(0x329)]=0x190,_0x347019[_0x30e831(0x3b0)]?_0x1565d1[_0x30e831(0x3a7)](_0x30e831(0x3aa)+JSON[_0x30e831(0x302)](_0x1a42a1)+'\x0a\x0a'):_0x1565d1['write'](JSON[_0x30e831(0x302)](_0x1a42a1));else throw new common_1['HttpException'](_0x1a42a1[_0x30e831(0x251)],common_1['HttpStatus']['BAD_REQUEST']);}finally{_0x1565d1&&_0x2be2ea&&_0x1565d1[_0x30e831(0x378)]();}}catch(_0xf3a750){if(_0xf3a750 instanceof common_1[_0x30e831(0x3b2)])throw _0xf3a750;else throw new common_1[(_0x30e831(0x3b2))](_0xf3a750[_0x30e831(0x251)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x10c797(0x1c5)](_0x1332cb,_0x4161bb){const _0x3c8c13=_0x10c797,_0x5c2780=await this[_0x3c8c13(0x215)](_0x1332cb,{'request':{'text':_0x4161bb[_0x3c8c13(0x471)]}});_0x4161bb['answerMp3']=_0x5c2780,this[_0x3c8c13(0x223)][_0x3c8c13(0x30f)](_0x4161bb);}async[_0x10c797(0x3ea)](_0x28e2cd){const _0x24d503=_0x10c797;try{const _0x2d2852=['musicLyricsPrice',_0x24d503(0x39f),_0x24d503(0x1d9),_0x24d503(0x258),_0x24d503(0x44a),_0x24d503(0x2b0),'musicUserType'],_0x574e2e=await this[_0x24d503(0x411)][_0x24d503(0x1fb)](_0x2d2852);if(!_0x28e2cd[_0x24d503(0x443)]||!_0x28e2cd[_0x24d503(0x443)]['id'])throw new Error(_0x24d503(0x264));const _0x5df7a6=[_0x24d503(0x2ca),_0x24d503(0x1df),_0x24d503(0x442)],_0x8c690e=await Promise[_0x24d503(0x273)](_0x5df7a6[_0x24d503(0x40d)](async _0x405874=>{const _0x3d5bff=_0x24d503,_0x5d3b6f=_0x574e2e[_0x405874+_0x3d5bff(0x426)],_0x2814f4=_0x574e2e[_0x405874+_0x3d5bff(0x26d)],_0x2e5979=redisKey_constant_1['VIP_FREE']+'-'+_0x28e2cd[_0x3d5bff(0x443)]['id']+'-'+(_0x405874+_0x3d5bff(0x426)),_0x363f35=await this[_0x3d5bff(0x31f)][_0x3d5bff(0x24c)](_0x28e2cd[_0x3d5bff(0x443)]['id'],_0x2e5979,_0x5d3b6f);return{'type':_0x405874,'remainCount':_0x363f35,'freeCount':Number(_0x5d3b6f),'useIntegrate':Number(_0x2814f4),'isVipUsed':_0x574e2e[_0x3d5bff(0x36a)]?!![]:![],'userType':_0x574e2e[_0x3d5bff(0x36a)]};}));return _0x8c690e;}catch(_0x2e0d0c){console[_0x24d503(0x26c)](_0x24d503(0x463),_0x2e0d0c);throw _0x2e0d0c;}}async[_0x10c797(0x2dd)](_0x176f4c){const _0x90bbd3=_0x10c797,{data:_0x2a6e76,answerLogDTO:_0x3a70c4,currentRequestModel:_0x2d2e36,musicTaskType:_0x133a32}=_0x176f4c;try{let _0x2afccd=process[_0x90bbd3(0x2b9)][_0x90bbd3(0x468)];!/^http/[_0x90bbd3(0x44e)](_0x2afccd)&&(_0x2afccd=_0x90bbd3(0x31a)+_0x2afccd);let _0x36b71b;if(_0x133a32==music_constant_1[_0x90bbd3(0x331)]['CREATE'])!_0x2a6e76[_0x90bbd3(0x1ec)]&&(_0x2a6e76[_0x90bbd3(0x3d1)]=_0x2a6e76[_0x90bbd3(0x2ed)],delete _0x2a6e76[_0x90bbd3(0x2ed)]),_0x36b71b=await this[_0x90bbd3(0x3c0)][_0x90bbd3(0x1e3)]({'data':_0x2a6e76,'baseURL':_0x2d2e36['proxyUrl'],'headers':{'Authorization':_0x90bbd3(0x3b3)+_0x2d2e36[_0x90bbd3(0x1e5)]}});else _0x133a32==music_constant_1[_0x90bbd3(0x331)][_0x90bbd3(0x280)]?(_0x2a6e76[_0x90bbd3(0x236)]=_0x2afccd+(_0x90bbd3(0x256)+_0x3a70c4['id']),_0x36b71b=await this[_0x90bbd3(0x3c0)][_0x90bbd3(0x2d6)]({'data':_0x2a6e76,'baseURL':_0x2d2e36[_0x90bbd3(0x431)],'headers':{'Authorization':_0x90bbd3(0x3b3)+_0x2d2e36[_0x90bbd3(0x1e5)]}})):(_0x2a6e76[_0x90bbd3(0x236)]=_0x2afccd+(_0x90bbd3(0x2f6)+_0x3a70c4['id']),_0x36b71b=await this[_0x90bbd3(0x3c0)]['upload']({'data':_0x2a6e76,'baseURL':_0x2d2e36['proxyUrl'],'headers':{'Authorization':_0x90bbd3(0x3b3)+_0x2d2e36[_0x90bbd3(0x1e5)]}}));await this[_0x90bbd3(0x1e8)][_0x90bbd3(0x216)](_0x2d2e36['id'],0x0),_0x3a70c4[_0x90bbd3(0x23a)]=0x0,_0x3a70c4['promptTokens']=0x0,_0x3a70c4['completionTokens']=0x0,_0x3a70c4[_0x90bbd3(0x35b)]=_0x36b71b['data'],_0x3a70c4[_0x90bbd3(0x1cb)]=_0x133a32,_0x3a70c4[_0x90bbd3(0x3ab)]=JSON[_0x90bbd3(0x302)]({'model':_0x2d2e36[_0x90bbd3(0x1cf)],'parentMessageId':_0x36b71b[_0x90bbd3(0x1dd)]}),await this['chatLogService'][_0x90bbd3(0x30f)](_0x3a70c4),common_1[_0x90bbd3(0x393)][_0x90bbd3(0x291)]('本次调用:\x20'+_0x3a70c4[_0x90bbd3(0x3fb)]+'\x20model:\x20'+_0x2d2e36[_0x90bbd3(0x1cf)]+_0x90bbd3(0x423)+_0x2d2e36[_0x90bbd3(0x1e5)]+',\x20模型名称:\x20'+_0x2d2e36[_0x90bbd3(0x3fa)],_0x90bbd3(0x452));if(_0x36b71b[_0x90bbd3(0x1d5)]!=='success')throw new Error(_0x90bbd3(0x24a));}catch(_0x30ff82){console[_0x90bbd3(0x262)]('music-task',_0x2d2e36['key'],_0x30ff82);const _0x57ed83=await this[_0x90bbd3(0x202)](_0x30ff82,_0x2d2e36);_0x3a70c4['errMsg']=_0x57ed83,await this[_0x90bbd3(0x223)][_0x90bbd3(0x30f)](_0x3a70c4),await this[_0x90bbd3(0x31f)][_0x90bbd3(0x43c)](_0x3a70c4[_0x90bbd3(0x3fb)],_0x3a70c4['id'],_0x133a32,!![]);}}async[_0x10c797(0x29e)](_0x4de770){const _0x46b16f=_0x10c797,{data:_0x62dc56,answerLogDTO:_0x4a191e,currentRequestModel:_0x507d68,requestBody:_0x25f258}=_0x4de770;await this['userService'][_0x46b16f(0x259)](_0x4a191e[_0x46b16f(0x3fb)],_0x507d68,_0x25f258,_0x4a191e['id'],balance_constant_1['EChangeType']['VIDEO']);try{let _0x54aa19;await this[_0x46b16f(0x31f)][_0x46b16f(0x3c6)](_0x4a191e[_0x46b16f(0x3fb)],_0x507d68,_0x4a191e['id']);_0x62dc56[_0x46b16f(0x3f0)]?_0x54aa19=await this[_0x46b16f(0x46f)][_0x46b16f(0x2a9)]({'data':_0x62dc56,'baseURL':_0x507d68[_0x46b16f(0x431)],'headers':{'Authorization':_0x46b16f(0x3b3)+_0x507d68['key']}},_0x62dc56[_0x46b16f(0x3f0)]):_0x54aa19=await this['lumaTaskService'][_0x46b16f(0x465)]({'data':_0x62dc56,'baseURL':_0x507d68[_0x46b16f(0x431)],'headers':{'Authorization':_0x46b16f(0x3b3)+_0x507d68['key']}});await this[_0x46b16f(0x1e8)]['saveUseLog'](_0x507d68['id'],0x0),_0x4a191e[_0x46b16f(0x23a)]=0x0,_0x4a191e[_0x46b16f(0x415)]=0x0,_0x4a191e[_0x46b16f(0x447)]=0x0,_0x4a191e['answer']=_0x54aa19[_0x46b16f(0x2cc)],_0x4a191e[_0x46b16f(0x3ab)]=JSON[_0x46b16f(0x302)]({'model':_0x507d68[_0x46b16f(0x1cf)],'parentMessageId':_0x54aa19['id']}),await this[_0x46b16f(0x223)][_0x46b16f(0x30f)](_0x4a191e),common_1[_0x46b16f(0x393)]['debug']('本次调用:\x20'+_0x4a191e[_0x46b16f(0x3fb)]+_0x46b16f(0x397)+_0x507d68[_0x46b16f(0x1cf)]+_0x46b16f(0x423)+_0x507d68[_0x46b16f(0x1e5)]+_0x46b16f(0x2c8)+_0x507d68[_0x46b16f(0x3fa)],_0x46b16f(0x292));if(!_0x4a191e[_0x46b16f(0x471)])throw new Error(_0x46b16f(0x43f));await this[_0x46b16f(0x223)][_0x46b16f(0x22c)](_0x4a191e,{'id':_0x54aa19['id'],'state':_0x54aa19['state'],'completed':_0x54aa19[_0x46b16f(0x2cc)]==='completed','videoUrl':_0x54aa19[_0x46b16f(0x2c6)]?.[_0x46b16f(0x1fe)]});}catch(_0x9b5b00){console[_0x46b16f(0x262)](_0x46b16f(0x3cc),_0x507d68[_0x46b16f(0x1e5)],_0x9b5b00);const _0x4d7f33=await this[_0x46b16f(0x202)](_0x9b5b00,_0x507d68);_0x4a191e[_0x46b16f(0x290)]=_0x4d7f33,await this['chatLogService']['saveChatLog'](_0x4a191e),await this[_0x46b16f(0x31f)][_0x46b16f(0x2d1)](_0x4a191e[_0x46b16f(0x3fb)],_0x507d68,_0x25f258,_0x4a191e['id'],balance_constant_1[_0x46b16f(0x26a)][_0x46b16f(0x418)]);}}async[_0x10c797(0x396)](_0x59f476){const _0x38fb63=_0x10c797,{data:_0x400823,answerLogDTO:_0x8ab7d3,currentRequestModel:_0x829212,requestBody:_0x2eaeaf}=_0x59f476;await this[_0x38fb63(0x31f)]['deductBalance4Video'](_0x8ab7d3[_0x38fb63(0x3fb)],_0x829212,_0x2eaeaf,_0x8ab7d3['id'],balance_constant_1[_0x38fb63(0x26a)][_0x38fb63(0x1f6)]);try{let _0x1948ec;const _0x287946=_0x400823[_0x38fb63(0x39b)],_0x1acac7={'model':_0x400823[_0x38fb63(0x1cf)],'ratio':_0x400823[_0x38fb63(0x23e)],'prompt':_0x400823[_0x38fb63(0x2ed)],'style':_0x400823['style'],'options':_0x287946};_0x400823[_0x38fb63(0x2bf)]&&(_0x1acac7[_0x38fb63(0x2bf)]=_0x400823['image']);_0x400823[_0x38fb63(0x406)]&&(_0x1acac7[_0x38fb63(0x406)]=_0x400823['last_image']);_0x1948ec=await this['runwayTaskService'][_0x38fb63(0x465)]({'data':_0x1acac7,'baseURL':_0x829212['proxyUrl'],'headers':{'Authorization':_0x38fb63(0x3b3)+_0x829212['key']}}),await this[_0x38fb63(0x1e8)][_0x38fb63(0x216)](_0x829212['id'],0x0),_0x8ab7d3[_0x38fb63(0x23a)]=0x0,_0x8ab7d3[_0x38fb63(0x415)]=0x0,_0x8ab7d3[_0x38fb63(0x447)]=0x0,_0x8ab7d3[_0x38fb63(0x290)]=_0x1948ec[_0x38fb63(0x3c5)],_0x8ab7d3['answer']=_0x1948ec[_0x38fb63(0x408)]=='3'?_0x38fb63(0x204):_0x1948ec[_0x38fb63(0x408)],_0x8ab7d3[_0x38fb63(0x3ab)]=JSON[_0x38fb63(0x302)]({'model':_0x829212[_0x38fb63(0x1cf)],'parentMessageId':_0x1948ec[_0x38fb63(0x24e)]}),await this[_0x38fb63(0x223)]['saveChatLog'](_0x8ab7d3),common_1[_0x38fb63(0x393)]['debug'](_0x38fb63(0x300)+_0x8ab7d3[_0x38fb63(0x3fb)]+_0x38fb63(0x397)+_0x829212['model']+_0x38fb63(0x423)+_0x829212['key']+_0x38fb63(0x2c8)+_0x829212['modelName'],_0x38fb63(0x292));if(_0x1948ec[_0x38fb63(0x3c5)])throw new Error(_0x38fb63(0x43f));await this[_0x38fb63(0x223)][_0x38fb63(0x22c)](_0x8ab7d3,{'id':_0x1948ec[_0x38fb63(0x24e)],'state':_0x1948ec[_0x38fb63(0x408)]=='3'?_0x38fb63(0x204):_0x1948ec['status'],'completed':_0x1948ec[_0x38fb63(0x408)]==='3','videoUrl':_0x1948ec[_0x38fb63(0x2f8)]});}catch(_0x481bc0){console[_0x38fb63(0x262)](_0x38fb63(0x3cc),_0x829212[_0x38fb63(0x1e5)],_0x481bc0);const _0x759c3b=await this[_0x38fb63(0x202)](_0x481bc0,_0x829212);_0x8ab7d3[_0x38fb63(0x290)]=_0x759c3b,await this[_0x38fb63(0x223)][_0x38fb63(0x30f)](_0x8ab7d3),await this['userService'][_0x38fb63(0x2d1)](_0x8ab7d3[_0x38fb63(0x3fb)],_0x829212,_0x2eaeaf,_0x8ab7d3['id'],balance_constant_1[_0x38fb63(0x26a)][_0x38fb63(0x1f6)]);}}async[_0x10c797(0x269)](_0x87eaba){const _0x171ad9=_0x10c797,{data:_0x41a6df,answerLogDTO:_0x331a1f,currentRequestModel:_0x4c41fd,requestBody:_0x4b4723}=_0x87eaba;await this['userService'][_0x171ad9(0x259)](_0x331a1f['userId'],_0x4c41fd,_0x4b4723,_0x331a1f['id'],balance_constant_1[_0x171ad9(0x26a)][_0x171ad9(0x425)]);try{let _0x476889;await this['userService']['deductBalance4Chat'](_0x331a1f['userId'],_0x4c41fd,_0x331a1f['id']);!_0x41a6df[_0x171ad9(0x344)]?(_0x41a6df['model_name']=_0x41a6df[_0x171ad9(0x1cf)],delete _0x41a6df[_0x171ad9(0x1cf)]):delete _0x41a6df[_0x171ad9(0x1cf)];_0x41a6df[_0x171ad9(0x2bf)]?_0x476889=await this['klingTaskService']['i2v']({'data':_0x41a6df,'baseURL':_0x4c41fd[_0x171ad9(0x431)],'headers':{'Authorization':'Bearer\x20'+_0x4c41fd[_0x171ad9(0x1e5)]}}):_0x476889=await this[_0x171ad9(0x43e)]['t2v']({'data':_0x41a6df,'baseURL':_0x4c41fd['proxyUrl'],'headers':{'Authorization':_0x171ad9(0x3b3)+_0x4c41fd[_0x171ad9(0x1e5)]}});await this[_0x171ad9(0x1e8)][_0x171ad9(0x216)](_0x4c41fd['id'],0x0),_0x331a1f[_0x171ad9(0x23a)]=0x0,_0x331a1f[_0x171ad9(0x415)]=0x0,_0x331a1f[_0x171ad9(0x447)]=0x0,_0x331a1f[_0x171ad9(0x471)]=_0x476889[_0x171ad9(0x1c8)],_0x331a1f[_0x171ad9(0x3ab)]=JSON[_0x171ad9(0x302)]({'model':_0x4c41fd[_0x171ad9(0x1cf)],'parentMessageId':_0x476889['task_id']}),await this[_0x171ad9(0x223)]['saveChatLog'](_0x331a1f),common_1[_0x171ad9(0x393)][_0x171ad9(0x291)](_0x171ad9(0x300)+_0x331a1f[_0x171ad9(0x3fb)]+'\x20model:\x20'+_0x4c41fd['model']+_0x171ad9(0x423)+_0x4c41fd[_0x171ad9(0x1e5)]+_0x171ad9(0x2c8)+_0x4c41fd[_0x171ad9(0x3fa)],_0x171ad9(0x292));if(!_0x331a1f[_0x171ad9(0x471)]||_0x331a1f[_0x171ad9(0x471)]==='failed')throw new Error(_0x171ad9(0x43f));await this[_0x171ad9(0x223)][_0x171ad9(0x22c)](_0x331a1f,{'id':_0x476889[_0x171ad9(0x24e)],'state':_0x476889[_0x171ad9(0x1c8)],'completed':_0x476889['task_status']===_0x171ad9(0x45d),'videoUrl':_0x476889[_0x171ad9(0x38e)]&&_0x476889[_0x171ad9(0x38e)][_0x171ad9(0x42c)]&&_0x476889[_0x171ad9(0x38e)]['videos']['length']?_0x476889[_0x171ad9(0x38e)][_0x171ad9(0x42c)][0x0]?.[_0x171ad9(0x1fe)]:''});}catch(_0x405387){console[_0x171ad9(0x262)](_0x171ad9(0x3cc),_0x4c41fd[_0x171ad9(0x1e5)],_0x405387);const _0x3ec9df=await this[_0x171ad9(0x202)](_0x405387,_0x4c41fd);_0x331a1f[_0x171ad9(0x290)]=_0x3ec9df,await this[_0x171ad9(0x223)][_0x171ad9(0x30f)](_0x331a1f),await this['userService']['refundBalance4Video'](_0x331a1f['userId'],_0x4c41fd,_0x4b4723,_0x331a1f['id'],balance_constant_1[_0x171ad9(0x26a)][_0x171ad9(0x425)]);}}async[_0x10c797(0x2a7)](_0xe647c8,_0x8e06df){const _0x532300=_0x10c797;try{const _0x87d485=(0x0,utils_1[_0x532300(0x305)])(this[_0x532300(0x412)]);let _0x334c25=await this[_0x532300(0x1e8)][_0x532300(0x363)](model_constant_1['EModelType'][_0x532300(0x3eb)],_0xe647c8[_0x532300(0x344)]);_0x334c25['model']=_0xe647c8[_0x532300(0x344)],await this[_0x532300(0x27b)]({'prompt':_0xe647c8[_0x532300(0x2ed)],'currentRequestModel':_0x334c25,'user':_0x8e06df[_0x532300(0x443)],'count':_0xe647c8['n']});const _0x382c22=(0x0,utils_1[_0x532300(0x3f6)])(_0x8e06df),_0xd1c05d={'curIp':_0x382c22,'prompt':_0xe647c8[_0x532300(0x2ed)],'modelId':_0x334c25['id'],'modelType':model_constant_1[_0x532300(0x375)]['DRAW'],'answer':'','model':_0xe647c8['model_name'],'role':_0x532300(0x443),'userId':_0x8e06df[_0x532300(0x443)]['id'],'type':balance_constant_1[_0x532300(0x20f)][_0x532300(0x2e8)],'logType':0x1,'modelSubType':_0x334c25[_0x532300(0x342)][_0x532300(0x2a8)](),'requestParams':_0xe647c8,'requestOptions':JSON['stringify']({'options':null,'prompt':_0xe647c8[_0x532300(0x2ed)]}),'status':0x2,'saasId':_0x87d485};await this[_0x532300(0x223)][_0x532300(0x30f)](_0xd1c05d);try{await this[_0x532300(0x31f)][_0x532300(0x3a2)](_0xd1c05d[_0x532300(0x3fb)],_0x334c25,_0xd1c05d['id'],_0xe647c8['n'],balance_constant_1[_0x532300(0x26a)]['KLDraw']);const _0x432872=await this[_0x532300(0x43e)][_0x532300(0x2e1)]({'data':_0xe647c8,'baseURL':_0x334c25[_0x532300(0x431)],'headers':{'Authorization':_0x532300(0x3b3)+_0x334c25['key']}});_0xd1c05d[_0x532300(0x2db)]=_0x382c22,_0xd1c05d[_0x532300(0x471)]=_0x432872[_0x532300(0x1c8)],_0xd1c05d[_0x532300(0x35b)]=_0x432872[_0x532300(0x24e)],await this[_0x532300(0x223)][_0x532300(0x30f)](_0xd1c05d);if(!_0xd1c05d[_0x532300(0x471)]||_0xd1c05d[_0x532300(0x471)]===_0x532300(0x469))throw new Error(_0x532300(0x46e));}catch(_0x5dc494){console['log']('kling-draw-task',_0x334c25[_0x532300(0x1e5)],_0x5dc494);const _0x35a626=await this['openAiErrHandler'](_0x5dc494,_0x334c25);_0xd1c05d[_0x532300(0x290)]=_0x35a626,_0xd1c05d[_0x532300(0x408)]=0x4,await this[_0x532300(0x223)][_0x532300(0x30f)](_0xd1c05d),await this[_0x532300(0x31f)]['refundBalance4Draw'](_0xd1c05d[_0x532300(0x3fb)],_0x334c25,_0xd1c05d['id'],balance_constant_1[_0x532300(0x26a)][_0x532300(0x3a6)]);}return _0xd1c05d;}catch(_0x368493){if(_0x368493 instanceof common_1[_0x532300(0x3b2)])throw _0x368493;else throw new common_1[(_0x532300(0x3b2))](_0x368493[_0x532300(0x251)],common_1[_0x532300(0x21b)][_0x532300(0x2eb)]);}}async['jmengVideoTask'](_0x300b14){const _0x30569f=_0x10c797,{data:_0x2f0580,answerLogDTO:_0x48818e,currentRequestModel:_0x2a369e,requestBody:_0x48f710}=_0x300b14;await this[_0x30569f(0x31f)][_0x30569f(0x259)](_0x48818e['userId'],_0x2a369e,_0x48f710,_0x48818e['id'],balance_constant_1['EChangeType'][_0x30569f(0x3f8)]);try{!_0x2f0580['model_name']?(_0x2f0580[_0x30569f(0x344)]=_0x2f0580['model'],delete _0x2f0580[_0x30569f(0x1cf)]):delete _0x2f0580[_0x30569f(0x1cf)];const _0x1ff752=new openapi_1[(_0x30569f(0x253))]({'serviceName':'cv','region':_0x30569f(0x25f),'host':_0x2a369e[_0x30569f(0x431)],'accessKeyId':_0x2a369e[_0x30569f(0x1e5)],'secretKey':_0x2a369e['secret']}),_0xfd2675=_0x1ff752['createAPI'](_0x30569f(0x3d2),{'Version':_0x30569f(0x39c),'method':'POST','contentType':'json'}),_0x4ed08f={'req_key':_0x2a369e[_0x30569f(0x1cf)],'model_name':_0x2f0580[_0x30569f(0x344)],'prompt':_0x2f0580[_0x30569f(0x2ed)],'seed':_0x2f0580[_0x30569f(0x35c)],'aspect_ratio':_0x2f0580[_0x30569f(0x38f)],'image_urls':_0x2f0580[_0x30569f(0x298)]},_0x3dd72a=await _0xfd2675(_0x4ed08f);if(_0x3dd72a['code']!=0x2710)throw new Error(_0x30569f(0x374)+_0x3dd72a['message']);await this[_0x30569f(0x1e8)]['saveUseLog'](_0x2a369e['id'],0x0),_0x48818e[_0x30569f(0x35b)]=_0x3dd72a['data']['task_id'],_0x48818e[_0x30569f(0x471)]=_0x3dd72a[_0x30569f(0x408)],_0x48818e[_0x30569f(0x3ab)]=JSON[_0x30569f(0x302)]({'model':_0x2a369e[_0x30569f(0x1cf)],'parentMessageId':_0x3dd72a[_0x30569f(0x1dd)][_0x30569f(0x24e)]}),await this[_0x30569f(0x223)]['saveChatLog'](_0x48818e),await this[_0x30569f(0x223)][_0x30569f(0x22c)](_0x48818e,{'id':_0x3dd72a[_0x30569f(0x1dd)]['task_id'],'state':_0x3dd72a['status'],'completed':![],'videoUrl':''});}catch(_0x32d2a3){console['log'](_0x30569f(0x326),_0x2a369e[_0x30569f(0x1e5)],_0x32d2a3);const _0xf8c0e3=await this['openAiErrHandler'](_0x32d2a3,_0x2a369e);_0x48818e['errMsg']=_0xf8c0e3,_0x48818e[_0x30569f(0x471)]=_0x30569f(0x469),await this[_0x30569f(0x223)][_0x30569f(0x30f)](_0x48818e),await this['userService'][_0x30569f(0x2d1)](_0x48818e[_0x30569f(0x3fb)],_0x2a369e,_0x48f710,_0x48818e['id'],balance_constant_1[_0x30569f(0x26a)][_0x30569f(0x3f8)]);}}async['veoVideoTask'](_0x3e1dae){const _0x361323=_0x10c797,{data:_0x36f6e9,answerLogDTO:_0x2082d5,currentRequestModel:_0x527e88,requestBody:_0x106174}=_0x3e1dae;await this[_0x361323(0x31f)][_0x361323(0x259)](_0x2082d5[_0x361323(0x3fb)],_0x527e88,_0x106174,_0x2082d5['id'],balance_constant_1[_0x361323(0x26a)][_0x361323(0x407)]);try{let _0x694ae6;(!_0x36f6e9[_0x361323(0x24d)]||_0x36f6e9[_0x361323(0x24d)]['length']==0x0)&&delete _0x36f6e9['images'];const _0x4b49cf={..._0x36f6e9};_0x4b49cf['enhance_prompt']=!![],console[_0x361323(0x262)](_0x361323(0x203),_0x4b49cf),_0x694ae6=await this[_0x361323(0x352)][_0x361323(0x44c)]({'data':_0x4b49cf,'baseURL':_0x527e88['proxyUrl'],'headers':{'Authorization':_0x361323(0x3b3)+_0x527e88[_0x361323(0x1e5)]}}),await this[_0x361323(0x1e8)][_0x361323(0x216)](_0x527e88['id'],0x0),_0x2082d5[_0x361323(0x23a)]=0x0,_0x2082d5[_0x361323(0x415)]=0x0,_0x2082d5[_0x361323(0x447)]=0x0,_0x2082d5[_0x361323(0x471)]=_0x694ae6['status'],_0x2082d5[_0x361323(0x35b)]=_0x694ae6['id'],_0x2082d5[_0x361323(0x3ab)]=JSON[_0x361323(0x302)]({'model':_0x527e88[_0x361323(0x1cf)],'parentMessageId':_0x694ae6['id']}),await this['chatLogService'][_0x361323(0x30f)](_0x2082d5),common_1[_0x361323(0x393)]['debug']('本次调用:\x20'+_0x2082d5['userId']+_0x361323(0x397)+_0x527e88[_0x361323(0x1cf)]+'\x20key\x20->\x20'+_0x527e88[_0x361323(0x1e5)]+_0x361323(0x2c8)+_0x527e88[_0x361323(0x3fa)],_0x361323(0x292));if(!_0x2082d5[_0x361323(0x471)]||_0x2082d5[_0x361323(0x471)]===_0x361323(0x469))throw new Error('视频生成失败，没有响应');await this['chatLogService'][_0x361323(0x22c)](_0x2082d5,{'id':_0x694ae6['id'],'state':_0x694ae6[_0x361323(0x408)],'completed':_0x694ae6['status']===_0x361323(0x32f),'videoUrl':''});}catch(_0x1bfb83){console[_0x361323(0x262)]('video-task',_0x527e88[_0x361323(0x1e5)],_0x1bfb83);const _0x5bfb5b=await this[_0x361323(0x202)](_0x1bfb83,_0x527e88);_0x2082d5[_0x361323(0x290)]=_0x5bfb5b,await this[_0x361323(0x223)][_0x361323(0x30f)](_0x2082d5),await this['userService']['refundBalance4Video'](_0x2082d5[_0x361323(0x3fb)],_0x527e88,_0x106174,_0x2082d5['id'],balance_constant_1[_0x361323(0x26a)][_0x361323(0x407)]);}}async[_0x10c797(0x3b9)](_0x8bc667,_0x55f426){const _0x27415e=_0x10c797;try{const _0x201345=(0x0,utils_1['getReqSaasId'])(this[_0x27415e(0x412)]);let _0x34900a=await this['modelsService'][_0x27415e(0x363)](model_constant_1[_0x27415e(0x375)][_0x27415e(0x3eb)],_0x8bc667[_0x27415e(0x344)]);_0x34900a[_0x27415e(0x1cf)]=_0x8bc667[_0x27415e(0x344)],await this[_0x27415e(0x27b)]({'prompt':_0x8bc667[_0x27415e(0x2ed)],'currentRequestModel':_0x34900a,'user':_0x55f426['user']});const _0x134e46=(0x0,utils_1[_0x27415e(0x3f6)])(_0x55f426),_0x2fb3c7={'curIp':_0x134e46,'prompt':_0x8bc667[_0x27415e(0x2ed)],'modelId':_0x34900a['id'],'modelType':model_constant_1[_0x27415e(0x375)][_0x27415e(0x3eb)],'answer':'','model':_0x8bc667[_0x27415e(0x344)],'role':_0x27415e(0x443),'userId':_0x55f426['user']['id'],'completionTokens':0x0,'type':balance_constant_1[_0x27415e(0x20f)][_0x27415e(0x2e8)],'logType':0x1,'modelSubType':_0x34900a[_0x27415e(0x342)][_0x27415e(0x2a8)](),'requestParams':_0x8bc667,'requestOptions':JSON[_0x27415e(0x302)]({'options':null,'prompt':_0x8bc667[_0x27415e(0x2ed)]}),'status':0x2,'saasId':_0x201345};await this['chatLogService']['saveChatLog'](_0x2fb3c7);try{await this[_0x27415e(0x31f)][_0x27415e(0x3a2)](_0x2fb3c7['userId'],_0x34900a,_0x2fb3c7['id'],0x1,balance_constant_1[_0x27415e(0x26a)][_0x27415e(0x462)]);const _0x581f9a=new openapi_1[(_0x27415e(0x253))]({'serviceName':'cv','region':_0x27415e(0x25f),'host':_0x34900a[_0x27415e(0x431)],'accessKeyId':_0x34900a[_0x27415e(0x1e5)],'secretKey':_0x34900a['secret']}),_0x269e51=_0x581f9a[_0x27415e(0x384)](_0x27415e(0x371),{'Version':_0x27415e(0x39c),'method':_0x27415e(0x254),'contentType':_0x27415e(0x460)}),_0x5445f4=await _0x269e51({'req_key':_0x34900a[_0x27415e(0x1cf)],..._0x8bc667});_0x2fb3c7[_0x27415e(0x2db)]=_0x134e46;if(_0x5445f4[_0x27415e(0x1d5)]==0x2710){const _0x147472=[];let _0x3d93e3=0x0,_0xe78102=0x0;for(const _0x28d537 of _0x5445f4['data'][_0x27415e(0x2ae)]){const _0x19afa8=_0x28d537,_0x1e75ac=uuid['v4']()['slice'](0x0,0xa)+_0x27415e(0x351),_0x22dd7d=Buffer[_0x27415e(0x3f2)](_0x19afa8,'base64');_0x147472['push'](this[_0x27415e(0x1ee)][_0x27415e(0x370)]({'filename':_0x1e75ac,'buffer':_0x22dd7d}));const _0x56959b=await(0x0,image_size_1[_0x27415e(0x208)])(_0x22dd7d);_0x3d93e3=_0x56959b[_0x27415e(0x37b)],_0xe78102=_0x56959b[_0x27415e(0x3e6)];}const _0x2fbfbe=await Promise[_0x27415e(0x273)](_0x147472);_0x2fb3c7[_0x27415e(0x41d)]=JSON[_0x27415e(0x302)](_0x2fbfbe),_0x2fb3c7[_0x27415e(0x408)]=0xa,_0x2fb3c7[_0x27415e(0x2fa)]=_0x2fbfbe[_0x27415e(0x40d)](_0x17fb96=>{return{'url':_0x17fb96,'width':_0x3d93e3,'height':_0xe78102};});}else throw new Error(_0x27415e(0x46e)+_0x5445f4[_0x27415e(0x251)]);await this[_0x27415e(0x223)]['saveChatLog'](_0x2fb3c7);}catch(_0x1ae957){console[_0x27415e(0x262)](_0x27415e(0x350),_0x34900a[_0x27415e(0x1e5)],_0x1ae957);const _0x34b71c=await this[_0x27415e(0x202)](_0x1ae957,_0x34900a);_0x2fb3c7['errMsg']=_0x34b71c,_0x2fb3c7['status']=0x4,await this[_0x27415e(0x223)]['saveChatLog'](_0x2fb3c7),await this[_0x27415e(0x31f)][_0x27415e(0x25b)](_0x2fb3c7[_0x27415e(0x3fb)],_0x34900a,_0x2fb3c7['id'],balance_constant_1['EChangeType'][_0x27415e(0x462)]);}return this[_0x27415e(0x223)][_0x27415e(0x332)](_0x2fb3c7);}catch(_0x1b613d){if(_0x1b613d instanceof common_1[_0x27415e(0x3b2)])throw _0x1b613d;else throw new common_1[(_0x27415e(0x3b2))](_0x1b613d[_0x27415e(0x251)],common_1[_0x27415e(0x21b)]['BAD_REQUEST']);}}async[_0x10c797(0x26b)](_0x435252,_0xa00dd4){const _0x60ebe9=_0x10c797;try{const _0x5c2ec3=(0x0,utils_1[_0x60ebe9(0x305)])(this[_0x60ebe9(0x412)]);let _0x37cc80=await this['modelsService'][_0x60ebe9(0x363)](model_constant_1[_0x60ebe9(0x375)][_0x60ebe9(0x3eb)],_0x435252[_0x60ebe9(0x344)]);_0x37cc80['model']=_0x435252['model_name'],await this[_0x60ebe9(0x27b)]({'prompt':_0x435252[_0x60ebe9(0x2ed)],'currentRequestModel':_0x37cc80,'user':_0xa00dd4[_0x60ebe9(0x443)]});const _0x17182d=(0x0,utils_1[_0x60ebe9(0x3f6)])(_0xa00dd4),_0x26cf0c={'curIp':_0x17182d,'prompt':_0x435252['prompt'],'modelId':_0x37cc80['id'],'modelType':model_constant_1[_0x60ebe9(0x375)][_0x60ebe9(0x3eb)],'answer':'','model':_0x435252[_0x60ebe9(0x344)],'role':_0x60ebe9(0x443),'userId':_0xa00dd4[_0x60ebe9(0x443)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x60ebe9(0x20f)][_0x60ebe9(0x2e8)],'logType':0x1,'modelSubType':_0x37cc80[_0x60ebe9(0x342)]['toString'](),'requestParams':_0x435252,'requestOptions':JSON[_0x60ebe9(0x302)]({'options':null,'prompt':_0x435252['prompt']}),'status':0x2,'saasId':_0x5c2ec3};return await this[_0x60ebe9(0x223)][_0x60ebe9(0x30f)](_0x26cf0c),await this[_0x60ebe9(0x31f)][_0x60ebe9(0x3a2)](_0x26cf0c['userId'],_0x37cc80,_0x26cf0c['id'],0x1,balance_constant_1[_0x60ebe9(0x26a)][_0x60ebe9(0x462)]),setTimeout(async()=>{const _0x2c1951=_0x60ebe9;try{const _0x4c74f3=new openapi_1['Service']({'serviceName':'cv','region':'cn-north-1','host':_0x37cc80[_0x2c1951(0x431)],'accessKeyId':_0x37cc80['key'],'secretKey':_0x37cc80['secret']}),_0x21891c=_0x4c74f3[_0x2c1951(0x384)](_0x2c1951(0x371),{'Version':_0x2c1951(0x39c),'method':_0x2c1951(0x254),'contentType':_0x2c1951(0x460)}),_0x1c23ca=await _0x21891c({'req_key':_0x37cc80[_0x2c1951(0x1cf)],..._0x435252});_0x26cf0c[_0x2c1951(0x2db)]=_0x17182d;if(_0x1c23ca[_0x2c1951(0x1d5)]==0x2710){const _0x14201c=[];for(const _0x2c5c05 of _0x1c23ca[_0x2c1951(0x1dd)][_0x2c1951(0x2ae)]){const _0x1a541d=_0x2c5c05,_0x595668=uuid['v4']()[_0x2c1951(0x261)](0x0,0xa)+_0x2c1951(0x351),_0x1e29b1=Buffer[_0x2c1951(0x3f2)](_0x1a541d,_0x2c1951(0x46b));_0x14201c[_0x2c1951(0x448)](this[_0x2c1951(0x1ee)][_0x2c1951(0x370)]({'filename':_0x595668,'buffer':_0x1e29b1}));}const _0x60451=await Promise[_0x2c1951(0x273)](_0x14201c);_0x26cf0c['fileInfo']=JSON[_0x2c1951(0x302)](_0x60451),_0x26cf0c[_0x2c1951(0x2fa)]=_0x60451[_0x2c1951(0x40d)](_0x5332ef=>{return{'url':_0x5332ef};}),_0x26cf0c[_0x2c1951(0x408)]=0xa;}else throw new Error(_0x2c1951(0x46e)+_0x1c23ca[_0x2c1951(0x251)]);await this[_0x2c1951(0x223)][_0x2c1951(0x30f)](_0x26cf0c);}catch(_0x50b3fd){console[_0x2c1951(0x262)](_0x2c1951(0x350),_0x37cc80[_0x2c1951(0x1e5)],_0x50b3fd);const _0x58cacf=await this[_0x2c1951(0x202)](_0x50b3fd,_0x37cc80);_0x26cf0c['errMsg']=_0x58cacf,_0x26cf0c[_0x2c1951(0x408)]=0x4,await this[_0x2c1951(0x223)][_0x2c1951(0x30f)](_0x26cf0c),await this['userService'][_0x2c1951(0x25b)](_0x26cf0c['userId'],_0x37cc80,_0x26cf0c['id'],balance_constant_1[_0x2c1951(0x26a)][_0x2c1951(0x462)]);}},0x0),_0x26cf0c;}catch(_0x3db8b5){if(_0x3db8b5 instanceof common_1[_0x60ebe9(0x3b2)])throw _0x3db8b5;else throw new common_1[(_0x60ebe9(0x3b2))](_0x3db8b5[_0x60ebe9(0x251)],common_1['HttpStatus'][_0x60ebe9(0x2eb)]);}}async['chatMuiscTask'](_0x1d9227){const _0x2de862=_0x10c797;try{const _0x2deccb=(0x0,utils_1[_0x2de862(0x305)])(this[_0x2de862(0x412)]),{req:_0x41c453,model:_0x2c309c,modelType:_0x4c6925,datas:_0x1a7789,requestBody:_0x245910,musicTaskType:_0x49e179}=_0x1d9227;let _0x2d0ee5,_0x5e1214;const _0x25caa9=await this['getModelConfig']({'modelType':_0x4c6925});_0x2d0ee5=_0x25caa9[_0x2de862(0x27a)],_0x5e1214=_0x25caa9[_0x2de862(0x27c)];let _0x172a0a='';_0x2de862(0x2ed)in _0x1a7789&&(_0x172a0a=_0x1a7789[_0x2de862(0x2ed)]);const _0x23647c=await this[_0x2de862(0x1e8)][_0x2de862(0x337)](_0x4c6925,_0x4c6925===model_constant_1['EModelType'][_0x2de862(0x418)]?_0x2c309c:'');_0x23647c[_0x2de862(0x1cf)]=_0x2c309c,_0x5e1214['modelInfo'][_0x2de862(0x1cf)]=_0x2c309c;'prompt'in _0x1a7789&&await this[_0x2de862(0x200)]({'prompt':_0x172a0a,'currentRequestModel':_0x23647c,'user':_0x41c453[_0x2de862(0x443)]});let {id:_0x2bbe5,topN:_0x3baf0c,keyType:_0x50fb04}=_0x5e1214[_0x2de862(0x325)];const _0x2743bd=0x0,_0xb34d84=0x0,_0x1c7045=_0x2743bd+_0xb34d84,_0x160bea=(0x0,utils_1['getClientIp'])(_0x41c453),_0x36105c={'appId':_0x2d0ee5,'curIp':_0x160bea,'prompt':_0x172a0a,'modelId':_0x2bbe5,'modelType':_0x4c6925,'answer':'','model':_0x2c309c,'role':'user','userId':_0x41c453[_0x2de862(0x443)]['id'],'completionTokens':0x0,'totalTokens':_0x1c7045,'type':balance_constant_1[_0x2de862(0x20f)][_0x2de862(0x43b)],'logType':0x1,'modelSubType':'','requestParams':_0x245910||_0x1a7789,'requestOptions':JSON[_0x2de862(0x302)]({'options':null,'prompt':_0x172a0a}),'saasId':_0x2deccb},_0xf45c4f={..._0x36105c,'role':_0x2de862(0x221),'requestOptions':JSON[_0x2de862(0x302)]({'prompt':_0x172a0a,'options':{'model':_0x2c309c,'temperature':_0x3baf0c}})};await this['chatLogService'][_0x2de862(0x30f)](_0x36105c);const _0x121d48=await this[_0x2de862(0x223)]['saveChatLog'](_0xf45c4f);return await this[_0x2de862(0x31f)]['debuctBalance4Muisc'](_0x41c453[_0x2de862(0x443)]['id'],_0x121d48['id'],_0x49e179),await this[_0x2de862(0x2dd)]({'data':_0x1a7789,'currentRequestModel':_0x23647c,'answerLogDTO':_0x121d48,'musicTaskType':_0x49e179}),_0x121d48;}catch(_0x3030c6){if(_0x3030c6 instanceof common_1['HttpException'])throw _0x3030c6;else throw new common_1[(_0x2de862(0x3b2))](_0x3030c6['message'],common_1[_0x2de862(0x21b)][_0x2de862(0x2eb)]);}}async[_0x10c797(0x3df)](_0x52e21f){const _0x225f5a=_0x10c797;try{const _0x597d3e=(0x0,utils_1['getReqSaasId'])(this[_0x225f5a(0x412)]),{req:_0x5d67c7,model:_0xd3771a,modelType:_0x5bf7e,datas:_0x3db59d,requestBody:_0xeb96e}=_0x52e21f,{prompt:_0x37f26e,options:options={}}=_0x3db59d,{groupId:_0x35c78d,type:_0xd73bba}=options;let _0x26fa0e,_0x26d772,_0x166726;if(_0x5bf7e===model_constant_1[_0x225f5a(0x375)][_0x225f5a(0x418)]){const _0x3ae971=await this[_0x225f5a(0x3a8)]({'modelType':_0x5bf7e,'keyType':_0x52e21f['keyType']});_0x26fa0e=_0x3ae971[_0x225f5a(0x27a)],_0x26d772=_0x3ae971[_0x225f5a(0x27c)],_0x166726=await this[_0x225f5a(0x1e8)][_0x225f5a(0x1c6)](_0x5bf7e,parseInt(_0x52e21f[_0x225f5a(0x342)]));}else{const _0x297628=await this[_0x225f5a(0x3a8)]({'modelType':_0x5bf7e});_0x26fa0e=_0x297628['appId'],_0x26d772=_0x297628[_0x225f5a(0x27c)],_0x166726=await this[_0x225f5a(0x1e8)]['getRandomKey'](_0x5bf7e);}_0x166726['model']=_0xd3771a,_0x26d772[_0x225f5a(0x325)]['model']=_0xd3771a;_0x5bf7e===model_constant_1[_0x225f5a(0x375)]['VIDEO']?await this['validateVideoBeforeChat']({'prompt':_0x37f26e,'currentRequestModel':_0x166726,'user':_0x5d67c7[_0x225f5a(0x443)],'requestParams':_0xeb96e}):await this[_0x225f5a(0x200)]({'prompt':_0x37f26e,'currentRequestModel':_0x166726,'user':_0x5d67c7[_0x225f5a(0x443)]});let {id:_0x10bd05,topN:_0x1d3752,keyType:_0x27e4fc}=_0x26d772[_0x225f5a(0x325)];const _0x31775e=0x0,_0x4de4ab=0x0,_0x1f4e89=_0x31775e+_0x4de4ab,_0x2fcdc4=(0x0,utils_1['getClientIp'])(_0x5d67c7),_0xa3cb5e={'appId':_0x26fa0e,'curIp':_0x2fcdc4,'prompt':_0x37f26e,'groupId':_0x35c78d,'modelId':_0x10bd05,'modelType':_0x5bf7e,'answer':'','model':_0xd3771a,'role':_0x225f5a(0x443),'userId':_0x5d67c7[_0x225f5a(0x443)]['id'],'completionTokens':0x0,'totalTokens':_0x1f4e89,'type':balance_constant_1[_0x225f5a(0x20f)][_0x225f5a(0x43b)],'logType':_0xd73bba===_0x225f5a(0x260)?0x2:0x1,'modelSubType':_0x5bf7e===model_constant_1[_0x225f5a(0x375)][_0x225f5a(0x418)]?_0x27e4fc['toString']():'','requestParams':_0xeb96e||_0x3db59d,'requestOptions':JSON[_0x225f5a(0x302)]({'options':null,'prompt':_0x37f26e}),'saasId':_0x597d3e},_0x4bf3df={..._0xa3cb5e,'role':_0x225f5a(0x221),'requestOptions':JSON['stringify']({'prompt':_0x37f26e,'options':{'model':_0xd3771a,'temperature':_0x1d3752}})};await this[_0x225f5a(0x223)][_0x225f5a(0x30f)](_0xa3cb5e);const _0x5da9a6=await this[_0x225f5a(0x223)]['saveChatLog'](_0x4bf3df);if(_0x5bf7e===model_constant_1['EModelType']['VIDEO'])switch(_0x27e4fc){case 0x2:this['runwayVideoTask']({'data':_0x3db59d,'currentRequestModel':_0x166726,'answerLogDTO':_0x5da9a6,'requestBody':_0xeb96e});break;case 0x3:this[_0x225f5a(0x269)]({'data':_0x3db59d,'currentRequestModel':_0x166726,'answerLogDTO':_0x5da9a6,'requestBody':_0xeb96e});break;case 0x5:this[_0x225f5a(0x1f4)]({'data':_0x3db59d,'currentRequestModel':_0x166726,'answerLogDTO':_0x5da9a6,'requestBody':_0xeb96e});break;case 0x6:this[_0x225f5a(0x432)]({'data':_0x3db59d,'currentRequestModel':_0x166726,'answerLogDTO':_0x5da9a6,'requestBody':_0xeb96e});break;default:this[_0x225f5a(0x29e)]({'data':_0x3db59d,'currentRequestModel':_0x166726,'answerLogDTO':_0x5da9a6,'requestBody':_0xeb96e});}else await this['userService'][_0x225f5a(0x3c6)](_0x5d67c7[_0x225f5a(0x443)]['id'],_0x166726,_0x5da9a6['id']);return _0x5da9a6['modelInfo']=_0x166726[_0x225f5a(0x297)]?.[_0x225f5a(0x3f1)](_0x3553fc=>_0x3553fc[_0x225f5a(0x1fc)]==_0x5da9a6[_0x225f5a(0x1cf)]),_0x5da9a6;}catch(_0x3c90f4){console[_0x225f5a(0x262)](_0x225f5a(0x281),_0x3c90f4);if(_0x3c90f4 instanceof common_1[_0x225f5a(0x3b2)])throw _0x3c90f4;else throw new common_1['HttpException'](_0x3c90f4[_0x225f5a(0x251)],common_1[_0x225f5a(0x21b)]['BAD_REQUEST']);}}async['chatMusic'](_0x437776,_0xa57f63){const _0x3e5c7d=_0x10c797;let {mv:_0x5c28bd}=_0x437776;return!_0x437776[_0x3e5c7d(0x335)]?_0x437776[_0x3e5c7d(0x335)]=![]:_0x437776[_0x3e5c7d(0x335)]=!![],this[_0x3e5c7d(0x28d)]({'req':_0xa57f63,'datas':_0x437776,'model':_0x5c28bd||_0x3e5c7d(0x1d0),'modelType':model_constant_1[_0x3e5c7d(0x375)][_0x3e5c7d(0x1cc)],'musicTaskType':music_constant_1['EMusicTaskType'][_0x3e5c7d(0x3e5)]});}async[_0x10c797(0x21c)](_0x16e7a5,_0x536707){const _0x3b10e9=_0x10c797,_0x4f0da2={'url':_0x16e7a5};return this[_0x3b10e9(0x28d)]({'req':_0x536707,'datas':_0x4f0da2,'model':_0x3b10e9(0x1d0),'modelType':model_constant_1[_0x3b10e9(0x375)]['MUSIC'],'musicTaskType':music_constant_1['EMusicTaskType'][_0x3b10e9(0x3b7)]});}async[_0x10c797(0x383)](_0x583321,_0x47db8e){const _0x30ec44=_0x10c797;return this[_0x30ec44(0x28d)]({'req':_0x47db8e,'datas':_0x583321,'model':_0x30ec44(0x1d0),'modelType':model_constant_1[_0x30ec44(0x375)][_0x30ec44(0x1cc)],'musicTaskType':music_constant_1[_0x30ec44(0x331)][_0x30ec44(0x280)]});}async[_0x10c797(0x311)](_0x5cb8dd,_0xaa4c79){const _0x204080=_0x10c797,_0x49f60e=JSON[_0x204080(0x3b6)](JSON[_0x204080(0x302)](_0x5cb8dd));let {model:_0x3f87a0,prompt:_0x56095d,expand_prompt:_0x374d54,aspect_ratio:_0x1109e9,image_url:_0x9c1e76,image_end_url:_0x14073d}=_0x5cb8dd,_0x38b5b5=_0x204080(0x3ce)+_0x56095d+_0x204080(0x2af)+_0x374d54+_0x204080(0x36e)+_0x1109e9;return _0x9c1e76&&(_0x38b5b5=_0x38b5b5+_0x204080(0x2e9)+_0x9c1e76),_0x14073d&&(_0x38b5b5=_0x38b5b5+_0x204080(0x43a)+_0x14073d),_0x5cb8dd['prompt']=_0x38b5b5,_0x5cb8dd['user_prompt']=_0x56095d,this['chatTask']({'req':_0xaa4c79,'datas':_0x5cb8dd,'requestBody':_0x49f60e,'model':_0x3f87a0||_0x204080(0x427),'keyType':'1','modelType':model_constant_1[_0x204080(0x375)][_0x204080(0x418)]});}async[_0x10c797(0x1da)](_0x433643,_0x1f8c18){const _0x5597fe=_0x10c797,_0x1992aa=JSON[_0x5597fe(0x3b6)](JSON[_0x5597fe(0x302)](_0x433643));return this['chatTask']({'req':_0x1f8c18,'datas':_0x433643,'requestBody':_0x1992aa,'model':_0x433643[_0x5597fe(0x1cf)]||_0x5597fe(0x3a3),'keyType':'2','modelType':model_constant_1['EModelType'][_0x5597fe(0x418)]});}async['jmengChatVideo'](_0x18bace,_0x581132){const _0x3936a5=_0x10c797,_0x366667=JSON['parse'](JSON['stringify'](_0x18bace));return!_0x18bace[_0x3936a5(0x1cf)]&&(_0x18bace[_0x3936a5(0x1cf)]=_0x18bace[_0x3936a5(0x344)]),this[_0x3936a5(0x3df)]({'req':_0x581132,'datas':_0x18bace,'requestBody':_0x366667,'model':_0x18bace[_0x3936a5(0x1cf)]||_0x3936a5(0x1ca),'keyType':'5','modelType':model_constant_1['EModelType'][_0x3936a5(0x418)]});}async['klingChatVideo'](_0x14ac48,_0x125bd2){const _0x761ec0=_0x10c797,_0x2349e6=JSON[_0x761ec0(0x3b6)](JSON['stringify'](_0x14ac48));return this[_0x761ec0(0x3df)]({'req':_0x125bd2,'datas':_0x14ac48,'requestBody':_0x2349e6,'model':_0x14ac48[_0x761ec0(0x1cf)]||_0x761ec0(0x349),'keyType':'3','modelType':model_constant_1[_0x761ec0(0x375)][_0x761ec0(0x418)]});}async['veoChatVideo'](_0x32c2c3,_0x3a4120){const _0x444d26=_0x10c797,_0x484a41=JSON[_0x444d26(0x3b6)](JSON[_0x444d26(0x302)](_0x32c2c3));return this['chatTask']({'req':_0x3a4120,'datas':_0x32c2c3,'requestBody':_0x484a41,'model':_0x32c2c3[_0x444d26(0x1cf)]||_0x444d26(0x1e1),'keyType':'6','modelType':model_constant_1[_0x444d26(0x375)][_0x444d26(0x418)]});}async[_0x10c797(0x239)](){const _0x48359f=_0x10c797,_0x509596=await this[_0x48359f(0x223)]['listUndoneVideoForLuma']();if(!_0x509596[_0x48359f(0x1c7)])return;const _0x33e266=[],_0x3b68a7=new Map();_0x509596[_0x48359f(0x2cf)](_0x4afb3f=>{const _0x166995=_0x48359f;_0x33e266[_0x166995(0x448)](_0x4afb3f['id']),_0x3b68a7[_0x166995(0x409)](_0x4afb3f['id'],_0x4afb3f);});const _0x3b5108=await this['chatLogService']['listAssetsBychatLogIds'](_0x33e266),_0x45b174=[],_0x588000=new Map();_0x3b5108[_0x48359f(0x2cf)](_0x4eb956=>{const _0x3e4d50=_0x48359f;_0x45b174[_0x3e4d50(0x448)](_0x4eb956[_0x3e4d50(0x355)]),_0x588000['set'](_0x4eb956[_0x3e4d50(0x355)],_0x4eb956);});const _0x2e58c7=await this[_0x48359f(0x1e8)][_0x48359f(0x337)](model_constant_1[_0x48359f(0x375)][_0x48359f(0x418)]),_0x1fb815=await this[_0x48359f(0x46f)][_0x48359f(0x38d)]({'baseURL':_0x2e58c7[_0x48359f(0x431)],'headers':{'Authorization':_0x48359f(0x3b3)+_0x2e58c7['key']},'data':{'ids':_0x45b174}});for(let _0x121b39=0x0;_0x121b39<_0x1fb815['length'];_0x121b39++){const _0x102e40=_0x1fb815[_0x121b39],_0x542e54=_0x588000[_0x48359f(0x34c)](_0x102e40[_0x48359f(0x24e)]),_0x364f4c=_0x3b68a7[_0x48359f(0x34c)](_0x542e54[_0x48359f(0x21f)]);await this[_0x48359f(0x223)][_0x48359f(0x22c)](_0x364f4c,{'id':_0x102e40[_0x48359f(0x1dd)]['id'],'state':_0x102e40['data'][_0x48359f(0x2cc)],'completed':_0x102e40[_0x48359f(0x1dd)][_0x48359f(0x2cc)]==='completed','videoUrl':_0x102e40[_0x48359f(0x1dd)][_0x48359f(0x2c6)]?.['url']});}}async['requestFromGpt'](_0x1b0eb8){const _0x413fbc=_0x10c797,{prompt:_0x385ad9,userId:_0xe15662,abortController:_0x20c0cb}=_0x1b0eb8,_0x4fdc3e=await this[_0x413fbc(0x1e8)][_0x413fbc(0x422)](model_constant_1['EModelType'][_0x413fbc(0x35d)]),_0x190790=_0x4fdc3e[_0x413fbc(0x325)],_0x30538a=_0x4fdc3e[_0x413fbc(0x325)][_0x413fbc(0x342)];if(!_0x190790)throw new common_1[(_0x413fbc(0x3b2))](_0x413fbc(0x3d7),common_1[_0x413fbc(0x21b)][_0x413fbc(0x2eb)]);const {id:_0xa1c6bd}=_0x190790;let _0x3ee426=null,_0x53a626=null;try{const _0x12cb9d=await this['buildOptions']('','',_0x190790),_0x3171c8=await this[_0x413fbc(0x336)](_0x190790);_0x3ee426=await _0x3171c8[_0x413fbc(0x212)](_0x385ad9,{..._0x12cb9d,'abortSignal':_0x20c0cb[_0x413fbc(0x310)]});const _0x3cbeb3=(0x0,helper_1['unifiedFormattingResponse'])(_0x30538a,_0x3ee426,_0x53a626),{total_tokens:total_tokens=0x0}=_0x3cbeb3['usage'];return await this[_0x413fbc(0x1e8)][_0x413fbc(0x216)](_0xa1c6bd,total_tokens),await this[_0x413fbc(0x31f)][_0x413fbc(0x3c6)](_0xe15662,_0x190790,-0x1),_0x3ee426[_0x413fbc(0x28f)];}catch(_0xed8cdd){common_1[_0x413fbc(0x393)][_0x413fbc(0x262)](_0xed8cdd);const _0x52c353=_0xed8cdd[_0x413fbc(0x329)];console[_0x413fbc(0x262)](_0x52c353);if(_0xed8cdd[_0x413fbc(0x408)]&&_0xed8cdd['status']===0x192)throw new common_1[(_0x413fbc(0x3b2))](_0xed8cdd[_0x413fbc(0x251)],common_1['HttpStatus'][_0x413fbc(0x219)]);if(!_0x52c353)throw new common_1[(_0x413fbc(0x3b2))](_0xed8cdd[_0x413fbc(0x251)],common_1[_0x413fbc(0x21b)][_0x413fbc(0x2eb)]);let _0xe2148e=errorMessage_constant_1[_0x413fbc(0x31e)][_0x52c353]?errorMessage_constant_1[_0x413fbc(0x31e)][_0x52c353]:'服务异常、请重新试试吧！！！';_0xed8cdd?.[_0x413fbc(0x251)]['includes'](_0x413fbc(0x24b))&&Number(_0x30538a)===0x1&&(await this[_0x413fbc(0x1e8)]['lockKey'](_0xa1c6bd,_0x413fbc(0x232),-0x1),_0xe2148e='当前模型key已被封禁');_0xed8cdd?.['statusCode']===0x1ad&&_0xed8cdd['message'][_0x413fbc(0x28e)](_0x413fbc(0x3c7))&&Number(_0x30538a)===0x1&&(await this['modelsService'][_0x413fbc(0x3f9)](_0xa1c6bd,_0x413fbc(0x1ff),-0x3),_0xe2148e=_0x413fbc(0x438));_0xed8cdd?.[_0x413fbc(0x329)]===0x191&&_0xed8cdd[_0x413fbc(0x251)][_0x413fbc(0x28e)](_0x413fbc(0x2c5))&&Number(_0x30538a)===0x1&&(await this[_0x413fbc(0x1e8)][_0x413fbc(0x3f9)](_0xa1c6bd,_0x413fbc(0x231),-0x2),_0xe2148e=_0x413fbc(0x410));_0xed8cdd?.[_0x413fbc(0x329)]===0x191&&_0xed8cdd[_0x413fbc(0x251)][_0x413fbc(0x28e)](_0x413fbc(0x2ff))&&Number(_0x30538a)===0x1&&(await this[_0x413fbc(0x1e8)][_0x413fbc(0x3f9)](_0xa1c6bd,_0x413fbc(0x438),-0x2),_0xe2148e=_0x413fbc(0x34b));_0xed8cdd?.[_0x413fbc(0x329)]===0x194&&_0xed8cdd['message']['includes']('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x30538a)===0x1&&(await this[_0x413fbc(0x1e8)][_0x413fbc(0x3f9)](_0xa1c6bd,_0x413fbc(0x343),-0x4),_0xe2148e='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0xed8cdd?.[_0x413fbc(0x329)]===0x133&&_0xed8cdd['message'][_0x413fbc(0x28e)]('bad\x20response\x20status\x20code\x20307')&&Number(_0x30538a)===0x1&&(_0xe2148e='\x20！');_0x52c353===0x190&&console[_0x413fbc(0x262)](_0x413fbc(0x266),_0xed8cdd,_0xed8cdd[_0x413fbc(0x251)]);const _0x5c87f0={'message':_0xe2148e||_0x413fbc(0x2a0),'code':_0x52c353===0x191?0x191:_0x52c353||0x1f4};throw new common_1[(_0x413fbc(0x3b2))](_0x5c87f0['message'],common_1[_0x413fbc(0x21b)][_0x413fbc(0x2eb)]);}}async['chatRealTime'](_0x45c4dc,_0x41fc21,_0x28f4a4){const _0x240aec=_0x10c797;try{const {audio:_0xe144d0,voice:_0x433b68}=_0x45c4dc,_0x51b956=_0x41fc21[_0x240aec(0x3e2)],_0x143176=await this['modelsService'][_0x240aec(0x414)]();if(!_0x143176)throw _0x240aec(0x26e);const {key:_0x2a60fe,proxyUrl:_0x309119}=_0x143176;await this['userService'][_0x240aec(0x2a6)](_0x41fc21['user']),await this[_0x240aec(0x31f)][_0x240aec(0x40f)](_0x41fc21[_0x240aec(0x443)]['id'],_0x143176),console[_0x240aec(0x262)]('key\x20%s,\x20proxy\x20%s',_0x2a60fe,_0x309119),this[_0x240aec(0x26f)][_0x240aec(0x44b)]=_0x2a60fe,this[_0x240aec(0x26f)][_0x240aec(0x283)]=(_0x309119||this[_0x240aec(0x2a2)])+'/v1',this[_0x240aec(0x26f)]['timeout']=0x989680;const _0x4650a3=await this[_0x240aec(0x26f)][_0x240aec(0x1cd)]['transcriptions']['create']({'file':(0x0,fs_1[_0x240aec(0x42d)])((0x0,path_1[_0x240aec(0x295)])(_0xe144d0[_0x240aec(0x1c9)])),'model':_0x240aec(0x464),'language':'zh','response_format':_0x240aec(0x460),'temperature':0x0})[_0x240aec(0x42b)](_0x4959a3=>_0x4959a3[_0x240aec(0x28f)])[_0x240aec(0x33f)](_0x386c22=>{const _0x3677b2=_0x240aec;common_1['Logger'][_0x3677b2(0x26c)](_0x386c22);});console[_0x240aec(0x262)](_0x240aec(0x454),_0x4650a3);if(!_0x4650a3){this[_0x240aec(0x404)]((0x0,path_1[_0x240aec(0x295)])(_0xe144d0[_0x240aec(0x1c9)]));throw new common_1[(_0x240aec(0x3b2))](_0x240aec(0x328),common_1[_0x240aec(0x21b)]['BAD_REQUEST']);}await this['userService'][_0x240aec(0x3c6)](_0x41fc21['user']['id'],_0x143176,-0x1);const _0x21fff3=await this[_0x240aec(0x35a)]({'userId':_0x41fc21[_0x240aec(0x443)]['id'],'prompt':_0x4650a3,'abortController':_0x51b956});console[_0x240aec(0x262)]('request\x20gpt\x20',_0x21fff3);if(!_0x21fff3){this[_0x240aec(0x404)]((0x0,path_1['resolve'])(_0xe144d0[_0x240aec(0x1c9)]));throw new common_1[(_0x240aec(0x3b2))](_0x240aec(0x1d3),common_1[_0x240aec(0x21b)][_0x240aec(0x2eb)]);}console[_0x240aec(0x262)](_0x240aec(0x2aa),_0x21fff3[_0x240aec(0x1c7)]);let _0x24d87f=_0x21fff3[_0x240aec(0x1c7)]>0x1000?_0x21fff3[_0x240aec(0x261)](0x0,0xfff):_0x21fff3;const _0x56c0b0=await this[_0x240aec(0x26f)][_0x240aec(0x1cd)][_0x240aec(0x3db)][_0x240aec(0x44c)]({'input':_0x24d87f,'model':_0x240aec(0x22f),'response_format':_0x240aec(0x3e8),'voice':_0x433b68,'speed':0x1})[_0x240aec(0x42b)](_0x13b1dd=>_0x13b1dd[_0x240aec(0x296)]())[_0x240aec(0x33f)](_0x295b7=>{const _0x324fce=_0x240aec;common_1[_0x324fce(0x393)][_0x324fce(0x26c)](_0x295b7);});if(!_0x56c0b0){this[_0x240aec(0x404)]((0x0,path_1['resolve'])(_0xe144d0[_0x240aec(0x1c9)]));throw new common_1[(_0x240aec(0x3b2))](_0x240aec(0x3a0),common_1[_0x240aec(0x21b)][_0x240aec(0x2eb)]);}await this[_0x240aec(0x31f)][_0x240aec(0x3c6)](_0x41fc21[_0x240aec(0x443)]['id'],_0x143176,-0x1);const _0x2f55ab=Buffer['from'](_0x56c0b0);return _0x28f4a4[_0x240aec(0x2a4)](_0x240aec(0x2ab),_0x240aec(0x3ee)),_0x28f4a4[_0x240aec(0x3a7)](_0x2f55ab),_0x28f4a4[_0x240aec(0x378)](_0x2f55ab),this['removeFile']((0x0,path_1[_0x240aec(0x295)])(_0xe144d0[_0x240aec(0x1c9)])),_0x2f55ab;}catch(_0x4b1129){if(_0x4b1129 instanceof common_1[_0x240aec(0x3b2)])throw _0x4b1129;else throw new common_1[(_0x240aec(0x3b2))](_0x4b1129[_0x240aec(0x251)],common_1['HttpStatus']['BAD_REQUEST']);}}async['getImageStreamFromUrl'](_0x2dcaf5){const _0x221233=_0x10c797;try{const _0x15a3d6=await(0x0,axios_1[_0x221233(0x208)])({'url':_0x2dcaf5,'method':_0x221233(0x32c),'responseType':_0x221233(0x3b0)});return _0x15a3d6[_0x221233(0x1dd)];}catch(_0x71673e){throw new Error(_0x221233(0x2c9)+_0x2dcaf5+',\x20错误:\x20'+_0x71673e[_0x221233(0x251)]);}}async[_0x10c797(0x334)](_0x1f1f31,_0x310885,_0x37a671=balance_constant_1['EChangeType'][_0x10c797(0x339)]){const _0x36de49=_0x10c797;common_1[_0x36de49(0x393)][_0x36de49(0x262)](_0x36de49(0x2e3)+_0x1f1f31[_0x36de49(0x2ed)],_0x36de49(0x312)),await this[_0x36de49(0x270)]['checkBadWords'](_0x1f1f31['prompt'],_0x310885[_0x36de49(0x443)]['id']),await this[_0x36de49(0x31f)][_0x36de49(0x2a6)](_0x310885[_0x36de49(0x443)]);let _0x18a4b5=[];const _0x524b99=await this[_0x36de49(0x1e8)][_0x36de49(0x363)](model_constant_1[_0x36de49(0x375)][_0x36de49(0x3eb)],_0x1f1f31[_0x36de49(0x1cf)]);await this[_0x36de49(0x31f)][_0x36de49(0x25e)](_0x310885['user']['id'],_0x524b99,_0x1f1f31['n']);const {key:_0x3d279a,model:_0x5b97c3,proxyUrl:_0x5052ae}=await this[_0x36de49(0x286)](_0x524b99);let _0x20961e=_0x5052ae+_0x36de49(0x38b);_0x1f1f31['image']&&_0x1f1f31['image'][_0x36de49(0x1c7)]>0x0?_0x20961e=_0x5052ae+_0x36de49(0x386):delete _0x1f1f31['image'];try{let _0x465115;if(_0x1f1f31[_0x36de49(0x2bf)]&&_0x1f1f31['image']['length']>0x0){const _0x29e9eb=new FormData();for(let _0x390d77=0x0;_0x390d77<_0x1f1f31[_0x36de49(0x2bf)][_0x36de49(0x1c7)];_0x390d77++){const _0x2e33c2=await this[_0x36de49(0x2ad)](_0x1f1f31['image'][_0x390d77]),_0x23a23a=_0x36de49(0x29b)+_0x1f1f31[_0x36de49(0x2bf)][_0x390d77]+'-'+Date[_0x36de49(0x394)]()+'.png';_0x29e9eb['append'](_0x36de49(0x2bf),_0x2e33c2,{'filename':_0x23a23a});}_0x29e9eb[_0x36de49(0x2d8)](_0x36de49(0x2ed),_0x1f1f31[_0x36de49(0x2ed)]),_0x29e9eb[_0x36de49(0x2d8)]('n',_0x1f1f31['n'][_0x36de49(0x2a8)]()),_0x1f1f31[_0x36de49(0x2e4)]&&_0x29e9eb[_0x36de49(0x2d8)]('size',_0x1f1f31[_0x36de49(0x2e4)]),_0x1f1f31[_0x36de49(0x222)]&&_0x29e9eb['append'](_0x36de49(0x222),_0x1f1f31[_0x36de49(0x222)]),_0x29e9eb[_0x36de49(0x2d8)]('response_format',_0x36de49(0x41a)),_0x29e9eb[_0x36de49(0x2d8)](_0x36de49(0x1cf),_0x1f1f31['model']),_0x465115=await(0x0,axios_1[_0x36de49(0x208)])({'method':_0x36de49(0x28c),'url':_0x20961e,'headers':{'Authorization':_0x36de49(0x3b3)+_0x3d279a,..._0x29e9eb[_0x36de49(0x277)]()},'data':_0x29e9eb,'maxContentLength':Infinity,'maxBodyLength':Infinity});}else _0x465115=await axios_1['default']['post'](_0x20961e,{..._0x1f1f31,'model':_0x5b97c3,'response_format':'b64_json'},{'headers':{'Authorization':_0x36de49(0x3b3)+_0x3d279a}});_0x18a4b5=_0x465115[_0x36de49(0x1dd)][_0x36de49(0x1dd)];}catch(_0x299870){console[_0x36de49(0x262)](_0x36de49(0x364),_0x299870);const _0x21844b=_0x299870?.[_0x36de49(0x2b1)]?.[_0x36de49(0x408)]||0x1f4,_0x20e405=_0x299870?.[_0x36de49(0x2b1)]?.['data']?.[_0x36de49(0x26c)]?.[_0x36de49(0x251)];if(_0x21844b===0x1ad)throw new common_1[(_0x36de49(0x3b2))](_0x36de49(0x2f0),common_1[_0x36de49(0x21b)][_0x36de49(0x2eb)]);if(_0x21844b===0x190||_0x20e405[_0x36de49(0x28e)](_0x36de49(0x220)))throw new common_1[(_0x36de49(0x3b2))](_0x36de49(0x2de),common_1['HttpStatus'][_0x36de49(0x2eb)]);if(_0x21844b===0x1f4)throw new common_1[(_0x36de49(0x3b2))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x36de49(0x21b)][_0x36de49(0x2eb)]);if(_0x21844b===0x191)throw new common_1['HttpException'](_0x36de49(0x30a),common_1[_0x36de49(0x21b)][_0x36de49(0x2eb)]);throw new common_1[(_0x36de49(0x3b2))](_0x36de49(0x3ad),common_1[_0x36de49(0x21b)][_0x36de49(0x2eb)]);}const _0x37a240=[];for(const _0x5592e6 of _0x18a4b5){const _0x30fe99=_0x5592e6[_0x36de49(0x41a)][_0x36de49(0x1dc)](/^data:image\/\w+;base64,/,''),_0x3bb4e9=uuid['v4']()['slice'](0x0,0xa)+_0x36de49(0x351),_0xf07196=Buffer[_0x36de49(0x3f2)](_0x30fe99,_0x36de49(0x46b));_0x37a240[_0x36de49(0x448)](this[_0x36de49(0x1ee)]['uploadFile']({'filename':_0x3bb4e9,'buffer':_0xf07196}));}const _0xf2424c=(0x0,utils_1[_0x36de49(0x3f6)])(_0x310885),_0x3d8915=await Promise[_0x36de49(0x273)](_0x37a240);let _0x41b55c='',_0x23c43b='';if(_0x1f1f31[_0x36de49(0x2e4)])[_0x41b55c,_0x23c43b]=_0x1f1f31[_0x36de49(0x2e4)][_0x36de49(0x419)]('x');else _0x1f1f31[_0x36de49(0x222)]&&([_0x41b55c,_0x23c43b]=_0x1f1f31[_0x36de49(0x222)][_0x36de49(0x419)]('x'));const _0x3c5c02=_0x3d8915[_0x36de49(0x40d)](_0x5c30ba=>{const _0x253866=_0x36de49;return this[_0x253866(0x223)][_0x253866(0x30f)]({'curIp':_0xf2424c,'logType':0x3,'answer':_0x5c30ba,'totalTokens':0x0,'promptTokens':0x0,'model':_0x1f1f31['model'],'userId':_0x310885['user']['id'],'prompt':_0x1f1f31['prompt'],'completionTokens':0x0,'modelSubType':_0x37a671==balance_constant_1[_0x253866(0x26a)][_0x253866(0x339)]?'1':_0x37a671==balance_constant_1[_0x253866(0x26a)][_0x253866(0x391)]?'4':'5','modelType':model_constant_1[_0x253866(0x375)][_0x253866(0x3eb)],'type':balance_constant_1[_0x253866(0x20f)][_0x253866(0x2e8)],'fileInfo':JSON[_0x253866(0x302)]({'width':_0x41b55c,'height':_0x23c43b,'cosUrl':_0x5c30ba}),'status':0xa,'requestParams':_0x1f1f31,'responseResult':[{'width':_0x41b55c,'height':_0x23c43b,'url':_0x5c30ba}]});}),_0xd00d4b=await Promise[_0x36de49(0x273)](_0x3c5c02);return console[_0x36de49(0x262)](_0x36de49(0x413),_0x3d8915),await this[_0x36de49(0x31f)][_0x36de49(0x3a2)](_0x310885[_0x36de49(0x443)]['id'],_0x524b99,_0xd00d4b[0x0]['id'],_0x1f1f31['n'],_0x37a671),_0x3d8915;}async[_0x10c797(0x267)](_0x29cf79,_0x54c185,_0x28f450=balance_constant_1[_0x10c797(0x26a)][_0x10c797(0x339)]){const _0x569685=_0x10c797;await this[_0x569685(0x270)][_0x569685(0x3be)](_0x29cf79[_0x569685(0x2ed)],_0x54c185[_0x569685(0x443)]['id']),await this[_0x569685(0x31f)][_0x569685(0x2a6)](_0x54c185['user']);const _0x1b7aef=await this[_0x569685(0x1e8)]['getModelChild'](model_constant_1[_0x569685(0x375)][_0x569685(0x3eb)],_0x29cf79[_0x569685(0x1cf)]);await this[_0x569685(0x31f)][_0x569685(0x25e)](_0x54c185['user']['id'],_0x1b7aef,_0x29cf79['n']);const _0x4bd580=await this[_0x569685(0x223)][_0x569685(0x30f)]({'curIp':_0x54c185['ip'],'logType':0x3,'answer':'','model':_0x29cf79[_0x569685(0x1cf)],'userId':_0x54c185[_0x569685(0x443)]['id'],'prompt':_0x29cf79['prompt'],'modelSubType':_0x28f450==balance_constant_1[_0x569685(0x26a)][_0x569685(0x339)]?'1':_0x28f450==balance_constant_1[_0x569685(0x26a)][_0x569685(0x391)]?'4':'5','modelType':model_constant_1[_0x569685(0x375)][_0x569685(0x3eb)],'type':balance_constant_1[_0x569685(0x20f)][_0x569685(0x2e8)],'status':0x2,'requestParams':_0x29cf79});return await this['userService'][_0x569685(0x3a2)](_0x54c185[_0x569685(0x443)]['id'],_0x1b7aef,_0x4bd580['id'],_0x29cf79['n'],_0x28f450),setTimeout(async()=>{const _0x53d564=_0x569685;let _0x5b56cb=[];const {key:_0x292538,model:_0x5dcece,proxyUrl:_0x5b840e}=await this[_0x53d564(0x286)](_0x1b7aef);let _0x11e760=_0x5b840e+_0x53d564(0x38b);_0x29cf79[_0x53d564(0x2bf)]&&_0x29cf79[_0x53d564(0x2bf)]['length']>0x0?_0x11e760=_0x5b840e+_0x53d564(0x386):delete _0x29cf79[_0x53d564(0x2bf)];console[_0x53d564(0x262)](_0x53d564(0x38c));try{let _0x6660ef;if(_0x29cf79['image']&&_0x29cf79[_0x53d564(0x2bf)]['length']>0x0){const _0x5a7f77=new FormData();for(let _0x89665c=0x0;_0x89665c<_0x29cf79[_0x53d564(0x2bf)]['length'];_0x89665c++){const _0x49ed89=await this[_0x53d564(0x2ad)](_0x29cf79[_0x53d564(0x2bf)][_0x89665c]),_0x535336=_0x53d564(0x29b)+_0x29cf79[_0x53d564(0x2bf)][_0x89665c]+'-'+Date[_0x53d564(0x394)]()+_0x53d564(0x351);_0x5a7f77['append'](_0x53d564(0x2bf),_0x49ed89,{'filename':_0x535336});}_0x5a7f77[_0x53d564(0x2d8)]('prompt',_0x29cf79[_0x53d564(0x2ed)]),_0x5a7f77[_0x53d564(0x2d8)]('n',_0x29cf79['n'][_0x53d564(0x2a8)]()),_0x29cf79['size']&&_0x5a7f77[_0x53d564(0x2d8)](_0x53d564(0x2e4),_0x29cf79[_0x53d564(0x2e4)]),_0x29cf79['style']&&_0x5a7f77[_0x53d564(0x2d8)](_0x53d564(0x222),_0x29cf79['style']),_0x5a7f77[_0x53d564(0x2d8)](_0x53d564(0x271),_0x53d564(0x41a)),_0x5a7f77[_0x53d564(0x2d8)]('model',_0x29cf79['model']),_0x6660ef=await(0x0,axios_1[_0x53d564(0x208)])({'method':_0x53d564(0x28c),'url':_0x11e760,'headers':{'Authorization':_0x53d564(0x3b3)+_0x292538,..._0x5a7f77[_0x53d564(0x277)]()},'timeout':0x927c0,'data':_0x5a7f77,'maxContentLength':Infinity,'maxBodyLength':Infinity});}else console[_0x53d564(0x262)](_0x53d564(0x365)),_0x6660ef=await axios_1[_0x53d564(0x208)][_0x53d564(0x28c)](_0x11e760,{..._0x29cf79,'model':_0x5dcece,'response_format':_0x53d564(0x41a)},{'headers':{'Authorization':'Bearer\x20'+_0x292538},'timeout':0x927c0});console[_0x53d564(0x262)](_0x53d564(0x472),_0x6660ef),_0x5b56cb=_0x6660ef['data'][_0x53d564(0x1dd)];const _0x4ff092=[];for(const _0x2d7cab of _0x5b56cb){const _0x4bf8e5=_0x2d7cab[_0x53d564(0x41a)][_0x53d564(0x1dc)](/^data:image\/\w+;base64,/,''),_0x178a4e=uuid['v4']()[_0x53d564(0x261)](0x0,0xa)+_0x53d564(0x351),_0x15f521=Buffer[_0x53d564(0x3f2)](_0x4bf8e5,'base64');_0x4ff092[_0x53d564(0x448)](this[_0x53d564(0x1ee)]['uploadFile']({'filename':_0x178a4e,'buffer':_0x15f521}));}const _0x249073=await Promise[_0x53d564(0x273)](_0x4ff092);let _0x36e879='',_0x332647='';if(_0x29cf79[_0x53d564(0x2e4)])[_0x36e879,_0x332647]=_0x29cf79[_0x53d564(0x2e4)][_0x53d564(0x419)]('x');else _0x29cf79[_0x53d564(0x222)]&&([_0x36e879,_0x332647]=_0x29cf79[_0x53d564(0x222)][_0x53d564(0x419)]('x'));const _0x5e0ea3=_0x249073['map'](_0x6e235c=>{return{'width':_0x36e879,'height':_0x332647,'url':_0x6e235c};});_0x4bd580[_0x53d564(0x2fa)]=_0x5e0ea3,_0x4bd580[_0x53d564(0x408)]=0xa,this[_0x53d564(0x223)][_0x53d564(0x30f)](_0x4bd580),console['log'](_0x53d564(0x472),_0x4bd580);}catch(_0x473f84){_0x4bd580[_0x53d564(0x290)]=_0x53d564(0x26c),_0x4bd580[_0x53d564(0x408)]=0x4,this[_0x53d564(0x223)][_0x53d564(0x30f)](_0x4bd580),await this[_0x53d564(0x31f)][_0x53d564(0x25b)](_0x54c185[_0x53d564(0x443)]['id'],_0x1b7aef,_0x4bd580['id'],_0x28f450);}},0x0),_0x4bd580;}async[_0x10c797(0x286)](_0x5eb59f){const _0x1242b9=_0x10c797,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x1242b9(0x411)]['getConfigByKeys'](['openaiModel3MaxTokens',_0x1242b9(0x44d),_0x1242b9(0x437),_0x1242b9(0x315),_0x1242b9(0x379),_0x1242b9(0x2ea),_0x1242b9(0x306),'openaiModel4MaxTokens32kRes',_0x1242b9(0x466)]);let _0x47194f=null,_0x376de1=null,_0x4d7042=null;const {model:_0x25802d,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x1d5437,key:_0xe9491b}=_0x5eb59f;return _0x25802d[_0x1242b9(0x417)]()['includes'](_0x1242b9(0x32e))&&(_0x25802d[_0x1242b9(0x417)]()[_0x1242b9(0x28e)]('32k')?(_0x47194f=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x376de1=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x47194f=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x376de1=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x25802d[_0x1242b9(0x417)]()[_0x1242b9(0x28e)]('gpt-3')&&(_0x25802d[_0x1242b9(0x417)]()[_0x1242b9(0x28e)](_0x1242b9(0x451))?(_0x47194f=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x376de1=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x47194f=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x376de1=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x4d7042=_0x1d5437||openaiBaseUrl||'https://api.openai.com',_0x376de1>=_0x47194f&&(_0x376de1=Math[_0x1242b9(0x2b8)](_0x47194f/0x2),common_1[_0x1242b9(0x393)][_0x1242b9(0x291)](_0x1242b9(0x243)+_0xe9491b+_0x1242b9(0x3dc)+_0x376de1)),{'key':_0xe9491b,'model':_0x25802d,'maxToken':_0x47194f,'maxTokenRes':_0x376de1,'proxyUrl':_0x4d7042};}async['asyncPPTProgress'](_0x96a5a8){const _0x1c9983=_0x10c797;try{const _0x2aa577=await this['pptService']['pptResult'](_0x96a5a8),_0x58b3c5=await this['pptTaskEntity'][_0x1c9983(0x2b6)]({'where':{'yooTaskId':_0x96a5a8['params']['id']}});if(!_0x58b3c5)throw new Error(_0x1c9983(0x2f3));_0x58b3c5[_0x1c9983(0x408)]=_0x2aa577[_0x1c9983(0x1dd)][_0x1c9983(0x408)],_0x58b3c5[_0x1c9983(0x36b)]=_0x2aa577[_0x1c9983(0x1dd)][_0x1c9983(0x1e7)],_0x58b3c5['progress']=_0x2aa577[_0x1c9983(0x1dd)]['progress'],_0x58b3c5[_0x1c9983(0x2e0)]=_0x2aa577[_0x1c9983(0x1dd)][_0x1c9983(0x382)],_0x58b3c5[_0x1c9983(0x387)]=_0x2aa577[_0x1c9983(0x1dd)]['page_count'],_0x58b3c5[_0x1c9983(0x2f9)]=_0x2aa577[_0x1c9983(0x1dd)][_0x1c9983(0x2bb)],_0x58b3c5[_0x1c9983(0x24d)]=_0x2aa577[_0x1c9983(0x1dd)][_0x1c9983(0x45c)],_0x58b3c5['startTime']=_0x2aa577[_0x1c9983(0x1dd)]['created_at'],_0x58b3c5[_0x1c9983(0x41f)]=_0x2aa577['data'][_0x1c9983(0x206)],_0x58b3c5[_0x1c9983(0x21d)]=_0x2aa577['data'][_0x1c9983(0x2be)],await this['pptTaskEntity'][_0x1c9983(0x249)](_0x58b3c5);}catch(_0x20f259){common_1[_0x1c9983(0x393)][_0x1c9983(0x26c)](_0x20f259[_0x1c9983(0x251)],_0x1c9983(0x3bb));}}async[_0x10c797(0x35e)](_0x934e03,_0x365ed7){const _0x284a36=_0x10c797;try{return this[_0x284a36(0x31c)]['transaction'](async()=>{const _0x3b5188=_0x284a36,_0x4256c3=await this[_0x3b5188(0x1e8)][_0x3b5188(0x422)](model_constant_1[_0x3b5188(0x375)][_0x3b5188(0x23d)]);let _0x8b373b={'userId':_0x934e03[_0x3b5188(0x443)]['id'],'type':ppt_constant_1[_0x3b5188(0x3d4)][_0x3b5188(0x359)],'title':_0x365ed7['title'],'text':_0x365ed7['text'],'theme':_0x365ed7[_0x3b5188(0x3c4)]};_0x8b373b=await this[_0x3b5188(0x39d)][_0x3b5188(0x249)](_0x8b373b),await this[_0x3b5188(0x31f)][_0x3b5188(0x3e0)](_0x934e03['user']['id'],_0x8b373b['id'],_0x8b373b[_0x3b5188(0x3ed)]);const _0xa503fa=await this[_0x3b5188(0x27e)][_0x3b5188(0x35e)]({'data':_0x365ed7,'baseURL':_0x4256c3[_0x3b5188(0x325)]['proxyUrl'],'headers':{'Authorization':_0x3b5188(0x3b3)+_0x4256c3['modelInfo'][_0x3b5188(0x2ac)]}});return _0x8b373b[_0x3b5188(0x1e0)]=_0xa503fa[_0x3b5188(0x1dd)][_0x3b5188(0x1e0)],_0x8b373b[_0x3b5188(0x308)]=_0xa503fa[_0x3b5188(0x1dd)][_0x3b5188(0x308)],await this['pptTaskEntity']['save'](_0x8b373b),_0x8b373b;});}catch(_0x23eb80){throw new common_1['HttpException'](_0x23eb80['message'],common_1[_0x284a36(0x21b)][_0x284a36(0x2eb)]);}}async[_0x10c797(0x45b)](_0x441f3f,_0x15a132){const _0x20ca66=_0x10c797,_0x43aaa5=await this['pptTaskEntity']['findOne']({'where':{'id':_0x15a132}});if(!_0x43aaa5)throw new common_1[(_0x20ca66(0x3b2))]('PPT不存在',common_1[_0x20ca66(0x21b)][_0x20ca66(0x2eb)]);await this[_0x20ca66(0x31f)][_0x20ca66(0x3e0)](_0x441f3f[_0x20ca66(0x443)]['id'],_0x43aaa5['id'],ppt_constant_1[_0x20ca66(0x3d4)]['EDITOR']);const _0xbbbe7b=await this[_0x20ca66(0x1e8)]['getModelByType'](model_constant_1['EModelType'][_0x20ca66(0x23d)]),_0x19956b=await this[_0x20ca66(0x27e)][_0x20ca66(0x1f2)]({'baseURL':_0xbbbe7b[_0x20ca66(0x325)][_0x20ca66(0x431)],'headers':{'Authorization':_0x20ca66(0x238)+_0xbbbe7b[_0x20ca66(0x325)]['accessToken']},'data':{'id':_0x43aaa5['yooTaskId'],'expire':0x83d600}});return _0x19956b['code']==_0x20ca66(0x2d0)&&_0x19956b[_0x20ca66(0x1dd)][_0x20ca66(0x1fe)]&&(_0x43aaa5[_0x20ca66(0x2e2)]=_0x19956b[_0x20ca66(0x1dd)][_0x20ca66(0x1fe)],await this[_0x20ca66(0x39d)][_0x20ca66(0x41e)]({'id':_0x43aaa5['id']},{'editorUrl':_0x43aaa5[_0x20ca66(0x2e2)]})),_0x43aaa5;}async['pptDownload'](_0xbddd74,_0x1b8c5f){const _0x24e950=_0x10c797,_0x2174ac=await this[_0x24e950(0x39d)][_0x24e950(0x2b6)]({'where':{'id':_0x1b8c5f}});if(!_0x2174ac)throw new common_1[(_0x24e950(0x3b2))](_0x24e950(0x3dd),common_1[_0x24e950(0x21b)][_0x24e950(0x2eb)]);await this['userService'][_0x24e950(0x3e0)](_0xbddd74[_0x24e950(0x443)]['id'],_0x2174ac['id'],ppt_constant_1['EPPTTaskType'][_0x24e950(0x2c1)]);const _0xb360f3=await this['modelsService']['getModelByType'](model_constant_1[_0x24e950(0x375)][_0x24e950(0x23d)]),_0x398b18=await this[_0x24e950(0x27e)][_0x24e950(0x25d)]({'baseURL':_0xb360f3[_0x24e950(0x325)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0xb360f3[_0x24e950(0x325)][_0x24e950(0x2ac)]},'params':{'id':_0x2174ac['yooTaskId'],'type':_0x24e950(0x470)}});return _0x398b18['code']==_0x24e950(0x2d0)&&_0x398b18[_0x24e950(0x1dd)][_0x24e950(0x346)]&&(_0x2174ac[_0x24e950(0x2f9)]=_0x398b18[_0x24e950(0x1dd)][_0x24e950(0x346)],await this[_0x24e950(0x39d)][_0x24e950(0x41e)]({'id':_0x2174ac['id']},{'downUrl':_0x2174ac['downUrl']})),_0x2174ac;}[_0x10c797(0x316)](_0x57126a,_0x6bbebf){const _0x13fb60=_0x10c797;try{return this[_0x13fb60(0x31c)][_0x13fb60(0x3d8)](async()=>{const _0x6f0708=_0x13fb60,_0x1b012d=await this[_0x6f0708(0x1e8)][_0x6f0708(0x422)](model_constant_1[_0x6f0708(0x375)][_0x6f0708(0x23d)]);let _0x42efb5={'userId':_0x57126a[_0x6f0708(0x443)]['id'],'type':ppt_constant_1[_0x6f0708(0x3d4)]['COVER'],'title':_0x6bbebf[_0x6f0708(0x1e0)],'text':_0x6bbebf[_0x6f0708(0x28f)],'author':_0x6bbebf[_0x6f0708(0x275)],'color':_0x6bbebf[_0x6f0708(0x317)],'style':_0x6bbebf[_0x6f0708(0x222)]};_0x42efb5=await this[_0x6f0708(0x39d)]['save'](_0x42efb5),await this[_0x6f0708(0x31f)][_0x6f0708(0x3e0)](_0x57126a[_0x6f0708(0x443)]['id'],_0x42efb5['id'],_0x42efb5[_0x6f0708(0x3ed)]);const _0x15a947=await this[_0x6f0708(0x27e)][_0x6f0708(0x316)]({'data':{'title':_0x6bbebf[_0x6f0708(0x1e0)],'count':_0x6bbebf[_0x6f0708(0x28f)],'user_name':_0x6bbebf[_0x6f0708(0x275)],'color':_0x6bbebf[_0x6f0708(0x317)],'style':_0x6bbebf[_0x6f0708(0x222)]},'baseURL':_0x1b012d[_0x6f0708(0x325)][_0x6f0708(0x431)],'headers':{'Authorization':_0x6f0708(0x238)+_0x1b012d['modelInfo'][_0x6f0708(0x2ac)]}});return _0x42efb5[_0x6f0708(0x21e)]=_0x15a947[_0x6f0708(0x1dd)],await this[_0x6f0708(0x39d)][_0x6f0708(0x249)](_0x42efb5),_0x42efb5;});}catch(_0x27916c){throw new common_1[(_0x13fb60(0x3b2))](_0x27916c[_0x13fb60(0x251)],common_1[_0x13fb60(0x21b)][_0x13fb60(0x2eb)]);}}[_0x10c797(0x2fb)](_0x50c12b,_0x5b84d6){const _0x5dc67b=_0x10c797;try{return this[_0x5dc67b(0x31c)][_0x5dc67b(0x3d8)](async()=>{const _0x62ab94=_0x5dc67b,_0x41211b=await this['modelsService'][_0x62ab94(0x422)](model_constant_1['EModelType'][_0x62ab94(0x23d)]);let _0x388556={'userId':_0x50c12b[_0x62ab94(0x443)]['id'],'type':ppt_constant_1['EPPTTaskType']['RECOVER'],'title':_0x5b84d6[_0x62ab94(0x1e0)],'text':_0x5b84d6['text'],'author':_0x5b84d6[_0x62ab94(0x275)],'coverId':_0x5b84d6[_0x62ab94(0x3c9)]};_0x388556=await this[_0x62ab94(0x39d)][_0x62ab94(0x249)](_0x388556),await this[_0x62ab94(0x31f)][_0x62ab94(0x3e0)](_0x50c12b['user']['id'],_0x388556['id'],_0x388556[_0x62ab94(0x3ed)]);const _0x44b25c=await this[_0x62ab94(0x27e)][_0x62ab94(0x2fb)]({'data':{'title':_0x5b84d6[_0x62ab94(0x1e0)],'count':_0x5b84d6[_0x62ab94(0x28f)],'user_name':_0x5b84d6['author'],'cover_id':_0x5b84d6[_0x62ab94(0x3c9)]},'baseURL':_0x41211b[_0x62ab94(0x325)][_0x62ab94(0x431)],'headers':{'Authorization':'Beare\x20'+_0x41211b[_0x62ab94(0x325)]['accessToken']}});return _0x388556['resCover']=_0x44b25c[_0x62ab94(0x1dd)],await this['pptTaskEntity'][_0x62ab94(0x249)](_0x388556),_0x388556;});}catch(_0x38a07d){throw new common_1[(_0x5dc67b(0x3b2))](_0x38a07d[_0x5dc67b(0x251)],common_1['HttpStatus'][_0x5dc67b(0x2eb)]);}}async['pptConfig'](_0x31db7d){const _0xf56cf6=_0x10c797;try{const _0x5cebce=[_0xf56cf6(0x3d9),_0xf56cf6(0x31b),_0xf56cf6(0x455),_0xf56cf6(0x2bc),_0xf56cf6(0x3a5),_0xf56cf6(0x399),_0xf56cf6(0x29c)],_0x4b0d2f=await this['globalConfigService']['getConfigByKeys'](_0x5cebce);if(!_0x31db7d[_0xf56cf6(0x443)]||!_0x31db7d['user']['id'])throw new Error(_0xf56cf6(0x264));const _0x5040f9=[_0xf56cf6(0x3f4),_0xf56cf6(0x3d0),'pptEditor'],_0x2d2fce=await Promise[_0xf56cf6(0x273)](_0x5040f9['map'](async _0x532f81=>{const _0x1bf36e=_0xf56cf6,_0x218e23=_0x4b0d2f[_0x532f81+_0x1bf36e(0x426)],_0x5e9f2a=_0x4b0d2f[_0x532f81+_0x1bf36e(0x26d)],_0x452785=redisKey_constant_1['VIP_FREE']+'-'+_0x31db7d[_0x1bf36e(0x443)]['id']+'-'+(_0x532f81+'VipFree'),_0x545f7f=await this[_0x1bf36e(0x31f)][_0x1bf36e(0x24c)](_0x31db7d[_0x1bf36e(0x443)]['id'],_0x452785,_0x218e23);return{'type':_0x532f81,'remainCount':_0x545f7f,'freeCount':Number(_0x218e23),'useIntegrate':Number(_0x5e9f2a),'userType':_0x4b0d2f['pptUserType'],'isVipUsed':_0x4b0d2f[_0x1bf36e(0x29c)]?!![]:![]};}));return _0x2d2fce;}catch(_0x1957ce){console[_0xf56cf6(0x26c)]('Error\x20in\x20pptConfig:',_0x1957ce);throw _0x1957ce;}}[_0x10c797(0x3d0)](_0x32716d,_0x5301f5){const _0x4f2342=_0x10c797;try{return this[_0x4f2342(0x31c)][_0x4f2342(0x3d8)](async()=>{const _0x2e54aa=_0x4f2342;let _0x3faf28;const _0x486130=await this['modelsService'][_0x2e54aa(0x422)](model_constant_1[_0x2e54aa(0x375)][_0x2e54aa(0x23d)]);if(_0x5301f5[_0x2e54aa(0x388)]){_0x3faf28=await this[_0x2e54aa(0x39d)][_0x2e54aa(0x2b6)]({'where':{'id':_0x5301f5[_0x2e54aa(0x388)]}});if(!_0x3faf28)throw new Error(_0x2e54aa(0x3b4));}let _0x4c9d72={'userId':_0x32716d['user']['id'],'type':ppt_constant_1[_0x2e54aa(0x3d4)][_0x2e54aa(0x3e5)],'title':_0x5301f5[_0x2e54aa(0x1e0)],'subTitle':_0x5301f5[_0x2e54aa(0x3d6)],'text':_0x5301f5[_0x2e54aa(0x28f)],'catalogs':_0x5301f5[_0x2e54aa(0x308)],'contents':_0x5301f5[_0x2e54aa(0x293)],'author':_0x5301f5[_0x2e54aa(0x275)],'fontName':_0x5301f5[_0x2e54aa(0x217)],'transition':_0x5301f5[_0x2e54aa(0x250)],'complex':_0x5301f5[_0x2e54aa(0x279)],'coverId':_0x5301f5[_0x2e54aa(0x3c9)],'originId':_0x5301f5[_0x2e54aa(0x388)]};_0x4c9d72=await this[_0x2e54aa(0x39d)]['save'](_0x4c9d72),await this['userService'][_0x2e54aa(0x3e0)](_0x32716d[_0x2e54aa(0x443)]['id'],_0x4c9d72['id'],_0x4c9d72[_0x2e54aa(0x3ed)]);try{const _0xe92d85=await this[_0x2e54aa(0x27e)][_0x2e54aa(0x3d0)]({'data':{'text':_0x5301f5[_0x2e54aa(0x28f)],'custom_data':{'title':_0x5301f5[_0x2e54aa(0x1e0)],'sub_title':_0x5301f5[_0x2e54aa(0x3d6)],'author':_0x5301f5[_0x2e54aa(0x275)],'catalogs':_0x5301f5[_0x2e54aa(0x308)],'contents':_0x5301f5[_0x2e54aa(0x293)]},'cover_id':_0x5301f5['coverId'],'font_name':_0x5301f5[_0x2e54aa(0x217)],'transition':_0x5301f5['transition'],'complex':_0x5301f5[_0x2e54aa(0x279)],'user_name':_0x5301f5['author'],'id':_0x3faf28?.['yooTaskId']},'baseURL':_0x486130[_0x2e54aa(0x325)]['proxyUrl'],'headers':{'Authorization':_0x2e54aa(0x238)+_0x486130[_0x2e54aa(0x325)][_0x2e54aa(0x2ac)]}});return _0x4c9d72[_0x2e54aa(0x457)]=_0xe92d85[_0x2e54aa(0x1dd)]['id'],await this[_0x2e54aa(0x39d)][_0x2e54aa(0x249)](_0x4c9d72),_0x4c9d72;}catch(_0x2594e1){await this[_0x2e54aa(0x31f)][_0x2e54aa(0x3e0)](_0x32716d[_0x2e54aa(0x443)]['id'],_0x4c9d72['id'],_0x4c9d72[_0x2e54aa(0x3ed)],!![]);throw new common_1[(_0x2e54aa(0x3b2))](_0x2594e1['message'],common_1['HttpStatus']['BAD_REQUEST']);}});}catch(_0xbc3c6c){throw new common_1[(_0x4f2342(0x3b2))](_0xbc3c6c[_0x4f2342(0x251)],common_1[_0x4f2342(0x21b)]['BAD_REQUEST']);}}[_0x10c797(0x36c)](_0x4755c0,_0x213b46){const _0x3c3f75=_0x10c797;try{return this[_0x3c3f75(0x31c)][_0x3c3f75(0x3d8)](async()=>{const _0x4bf2e2=_0x3c3f75,_0x35c518=await this['modelsService'][_0x4bf2e2(0x422)](model_constant_1[_0x4bf2e2(0x375)]['PPT']);let _0x3457fc={'userId':_0x4755c0['user']['id'],'type':ppt_constant_1[_0x4bf2e2(0x3d4)][_0x4bf2e2(0x2f2)],'title':_0x213b46[_0x4bf2e2(0x1e0)],'color':_0x213b46[_0x4bf2e2(0x317)],'style':_0x213b46[_0x4bf2e2(0x222)],'fileUrl':_0x213b46['fileUrl'],'pleader':_0x213b46[_0x4bf2e2(0x225)],'advisor':_0x213b46[_0x4bf2e2(0x3bf)],'school':_0x213b46[_0x4bf2e2(0x45f)],'schoolLogo':_0x213b46[_0x4bf2e2(0x321)],'schoolPicture':_0x213b46[_0x4bf2e2(0x36f)]};_0x3457fc=await this['pptTaskEntity'][_0x4bf2e2(0x249)](_0x3457fc),await this['userService'][_0x4bf2e2(0x3e0)](_0x4755c0['user']['id'],_0x3457fc['id'],_0x3457fc[_0x4bf2e2(0x3ed)]);const _0x147dc6=await this[_0x4bf2e2(0x27e)]['pptCreateThesis']({'data':{'file_key':_0x213b46[_0x4bf2e2(0x449)],'title':_0x213b46[_0x4bf2e2(0x1e0)],'color':_0x213b46['color'],'style':_0x213b46[_0x4bf2e2(0x222)],'pleader':_0x213b46[_0x4bf2e2(0x225)],'advisor':_0x213b46[_0x4bf2e2(0x3bf)],'school':_0x213b46[_0x4bf2e2(0x45f)],'school_logo':_0x213b46[_0x4bf2e2(0x321)],'school_picture':_0x213b46[_0x4bf2e2(0x36f)]},'baseURL':_0x35c518[_0x4bf2e2(0x325)][_0x4bf2e2(0x431)],'headers':{'Authorization':_0x4bf2e2(0x238)+_0x35c518['modelInfo'][_0x4bf2e2(0x2ac)]}});return _0x3457fc['yooTaskId']=_0x147dc6['data']['id'],await this['pptTaskEntity'][_0x4bf2e2(0x249)](_0x3457fc),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x35c518[_0x4bf2e2(0x325)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x35c518[_0x4bf2e2(0x325)][_0x4bf2e2(0x2ac)]},'params':{'id':_0x3457fc['yooTaskId']}}),0xbb8),_0x3457fc;});}catch(_0x32fccd){throw new common_1[(_0x3c3f75(0x3b2))](_0x32fccd[_0x3c3f75(0x251)],common_1[_0x3c3f75(0x21b)]['BAD_REQUEST']);}}[_0x10c797(0x1f0)](_0x3a480f,_0x358820){const _0x2ce78c=_0x10c797;try{return this[_0x2ce78c(0x31c)][_0x2ce78c(0x3d8)](async()=>{const _0x480170=_0x2ce78c,_0x4725cb=await this[_0x480170(0x1e8)][_0x480170(0x422)](model_constant_1[_0x480170(0x375)][_0x480170(0x23d)]);let _0x1462c4={'userId':_0x3a480f[_0x480170(0x443)]['id'],'type':ppt_constant_1['EPPTTaskType']['FILE'],'fileUrl':_0x358820[_0x480170(0x449)],'coverId':_0x358820[_0x480170(0x3c9)],'author':_0x358820[_0x480170(0x275)]};_0x1462c4=await this['pptTaskEntity'][_0x480170(0x249)](_0x1462c4),await this[_0x480170(0x31f)][_0x480170(0x3e0)](_0x3a480f[_0x480170(0x443)]['id'],_0x1462c4['id'],_0x1462c4['type']);const _0x4d1046=await this['pptService'][_0x480170(0x1f0)]({'data':{'file_url':_0x358820['fileUrl'],'cover_id':_0x358820[_0x480170(0x3c9)],'user_name':_0x358820[_0x480170(0x275)]},'baseURL':_0x4725cb[_0x480170(0x325)][_0x480170(0x431)],'headers':{'Authorization':_0x480170(0x238)+_0x4725cb[_0x480170(0x325)]['accessToken']}});return _0x1462c4[_0x480170(0x457)]=_0x4d1046[_0x480170(0x1dd)]['id'],await this[_0x480170(0x39d)][_0x480170(0x249)](_0x1462c4),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x4725cb[_0x480170(0x325)][_0x480170(0x431)],'headers':{'Authorization':_0x480170(0x238)+_0x4725cb['modelInfo']['accessToken']},'params':{'id':_0x1462c4[_0x480170(0x457)]}}),0xbb8),_0x1462c4;});}catch(_0x2073c2){throw new common_1[(_0x2ce78c(0x3b2))](_0x2073c2[_0x2ce78c(0x251)],common_1['HttpStatus']['BAD_REQUEST']);}}['pptDetail'](_0x3e83bc){const _0x610358=_0x10c797;return this[_0x610358(0x39d)]['findOne']({'where':{'id':_0x3e83bc}});}['pptChangeTheme'](_0x48885d,_0x166f0b){const _0x4c30d8=_0x10c797;try{return this['connection'][_0x4c30d8(0x3d8)](async()=>{const _0x5da316=_0x4c30d8,_0x467a97=await this[_0x5da316(0x39d)][_0x5da316(0x2b6)]({'where':{'id':_0x166f0b[_0x5da316(0x388)]}});if(!_0x467a97)throw new Error(_0x5da316(0x3b4));const _0x49ae94=await this[_0x5da316(0x1e8)][_0x5da316(0x422)](model_constant_1[_0x5da316(0x375)][_0x5da316(0x23d)]);let _0x5e8632={'userId':_0x48885d[_0x5da316(0x443)]['id'],'type':ppt_constant_1[_0x5da316(0x3d4)][_0x5da316(0x402)],'originId':_0x166f0b[_0x5da316(0x388)],'coverId':_0x166f0b[_0x5da316(0x3c9)],'fontName':_0x166f0b[_0x5da316(0x217)],'transition':_0x166f0b[_0x5da316(0x250)]};_0x5e8632=await this[_0x5da316(0x39d)]['save'](_0x5e8632),await this[_0x5da316(0x31f)][_0x5da316(0x3e0)](_0x48885d[_0x5da316(0x443)]['id'],_0x5e8632['id'],_0x5e8632[_0x5da316(0x3ed)]);const _0x1a95fc=await this['pptService'][_0x5da316(0x37f)]({'data':{'id':_0x467a97[_0x5da316(0x457)],'cover_id':_0x166f0b['coverId'],'font_name':_0x166f0b['fontName'],'transition':_0x166f0b[_0x5da316(0x250)]},'baseURL':_0x49ae94[_0x5da316(0x325)][_0x5da316(0x431)],'headers':{'Authorization':'Beare\x20'+_0x49ae94[_0x5da316(0x325)]['accessToken']}});return _0x5e8632[_0x5da316(0x457)]=_0x1a95fc[_0x5da316(0x1dd)]['id'],await this[_0x5da316(0x39d)][_0x5da316(0x249)](_0x5e8632),setTimeout(()=>this[_0x5da316(0x1fd)]({'baseURL':_0x49ae94['modelInfo'][_0x5da316(0x431)],'headers':{'Authorization':_0x5da316(0x238)+_0x49ae94[_0x5da316(0x325)][_0x5da316(0x2ac)]},'params':{'id':_0x5e8632[_0x5da316(0x457)]}}),0xbb8),_0x5e8632;});}catch(_0x584b93){throw new common_1[(_0x4c30d8(0x3b2))](_0x584b93[_0x4c30d8(0x251)],common_1[_0x4c30d8(0x21b)][_0x4c30d8(0x2eb)]);}}[_0x10c797(0x2b2)](_0x2bf044,_0x3b7f2b){const _0xdf0137=_0x10c797;try{return this[_0xdf0137(0x31c)][_0xdf0137(0x3d8)](async()=>{const _0x5dd017=_0xdf0137,_0x155586=await this['pptTaskEntity'][_0x5dd017(0x2b6)]({'where':{'id':_0x3b7f2b['originTaskId']}});if(!_0x155586)throw new Error(_0x5dd017(0x3b4));const _0x326610=await this[_0x5dd017(0x1e8)][_0x5dd017(0x422)](model_constant_1['EModelType'][_0x5dd017(0x23d)]);let _0x42d5f3={'userId':_0x2bf044['user']['id'],'type':ppt_constant_1[_0x5dd017(0x3d4)][_0x5dd017(0x263)],'originId':_0x3b7f2b[_0x5dd017(0x388)],'theme':_0x3b7f2b['theme'],'text':_0x3b7f2b[_0x5dd017(0x28f)],'complex':_0x3b7f2b['complex']?String(_0x3b7f2b['complex']):'1','author':_0x3b7f2b[_0x5dd017(0x275)],'fontName':_0x3b7f2b[_0x5dd017(0x217)],'transition':_0x3b7f2b[_0x5dd017(0x250)],'slideNumber':_0x3b7f2b['slideNumber'],'slideType':_0x3b7f2b['slideType']};_0x42d5f3=await this[_0x5dd017(0x39d)][_0x5dd017(0x249)](_0x42d5f3),await this[_0x5dd017(0x31f)][_0x5dd017(0x3e0)](_0x2bf044['user']['id'],_0x42d5f3['id'],_0x42d5f3[_0x5dd017(0x3ed)]);const _0x2ad403=await this[_0x5dd017(0x27e)]['pptAddPage']({'data':{'id':_0x155586[_0x5dd017(0x457)],'text':_0x3b7f2b[_0x5dd017(0x28f)],'complex':_0x3b7f2b[_0x5dd017(0x279)],'user_name':_0x3b7f2b[_0x5dd017(0x275)],'font_name':_0x3b7f2b[_0x5dd017(0x217)],'transition':_0x3b7f2b[_0x5dd017(0x250)],'slide_number':_0x3b7f2b[_0x5dd017(0x2d5)],'slide_type':_0x3b7f2b[_0x5dd017(0x229)],'theme':_0x3b7f2b[_0x5dd017(0x3c4)]},'baseURL':_0x326610[_0x5dd017(0x325)][_0x5dd017(0x431)],'headers':{'Authorization':_0x5dd017(0x238)+_0x326610[_0x5dd017(0x325)][_0x5dd017(0x2ac)]}});return _0x42d5f3[_0x5dd017(0x457)]=_0x2ad403[_0x5dd017(0x1dd)]['id'],await this[_0x5dd017(0x39d)]['save'](_0x42d5f3),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x326610['modelInfo'][_0x5dd017(0x431)],'headers':{'Authorization':_0x5dd017(0x238)+_0x326610[_0x5dd017(0x325)][_0x5dd017(0x2ac)]},'params':{'id':_0x42d5f3[_0x5dd017(0x457)]}}),0xbb8),_0x42d5f3;});}catch(_0x2830b3){throw new common_1['HttpException'](_0x2830b3['message'],common_1[_0xdf0137(0x21b)][_0xdf0137(0x2eb)]);}}[_0x10c797(0x377)](_0x46f0ae,_0x3e7be3){const _0x53d0cb=_0x10c797;try{return this[_0x53d0cb(0x31c)][_0x53d0cb(0x3d8)](async()=>{const _0x49215f=_0x53d0cb,_0x389a02=await this[_0x49215f(0x39d)]['findOne']({'where':{'id':_0x3e7be3['originTaskId']}});if(!_0x389a02)throw new Error(_0x49215f(0x3b4));const _0x598de8=await this[_0x49215f(0x1e8)][_0x49215f(0x422)](model_constant_1[_0x49215f(0x375)][_0x49215f(0x23d)]);let _0xe6bdd4={'userId':_0x46f0ae[_0x49215f(0x443)]['id'],'type':ppt_constant_1[_0x49215f(0x3d4)][_0x49215f(0x248)],'originId':_0x3e7be3[_0x49215f(0x388)],'notes':_0x3e7be3};_0xe6bdd4=await this[_0x49215f(0x39d)][_0x49215f(0x249)](_0xe6bdd4),await this[_0x49215f(0x31f)][_0x49215f(0x3e0)](_0x46f0ae[_0x49215f(0x443)]['id'],_0xe6bdd4['id'],_0xe6bdd4[_0x49215f(0x3ed)]);const _0x32b6a8=await this[_0x49215f(0x27e)][_0x49215f(0x20c)]({'data':{..._0x3e7be3,'id':_0x389a02[_0x49215f(0x457)]},'baseURL':_0x598de8['modelInfo'][_0x49215f(0x431)],'headers':{'Authorization':'Beare\x20'+_0x598de8[_0x49215f(0x325)]['accessToken']}});return _0xe6bdd4[_0x49215f(0x457)]=_0x32b6a8[_0x49215f(0x1dd)]['id'],await this['pptTaskEntity'][_0x49215f(0x249)](_0xe6bdd4),setTimeout(()=>this[_0x49215f(0x1fd)]({'baseURL':_0x598de8[_0x49215f(0x325)][_0x49215f(0x431)],'headers':{'Authorization':_0x49215f(0x238)+_0x598de8['modelInfo'][_0x49215f(0x2ac)]},'params':{'id':_0xe6bdd4[_0x49215f(0x457)]}}),0xbb8),_0xe6bdd4;});}catch(_0x1b5f08){throw new common_1['HttpException'](_0x1b5f08[_0x53d0cb(0x251)],common_1[_0x53d0cb(0x21b)][_0x53d0cb(0x2eb)]);}}async[_0x10c797(0x3ef)](_0x93218b,_0x19d806){const _0x48e847=_0x10c797,{page:page=0x1,size:size=0x14,keyword:_0x24cafa}=_0x93218b,_0x42e389=[{'delFlag':0x0,'publishFlag':0x1,'type':(0x0,typeorm_1['In'])([ppt_constant_1['EPPTTaskType'][_0x48e847(0x3e5)],ppt_constant_1[_0x48e847(0x3d4)][_0x48e847(0x1d1)]])}];_0x24cafa&&_0x42e389[_0x48e847(0x448)]({'title':(0x0,typeorm_1[_0x48e847(0x320)])('%'+_0x24cafa+'%'),'delFlag':0x0},{'subTitle':(0x0,typeorm_1[_0x48e847(0x320)])('%'+_0x24cafa+'%'),'delFlag':0x0});const [_0x1f26d2,_0xf4c308]=await this['pptTaskEntity'][_0x48e847(0x398)]({'where':_0x42e389,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':_0x48e847(0x345)}}),_0x3af4e9=await this[_0x48e847(0x31f)][_0x48e847(0x278)](_0x1f26d2,_0x19d806);return{'rows':_0x3af4e9,'count':_0xf4c308};}async[_0x10c797(0x24f)](_0x3863b9,_0x339da4){const _0x275d3d=_0x10c797,_0x40d478=_0x339da4[_0x275d3d(0x443)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x9f9501}=_0x3863b9,_0x32d22f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x20and\x20(type=\x27create\x27\x20or\x20type=\x27file\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x9f9501?_0x275d3d(0x2cd)+_0x9f9501+_0x275d3d(0x23f)+_0x9f9501+_0x275d3d(0x230):'')+_0x275d3d(0x284)+(_0x40d478?'\x20AND\x20p.user_id\x20=\x20'+_0x40d478:'')+_0x275d3d(0x28b),_0x4d00b9=await this[_0x275d3d(0x31c)][_0x275d3d(0x282)](_0x275d3d(0x201)+_0x32d22f+_0x275d3d(0x28b)),_0x3ed74d=await this['connection']['query'](_0x275d3d(0x3e7)+_0x32d22f+_0x275d3d(0x39e)+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20');!(0x0,utils_1[_0x275d3d(0x458)])(this[_0x275d3d(0x412)])&&_0x3ed74d[_0x275d3d(0x2cf)](_0x19cf16=>{const _0x4464b7=_0x275d3d;_0x19cf16[_0x4464b7(0x36d)]=(0x0,utils_1[_0x4464b7(0x23c)])(_0x19cf16['email']),_0x19cf16[_0x4464b7(0x347)]=(0x0,utils_1['maskEmail'])(_0x19cf16[_0x4464b7(0x347)]);});const _0x28312a=await this[_0x275d3d(0x31f)][_0x275d3d(0x278)](_0x3ed74d,_0x339da4);return{'rows':_0x28312a,'count':Number(_0x4d00b9[0x0]?.[_0x275d3d(0x31d)]||0x0)};}async[_0x10c797(0x20a)](_0x1fba1c,_0x54a8b=0x1,_0x3f2714=0xa){const _0xd74943=_0x10c797,{rows:_0x28a76e,count:_0x1fa08e}=await this['userService'][_0xd74943(0x2e5)](_0x54a8b,_0x3f2714,_0x1fba1c[_0xd74943(0x443)]['id'],collectType_constant_1[_0xd74943(0x369)][_0xd74943(0x23d)]),_0x1d2ec1=await this[_0xd74943(0x39d)][_0xd74943(0x3f1)]({'where':{'id':(0x0,typeorm_1['In'])(_0x28a76e[_0xd74943(0x40d)](_0x289728=>_0x289728[_0xd74943(0x294)]))}});return{'rows':_0x1d2ec1,'count':_0x1fa08e};}async['pptDel'](_0x2fb74c,_0x359ba7){const _0x599e3d=_0x10c797;if(!_0x2fb74c[_0x599e3d(0x3fc)]||!_0x2fb74c['ids'][_0x599e3d(0x1c7)])return!![];const _0x439290={'id':(0x0,typeorm_1['In'])(_0x2fb74c[_0x599e3d(0x3fc)])};return _0x359ba7&&(_0x439290[_0x599e3d(0x3fb)]=_0x359ba7),await this[_0x599e3d(0x39d)]['update'](_0x439290,{'delFlag':0x1}),await this[_0x599e3d(0x31f)][_0x599e3d(0x46a)](_0x2fb74c[_0x599e3d(0x3fc)],collectType_constant_1[_0x599e3d(0x369)][_0x599e3d(0x23d)]),!![];}async[_0x10c797(0x215)](_0x2d7f23,_0x31c4a9){const _0x109afc=_0x10c797;try{let _0x258097='';return await this['connection']['transaction'](async()=>{const _0x46509e=_0x3268,_0xf4c952=(0x0,utils_1[_0x46509e(0x305)])(this[_0x46509e(0x412)]),{modelInfo:_0x4ab06a}=await this[_0x46509e(0x1e8)][_0x46509e(0x422)](model_constant_1[_0x46509e(0x375)]['TTS'],_0x46509e(0x29f));await this['validateBeforeChat']({'prompt':_0x31c4a9[_0x46509e(0x356)]['text'],'user':_0x2d7f23[_0x46509e(0x443)],'currentRequestModel':_0x4ab06a});const _0x2b7921={'curIp':(0x0,utils_1[_0x46509e(0x3f6)])(_0x2d7f23),'prompt':_0x31c4a9[_0x46509e(0x356)][_0x46509e(0x28f)],'modelId':_0x4ab06a['id'],'modelType':_0x4ab06a[_0x46509e(0x41c)],'answer':'','model':_0x4ab06a['model'],'role':_0x46509e(0x443),'userId':_0x2d7f23[_0x46509e(0x443)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x46509e(0x20f)][_0x46509e(0x43b)],'logType':0x1,'requestOptions':JSON[_0x46509e(0x302)](_0x31c4a9),'saasId':_0xf4c952},_0x1cf698={..._0x2b7921,'role':_0x46509e(0x221),'requestOptions':JSON['stringify']({'prompt':_0x31c4a9[_0x46509e(0x356)][_0x46509e(0x28f)],'options':{'model':_0x4ab06a[_0x46509e(0x1cf)]}})};await this['chatLogService'][_0x46509e(0x30f)](_0x2b7921),await this[_0x46509e(0x223)][_0x46509e(0x30f)](_0x1cf698),await this['userService']['deductBalance4Chat'](_0x2d7f23['user']['id'],_0x4ab06a,_0x1cf698['id']);const _0x567ae0={'app':{'appid':_0x4ab06a[_0x46509e(0x3cf)],'token':_0x4ab06a[_0x46509e(0x2ac)],'cluster':_0x46509e(0x3cd)},'user':{'uid':String(_0x2d7f23[_0x46509e(0x443)]['id'])},'audio':{'voice_type':_0x46509e(0x318),'encoding':_0x46509e(0x1ce),'speed_ratio':0x1},'request':{'reqid':(0x0,crypto_1['randomUUID'])(),'text':_0x31c4a9['request'][_0x46509e(0x28f)],'operation':_0x46509e(0x282)}},_0x1d63de=await this['doubaoService'][_0x46509e(0x215)]({'data':_0x567ae0,'headers':{'Authorization':_0x46509e(0x40a)+_0x4ab06a['accessToken']}}),_0x22cd70=chat_constant_1[_0x46509e(0x327)][_0x46509e(0x240)]+'-'+_0xf4c952+'-'+_0x2d7f23[_0x46509e(0x443)]['id']+'-'+new Date()[_0x46509e(0x1f9)]()+_0x46509e(0x367);let _0x2b0366=(0x0,path_1[_0x46509e(0x33e)])(process[_0x46509e(0x1d8)](),_0x46509e(0x20e),_0x46509e(0x29a)),_0x47030e=_0x46509e(0x247);_0x47030e=_0x47030e+'/'+_0x22cd70;!(0x0,fs_1[_0x46509e(0x2d4)])(_0x2b0366)&&(0x0,fs_1[_0x46509e(0x3c3)])(_0x2b0366,{'recursive':!![]});_0x2b0366=(0x0,path_1[_0x46509e(0x33e)])(_0x2b0366,_0x22cd70),(0x0,fs_1[_0x46509e(0x2ba)])(_0x2b0366,_0x1d63de[_0x46509e(0x1dd)],_0x46509e(0x46b));let _0x215143=process[_0x46509e(0x2b9)][_0x46509e(0x468)];_0x215143[_0x46509e(0x450)]('http')?_0x258097=_0x215143+_0x47030e:_0x258097=_0x46509e(0x31a)+_0x215143+_0x47030e,_0x1cf698[_0x46509e(0x471)]=_0x258097,await this['chatLogService'][_0x46509e(0x30f)](_0x1cf698);}),_0x258097;}catch(_0x37bb8b){console[_0x109afc(0x262)](_0x109afc(0x210),_0x37bb8b);throw new common_1[(_0x109afc(0x3b2))](_0x37bb8b[_0x109afc(0x251)],common_1[_0x109afc(0x21b)][_0x109afc(0x2eb)]);}}async[_0x10c797(0x3c1)](_0xe24a94,_0x14f0a7,_0x54c273){const _0x2fab87=_0x10c797;try{let _0x3d0c31,_0x310018;return await this[_0x2fab87(0x31c)]['transaction'](async()=>{const _0x249747=_0x2fab87,_0x1e20a3=(0x0,utils_1['getReqSaasId'])(this[_0x249747(0x412)]),{modelInfo:_0x3428b5}=await this['modelsService'][_0x249747(0x422)](model_constant_1['EModelType'][_0x249747(0x2fd)],'AUC7419233800922468658');await this[_0x249747(0x31f)][_0x249747(0x40f)](_0xe24a94[_0x249747(0x443)]['id'],_0x3428b5);const _0x111d45={'groupId':_0x54c273,'curIp':(0x0,utils_1[_0x249747(0x3f6)])(_0xe24a94),'prompt':_0x14f0a7,'modelId':_0x3428b5['id'],'modelType':_0x3428b5[_0x249747(0x41c)],'answer':'','model':_0x3428b5[_0x249747(0x1cf)],'role':'user','userId':_0xe24a94[_0x249747(0x443)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x249747(0x20f)][_0x249747(0x43b)],'logType':0x1,'requestOptions':JSON[_0x249747(0x302)]({'url':_0x14f0a7}),'saasId':_0x1e20a3},_0x22c64={..._0x111d45,'role':'assistant','requestOptions':JSON[_0x249747(0x302)]({'prompt':_0x14f0a7,'options':{'model':_0x3428b5[_0x249747(0x1cf)]}})};await this[_0x249747(0x223)][_0x249747(0x30f)](_0x111d45),await this['chatLogService'][_0x249747(0x30f)](_0x22c64),await this['userService'][_0x249747(0x3c6)](_0xe24a94[_0x249747(0x443)]['id'],_0x3428b5,_0x22c64['id']);let _0x2082f7=process['env'][_0x249747(0x468)];!/^http/[_0x249747(0x44e)](_0x2082f7)&&(_0x2082f7='https://'+_0x2082f7);const _0x95a99e={'app':{'appid':_0x3428b5[_0x249747(0x3cf)],'token':_0x3428b5['accessToken'],'cluster':_0x249747(0x3e4)},'user':{'uid':String(_0xe24a94[_0x249747(0x443)]['id'])},'audio':{'url':_0x14f0a7,'format':_0x14f0a7[_0x249747(0x419)]('.')['pop']()},'request':{'callback':_0x2082f7+_0x249747(0x40e)}},_0x34397b=await this[_0x249747(0x2c0)][_0x249747(0x3c1)]({'data':_0x95a99e,'headers':{'Authorization':'Bearer;'+_0x3428b5[_0x249747(0x2ac)]}});console[_0x249747(0x262)]('---------------------ASR---------------------',_0x34397b),_0x3d0c31=_0x34397b['id'],_0x310018=await this[_0x249747(0x223)][_0x249747(0x30f)](_0x22c64);}),new Promise(_0x294983=>{utils_1['EE']['once'](chat_constant_1['EChatType']['ASR']+'-'+_0x3d0c31,async _0x293ab3=>{const _0xbab2b9=_0x3268;_0x310018['answer']=_0x293ab3['text'],_0x310018=await this[_0xbab2b9(0x223)][_0xbab2b9(0x30f)](_0x310018),_0x294983(_0x310018);});});}catch(_0x17c712){console[_0x2fab87(0x262)](_0x2fab87(0x2a3),_0x17c712);throw new common_1[(_0x2fab87(0x3b2))](_0x17c712['message'],common_1[_0x2fab87(0x21b)][_0x2fab87(0x2eb)]);}}[_0x10c797(0x234)](_0x14e48b){const _0x591965=_0x10c797;_0x14e48b['code']===0x3e8&&utils_1['EE'][_0x591965(0x2df)](chat_constant_1[_0x591965(0x327)][_0x591965(0x2fd)]+'-'+_0x14e48b['id'],_0x14e48b);}async[_0x10c797(0x430)](_0x789d86,_0x18d729,_0x28a47e,_0x4caa4e){const _0x337af0=_0x10c797;try{let _0x15029c=await this[_0x337af0(0x31c)]['transaction'](async()=>{const _0x692e6c=_0x337af0;let _0x37bf96=new Date()[_0x692e6c(0x1f9)](),_0x362349=new Date()[_0x692e6c(0x1f9)]();const _0x5887ee=_0x789d86[_0x692e6c(0x443)]['id'],_0x20cb25=(0x0,utils_1['getReqSaasId'])(this[_0x692e6c(0x412)]),_0x1f848f=chat_constant_1['EChatType'][_0x692e6c(0x2fd)]+'-'+_0x20cb25+'-'+_0x5887ee+'-'+new Date()[_0x692e6c(0x1f9)]()+_0x692e6c(0x367),_0x3365c3=await this[_0x692e6c(0x1ee)][_0x692e6c(0x276)]({'filename':_0x1f848f,'buffer':_0x4caa4e[_0x692e6c(0x34d)]});_0x362349=new Date()[_0x692e6c(0x1f9)](),console[_0x692e6c(0x262)](_0x692e6c(0x211),_0x362349-_0x37bf96);const _0x18b5ab=await this[_0x692e6c(0x3c1)](_0x789d86,_0x3365c3,_0x28a47e?.['options']?.[_0x692e6c(0x2b3)]);_0x37bf96=new Date()[_0x692e6c(0x1f9)](),console[_0x692e6c(0x262)]('[耗时打印]语音转文字耗时：',_0x37bf96-_0x362349),_0x28a47e['prompt']=_0x18b5ab[_0x692e6c(0x471)];typeof _0x28a47e[_0x692e6c(0x2dc)]===_0x692e6c(0x2ee)&&(_0x28a47e['options']=JSON[_0x692e6c(0x3b6)](_0x28a47e[_0x692e6c(0x2dc)]));const _0x1cd642=await this['chatProcess'](_0x28a47e,_0x789d86,_0x18d729,![]);_0x362349=new Date()[_0x692e6c(0x1f9)](),console['log'](_0x692e6c(0x233),_0x362349-_0x37bf96);const _0x5cd0e9=await this['tts'](_0x789d86,{'request':{'text':_0x1cd642['answer']}});_0x1cd642['answerMp3']=_0x5cd0e9,this[_0x692e6c(0x223)][_0x692e6c(0x30f)](_0x1cd642),_0x37bf96=new Date()[_0x692e6c(0x1f9)](),console[_0x692e6c(0x262)](_0x692e6c(0x274),_0x37bf96-_0x362349);const {prompt:_0x18ed94,role:_0x4a06c6,answer:_0x7b10ab,createdAt:_0x286036,conversationOptions:_0x4e7e63,requestOptions:_0x4165be,id:_0x2085ae,answerMp3:_0x4e31fa}=_0x1cd642;return{'chatId':_0x2085ae,'dateTime':(0x0,utils_1[_0x692e6c(0x2e7)])(_0x286036),'text':_0x4a06c6==='user'?_0x18ed94:_0x7b10ab,'textMp3':_0x4e31fa,'inversion':_0x4a06c6==='user','error':![],'conversationOptions':_0x4e7e63?JSON[_0x692e6c(0x3b6)](_0x4e7e63):null,'requestOptions':_0x4165be?JSON[_0x692e6c(0x3b6)](_0x4165be):null};});_0x18d729['status'](0xc8)[_0x337af0(0x460)](result_1[_0x337af0(0x42a)][_0x337af0(0x44f)](_0x15029c));}catch(_0x523d78){throw new common_1[(_0x337af0(0x3b2))](_0x523d78[_0x337af0(0x251)],common_1[_0x337af0(0x21b)][_0x337af0(0x2eb)]);}}async[_0x10c797(0x2a5)](_0xf36cec,_0x5883fc){const _0x2f63f2=_0x10c797,_0x35aed4=_0x5883fc[_0x2f63f2(0x443)]['id'],_0x36e42f=await this[_0x2f63f2(0x1e8)][_0x2f63f2(0x1ea)](_0xf36cec);return{'remainCount':await this[_0x2f63f2(0x31f)]['getModelVipFree'](_0x35aed4,_0x36e42f),'freeCount':_0x36e42f['vipFreeNum'],'isVipFree':_0x36e42f[_0x2f63f2(0x27d)]==-0x1,'useIntegrate':_0x36e42f[_0x2f63f2(0x22b)]};}async['getVideoModelFree'](_0x1e8017){const _0x29b8e7=_0x10c797,_0x5ddf17=_0x1e8017['user']?.['id'],_0x514caa=await this[_0x29b8e7(0x1e8)][_0x29b8e7(0x2f5)](model_constant_1[_0x29b8e7(0x375)][_0x29b8e7(0x418)]),_0xd9988c=[];if(_0x5ddf17)for(const _0x37d94d of _0x514caa){_0xd9988c[_0x29b8e7(0x448)]({'id':_0x37d94d['id'],'keyType':_0x37d94d[_0x29b8e7(0x342)],'model':_0x37d94d[_0x29b8e7(0x1cf)],'name':_0x37d94d[_0x29b8e7(0x3fa)],'modelType':_0x37d94d[_0x29b8e7(0x41c)],'remainCount':await this[_0x29b8e7(0x31f)]['getModelVipFree'](_0x5ddf17,_0x37d94d),'freeCount':_0x37d94d[_0x29b8e7(0x27d)],'isVipFree':_0x37d94d[_0x29b8e7(0x27d)]==-0x1,'useIntegrate':_0x37d94d['deduct']});}else _0x514caa[_0x29b8e7(0x2cf)](_0x2868b5=>{const _0x1288db=_0x29b8e7;_0xd9988c[_0x1288db(0x448)]({'id':_0x2868b5['id'],'keyType':_0x2868b5[_0x1288db(0x342)],'model':_0x2868b5['model'],'name':_0x2868b5[_0x1288db(0x3fa)],'modelType':_0x2868b5[_0x1288db(0x41c)],'remainCount':0x0,'freeCount':_0x2868b5[_0x1288db(0x27d)],'isVipFree':_0x2868b5[_0x1288db(0x27d)]==-0x1,'useIntegrate':_0x2868b5[_0x1288db(0x22b)]});});return _0xd9988c;}async[_0x10c797(0x333)](_0x1e948b,_0x223f7e){const _0x412acf=_0x10c797,_0x348b0b=_0x1e948b['user']?.['id'];let _0x49e506=_0x223f7e[_0x412acf(0x342)];const _0x48549a=await this['modelsService'][_0x412acf(0x360)](model_constant_1[_0x412acf(0x375)][_0x412acf(0x418)],_0x49e506);if(!_0x48549a)throw new common_1[(_0x412acf(0x3b2))](_0x412acf(0x338),common_1[_0x412acf(0x21b)][_0x412acf(0x2eb)]);const _0x346cac=await this[_0x412acf(0x31f)]['getVideoConfig'](_0x48549a,_0x223f7e);if(!_0x348b0b)return{'remainCount':0x0,'freeCount':_0x48549a[_0x412acf(0x27d)]>0x0?_0x48549a[_0x412acf(0x27d)]:_0x346cac?.[_0x412acf(0x27d)]||0x0,'isVipFree':_0x48549a['vipFreeNum']==-0x1||_0x346cac?.[_0x412acf(0x27d)]==-0x1,'useIntegrate':_0x48549a['deduct']>0x0?_0x48549a['deduct']:_0x346cac?.[_0x412acf(0x1f7)]||0x0,'isVipUsed':_0x48549a[_0x412acf(0x246)]?!![]:![],'userType':_0x48549a[_0x412acf(0x246)]};return{'remainCount':await this[_0x412acf(0x31f)][_0x412acf(0x372)](_0x348b0b,_0x48549a,_0x223f7e),'freeCount':_0x48549a[_0x412acf(0x27d)]>0x0?_0x48549a[_0x412acf(0x27d)]:_0x346cac?.[_0x412acf(0x27d)]||0x0,'isVipFree':_0x48549a[_0x412acf(0x27d)]==-0x1||_0x346cac?.[_0x412acf(0x27d)]==-0x1,'useIntegrate':_0x48549a['deduct']>0x0?_0x48549a['deduct']:_0x346cac?.[_0x412acf(0x1f7)]||0x0,'isVipUsed':_0x48549a['userType']?!![]:![],'userType':_0x48549a[_0x412acf(0x246)]};}async['getDrawFree'](_0x51ab0d,_0x21f967){const _0x228f1b=_0x10c797,_0x24872b=this[_0x228f1b(0x31f)][_0x228f1b(0x226)](_0x51ab0d),_0x1d01c6=_0x24872b?.['id'];let _0x48c4dc=_0x21f967[_0x228f1b(0x344)]||_0x21f967[_0x228f1b(0x1cf)],_0x43d987=_0x21f967['n']||0x1;const _0x3350a6=await this[_0x228f1b(0x1e8)][_0x228f1b(0x363)](model_constant_1['EModelType']['DRAW'],_0x48c4dc);if(!_0x3350a6)throw new common_1[(_0x228f1b(0x3b2))](_0x228f1b(0x338),common_1['HttpStatus']['BAD_REQUEST']);if(!_0x1d01c6)return{'remainCount':0x0,'freeCount':_0x3350a6[_0x228f1b(0x27d)]>0x0?_0x3350a6[_0x228f1b(0x27d)]:0x0,'isVipFree':_0x3350a6[_0x228f1b(0x27d)]==-0x1,'useIntegrate':_0x3350a6['deduct']>0x0?_0x3350a6[_0x228f1b(0x22b)]:0x0,'isVipUsed':_0x3350a6[_0x228f1b(0x246)]?!![]:![],'userType':_0x3350a6['userType']};return{'remainCount':await this[_0x228f1b(0x31f)][_0x228f1b(0x34e)](_0x1d01c6,_0x3350a6),'freeCount':_0x3350a6[_0x228f1b(0x27d)]>0x0?_0x3350a6['vipFreeNum']:0x0,'isVipFree':_0x3350a6['vipFreeNum']==-0x1,'useIntegrate':_0x3350a6[_0x228f1b(0x22b)]>0x0?_0x3350a6[_0x228f1b(0x22b)]*_0x43d987:0x0,'isVipUsed':_0x3350a6['userType']?!![]:![],'userType':_0x3350a6[_0x228f1b(0x246)]};}async[_0x10c797(0x3e3)](){const _0x45e253=_0x10c797,_0x3a7afb=await this[_0x45e253(0x1e8)][_0x45e253(0x422)](model_constant_1['EModelType'][_0x45e253(0x23d)]),_0x528622=await this[_0x45e253(0x39d)][_0x45e253(0x282)]('select\x20*\x20from\x20ppt_task\x20where\x20\x20(status<>2\x20or\x20status\x20is\x20null\x20)and\x20yoo_task_id\x20is\x20not\x20null');_0x528622[_0x45e253(0x1c7)]&&_0x528622[_0x45e253(0x2cf)](async _0x282423=>{const _0x4f3559=_0x45e253;this[_0x4f3559(0x1fd)]({'baseURL':_0x3a7afb[_0x4f3559(0x325)][_0x4f3559(0x431)],'headers':{'Authorization':_0x4f3559(0x238)+_0x3a7afb[_0x4f3559(0x325)][_0x4f3559(0x2ac)]},'params':{'id':_0x282423[_0x4f3559(0x348)]}});});const _0x468832=await this[_0x45e253(0x39d)][_0x45e253(0x282)](_0x45e253(0x1eb));_0x468832['length']&&_0x468832[_0x45e253(0x2cf)](async _0x1def0e=>{const _0x211984=_0x45e253,_0x24862d=await this['pptService'][_0x211984(0x25d)]({'baseURL':_0x3a7afb[_0x211984(0x325)][_0x211984(0x431)],'headers':{'Authorization':_0x211984(0x238)+_0x3a7afb[_0x211984(0x325)]['accessToken']},'params':{'id':_0x1def0e[_0x211984(0x348)],'type':_0x211984(0x2b5)}});_0x24862d[_0x211984(0x1d5)]==_0x211984(0x2d0)&&_0x24862d['data']['download_url']&&(_0x1def0e['pdf_down_url']=_0x24862d[_0x211984(0x1dd)]['download_url'],await this[_0x211984(0x39d)][_0x211984(0x41e)]({'id':_0x1def0e['id']},{'pdfDownUrl':_0x1def0e[_0x211984(0x209)]}));});const _0x2352e1=await this['pptTaskEntity'][_0x45e253(0x282)](_0x45e253(0x38a));_0x2352e1[_0x45e253(0x1c7)]&&_0x2352e1[_0x45e253(0x2cf)](async _0x31775f=>{const _0x39fb35=_0x45e253,_0x6c554e=await this[_0x39fb35(0x27e)][_0x39fb35(0x25d)]({'baseURL':_0x3a7afb[_0x39fb35(0x325)][_0x39fb35(0x431)],'headers':{'Authorization':_0x39fb35(0x238)+_0x3a7afb['modelInfo'][_0x39fb35(0x2ac)]},'params':{'id':_0x31775f['yoo_task_id'],'type':_0x39fb35(0x46d)}});_0x6c554e[_0x39fb35(0x1d5)]==_0x39fb35(0x2d0)&&_0x6c554e[_0x39fb35(0x1dd)]['download_url']&&(_0x31775f[_0x39fb35(0x288)]=_0x6c554e[_0x39fb35(0x1dd)][_0x39fb35(0x346)],await this[_0x39fb35(0x39d)][_0x39fb35(0x41e)]({'id':_0x31775f['id']},{'pngDownUrl':_0x31775f[_0x39fb35(0x288)]}));});try{const _0x3205ad=store_2['PPTConfig'][_0x45e253(0x235)]||0x5,_0x2fc9d3=[{'status':0x1,'type':ppt_constant_1[_0x45e253(0x3d4)][_0x45e253(0x3e5)],'updatedAt':(0x0,typeorm_1[_0x45e253(0x444)])(new Date(Date['now']()-_0x3205ad*0x3c*0x3e8))}],_0x2e0d17=await this[_0x45e253(0x39d)][_0x45e253(0x3f1)]({'where':_0x2fc9d3});_0x2e0d17[_0x45e253(0x2cf)](async _0x35fbb5=>{const _0x9dfdd7=_0x45e253;_0x35fbb5[_0x9dfdd7(0x36b)]='timeout',_0x35fbb5[_0x9dfdd7(0x408)]=0x3,this[_0x9dfdd7(0x39d)][_0x9dfdd7(0x249)](_0x35fbb5),this[_0x9dfdd7(0x31f)][_0x9dfdd7(0x3e0)](_0x35fbb5[_0x9dfdd7(0x3fb)],_0x35fbb5['id'],_0x35fbb5['type'],!![]);});}catch(_0x16ecf3){common_1['Logger'][_0x45e253(0x26c)](_0x16ecf3);}}};ChatgptService=__decorate([(0x0,common_1[_0x10c797(0x1de)])(),__param(0x0,(0x0,typeorm_2[_0x10c797(0x20d)])(pptTask_entity_1[_0x10c797(0x3ca)])),__metadata(_0x10c797(0x340),[typeorm_1['Repository'],nestjs_cls_1[_0x10c797(0x433)],user_service_1[_0x10c797(0x445)],file_service_1[_0x10c797(0x324)],gpts_service_1[_0x10c797(0x3f5)],yooPPT_service_1[_0x10c797(0x400)],doubao_service_1[_0x10c797(0x441)],models_service_1['ModelsService'],chatLog_service_1[_0x10c797(0x3af)],lumaTask_service_1[_0x10c797(0x3bc)],runwayTask_service_1[_0x10c797(0x2f7)],klingTask_service_1[_0x10c797(0x1e4)],sunoTask_service_1['SunoTaskService'],veoTask_service_1[_0x10c797(0x245)],badwords_service_1[_0x10c797(0x2f4)],autoreply_service_1[_0x10c797(0x268)],chatGroup_service_1['ChatGroupService'],globalConfig_service_1[_0x10c797(0x303)],typeorm_1['Connection'],mindTask_service_1[_0x10c797(0x436)]])],ChatgptService),exports[_0x10c797(0x292)]=ChatgptService;