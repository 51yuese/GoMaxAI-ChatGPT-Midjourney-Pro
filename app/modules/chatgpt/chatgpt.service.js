'use strict';const _0x48aa00=_0x4f01;function _0x4f01(_0x25959e,_0x5cf9e6){const _0x345601=_0x3456();return _0x4f01=function(_0x4f01eb,_0x530a2e){_0x4f01eb=_0x4f01eb-0x184;let _0x15320e=_0x345601[_0x4f01eb];return _0x15320e;},_0x4f01(_0x25959e,_0x5cf9e6);}(function(_0x61059e,_0x1a3bcb){const _0x41ea02=_0x4f01,_0x3136f7=_0x61059e();while(!![]){try{const _0x2f054b=parseInt(_0x41ea02(0x237))/0x1+-parseInt(_0x41ea02(0x35a))/0x2+parseInt(_0x41ea02(0x397))/0x3*(parseInt(_0x41ea02(0x2a1))/0x4)+-parseInt(_0x41ea02(0x19a))/0x5*(parseInt(_0x41ea02(0x357))/0x6)+-parseInt(_0x41ea02(0x2e0))/0x7+-parseInt(_0x41ea02(0x24e))/0x8*(-parseInt(_0x41ea02(0x1ed))/0x9)+-parseInt(_0x41ea02(0x1f3))/0xa*(-parseInt(_0x41ea02(0x2f1))/0xb);if(_0x2f054b===_0x1a3bcb)break;else _0x3136f7['push'](_0x3136f7['shift']());}catch(_0x2b7143){_0x3136f7['push'](_0x3136f7['shift']());}}}(_0x3456,0x353df));function _0x3456(){const _0x15683d=['Logger','includes','now','updated_at','findAndCount','sunoMusicId','usage','text/event-stream','originTaskId','Speech_Synthesis7418877984234656063','EMusicTaskType','pptDel','listTaskByIds','getTime','../../common/constants/model.constant','startsWith','getVideoConfig','type','PPT','msg','Content-Type','Catch\x20Error\x20','ClsService','tts-1','同步PPT生成任务进度失败！','statusCode','schoolPicture','chatMusicLyrics','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','SUCCEEDED','sunoMusicTask','\x20AND\x20p.user_id\x20=\x20','https://','1132502AmSJIm','Access-Control-Allow-Origin','Bearer\x20','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','removeSpecialCharacters','/api/chatLog/notify-Suno-lyrics?id=','completionParams','yoo_task_id','klingChatVideo','tts','audio2text\x20','musicCreate','catch','parse','绘制图片失败，请检查你的提示词是否有非法描述！','isCustom','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.state_desc\x20as\x20stateDesc,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.editor_url\x20as\x20editorUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.images,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.preview_url\x20as\x20previewUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pdf_down_url\x20as\x20pdfDownUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.png_down_url\x20as\x20pngDownUrl\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','11lKcEvR','push','mergedOptions','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','Please\x20check\x20the\x20back-end\x20console','../api/klingTask.service','yooTaskId','parseAndSaveVideo','CHAT','then','--------------------------------------------------------','./zhipu','upload2Local','../api/yooPPT.service','MindTaskService','openaiModel3MaxTokensRes','model','gomaxAiStore','options','modelConfig','all','notifyAsr','env','pptCover','writeFileSync','pptStructure','decorate','png','openAiErrHandler','PPTTaskEntity','messageStore','pptRecPage','PPT不存在','mind','sendMessage','apiBaseUrl','transaction','gomaxai-default-key','state','process_url','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20pdf_down_url\x20is\x20null','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','fanyi\x20mj-associate','VIDEO','chatMusicUpload','user_prompt','gpts','checkUserStatus','openai','chunked','chatDraw','pop','aac','assistant','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','绘制图片失败，请稍后试试吧！','chatGroupService','getKeyFree','abortController','视频生成失败，没有响应','groupId','editorUrl','save','gomaxai-chatlog','proxyUrl','getModelVipFree','emit','video-task','pptReCover','resolve','getGroupInfoFromId','creat','last_image','deductBalance4Video','params','COVER','baseURL','removeFile','requestFromGpt','lumaTaskService','原始任务不存在！','catalogs','openaiModel3MaxTokens16k','openaiModel4MaxTokens','Transfer-Encoding','test','../file/file.service','delta','user','getCurrentModel','video','png_down_url','slideType','file','InjectRepository','BAD_REQUEST','OpenAiErrorCodeMessage','object','answer','b64_json','split','is_end','223866wqFKNk','volcano_tts','userId','270654spJpph','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','../../common/constants/balance.constant','toString','content','base64','deduct','kimiUpload','pptPage','openaiModel3MaxTokens','findOne','../../common/constants/errorMessage.constant','@nestjs/typeorm','completions','\x20--aspect_ratio\x20','pptResult','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x20and\x20(type=\x27create\x27\x20or\x20type=\x27file\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','pptEditorVipFree','i2v','json','/api/chatLog/notify-Suno-upload?id=','axios','author','musicUploadPrice','PPT\x20任务不存在！','totalTokens','price','Like','[耗时打印]保存文件耗时：','chatLogId','MUSIC','key:\x20','join','提供了错误的模型秘钥','__esModule','previewUrl','mergeCollectData','buffer','key','listAssetsBychatLogIds','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','pptConfig','BV700_streaming','HttpException','openaiTimeoutMs','模型秘钥错误或模型金额不足，请联系管理员！','files','setData','模型不存在','Repository','pptCreateVipFree','BadwordsService','../api/lumaTask.service','RECOVER','openaiModel4MaxTokens32kRes','__decorate','buildMessageFromParentMessageId','signal','upload','no-cache','../chatGroup/chatGroup.service','225996ZgUobH','HttpStatus','resCover','configDoubaoApi','function','listUndoneVideo','succeed','16k','advisor','batchPPTResult','STRUCTURE','buildSystemMessage','NineStore','addOneIfOdd','video_url','modelType','abs','YooPPTService','checkBadWords','saveUseLog','apiKey','draw\x20paompt\x20info\x20<======*******======>\x20','remove\x20file\x20','------------------------DEBUG-----------------------------','abort','select\x20*\x20from\x20ppt_task\x20where\x20status=2\x20and\x20yoo_task_id\x20is\x20not\x20null\x20and\x20png_down_url\x20is\x20null','klingTaskService','downUrl','thirdId','task_result','appid','end','string','TTS','api','data:\x20','subTitle','accessToken','asyncPPTProgress','createReadStream','images','PAINT_TYPE','../api/runwayTask.service','t2v','clsService','style','语音转文本失败','configKimiApi','startTime','musicCreateVipFree','32k','debuctBalance4Muisc','FILE','当前模型key已被封禁','25bPjQJu','keyType','errMsg','Result','DoubaoService','parentMessageId','collectPage','message','THEME','count','ids','EPPTTaskType','model_name','../../common/constants/chat.constant','conversationOptions','musicUpload','query','ADDNOTES','getModelsByModelType','fontName','onModuleInit','Download','ChatLogService','getModelByType','chatProcess','getConfigByKeys','existsSync','../models/models.service','pleader','close','result','./../user/user.service','GOMAXAI_HOST','success','getCurrentModelByChatGroupId','runwayChatVideo','completed','application/octet-stream;\x20charset=utf-8','modelOptions','promptTokens','ChatgptService','当前模型key余额已耗尽，请充值！','vipFreeNum','语音转换失败','progressUrl','contents','服务异常、请重新试试吧！！！','notify_hook','from','https://api.moonshot.cn/v1','klingVideoTask','当前请求已过载、请稍等会儿再试试吧！','default','../../common/utils','isSuper','Incorrect\x20API\x20key\x20provided','.mp3','Price','deductBalance4Chat','Error\x20in\x20pptConfig:','chat','musicLyricsVipFree','\x0a\x20\x20\x20\x20\x20\x20','crypto','runwayVideoTask','../../common/constants/redisKey.constant','preset','luma-video','DRAW','getOwnPropertyDescriptor','keyv','answerMp3','importDynamic','role','find','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','EDITOR','pptCreate','sunoTaskService','getVideoModelVipFree','syncLumaTask','download_url','setHeader','1975167RSixXX','message_id','/api/v3','volc_auc_common','\x20key\x20->\x20','ratio','2361350OylLzA','unifiedFormattingResponse','当前模型key余额已耗尽','videos','模型秘钥错误或模型余额不足','Content-type','RunwayTaskService','DeductionKey','PAYMENT_REQUIRED','/api/chatgpt/notify-asr','create','pptEditor','https://api.openai.com','email','./baidu','debug','pptService','sendMessageFromSpark','update','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','pageCount','pptTaskEntity','sendMessageFromZhipu','openaiBaseUrl','pdf_down_url','pptCollectPage','LessThan','CHAT_TYPE','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','ADDPAGE','image','configChatGptApi','suno-v3','voiceChat','forEach','pptOnlineEditor','gpt-4','key\x20%s,\x20proxy\x20%s','text','lumaVideoTask','validateBeforeChat','metadata','error','UserCollectType','coverId','getModelConfig','design:paramtypes','title','globalConfigService','pptDetail','doubaoService','getUuid','prompt\x20','ModelsService','musicLyricsPrice','VIP_FREE','fileUrl','\x20model:\x20','state_description','OTHER','内容提取失败','../api/sunoTask.service','toLowerCase','floor','mkdirSync','musicLyrics','mindTaskService','chatMuiscTask','20153FeHGPo','data','webroot','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','remove\x20file\x20%s\x20success','Injectable','PPTConfig','listByGroupId','../../common/constants/collectType.constant','application/octet-stream','bad\x20response\x20status\x20code\x20307','saveMindTask','openAi','fileService','code','getVideoFree','cwd','./helper','get','runwayTaskService','pptChangeTheme','defaultBaseUrl','responseMessage','8rZvSQL','FileService','stream','request','getClientIp','CREATE','messages','pptCreateFile','compileNetwork','prompt','validateBalance4Chat','badwordsService',',\x20模型名称:\x20','未获取到模型基础配置，请前往后台配置并启用','可翻译成其他语言。','refundBalance4Chat','status','task_id','Bearer;','write','schoolLogo','set','/upload','audio','unlink','AutoreplyService','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','log','whisper-1','map','saveChatLog','modelsService','REDIS_PORT','../api/doubao.service','pptAddNote','THESIS','transition','appId','pptOutlineVipFree','task_status','gpt-3','conversationId','Beare\x20','getVideoModelFree','200','extend','mp3','stringify','validateVideoBeforeChat','getAppById','path','userService','phone','lumaChatVideo','Unauthorized','url','REDIS_HOST','lyrics','file-extract','saveGptsUseLog','EChatType','VipFree','LYRICS','/v1/images/generations','theme','failed','toISOString','make_instrumental','post','getRandomKey','asr','once','当前模型不是聊天模型','pptDownload','pathname','progress','mindTaskId','lockKey','modelSubType','completionTokens','uncollectByRelIds','ASR','EModelType','12OQBOSr','arrayBuffer','getModelByModel','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','getReqSaasId','pptx_url','defineProperty','chatLogService','modelInfo','/v1','formatModelToken','detail','typeorm','connection','length','chatTask','slideNumber','modelName','.png','debuctBalance4PPT','../mindTask/mindTask.service','../badwords/badwords.service','@keyv/redis','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','initOpenAi','buildOptions','gptsService','color','本次调用:\x20','complex'];_0x3456=function(){return _0x15683d;};return _0x3456();}var __decorate=this&&this[_0x48aa00(0x391)]||function(_0x16abbc,_0x3379ac,_0x5034b7,_0x222ed1){const _0x491cfb=_0x48aa00;var _0x17a121=arguments[_0x491cfb(0x2af)],_0x576c09=_0x17a121<0x3?_0x3379ac:_0x222ed1===null?_0x222ed1=Object[_0x491cfb(0x1df)](_0x3379ac,_0x5034b7):_0x222ed1,_0x7730ab;if(typeof Reflect===_0x491cfb(0x352)&&typeof Reflect[_0x491cfb(0x30b)]==='function')_0x576c09=Reflect['decorate'](_0x16abbc,_0x3379ac,_0x5034b7,_0x222ed1);else{for(var _0x1d10ef=_0x16abbc[_0x491cfb(0x2af)]-0x1;_0x1d10ef>=0x0;_0x1d10ef--)if(_0x7730ab=_0x16abbc[_0x1d10ef])_0x576c09=(_0x17a121<0x3?_0x7730ab(_0x576c09):_0x17a121>0x3?_0x7730ab(_0x3379ac,_0x5034b7,_0x576c09):_0x7730ab(_0x3379ac,_0x5034b7))||_0x576c09;}return _0x17a121>0x3&&_0x576c09&&Object[_0x491cfb(0x2a7)](_0x3379ac,_0x5034b7,_0x576c09),_0x576c09;},__metadata=this&&this['__metadata']||function(_0x3eb8fd,_0x2ae70a){const _0x1a17d0=_0x48aa00;if(typeof Reflect===_0x1a17d0(0x352)&&typeof Reflect['metadata']===_0x1a17d0(0x39b))return Reflect[_0x1a17d0(0x21c)](_0x3eb8fd,_0x2ae70a);},__param=this&&this['__param']||function(_0x426bdb,_0x338bcb){return function(_0x5882b5,_0xbc7b4d){_0x338bcb(_0x5882b5,_0xbc7b4d,_0x426bdb);};};Object[_0x48aa00(0x2a7)](exports,_0x48aa00(0x37c),{'value':!![]}),exports[_0x48aa00(0x1c2)]=void 0x0;const file_service_1=require(_0x48aa00(0x347)),user_service_1=require(_0x48aa00(0x1b9)),openai_1=require(_0x48aa00(0x321)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x48aa00(0x365)),utils_1=require(_0x48aa00(0x1cf)),axios_1=require(_0x48aa00(0x36f)),balance_constant_1=require(_0x48aa00(0x35c)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require('uuid'),fs=require('fs'),typeorm_1=require(_0x48aa00(0x2ad)),typeorm_2=require(_0x48aa00(0x366)),badwords_service_1=require(_0x48aa00(0x2b6)),autoreply_service_1=require('../autoreply/autoreply.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),chatGroup_service_1=require(_0x48aa00(0x396)),models_service_1=require(_0x48aa00(0x1b5)),baidu_1=require(_0x48aa00(0x201)),helper_1=require(_0x48aa00(0x248)),store_1=require('./store'),zhipu_1=require(_0x48aa00(0x2fc)),spark_1=require('./spark'),model_constant_1=require(_0x48aa00(0x2cd)),fs_1=require('fs'),path_1=require(_0x48aa00(0x280)),gpts_service_1=require('../gpts/gpts.service'),yooPPT_service_1=require(_0x48aa00(0x2fe)),pptTask_entity_1=require('./entity/pptTask.entity'),ppt_constant_1=require('../../common/constants/ppt.constant'),lumaTask_service_1=require(_0x48aa00(0x38e)),nestjs_cls_1=require('nestjs-cls'),doubao_service_1=require(_0x48aa00(0x26f)),crypto_1=require(_0x48aa00(0x1d9)),chat_constant_1=require(_0x48aa00(0x1a7)),result_1=require('../../common/result'),runwayTask_service_1=require(_0x48aa00(0x18e)),klingTask_service_1=require(_0x48aa00(0x2f6)),sunoTask_service_1=require(_0x48aa00(0x230)),mindTask_service_1=require(_0x48aa00(0x2b5)),collectType_constant_1=require(_0x48aa00(0x23f)),redisKey_constant_1=require(_0x48aa00(0x1db)),store_2=require('../../common/store'),music_constant_1=require('../../common/constants/music.constant');let ChatgptService=class ChatgptService{constructor(_0x116447,_0x4ba26c,_0x39d190,_0x11c63c,_0x26be28,_0x290329,_0x348703,_0x1af51a,_0x188d4e,_0x2138a2,_0x4d6253,_0x24b00d,_0x5be48d,_0x5c7363,_0x56a24c,_0x54c3df,_0x5c2bdd,_0xd5d0ec,_0x2218d0){const _0x1fd8a7=_0x48aa00;this['pptTaskEntity']=_0x116447,this[_0x1fd8a7(0x190)]=_0x4ba26c,this[_0x1fd8a7(0x281)]=_0x39d190,this['fileService']=_0x11c63c,this[_0x1fd8a7(0x2bb)]=_0x26be28,this[_0x1fd8a7(0x203)]=_0x290329,this[_0x1fd8a7(0x225)]=_0x348703,this['modelsService']=_0x1af51a,this[_0x1fd8a7(0x2a8)]=_0x188d4e,this[_0x1fd8a7(0x340)]=_0x2138a2,this[_0x1fd8a7(0x24a)]=_0x4d6253,this[_0x1fd8a7(0x3b1)]=_0x24b00d,this['sunoTaskService']=_0x5be48d,this[_0x1fd8a7(0x259)]=_0x5c7363,this['autoreplyService']=_0x56a24c,this[_0x1fd8a7(0x329)]=_0x54c3df,this[_0x1fd8a7(0x223)]=_0x5c2bdd,this[_0x1fd8a7(0x2ae)]=_0xd5d0ec,this[_0x1fd8a7(0x235)]=_0x2218d0,this[_0x1fd8a7(0x24c)]='https://api.openai.com',this['messageStore']=null,this['gomaxAiStore']=null,this[_0x1fd8a7(0x33e)]=_0xbb423c=>{const _0xa17412=_0x1fd8a7;return fs[_0xa17412(0x266)](_0xbb423c,_0x11b732=>{const _0x3be8f9=_0xa17412;_0x11b732?console[_0x3be8f9(0x269)](_0x3be8f9(0x3ad),_0x11b732):console[_0x3be8f9(0x269)](_0x3be8f9(0x23b),_0xbb423c);});};}async[_0x48aa00(0x1ae)](){const _0x55fa22=_0x48aa00;let _0x2f585c=await(0x0,utils_1['importDynamic'])('chatgpt');_0x2f585c=_0x2f585c?.[_0x55fa22(0x1ce)]?_0x2f585c[_0x55fa22(0x1ce)]:_0x2f585c,this[_0x55fa22(0x186)]=_0x2f585c['ChatGPTAPI'];let _0x4e315c=await(0x0,utils_1['importDynamic'])(_0x55fa22(0x1e0));_0x4e315c=_0x4e315c?.[_0x55fa22(0x1ce)]?_0x4e315c[_0x55fa22(0x1ce)]:_0x4e315c;let _0x2364c4=await(0x0,utils_1[_0x55fa22(0x1e2)])(_0x55fa22(0x2b7));_0x2364c4=_0x2364c4?.[_0x55fa22(0x1ce)]?_0x2364c4['default']:_0x2364c4;const _0x141bdb=+process[_0x55fa22(0x307)][_0x55fa22(0x26e)],_0x23b657=process[_0x55fa22(0x307)][_0x55fa22(0x286)],_0x442f57=process[_0x55fa22(0x307)]['REDIS_PASSWORD'],_0x3d0f3c=process[_0x55fa22(0x307)]['REDIS_USER'],_0x53c918='redis://'+(_0x3d0f3c||'')+':'+(_0x442f57||'')+'@'+_0x23b657+':'+_0x141bdb,_0x28a4aa=new _0x2364c4(_0x53c918);this[_0x55fa22(0x30f)]=new _0x4e315c({'store':_0x28a4aa,'namespace':_0x55fa22(0x330)}),this[_0x55fa22(0x302)]=new store_1[(_0x55fa22(0x3a3))]({'store':this['messageStore'],'namespace':_0x55fa22(0x1d6)}),!this[_0x55fa22(0x243)]&&this[_0x55fa22(0x2b9)]();}[_0x48aa00(0x2b9)](){const _0x398b3a=_0x48aa00;this[_0x398b3a(0x243)]=new openai_1['default']({'apiKey':_0x398b3a(0x316),'baseURL':this[_0x398b3a(0x24c)]+_0x398b3a(0x2aa)});}async['getModelConfig'](_0x5c0ce5){const _0x5c9c58=_0x48aa00,{type:_0x8eab8d,groupId:_0x44a054,modelType:_0x5c72f6,officialModel:_0x359f43}=_0x5c0ce5;console['log'](_0x5c9c58(0x2fb),_0x5c0ce5);let _0x4f6a67,_0x4b68fd;_0x8eab8d&&_0x8eab8d===_0x5c9c58(0x31f)?(_0x4b68fd=await this['gptsService']['getGroupInfoFromId'](_0x44a054),_0x4f6a67=_0x4b68fd['modelId']):_0x4b68fd=await this[_0x5c9c58(0x329)][_0x5c9c58(0x337)](_0x44a054);let _0x1d7282;if(_0x4b68fd)_0x1d7282=JSON[_0x5c9c58(0x2ed)](_0x4b68fd['config']);else _0x5c72f6?_0x1d7282=await this[_0x5c9c58(0x26d)][_0x5c9c58(0x1b1)](_0x5c72f6,_0x359f43):_0x1d7282=await this[_0x5c9c58(0x26d)]['getModelByType'](model_constant_1[_0x5c9c58(0x2a0)][_0x5c9c58(0x22e)]);if(!_0x1d7282)throw new common_1[(_0x5c9c58(0x385))](_0x5c9c58(0x25b),common_1['HttpStatus'][_0x5c9c58(0x350)]);return{'appId':_0x4f6a67,'modelConfig':_0x1d7282};}async['buildSystemMessage'](_0x465c4d){const _0xd407ff=_0x48aa00,_0x206e18=this;let _0x16a367='',_0x3b6abf='',{type:_0x14b9c1,appId:_0x175dc9,prompt:_0xd13561,custom:_0x5d2ad9,usingNetwork:_0x28623e,systemMessage:_0x37ed94,customSystemMessage:_0x455db2}=_0x465c4d;const _0x453adc=async function(){const _0x3661c6=_0x4f01,_0x57db3d=new Date()[_0x3661c6(0x290)]()[_0x3661c6(0x355)]('T')[0x0];return _0x3b6abf=await _0x206e18[_0x3661c6(0x223)][_0x3661c6(0x1b3)](['systemPreMessage']),_0x3b6abf+(_0x3661c6(0x31a)+_0x57db3d);};if(_0x175dc9){const _0x5e9973=await this['gptsService'][_0xd407ff(0x27f)](_0x175dc9,0x1);if(!_0x5e9973)throw new common_1[(_0xd407ff(0x385))]('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0xd407ff(0x398)][_0xd407ff(0x350)]);_0x5e9973[_0xd407ff(0x1dc)]&&(_0x37ed94=_0x5e9973[_0xd407ff(0x1dc)]);}else{if(_0x5d2ad9)_0x37ed94=_0x37ed94;else _0x455db2?_0x37ed94=_0x455db2:_0x14b9c1!=='gpts'&&(_0x37ed94=await _0x453adc());}return _0x28623e&&(_0x16a367=await(0x0,utils_1[_0xd407ff(0x256)])(_0xd13561),!_0x3b6abf&&(_0x37ed94=await _0x453adc())),{'systemMessage':_0x37ed94,'netWorkPrompt':_0x16a367};}async[_0x48aa00(0x34a)](_0x4ef329){const _0x220d13=_0x48aa00,{type:_0x5a9f15,custom:_0x1380f6,groupId:_0x9a7c4e,modelConfig:_0x594417}=_0x4ef329;let _0x5db170=null;if(!_0x1380f6&&!_0x5a9f15){const _0x57d5d7=await this['modelsService'][_0x220d13(0x1b1)](model_constant_1[_0x220d13(0x2a0)][_0x220d13(0x2f9)],_0x594417[_0x220d13(0x2a9)][_0x220d13(0x301)]);_0x5db170=_0x57d5d7['modelInfo'];}else{if(_0x5a9f15===_0x220d13(0x31f))_0x5db170=await this[_0x220d13(0x2bb)][_0x220d13(0x1bc)](_0x9a7c4e);else{if(_0x5a9f15===_0x220d13(0x34e)){const _0x216bc2=await this['modelsService'][_0x220d13(0x1b1)](model_constant_1[_0x220d13(0x2a0)][_0x220d13(0x198)],_0x594417[_0x220d13(0x2a9)][_0x220d13(0x301)]);_0x5db170=_0x216bc2[_0x220d13(0x2a9)];}else _0x1380f6?_0x5db170=await this[_0x220d13(0x26d)][_0x220d13(0x293)](model_constant_1[_0x220d13(0x2a0)][_0x220d13(0x22e)]):_0x5db170=await this[_0x220d13(0x26d)][_0x220d13(0x293)](model_constant_1[_0x220d13(0x2a0)]['CHAT']);}}if(!_0x5db170)throw new common_1[(_0x220d13(0x385))]('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x220d13(0x398)]['BAD_REQUEST']);return _0x5a9f15==='gpts'?_0x594417[_0x220d13(0x2a9)][_0x220d13(0x301)]=_0x5db170[_0x220d13(0x301)]:_0x5db170[_0x220d13(0x301)]=_0x594417[_0x220d13(0x2a9)][_0x220d13(0x301)],_0x5db170;}async[_0x48aa00(0x27e)](_0x5869d9){const _0x545024=_0x48aa00,{user:_0x55a40b,prompt:_0x10706d,currentRequestModel:_0x3480da}=_0x5869d9;await this[_0x545024(0x281)][_0x545024(0x320)](_0x55a40b),await this['badwordsService'][_0x545024(0x3a9)](_0x10706d,_0x55a40b['id']),await this[_0x545024(0x281)]['validateBalance4Video'](_0x55a40b['id'],_0x3480da,_0x5869d9);}async[_0x48aa00(0x21b)](_0x450bf5){const _0x3517ac=_0x48aa00,{user:_0x46ac58,prompt:_0x5484cc,currentRequestModel:_0x298094}=_0x450bf5;await this['userService']['checkUserStatus'](_0x46ac58),await this[_0x3517ac(0x259)][_0x3517ac(0x3a9)](_0x5484cc,_0x46ac58['id']),await this[_0x3517ac(0x281)][_0x3517ac(0x258)](_0x46ac58['id'],_0x298094);}async['buildOptions'](_0x1cf443,_0x155122,_0x4fbca9){const _0x595d77=_0x48aa00,_0x5b02d5=await this[_0x595d77(0x223)][_0x595d77(0x1b3)]([_0x595d77(0x386)]),_0x3c35eb=Number(_0x5b02d5)||0x493e0,_0x2194f2={'timeoutMs':+_0x3c35eb,'systemMessage':_0x155122||'','parentMessageId':_0x1cf443||'','completionParams':{'temperature':0.8,'model':_0x4fbca9[_0x595d77(0x301)]}};return _0x2194f2;}async[_0x48aa00(0x212)](_0x4ff12e,_0x518829){const _0x55faa7=_0x48aa00;let _0x553e03=_0x4ff12e['proxyUrl'];if(!_0x553e03){const _0x2a4a3e=await this[_0x55faa7(0x223)][_0x55faa7(0x1b3)]([_0x55faa7(0x20a)]);_0x2a4a3e?_0x553e03=_0x2a4a3e:_0x553e03=_0x55faa7(0x1ff);}const _0x4a51cf=0x1f40,_0x36c4ba=0x1000;console['log'](_0x55faa7(0x3ae),_0x4ff12e);const _0xd45177=new this[(_0x55faa7(0x186))]({'maxModelTokens':_0x4a51cf,'apiBaseUrl':_0x553e03+_0x55faa7(0x2aa),'messageStore':this[_0x55faa7(0x30f)],'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x4ff12e[_0x55faa7(0x380)]),'maxResponseTokens':_0x36c4ba>=_0x4a51cf?Math[_0x55faa7(0x3a7)](Math[_0x55faa7(0x232)](_0x4a51cf/0x2)):_0x36c4ba});return console[_0x55faa7(0x269)](_0x55faa7(0x3ab),_0xd45177[_0x55faa7(0x3ab)]),console[_0x55faa7(0x269)](_0x55faa7(0x2f3),_0x518829),console[_0x55faa7(0x269)](_0x55faa7(0x314),_0x553e03+_0x55faa7(0x2aa)),_0xd45177;}async[_0x48aa00(0x193)](_0x37725b){const _0x5b8d13=_0x48aa00,_0x585d71=new openai_1['default']({'baseURL':_0x37725b[_0x5b8d13(0x331)]+_0x5b8d13(0x2aa)||_0x5b8d13(0x1cb),'apiKey':_0x37725b[_0x5b8d13(0x380)]});return _0x585d71;}async[_0x48aa00(0x39a)](_0x244772,_0x1f2f5a){const _0x5037ca=_0x48aa00;let _0x5891d1=_0x244772['proxyUrl']||'https://ark.cn-beijing.volces.com';const _0x391d50=0x1f40,_0x48b205=0x1000,_0x453186=new this[(_0x5037ca(0x186))]({'maxModelTokens':_0x391d50,'apiBaseUrl':_0x5891d1+'/api/v3','messageStore':this[_0x5037ca(0x30f)],'apiKey':(0x0,utils_1[_0x5037ca(0x2e4)])(_0x244772['key']),'maxResponseTokens':_0x48b205>=_0x391d50?Math['abs'](Math[_0x5037ca(0x232)](_0x391d50/0x2)):_0x48b205});return console[_0x5037ca(0x269)](_0x5037ca(0x3ab),_0x453186['apiKey']),console[_0x5037ca(0x269)](_0x5037ca(0x2f3),_0x1f2f5a),console[_0x5037ca(0x269)](_0x5037ca(0x314),_0x5891d1+_0x5037ca(0x1ef)),_0x453186;}async['kimiUpload'](_0x5b8c8c,_0x413a04,_0x339165=null){const _0x4cc829=_0x48aa00;let _0x52aff5=[];for(const _0x345d43 of _0x413a04){const _0x686620=new URL(_0x345d43);let _0x12855d=(0x0,path_1[_0x4cc829(0x37a)])(process[_0x4cc829(0x247)](),_0x4cc829(0x239),_0x686620[_0x4cc829(0x298)]);_0x12855d=decodeURIComponent(_0x12855d);const _0x4e0d19=await _0x5b8c8c[_0x4cc829(0x388)][_0x4cc829(0x1fd)]({'file':fs['createReadStream'](_0x12855d),'purpose':_0x4cc829(0x288)});let _0x5b4dd4=await(await _0x5b8c8c[_0x4cc829(0x388)][_0x4cc829(0x35e)](_0x4e0d19['id']))[_0x4cc829(0x219)]();_0x52aff5[_0x4cc829(0x2f2)]({'role':'system','content':_0x5b4dd4});}return _0x52aff5;}async[_0x48aa00(0x30d)](_0x35ed0e,_0x1af890){const _0x5a7f0b=_0x48aa00;let _0x3786b2='',_0x74053d=_0x35ed0e[_0x5a7f0b(0x2d8)];return!_0x3786b2&&(_0x3786b2=errorMessage_constant_1[_0x5a7f0b(0x351)][_0x74053d]?errorMessage_constant_1[_0x5a7f0b(0x351)][_0x74053d]:_0x5a7f0b(0x1c8)),_0x35ed0e?.['message'][_0x5a7f0b(0x2c0)](_0x5a7f0b(0x2e3))&&(await this[_0x5a7f0b(0x26d)][_0x5a7f0b(0x29b)](_0x1af890['id'],'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x3786b2=_0x5a7f0b(0x199)),_0x35ed0e?.[_0x5a7f0b(0x2d8)]===0x1ad&&_0x35ed0e[_0x5a7f0b(0x1a1)]['includes'](_0x5a7f0b(0x2db))&&(await this[_0x5a7f0b(0x26d)][_0x5a7f0b(0x29b)](_0x1af890['id'],_0x5a7f0b(0x327),-0x3),_0x3786b2=_0x5a7f0b(0x1f5)),_0x35ed0e?.[_0x5a7f0b(0x2d8)]===0x191&&_0x35ed0e[_0x5a7f0b(0x1a1)][_0x5a7f0b(0x2c0)](_0x5a7f0b(0x1d1))&&(await this[_0x5a7f0b(0x26d)][_0x5a7f0b(0x29b)](_0x1af890['id'],'模型秘钥错误或模型余额不足',-0x2),_0x3786b2=_0x5a7f0b(0x387)),_0x35ed0e?.[_0x5a7f0b(0x2d8)]===0x191&&(_0x3786b2='模型秘钥错误或模型金额不足，请联系管理员！'),_0x35ed0e?.['statusCode']===0x191&&_0x35ed0e[_0x5a7f0b(0x1a1)][_0x5a7f0b(0x2c0)](_0x5a7f0b(0x284))&&(await this[_0x5a7f0b(0x26d)][_0x5a7f0b(0x29b)](_0x1af890['id'],_0x5a7f0b(0x1f7),-0x2),_0x3786b2=_0x5a7f0b(0x387)),_0x35ed0e?.['statusCode']===0x194&&_0x35ed0e[_0x5a7f0b(0x1a1)][_0x5a7f0b(0x2c0)](_0x5a7f0b(0x1e5))&&(await this[_0x5a7f0b(0x26d)][_0x5a7f0b(0x29b)](_0x1af890['id'],_0x5a7f0b(0x296),-0x4),_0x3786b2=_0x5a7f0b(0x23a)),_0x3786b2;}[_0x48aa00(0x24d)](_0x52167e,_0x41ac53,_0x54ccf2,_0x3ce04e,_0x2d7d1f){const _0x4b5195=_0x48aa00;if(_0x54ccf2)_0x52167e['write'](_0x4b5195(0x187)+JSON[_0x4b5195(0x27d)](_0x41ac53)+'\x0a\x0a');else _0x3ce04e&&_0x52167e[_0x4b5195(0x261)](_0x2d7d1f?JSON['stringify'](_0x41ac53):'\x0a'+JSON['stringify'](_0x41ac53));}async[_0x48aa00(0x1b2)](_0xf0d79a,_0x77d6fd,_0x2902d1,_0x295d7f=!![],_0x56e10e=''){const _0x5b0e57=_0x48aa00;try{const _0x2dd3f6=_0x77d6fd[_0x5b0e57(0x32b)],_0xa9be4a=(0x0,utils_1[_0x5b0e57(0x2a5)])(this[_0x5b0e57(0x190)]),{options:options={},prompt:_0x4ddb49,cusromPrompt:_0xc5631f,assetsId:_0xc02cbc,autoVoice:_0x1c8ac1}=_0xf0d79a,{groupId:_0x1070de,usingNetwork:_0x181c77,parentMessageId:_0x1bf450,type:_0x4daf1e}=options,{appId:_0x3ef2f6,modelConfig:_0x2c8036}=await this[_0x5b0e57(0x220)]({'type':_0x4daf1e,'groupId':_0x1070de}),{systemMessage:_0xf15b4,netWorkPrompt:_0x4214b3}=await this[_0x5b0e57(0x3a2)]({'type':_0x4daf1e,'appId':_0x3ef2f6,'prompt':_0x4ddb49,'usingNetwork':_0x181c77,'custom':_0xc5631f,'systemMessage':_0xf0d79a['systemMessage'],'customSystemMessage':_0x2c8036[_0x5b0e57(0x2a9)]['systemMessage']}),_0x54385e=await this['getCurrentModel']({'type':_0x4daf1e,'groupId':_0x1070de,'modelConfig':_0x2c8036,'custom':_0xc5631f});await this['validateBeforeChat']({'prompt':_0x4ddb49,'currentRequestModel':_0x54385e,'user':_0x77d6fd[_0x5b0e57(0x349)]});const _0x6b64a0=await this['autoreplyService']['checkAutoReply'](_0x4ddb49);_0x2902d1&&_0x295d7f&&(!_0xf0d79a[_0x5b0e57(0x250)]?_0x2902d1['setHeader']('Content-type',_0x5b0e57(0x1bf)):(_0x2902d1[_0x5b0e57(0x1ec)](_0x5b0e57(0x2d3),_0x5b0e57(0x2c6)),_0x2902d1[_0x5b0e57(0x1ec)](_0x5b0e57(0x345),_0x5b0e57(0x322)),_0x2902d1['setHeader']('Cache-Control',_0x5b0e57(0x395)),_0x2902d1[_0x5b0e57(0x1ec)]('X-Accel-Buffering','no'),_0x2902d1[_0x5b0e57(0x1ec)](_0x5b0e57(0x2e1),'*')));if(_0x6b64a0){if(_0x2902d1&&_0x295d7f){const _0x3d11bf={'message':_0x6b64a0,'code':0x1f4};_0x2902d1[_0x5b0e57(0x261)](JSON['stringify'](_0x3d11bf)),_0x2902d1[_0x5b0e57(0x3b6)]();return;}else return _0x6b64a0;}const _0x2aab9b=await this['buildOptions'](options[_0x5b0e57(0x19f)],_0xf15b4,_0x54385e);options[_0x5b0e57(0x301)]&&(_0x2aab9b[_0x5b0e57(0x2e6)][_0x5b0e57(0x301)]=options[_0x5b0e57(0x301)]);let {model:_0x25c5ec,rounds:_0x4a11c5,keyType:_0xd2ed20,modelType:_0x20b0fa,id:_0x3672aa,topN:_0x1cc52b}=_0x2c8036[_0x5b0e57(0x2a9)];const {key:_0x59b7ab,modelName:_0x27d755,id:_0x491b13,accessToken:_0x5d82f5}=_0x54385e;_0x25c5ec=_0x2aab9b[_0x5b0e57(0x2e6)][_0x5b0e57(0x301)];_0x2902d1&&_0x295d7f&&_0x2902d1[_0x5b0e57(0x25e)](0xc8);let _0x4fc515=null,_0x456f1a=null;const _0x275ceb=(0x0,utils_1[_0x5b0e57(0x252)])(_0x77d6fd),_0x2b5e96={'appId':_0x3ef2f6,'curIp':_0x275ceb,'prompt':_0x4ddb49,'groupId':_0x1070de,'modelId':_0x3672aa,'modelType':_0x20b0fa,'answer':'','model':_0x25c5ec,'role':_0x5b0e57(0x349),'userId':_0x77d6fd[_0x5b0e57(0x349)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x5b0e57(0x1fa)][_0x5b0e57(0x20e)],'logType':_0x4daf1e==='gpts'?0x2:0x1,'requestOptions':JSON['stringify']({'options':options,'prompt':_0x4ddb49}),'saasId':_0xa9be4a,'modelSubType':_0x56e10e},_0x572ff0={..._0x2b5e96,'role':_0x5b0e57(0x326),'requestOptions':JSON[_0x5b0e57(0x27d)]({'prompt':_0x4ddb49,'options':{'model':_0x25c5ec,'temperature':_0x1cc52b}})};try{if(_0x2902d1){let _0x162da4=null,_0x51311f=![];_0x2902d1['on'](_0x5b0e57(0x1b7),async()=>{const _0x45e536=_0x5b0e57;if(_0x51311f)return;_0x2dd3f6[_0x45e536(0x3af)]();const _0x499e20=0x0,_0x2d6800=0x0,_0x4568ee=_0x499e20+_0x2d6800;_0x2b5e96[_0x45e536(0x373)]=_0x499e20,_0x2b5e96['promptTokens']=_0x499e20,await this[_0x45e536(0x2a8)][_0x45e536(0x26c)](_0x2b5e96),_0x572ff0[_0x45e536(0x353)]=_0x162da4?.[_0x45e536(0x219)],_0x572ff0[_0x45e536(0x373)]=_0x4568ee,_0x572ff0[_0x45e536(0x1c1)]=_0x499e20,_0x572ff0[_0x45e536(0x29d)]=_0x2d6800,_0x572ff0['conversationOptions']=JSON[_0x45e536(0x27d)]({'conversationId':_0x162da4?.[_0x45e536(0x277)],'model':_0x25c5ec,'parentMessageId':_0x162da4?.['id'],'temperature':_0x1cc52b});const _0x83ec68=await this[_0x45e536(0x2a8)][_0x45e536(0x26c)](_0x572ff0);if(_0x56e10e=='mind'){const _0xa36ecc=await this[_0x45e536(0x235)][_0x45e536(0x242)]({'id':_0xc02cbc,'userId':_0x83ec68[_0x45e536(0x359)],'chatLogId':_0x83ec68['id'],'prompt':_0x83ec68['prompt'],'result':_0x572ff0[_0x45e536(0x353)],'status':0x1});_0x4fc515[_0x45e536(0x29a)]=_0xa36ecc['id'];}await this[_0x45e536(0x281)][_0x45e536(0x1d4)](_0x77d6fd[_0x45e536(0x349)]['id'],_0x54385e,_0x83ec68['id']);}),_0x2902d1['on'](_0x5b0e57(0x21d),_0x7528f8=>{console['log'](_0x7528f8);});if(Number(_0xd2ed20)===0x1){let _0x5a2a5f=!![];const _0x3858a7=await this['configChatGptApi'](_0x54385e,_0x2aab9b);_0x4fc515=await _0x3858a7[_0x5b0e57(0x313)](_0x181c77?_0x4214b3:_0x4ddb49,{..._0x2aab9b,'onProgress':_0xf97d6f=>{this['responseMessage'](_0x2902d1,_0xf97d6f,_0xf0d79a['stream'],_0x295d7f,_0x5a2a5f),_0x5a2a5f=![],_0x162da4=_0xf97d6f;},'abortSignal':_0x2dd3f6['signal']}),_0x51311f=!![];}if(Number(_0xd2ed20)===0x2){let _0x4ee31f=!![];const _0x262f62=await this[_0x5b0e57(0x302)][_0x5b0e57(0x392)](_0x181c77?_0x4214b3:_0x4ddb49,{'parentMessageId':_0x1bf450,'maxRounds':(0x0,helper_1[_0x5b0e57(0x3a4)])(_0x4a11c5)});_0x4fc515=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x181c77?_0x4214b3:_0x262f62,{'temperature':_0x1cc52b,'accessToken':_0x5d82f5,'model':_0x25c5ec,'onProgress':_0x374164=>{this['responseMessage'](_0x2902d1,_0x374164,_0xf0d79a['stream'],_0x295d7f,_0x4ee31f),_0x4ee31f=![],_0x162da4=_0x374164;}}),_0x51311f=!![];}if(Number(_0xd2ed20)===0x3){let _0xbf493=!![];const _0x3f35f0=await this[_0x5b0e57(0x302)][_0x5b0e57(0x392)](_0x181c77?_0x4214b3:_0x4ddb49,{'parentMessageId':_0x1bf450,'maxRounds':(0x0,helper_1[_0x5b0e57(0x3a4)])(_0x4a11c5)});console[_0x5b0e57(0x269)](_0x3f35f0),_0x4fc515=await(0x0,zhipu_1[_0x5b0e57(0x209)])(_0x181c77?_0x4214b3:_0x3f35f0,{'temperature':_0x1cc52b,'key':_0x59b7ab,'model':_0x25c5ec,'onProgress':_0xe1a54a=>{const _0x1c4707=_0x5b0e57;this[_0x1c4707(0x24d)](_0x2902d1,_0xe1a54a,_0xf0d79a[_0x1c4707(0x250)],_0x295d7f,_0xbf493),_0xbf493=![],_0x162da4=_0xe1a54a;}}),_0x51311f=!![];}if(Number(_0xd2ed20)===0x4){let _0x5659a1=!![];const _0x158e4b=await this[_0x5b0e57(0x302)][_0x5b0e57(0x392)](_0x181c77?_0x4214b3:_0x4ddb49,{'parentMessageId':_0x1bf450,'maxRounds':(0x0,helper_1[_0x5b0e57(0x3a4)])(_0x4a11c5)});_0x4fc515=await(0x0,spark_1[_0x5b0e57(0x204)])(_0x181c77?_0x4214b3:_0x158e4b,{'temperature':_0x1cc52b,'key':_0x59b7ab,'model':_0x25c5ec,'onProgress':_0x52ebd8=>{const _0x49995a=_0x5b0e57;this[_0x49995a(0x24d)](_0x2902d1,_0x52ebd8,_0xf0d79a[_0x49995a(0x250)],_0x295d7f,_0x5659a1),_0x5659a1=![],_0x162da4=_0x52ebd8;}}),_0x51311f=!![];}if(Number(_0xd2ed20)===0x7){_0x4fc515={};const _0x3768a3=await this[_0x5b0e57(0x193)](_0x54385e);let _0x29926f=!![],_0x1e5c9f=[],_0x4c8c28=!![];const _0x2fdf73=[],_0x588051=[],_0x37cea8=_0x4ddb49['split']('\x20');for(let _0x4a3dd3=0x0;_0x4a3dd3<_0x37cea8[_0x5b0e57(0x2af)];_0x4a3dd3++){_0x29926f&&/^[http:\/\/|https:\/\/]/[_0x5b0e57(0x346)](_0x37cea8[_0x4a3dd3])?_0x2fdf73[_0x5b0e57(0x2f2)](_0x37cea8[_0x4a3dd3]):(_0x29926f=![],_0x37cea8[_0x4a3dd3]&&_0x588051[_0x5b0e57(0x2f2)](_0x37cea8[_0x4a3dd3]));}if(options[_0x5b0e57(0x19f)]){const _0x17766a=await this['chatLogService'][_0x5b0e57(0x23e)](options[_0x5b0e57(0x32d)]);_0x1e5c9f=_0x17766a[_0x5b0e57(0x26b)](_0x218aa9=>{const _0x419029=_0x5b0e57;return{'role':_0x218aa9[_0x419029(0x1e3)]==='user'?_0x419029(0x349):'system','content':_0x218aa9[_0x419029(0x257)]||_0x218aa9[_0x419029(0x353)]};});}const _0xcf53cb=await this[_0x5b0e57(0x361)](_0x3768a3,_0x2fdf73),_0x214b33=[..._0x1e5c9f,..._0xcf53cb,{'role':'system','content':_0x5b0e57(0x20f)+_0x5b0e57(0x35b)+_0x5b0e57(0x25c)},{'role':_0x5b0e57(0x349),'content':_0x588051[_0x5b0e57(0x37a)]('\x20')}];console[_0x5b0e57(0x269)](_0x5b0e57(0x3ab),_0x3768a3[_0x5b0e57(0x3ab)]),console[_0x5b0e57(0x269)](_0x5b0e57(0x2f3),options),console[_0x5b0e57(0x269)]('apiBaseUrl',_0x3768a3[_0x5b0e57(0x33d)]+_0x5b0e57(0x2aa)),console[_0x5b0e57(0x269)](_0x5b0e57(0x254),JSON[_0x5b0e57(0x27d)](_0x214b33));const _0x5c9568=await _0x3768a3[_0x5b0e57(0x1d6)][_0x5b0e57(0x367)][_0x5b0e57(0x1fd)]({'stream':!![],..._0x2aab9b,'messages':_0x214b33,'model':_0x54385e['model']});for await(const _0x379b30 of _0x5c9568){const _0x3c4d08=_0x379b30?.['choices'][0x0],_0x4a8a05=_0x3c4d08?.[_0x5b0e57(0x348)];_0x4fc515[_0x5b0e57(0x2ac)]=_0x379b30,_0x379b30['id']&&(_0x4fc515['id']=_0x379b30['id']),_0x4a8a05['role']&&(_0x4fc515[_0x5b0e57(0x1e3)]=_0x4a8a05[_0x5b0e57(0x1e3)]),_0x4a8a05&&_0x4a8a05[_0x5b0e57(0x35e)]&&(_0x4fc515[_0x5b0e57(0x219)]+=_0x4a8a05[_0x5b0e57(0x35e)],_0x4fc515[_0x5b0e57(0x348)]=_0x4a8a05?.['content']),_0x3c4d08['finish_reason']&&(_0x4fc515[_0x5b0e57(0x219)]=_0x4fc515[_0x5b0e57(0x219)]['trim']()),this[_0x5b0e57(0x24d)](_0x2902d1,_0x4fc515,_0xf0d79a[_0x5b0e57(0x250)],_0x295d7f,_0x4c8c28),_0x4c8c28=![],_0x162da4=_0x379b30;}}if(Number(_0xd2ed20)===0x8){let _0x25ebe6=!![];const _0x593480=await this['configDoubaoApi'](_0x54385e,_0x2aab9b);_0x4fc515=await _0x593480[_0x5b0e57(0x313)](_0x181c77?_0x4214b3:_0x4ddb49,{..._0x2aab9b,'onProgress':_0x2131e3=>{this['responseMessage'](_0x2902d1,_0x2131e3,_0xf0d79a['stream'],_0x295d7f,_0x25ebe6),_0x25ebe6=![],_0x162da4=_0x2131e3;},'abortSignal':_0x2dd3f6[_0x5b0e57(0x393)]}),_0x51311f=!![];}const _0x1ba2ea={'id':this[_0x5b0e57(0x302)][_0x5b0e57(0x226)](),'text':_0x4ddb49,'role':_0x5b0e57(0x349),'name':undefined,'usage':null,'parentMessageId':_0x1bf450,'conversationId':_0x4fc515?.['conversationId']||null};_0x456f1a={'model':_0x25c5ec,'parentMessageId':_0x1bf450},await this['gomaxAiStore'][_0x5b0e57(0x389)](_0x1ba2ea);const _0x263ff3={'id':_0x4fc515?.['id']||this[_0x5b0e57(0x302)]['getUuid'](),'text':_0x4fc515[_0x5b0e57(0x219)],'role':_0x5b0e57(0x326),'name':undefined,'usage':_0x4fc515[_0x5b0e57(0x2c5)],'parentMessageId':_0x1ba2ea['id'],'conversationId':_0x4fc515?.[_0x5b0e57(0x277)]};await this[_0x5b0e57(0x302)][_0x5b0e57(0x389)](_0x263ff3),_0x456f1a={'model':_0x25c5ec,'parentMessageId':_0x1ba2ea['id']};}else{console['log'](_0x5b0e57(0x31b));const _0x62d521=await this[_0x5b0e57(0x212)](_0x54385e,_0x2aab9b);_0x4fc515=await _0x62d521[_0x5b0e57(0x313)](_0x181c77?_0x4214b3:_0x4ddb49,_0x2aab9b);}const _0x143077=(0x0,helper_1['unifiedFormattingResponse'])(_0xd2ed20,_0x4fc515,_0x456f1a),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x143077[_0x5b0e57(0x2c5)];_0x4daf1e===_0x5b0e57(0x31f)?await this['gptsService'][_0x5b0e57(0x289)](_0x491b13,total_tokens):await this[_0x5b0e57(0x26d)][_0x5b0e57(0x3aa)](_0x491b13,total_tokens);_0x2b5e96['totalTokens']=total_tokens,await this['chatLogService'][_0x5b0e57(0x26c)](_0x2b5e96),_0x572ff0[_0x5b0e57(0x353)]=_0x143077?.[_0x5b0e57(0x219)],_0x572ff0['totalTokens']=total_tokens,_0x572ff0[_0x5b0e57(0x1c1)]=prompt_tokens,_0x572ff0['completionTokens']=completion_tokens,_0x572ff0[_0x5b0e57(0x1a8)]=JSON[_0x5b0e57(0x27d)]({'conversationId':_0x4fc515[_0x5b0e57(0x277)],'model':_0x25c5ec,'parentMessageId':_0x4fc515['id'],'temperature':_0x1cc52b});const _0x4b675c=await this['chatLogService'][_0x5b0e57(0x26c)](_0x572ff0);common_1['Logger'][_0x5b0e57(0x202)](_0x5b0e57(0x2bd)+_0x77d6fd[_0x5b0e57(0x349)]['id']+_0x5b0e57(0x22c)+_0x25c5ec+_0x5b0e57(0x1f1)+_0x59b7ab+_0x5b0e57(0x25a)+_0x27d755,_0x5b0e57(0x1c2)),_0x4fc515[_0x5b0e57(0x1b8)]&&(_0x4fc515[_0x5b0e57(0x1b8)]=''),_0x4fc515[_0x5b0e57(0x356)]=!![],_0x4fc515[_0x5b0e57(0x377)]=_0x4b675c['id'];_0x1c8ac1&&setTimeout(()=>{this['saveVoiceChat'](_0x77d6fd,_0x4b675c);},0x64);if(_0x56e10e==_0x5b0e57(0x312)){const _0xb0278=await this['mindTaskService'][_0x5b0e57(0x242)]({'id':_0xc02cbc,'userId':_0x4b675c['userId'],'chatLogId':_0x4b675c['id'],'prompt':_0x4b675c[_0x5b0e57(0x257)],'result':_0x572ff0[_0x5b0e57(0x353)],'status':0x1});_0x4fc515[_0x5b0e57(0x29a)]=_0xb0278['id'];}if(_0x2902d1&&_0x295d7f)await this[_0x5b0e57(0x281)][_0x5b0e57(0x1d4)](_0x77d6fd[_0x5b0e57(0x349)]['id'],_0x54385e,_0x4b675c['id']),_0xf0d79a['stream']?_0x2902d1['write'](_0x5b0e57(0x187)+JSON[_0x5b0e57(0x27d)](_0x4fc515)+'\x0a\x0a'):_0x2902d1[_0x5b0e57(0x261)]('\x0a'+JSON[_0x5b0e57(0x27d)](_0x4fc515));else return _0x4fc515[_0x5b0e57(0x219)];}catch(_0x26e3aa){_0x572ff0['answer']=_0x26e3aa[_0x5b0e57(0x1a1)],_0x572ff0[_0x5b0e57(0x19c)]=_0x26e3aa[_0x5b0e57(0x1a1)],_0x572ff0[_0x5b0e57(0x1a8)]=JSON['stringify']({'conversationId':_0x4fc515?.[_0x5b0e57(0x277)],'model':_0x25c5ec,'parentMessageId':_0x4fc515?.['id'],'temperature':_0x1cc52b});const _0x2bb789=await this[_0x5b0e57(0x2a8)][_0x5b0e57(0x26c)](_0x572ff0);if(_0x56e10e==_0x5b0e57(0x312)){const _0x3b1d38=await this[_0x5b0e57(0x235)][_0x5b0e57(0x242)]({'id':_0xc02cbc,'userId':_0x2bb789[_0x5b0e57(0x359)],'prompt':_0x2bb789['prompt'],'chatLogId':_0x2bb789['id'],'result':_0x572ff0['answer'],'status':-0x1});_0x4fc515[_0x5b0e57(0x29a)]=_0x3b1d38['id'];}const _0xbe9d59=_0x26e3aa[_0x5b0e57(0x2d8)];_0xbe9d59===0x190&&console['log']('400\x20error',_0x26e3aa,_0x26e3aa['message']);if(_0x26e3aa[_0x5b0e57(0x25e)]&&_0x26e3aa[_0x5b0e57(0x25e)]===0x192){const _0x31a23f={'message':_0x5b0e57(0x2d4)+_0x26e3aa[_0x5b0e57(0x1a1)],'code':0x192};if(_0x2902d1&&_0x295d7f){_0xf0d79a[_0x5b0e57(0x250)]?_0x2902d1[_0x5b0e57(0x261)](_0x5b0e57(0x187)+JSON[_0x5b0e57(0x27d)](_0x31a23f)+'\x0a\x0a'):_0x2902d1['write'](JSON[_0x5b0e57(0x27d)](_0x31a23f));_0x2902d1[_0x5b0e57(0x3b6)]();return;}else throw new common_1[(_0x5b0e57(0x385))](_0x26e3aa[_0x5b0e57(0x1a1)],common_1[_0x5b0e57(0x398)][_0x5b0e57(0x1fb)]);}if(!_0xbe9d59){if(_0x2902d1&&_0x295d7f){_0xf0d79a[_0x5b0e57(0x250)]?_0x2902d1[_0x5b0e57(0x261)](_0x5b0e57(0x187)+JSON[_0x5b0e57(0x27d)]({'message':_0x26e3aa['message'],'code':0x1f4})+'\x0a\x0a'):_0x2902d1[_0x5b0e57(0x261)](JSON[_0x5b0e57(0x27d)]({'message':_0x26e3aa[_0x5b0e57(0x1a1)],'code':0x1f4}));_0x2902d1[_0x5b0e57(0x3b6)]();return;}else throw new common_1[(_0x5b0e57(0x385))](_0x26e3aa[_0x5b0e57(0x1a1)],common_1[_0x5b0e57(0x398)][_0x5b0e57(0x350)]);}const _0x5cd561=await this[_0x5b0e57(0x30d)](_0x26e3aa,_0x54385e),_0x5f2a88={'message':_0x5cd561||'Please\x20check\x20the\x20back-end\x20console','code':_0xbe9d59===0x191?0x191:_0xbe9d59||0x1f4};if(_0x2902d1&&_0x295d7f)_0x2902d1[_0x5b0e57(0x2d8)]=0x190,_0xf0d79a['stream']?_0x2902d1[_0x5b0e57(0x261)](_0x5b0e57(0x187)+JSON[_0x5b0e57(0x27d)](_0x5f2a88)+'\x0a\x0a'):_0x2902d1[_0x5b0e57(0x261)](JSON[_0x5b0e57(0x27d)](_0x5f2a88));else throw new common_1[(_0x5b0e57(0x385))](_0x5f2a88[_0x5b0e57(0x1a1)],common_1[_0x5b0e57(0x398)][_0x5b0e57(0x350)]);}finally{_0x2902d1&&_0x295d7f&&_0x2902d1[_0x5b0e57(0x3b6)]();}}catch(_0xa6b25c){if(_0xa6b25c instanceof common_1[_0x5b0e57(0x385)])throw _0xa6b25c;else throw new common_1[(_0x5b0e57(0x385))](_0xa6b25c[_0x5b0e57(0x1a1)],common_1[_0x5b0e57(0x398)]['BAD_REQUEST']);}}async['saveVoiceChat'](_0x259311,_0x2e2b88){const _0x51743f=_0x48aa00,_0x4d1c77=await this[_0x51743f(0x2e9)](_0x259311,{'request':{'text':_0x2e2b88[_0x51743f(0x353)]}});_0x2e2b88[_0x51743f(0x1e1)]=_0x4d1c77,this[_0x51743f(0x2a8)][_0x51743f(0x26c)](_0x2e2b88);}async['musicConfig'](_0x17febf){const _0x41f1d8=_0x48aa00;try{const _0x44d49d=[_0x41f1d8(0x229),_0x41f1d8(0x1d7),'musicCreatePrice',_0x41f1d8(0x195),_0x41f1d8(0x371),'musicUploadVipFree'],_0x369b9e=await this[_0x41f1d8(0x223)][_0x41f1d8(0x1b3)](_0x44d49d);if(!_0x17febf['user']||!_0x17febf[_0x41f1d8(0x349)]['id'])throw new Error('Invalid\x20user\x20information');const _0x1080c2=[_0x41f1d8(0x234),_0x41f1d8(0x2eb),_0x41f1d8(0x1a9)],_0x58e20e=await Promise['all'](_0x1080c2[_0x41f1d8(0x26b)](async _0x55d61a=>{const _0x195702=_0x41f1d8,_0x3c9504=_0x369b9e[_0x55d61a+'VipFree'],_0x2676cb=_0x369b9e[_0x55d61a+'Price'],_0x1bcf9d=redisKey_constant_1[_0x195702(0x22a)]+'-'+_0x17febf[_0x195702(0x349)]['id']+'-'+(_0x55d61a+_0x195702(0x28b)),_0x4bda18=await this[_0x195702(0x281)][_0x195702(0x32a)](_0x17febf[_0x195702(0x349)]['id'],_0x1bcf9d,_0x3c9504);return{'type':_0x55d61a,'remainCount':_0x4bda18,'freeCount':Number(_0x3c9504),'useIntegrate':Number(_0x2676cb)};}));return _0x58e20e;}catch(_0x5ace4a){console[_0x41f1d8(0x21d)](_0x41f1d8(0x1d5),_0x5ace4a);throw _0x5ace4a;}}async[_0x48aa00(0x2dd)](_0x5a9eea){const _0x35f7cb=_0x48aa00,{data:_0x59c29a,answerLogDTO:_0x4a761b,currentRequestModel:_0x2b3ed9,musicTaskType:_0x45aad3}=_0x5a9eea;try{let _0x3b2b70=process['env'][_0x35f7cb(0x1ba)];!/^http/[_0x35f7cb(0x346)](_0x3b2b70)&&(_0x3b2b70='https://'+_0x3b2b70);let _0x2fe79d;if(_0x45aad3==music_constant_1[_0x35f7cb(0x2c9)][_0x35f7cb(0x253)])!_0x59c29a[_0x35f7cb(0x2ef)]&&(_0x59c29a['gpt_description_prompt']=_0x59c29a[_0x35f7cb(0x257)],delete _0x59c29a[_0x35f7cb(0x257)]),_0x2fe79d=await this[_0x35f7cb(0x1e8)]['music']({'data':_0x59c29a,'baseURL':_0x2b3ed9[_0x35f7cb(0x331)],'headers':{'Authorization':_0x35f7cb(0x2e2)+_0x2b3ed9[_0x35f7cb(0x380)]}});else _0x45aad3==music_constant_1[_0x35f7cb(0x2c9)][_0x35f7cb(0x28c)]?(_0x59c29a['notify_hook']=_0x3b2b70+(_0x35f7cb(0x2e5)+_0x4a761b['id']),_0x2fe79d=await this['sunoTaskService'][_0x35f7cb(0x287)]({'data':_0x59c29a,'baseURL':_0x2b3ed9[_0x35f7cb(0x331)],'headers':{'Authorization':_0x35f7cb(0x2e2)+_0x2b3ed9['key']}})):(_0x59c29a[_0x35f7cb(0x1c9)]=_0x3b2b70+(_0x35f7cb(0x36e)+_0x4a761b['id']),_0x2fe79d=await this[_0x35f7cb(0x1e8)]['upload']({'data':_0x59c29a,'baseURL':_0x2b3ed9[_0x35f7cb(0x331)],'headers':{'Authorization':_0x35f7cb(0x2e2)+_0x2b3ed9[_0x35f7cb(0x380)]}}));await this[_0x35f7cb(0x26d)][_0x35f7cb(0x3aa)](_0x2b3ed9['id'],0x0),_0x4a761b['totalTokens']=0x0,_0x4a761b['promptTokens']=0x0,_0x4a761b[_0x35f7cb(0x29d)]=0x0,_0x4a761b[_0x35f7cb(0x1ee)]=_0x2fe79d[_0x35f7cb(0x238)],_0x4a761b[_0x35f7cb(0x29c)]=_0x45aad3,_0x4a761b[_0x35f7cb(0x1a8)]=JSON[_0x35f7cb(0x27d)]({'model':_0x2b3ed9[_0x35f7cb(0x301)],'parentMessageId':_0x2fe79d['data']}),await this['chatLogService'][_0x35f7cb(0x26c)](_0x4a761b),common_1[_0x35f7cb(0x2bf)][_0x35f7cb(0x202)](_0x35f7cb(0x2bd)+_0x4a761b[_0x35f7cb(0x359)]+'\x20model:\x20'+_0x2b3ed9[_0x35f7cb(0x301)]+_0x35f7cb(0x1f1)+_0x2b3ed9[_0x35f7cb(0x380)]+_0x35f7cb(0x25a)+_0x2b3ed9[_0x35f7cb(0x2b2)],'SunoMusicTask');if(_0x2fe79d[_0x35f7cb(0x245)]!=='success')throw new Error('音乐生成失败，没有响应');}catch(_0x4507f6){console[_0x35f7cb(0x269)]('music-task',_0x2b3ed9[_0x35f7cb(0x380)],_0x4507f6);const _0xea63db=await this[_0x35f7cb(0x30d)](_0x4507f6,_0x2b3ed9);_0x4a761b[_0x35f7cb(0x19c)]=_0xea63db,await this[_0x35f7cb(0x2a8)][_0x35f7cb(0x26c)](_0x4a761b),await this['userService'][_0x35f7cb(0x197)](_0x4a761b[_0x35f7cb(0x359)],_0x4a761b['id'],_0x45aad3,!![]);}}async[_0x48aa00(0x21a)](_0x25d75c){const _0xcc1a8d=_0x48aa00,{data:_0x608296,answerLogDTO:_0x252b00,currentRequestModel:_0x1fd066}=_0x25d75c;try{let _0x3b9ae3;await this['userService']['deductBalance4Chat'](_0x252b00['userId'],_0x1fd066,_0x252b00['id']);_0x608296[_0xcc1a8d(0x3b3)]?_0x3b9ae3=await this[_0xcc1a8d(0x340)][_0xcc1a8d(0x27b)]({'data':_0x608296,'baseURL':_0x1fd066[_0xcc1a8d(0x331)],'headers':{'Authorization':'Bearer\x20'+_0x1fd066[_0xcc1a8d(0x380)]}},_0x608296[_0xcc1a8d(0x3b3)]):_0x3b9ae3=await this[_0xcc1a8d(0x340)][_0xcc1a8d(0x338)]({'data':_0x608296,'baseURL':_0x1fd066[_0xcc1a8d(0x331)],'headers':{'Authorization':_0xcc1a8d(0x2e2)+_0x1fd066['key']}});await this[_0xcc1a8d(0x26d)][_0xcc1a8d(0x3aa)](_0x1fd066['id'],0x0),_0x252b00[_0xcc1a8d(0x373)]=0x0,_0x252b00[_0xcc1a8d(0x1c1)]=0x0,_0x252b00[_0xcc1a8d(0x29d)]=0x0,_0x252b00[_0xcc1a8d(0x353)]=_0x3b9ae3['state'],_0x252b00[_0xcc1a8d(0x1a8)]=JSON[_0xcc1a8d(0x27d)]({'model':_0x1fd066['model'],'parentMessageId':_0x3b9ae3['id']}),await this['chatLogService'][_0xcc1a8d(0x26c)](_0x252b00),common_1[_0xcc1a8d(0x2bf)][_0xcc1a8d(0x202)](_0xcc1a8d(0x2bd)+_0x252b00['userId']+'\x20model:\x20'+_0x1fd066[_0xcc1a8d(0x301)]+_0xcc1a8d(0x1f1)+_0x1fd066[_0xcc1a8d(0x380)]+_0xcc1a8d(0x25a)+_0x1fd066['modelName'],'ChatgptService');if(!_0x252b00[_0xcc1a8d(0x353)])throw new Error(_0xcc1a8d(0x32c));await this[_0xcc1a8d(0x2a8)]['parseAndSaveVideo'](_0x252b00,{'id':_0x3b9ae3['id'],'state':_0x3b9ae3[_0xcc1a8d(0x317)],'completed':_0x3b9ae3['state']===_0xcc1a8d(0x1be),'videoUrl':_0x3b9ae3[_0xcc1a8d(0x34b)]?.[_0xcc1a8d(0x285)]});}catch(_0x3a3f08){console[_0xcc1a8d(0x269)](_0xcc1a8d(0x334),_0x1fd066[_0xcc1a8d(0x380)],_0x3a3f08);const _0x2ae12d=await this[_0xcc1a8d(0x30d)](_0x3a3f08,_0x1fd066);_0x252b00['errMsg']=_0x2ae12d,await this[_0xcc1a8d(0x2a8)][_0xcc1a8d(0x26c)](_0x252b00),await this[_0xcc1a8d(0x281)]['refundBalance4Chat'](_0x252b00[_0xcc1a8d(0x359)],_0x1fd066,_0x252b00['id']);}}async['runwayVideoTask'](_0x3819bf){const _0x261150=_0x48aa00,{data:_0x22e42f,answerLogDTO:_0xc4ced3,currentRequestModel:_0x2058bc}=_0x3819bf;try{let _0x4cece8;await this[_0x261150(0x281)][_0x261150(0x1d4)](_0xc4ced3[_0x261150(0x359)],_0x2058bc,_0xc4ced3['id']);const _0x4ada81=_0x22e42f[_0x261150(0x1c0)],_0x36d19d={'model':_0x22e42f[_0x261150(0x301)],'ratio':_0x22e42f[_0x261150(0x1f2)],'prompt':_0x22e42f[_0x261150(0x257)],'style':_0x22e42f[_0x261150(0x191)],'options':_0x4ada81};_0x22e42f[_0x261150(0x211)]&&(_0x36d19d[_0x261150(0x211)]=_0x22e42f[_0x261150(0x211)]);_0x22e42f[_0x261150(0x339)]&&(_0x36d19d[_0x261150(0x339)]=_0x22e42f[_0x261150(0x339)]);_0x4cece8=await this[_0x261150(0x24a)]['creat']({'data':_0x36d19d,'baseURL':_0x2058bc[_0x261150(0x331)],'headers':{'Authorization':'Bearer\x20'+_0x2058bc[_0x261150(0x380)]}}),await this[_0x261150(0x26d)]['saveUseLog'](_0x2058bc['id'],0x0),_0xc4ced3[_0x261150(0x373)]=0x0,_0xc4ced3[_0x261150(0x1c1)]=0x0,_0xc4ced3[_0x261150(0x29d)]=0x0,_0xc4ced3[_0x261150(0x19c)]=_0x4cece8[_0x261150(0x2d2)],_0xc4ced3['answer']=_0x4cece8[_0x261150(0x25e)]=='3'?_0x261150(0x2dc):_0x4cece8[_0x261150(0x25e)],_0xc4ced3[_0x261150(0x1a8)]=JSON['stringify']({'model':_0x2058bc[_0x261150(0x301)],'parentMessageId':_0x4cece8[_0x261150(0x25f)]}),await this[_0x261150(0x2a8)][_0x261150(0x26c)](_0xc4ced3),common_1[_0x261150(0x2bf)][_0x261150(0x202)]('本次调用:\x20'+_0xc4ced3['userId']+_0x261150(0x22c)+_0x2058bc[_0x261150(0x301)]+_0x261150(0x1f1)+_0x2058bc[_0x261150(0x380)]+',\x20模型名称:\x20'+_0x2058bc['modelName'],_0x261150(0x1c2));if(_0x4cece8[_0x261150(0x2d2)])throw new Error(_0x261150(0x32c));await this[_0x261150(0x2a8)][_0x261150(0x2f8)](_0xc4ced3,{'id':_0x4cece8[_0x261150(0x25f)],'state':_0x4cece8[_0x261150(0x25e)]=='3'?_0x261150(0x2dc):_0x4cece8[_0x261150(0x25e)],'completed':_0x4cece8[_0x261150(0x25e)]==='3','videoUrl':_0x4cece8[_0x261150(0x3a5)]});}catch(_0x268768){console[_0x261150(0x269)]('video-task',_0x2058bc[_0x261150(0x380)],_0x268768);const _0x2eff69=await this[_0x261150(0x30d)](_0x268768,_0x2058bc);_0xc4ced3['errMsg']=_0x2eff69,await this[_0x261150(0x2a8)]['saveChatLog'](_0xc4ced3),await this[_0x261150(0x281)][_0x261150(0x25d)](_0xc4ced3['userId'],_0x2058bc,_0xc4ced3['id']);}}async[_0x48aa00(0x1cc)](_0x1e689c){const _0x3c418d=_0x48aa00,{data:_0xb0e1f6,answerLogDTO:_0x1ee8df,currentRequestModel:_0x52649b}=_0x1e689c;try{let _0x1dbb80;await this[_0x3c418d(0x281)][_0x3c418d(0x1d4)](_0x1ee8df[_0x3c418d(0x359)],_0x52649b,_0x1ee8df['id']);!_0xb0e1f6['model_name']?(_0xb0e1f6[_0x3c418d(0x1a6)]=_0xb0e1f6[_0x3c418d(0x301)],delete _0xb0e1f6['model']):delete _0xb0e1f6[_0x3c418d(0x301)];_0xb0e1f6[_0x3c418d(0x211)]?_0x1dbb80=await this[_0x3c418d(0x3b1)][_0x3c418d(0x36c)]({'data':_0xb0e1f6,'baseURL':_0x52649b[_0x3c418d(0x331)],'headers':{'Authorization':_0x3c418d(0x2e2)+_0x52649b[_0x3c418d(0x380)]}}):_0x1dbb80=await this[_0x3c418d(0x3b1)][_0x3c418d(0x18f)]({'data':_0xb0e1f6,'baseURL':_0x52649b[_0x3c418d(0x331)],'headers':{'Authorization':_0x3c418d(0x2e2)+_0x52649b[_0x3c418d(0x380)]}});await this[_0x3c418d(0x26d)][_0x3c418d(0x3aa)](_0x52649b['id'],0x0),_0x1ee8df['totalTokens']=0x0,_0x1ee8df[_0x3c418d(0x1c1)]=0x0,_0x1ee8df['completionTokens']=0x0,_0x1ee8df['answer']=_0x1dbb80['task_status'],_0x1ee8df['conversationOptions']=JSON[_0x3c418d(0x27d)]({'model':_0x52649b[_0x3c418d(0x301)],'parentMessageId':_0x1dbb80[_0x3c418d(0x25f)]}),await this['chatLogService'][_0x3c418d(0x26c)](_0x1ee8df),common_1[_0x3c418d(0x2bf)][_0x3c418d(0x202)](_0x3c418d(0x2bd)+_0x1ee8df[_0x3c418d(0x359)]+_0x3c418d(0x22c)+_0x52649b[_0x3c418d(0x301)]+_0x3c418d(0x1f1)+_0x52649b[_0x3c418d(0x380)]+_0x3c418d(0x25a)+_0x52649b[_0x3c418d(0x2b2)],_0x3c418d(0x1c2));if(!_0x1ee8df[_0x3c418d(0x353)]||_0x1ee8df[_0x3c418d(0x353)]===_0x3c418d(0x28f))throw new Error(_0x3c418d(0x32c));await this[_0x3c418d(0x2a8)][_0x3c418d(0x2f8)](_0x1ee8df,{'id':_0x1dbb80[_0x3c418d(0x25f)],'state':_0x1dbb80[_0x3c418d(0x275)],'completed':_0x1dbb80[_0x3c418d(0x275)]===_0x3c418d(0x39d),'videoUrl':_0x1dbb80[_0x3c418d(0x3b4)]&&_0x1dbb80[_0x3c418d(0x3b4)][_0x3c418d(0x1f6)]&&_0x1dbb80[_0x3c418d(0x3b4)][_0x3c418d(0x1f6)][_0x3c418d(0x2af)]?_0x1dbb80[_0x3c418d(0x3b4)][_0x3c418d(0x1f6)][0x0]?.[_0x3c418d(0x285)]:''});}catch(_0x261bff){console[_0x3c418d(0x269)]('video-task',_0x52649b[_0x3c418d(0x380)],_0x261bff);const _0x31d520=await this['openAiErrHandler'](_0x261bff,_0x52649b);_0x1ee8df[_0x3c418d(0x19c)]=_0x31d520,await this['chatLogService'][_0x3c418d(0x26c)](_0x1ee8df),await this['userService'][_0x3c418d(0x25d)](_0x1ee8df[_0x3c418d(0x359)],_0x52649b,_0x1ee8df['id']);}}async[_0x48aa00(0x236)](_0x2f8bf7){const _0x1b0c7a=_0x48aa00;try{const _0x44b05d=(0x0,utils_1[_0x1b0c7a(0x2a5)])(this[_0x1b0c7a(0x190)]),{req:_0x24f016,model:_0x297efb,modelType:_0x4e8cf5,datas:_0x320dc1,requestBody:_0x79bc91,musicTaskType:_0x127f02}=_0x2f8bf7;let _0x45ac10,_0x1c4ce3;const _0x21c77d=await this['getModelConfig']({'modelType':_0x4e8cf5});_0x45ac10=_0x21c77d[_0x1b0c7a(0x273)],_0x1c4ce3=_0x21c77d[_0x1b0c7a(0x304)];let _0x189186='';_0x1b0c7a(0x257)in _0x320dc1&&(_0x189186=_0x320dc1[_0x1b0c7a(0x257)]);const _0xcd988=await this[_0x1b0c7a(0x26d)][_0x1b0c7a(0x293)](_0x4e8cf5,_0x4e8cf5===model_constant_1[_0x1b0c7a(0x2a0)]['VIDEO']?_0x297efb:'');_0xcd988[_0x1b0c7a(0x301)]=_0x297efb,_0x1c4ce3[_0x1b0c7a(0x2a9)][_0x1b0c7a(0x301)]=_0x297efb;_0x1b0c7a(0x257)in _0x320dc1&&await this[_0x1b0c7a(0x21b)]({'prompt':_0x189186,'currentRequestModel':_0xcd988,'user':_0x24f016[_0x1b0c7a(0x349)]});let {id:_0x1f8781,topN:_0x11d7b8,keyType:_0x484bd7}=_0x1c4ce3[_0x1b0c7a(0x2a9)];const _0xde65f4=0x0,_0x5a80bc=0x0,_0x2ddc0c=_0xde65f4+_0x5a80bc,_0x493ca8=(0x0,utils_1['getClientIp'])(_0x24f016),_0x10c57f={'appId':_0x45ac10,'curIp':_0x493ca8,'prompt':_0x189186,'modelId':_0x1f8781,'modelType':_0x4e8cf5,'answer':'','model':_0x297efb,'role':_0x1b0c7a(0x349),'userId':_0x24f016[_0x1b0c7a(0x349)]['id'],'completionTokens':0x0,'totalTokens':_0x2ddc0c,'type':balance_constant_1[_0x1b0c7a(0x1fa)][_0x1b0c7a(0x20e)],'logType':0x1,'modelSubType':'','requestParams':_0x79bc91||_0x320dc1,'requestOptions':JSON[_0x1b0c7a(0x27d)]({'options':null,'prompt':_0x189186}),'saasId':_0x44b05d},_0x2da4fa={..._0x10c57f,'role':'assistant','requestOptions':JSON[_0x1b0c7a(0x27d)]({'prompt':_0x189186,'options':{'model':_0x297efb,'temperature':_0x11d7b8}})};await this[_0x1b0c7a(0x2a8)][_0x1b0c7a(0x26c)](_0x10c57f);const _0x1fd5f2=await this['chatLogService']['saveChatLog'](_0x2da4fa);return await this[_0x1b0c7a(0x281)]['debuctBalance4Muisc'](_0x24f016[_0x1b0c7a(0x349)]['id'],_0x1fd5f2['id'],_0x127f02),await this[_0x1b0c7a(0x2dd)]({'data':_0x320dc1,'currentRequestModel':_0xcd988,'answerLogDTO':_0x1fd5f2,'musicTaskType':_0x127f02}),_0x1fd5f2;}catch(_0x36fb62){if(_0x36fb62 instanceof common_1[_0x1b0c7a(0x385)])throw _0x36fb62;else throw new common_1['HttpException'](_0x36fb62[_0x1b0c7a(0x1a1)],common_1[_0x1b0c7a(0x398)][_0x1b0c7a(0x350)]);}}async[_0x48aa00(0x2b0)](_0x509a52){const _0x5b9172=_0x48aa00;try{const _0x394235=(0x0,utils_1[_0x5b9172(0x2a5)])(this[_0x5b9172(0x190)]),{req:_0x311663,model:_0x11415f,modelType:_0x4005d8,datas:_0x4d8ffb,requestBody:_0x5aaa1a}=_0x509a52,{prompt:_0x2cd975,options:options={}}=_0x4d8ffb,{groupId:_0x89e8d3,type:_0x40b250}=options;let _0x25357b,_0x5352da;if(_0x4005d8===model_constant_1[_0x5b9172(0x2a0)][_0x5b9172(0x31c)]){const _0x50acb3=await this[_0x5b9172(0x220)]({'modelType':_0x4005d8,'officialModel':_0x11415f});_0x25357b=_0x50acb3[_0x5b9172(0x273)],_0x5352da=_0x50acb3[_0x5b9172(0x304)];}else{const _0x192c99=await this[_0x5b9172(0x220)]({'modelType':_0x4005d8});_0x25357b=_0x192c99[_0x5b9172(0x273)],_0x5352da=_0x192c99[_0x5b9172(0x304)];}const _0xcff581=await this[_0x5b9172(0x26d)][_0x5b9172(0x293)](_0x4005d8,_0x4005d8===model_constant_1[_0x5b9172(0x2a0)][_0x5b9172(0x31c)]?_0x11415f:'');_0xcff581[_0x5b9172(0x301)]=_0x11415f,_0x5352da[_0x5b9172(0x2a9)][_0x5b9172(0x301)]=_0x11415f;_0x4005d8===model_constant_1[_0x5b9172(0x2a0)][_0x5b9172(0x31c)]?await this[_0x5b9172(0x27e)]({'prompt':_0x2cd975,'currentRequestModel':_0xcff581,'user':_0x311663['user'],'params':_0x5aaa1a}):await this[_0x5b9172(0x21b)]({'prompt':_0x2cd975,'currentRequestModel':_0xcff581,'user':_0x311663[_0x5b9172(0x349)]});let {id:_0x54f69c,topN:_0x4a0e7f,keyType:_0x1583ee}=_0x5352da[_0x5b9172(0x2a9)];const _0x562f67=0x0,_0x229964=0x0,_0x3f21df=_0x562f67+_0x229964,_0x282212=(0x0,utils_1[_0x5b9172(0x252)])(_0x311663),_0x2fc333={'appId':_0x25357b,'curIp':_0x282212,'prompt':_0x2cd975,'groupId':_0x89e8d3,'modelId':_0x54f69c,'modelType':_0x4005d8,'answer':'','model':_0x11415f,'role':_0x5b9172(0x349),'userId':_0x311663[_0x5b9172(0x349)]['id'],'completionTokens':0x0,'totalTokens':_0x3f21df,'type':balance_constant_1[_0x5b9172(0x1fa)][_0x5b9172(0x20e)],'logType':_0x40b250===_0x5b9172(0x31f)?0x2:0x1,'modelSubType':_0x4005d8===model_constant_1[_0x5b9172(0x2a0)][_0x5b9172(0x31c)]?_0x1583ee[_0x5b9172(0x35d)]():'','requestParams':_0x5aaa1a||_0x4d8ffb,'requestOptions':JSON[_0x5b9172(0x27d)]({'options':null,'prompt':_0x2cd975}),'saasId':_0x394235},_0x3ce480={..._0x2fc333,'role':_0x5b9172(0x326),'requestOptions':JSON[_0x5b9172(0x27d)]({'prompt':_0x2cd975,'options':{'model':_0x11415f,'temperature':_0x4a0e7f}})};await this[_0x5b9172(0x2a8)][_0x5b9172(0x26c)](_0x2fc333);const _0x501804=await this[_0x5b9172(0x2a8)][_0x5b9172(0x26c)](_0x3ce480);if(_0x4005d8===model_constant_1[_0x5b9172(0x2a0)][_0x5b9172(0x31c)]){await this['userService'][_0x5b9172(0x33a)](_0x311663['user']['id'],_0xcff581,_0x5aaa1a,_0x501804['id']);switch(_0x1583ee){case 0x2:this[_0x5b9172(0x1da)]({'data':_0x4d8ffb,'currentRequestModel':_0xcff581,'answerLogDTO':_0x501804});break;case 0x3:this[_0x5b9172(0x1cc)]({'data':_0x4d8ffb,'currentRequestModel':_0xcff581,'answerLogDTO':_0x501804});break;default:this[_0x5b9172(0x21a)]({'data':_0x4d8ffb,'currentRequestModel':_0xcff581,'answerLogDTO':_0x501804});}}else await this[_0x5b9172(0x281)][_0x5b9172(0x1d4)](_0x311663[_0x5b9172(0x349)]['id'],_0xcff581,_0x501804['id']);return _0x501804;}catch(_0x22f5e0){if(_0x22f5e0 instanceof common_1[_0x5b9172(0x385)])throw _0x22f5e0;else throw new common_1[(_0x5b9172(0x385))](_0x22f5e0['message'],common_1[_0x5b9172(0x398)][_0x5b9172(0x350)]);}}async['chatMusic'](_0x2b761a,_0x5e6148){const _0x5b723e=_0x48aa00;let {mv:_0x54e3b0}=_0x2b761a;return!_0x2b761a[_0x5b723e(0x291)]?_0x2b761a[_0x5b723e(0x291)]=![]:_0x2b761a[_0x5b723e(0x291)]=!![],this[_0x5b723e(0x236)]({'req':_0x5e6148,'datas':_0x2b761a,'model':_0x54e3b0||'suno-v3','modelType':model_constant_1['EModelType']['MUSIC'],'musicTaskType':music_constant_1['EMusicTaskType'][_0x5b723e(0x253)]});}async[_0x48aa00(0x31d)](_0xf74d3,_0x530601){const _0x312e7f=_0x48aa00,_0x4543a3={'url':_0xf74d3};return this['chatMuiscTask']({'req':_0x530601,'datas':_0x4543a3,'model':'suno-v3','modelType':model_constant_1[_0x312e7f(0x2a0)]['MUSIC'],'musicTaskType':music_constant_1[_0x312e7f(0x2c9)]['UPLOAD']});}async[_0x48aa00(0x2da)](_0x15e367,_0x3e65e7){const _0x1ce702=_0x48aa00;return this[_0x1ce702(0x236)]({'req':_0x3e65e7,'datas':_0x15e367,'model':_0x1ce702(0x213),'modelType':model_constant_1[_0x1ce702(0x2a0)][_0x1ce702(0x378)],'musicTaskType':music_constant_1[_0x1ce702(0x2c9)]['LYRICS']});}async[_0x48aa00(0x283)](_0x13b788,_0x1b5c8e){const _0x58ff1e=_0x48aa00,_0x50af4d=JSON[_0x58ff1e(0x2ed)](JSON['stringify'](_0x13b788));let {model:_0x55c3af,prompt:_0x1a3608,expand_prompt:_0xde5d9c,aspect_ratio:_0x3df85a,image_url:_0x23ce85,image_end_url:_0x4b7639}=_0x13b788,_0x5a8635=_0x58ff1e(0x227)+_0x1a3608+'\x20--expand_prompt\x20'+_0xde5d9c+_0x58ff1e(0x368)+_0x3df85a;return _0x23ce85&&(_0x5a8635=_0x5a8635+'\x20image_url\x20'+_0x23ce85),_0x4b7639&&(_0x5a8635=_0x5a8635+'\x20image_end_url\x20'+_0x4b7639),_0x13b788[_0x58ff1e(0x257)]=_0x5a8635,_0x13b788[_0x58ff1e(0x31e)]=_0x1a3608,this[_0x58ff1e(0x2b0)]({'req':_0x1b5c8e,'datas':_0x13b788,'requestBody':_0x50af4d,'model':_0x55c3af||_0x58ff1e(0x1dd),'modelType':model_constant_1['EModelType'][_0x58ff1e(0x31c)]});}async[_0x48aa00(0x1bd)](_0x770402,_0x6f818){const _0x4e1201=_0x48aa00,_0x5085a8=JSON[_0x4e1201(0x2ed)](JSON[_0x4e1201(0x27d)](_0x770402));return this['chatTask']({'req':_0x6f818,'datas':_0x770402,'requestBody':_0x5085a8,'model':_0x770402[_0x4e1201(0x301)]||'gen2','modelType':model_constant_1[_0x4e1201(0x2a0)][_0x4e1201(0x31c)]});}async[_0x48aa00(0x2e8)](_0x356e21,_0x1a28a7){const _0x122dc2=_0x48aa00,_0x6abac2=JSON['parse'](JSON[_0x122dc2(0x27d)](_0x356e21));return this[_0x122dc2(0x2b0)]({'req':_0x1a28a7,'datas':_0x356e21,'requestBody':_0x6abac2,'model':_0x356e21[_0x122dc2(0x301)]||'kling-video_std_5','modelType':model_constant_1[_0x122dc2(0x2a0)][_0x122dc2(0x31c)]});}async[_0x48aa00(0x1ea)](){const _0x7597a4=_0x48aa00,_0x501acd=await this['chatLogService'][_0x7597a4(0x39c)]();if(!_0x501acd[_0x7597a4(0x2af)])return;const _0x49bc44=[],_0x3e8491=new Map();_0x501acd[_0x7597a4(0x215)](_0x318b1d=>{const _0x3d0541=_0x7597a4;_0x49bc44[_0x3d0541(0x2f2)](_0x318b1d['id']),_0x3e8491[_0x3d0541(0x263)](_0x318b1d['id'],_0x318b1d);});const _0x530f16=await this[_0x7597a4(0x2a8)][_0x7597a4(0x381)](_0x49bc44),_0x3c2e44=[],_0x1c4bfa=new Map();_0x530f16[_0x7597a4(0x215)](_0x36b8cc=>{const _0x5d364b=_0x7597a4;_0x3c2e44[_0x5d364b(0x2f2)](_0x36b8cc[_0x5d364b(0x2c4)]),_0x1c4bfa[_0x5d364b(0x263)](_0x36b8cc['sunoMusicId'],_0x36b8cc);});const _0x2275ec=await this[_0x7597a4(0x26d)][_0x7597a4(0x293)](model_constant_1[_0x7597a4(0x2a0)][_0x7597a4(0x31c)]),_0x3e84eb=await this[_0x7597a4(0x340)][_0x7597a4(0x2cb)]({'baseURL':_0x2275ec[_0x7597a4(0x331)],'headers':{'Authorization':'Bearer\x20'+_0x2275ec['key']},'data':{'ids':_0x3c2e44}});for(let _0x40ac6d=0x0;_0x40ac6d<_0x3e84eb[_0x7597a4(0x2af)];_0x40ac6d++){const _0x2623fd=_0x3e84eb[_0x40ac6d],_0x1b98df=_0x1c4bfa['get'](_0x2623fd[_0x7597a4(0x25f)]),_0x44381f=_0x3e8491[_0x7597a4(0x249)](_0x1b98df['chatLogId']);await this[_0x7597a4(0x2a8)][_0x7597a4(0x2f8)](_0x44381f,{'id':_0x2623fd[_0x7597a4(0x238)]['id'],'state':_0x2623fd['data'][_0x7597a4(0x317)],'completed':_0x2623fd[_0x7597a4(0x238)][_0x7597a4(0x317)]===_0x7597a4(0x1be),'videoUrl':_0x2623fd[_0x7597a4(0x238)]['video']?.['url']});}}async[_0x48aa00(0x33f)](_0x58af15){const _0x126eec=_0x48aa00,{prompt:_0x5dc62c,userId:_0x313a69,abortController:_0x1088d1}=_0x58af15,_0x5ef982=await this[_0x126eec(0x26d)][_0x126eec(0x1b1)](model_constant_1[_0x126eec(0x2a0)][_0x126eec(0x2f9)]),_0x2e9089=_0x5ef982[_0x126eec(0x2a9)],_0x552bbc=_0x5ef982[_0x126eec(0x2a9)][_0x126eec(0x19b)];if(!_0x2e9089)throw new common_1[(_0x126eec(0x385))](_0x126eec(0x2b8),common_1[_0x126eec(0x398)][_0x126eec(0x350)]);const {id:_0x54793d}=_0x2e9089;let _0x30bc41=null,_0x3644c0=null;try{const _0x3a5697=await this[_0x126eec(0x2ba)]('','',_0x2e9089),_0x15b993=await this['configChatGptApi'](_0x2e9089,_0x3a5697);_0x30bc41=await _0x15b993[_0x126eec(0x313)](_0x5dc62c,{..._0x3a5697,'abortSignal':_0x1088d1['signal']});const _0x5c7c75=(0x0,helper_1[_0x126eec(0x1f4)])(_0x552bbc,_0x30bc41,_0x3644c0),{total_tokens:total_tokens=0x0}=_0x5c7c75[_0x126eec(0x2c5)];return await this[_0x126eec(0x26d)][_0x126eec(0x3aa)](_0x54793d,total_tokens),await this[_0x126eec(0x281)]['deductBalance4Chat'](_0x313a69,_0x2e9089,-0x1),_0x30bc41[_0x126eec(0x219)];}catch(_0x17b033){common_1[_0x126eec(0x2bf)][_0x126eec(0x269)](_0x17b033);const _0x5ca7db=_0x17b033[_0x126eec(0x2d8)];console[_0x126eec(0x269)](_0x5ca7db);if(_0x17b033[_0x126eec(0x25e)]&&_0x17b033[_0x126eec(0x25e)]===0x192)throw new common_1[(_0x126eec(0x385))](_0x17b033[_0x126eec(0x1a1)],common_1[_0x126eec(0x398)]['PAYMENT_REQUIRED']);if(!_0x5ca7db)throw new common_1['HttpException'](_0x17b033[_0x126eec(0x1a1)],common_1[_0x126eec(0x398)][_0x126eec(0x350)]);let _0x2f78d5=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x5ca7db]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x5ca7db]:_0x126eec(0x1c8);_0x17b033?.[_0x126eec(0x1a1)][_0x126eec(0x2c0)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&Number(_0x552bbc)===0x1&&(await this[_0x126eec(0x26d)][_0x126eec(0x29b)](_0x54793d,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x2f78d5=_0x126eec(0x199));_0x17b033?.['statusCode']===0x1ad&&_0x17b033['message'][_0x126eec(0x2c0)](_0x126eec(0x2db))&&Number(_0x552bbc)===0x1&&(await this[_0x126eec(0x26d)]['lockKey'](_0x54793d,_0x126eec(0x327),-0x3),_0x2f78d5=_0x126eec(0x1f5));_0x17b033?.[_0x126eec(0x2d8)]===0x191&&_0x17b033[_0x126eec(0x1a1)][_0x126eec(0x2c0)](_0x126eec(0x1d1))&&Number(_0x552bbc)===0x1&&(await this[_0x126eec(0x26d)]['lockKey'](_0x54793d,_0x126eec(0x37b),-0x2),_0x2f78d5=_0x126eec(0x268));_0x17b033?.[_0x126eec(0x2d8)]===0x191&&_0x17b033[_0x126eec(0x1a1)][_0x126eec(0x2c0)]('Unauthorized')&&Number(_0x552bbc)===0x1&&(await this[_0x126eec(0x26d)]['lockKey'](_0x54793d,_0x126eec(0x1f5),-0x2),_0x2f78d5=_0x126eec(0x1c3));_0x17b033?.[_0x126eec(0x2d8)]===0x194&&_0x17b033['message'][_0x126eec(0x2c0)]('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x552bbc)===0x1&&(await this['modelsService'][_0x126eec(0x29b)](_0x54793d,_0x126eec(0x296),-0x4),_0x2f78d5=_0x126eec(0x23a));_0x17b033?.['statusCode']===0x133&&_0x17b033[_0x126eec(0x1a1)][_0x126eec(0x2c0)](_0x126eec(0x241))&&Number(_0x552bbc)===0x1&&(_0x2f78d5='\x20！');_0x5ca7db===0x190&&console[_0x126eec(0x269)]('400\x20error',_0x17b033,_0x17b033[_0x126eec(0x1a1)]);const _0x39e9dc={'message':_0x2f78d5||_0x126eec(0x2f5),'code':_0x5ca7db===0x191?0x191:_0x5ca7db||0x1f4};throw new common_1[(_0x126eec(0x385))](_0x39e9dc[_0x126eec(0x1a1)],common_1[_0x126eec(0x398)]['BAD_REQUEST']);}}async['chatRealTime'](_0x5eaf4f,_0x1f2c92,_0xf2dfe7){const _0x1026e5=_0x48aa00;try{const {audio:_0x17bef8,voice:_0x144df0}=_0x5eaf4f,_0x487e7d=_0x1f2c92['abortController'],_0x15d0f0=await this[_0x1026e5(0x26d)]['getRandomAudioKey']();if(!_0x15d0f0)throw'未配置语音模型或语音模型key，请配置并启用语音功能！';const {key:_0x40818c,proxyUrl:_0x9dbc9c}=_0x15d0f0;await this[_0x1026e5(0x281)]['checkUserStatus'](_0x1f2c92[_0x1026e5(0x349)]),await this[_0x1026e5(0x281)][_0x1026e5(0x258)](_0x1f2c92[_0x1026e5(0x349)]['id'],_0x15d0f0),console[_0x1026e5(0x269)](_0x1026e5(0x218),_0x40818c,_0x9dbc9c),this[_0x1026e5(0x243)][_0x1026e5(0x3ab)]=_0x40818c,this[_0x1026e5(0x243)][_0x1026e5(0x33d)]=(_0x9dbc9c||this['defaultBaseUrl'])+_0x1026e5(0x2aa),this[_0x1026e5(0x243)]['timeout']=0x989680;const _0x22fac9=await this['openAi'][_0x1026e5(0x265)]['transcriptions'][_0x1026e5(0x1fd)]({'file':(0x0,fs_1[_0x1026e5(0x18b)])((0x0,path_1[_0x1026e5(0x336)])(_0x17bef8[_0x1026e5(0x280)])),'model':_0x1026e5(0x26a),'language':'zh','response_format':'json','temperature':0x0})[_0x1026e5(0x2fa)](_0x2cff13=>_0x2cff13[_0x1026e5(0x219)])[_0x1026e5(0x2ec)](_0x2ed0ea=>{common_1['Logger']['error'](_0x2ed0ea);});console[_0x1026e5(0x269)](_0x1026e5(0x2ea),_0x22fac9);if(!_0x22fac9){this['removeFile']((0x0,path_1['resolve'])(_0x17bef8[_0x1026e5(0x280)]));throw new common_1[(_0x1026e5(0x385))](_0x1026e5(0x192),common_1[_0x1026e5(0x398)][_0x1026e5(0x350)]);}await this[_0x1026e5(0x281)][_0x1026e5(0x1d4)](_0x1f2c92['user']['id'],_0x15d0f0,-0x1);const _0x18af2d=await this[_0x1026e5(0x33f)]({'userId':_0x1f2c92[_0x1026e5(0x349)]['id'],'prompt':_0x22fac9,'abortController':_0x487e7d});console[_0x1026e5(0x269)]('request\x20gpt\x20',_0x18af2d);if(!_0x18af2d){this[_0x1026e5(0x33e)]((0x0,path_1['resolve'])(_0x17bef8[_0x1026e5(0x280)]));throw new common_1[(_0x1026e5(0x385))](_0x1026e5(0x22f),common_1[_0x1026e5(0x398)]['BAD_REQUEST']);}console[_0x1026e5(0x269)]('response.length',_0x18af2d['length']);let _0x226b38=_0x18af2d[_0x1026e5(0x2af)]>0x1000?_0x18af2d['slice'](0x0,0xfff):_0x18af2d;const _0x4eaecd=await this[_0x1026e5(0x243)][_0x1026e5(0x265)]['speech'][_0x1026e5(0x1fd)]({'input':_0x226b38,'model':_0x1026e5(0x2d6),'response_format':_0x1026e5(0x325),'voice':_0x144df0,'speed':0x1})[_0x1026e5(0x2fa)](_0x1271df=>_0x1271df[_0x1026e5(0x2a2)]())[_0x1026e5(0x2ec)](_0x42cf4e=>{const _0x3d9a02=_0x1026e5;common_1['Logger'][_0x3d9a02(0x21d)](_0x42cf4e);});if(!_0x4eaecd){this[_0x1026e5(0x33e)]((0x0,path_1['resolve'])(_0x17bef8[_0x1026e5(0x280)]));throw new common_1[(_0x1026e5(0x385))](_0x1026e5(0x1c5),common_1[_0x1026e5(0x398)][_0x1026e5(0x350)]);}await this['userService'][_0x1026e5(0x1d4)](_0x1f2c92['user']['id'],_0x15d0f0,-0x1);const _0x48ab94=Buffer[_0x1026e5(0x1ca)](_0x4eaecd);return _0xf2dfe7[_0x1026e5(0x1ec)](_0x1026e5(0x1f8),_0x1026e5(0x240)),_0xf2dfe7[_0x1026e5(0x261)](_0x48ab94),_0xf2dfe7[_0x1026e5(0x3b6)](_0x48ab94),this[_0x1026e5(0x33e)]((0x0,path_1[_0x1026e5(0x336)])(_0x17bef8['path'])),_0x48ab94;}catch(_0x43fb46){if(_0x43fb46 instanceof common_1[_0x1026e5(0x385)])throw _0x43fb46;else throw new common_1[(_0x1026e5(0x385))](_0x43fb46[_0x1026e5(0x1a1)],common_1[_0x1026e5(0x398)][_0x1026e5(0x350)]);}}async[_0x48aa00(0x323)](_0x201080,_0x37688c){const _0x495044=_0x48aa00;common_1[_0x495044(0x2bf)][_0x495044(0x269)](_0x495044(0x3ac)+_0x201080[_0x495044(0x257)],'DrawService'),await this[_0x495044(0x259)][_0x495044(0x3a9)](_0x201080['prompt'],_0x37688c[_0x495044(0x349)]['id']),await this[_0x495044(0x281)][_0x495044(0x320)](_0x37688c['user']);let _0x40fc22=[];const _0xfb6be3=await this[_0x495044(0x26d)]['getRandomKey'](model_constant_1[_0x495044(0x2a0)][_0x495044(0x1de)]);await this[_0x495044(0x281)]['validateBalance4Chat'](_0x37688c['user']['id'],_0xfb6be3);const {key:_0x2db48c,model:_0x5a8614,proxyUrl:_0x2bfcab}=await this[_0x495044(0x2ab)](_0xfb6be3),_0x157df9=_0x2bfcab+_0x495044(0x28d);try{const _0x4849dc=await axios_1['default'][_0x495044(0x292)](_0x157df9,{..._0x201080,'model':_0x5a8614,'response_format':_0x495044(0x354)},{'headers':{'Authorization':_0x495044(0x2e2)+_0x2db48c}});_0x40fc22=_0x4849dc[_0x495044(0x238)][_0x495044(0x238)];}catch(_0x5f1108){console[_0x495044(0x269)]('openai-draw',_0x5f1108);const _0xb5a270=_0x5f1108?.['response']?.[_0x495044(0x25e)]||0x1f4,_0x3a6979=_0x5f1108?.['response']?.[_0x495044(0x238)]?.[_0x495044(0x21d)]?.['message'];if(_0xb5a270===0x1ad)throw new common_1[(_0x495044(0x385))](_0x495044(0x1cd),common_1[_0x495044(0x398)][_0x495044(0x350)]);if(_0xb5a270===0x190||_0x3a6979[_0x495044(0x2c0)](_0x495044(0x382)))throw new common_1[(_0x495044(0x385))](_0x495044(0x2f4),common_1[_0x495044(0x398)][_0x495044(0x350)]);if(_0xb5a270===0x1f4)throw new common_1[(_0x495044(0x385))](_0x495044(0x2ee),common_1[_0x495044(0x398)]['BAD_REQUEST']);if(_0xb5a270===0x191)throw new common_1[(_0x495044(0x385))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x495044(0x398)][_0x495044(0x350)]);throw new common_1[(_0x495044(0x385))](_0x495044(0x328),common_1[_0x495044(0x398)][_0x495044(0x350)]);}const _0x21bad0=[];for(const _0x8fee76 of _0x40fc22){const _0x4c4943=_0x8fee76[_0x495044(0x354)]['replace'](/^data:image\/\w+;base64,/,''),_0x3c509c=uuid['v4']()['slice'](0x0,0xa)+_0x495044(0x2b3),_0x50ebae=Buffer['from'](_0x4c4943,'base64');_0x21bad0['push'](this['fileService']['uploadFile']({'filename':_0x3c509c,'buffer':_0x50ebae}));}const _0x2c806b=(0x0,utils_1[_0x495044(0x252)])(_0x37688c),_0x5a1451=await Promise[_0x495044(0x305)](_0x21bad0),[_0x3e3bfc,_0x1ed028]=_0x201080['size'][_0x495044(0x355)]('x'),_0xbbbeff=_0x5a1451[_0x495044(0x26b)](_0x2078c7=>{const _0x779903=_0x495044;return this[_0x779903(0x2a8)][_0x779903(0x26c)]({'curIp':_0x2c806b,'logType':0x3,'answer':_0x2078c7,'totalTokens':0x0,'promptTokens':0x0,'model':'DALL-E2','userId':_0x37688c[_0x779903(0x349)]['id'],'prompt':_0x201080[_0x779903(0x257)],'completionTokens':0x0,'modelType':model_constant_1[_0x779903(0x2a0)][_0x779903(0x1de)],'type':balance_constant_1[_0x779903(0x1fa)][_0x779903(0x18d)],'fileInfo':JSON[_0x779903(0x27d)]({'width':_0x3e3bfc,'height':_0x1ed028,'cosUrl':_0x2078c7})});}),_0x1f42d2=await Promise[_0x495044(0x305)](_0xbbbeff);return await this[_0x495044(0x281)][_0x495044(0x1d4)](_0x37688c[_0x495044(0x349)]['id'],_0xfb6be3,_0x1f42d2[0x0]['id']),_0x5a1451;}async[_0x48aa00(0x2ab)](_0x112914){const _0x1c33f6=_0x48aa00,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x1c33f6(0x223)][_0x1c33f6(0x1b3)]([_0x1c33f6(0x363),_0x1c33f6(0x300),_0x1c33f6(0x343),'openaiModel3MaxTokens16kRes',_0x1c33f6(0x344),'openaiModel4MaxTokensRes','openaiModel4MaxTokens32k',_0x1c33f6(0x390),_0x1c33f6(0x20a)]);let _0x3dba32=null,_0xf19d1b=null,_0x58c03d=null;const {model:_0x4473ce,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x5c0baf,key:_0x5b12a3}=_0x112914;return _0x4473ce[_0x1c33f6(0x231)]()['includes'](_0x1c33f6(0x217))&&(_0x4473ce[_0x1c33f6(0x231)]()[_0x1c33f6(0x2c0)](_0x1c33f6(0x196))?(_0x3dba32=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0xf19d1b=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x3dba32=maxModelTokens||openaiModel4MaxTokens||0x2000,_0xf19d1b=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x4473ce[_0x1c33f6(0x231)]()['includes'](_0x1c33f6(0x276))&&(_0x4473ce[_0x1c33f6(0x231)]()[_0x1c33f6(0x2c0)](_0x1c33f6(0x39e))?(_0x3dba32=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0xf19d1b=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x3dba32=maxModelTokens||openaiModel3MaxTokens||0x1000,_0xf19d1b=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x58c03d=_0x5c0baf||openaiBaseUrl||_0x1c33f6(0x1ff),_0xf19d1b>=_0x3dba32&&(_0xf19d1b=Math[_0x1c33f6(0x232)](_0x3dba32/0x2),common_1['Logger'][_0x1c33f6(0x202)](_0x1c33f6(0x379)+_0x5b12a3+'\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20'+_0xf19d1b)),{'key':_0x5b12a3,'model':_0x4473ce,'maxToken':_0x3dba32,'maxTokenRes':_0xf19d1b,'proxyUrl':_0x58c03d};}async[_0x48aa00(0x18a)](_0x49e915){const _0xbbfbd4=_0x48aa00;try{const _0x415998=await this['pptService'][_0xbbfbd4(0x369)](_0x49e915),_0x543d5a=await this[_0xbbfbd4(0x208)][_0xbbfbd4(0x364)]({'where':{'yooTaskId':_0x49e915[_0xbbfbd4(0x33b)]['id']}});if(!_0x543d5a)throw new Error(_0xbbfbd4(0x372));_0x543d5a['status']=_0x415998[_0xbbfbd4(0x238)][_0xbbfbd4(0x25e)],_0x543d5a['stateDesc']=_0x415998[_0xbbfbd4(0x238)][_0xbbfbd4(0x22d)],_0x543d5a[_0xbbfbd4(0x299)]=_0x415998[_0xbbfbd4(0x238)]['progress'],_0x543d5a[_0xbbfbd4(0x1c6)]=_0x415998[_0xbbfbd4(0x238)][_0xbbfbd4(0x318)],_0x543d5a[_0xbbfbd4(0x207)]=_0x415998[_0xbbfbd4(0x238)]['page_count'],_0x543d5a[_0xbbfbd4(0x3b2)]=_0x415998[_0xbbfbd4(0x238)][_0xbbfbd4(0x2a6)],_0x543d5a[_0xbbfbd4(0x18c)]=_0x415998[_0xbbfbd4(0x238)]['images_url'],_0x543d5a[_0xbbfbd4(0x194)]=_0x415998[_0xbbfbd4(0x238)]['created_at'],_0x543d5a['endTime']=_0x415998[_0xbbfbd4(0x238)][_0xbbfbd4(0x2c2)],_0x543d5a[_0xbbfbd4(0x37d)]=_0x415998[_0xbbfbd4(0x238)]['preview_url'],await this[_0xbbfbd4(0x208)][_0xbbfbd4(0x32f)](_0x543d5a);}catch(_0x2e3ae0){common_1[_0xbbfbd4(0x2bf)]['error'](_0x2e3ae0[_0xbbfbd4(0x1a1)],_0xbbfbd4(0x2d7));}}async['pptStructure'](_0x54a7a8,_0x30bb82){const _0x284d0e=_0x48aa00;try{return this[_0x284d0e(0x2ae)][_0x284d0e(0x315)](async()=>{const _0x5b55f0=_0x284d0e,_0x4d991e=await this[_0x5b55f0(0x26d)]['getModelByType'](model_constant_1[_0x5b55f0(0x2a0)][_0x5b55f0(0x2d1)]);let _0x4c3eda={'userId':_0x54a7a8[_0x5b55f0(0x349)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x5b55f0(0x3a1)],'title':_0x30bb82[_0x5b55f0(0x222)],'text':_0x30bb82['text'],'theme':_0x30bb82[_0x5b55f0(0x28e)]};_0x4c3eda=await this['pptTaskEntity'][_0x5b55f0(0x32f)](_0x4c3eda),await this[_0x5b55f0(0x281)][_0x5b55f0(0x2b4)](_0x54a7a8[_0x5b55f0(0x349)]['id'],_0x4c3eda['id'],_0x4c3eda[_0x5b55f0(0x2d0)]);const _0x550014=await this[_0x5b55f0(0x203)][_0x5b55f0(0x30a)]({'data':_0x30bb82,'baseURL':_0x4d991e['modelInfo']['proxyUrl'],'headers':{'Authorization':_0x5b55f0(0x2e2)+_0x4d991e['modelInfo'][_0x5b55f0(0x189)]}});return _0x4c3eda[_0x5b55f0(0x222)]=_0x550014['data'][_0x5b55f0(0x222)],_0x4c3eda[_0x5b55f0(0x342)]=_0x550014[_0x5b55f0(0x238)][_0x5b55f0(0x342)],await this[_0x5b55f0(0x208)][_0x5b55f0(0x32f)](_0x4c3eda),_0x4c3eda;});}catch(_0x4e8500){throw new common_1[(_0x284d0e(0x385))](_0x4e8500[_0x284d0e(0x1a1)],common_1[_0x284d0e(0x398)]['BAD_REQUEST']);}}async[_0x48aa00(0x216)](_0x299db3,_0x841e32){const _0x48df37=_0x48aa00,_0x481a86=await this['pptTaskEntity'][_0x48df37(0x364)]({'where':{'id':_0x841e32}});if(!_0x481a86)throw new common_1['HttpException'](_0x48df37(0x311),common_1[_0x48df37(0x398)][_0x48df37(0x350)]);await this[_0x48df37(0x281)][_0x48df37(0x2b4)](_0x299db3[_0x48df37(0x349)]['id'],_0x481a86['id'],ppt_constant_1[_0x48df37(0x1a5)][_0x48df37(0x1e6)]);const _0x45c3b5=await this[_0x48df37(0x26d)][_0x48df37(0x1b1)](model_constant_1[_0x48df37(0x2a0)][_0x48df37(0x2d1)]),_0x2b04e3=await this[_0x48df37(0x203)][_0x48df37(0x1fe)]({'baseURL':_0x45c3b5[_0x48df37(0x2a9)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x45c3b5['modelInfo'][_0x48df37(0x189)]},'data':{'id':_0x481a86[_0x48df37(0x2f7)],'expire':0x83d600}});return _0x2b04e3['code']=='200'&&_0x2b04e3[_0x48df37(0x238)][_0x48df37(0x285)]&&(_0x481a86[_0x48df37(0x32e)]=_0x2b04e3[_0x48df37(0x238)][_0x48df37(0x285)],await this['pptTaskEntity'][_0x48df37(0x205)]({'id':_0x481a86['id']},{'editorUrl':_0x481a86[_0x48df37(0x32e)]})),_0x481a86;}async[_0x48aa00(0x297)](_0x4a7a65,_0x1a3f1e){const _0x1b0ed0=_0x48aa00,_0x5e65c6=await this[_0x1b0ed0(0x208)][_0x1b0ed0(0x364)]({'where':{'id':_0x1a3f1e}});if(!_0x5e65c6)throw new common_1[(_0x1b0ed0(0x385))](_0x1b0ed0(0x311),common_1[_0x1b0ed0(0x398)]['BAD_REQUEST']);await this[_0x1b0ed0(0x281)]['debuctBalance4PPT'](_0x4a7a65['user']['id'],_0x5e65c6['id'],ppt_constant_1['EPPTTaskType'][_0x1b0ed0(0x1af)]);const _0x413efd=await this[_0x1b0ed0(0x26d)][_0x1b0ed0(0x1b1)](model_constant_1[_0x1b0ed0(0x2a0)][_0x1b0ed0(0x2d1)]),_0x14b1b8=await this[_0x1b0ed0(0x203)]['pptDownload']({'baseURL':_0x413efd['modelInfo']['proxyUrl'],'headers':{'Authorization':_0x1b0ed0(0x278)+_0x413efd[_0x1b0ed0(0x2a9)][_0x1b0ed0(0x189)]},'params':{'id':_0x5e65c6['yooTaskId'],'type':'pptx'}});return _0x14b1b8[_0x1b0ed0(0x245)]==_0x1b0ed0(0x27a)&&_0x14b1b8['data']['download_url']&&(_0x5e65c6[_0x1b0ed0(0x3b2)]=_0x14b1b8[_0x1b0ed0(0x238)][_0x1b0ed0(0x1eb)],await this[_0x1b0ed0(0x208)]['update']({'id':_0x5e65c6['id']},{'downUrl':_0x5e65c6[_0x1b0ed0(0x3b2)]})),_0x5e65c6;}[_0x48aa00(0x308)](_0x4587d8,_0x49121b){const _0x523984=_0x48aa00;try{return this[_0x523984(0x2ae)][_0x523984(0x315)](async()=>{const _0x1b519a=_0x523984,_0x20b7e4=await this[_0x1b519a(0x26d)][_0x1b519a(0x1b1)](model_constant_1[_0x1b519a(0x2a0)][_0x1b519a(0x2d1)]);let _0x459290={'userId':_0x4587d8[_0x1b519a(0x349)]['id'],'type':ppt_constant_1[_0x1b519a(0x1a5)][_0x1b519a(0x33c)],'title':_0x49121b[_0x1b519a(0x222)],'text':_0x49121b[_0x1b519a(0x219)],'author':_0x49121b['author'],'color':_0x49121b[_0x1b519a(0x2bc)],'style':_0x49121b['style']};_0x459290=await this[_0x1b519a(0x208)][_0x1b519a(0x32f)](_0x459290),await this[_0x1b519a(0x281)][_0x1b519a(0x2b4)](_0x4587d8[_0x1b519a(0x349)]['id'],_0x459290['id'],_0x459290['type']);const _0x3639cb=await this[_0x1b519a(0x203)][_0x1b519a(0x308)]({'data':{'title':_0x49121b[_0x1b519a(0x222)],'count':_0x49121b['text'],'user_name':_0x49121b[_0x1b519a(0x370)],'color':_0x49121b[_0x1b519a(0x2bc)],'style':_0x49121b[_0x1b519a(0x191)]},'baseURL':_0x20b7e4['modelInfo'][_0x1b519a(0x331)],'headers':{'Authorization':_0x1b519a(0x278)+_0x20b7e4['modelInfo'][_0x1b519a(0x189)]}});return _0x459290[_0x1b519a(0x399)]=_0x3639cb[_0x1b519a(0x238)],await this['pptTaskEntity'][_0x1b519a(0x32f)](_0x459290),_0x459290;});}catch(_0xdf8853){throw new common_1[(_0x523984(0x385))](_0xdf8853[_0x523984(0x1a1)],common_1[_0x523984(0x398)][_0x523984(0x350)]);}}[_0x48aa00(0x335)](_0x1f611d,_0x1a36d9){const _0x26b0e8=_0x48aa00;try{return this[_0x26b0e8(0x2ae)][_0x26b0e8(0x315)](async()=>{const _0x15f478=_0x26b0e8,_0xd598d5=await this[_0x15f478(0x26d)][_0x15f478(0x1b1)](model_constant_1['EModelType']['PPT']);let _0x3a9f1f={'userId':_0x1f611d[_0x15f478(0x349)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x15f478(0x38f)],'title':_0x1a36d9[_0x15f478(0x222)],'text':_0x1a36d9[_0x15f478(0x219)],'author':_0x1a36d9['author'],'coverId':_0x1a36d9[_0x15f478(0x21f)]};_0x3a9f1f=await this[_0x15f478(0x208)][_0x15f478(0x32f)](_0x3a9f1f),await this[_0x15f478(0x281)]['debuctBalance4PPT'](_0x1f611d[_0x15f478(0x349)]['id'],_0x3a9f1f['id'],_0x3a9f1f[_0x15f478(0x2d0)]);const _0x5907f9=await this[_0x15f478(0x203)][_0x15f478(0x335)]({'data':{'title':_0x1a36d9[_0x15f478(0x222)],'count':_0x1a36d9['text'],'user_name':_0x1a36d9['author'],'cover_id':_0x1a36d9[_0x15f478(0x21f)]},'baseURL':_0xd598d5[_0x15f478(0x2a9)]['proxyUrl'],'headers':{'Authorization':_0x15f478(0x278)+_0xd598d5[_0x15f478(0x2a9)][_0x15f478(0x189)]}});return _0x3a9f1f[_0x15f478(0x399)]=_0x5907f9[_0x15f478(0x238)],await this[_0x15f478(0x208)][_0x15f478(0x32f)](_0x3a9f1f),_0x3a9f1f;});}catch(_0x36f82a){throw new common_1['HttpException'](_0x36f82a[_0x26b0e8(0x1a1)],common_1[_0x26b0e8(0x398)][_0x26b0e8(0x350)]);}}async[_0x48aa00(0x383)](_0x42cf52){const _0xffa6ef=_0x48aa00;try{const _0x34ba30=['pptOutlinePrice',_0xffa6ef(0x274),'pptCreatePrice',_0xffa6ef(0x38c),'pptEditorPrice',_0xffa6ef(0x36b)],_0x34cbcb=await this[_0xffa6ef(0x223)][_0xffa6ef(0x1b3)](_0x34ba30);if(!_0x42cf52[_0xffa6ef(0x349)]||!_0x42cf52[_0xffa6ef(0x349)]['id'])throw new Error('Invalid\x20user\x20information');const _0x1f66cd=['pptOutline',_0xffa6ef(0x1e7),_0xffa6ef(0x1fe)],_0x5c46d6=await Promise[_0xffa6ef(0x305)](_0x1f66cd[_0xffa6ef(0x26b)](async _0x364a9a=>{const _0x683f98=_0xffa6ef,_0x31dd9a=_0x34cbcb[_0x364a9a+'VipFree'],_0x1ad557=_0x34cbcb[_0x364a9a+_0x683f98(0x1d3)],_0x319c40=redisKey_constant_1['VIP_FREE']+'-'+_0x42cf52[_0x683f98(0x349)]['id']+'-'+(_0x364a9a+'VipFree'),_0x22e79e=await this[_0x683f98(0x281)][_0x683f98(0x32a)](_0x42cf52[_0x683f98(0x349)]['id'],_0x319c40,_0x31dd9a);return{'type':_0x364a9a,'remainCount':_0x22e79e,'freeCount':Number(_0x31dd9a),'useIntegrate':Number(_0x1ad557)};}));return _0x5c46d6;}catch(_0x373e08){console[_0xffa6ef(0x21d)](_0xffa6ef(0x1d5),_0x373e08);throw _0x373e08;}}['pptCreate'](_0x2874ad,_0x14aa44){const _0x1ccdc1=_0x48aa00;try{return this[_0x1ccdc1(0x2ae)][_0x1ccdc1(0x315)](async()=>{const _0x50083c=_0x1ccdc1;let _0x16737b;const _0x9510d6=await this[_0x50083c(0x26d)][_0x50083c(0x1b1)](model_constant_1[_0x50083c(0x2a0)][_0x50083c(0x2d1)]);if(_0x14aa44[_0x50083c(0x2c7)]){_0x16737b=await this[_0x50083c(0x208)][_0x50083c(0x364)]({'where':{'id':_0x14aa44[_0x50083c(0x2c7)]}});if(!_0x16737b)throw new Error(_0x50083c(0x341));}let _0x26d584={'userId':_0x2874ad[_0x50083c(0x349)]['id'],'type':ppt_constant_1[_0x50083c(0x1a5)]['CREATE'],'title':_0x14aa44[_0x50083c(0x222)],'subTitle':_0x14aa44[_0x50083c(0x188)],'text':_0x14aa44[_0x50083c(0x219)],'catalogs':_0x14aa44['catalogs'],'contents':_0x14aa44[_0x50083c(0x1c7)],'author':_0x14aa44['author'],'fontName':_0x14aa44[_0x50083c(0x1ad)],'transition':_0x14aa44[_0x50083c(0x272)],'complex':_0x14aa44[_0x50083c(0x2be)],'coverId':_0x14aa44[_0x50083c(0x21f)],'originId':_0x14aa44[_0x50083c(0x2c7)]};_0x26d584=await this[_0x50083c(0x208)][_0x50083c(0x32f)](_0x26d584),await this[_0x50083c(0x281)][_0x50083c(0x2b4)](_0x2874ad[_0x50083c(0x349)]['id'],_0x26d584['id'],_0x26d584['type']);try{const _0x4a8dee=await this[_0x50083c(0x203)][_0x50083c(0x1e7)]({'data':{'text':_0x14aa44[_0x50083c(0x219)],'custom_data':{'title':_0x14aa44['title'],'sub_title':_0x14aa44[_0x50083c(0x188)],'author':_0x14aa44['author'],'catalogs':_0x14aa44[_0x50083c(0x342)],'contents':_0x14aa44[_0x50083c(0x1c7)]},'cover_id':_0x14aa44[_0x50083c(0x21f)],'font_name':_0x14aa44[_0x50083c(0x1ad)],'transition':_0x14aa44[_0x50083c(0x272)],'complex':_0x14aa44[_0x50083c(0x2be)],'user_name':_0x14aa44['author'],'id':_0x16737b?.[_0x50083c(0x2f7)]},'baseURL':_0x9510d6[_0x50083c(0x2a9)]['proxyUrl'],'headers':{'Authorization':_0x50083c(0x278)+_0x9510d6[_0x50083c(0x2a9)]['accessToken']}});return _0x26d584[_0x50083c(0x2f7)]=_0x4a8dee[_0x50083c(0x238)]['id'],await this['pptTaskEntity'][_0x50083c(0x32f)](_0x26d584),_0x26d584;}catch(_0x553fd5){await this[_0x50083c(0x281)][_0x50083c(0x2b4)](_0x2874ad[_0x50083c(0x349)]['id'],_0x26d584['id'],_0x26d584[_0x50083c(0x2d0)],!![]);throw new common_1[(_0x50083c(0x385))](_0x553fd5['message'],common_1[_0x50083c(0x398)]['BAD_REQUEST']);}});}catch(_0x18bdf8){throw new common_1[(_0x1ccdc1(0x385))](_0x18bdf8[_0x1ccdc1(0x1a1)],common_1[_0x1ccdc1(0x398)][_0x1ccdc1(0x350)]);}}['pptCreateThesis'](_0xbd0b85,_0x2afd4b){const _0x1b7a2d=_0x48aa00;try{return this[_0x1b7a2d(0x2ae)][_0x1b7a2d(0x315)](async()=>{const _0x23580a=_0x1b7a2d,_0x5bb3f9=await this['modelsService'][_0x23580a(0x1b1)](model_constant_1[_0x23580a(0x2a0)]['PPT']);let _0x5d42cf={'userId':_0xbd0b85[_0x23580a(0x349)]['id'],'type':ppt_constant_1[_0x23580a(0x1a5)][_0x23580a(0x271)],'title':_0x2afd4b[_0x23580a(0x222)],'color':_0x2afd4b[_0x23580a(0x2bc)],'style':_0x2afd4b[_0x23580a(0x191)],'fileUrl':_0x2afd4b[_0x23580a(0x22b)],'pleader':_0x2afd4b['pleader'],'advisor':_0x2afd4b[_0x23580a(0x39f)],'school':_0x2afd4b['school'],'schoolLogo':_0x2afd4b['schoolLogo'],'schoolPicture':_0x2afd4b[_0x23580a(0x2d9)]};_0x5d42cf=await this['pptTaskEntity'][_0x23580a(0x32f)](_0x5d42cf),await this['userService'][_0x23580a(0x2b4)](_0xbd0b85[_0x23580a(0x349)]['id'],_0x5d42cf['id'],_0x5d42cf[_0x23580a(0x2d0)]);const _0x41dad0=await this[_0x23580a(0x203)]['pptCreateThesis']({'data':{'file_key':_0x2afd4b[_0x23580a(0x22b)],'title':_0x2afd4b[_0x23580a(0x222)],'color':_0x2afd4b[_0x23580a(0x2bc)],'style':_0x2afd4b['style'],'pleader':_0x2afd4b[_0x23580a(0x1b6)],'advisor':_0x2afd4b[_0x23580a(0x39f)],'school':_0x2afd4b['school'],'school_logo':_0x2afd4b[_0x23580a(0x262)],'school_picture':_0x2afd4b[_0x23580a(0x2d9)]},'baseURL':_0x5bb3f9['modelInfo'][_0x23580a(0x331)],'headers':{'Authorization':_0x23580a(0x278)+_0x5bb3f9[_0x23580a(0x2a9)][_0x23580a(0x189)]}});return _0x5d42cf['yooTaskId']=_0x41dad0[_0x23580a(0x238)]['id'],await this[_0x23580a(0x208)][_0x23580a(0x32f)](_0x5d42cf),setTimeout(()=>this[_0x23580a(0x18a)]({'baseURL':_0x5bb3f9[_0x23580a(0x2a9)][_0x23580a(0x331)],'headers':{'Authorization':_0x23580a(0x278)+_0x5bb3f9['modelInfo']['accessToken']},'params':{'id':_0x5d42cf[_0x23580a(0x2f7)]}}),0xbb8),_0x5d42cf;});}catch(_0x2756bd){throw new common_1['HttpException'](_0x2756bd[_0x1b7a2d(0x1a1)],common_1[_0x1b7a2d(0x398)][_0x1b7a2d(0x350)]);}}[_0x48aa00(0x255)](_0x5da52a,_0x14d41b){const _0x590e90=_0x48aa00;try{return this[_0x590e90(0x2ae)][_0x590e90(0x315)](async()=>{const _0x52075d=_0x590e90,_0x7ff1c1=await this[_0x52075d(0x26d)][_0x52075d(0x1b1)](model_constant_1[_0x52075d(0x2a0)][_0x52075d(0x2d1)]);let _0x270d0e={'userId':_0x5da52a[_0x52075d(0x349)]['id'],'type':ppt_constant_1[_0x52075d(0x1a5)][_0x52075d(0x198)],'fileUrl':_0x14d41b[_0x52075d(0x22b)],'coverId':_0x14d41b[_0x52075d(0x21f)],'author':_0x14d41b[_0x52075d(0x370)]};_0x270d0e=await this[_0x52075d(0x208)][_0x52075d(0x32f)](_0x270d0e),await this['userService'][_0x52075d(0x2b4)](_0x5da52a[_0x52075d(0x349)]['id'],_0x270d0e['id'],_0x270d0e[_0x52075d(0x2d0)]);const _0x4e2191=await this['pptService'][_0x52075d(0x255)]({'data':{'file_url':_0x14d41b[_0x52075d(0x22b)],'cover_id':_0x14d41b['coverId'],'user_name':_0x14d41b[_0x52075d(0x370)]},'baseURL':_0x7ff1c1[_0x52075d(0x2a9)][_0x52075d(0x331)],'headers':{'Authorization':'Beare\x20'+_0x7ff1c1[_0x52075d(0x2a9)]['accessToken']}});return _0x270d0e[_0x52075d(0x2f7)]=_0x4e2191[_0x52075d(0x238)]['id'],await this[_0x52075d(0x208)][_0x52075d(0x32f)](_0x270d0e),setTimeout(()=>this[_0x52075d(0x18a)]({'baseURL':_0x7ff1c1['modelInfo'][_0x52075d(0x331)],'headers':{'Authorization':'Beare\x20'+_0x7ff1c1[_0x52075d(0x2a9)][_0x52075d(0x189)]},'params':{'id':_0x270d0e[_0x52075d(0x2f7)]}}),0xbb8),_0x270d0e;});}catch(_0x3fded1){throw new common_1[(_0x590e90(0x385))](_0x3fded1[_0x590e90(0x1a1)],common_1[_0x590e90(0x398)][_0x590e90(0x350)]);}}[_0x48aa00(0x224)](_0x4a130c){const _0x29f0b0=_0x48aa00;return this[_0x29f0b0(0x208)]['findOne']({'where':{'id':_0x4a130c}});}['pptChangeTheme'](_0x3d8efd,_0x44aec3){const _0x14fd91=_0x48aa00;try{return this['connection'][_0x14fd91(0x315)](async()=>{const _0x38f4fa=_0x14fd91,_0x3228ac=await this[_0x38f4fa(0x208)][_0x38f4fa(0x364)]({'where':{'id':_0x44aec3['originTaskId']}});if(!_0x3228ac)throw new Error(_0x38f4fa(0x341));const _0x1ab3f2=await this['modelsService']['getModelByType'](model_constant_1[_0x38f4fa(0x2a0)][_0x38f4fa(0x2d1)]);let _0x2d22ba={'userId':_0x3d8efd[_0x38f4fa(0x349)]['id'],'type':ppt_constant_1[_0x38f4fa(0x1a5)][_0x38f4fa(0x1a2)],'originId':_0x44aec3[_0x38f4fa(0x2c7)],'coverId':_0x44aec3['coverId'],'fontName':_0x44aec3['fontName'],'transition':_0x44aec3[_0x38f4fa(0x272)]};_0x2d22ba=await this[_0x38f4fa(0x208)][_0x38f4fa(0x32f)](_0x2d22ba),await this[_0x38f4fa(0x281)]['debuctBalance4PPT'](_0x3d8efd['user']['id'],_0x2d22ba['id'],_0x2d22ba[_0x38f4fa(0x2d0)]);const _0x5c82e5=await this[_0x38f4fa(0x203)][_0x38f4fa(0x24b)]({'data':{'id':_0x3228ac[_0x38f4fa(0x2f7)],'cover_id':_0x44aec3[_0x38f4fa(0x21f)],'font_name':_0x44aec3[_0x38f4fa(0x1ad)],'transition':_0x44aec3[_0x38f4fa(0x272)]},'baseURL':_0x1ab3f2['modelInfo'][_0x38f4fa(0x331)],'headers':{'Authorization':'Beare\x20'+_0x1ab3f2[_0x38f4fa(0x2a9)][_0x38f4fa(0x189)]}});return _0x2d22ba[_0x38f4fa(0x2f7)]=_0x5c82e5['data']['id'],await this[_0x38f4fa(0x208)][_0x38f4fa(0x32f)](_0x2d22ba),setTimeout(()=>this[_0x38f4fa(0x18a)]({'baseURL':_0x1ab3f2[_0x38f4fa(0x2a9)][_0x38f4fa(0x331)],'headers':{'Authorization':_0x38f4fa(0x278)+_0x1ab3f2[_0x38f4fa(0x2a9)]['accessToken']},'params':{'id':_0x2d22ba[_0x38f4fa(0x2f7)]}}),0xbb8),_0x2d22ba;});}catch(_0x209719){throw new common_1[(_0x14fd91(0x385))](_0x209719[_0x14fd91(0x1a1)],common_1[_0x14fd91(0x398)]['BAD_REQUEST']);}}['pptAddPage'](_0x20f2f5,_0xa5d091){const _0x39429f=_0x48aa00;try{return this[_0x39429f(0x2ae)][_0x39429f(0x315)](async()=>{const _0x51a363=_0x39429f,_0x5d6c36=await this['pptTaskEntity'][_0x51a363(0x364)]({'where':{'id':_0xa5d091[_0x51a363(0x2c7)]}});if(!_0x5d6c36)throw new Error(_0x51a363(0x341));const _0x41d9ec=await this[_0x51a363(0x26d)]['getModelByType'](model_constant_1['EModelType'][_0x51a363(0x2d1)]);let _0x40f5bf={'userId':_0x20f2f5[_0x51a363(0x349)]['id'],'type':ppt_constant_1[_0x51a363(0x1a5)][_0x51a363(0x210)],'originId':_0xa5d091[_0x51a363(0x2c7)],'theme':_0xa5d091[_0x51a363(0x28e)],'text':_0xa5d091[_0x51a363(0x219)],'complex':_0xa5d091['complex']?String(_0xa5d091[_0x51a363(0x2be)]):'1','author':_0xa5d091[_0x51a363(0x370)],'fontName':_0xa5d091['fontName'],'transition':_0xa5d091['transition'],'slideNumber':_0xa5d091[_0x51a363(0x2b1)],'slideType':_0xa5d091[_0x51a363(0x34d)]};_0x40f5bf=await this[_0x51a363(0x208)][_0x51a363(0x32f)](_0x40f5bf),await this['userService']['debuctBalance4PPT'](_0x20f2f5[_0x51a363(0x349)]['id'],_0x40f5bf['id'],_0x40f5bf[_0x51a363(0x2d0)]);const _0x48a5fb=await this['pptService']['pptAddPage']({'data':{'id':_0x5d6c36['yooTaskId'],'text':_0xa5d091[_0x51a363(0x219)],'complex':_0xa5d091[_0x51a363(0x2be)],'user_name':_0xa5d091[_0x51a363(0x370)],'font_name':_0xa5d091['fontName'],'transition':_0xa5d091[_0x51a363(0x272)],'slide_number':_0xa5d091[_0x51a363(0x2b1)],'slide_type':_0xa5d091[_0x51a363(0x34d)],'theme':_0xa5d091[_0x51a363(0x28e)]},'baseURL':_0x41d9ec[_0x51a363(0x2a9)][_0x51a363(0x331)],'headers':{'Authorization':_0x51a363(0x278)+_0x41d9ec[_0x51a363(0x2a9)]['accessToken']}});return _0x40f5bf[_0x51a363(0x2f7)]=_0x48a5fb[_0x51a363(0x238)]['id'],await this[_0x51a363(0x208)]['save'](_0x40f5bf),setTimeout(()=>this[_0x51a363(0x18a)]({'baseURL':_0x41d9ec[_0x51a363(0x2a9)]['proxyUrl'],'headers':{'Authorization':_0x51a363(0x278)+_0x41d9ec[_0x51a363(0x2a9)][_0x51a363(0x189)]},'params':{'id':_0x40f5bf['yooTaskId']}}),0xbb8),_0x40f5bf;});}catch(_0x173fff){throw new common_1['HttpException'](_0x173fff[_0x39429f(0x1a1)],common_1[_0x39429f(0x398)]['BAD_REQUEST']);}}[_0x48aa00(0x270)](_0x13cb74,_0x495bb0){const _0x39d6f4=_0x48aa00;try{return this[_0x39d6f4(0x2ae)][_0x39d6f4(0x315)](async()=>{const _0x53cf5e=_0x39d6f4,_0x5bcb11=await this[_0x53cf5e(0x208)][_0x53cf5e(0x364)]({'where':{'id':_0x495bb0['originTaskId']}});if(!_0x5bcb11)throw new Error(_0x53cf5e(0x341));const _0x54aca5=await this['modelsService']['getModelByType'](model_constant_1['EModelType'][_0x53cf5e(0x2d1)]);let _0x1e5678={'userId':_0x13cb74[_0x53cf5e(0x349)]['id'],'type':ppt_constant_1[_0x53cf5e(0x1a5)][_0x53cf5e(0x1ab)],'originId':_0x495bb0[_0x53cf5e(0x2c7)],'notes':_0x495bb0};_0x1e5678=await this[_0x53cf5e(0x208)][_0x53cf5e(0x32f)](_0x1e5678),await this[_0x53cf5e(0x281)][_0x53cf5e(0x2b4)](_0x13cb74['user']['id'],_0x1e5678['id'],_0x1e5678[_0x53cf5e(0x2d0)]);const _0x10ac25=await this[_0x53cf5e(0x203)]['pptNote']({'data':{..._0x495bb0,'id':_0x5bcb11[_0x53cf5e(0x2f7)]},'baseURL':_0x54aca5[_0x53cf5e(0x2a9)]['proxyUrl'],'headers':{'Authorization':'Beare\x20'+_0x54aca5['modelInfo'][_0x53cf5e(0x189)]}});return _0x1e5678[_0x53cf5e(0x2f7)]=_0x10ac25['data']['id'],await this['pptTaskEntity'][_0x53cf5e(0x32f)](_0x1e5678),setTimeout(()=>this['asyncPPTProgress']({'baseURL':_0x54aca5['modelInfo'][_0x53cf5e(0x331)],'headers':{'Authorization':_0x53cf5e(0x278)+_0x54aca5['modelInfo']['accessToken']},'params':{'id':_0x1e5678['yooTaskId']}}),0xbb8),_0x1e5678;});}catch(_0x4ebc38){throw new common_1['HttpException'](_0x4ebc38[_0x39d6f4(0x1a1)],common_1['HttpStatus'][_0x39d6f4(0x350)]);}}async[_0x48aa00(0x310)](_0xc3c60f,_0x5eca9a){const _0x4eeb7c=_0x48aa00,{page:page=0x1,size:size=0x14,keyword:_0x44cbbc}=_0xc3c60f,_0xb0042e=[{'delFlag':0x0,'publishFlag':0x1,'type':(0x0,typeorm_1['In'])([ppt_constant_1[_0x4eeb7c(0x1a5)]['CREATE'],ppt_constant_1[_0x4eeb7c(0x1a5)][_0x4eeb7c(0x198)]])}];_0x44cbbc&&_0xb0042e['push']({'title':(0x0,typeorm_1['Like'])('%'+_0x44cbbc+'%'),'delFlag':0x0},{'subTitle':(0x0,typeorm_1[_0x4eeb7c(0x375)])('%'+_0x44cbbc+'%'),'delFlag':0x0});const [_0x57c78d,_0x2742a6]=await this[_0x4eeb7c(0x208)][_0x4eeb7c(0x2c3)]({'where':_0xb0042e,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':'DESC'}}),_0x27601f=await this[_0x4eeb7c(0x281)][_0x4eeb7c(0x37e)](_0x57c78d,_0x5eca9a);return{'rows':_0x27601f,'count':_0x2742a6};}async[_0x48aa00(0x362)](_0x53a4e5,_0x397c65){const _0x35bd47=_0x48aa00,_0x5000c4=_0x397c65[_0x35bd47(0x349)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x3f4af2}=_0x53a4e5,_0x479634=_0x35bd47(0x36a)+(_0x3f4af2?_0x35bd47(0x2a4)+_0x3f4af2+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%'+_0x3f4af2+'%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20':'')+'\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x5000c4?_0x35bd47(0x2de)+_0x5000c4:'')+'\x0a\x20\x20\x20\x20\x20\x20',_0x1e8291=await this['connection'][_0x35bd47(0x1aa)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x479634+_0x35bd47(0x1d8)),_0x1d024e=await this[_0x35bd47(0x2ae)]['query'](_0x35bd47(0x2f0)+_0x479634+_0x35bd47(0x206)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x35bd47(0x1d8));!(0x0,utils_1[_0x35bd47(0x1d0)])(this[_0x35bd47(0x190)])&&_0x1d024e[_0x35bd47(0x215)](_0x26ce29=>{const _0x16fb64=_0x35bd47;_0x26ce29['email']=(0x0,utils_1['maskEmail'])(_0x26ce29[_0x16fb64(0x200)]),_0x26ce29[_0x16fb64(0x282)]=(0x0,utils_1['maskEmail'])(_0x26ce29['phone']);});const _0x39aab1=await this[_0x35bd47(0x281)]['mergeCollectData'](_0x1d024e,_0x397c65);return{'rows':_0x39aab1,'count':Number(_0x1e8291[0x0]?.[_0x35bd47(0x1a3)]||0x0)};}async[_0x48aa00(0x20c)](_0x567fa4,_0x543fe1=0x1,_0x2a994d=0xa){const _0x405f8d=_0x48aa00,{rows:_0x30cc79,count:_0xabdc54}=await this[_0x405f8d(0x281)][_0x405f8d(0x1a0)](_0x543fe1,_0x2a994d,_0x567fa4[_0x405f8d(0x349)]['id'],collectType_constant_1[_0x405f8d(0x21e)][_0x405f8d(0x2d1)]),_0x183c77=await this['pptTaskEntity'][_0x405f8d(0x1e4)]({'where':{'id':(0x0,typeorm_1['In'])(_0x30cc79['map'](_0x4390ee=>_0x4390ee['relId']))}});return{'rows':_0x183c77,'count':_0xabdc54};}async[_0x48aa00(0x2ca)](_0x2f054e,_0x5c5743){const _0x1335c1=_0x48aa00;if(!_0x2f054e[_0x1335c1(0x1a4)]||!_0x2f054e[_0x1335c1(0x1a4)][_0x1335c1(0x2af)])return!![];const _0x249a10={'id':(0x0,typeorm_1['In'])(_0x2f054e[_0x1335c1(0x1a4)])};return _0x5c5743&&(_0x249a10['userId']=_0x5c5743),await this['pptTaskEntity'][_0x1335c1(0x205)](_0x249a10,{'delFlag':0x1}),await this[_0x1335c1(0x281)][_0x1335c1(0x29e)](_0x2f054e['ids'],collectType_constant_1[_0x1335c1(0x21e)][_0x1335c1(0x2d1)]),!![];}async[_0x48aa00(0x2e9)](_0x3986af,_0xebd606){const _0x546b2c=_0x48aa00;try{let _0x2cff2d='';return await this[_0x546b2c(0x2ae)][_0x546b2c(0x315)](async()=>{const _0xa3df09=_0x546b2c,_0x168962=(0x0,utils_1[_0xa3df09(0x2a5)])(this[_0xa3df09(0x190)]),{modelInfo:_0x55c0e7}=await this[_0xa3df09(0x26d)][_0xa3df09(0x1b1)](model_constant_1[_0xa3df09(0x2a0)]['TTS'],_0xa3df09(0x2c8));await this[_0xa3df09(0x21b)]({'prompt':_0xebd606['request'][_0xa3df09(0x219)],'user':_0x3986af['user'],'currentRequestModel':_0x55c0e7});const _0x181cb8={'curIp':(0x0,utils_1[_0xa3df09(0x252)])(_0x3986af),'prompt':_0xebd606[_0xa3df09(0x251)]['text'],'modelId':_0x55c0e7['id'],'modelType':_0x55c0e7[_0xa3df09(0x3a6)],'answer':'','model':_0x55c0e7[_0xa3df09(0x301)],'role':_0xa3df09(0x349),'userId':_0x3986af['user']['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0xa3df09(0x1fa)][_0xa3df09(0x20e)],'logType':0x1,'requestOptions':JSON[_0xa3df09(0x27d)](_0xebd606),'saasId':_0x168962},_0x3737fa={..._0x181cb8,'role':_0xa3df09(0x326),'requestOptions':JSON[_0xa3df09(0x27d)]({'prompt':_0xebd606[_0xa3df09(0x251)][_0xa3df09(0x219)],'options':{'model':_0x55c0e7[_0xa3df09(0x301)]}})};await this[_0xa3df09(0x2a8)][_0xa3df09(0x26c)](_0x181cb8),await this[_0xa3df09(0x2a8)][_0xa3df09(0x26c)](_0x3737fa),await this[_0xa3df09(0x281)][_0xa3df09(0x1d4)](_0x3986af[_0xa3df09(0x349)]['id'],_0x55c0e7,_0x3737fa['id']);const _0x46262b={'app':{'appid':_0x55c0e7[_0xa3df09(0x3b5)],'token':_0x55c0e7[_0xa3df09(0x3b5)],'cluster':_0xa3df09(0x358)},'user':{'uid':String(_0x3986af['user']['id'])},'audio':{'voice_type':_0xa3df09(0x384),'encoding':_0xa3df09(0x27c)},'request':{'reqid':(0x0,crypto_1['randomUUID'])(),'text':_0xebd606[_0xa3df09(0x251)][_0xa3df09(0x219)],'operation':_0xa3df09(0x1aa)}},_0x45b19d=await this[_0xa3df09(0x225)][_0xa3df09(0x2e9)]({'data':_0x46262b,'headers':{'Authorization':_0xa3df09(0x260)+_0x55c0e7[_0xa3df09(0x189)]}}),_0x10a1d4=chat_constant_1[_0xa3df09(0x28a)][_0xa3df09(0x185)]+'-'+_0x168962+'-'+_0x3986af['user']['id']+'-'+new Date()[_0xa3df09(0x2cc)]()+_0xa3df09(0x1d2);let _0x4fdbc2=(0x0,path_1[_0xa3df09(0x37a)])(process['cwd'](),'webroot',_0xa3df09(0x394)),_0x1ada19=_0xa3df09(0x264);_0x1ada19=_0x1ada19+'/'+_0x10a1d4;!(0x0,fs_1[_0xa3df09(0x1b4)])(_0x4fdbc2)&&(0x0,fs_1[_0xa3df09(0x233)])(_0x4fdbc2,{'recursive':!![]});_0x4fdbc2=(0x0,path_1[_0xa3df09(0x37a)])(_0x4fdbc2,_0x10a1d4),(0x0,fs_1[_0xa3df09(0x309)])(_0x4fdbc2,_0x45b19d[_0xa3df09(0x238)],_0xa3df09(0x35f));let _0x23bee0=process[_0xa3df09(0x307)]['GOMAXAI_HOST'];_0x23bee0[_0xa3df09(0x2ce)]('http')?_0x2cff2d=_0x23bee0+_0x1ada19:_0x2cff2d=_0xa3df09(0x2df)+_0x23bee0+_0x1ada19,_0x3737fa[_0xa3df09(0x353)]=_0x2cff2d,await this[_0xa3df09(0x2a8)][_0xa3df09(0x26c)](_0x3737fa);}),_0x2cff2d;}catch(_0x5ecbcf){throw new common_1['HttpException'](_0x5ecbcf['message'],common_1['HttpStatus'][_0x546b2c(0x350)]);}}async[_0x48aa00(0x294)](_0x42cffb,_0x2451db,_0x5400be){const _0x10fe84=_0x48aa00;try{let _0x24df0a,_0x307349;return await this[_0x10fe84(0x2ae)][_0x10fe84(0x315)](async()=>{const _0x183cbd=_0x10fe84,_0x34b965=(0x0,utils_1[_0x183cbd(0x2a5)])(this['clsService']),{modelInfo:_0x429765}=await this[_0x183cbd(0x26d)]['getModelByType'](model_constant_1[_0x183cbd(0x2a0)]['ASR'],'AUC7419233800922468658');await this[_0x183cbd(0x281)][_0x183cbd(0x258)](_0x42cffb['user']['id'],_0x429765);const _0x24c68a={'groupId':_0x5400be,'curIp':(0x0,utils_1['getClientIp'])(_0x42cffb),'prompt':_0x2451db,'modelId':_0x429765['id'],'modelType':_0x429765[_0x183cbd(0x3a6)],'answer':'','model':_0x429765[_0x183cbd(0x301)],'role':'user','userId':_0x42cffb[_0x183cbd(0x349)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x183cbd(0x1fa)][_0x183cbd(0x20e)],'logType':0x1,'requestOptions':JSON[_0x183cbd(0x27d)]({'url':_0x2451db}),'saasId':_0x34b965},_0x25a3d9={..._0x24c68a,'role':_0x183cbd(0x326),'requestOptions':JSON['stringify']({'prompt':_0x2451db,'options':{'model':_0x429765[_0x183cbd(0x301)]}})};await this[_0x183cbd(0x2a8)][_0x183cbd(0x26c)](_0x24c68a),await this[_0x183cbd(0x2a8)][_0x183cbd(0x26c)](_0x25a3d9),await this['userService']['deductBalance4Chat'](_0x42cffb[_0x183cbd(0x349)]['id'],_0x429765,_0x25a3d9['id']);let _0x292310=process['env'][_0x183cbd(0x1ba)];!/^http/[_0x183cbd(0x346)](_0x292310)&&(_0x292310=_0x183cbd(0x2df)+_0x292310);const _0x36f967={'app':{'appid':_0x429765['appid'],'token':_0x429765['appid'],'cluster':_0x183cbd(0x1f0)},'user':{'uid':String(_0x42cffb[_0x183cbd(0x349)]['id'])},'audio':{'url':_0x2451db,'format':_0x2451db['split']('.')[_0x183cbd(0x324)]()},'request':{'callback':_0x292310+_0x183cbd(0x1fc)}},_0x15085e=await this[_0x183cbd(0x225)][_0x183cbd(0x294)]({'data':_0x36f967,'headers':{'Authorization':_0x183cbd(0x260)+_0x429765['accessToken']}});_0x24df0a=_0x15085e['id'],_0x307349=await this[_0x183cbd(0x2a8)][_0x183cbd(0x26c)](_0x25a3d9);}),new Promise(_0xd3625a=>{const _0x133240=_0x10fe84;utils_1['EE'][_0x133240(0x295)](chat_constant_1[_0x133240(0x28a)][_0x133240(0x29f)]+'-'+_0x24df0a,async _0x1ef225=>{const _0x4687d5=_0x133240;_0x307349['answer']=_0x1ef225[_0x4687d5(0x219)],_0x307349=await this[_0x4687d5(0x2a8)][_0x4687d5(0x26c)](_0x307349),_0xd3625a(_0x307349);});});}catch(_0x2e807d){throw new common_1[(_0x10fe84(0x385))](_0x2e807d[_0x10fe84(0x1a1)],common_1[_0x10fe84(0x398)][_0x10fe84(0x350)]);}}[_0x48aa00(0x306)](_0x3b07d8){const _0x229484=_0x48aa00;_0x3b07d8[_0x229484(0x245)]===0x3e8&&utils_1['EE'][_0x229484(0x333)](chat_constant_1[_0x229484(0x28a)][_0x229484(0x29f)]+'-'+_0x3b07d8['id'],_0x3b07d8);}async[_0x48aa00(0x214)](_0xa09140,_0x136d87,_0x3d97df,_0xb02e40){const _0x5d537c=_0x48aa00;try{let _0x13e5d3=await this[_0x5d537c(0x2ae)][_0x5d537c(0x315)](async()=>{const _0x5a86ef=_0x5d537c;let _0x3a302d=new Date()[_0x5a86ef(0x2cc)](),_0x29d014=new Date()[_0x5a86ef(0x2cc)]();const _0x18d16a=_0xa09140[_0x5a86ef(0x349)]['id'],_0x4eeaef=(0x0,utils_1[_0x5a86ef(0x2a5)])(this[_0x5a86ef(0x190)]),_0x10e6f0=chat_constant_1['EChatType'][_0x5a86ef(0x29f)]+'-'+_0x4eeaef+'-'+_0x18d16a+'-'+new Date()[_0x5a86ef(0x2cc)]()+_0x5a86ef(0x1d2),_0x59089c=await this[_0x5a86ef(0x244)][_0x5a86ef(0x2fd)]({'filename':_0x10e6f0,'buffer':_0xb02e40[_0x5a86ef(0x37f)]});_0x29d014=new Date()[_0x5a86ef(0x2cc)](),console[_0x5a86ef(0x269)](_0x5a86ef(0x376),_0x29d014-_0x3a302d);const _0x2b8237=await this[_0x5a86ef(0x294)](_0xa09140,_0x59089c,_0x3d97df?.[_0x5a86ef(0x303)]?.[_0x5a86ef(0x32d)]);_0x3a302d=new Date()[_0x5a86ef(0x2cc)](),console[_0x5a86ef(0x269)]('[耗时打印]语音转文字耗时：',_0x3a302d-_0x29d014),_0x3d97df[_0x5a86ef(0x257)]=_0x2b8237[_0x5a86ef(0x353)];typeof _0x3d97df['options']===_0x5a86ef(0x184)&&(_0x3d97df[_0x5a86ef(0x303)]=JSON['parse'](_0x3d97df[_0x5a86ef(0x303)]));const _0x16b1f0=await this[_0x5a86ef(0x1b2)](_0x3d97df,_0xa09140,_0x136d87,![]);_0x29d014=new Date()[_0x5a86ef(0x2cc)](),console[_0x5a86ef(0x269)]('[耗时打印]文字对话耗时：',_0x29d014-_0x3a302d);const _0x31161d=await this['tts'](_0xa09140,{'request':{'text':_0x16b1f0[_0x5a86ef(0x353)]}});_0x16b1f0[_0x5a86ef(0x1e1)]=_0x31161d,this[_0x5a86ef(0x2a8)][_0x5a86ef(0x26c)](_0x16b1f0),_0x3a302d=new Date()[_0x5a86ef(0x2cc)](),console[_0x5a86ef(0x269)]('[耗时打印]文字转语音耗时：',_0x3a302d-_0x29d014);const {prompt:_0x4aceb2,role:_0x43fb51,answer:_0x4630d5,createdAt:_0x24e1fe,conversationOptions:_0x826cdf,requestOptions:_0x32d21d,id:_0x18f8bf,answerMp3:_0x3ca189}=_0x16b1f0;return{'chatId':_0x18f8bf,'dateTime':(0x0,utils_1['formatDate'])(_0x24e1fe),'text':_0x43fb51==='user'?_0x4aceb2:_0x4630d5,'textMp3':_0x3ca189,'inversion':_0x43fb51===_0x5a86ef(0x349),'error':![],'conversationOptions':_0x826cdf?JSON[_0x5a86ef(0x2ed)](_0x826cdf):null,'requestOptions':_0x32d21d?JSON[_0x5a86ef(0x2ed)](_0x32d21d):null};});_0x136d87[_0x5d537c(0x25e)](0xc8)[_0x5d537c(0x36d)](result_1[_0x5d537c(0x19d)][_0x5d537c(0x1bb)](_0x13e5d3));}catch(_0xc3ceb4){throw new common_1[(_0x5d537c(0x385))](_0xc3ceb4[_0x5d537c(0x1a1)],common_1[_0x5d537c(0x398)]['BAD_REQUEST']);}}async['getUserModelFree'](_0x2c5055,_0x3f121d){const _0x2742af=_0x48aa00,_0x4f484a=_0x3f121d[_0x2742af(0x349)]['id'],_0x540d6a=await this['modelsService']['getModelById'](_0x2c5055);return{'remainCount':await this[_0x2742af(0x281)]['getModelVipFree'](_0x4f484a,_0x540d6a),'freeCount':_0x540d6a[_0x2742af(0x1c4)],'isVipFree':_0x540d6a[_0x2742af(0x1c4)]==-0x1,'useIntegrate':_0x540d6a[_0x2742af(0x360)]};}async[_0x48aa00(0x279)](_0x457c92){const _0x3d0067=_0x48aa00,_0x3cdfe0=_0x457c92[_0x3d0067(0x349)]?.['id'],_0x534d58=await this[_0x3d0067(0x26d)][_0x3d0067(0x1ac)](model_constant_1['EModelType'][_0x3d0067(0x31c)]),_0x2e1d8c=[];if(_0x3cdfe0)for(const _0x36815d of _0x534d58){_0x2e1d8c[_0x3d0067(0x2f2)]({'id':_0x36815d['id'],'keyType':_0x36815d[_0x3d0067(0x19b)],'model':_0x36815d[_0x3d0067(0x301)],'name':_0x36815d[_0x3d0067(0x2b2)],'modelType':_0x36815d[_0x3d0067(0x3a6)],'remainCount':await this[_0x3d0067(0x281)][_0x3d0067(0x332)](_0x3cdfe0,_0x36815d),'freeCount':_0x36815d[_0x3d0067(0x1c4)],'isVipFree':_0x36815d['vipFreeNum']==-0x1,'useIntegrate':_0x36815d[_0x3d0067(0x360)]});}else _0x534d58[_0x3d0067(0x215)](_0x38a7a1=>{const _0x17fbfc=_0x3d0067;_0x2e1d8c[_0x17fbfc(0x2f2)]({'id':_0x38a7a1['id'],'keyType':_0x38a7a1['keyType'],'model':_0x38a7a1[_0x17fbfc(0x301)],'name':_0x38a7a1[_0x17fbfc(0x2b2)],'modelType':_0x38a7a1['modelType'],'remainCount':0x0,'freeCount':_0x38a7a1[_0x17fbfc(0x1c4)],'isVipFree':_0x38a7a1[_0x17fbfc(0x1c4)]==-0x1,'useIntegrate':_0x38a7a1[_0x17fbfc(0x360)]});});return _0x2e1d8c;}async[_0x48aa00(0x246)](_0x2fc443,_0x369787){const _0x4c51e3=_0x48aa00,_0x247b21=_0x2fc443['user']?.['id'];let _0x5e3eb2=_0x369787[_0x4c51e3(0x301)];const _0x308bd5=await this[_0x4c51e3(0x26d)][_0x4c51e3(0x2a3)](_0x5e3eb2);if(!_0x308bd5)throw new common_1[(_0x4c51e3(0x385))](_0x4c51e3(0x38a),common_1[_0x4c51e3(0x398)][_0x4c51e3(0x350)]);const _0x339bcd=await this[_0x4c51e3(0x281)][_0x4c51e3(0x2cf)](_0x308bd5,_0x369787);if(!_0x247b21)return{'remainCount':0x0,'freeCount':_0x308bd5[_0x4c51e3(0x1c4)]>0x0?_0x308bd5[_0x4c51e3(0x1c4)]:_0x339bcd?.[_0x4c51e3(0x1c4)]||0x0,'isVipFree':_0x308bd5['vipFreeNum']==-0x1||_0x339bcd?.[_0x4c51e3(0x1c4)]==-0x1,'useIntegrate':_0x308bd5['deduct']>0x0?_0x308bd5[_0x4c51e3(0x360)]:_0x339bcd?.[_0x4c51e3(0x374)]||0x0};return{'remainCount':await this[_0x4c51e3(0x281)][_0x4c51e3(0x1e9)](_0x247b21,_0x308bd5,_0x369787),'freeCount':_0x308bd5[_0x4c51e3(0x1c4)]>0x0?_0x308bd5['vipFreeNum']:_0x339bcd?.['vipFreeNum']||0x0,'isVipFree':_0x308bd5[_0x4c51e3(0x1c4)]==-0x1||_0x339bcd?.[_0x4c51e3(0x1c4)]==-0x1,'useIntegrate':_0x308bd5[_0x4c51e3(0x360)]>0x0?_0x308bd5[_0x4c51e3(0x360)]:_0x339bcd?.['price']||0x0};}async[_0x48aa00(0x3a0)](){const _0x158518=_0x48aa00,_0x14d08d=await this[_0x158518(0x26d)]['getModelByType'](model_constant_1[_0x158518(0x2a0)][_0x158518(0x2d1)]),_0x466d7f=await this[_0x158518(0x208)][_0x158518(0x1aa)]('select\x20*\x20from\x20ppt_task\x20where\x20\x20(status<>2\x20or\x20status\x20is\x20null\x20)and\x20yoo_task_id\x20is\x20not\x20null');_0x466d7f[_0x158518(0x2af)]&&_0x466d7f['forEach'](async _0x1b08a4=>{const _0x48197b=_0x158518;this[_0x48197b(0x18a)]({'baseURL':_0x14d08d[_0x48197b(0x2a9)][_0x48197b(0x331)],'headers':{'Authorization':_0x48197b(0x278)+_0x14d08d[_0x48197b(0x2a9)][_0x48197b(0x189)]},'params':{'id':_0x1b08a4[_0x48197b(0x2e7)]}});});const _0x5257cd=await this['pptTaskEntity'][_0x158518(0x1aa)](_0x158518(0x319));_0x5257cd['length']&&_0x5257cd['forEach'](async _0x241598=>{const _0x31f616=_0x158518,_0x1fc8cf=await this[_0x31f616(0x203)][_0x31f616(0x297)]({'baseURL':_0x14d08d[_0x31f616(0x2a9)]['proxyUrl'],'headers':{'Authorization':_0x31f616(0x278)+_0x14d08d['modelInfo']['accessToken']},'params':{'id':_0x241598[_0x31f616(0x2e7)],'type':'pdf'}});_0x1fc8cf['code']==_0x31f616(0x27a)&&_0x1fc8cf[_0x31f616(0x238)][_0x31f616(0x1eb)]&&(_0x241598[_0x31f616(0x20b)]=_0x1fc8cf[_0x31f616(0x238)][_0x31f616(0x1eb)],await this['pptTaskEntity']['update']({'id':_0x241598['id']},{'pdfDownUrl':_0x241598['pdf_down_url']}));});const _0xffcaa3=await this[_0x158518(0x208)][_0x158518(0x1aa)](_0x158518(0x3b0));_0xffcaa3[_0x158518(0x2af)]&&_0xffcaa3[_0x158518(0x215)](async _0x12906e=>{const _0x44a66=_0x158518,_0x375393=await this[_0x44a66(0x203)][_0x44a66(0x297)]({'baseURL':_0x14d08d[_0x44a66(0x2a9)][_0x44a66(0x331)],'headers':{'Authorization':_0x44a66(0x278)+_0x14d08d[_0x44a66(0x2a9)][_0x44a66(0x189)]},'params':{'id':_0x12906e[_0x44a66(0x2e7)],'type':_0x44a66(0x30c)}});_0x375393[_0x44a66(0x245)]==_0x44a66(0x27a)&&_0x375393[_0x44a66(0x238)][_0x44a66(0x1eb)]&&(_0x12906e[_0x44a66(0x34c)]=_0x375393[_0x44a66(0x238)][_0x44a66(0x1eb)],await this[_0x44a66(0x208)][_0x44a66(0x205)]({'id':_0x12906e['id']},{'pngDownUrl':_0x12906e[_0x44a66(0x34c)]}));});try{const _0x1a78c4=store_2[_0x158518(0x23d)]['pptTimeoutMs']||0x5,_0x272d26=[{'status':0x1,'type':ppt_constant_1[_0x158518(0x1a5)][_0x158518(0x253)],'updatedAt':(0x0,typeorm_1[_0x158518(0x20d)])(new Date(Date[_0x158518(0x2c1)]()-_0x1a78c4*0x3c*0x3e8))}],_0x11854f=await this['pptTaskEntity'][_0x158518(0x1e4)]({'where':_0x272d26});_0x11854f['forEach'](async _0x559570=>{const _0x57b4d6=_0x158518;_0x559570['stateDesc']='timeout',_0x559570['status']=0x3,this['pptTaskEntity'][_0x57b4d6(0x32f)](_0x559570),this[_0x57b4d6(0x281)]['debuctBalance4PPT'](_0x559570[_0x57b4d6(0x359)],_0x559570['id'],_0x559570[_0x57b4d6(0x2d0)],!![]);});}catch(_0x1a5b1f){common_1[_0x158518(0x2bf)][_0x158518(0x21d)](_0x1a5b1f);}}};ChatgptService=__decorate([(0x0,common_1[_0x48aa00(0x23c)])(),__param(0x0,(0x0,typeorm_2[_0x48aa00(0x34f)])(pptTask_entity_1[_0x48aa00(0x30e)])),__metadata(_0x48aa00(0x221),[typeorm_1[_0x48aa00(0x38b)],nestjs_cls_1[_0x48aa00(0x2d5)],user_service_1['UserService'],file_service_1[_0x48aa00(0x24f)],gpts_service_1['GptsService'],yooPPT_service_1[_0x48aa00(0x3a8)],doubao_service_1[_0x48aa00(0x19e)],models_service_1[_0x48aa00(0x228)],chatLog_service_1[_0x48aa00(0x1b0)],lumaTask_service_1['LumaTaskService'],runwayTask_service_1[_0x48aa00(0x1f9)],klingTask_service_1['KLingTaskService'],sunoTask_service_1['SunoTaskService'],badwords_service_1[_0x48aa00(0x38d)],autoreply_service_1[_0x48aa00(0x267)],chatGroup_service_1['ChatGroupService'],globalConfig_service_1['GlobalConfigService'],typeorm_1['Connection'],mindTask_service_1[_0x48aa00(0x2ff)]])],ChatgptService),exports['ChatgptService']=ChatgptService;