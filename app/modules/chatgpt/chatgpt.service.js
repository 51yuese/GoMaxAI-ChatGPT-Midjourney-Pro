'use strict';const _0x25df75=_0x1f8d;function _0x1f8d(_0x25ffaa,_0x5e6e1e){const _0x191fb5=_0x191f();return _0x1f8d=function(_0x1f8d21,_0x614900){_0x1f8d21=_0x1f8d21-0x12a;let _0x132dbf=_0x191fb5[_0x1f8d21];return _0x132dbf;},_0x1f8d(_0x25ffaa,_0x5e6e1e);}(function(_0x449800,_0x56a2c8){const _0x5e2e0f=_0x1f8d,_0xbd413f=_0x449800();while(!![]){try{const _0x3de522=-parseInt(_0x5e2e0f(0x260))/0x1+parseInt(_0x5e2e0f(0x2c1))/0x2+parseInt(_0x5e2e0f(0x1bf))/0x3+-parseInt(_0x5e2e0f(0x146))/0x4+-parseInt(_0x5e2e0f(0x198))/0x5*(-parseInt(_0x5e2e0f(0x1f1))/0x6)+-parseInt(_0x5e2e0f(0x1de))/0x7+-parseInt(_0x5e2e0f(0x2be))/0x8*(-parseInt(_0x5e2e0f(0x2cd))/0x9);if(_0x3de522===_0x56a2c8)break;else _0xbd413f['push'](_0xbd413f['shift']());}catch(_0x5ee800){_0xbd413f['push'](_0xbd413f['shift']());}}}(_0x191f,0xcefe2));function _0x191f(){const _0x71fc80=['existsSync','isSuper','subTitle','getModelByType','DALL-E2','EChatType','connection','catalogs','findOne','ChatgptService','email','chatTask','answer','29255PIEPtP','request','application/octet-stream;\x20charset=utf-8','listAssetsBychatLogIds','PAYMENT_REQUIRED','speech','Please\x20check\x20the\x20back-end\x20console','setData','__metadata','messageStore','trim','webroot','sendMessageFromBaidu','ADDPAGE','mp3','resolve','gptsService','saveChatLog','\x20OFFSET\x20','music-task',',\x20make_instrumental\x20',',\x20tags\x20','视频生成失败，没有响应','未配置语音模型或语音模型key，请配置并启用语音功能！','pptAddPage','\x0a\x20\x20\x20\x20\x20\x20','decorate','sendMessage','key','THEME','forEach','可翻译成其他语言。','当前模型key余额已耗尽','chat-error','conversationId','chatgpt','chatDraw','upload','refundBalance4Chat','4462215ZQDzDJ','../globalConfig/globalConfig.service','model','deductBalance4Chat','conversationOptions','createReadStream','音乐生成失败，没有响应','role','debug','totalTokens','promptTokens','ASR','sendMessageFromXunFei','apiKey','Speech_Synthesis7418877984234656063','parseAndSaveMusic','completionParams','../chatGroup/chatGroup.service','userId','openai-draw','then','redis://','Unauthorized','finish_reason','status','./baidu','https://','pptReCover','system','语音转换失败','__decorate','4776674KZQten','prompt\x20','MUSIC','getClientIp','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','fileService','EModelType','内容提取失败','once','模型秘钥错误或模型余额不足','Bearer;','audio','DoubaoService','videoTask','schoolLogo','defineProperty','title','chatLogId','writeFileSync','72SzwJJB','服务异常、请重新试试吧！！！','detail','Logger','signal','RECOVER','downUrl','mergedOptions','DrawService','tts','https://ark.cn-beijing.volces.com','openaiBaseUrl','绘制图片失败，此次绘画被拒绝了！','modelType','complex','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','end','YooPPTService','getConfigByKeys','FILE','PPT','getTime','ADDNOTES','chatGroupService','user_prompt','process_url','length','/upload','fanyi\x20mj-associate','test','keyType','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%','arrayBuffer','typeorm','baseURL',',\x20title\x20','tts-1','transition','modelInfo','api','pptCreateFile','nestjs-cls','set','modelsService','base64','uploadFile','volcano_tts','ids','parseAndSaveVideo','getCurrentModelByChatGroupId','messages','/v1','configKimiApi','systemPreMessage','chatRealTime','pptAddNote','preset','Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system','is_end','https://api.openai.com','audio2text\x20','upload2Local','400\x20error','PPT\x20任务不存在！','/api/v3','chat','pptCreateThesis','BadwordsService','pptDel','configChatGptApi','extend','compileNetwork','CHAT_TYPE','message','all','getModelConfig','params','size','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.nickname\x20LIKE\x20(\x27%','errMsg','removeSpecialCharacters','openaiModel3MaxTokens16k','./store','options','Repository','Catch\x20Error\x20','gpt-3','GptsService','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','checkUserStatus','REDIS_PORT','原始任务不存在！','secret','FileService','slideNumber','push','default','../autoreply/autoreply.service','log','updated_at','pleader','appid','setHeader','get','userService','getOwnPropertyDescriptor','Incorrect\x20API\x20key\x20provided','getUuid','resCover','style','330528icFTYm','toISOString','systemMessage','images','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','content','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','usage','../../common/constants/errorMessage.constant','本次调用:\x20','floor','key\x20%s,\x20proxy\x20%s','query','abort','openaiModel3MaxTokens','function','images_url','contents','abortController','buildSystemMessage','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','startsWith','ModelsService','chatLogService','ClsService','progressUrl','pptNote','delta','UserService','error','16k','unifiedFormattingResponse','created_at','save','asyncPPTProgress','aac','page_count','333333333333333','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','当前模型key已被封禁','path','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','\x20--expand_prompt\x20','emit','./../user/user.service','\x20key\x20->\x20',',\x20continue_clip_id\x20',',\x20模型名称:\x20','VIDEO','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','openaiTimeoutMs','REDIS_HOST','axios','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','AUC7419233800922468658','Injectable','BAD_REQUEST','string','keyv','当前请求已过载、请稍等会儿再试试吧！','pptPage','gpts','/api/chatgpt/notify-asr','text','COVER','parse','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','b64_json','chatVideo','stringify','key:\x20','badwordsService','listUndoneVideo','DRAW','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','includes','statusCode','schoolPicture','uuid','video-task','../api/lumaTask.service','join','whisper-1','../models/models.service','gomaxAiStore','user','getAppById','completionTokens','HttpStatus','code',',\x20mv\x20','prompt','metadata','color','72232hhcHwi','config','replace','1020196TXTZYd','\x20AND\x20p.user_id\x20=\x20','语音转文本失败','当前模型不是聊天模型','asr','stateDesc','thirdId','startTime','map','validateBalance4Chat','abs','globalConfigService','819hJwJju','sunoMusicId','write','PAINT_TYPE','maskEmail','doubaoService','InjectRepository','TTS','debuctBalance4PPT','author','getReqSaasId','\x20model:\x20','../../common/constants/balance.constant','../file/file.service','同步PPT生成任务进度失败！','getRandomKey','OpenAiErrorCodeMessage','accessToken','getRandomAudioKey','ChatGroupService','lumaTaskService','creat','data','ChatGPTAPI','yooTaskId','HttpException','close','state_description','school','slideType','GOMAXAI_HOST','defaultBaseUrl','slice','toLowerCase','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','OTHER','groupId','../badwords/badwords.service','bad\x20response\x20status\x20code\x20307','notifyAsr','draw\x20paompt\x20info\x20<======*******======>\x20','pptTaskEntity','buildOptions','lockKey','luma-video','buildMessageFromParentMessageId','Connection','object','fontName','originTaskId','phone','Bearer\x20','getCurrentModel','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','create','result','chatProcess','assistant','.mp3','request\x20gpt\x20','\x20image_end_url\x20','openaiModel4MaxTokens','choices','openaiModel3MaxTokensRes','temperature','[耗时打印]文字转语音耗时：','4114408bSRtXU','pptCover','../../common/constants/ppt.constant','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','voiceChat','../api/doubao.service','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','removeFile','validateBeforeChat','openAi','fileUrl','openai','onModuleInit','randomUUID','split','saveUseLog','../../common/utils','cwd','update','response','pptService','32k','sendMessageFromZhipu','suno-v3','STRUCTURE','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username\x20LIKE\x20(\x27%','importDynamic','env','transaction','gomaxai-chatlog','addOneIfOdd','Content-type','parentMessageId','configDoubaoApi','DeductionKey','coverId','apiBaseUrl','/v1/images/generations','proxyUrl','chatMusic','REDIS_PASSWORD','modelName','./spark','EPPTTaskType','checkBadWords','pptStructure','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.email\x20LIKE\x20(\x27%','catch','\x20--aspect_ratio\x20','initOpenAi','listTaskByIds','未获取到模型基础配置，请前往后台配置并启用','\x20image_url\x20','post','response.length','type',',\x20continue_at\x20','saveGptsUseLog','theme','timeout','./helper','openaiModel4MaxTokensRes','getGroupInfoFromId','../gpts/gpts.service','openAiErrHandler','clsService','formatModelToken','pptChangeTheme','kimiUpload'];_0x191f=function(){return _0x71fc80;};return _0x191f();}var __decorate=this&&this[_0x25df75(0x1dd)]||function(_0x1d048e,_0x351a67,_0x5d3a02,_0x52b76e){const _0x274f68=_0x25df75;var _0x5c278a=arguments[_0x274f68(0x20b)],_0x20c2fe=_0x5c278a<0x3?_0x351a67:_0x52b76e===null?_0x52b76e=Object[_0x274f68(0x25b)](_0x351a67,_0x5d3a02):_0x52b76e,_0x43b2f4;if(typeof Reflect===_0x274f68(0x133)&&typeof Reflect[_0x274f68(0x1b2)]===_0x274f68(0x26f))_0x20c2fe=Reflect[_0x274f68(0x1b2)](_0x1d048e,_0x351a67,_0x5d3a02,_0x52b76e);else{for(var _0x4396f2=_0x1d048e[_0x274f68(0x20b)]-0x1;_0x4396f2>=0x0;_0x4396f2--)if(_0x43b2f4=_0x1d048e[_0x4396f2])_0x20c2fe=(_0x5c278a<0x3?_0x43b2f4(_0x20c2fe):_0x5c278a>0x3?_0x43b2f4(_0x351a67,_0x5d3a02,_0x20c2fe):_0x43b2f4(_0x351a67,_0x5d3a02))||_0x20c2fe;}return _0x5c278a>0x3&&_0x20c2fe&&Object[_0x274f68(0x1ed)](_0x351a67,_0x5d3a02,_0x20c2fe),_0x20c2fe;},__metadata=this&&this[_0x25df75(0x1a0)]||function(_0x15c31d,_0x29b90f){const _0x3b053f=_0x25df75;if(typeof Reflect===_0x3b053f(0x133)&&typeof Reflect[_0x3b053f(0x2bc)]===_0x3b053f(0x26f))return Reflect['metadata'](_0x15c31d,_0x29b90f);},__param=this&&this['__param']||function(_0x28ab17,_0x9ec6a6){return function(_0x5e4edc,_0x173cff){_0x9ec6a6(_0x5e4edc,_0x173cff,_0x28ab17);};};Object[_0x25df75(0x1ed)](exports,'__esModule',{'value':!![]}),exports[_0x25df75(0x194)]=void 0x0;const file_service_1=require(_0x25df75(0x2da)),user_service_1=require(_0x25df75(0x28c)),openai_1=require(_0x25df75(0x151)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x25df75(0x268)),utils_1=require(_0x25df75(0x156)),axios_1=require(_0x25df75(0x294)),balance_constant_1=require(_0x25df75(0x2d9)),chatLog_service_1=require('../chatLog/chatLog.service'),uuid=require(_0x25df75(0x2ae)),fs=require('fs'),typeorm_1=require(_0x25df75(0x212)),typeorm_2=require('@nestjs/typeorm'),badwords_service_1=require(_0x25df75(0x2f2)),autoreply_service_1=require(_0x25df75(0x253)),globalConfig_service_1=require(_0x25df75(0x1c0)),chatGroup_service_1=require(_0x25df75(0x1d0)),models_service_1=require(_0x25df75(0x2b3)),baidu_1=require(_0x25df75(0x1d8)),helper_1=require(_0x25df75(0x182)),store_1=require(_0x25df75(0x244)),zhipu_1=require('./zhipu'),spark_1=require(_0x25df75(0x170)),model_constant_1=require('../../common/constants/model.constant'),fs_1=require('fs'),path_1=require('path'),gpts_service_1=require(_0x25df75(0x185)),yooPPT_service_1=require('../api/yooPPT.service'),pptTask_entity_1=require('./pptTask.entity'),ppt_constant_1=require(_0x25df75(0x148)),lumaTask_service_1=require(_0x25df75(0x2b0)),nestjs_cls_1=require(_0x25df75(0x21a)),doubao_service_1=require(_0x25df75(0x14b)),crypto_1=require('crypto'),chat_constant_1=require('../../common/constants/chat.constant');let ChatgptService=class ChatgptService{constructor(_0x26ceb8,_0x20f531,_0x1d81f5,_0xa04ee4,_0x3c2184,_0x373a1f,_0x5a6357,_0x5e6fcb,_0x40c730,_0x7c0547,_0x433437,_0x442d0a,_0x52bf82,_0x477c69,_0x59dff8){const _0x307bbe=_0x25df75;this[_0x307bbe(0x12d)]=_0x26ceb8,this['clsService']=_0x20f531,this[_0x307bbe(0x25a)]=_0x1d81f5,this[_0x307bbe(0x1e3)]=_0xa04ee4,this['gptsService']=_0x3c2184,this[_0x307bbe(0x15a)]=_0x373a1f,this['doubaoService']=_0x5a6357,this['modelsService']=_0x5e6fcb,this['chatLogService']=_0x40c730,this[_0x307bbe(0x2e1)]=_0x7c0547,this['badwordsService']=_0x433437,this['autoreplyService']=_0x442d0a,this[_0x307bbe(0x208)]=_0x52bf82,this[_0x307bbe(0x2cc)]=_0x477c69,this[_0x307bbe(0x191)]=_0x59dff8,this[_0x307bbe(0x2ec)]='https://api.openai.com',this['messageStore']=null,this[_0x307bbe(0x2b4)]=null,this[_0x307bbe(0x14d)]=_0x508e1b=>{return fs['unlink'](_0x508e1b,_0x1259ab=>{const _0x1fcb87=_0x1f8d;_0x1259ab?console[_0x1fcb87(0x254)]('remove\x20file\x20',_0x1259ab):console['log']('remove\x20file\x20%s\x20success',_0x508e1b);});};}async[_0x25df75(0x152)](){const _0xc324a2=_0x25df75;let _0x2b380a=await(0x0,utils_1[_0xc324a2(0x160)])(_0xc324a2(0x1bb));_0x2b380a=_0x2b380a?.[_0xc324a2(0x252)]?_0x2b380a[_0xc324a2(0x252)]:_0x2b380a,this[_0xc324a2(0x218)]=_0x2b380a[_0xc324a2(0x2e4)];let _0x31cb9a=await(0x0,utils_1[_0xc324a2(0x160)])(_0xc324a2(0x29a));_0x31cb9a=_0x31cb9a?.['default']?_0x31cb9a[_0xc324a2(0x252)]:_0x31cb9a;let _0x3435b2=await(0x0,utils_1[_0xc324a2(0x160)])('@keyv/redis');_0x3435b2=_0x3435b2?.[_0xc324a2(0x252)]?_0x3435b2[_0xc324a2(0x252)]:_0x3435b2;const _0x4774ac=+process[_0xc324a2(0x161)][_0xc324a2(0x24c)],_0x1701dd=process[_0xc324a2(0x161)][_0xc324a2(0x293)],_0x28dd6b=process[_0xc324a2(0x161)][_0xc324a2(0x16e)],_0x2398a9=process[_0xc324a2(0x161)]['REDIS_USER'],_0x3c9ffc=_0xc324a2(0x1d4)+(_0x2398a9||'')+':'+(_0x28dd6b||'')+'@'+_0x1701dd+':'+_0x4774ac,_0x2d0365=new _0x3435b2(_0x3c9ffc);this['messageStore']=new _0x31cb9a({'store':_0x2d0365,'namespace':_0xc324a2(0x163)}),this['gomaxAiStore']=new store_1['NineStore']({'store':this['messageStore'],'namespace':_0xc324a2(0x232)}),!this['openAi']&&this[_0xc324a2(0x177)]();}['initOpenAi'](){const _0x88157c=_0x25df75;this[_0x88157c(0x14f)]=new openai_1[(_0x88157c(0x252))]({'apiKey':'gomaxai-default-key','baseURL':this[_0x88157c(0x2ec)]+'/v1'});}async['getModelConfig'](_0x276ac5){const _0x178b71=_0x25df75,{type:_0x37f1cf,groupId:_0x1b2751,modelType:_0x1701de}=_0x276ac5;let _0x4239af,_0x41f012;_0x37f1cf&&_0x37f1cf===_0x178b71(0x29d)?(_0x41f012=await this[_0x178b71(0x1a8)][_0x178b71(0x184)](_0x1b2751),_0x4239af=_0x41f012['modelId']):_0x41f012=await this[_0x178b71(0x208)][_0x178b71(0x184)](_0x1b2751);let _0x4fc2c4;if(_0x41f012)_0x4fc2c4=JSON['parse'](_0x41f012[_0x178b71(0x2bf)]);else _0x1701de?_0x4fc2c4=await this[_0x178b71(0x21c)][_0x178b71(0x18e)](_0x1701de):_0x4fc2c4=await this[_0x178b71(0x21c)][_0x178b71(0x18e)](model_constant_1['EModelType'][_0x178b71(0x2f0)]);if(!_0x4fc2c4)throw new common_1[(_0x178b71(0x2e6))](_0x178b71(0x179),common_1[_0x178b71(0x2b8)][_0x178b71(0x298)]);return{'appId':_0x4239af,'modelConfig':_0x4fc2c4};}async[_0x25df75(0x273)](_0x10e975){const _0x2c735a=_0x25df75,_0x3ae0cf=this;let _0x14cc44='',_0xf802e3='',{type:_0x369bac,appId:_0x35016d,prompt:_0x2fd901,custom:_0x44676e,usingNetwork:_0x133b6e,systemMessage:_0x1d3bd3,customSystemMessage:_0x17e3ab}=_0x10e975;const _0x5490b0=async function(){const _0x4d1c09=_0x1f8d,_0x17903b=new Date()[_0x4d1c09(0x261)]()[_0x4d1c09(0x154)]('T')[0x0];return _0xf802e3=await _0x3ae0cf[_0x4d1c09(0x2cc)][_0x4d1c09(0x203)]([_0x4d1c09(0x226)]),_0xf802e3+(_0x4d1c09(0x289)+_0x17903b);};if(_0x35016d){const _0x2c3a17=await this[_0x2c735a(0x1a8)][_0x2c735a(0x2b6)](_0x35016d,0x1);if(!_0x2c3a17)throw new common_1['HttpException']('你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',common_1[_0x2c735a(0x2b8)]['BAD_REQUEST']);_0x2c3a17['preset']&&(_0x1d3bd3=_0x2c3a17[_0x2c735a(0x229)]);}else{if(_0x44676e)_0x1d3bd3=_0x1d3bd3;else _0x17e3ab?_0x1d3bd3=_0x17e3ab:_0x369bac!==_0x2c735a(0x29d)&&(_0x1d3bd3=await _0x5490b0());}return _0x133b6e&&(_0x14cc44=await(0x0,utils_1[_0x2c735a(0x238)])(_0x2fd901),!_0xf802e3&&(_0x1d3bd3=await _0x5490b0())),{'systemMessage':_0x1d3bd3,'netWorkPrompt':_0x14cc44};}async[_0x25df75(0x138)](_0x1d95ca){const _0x4ac20b=_0x25df75,{type:_0x58790d,custom:_0x5e39bb,groupId:_0x29fb4c,modelConfig:_0x457d99}=_0x1d95ca;let _0x17f86f=null;if(!_0x5e39bb&&!_0x58790d){const _0x11a686=await this[_0x4ac20b(0x21c)][_0x4ac20b(0x18e)](model_constant_1[_0x4ac20b(0x1e4)]['CHAT'],_0x457d99[_0x4ac20b(0x217)]['model']);_0x17f86f=_0x11a686[_0x4ac20b(0x217)];}else{if(_0x58790d==='gpts')_0x17f86f=await this[_0x4ac20b(0x1a8)][_0x4ac20b(0x222)](_0x29fb4c);else{if(_0x58790d==='file'){const _0x2cb2d9=await this['modelsService'][_0x4ac20b(0x18e)](model_constant_1[_0x4ac20b(0x1e4)][_0x4ac20b(0x204)],_0x457d99[_0x4ac20b(0x217)]['model']);_0x17f86f=_0x2cb2d9['modelInfo'];}else _0x5e39bb?_0x17f86f=await this[_0x4ac20b(0x21c)][_0x4ac20b(0x2dc)](model_constant_1[_0x4ac20b(0x1e4)][_0x4ac20b(0x2f0)]):_0x17f86f=await this[_0x4ac20b(0x21c)][_0x4ac20b(0x2dc)](model_constant_1['EModelType']['CHAT']);}}if(!_0x17f86f)throw new common_1['HttpException']('当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！',common_1[_0x4ac20b(0x2b8)]['BAD_REQUEST']);return _0x58790d===_0x4ac20b(0x29d)?_0x457d99[_0x4ac20b(0x217)][_0x4ac20b(0x1c1)]=_0x17f86f[_0x4ac20b(0x1c1)]:_0x17f86f['model']=_0x457d99[_0x4ac20b(0x217)]['model'],_0x17f86f;}async['validateBeforeChat'](_0x2ce966){const _0x385875=_0x25df75,{user:_0x15a79e,prompt:_0x1f9259,currentRequestModel:_0x7d18bc}=_0x2ce966;await this['userService'][_0x385875(0x24b)](_0x15a79e),await this[_0x385875(0x2a7)][_0x385875(0x172)](_0x1f9259,_0x15a79e['id']),await this[_0x385875(0x25a)][_0x385875(0x2ca)](_0x15a79e['id'],_0x7d18bc);}async[_0x25df75(0x12e)](_0xbe54e0,_0xfafd5a,_0x55f82b){const _0x1bd7ec=_0x25df75,_0x13f81f=await this[_0x1bd7ec(0x2cc)]['getConfigByKeys']([_0x1bd7ec(0x292)]),_0x542b8e=Number(_0x13f81f)||0x493e0,_0x811ff9={'timeoutMs':+_0x542b8e,'systemMessage':_0xfafd5a||'','parentMessageId':_0xbe54e0||'','completionParams':{'temperature':0.8,'model':_0x55f82b[_0x1bd7ec(0x1c1)]}};return _0x811ff9;}async[_0x25df75(0x236)](_0x490d14,_0xa831f9){const _0x2823ba=_0x25df75;let _0x399f8c=_0x490d14['proxyUrl'];if(!_0x399f8c){const _0x336a59=await this[_0x2823ba(0x2cc)][_0x2823ba(0x203)]([_0x2823ba(0x1fc)]);_0x336a59?_0x399f8c=_0x336a59:_0x399f8c=_0x2823ba(0x22c);}const _0x2914b3=0x1f40,_0x47e5da=0x1000,_0x179c8e=new this[(_0x2823ba(0x218))]({'maxModelTokens':_0x2914b3,'apiBaseUrl':_0x399f8c+_0x2823ba(0x224),'messageStore':this[_0x2823ba(0x1a1)],'apiKey':(0x0,utils_1[_0x2823ba(0x242)])(_0x490d14[_0x2823ba(0x1b4)]),'maxResponseTokens':_0x47e5da>=_0x2914b3?Math[_0x2823ba(0x2cb)](Math[_0x2823ba(0x26a)](_0x2914b3/0x2)):_0x47e5da});return console[_0x2823ba(0x254)](_0x2823ba(0x1cc),_0x179c8e['apiKey']),console[_0x2823ba(0x254)]('mergedOptions',_0xa831f9),console[_0x2823ba(0x254)](_0x2823ba(0x16a),_0x399f8c+_0x2823ba(0x224)),_0x179c8e;}async[_0x25df75(0x225)](_0x1327af){const _0x334ede=_0x25df75,_0xe90a0=new openai_1['default']({'baseURL':_0x1327af[_0x334ede(0x16c)]+'/v1'||'https://api.moonshot.cn/v1','apiKey':_0x1327af[_0x334ede(0x1b4)]});return _0xe90a0;}async[_0x25df75(0x167)](_0x222a6b,_0x2f74a4){const _0x3c5181=_0x25df75;let _0x42947b=_0x222a6b['proxyUrl']||_0x3c5181(0x1fb);const _0x1be874=0x1f40,_0x509f29=0x1000,_0x9b82d4=new this['api']({'maxModelTokens':_0x1be874,'apiBaseUrl':_0x42947b+_0x3c5181(0x231),'messageStore':this[_0x3c5181(0x1a1)],'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x222a6b[_0x3c5181(0x1b4)]),'maxResponseTokens':_0x509f29>=_0x1be874?Math[_0x3c5181(0x2cb)](Math['floor'](_0x1be874/0x2)):_0x509f29});return console['log'](_0x3c5181(0x1cc),_0x9b82d4[_0x3c5181(0x1cc)]),console['log']('mergedOptions',_0x2f74a4),console[_0x3c5181(0x254)](_0x3c5181(0x16a),_0x42947b+'/api/v3'),_0x9b82d4;}async[_0x25df75(0x18a)](_0x7bae04,_0x2dafa6,_0x4526a9=null){const _0x12c3bf=_0x25df75;let _0x279a31=[];for(const _0x2b35c0 of _0x2dafa6){const _0x1b9c96=new URL(_0x2b35c0);let _0x4de508=(0x0,path_1[_0x12c3bf(0x2b1)])(process[_0x12c3bf(0x157)](),_0x12c3bf(0x1a3),_0x1b9c96['pathname']);_0x4de508=decodeURIComponent(_0x4de508);const _0x3beeee=await _0x7bae04['files']['create']({'file':fs['createReadStream'](_0x4de508),'purpose':'file-extract'});let _0x298402=await(await _0x7bae04['files'][_0x12c3bf(0x265)](_0x3beeee['id']))[_0x12c3bf(0x29f)]();_0x279a31[_0x12c3bf(0x251)]({'role':_0x12c3bf(0x1db),'content':_0x298402});}return _0x279a31;}async[_0x25df75(0x186)](_0x54600d,_0x422adc){const _0x397160=_0x25df75;let _0x5f4f6b='',_0xdd3eb8=_0x54600d['statusCode'];return!_0x5f4f6b&&(_0x5f4f6b=errorMessage_constant_1[_0x397160(0x2dd)][_0xdd3eb8]?errorMessage_constant_1[_0x397160(0x2dd)][_0xdd3eb8]:_0x397160(0x1f2)),_0x54600d?.[_0x397160(0x23a)][_0x397160(0x2ab)](_0x397160(0x1e2))&&(await this[_0x397160(0x21c)][_0x397160(0x12f)](_0x422adc['id'],_0x397160(0x23f),-0x1),_0x5f4f6b=_0x397160(0x287)),_0x54600d?.[_0x397160(0x2ac)]===0x1ad&&_0x54600d[_0x397160(0x23a)][_0x397160(0x2ab)](_0x397160(0x266))&&(await this[_0x397160(0x21c)][_0x397160(0x12f)](_0x422adc['id'],_0x397160(0x274),-0x3),_0x5f4f6b='当前模型key余额已耗尽'),_0x54600d?.[_0x397160(0x2ac)]===0x191&&_0x54600d[_0x397160(0x23a)][_0x397160(0x2ab)](_0x397160(0x25c))&&(await this[_0x397160(0x21c)][_0x397160(0x12f)](_0x422adc['id'],_0x397160(0x1e7),-0x2),_0x5f4f6b='模型秘钥错误或模型金额不足，请联系管理员！'),_0x54600d?.[_0x397160(0x2ac)]===0x191&&(_0x5f4f6b='模型秘钥错误或模型金额不足，请联系管理员！'),_0x54600d?.[_0x397160(0x2ac)]===0x191&&_0x54600d[_0x397160(0x23a)][_0x397160(0x2ab)](_0x397160(0x1d5))&&(await this['modelsService']['lockKey'](_0x422adc['id'],'模型秘钥错误或模型余额不足',-0x2),_0x5f4f6b='模型秘钥错误或模型金额不足，请联系管理员！'),_0x54600d?.[_0x397160(0x2ac)]===0x194&&_0x54600d[_0x397160(0x23a)][_0x397160(0x2ab)](_0x397160(0x286))&&(await this[_0x397160(0x21c)]['lockKey'](_0x422adc['id'],_0x397160(0x2c4),-0x4),_0x5f4f6b=_0x397160(0x291)),_0x5f4f6b;}async[_0x25df75(0x13c)](_0xae1443,_0x1aa4af,_0x12bc4d,_0x53bf7d=!![]){const _0x12008d=_0x25df75;try{const _0x9f4c53=_0x1aa4af['abortController'],_0x1421d9=(0x0,utils_1[_0x12008d(0x2d7)])(this['clsService']),{options:options={},prompt:_0xa9c402,cusromPrompt:_0x4e7ded}=_0xae1443,{groupId:_0x2efc43,usingNetwork:_0x1be1a0,parentMessageId:_0x59adb4,type:_0x61aa3a}=options,{appId:_0x5212ab,modelConfig:_0x46fdf4}=await this[_0x12008d(0x23c)]({'type':_0x61aa3a,'groupId':_0x2efc43}),{systemMessage:_0x47770b,netWorkPrompt:_0x30e6c5}=await this[_0x12008d(0x273)]({'type':_0x61aa3a,'appId':_0x5212ab,'prompt':_0xa9c402,'usingNetwork':_0x1be1a0,'custom':_0x4e7ded,'systemMessage':_0xae1443[_0x12008d(0x262)],'customSystemMessage':_0x46fdf4['modelInfo'][_0x12008d(0x262)]}),_0x2bb77c=await this['getCurrentModel']({'type':_0x61aa3a,'groupId':_0x2efc43,'modelConfig':_0x46fdf4,'custom':_0x4e7ded});await this['validateBeforeChat']({'prompt':_0xa9c402,'currentRequestModel':_0x2bb77c,'user':_0x1aa4af[_0x12008d(0x2b5)]});const _0x5486b6=await this['autoreplyService']['checkAutoReply'](_0xa9c402);_0x53bf7d&&_0x12bc4d&&_0x12bc4d['setHeader'](_0x12008d(0x165),_0x12008d(0x19a));if(_0x5486b6){if(_0x53bf7d&&_0x12bc4d){const _0x2512bd={'message':_0x5486b6,'code':0x1f4};_0x12bc4d[_0x12008d(0x2cf)](JSON[_0x12008d(0x2a5)](_0x2512bd)),_0x12bc4d['end']();return;}else return _0x5486b6;}const _0x32972a=await this[_0x12008d(0x12e)](options['parentMessageId'],_0x47770b,_0x2bb77c);options['model']&&(_0x32972a['completionParams'][_0x12008d(0x1c1)]=options['model']);let {model:_0x397065,rounds:_0xf22be3,keyType:_0x794bd1,modelType:_0x27306e,id:_0x5f2007,topN:_0x139dd9}=_0x46fdf4[_0x12008d(0x217)];const {key:_0x1407ea,modelName:_0x1fe81d,id:_0x278965,accessToken:_0x54f595}=_0x2bb77c;_0x397065=_0x32972a[_0x12008d(0x1cf)][_0x12008d(0x1c1)],_0x12bc4d&&_0x12bc4d[_0x12008d(0x1d7)](0xc8);let _0x395316=null,_0xc87491=null;const _0xd1c04d=(0x0,utils_1[_0x12008d(0x1e1)])(_0x1aa4af),_0x4ea101={'appId':_0x5212ab,'curIp':_0xd1c04d,'prompt':_0xa9c402,'groupId':_0x2efc43,'modelId':_0x5f2007,'modelType':_0x27306e,'answer':'','model':_0x397065,'role':_0x12008d(0x2b5),'userId':_0x1aa4af[_0x12008d(0x2b5)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x12008d(0x168)][_0x12008d(0x239)],'logType':_0x61aa3a===_0x12008d(0x29d)?0x2:0x1,'requestOptions':JSON[_0x12008d(0x2a5)]({'options':options,'prompt':_0xa9c402}),'saasId':_0x1421d9},_0x4f3644={..._0x4ea101,'role':_0x12008d(0x13d),'requestOptions':JSON['stringify']({'prompt':_0xa9c402,'options':{'model':_0x397065,'temperature':_0x139dd9}})};try{if(_0x12bc4d){let _0x13a23c=null,_0x5879f1=![];_0x12bc4d['on'](_0x12008d(0x2e7),async()=>{const _0x13958d=_0x12008d;if(_0x5879f1)return;_0x9f4c53[_0x13958d(0x26d)]();const _0x48bdbf=0x0,_0x605bbe=0x0,_0x20c00c=_0x48bdbf+_0x605bbe;_0x4ea101[_0x13958d(0x1c8)]=_0x48bdbf,_0x4ea101[_0x13958d(0x1c9)]=_0x48bdbf,await this['chatLogService'][_0x13958d(0x1a9)](_0x4ea101),_0x4f3644['answer']=_0x13a23c?.[_0x13958d(0x29f)],_0x4f3644[_0x13958d(0x1c8)]=_0x20c00c,_0x4f3644[_0x13958d(0x1c9)]=_0x48bdbf,_0x4f3644[_0x13958d(0x2b7)]=_0x605bbe,_0x4f3644[_0x13958d(0x1c3)]=JSON[_0x13958d(0x2a5)]({'conversationId':_0x13a23c?.[_0x13958d(0x1ba)],'model':_0x397065,'parentMessageId':_0x13a23c?.['id'],'temperature':_0x139dd9});const _0x5137a4=await this['chatLogService'][_0x13958d(0x1a9)](_0x4f3644);await this[_0x13958d(0x25a)]['deductBalance4Chat'](_0x1aa4af[_0x13958d(0x2b5)]['id'],_0x2bb77c,_0x5137a4['id']);}),_0x12bc4d['on']('error',_0xf53828=>{const _0x2de6f=_0x12008d;console[_0x2de6f(0x254)](_0xf53828);});if(Number(_0x794bd1)===0x1){let _0x3ee852=!![];const _0x459bd4=await this['configChatGptApi'](_0x2bb77c,_0x32972a);_0x395316=await _0x459bd4[_0x12008d(0x1b3)](_0x1be1a0?_0x30e6c5:_0xa9c402,{..._0x32972a,'onProgress':_0x18a296=>{const _0x3e96ec=_0x12008d;_0x53bf7d&&_0x12bc4d[_0x3e96ec(0x2cf)](_0x3ee852?JSON['stringify'](_0x18a296):'\x0a'+JSON['stringify'](_0x18a296)),_0x3ee852=![],_0x13a23c=_0x18a296;},'abortSignal':_0x9f4c53['signal']}),_0x5879f1=!![];}if(Number(_0x794bd1)===0x2){let _0x1251f5=!![];const _0x2ee663=await this['gomaxAiStore'][_0x12008d(0x131)](_0x1be1a0?_0x30e6c5:_0xa9c402,{'parentMessageId':_0x59adb4,'maxRounds':(0x0,helper_1[_0x12008d(0x164)])(_0xf22be3)});_0x395316=await(0x0,baidu_1[_0x12008d(0x1a4)])(_0x1be1a0?_0x30e6c5:_0x2ee663,{'temperature':_0x139dd9,'accessToken':_0x54f595,'model':_0x397065,'onProgress':_0x174c84=>{const _0x586989=_0x12008d;_0x53bf7d&&_0x12bc4d['write'](_0x1251f5?JSON[_0x586989(0x2a5)](_0x174c84):'\x0a'+JSON[_0x586989(0x2a5)](_0x174c84)),_0x1251f5=![],_0x13a23c=_0x174c84;}}),_0x5879f1=!![];}if(Number(_0x794bd1)===0x3){let _0x448ff2=!![];const _0x1b94ce=await this[_0x12008d(0x2b4)]['buildMessageFromParentMessageId'](_0x1be1a0?_0x30e6c5:_0xa9c402,{'parentMessageId':_0x59adb4,'maxRounds':(0x0,helper_1[_0x12008d(0x164)])(_0xf22be3)});_0x395316=await(0x0,zhipu_1[_0x12008d(0x15c)])(_0x1be1a0?_0x30e6c5:_0x1b94ce,{'temperature':_0x139dd9,'key':_0x1407ea,'model':_0x397065,'onProgress':_0x529ee5=>{const _0x1ec9c2=_0x12008d;_0x53bf7d&&_0x12bc4d['write'](_0x448ff2?JSON[_0x1ec9c2(0x2a5)](_0x529ee5):'\x0a'+JSON['stringify'](_0x529ee5)),_0x448ff2=![],_0x13a23c=_0x529ee5;}}),_0x5879f1=!![];}if(Number(_0x794bd1)===0x4){let _0x64baa8=!![];const {key:_0x47e290,appid:_0xe5caf,secret:_0x457c64,model:_0x1e489d}=_0x2bb77c,_0x5be93a=await this[_0x12008d(0x2b4)]['buildMessageFromParentMessageId'](_0x1be1a0?_0x30e6c5:_0xa9c402,{'parentMessageId':_0x59adb4,'maxRounds':(0x0,helper_1[_0x12008d(0x164)])(_0xf22be3)}),_0x4296c3=new spark_1['XunFeiSpark']({'appid':_0xe5caf,'secret':_0x457c64,'key':_0x47e290});_0x395316=await _0x4296c3[_0x12008d(0x1cb)](_0x1be1a0?_0x30e6c5:_0x5be93a,{'temperature':_0x139dd9,'model':_0x1e489d,'onProgress':_0x6b0383=>{const _0x98b1d0=_0x12008d;_0x53bf7d&&_0x12bc4d[_0x98b1d0(0x2cf)](_0x64baa8?JSON[_0x98b1d0(0x2a5)](_0x6b0383):'\x0a'+JSON[_0x98b1d0(0x2a5)](_0x6b0383)),_0x64baa8=![],_0x13a23c=_0x6b0383;},'abortController':_0x9f4c53}),_0x5879f1=!![];}if(Number(_0x794bd1)===0x7){_0x395316={};const _0x208ad4=await this['configKimiApi'](_0x2bb77c);let _0x5678e2=!![],_0x442010=[],_0x525e8b=!![];const _0x2cc045=[],_0x47d2ad=[],_0x73d8f2=_0xa9c402[_0x12008d(0x154)]('\x20');for(let _0x2e855a=0x0;_0x2e855a<_0x73d8f2['length'];_0x2e855a++){_0x5678e2&&/^[http:\/\/|https:\/\/]/[_0x12008d(0x20e)](_0x73d8f2[_0x2e855a])?_0x2cc045[_0x12008d(0x251)](_0x73d8f2[_0x2e855a]):(_0x5678e2=![],_0x73d8f2[_0x2e855a]&&_0x47d2ad['push'](_0x73d8f2[_0x2e855a]));}if(options[_0x12008d(0x166)]){const _0x37b4ec=await this[_0x12008d(0x277)]['listByGroupId'](options[_0x12008d(0x2f1)]);_0x442010=_0x37b4ec[_0x12008d(0x2c9)](_0x1c3cba=>{const _0x8af39c=_0x12008d;return{'role':_0x1c3cba[_0x8af39c(0x1c6)]===_0x8af39c(0x2b5)?_0x8af39c(0x2b5):_0x8af39c(0x1db),'content':_0x1c3cba['prompt']||_0x1c3cba['answer']};});}const _0x494a8b=await this[_0x12008d(0x18a)](_0x208ad4,_0x2cc045),_0x49999e=[..._0x442010,..._0x494a8b,{'role':_0x12008d(0x1db),'content':_0x12008d(0x295)+_0x12008d(0x14c)+_0x12008d(0x1b7)},{'role':'user','content':_0x47d2ad[_0x12008d(0x2b1)]('\x20')}];console[_0x12008d(0x254)](_0x12008d(0x1cc),_0x208ad4[_0x12008d(0x1cc)]),console[_0x12008d(0x254)](_0x12008d(0x1f8),options),console[_0x12008d(0x254)](_0x12008d(0x16a),_0x208ad4[_0x12008d(0x213)]+_0x12008d(0x224)),console[_0x12008d(0x254)](_0x12008d(0x223),JSON[_0x12008d(0x2a5)](_0x49999e));const _0x54adbd=await _0x208ad4[_0x12008d(0x232)]['completions']['create']({'stream':!![],..._0x32972a,'messages':_0x49999e,'model':_0x2bb77c[_0x12008d(0x1c1)]});for await(const _0x3f4067 of _0x54adbd){const _0x2373da=_0x3f4067?.[_0x12008d(0x142)][0x0],_0x4598f7=_0x2373da?.[_0x12008d(0x27b)];_0x395316[_0x12008d(0x1f3)]=_0x3f4067,_0x3f4067['id']&&(_0x395316['id']=_0x3f4067['id']),_0x4598f7['role']&&(_0x395316[_0x12008d(0x1c6)]=_0x4598f7[_0x12008d(0x1c6)]),_0x4598f7&&_0x4598f7['content']&&(_0x395316['text']+=_0x4598f7[_0x12008d(0x265)],_0x395316['delta']=_0x4598f7?.[_0x12008d(0x265)]),_0x2373da[_0x12008d(0x1d6)]&&(_0x395316[_0x12008d(0x29f)]=_0x395316[_0x12008d(0x29f)][_0x12008d(0x1a2)]()),_0x54adbd&&_0x12bc4d[_0x12008d(0x2cf)](_0x525e8b?JSON[_0x12008d(0x2a5)](_0x395316):'\x0a'+JSON[_0x12008d(0x2a5)](_0x395316)),_0x525e8b=![],_0x13a23c=_0x3f4067;}}if(Number(_0x794bd1)===0x8){let _0x4ef42b=!![];const _0x199507=await this[_0x12008d(0x167)](_0x2bb77c,_0x32972a);_0x395316=await _0x199507[_0x12008d(0x1b3)](_0x1be1a0?_0x30e6c5:_0xa9c402,{..._0x32972a,'onProgress':_0x2a18f6=>{const _0x406116=_0x12008d;_0x53bf7d&&_0x12bc4d[_0x406116(0x2cf)](_0x4ef42b?JSON[_0x406116(0x2a5)](_0x2a18f6):'\x0a'+JSON['stringify'](_0x2a18f6)),_0x4ef42b=![],_0x13a23c=_0x2a18f6;},'abortSignal':_0x9f4c53[_0x12008d(0x1f5)]}),_0x5879f1=!![];}const _0x5e9b4c={'id':this['gomaxAiStore'][_0x12008d(0x25d)](),'text':_0xa9c402,'role':'user','name':undefined,'usage':null,'parentMessageId':_0x59adb4,'conversationId':_0x395316?.[_0x12008d(0x1ba)]||null};_0xc87491={'model':_0x397065,'parentMessageId':_0x59adb4},await this[_0x12008d(0x2b4)][_0x12008d(0x19f)](_0x5e9b4c);const _0x58e94f={'id':_0x395316?.['id']||this['gomaxAiStore'][_0x12008d(0x25d)](),'text':_0x395316['text'],'role':'assistant','name':undefined,'usage':_0x395316[_0x12008d(0x267)],'parentMessageId':_0x5e9b4c['id'],'conversationId':_0x395316?.['conversationId']};await this['gomaxAiStore'][_0x12008d(0x19f)](_0x58e94f),_0xc87491={'model':_0x397065,'parentMessageId':_0x5e9b4c['id']};}else{console[_0x12008d(0x254)](_0x12008d(0x20d));const _0x4a994c=await this[_0x12008d(0x236)](_0x2bb77c,_0x32972a);_0x395316=await _0x4a994c[_0x12008d(0x1b3)](_0x1be1a0?_0x30e6c5:_0xa9c402,_0x32972a);}const _0x4a115d=(0x0,helper_1[_0x12008d(0x27f)])(_0x794bd1,_0x395316,_0xc87491),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x4a115d[_0x12008d(0x267)];_0x61aa3a===_0x12008d(0x29d)?await this['gptsService'][_0x12008d(0x17f)](_0x278965,total_tokens):await this[_0x12008d(0x21c)]['saveUseLog'](_0x278965,total_tokens);_0x4ea101[_0x12008d(0x1c8)]=total_tokens,await this[_0x12008d(0x277)][_0x12008d(0x1a9)](_0x4ea101),_0x4f3644[_0x12008d(0x197)]=_0x4a115d?.[_0x12008d(0x29f)],_0x4f3644[_0x12008d(0x1c8)]=total_tokens,_0x4f3644[_0x12008d(0x1c9)]=prompt_tokens,_0x4f3644['completionTokens']=completion_tokens,_0x4f3644[_0x12008d(0x1c3)]=JSON[_0x12008d(0x2a5)]({'conversationId':_0x395316[_0x12008d(0x1ba)],'model':_0x397065,'parentMessageId':_0x395316['id'],'temperature':_0x139dd9});const _0x183e06=await this[_0x12008d(0x277)][_0x12008d(0x1a9)](_0x4f3644);common_1['Logger'][_0x12008d(0x1c7)](_0x12008d(0x269)+_0x1aa4af[_0x12008d(0x2b5)]['id']+_0x12008d(0x2d8)+_0x397065+'\x20key\x20->\x20'+_0x1407ea+_0x12008d(0x28f)+_0x1fe81d,'ChatgptService'),_0x395316[_0x12008d(0x13b)]&&(_0x395316['result']=''),_0x395316[_0x12008d(0x22b)]=!![],_0x395316[_0x12008d(0x1ef)]=_0x183e06['id'];if(_0x12bc4d&&_0x53bf7d)await this['userService']['deductBalance4Chat'](_0x1aa4af['user']['id'],_0x2bb77c,_0x183e06['id']),_0x12bc4d[_0x12008d(0x2cf)]('\x0a'+JSON[_0x12008d(0x2a5)](_0x395316));else return _0x395316[_0x12008d(0x29f)];}catch(_0x2fda6f){_0x4f3644['answer']=_0x2fda6f['message'],_0x4f3644[_0x12008d(0x241)]=_0x2fda6f[_0x12008d(0x23a)],_0x4f3644[_0x12008d(0x1c3)]=JSON[_0x12008d(0x2a5)]({'conversationId':_0x395316?.['conversationId'],'model':_0x397065,'parentMessageId':_0x395316?.['id'],'temperature':_0x139dd9}),await this[_0x12008d(0x277)][_0x12008d(0x1a9)](_0x4f3644),console[_0x12008d(0x254)](_0x12008d(0x1b9),_0x1407ea,_0x2fda6f);const _0xc69540=_0x2fda6f[_0x12008d(0x2ac)];_0xc69540===0x190&&console['log'](_0x12008d(0x22f),_0x2fda6f,_0x2fda6f['message']);if(_0x2fda6f['status']&&_0x2fda6f['status']===0x192){const _0xfc9bd0={'message':_0x12008d(0x247)+_0x2fda6f['message'],'code':0x192};if(_0x12bc4d&&_0x53bf7d){_0x12bc4d[_0x12008d(0x2cf)](JSON[_0x12008d(0x2a5)](_0xfc9bd0)),_0x12bc4d[_0x12008d(0x201)]();return;}else throw new common_1[(_0x12008d(0x2e6))](_0x2fda6f[_0x12008d(0x23a)],common_1[_0x12008d(0x2b8)]['PAYMENT_REQUIRED']);}if(!_0xc69540){if(_0x12bc4d&&_0x53bf7d){_0x12bc4d[_0x12008d(0x2cf)](JSON['stringify']({'message':_0x2fda6f[_0x12008d(0x23a)],'code':0x1f4})),_0x12bc4d[_0x12008d(0x201)]();return;}else throw new common_1[(_0x12008d(0x2e6))](_0x2fda6f[_0x12008d(0x23a)],common_1[_0x12008d(0x2b8)][_0x12008d(0x298)]);}const _0x6d5640=await this[_0x12008d(0x186)](_0x2fda6f,_0x2bb77c),_0x408b57={'message':_0x6d5640||_0x12008d(0x19e),'code':_0xc69540===0x191?0x191:_0xc69540||0x1f4};if(_0x12bc4d&&_0x53bf7d)_0x12bc4d[_0x12008d(0x2ac)]=0x190,_0x12bc4d[_0x12008d(0x2cf)](JSON[_0x12008d(0x2a5)](_0x408b57));else throw new common_1[(_0x12008d(0x2e6))](_0x408b57[_0x12008d(0x23a)],common_1[_0x12008d(0x2b8)][_0x12008d(0x298)]);}finally{_0x12bc4d&&_0x53bf7d&&_0x12bc4d[_0x12008d(0x201)]();}}catch(_0x33a883){if(_0x33a883 instanceof common_1['HttpException'])throw _0x33a883;else throw new common_1['HttpException'](_0x33a883[_0x12008d(0x23a)],common_1[_0x12008d(0x2b8)][_0x12008d(0x298)]);}}async['musicTask'](_0x4366af){const _0xc300cc=_0x25df75,{userId:_0xba3167,prompt:_0x2c1612,options:_0xb77102,answerLogDTO:_0x4ff177,currentRequestModel:_0x559b17}=_0x4366af;try{const _0x519472=await this[_0xc300cc(0x236)](_0x559b17,_0xb77102),_0x29a006=await _0x519472[_0xc300cc(0x1b3)](_0x2c1612,{..._0xb77102,'onProgress':_0x24657b=>{}});let _0x516d65={'model':_0xb77102[_0xc300cc(0x1cf)][_0xc300cc(0x1c1)],'parentMessageId':_0xb77102['parentMessageId']};const _0x484a26=(0x0,helper_1[_0xc300cc(0x27f)])(0x1,_0x29a006,_0x516d65),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x484a26['usage'];await this[_0xc300cc(0x21c)][_0xc300cc(0x155)](_0x559b17['id'],total_tokens),_0x4ff177[_0xc300cc(0x197)]=_0x484a26?.[_0xc300cc(0x29f)],_0x4ff177[_0xc300cc(0x1c8)]=total_tokens,_0x4ff177[_0xc300cc(0x1c9)]=prompt_tokens,_0x4ff177[_0xc300cc(0x2b7)]=completion_tokens,_0x4ff177[_0xc300cc(0x1c3)]=JSON['stringify']({'conversationId':_0x29a006[_0xc300cc(0x1ba)],'model':_0x484a26['model'],'parentMessageId':_0x29a006['id'],'temperature':_0xb77102[_0xc300cc(0x1cf)][_0xc300cc(0x144)]}),await this[_0xc300cc(0x277)][_0xc300cc(0x1a9)](_0x4ff177),common_1['Logger']['debug'](_0xc300cc(0x269)+_0xba3167+_0xc300cc(0x2d8)+_0x559b17['model']+_0xc300cc(0x28d)+_0x559b17[_0xc300cc(0x1b4)]+',\x20模型名称:\x20'+_0x559b17[_0xc300cc(0x16f)],_0xc300cc(0x194));if(!_0x4ff177[_0xc300cc(0x197)])throw new Error(_0xc300cc(0x1c5));await this[_0xc300cc(0x277)][_0xc300cc(0x1ce)](_0x4ff177);}catch(_0x487538){console[_0xc300cc(0x254)](_0xc300cc(0x1ab),_0x559b17[_0xc300cc(0x1b4)],_0x487538);const _0x2f8ab4=await this[_0xc300cc(0x186)](_0x487538,_0x559b17);_0x4ff177[_0xc300cc(0x241)]=_0x2f8ab4,await this[_0xc300cc(0x277)][_0xc300cc(0x1a9)](_0x4ff177),await this['userService'][_0xc300cc(0x1be)](_0xba3167,_0x559b17,_0x4ff177['id']);}}async[_0x25df75(0x1eb)](_0x454729){const _0x23e942=_0x25df75,{data:_0x4ad50d,answerLogDTO:_0x2c1e00,currentRequestModel:_0x3467c8}=_0x454729;try{let _0x585684;await this[_0x23e942(0x25a)][_0x23e942(0x1c2)](_0x2c1e00[_0x23e942(0x1d1)],_0x3467c8,_0x2c1e00['id']);_0x4ad50d[_0x23e942(0x2c7)]?_0x585684=await this[_0x23e942(0x2e1)][_0x23e942(0x237)]({'data':_0x4ad50d,'baseURL':_0x3467c8[_0x23e942(0x16c)],'headers':{'Authorization':_0x23e942(0x137)+_0x3467c8[_0x23e942(0x1b4)]}},_0x4ad50d[_0x23e942(0x2c7)]):_0x585684=await this[_0x23e942(0x2e1)][_0x23e942(0x2e2)]({'data':_0x4ad50d,'baseURL':_0x3467c8[_0x23e942(0x16c)],'headers':{'Authorization':_0x23e942(0x137)+_0x3467c8[_0x23e942(0x1b4)]}});await this['modelsService'][_0x23e942(0x155)](_0x3467c8['id'],0x0),_0x2c1e00['totalTokens']=0x0,_0x2c1e00[_0x23e942(0x1c9)]=0x0,_0x2c1e00[_0x23e942(0x2b7)]=0x0,_0x2c1e00[_0x23e942(0x197)]=_0x585684['state'],_0x2c1e00[_0x23e942(0x1c3)]=JSON['stringify']({'model':_0x3467c8[_0x23e942(0x1c1)],'parentMessageId':_0x585684['id']}),await this[_0x23e942(0x277)][_0x23e942(0x1a9)](_0x2c1e00),common_1[_0x23e942(0x1f4)][_0x23e942(0x1c7)](_0x23e942(0x269)+_0x2c1e00['userId']+_0x23e942(0x2d8)+_0x3467c8[_0x23e942(0x1c1)]+_0x23e942(0x28d)+_0x3467c8[_0x23e942(0x1b4)]+_0x23e942(0x28f)+_0x3467c8[_0x23e942(0x16f)],_0x23e942(0x194));if(!_0x2c1e00['answer'])throw new Error(_0x23e942(0x1ae));await this[_0x23e942(0x277)][_0x23e942(0x221)](_0x2c1e00,_0x585684);}catch(_0x19e0df){console[_0x23e942(0x254)](_0x23e942(0x2af),_0x3467c8[_0x23e942(0x1b4)],_0x19e0df);const _0x53b99d=await this[_0x23e942(0x186)](_0x19e0df,_0x3467c8);_0x2c1e00[_0x23e942(0x241)]=_0x53b99d,await this[_0x23e942(0x277)][_0x23e942(0x1a9)](_0x2c1e00),await this[_0x23e942(0x25a)][_0x23e942(0x1be)](_0x2c1e00['userId'],_0x3467c8,_0x2c1e00['id']);}}async[_0x25df75(0x196)](_0x1b81b4){const _0x45a797=_0x25df75;try{const _0x415958=(0x0,utils_1[_0x45a797(0x2d7)])(this['clsService']),{req:_0xcee3d1,model:_0x43ded1,modelType:_0x2a2c4d,datas:_0x309336}=_0x1b81b4,{prompt:_0x1ef9cc,options:options={},cusromPrompt:_0xfc10f7}=_0x309336,{groupId:_0x3d1455,usingNetwork:_0x6985c3,type:_0x41b624}=options,{appId:_0x83fb,modelConfig:_0x218da1}=await this[_0x45a797(0x23c)]({'modelType':_0x2a2c4d}),{systemMessage:_0xb19ba0,netWorkPrompt:_0x49f4b2}=await this[_0x45a797(0x273)]({'type':_0x41b624,'appId':_0x83fb,'prompt':_0x1ef9cc,'usingNetwork':_0x6985c3,'custom':_0xfc10f7,'systemMessage':_0x309336[_0x45a797(0x262)],'customSystemMessage':_0x218da1[_0x45a797(0x217)][_0x45a797(0x262)]}),_0x563159=await this[_0x45a797(0x21c)][_0x45a797(0x2dc)](_0x2a2c4d);_0x563159[_0x45a797(0x1c1)]=_0x43ded1,_0x218da1[_0x45a797(0x217)][_0x45a797(0x1c1)]=_0x43ded1,await this[_0x45a797(0x14e)]({'prompt':_0x1ef9cc,'currentRequestModel':_0x563159,'user':_0xcee3d1[_0x45a797(0x2b5)]});const _0xf583ed=await this[_0x45a797(0x12e)](options[_0x45a797(0x166)],_0xb19ba0,_0x563159);let {id:_0x2c0300,topN:_0x59235a}=_0x218da1['modelInfo'];const _0x22dbba=0x0,_0x281640=0x0,_0x183773=_0x22dbba+_0x281640,_0xe58563=(0x0,utils_1[_0x45a797(0x1e1)])(_0xcee3d1),_0x339bda={'appId':_0x83fb,'curIp':_0xe58563,'prompt':_0x1ef9cc,'groupId':_0x3d1455,'modelId':_0x2c0300,'modelType':_0x2a2c4d,'answer':'','model':_0x43ded1,'role':_0x45a797(0x2b5),'userId':_0xcee3d1[_0x45a797(0x2b5)]['id'],'completionTokens':0x0,'totalTokens':_0x183773,'type':balance_constant_1[_0x45a797(0x168)][_0x45a797(0x239)],'logType':_0x41b624===_0x45a797(0x29d)?0x2:0x1,'requestOptions':JSON['stringify']({'options':null,'prompt':_0x1ef9cc}),'saasId':_0x415958},_0x28eea4={..._0x339bda,'role':_0x45a797(0x13d),'requestOptions':JSON[_0x45a797(0x2a5)]({'prompt':_0x1ef9cc,'options':{'model':_0x43ded1,'temperature':_0x59235a}})};await this[_0x45a797(0x277)][_0x45a797(0x1a9)](_0x339bda);const _0x380140=await this['chatLogService']['saveChatLog'](_0x28eea4);await this[_0x45a797(0x25a)][_0x45a797(0x1c2)](_0xcee3d1[_0x45a797(0x2b5)]['id'],_0x563159,_0x380140['id']);if(_0x2a2c4d===model_constant_1[_0x45a797(0x1e4)][_0x45a797(0x1e0)])this['musicTask']({'userId':_0xcee3d1[_0x45a797(0x2b5)]['id'],'currentRequestModel':_0x563159,'options':_0xf583ed,'answerLogDTO':_0x380140,'prompt':_0x6985c3?_0x49f4b2:_0x1ef9cc});else _0x2a2c4d===model_constant_1[_0x45a797(0x1e4)]['VIDEO']&&this['videoTask']({'data':_0x309336,'currentRequestModel':_0x563159,'answerLogDTO':_0x380140});return _0x380140;}catch(_0xa85c58){if(_0xa85c58 instanceof common_1[_0x45a797(0x2e6)])throw _0xa85c58;else throw new common_1[(_0x45a797(0x2e6))](_0xa85c58['message'],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x25df75(0x16d)](_0x348704,_0x3727ef){const _0x329e90=_0x25df75;let {mv:_0x5ea520,tags:_0x1dadb0,title:_0x111f66,prompt:_0x248dd0,continue_at:_0x519b33,continue_clip_id:_0x4bc69b,make_instrumental:_0x21ad58}=_0x348704,_0x260f21=_0x329e90(0x1df)+_0x248dd0;return _0x5ea520&&(_0x260f21=_0x260f21+_0x329e90(0x2ba)+_0x5ea520),_0x1dadb0&&(_0x260f21=_0x260f21+_0x329e90(0x1ad)+_0x1dadb0),_0x111f66&&(_0x260f21=_0x260f21+_0x329e90(0x214)+_0x111f66),_0x519b33&&(_0x260f21=_0x260f21+_0x329e90(0x17e)+_0x519b33),_0x4bc69b&&(_0x260f21=_0x260f21+_0x329e90(0x28e)+_0x4bc69b),_0x260f21=_0x260f21+_0x329e90(0x1ac)+_0x21ad58,_0x348704[_0x329e90(0x2bb)]=_0x260f21,_0x248dd0=_0x260f21,this[_0x329e90(0x196)]({'req':_0x3727ef,'datas':_0x348704,'model':_0x5ea520||_0x329e90(0x15d),'modelType':model_constant_1[_0x329e90(0x1e4)][_0x329e90(0x1e0)]});}async[_0x25df75(0x2a4)](_0x5d4e9f,_0x50ddff){const _0x1fe9f8=_0x25df75;let {model:_0x34d652,prompt:_0x22ca69,expand_prompt:_0xb2a970,aspect_ratio:_0x335d79,image_url:_0x4d1a84,image_end_url:_0x2f7dca}=_0x5d4e9f,_0x5b9199=_0x1fe9f8(0x1df)+_0x22ca69+_0x1fe9f8(0x28a)+_0xb2a970+_0x1fe9f8(0x176)+_0x335d79;return _0x4d1a84&&(_0x5b9199=_0x5b9199+_0x1fe9f8(0x17a)+_0x4d1a84),_0x2f7dca&&(_0x5b9199=_0x5b9199+_0x1fe9f8(0x140)+_0x2f7dca),_0x5d4e9f[_0x1fe9f8(0x2bb)]=_0x5b9199,_0x5d4e9f[_0x1fe9f8(0x209)]=_0x22ca69,this['chatTask']({'req':_0x50ddff,'datas':_0x5d4e9f,'model':_0x34d652||_0x1fe9f8(0x130),'modelType':model_constant_1[_0x1fe9f8(0x1e4)]['VIDEO']});}async['syncLumaTask'](){const _0x35c5be=_0x25df75,_0x1242c9=await this[_0x35c5be(0x277)][_0x35c5be(0x2a8)]();if(!_0x1242c9[_0x35c5be(0x20b)])return;const _0x11020a=[],_0x2f322b=new Map();_0x1242c9[_0x35c5be(0x1b6)](_0x1fb198=>{const _0x508861=_0x35c5be;_0x11020a[_0x508861(0x251)](_0x1fb198['id']),_0x2f322b[_0x508861(0x21b)](_0x1fb198['id'],_0x1fb198);});const _0x3e077d=await this[_0x35c5be(0x277)][_0x35c5be(0x19b)](_0x11020a),_0x5834a2=[],_0x2b2a25=new Map();_0x3e077d[_0x35c5be(0x1b6)](_0x40ada4=>{const _0x24ac82=_0x35c5be;_0x5834a2[_0x24ac82(0x251)](_0x40ada4[_0x24ac82(0x2ce)]),_0x2b2a25[_0x24ac82(0x21b)](_0x40ada4[_0x24ac82(0x2ce)],_0x40ada4);});const _0x52111f=await this['modelsService'][_0x35c5be(0x2dc)](model_constant_1['EModelType'][_0x35c5be(0x290)]),_0x594c34=await this[_0x35c5be(0x2e1)][_0x35c5be(0x178)]({'baseURL':_0x52111f['proxyUrl'],'headers':{'Authorization':_0x35c5be(0x137)+_0x52111f[_0x35c5be(0x1b4)]},'data':{'ids':_0x5834a2}});for(let _0x3e134e=0x0;_0x3e134e<_0x594c34[_0x35c5be(0x20b)];_0x3e134e++){const _0x2ed0f8=_0x594c34[_0x3e134e],_0x24843e=_0x2b2a25[_0x35c5be(0x259)](_0x2ed0f8['task_id']),_0x40a58f=_0x2f322b['get'](_0x24843e[_0x35c5be(0x1ef)]);await this[_0x35c5be(0x277)]['parseAndSaveVideo'](_0x40a58f,_0x2ed0f8[_0x35c5be(0x2e3)]);}}async['requestFromGpt'](_0x56ec6f){const _0x4aa88f=_0x25df75,{prompt:_0x5af4f9,userId:_0x3dc5bd,abortController:_0x5f52b9}=_0x56ec6f,_0x2e50cc=await this['modelsService'][_0x4aa88f(0x18e)](model_constant_1[_0x4aa88f(0x1e4)]['CHAT']),_0x26e255=_0x2e50cc[_0x4aa88f(0x217)],_0x49fd41=_0x2e50cc[_0x4aa88f(0x217)][_0x4aa88f(0x20f)];if(!_0x26e255)throw new common_1['HttpException'](_0x4aa88f(0x200),common_1[_0x4aa88f(0x2b8)][_0x4aa88f(0x298)]);const {id:_0x58f242}=_0x26e255;let _0x3d4efa=null,_0x3e9e92=null;try{const _0x486d9f=await this['buildOptions']('','',_0x26e255),_0x39580f=await this[_0x4aa88f(0x236)](_0x26e255,_0x486d9f);_0x3d4efa=await _0x39580f[_0x4aa88f(0x1b3)](_0x5af4f9,{..._0x486d9f,'abortSignal':_0x5f52b9[_0x4aa88f(0x1f5)]});const _0xbf3d79=(0x0,helper_1['unifiedFormattingResponse'])(_0x49fd41,_0x3d4efa,_0x3e9e92),{total_tokens:total_tokens=0x0}=_0xbf3d79['usage'];return await this[_0x4aa88f(0x21c)][_0x4aa88f(0x155)](_0x58f242,total_tokens),await this[_0x4aa88f(0x25a)]['deductBalance4Chat'](_0x3dc5bd,_0x26e255,-0x1),_0x3d4efa['text'];}catch(_0xa486e4){common_1[_0x4aa88f(0x1f4)][_0x4aa88f(0x254)](_0xa486e4);const _0x525bc9=_0xa486e4['statusCode'];console['log'](_0x525bc9);if(_0xa486e4[_0x4aa88f(0x1d7)]&&_0xa486e4[_0x4aa88f(0x1d7)]===0x192)throw new common_1[(_0x4aa88f(0x2e6))](_0xa486e4[_0x4aa88f(0x23a)],common_1[_0x4aa88f(0x2b8)][_0x4aa88f(0x19c)]);if(!_0x525bc9)throw new common_1['HttpException'](_0xa486e4[_0x4aa88f(0x23a)],common_1[_0x4aa88f(0x2b8)]['BAD_REQUEST']);let _0x5e97fe=errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x525bc9]?errorMessage_constant_1[_0x4aa88f(0x2dd)][_0x525bc9]:'服务异常、请重新试试吧！！！';_0xa486e4?.[_0x4aa88f(0x23a)]['includes'](_0x4aa88f(0x1e2))&&Number(_0x49fd41)===0x1&&(await this[_0x4aa88f(0x21c)][_0x4aa88f(0x12f)](_0x58f242,_0x4aa88f(0x23f),-0x1),_0x5e97fe=_0x4aa88f(0x287));_0xa486e4?.['statusCode']===0x1ad&&_0xa486e4[_0x4aa88f(0x23a)][_0x4aa88f(0x2ab)](_0x4aa88f(0x266))&&Number(_0x49fd41)===0x1&&(await this[_0x4aa88f(0x21c)][_0x4aa88f(0x12f)](_0x58f242,_0x4aa88f(0x274),-0x3),_0x5e97fe='当前模型key余额已耗尽');_0xa486e4?.[_0x4aa88f(0x2ac)]===0x191&&_0xa486e4[_0x4aa88f(0x23a)][_0x4aa88f(0x2ab)]('Incorrect\x20API\x20key\x20provided')&&Number(_0x49fd41)===0x1&&(await this[_0x4aa88f(0x21c)][_0x4aa88f(0x12f)](_0x58f242,'提供了错误的模型秘钥',-0x2),_0x5e97fe=_0x4aa88f(0x149));_0xa486e4?.['statusCode']===0x191&&_0xa486e4[_0x4aa88f(0x23a)][_0x4aa88f(0x2ab)](_0x4aa88f(0x1d5))&&Number(_0x49fd41)===0x1&&(await this[_0x4aa88f(0x21c)][_0x4aa88f(0x12f)](_0x58f242,_0x4aa88f(0x1b8),-0x2),_0x5e97fe='当前模型key余额已耗尽，请充值！');_0xa486e4?.[_0x4aa88f(0x2ac)]===0x194&&_0xa486e4[_0x4aa88f(0x23a)]['includes'](_0x4aa88f(0x286))&&Number(_0x49fd41)===0x1&&(await this[_0x4aa88f(0x21c)]['lockKey'](_0x58f242,_0x4aa88f(0x2c4),-0x4),_0x5e97fe=_0x4aa88f(0x291));_0xa486e4?.['statusCode']===0x133&&_0xa486e4[_0x4aa88f(0x23a)][_0x4aa88f(0x2ab)](_0x4aa88f(0x12a))&&Number(_0x49fd41)===0x1&&(console[_0x4aa88f(0x254)](_0x4aa88f(0x285)),_0x5e97fe='\x20！');_0x525bc9===0x190&&console['log'](_0x4aa88f(0x22f),_0xa486e4,_0xa486e4['message']);const _0x44a64d={'message':_0x5e97fe||_0x4aa88f(0x19e),'code':_0x525bc9===0x191?0x191:_0x525bc9||0x1f4};throw new common_1[(_0x4aa88f(0x2e6))](_0x44a64d[_0x4aa88f(0x23a)],common_1[_0x4aa88f(0x2b8)][_0x4aa88f(0x298)]);}}async[_0x25df75(0x227)](_0x22c65f,_0x468e18,_0x25e790){const _0x45fb04=_0x25df75;try{const {audio:_0x52c323,voice:_0x216b70}=_0x22c65f,_0x27a8b8=_0x468e18[_0x45fb04(0x272)],_0x525830=await this[_0x45fb04(0x21c)][_0x45fb04(0x2df)]();if(!_0x525830)throw _0x45fb04(0x1af);const {key:_0x50de3b,proxyUrl:_0x5cf4ef}=_0x525830;await this[_0x45fb04(0x25a)][_0x45fb04(0x24b)](_0x468e18[_0x45fb04(0x2b5)]),await this[_0x45fb04(0x25a)][_0x45fb04(0x2ca)](_0x468e18[_0x45fb04(0x2b5)]['id'],_0x525830),console[_0x45fb04(0x254)](_0x45fb04(0x26b),_0x50de3b,_0x5cf4ef),this[_0x45fb04(0x14f)][_0x45fb04(0x1cc)]=_0x50de3b,this[_0x45fb04(0x14f)][_0x45fb04(0x213)]=(_0x5cf4ef||this[_0x45fb04(0x2ec)])+'/v1',this[_0x45fb04(0x14f)][_0x45fb04(0x181)]=0x989680;const _0x2e9677=await this[_0x45fb04(0x14f)][_0x45fb04(0x1e9)]['transcriptions'][_0x45fb04(0x13a)]({'file':(0x0,fs_1[_0x45fb04(0x1c4)])((0x0,path_1[_0x45fb04(0x1a7)])(_0x52c323[_0x45fb04(0x288)])),'model':_0x45fb04(0x2b2),'language':'zh','response_format':'json','temperature':0x0})[_0x45fb04(0x1d3)](_0x20ea85=>_0x20ea85[_0x45fb04(0x29f)])[_0x45fb04(0x175)](_0x16b54a=>{const _0x11ce37=_0x45fb04;common_1[_0x11ce37(0x1f4)][_0x11ce37(0x27d)](_0x16b54a);});console[_0x45fb04(0x254)](_0x45fb04(0x22d),_0x2e9677);if(!_0x2e9677){this['removeFile']((0x0,path_1[_0x45fb04(0x1a7)])(_0x52c323[_0x45fb04(0x288)]));throw new common_1['HttpException'](_0x45fb04(0x2c3),common_1[_0x45fb04(0x2b8)][_0x45fb04(0x298)]);}await this[_0x45fb04(0x25a)][_0x45fb04(0x1c2)](_0x468e18[_0x45fb04(0x2b5)]['id'],_0x525830,-0x1);const _0x146c53=await this['requestFromGpt']({'userId':_0x468e18[_0x45fb04(0x2b5)]['id'],'prompt':_0x2e9677,'abortController':_0x27a8b8});console['log'](_0x45fb04(0x13f),_0x146c53);if(!_0x146c53){this[_0x45fb04(0x14d)]((0x0,path_1[_0x45fb04(0x1a7)])(_0x52c323[_0x45fb04(0x288)]));throw new common_1[(_0x45fb04(0x2e6))](_0x45fb04(0x1e5),common_1[_0x45fb04(0x2b8)][_0x45fb04(0x298)]);}console[_0x45fb04(0x254)](_0x45fb04(0x17c),_0x146c53[_0x45fb04(0x20b)]);let _0x5c0d82=_0x146c53[_0x45fb04(0x20b)]>0x1000?_0x146c53[_0x45fb04(0x2ed)](0x0,0xfff):_0x146c53;const _0x5de36e=await this[_0x45fb04(0x14f)][_0x45fb04(0x1e9)][_0x45fb04(0x19d)]['create']({'input':_0x5c0d82,'model':_0x45fb04(0x215),'response_format':_0x45fb04(0x283),'voice':_0x216b70,'speed':0x1})[_0x45fb04(0x1d3)](_0x28c1ac=>_0x28c1ac[_0x45fb04(0x211)]())[_0x45fb04(0x175)](_0x548fc9=>{const _0x151c42=_0x45fb04;common_1['Logger'][_0x151c42(0x27d)](_0x548fc9);});if(!_0x5de36e){this['removeFile']((0x0,path_1['resolve'])(_0x52c323[_0x45fb04(0x288)]));throw new common_1['HttpException'](_0x45fb04(0x1dc),common_1[_0x45fb04(0x2b8)][_0x45fb04(0x298)]);}await this['userService'][_0x45fb04(0x1c2)](_0x468e18['user']['id'],_0x525830,-0x1);const _0x1dd999=Buffer['from'](_0x5de36e);return _0x25e790[_0x45fb04(0x258)](_0x45fb04(0x165),'application/octet-stream'),_0x25e790[_0x45fb04(0x2cf)](_0x1dd999),_0x25e790[_0x45fb04(0x201)](_0x1dd999),this[_0x45fb04(0x14d)]((0x0,path_1['resolve'])(_0x52c323['path'])),_0x1dd999;}catch(_0x12c3f2){if(_0x12c3f2 instanceof common_1['HttpException'])throw _0x12c3f2;else throw new common_1[(_0x45fb04(0x2e6))](_0x12c3f2['message'],common_1[_0x45fb04(0x2b8)][_0x45fb04(0x298)]);}}async[_0x25df75(0x1bc)](_0x19d4a5,_0x581bb5){const _0x2393af=_0x25df75;common_1['Logger'][_0x2393af(0x254)](_0x2393af(0x12c)+_0x19d4a5[_0x2393af(0x2bb)],_0x2393af(0x1f9)),await this[_0x2393af(0x2a7)][_0x2393af(0x172)](_0x19d4a5[_0x2393af(0x2bb)],_0x581bb5[_0x2393af(0x2b5)]['id']),await this[_0x2393af(0x25a)][_0x2393af(0x24b)](_0x581bb5[_0x2393af(0x2b5)]);let _0x485396=[];const _0x5afb3c=await this['modelsService']['getRandomKey'](model_constant_1['EModelType']['DRAW']);await this[_0x2393af(0x25a)][_0x2393af(0x2ca)](_0x581bb5['user']['id'],_0x5afb3c);const {key:_0x5500d9,model:_0x1420b4,proxyUrl:_0x41f60a}=await this[_0x2393af(0x188)](_0x5afb3c),_0x3a10c0=_0x41f60a+_0x2393af(0x16b);try{const _0xefdedd=await axios_1[_0x2393af(0x252)][_0x2393af(0x17b)](_0x3a10c0,{..._0x19d4a5,'model':_0x1420b4,'response_format':_0x2393af(0x2a3)},{'headers':{'Authorization':_0x2393af(0x137)+_0x5500d9}});_0x485396=_0xefdedd[_0x2393af(0x2e3)]['data'];}catch(_0x4fae01){console['log'](_0x2393af(0x1d2),_0x4fae01);const _0x5ec923=_0x4fae01?.['response']?.[_0x2393af(0x1d7)]||0x1f4,_0x4473b9=_0x4fae01?.[_0x2393af(0x159)]?.[_0x2393af(0x2e3)]?.['error']?.[_0x2393af(0x23a)];if(_0x5ec923===0x1ad)throw new common_1['HttpException'](_0x2393af(0x29b),common_1[_0x2393af(0x2b8)][_0x2393af(0x298)]);if(_0x5ec923===0x190||_0x4473b9[_0x2393af(0x2ab)](_0x2393af(0x22a)))throw new common_1[(_0x2393af(0x2e6))]('您的请求已被系统拒绝。您的提示可能存在一些非法的文本。',common_1[_0x2393af(0x2b8)]['BAD_REQUEST']);if(_0x5ec923===0x1f4)throw new common_1[(_0x2393af(0x2e6))]('绘制图片失败，请检查你的提示词是否有非法描述！',common_1['HttpStatus'][_0x2393af(0x298)]);if(_0x5ec923===0x191)throw new common_1[(_0x2393af(0x2e6))](_0x2393af(0x1fd),common_1[_0x2393af(0x2b8)][_0x2393af(0x298)]);throw new common_1['HttpException']('绘制图片失败，请稍后试试吧！',common_1[_0x2393af(0x2b8)]['BAD_REQUEST']);}const _0x28add4=[];for(const _0x3cc2d5 of _0x485396){const _0x4e765e=_0x3cc2d5['b64_json'][_0x2393af(0x2c0)](/^data:image\/\w+;base64,/,''),_0x2180e8=uuid['v4']()[_0x2393af(0x2ed)](0x0,0xa)+'.png',_0x5538e3=Buffer['from'](_0x4e765e,_0x2393af(0x21d));_0x28add4[_0x2393af(0x251)](this[_0x2393af(0x1e3)][_0x2393af(0x21e)]({'filename':_0x2180e8,'buffer':_0x5538e3}));}const _0x3e9861=(0x0,utils_1[_0x2393af(0x1e1)])(_0x581bb5),_0x384d05=await Promise['all'](_0x28add4),[_0x4292ae,_0x32fea4]=_0x19d4a5[_0x2393af(0x23e)]['split']('x'),_0x5e20f3=_0x384d05['map'](_0x42ec26=>{const _0x102841=_0x2393af;return this[_0x102841(0x277)][_0x102841(0x1a9)]({'curIp':_0x3e9861,'logType':0x3,'answer':_0x42ec26,'totalTokens':0x0,'promptTokens':0x0,'model':_0x102841(0x18f),'userId':_0x581bb5[_0x102841(0x2b5)]['id'],'prompt':_0x19d4a5[_0x102841(0x2bb)],'completionTokens':0x0,'modelType':model_constant_1[_0x102841(0x1e4)][_0x102841(0x2a9)],'type':balance_constant_1[_0x102841(0x168)][_0x102841(0x2d0)],'fileInfo':JSON[_0x102841(0x2a5)]({'width':_0x4292ae,'height':_0x32fea4,'cosUrl':_0x42ec26})});}),_0x42b8ce=await Promise[_0x2393af(0x23b)](_0x5e20f3);return await this[_0x2393af(0x25a)][_0x2393af(0x1c2)](_0x581bb5['user']['id'],_0x5afb3c,_0x42b8ce[0x0]['id']),_0x384d05;}async[_0x25df75(0x188)](_0x729d0d){const _0x10e419=_0x25df75,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x10e419(0x2cc)][_0x10e419(0x203)]([_0x10e419(0x26e),_0x10e419(0x143),_0x10e419(0x243),'openaiModel3MaxTokens16kRes',_0x10e419(0x141),_0x10e419(0x183),'openaiModel4MaxTokens32k','openaiModel4MaxTokens32kRes',_0x10e419(0x1fc)]);let _0x5c91d0=null,_0x1d27ac=null,_0x262c57=null;const {model:_0x52ed92,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x2d0edf,key:_0x448efa}=_0x729d0d;return _0x52ed92['toLowerCase']()[_0x10e419(0x2ab)]('gpt-4')&&(_0x52ed92[_0x10e419(0x2ee)]()['includes'](_0x10e419(0x15b))?(_0x5c91d0=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x1d27ac=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x5c91d0=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x1d27ac=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x52ed92[_0x10e419(0x2ee)]()['includes'](_0x10e419(0x248))&&(_0x52ed92[_0x10e419(0x2ee)]()['includes'](_0x10e419(0x27e))?(_0x5c91d0=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x1d27ac=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x5c91d0=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x1d27ac=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x262c57=_0x2d0edf||openaiBaseUrl||_0x10e419(0x22c),_0x1d27ac>=_0x5c91d0&&(_0x1d27ac=Math[_0x10e419(0x26a)](_0x5c91d0/0x2),common_1[_0x10e419(0x1f4)][_0x10e419(0x1c7)](_0x10e419(0x2a6)+_0x448efa+_0x10e419(0x24a)+_0x1d27ac)),{'key':_0x448efa,'model':_0x52ed92,'maxToken':_0x5c91d0,'maxTokenRes':_0x1d27ac,'proxyUrl':_0x262c57};}async[_0x25df75(0x282)](_0x51060f){const _0x22258d=_0x25df75;try{const _0xda79ac=await this['pptService']['pptResult'](_0x51060f),_0x2ac8e5=await this[_0x22258d(0x12d)][_0x22258d(0x193)]({'where':{'yooTaskId':_0x51060f[_0x22258d(0x23d)]['id']}});if(!_0x2ac8e5)throw new Error(_0x22258d(0x230));_0x2ac8e5['status']=_0xda79ac['data'][_0x22258d(0x1d7)],_0x2ac8e5[_0x22258d(0x2c6)]=_0xda79ac[_0x22258d(0x2e3)][_0x22258d(0x2e8)],_0x2ac8e5['progress']=_0xda79ac[_0x22258d(0x2e3)]['progress'],_0x2ac8e5[_0x22258d(0x279)]=_0xda79ac[_0x22258d(0x2e3)][_0x22258d(0x20a)],_0x2ac8e5['pageCount']=_0xda79ac[_0x22258d(0x2e3)][_0x22258d(0x284)],_0x2ac8e5[_0x22258d(0x1f7)]=_0xda79ac[_0x22258d(0x2e3)]['pptx_url'],_0x2ac8e5[_0x22258d(0x263)]=_0xda79ac[_0x22258d(0x2e3)][_0x22258d(0x270)],_0x2ac8e5[_0x22258d(0x2c8)]=_0xda79ac[_0x22258d(0x2e3)][_0x22258d(0x280)],_0x2ac8e5['endTime']=_0xda79ac['data'][_0x22258d(0x255)],await this[_0x22258d(0x12d)][_0x22258d(0x281)](_0x2ac8e5),_0xda79ac[_0x22258d(0x2e3)]['status']===0x1&&setTimeout(()=>this['asyncPPTProgress'](_0x51060f),0xbb8);}catch(_0x39f0fc){common_1[_0x22258d(0x1f4)][_0x22258d(0x27d)](_0x39f0fc['message'],_0x22258d(0x2db));}}async[_0x25df75(0x173)](_0x300ed1,_0x2ae99a){const _0x1fbd25=_0x25df75;try{return this[_0x1fbd25(0x191)][_0x1fbd25(0x162)](async()=>{const _0xde3860=_0x1fbd25,_0x531e19=await this['modelsService'][_0xde3860(0x18e)](model_constant_1[_0xde3860(0x1e4)][_0xde3860(0x205)]);let _0x4a3024={'userId':_0x300ed1[_0xde3860(0x2b5)]['id'],'type':ppt_constant_1[_0xde3860(0x171)][_0xde3860(0x15e)],'title':_0x2ae99a[_0xde3860(0x1ee)],'text':_0x2ae99a[_0xde3860(0x29f)],'theme':_0x2ae99a['theme']};_0x4a3024=await this['pptTaskEntity'][_0xde3860(0x281)](_0x4a3024),await this[_0xde3860(0x25a)][_0xde3860(0x2d5)](_0x300ed1['user']['id'],_0x4a3024['id'],_0x4a3024['type']);const _0x3d1d58=await this[_0xde3860(0x15a)][_0xde3860(0x173)]({'data':_0x2ae99a,'baseURL':_0x531e19['modelInfo'][_0xde3860(0x16c)],'headers':{'AccessToken':_0x531e19[_0xde3860(0x217)][_0xde3860(0x2de)],'AccessSecret':_0x531e19[_0xde3860(0x217)][_0xde3860(0x24e)]}});return _0x4a3024[_0xde3860(0x1ee)]=_0x3d1d58[_0xde3860(0x2e3)]['title'],_0x4a3024[_0xde3860(0x192)]=_0x3d1d58[_0xde3860(0x2e3)]['catalogs'],await this['pptTaskEntity'][_0xde3860(0x281)](_0x4a3024),_0x4a3024;});}catch(_0x44696e){throw new common_1[(_0x1fbd25(0x2e6))](_0x44696e[_0x1fbd25(0x23a)],common_1['HttpStatus']['BAD_REQUEST']);}}[_0x25df75(0x147)](_0x426ff7,_0x4b25ef){const _0x5476f4=_0x25df75;try{return this[_0x5476f4(0x191)][_0x5476f4(0x162)](async()=>{const _0x3c8ee9=_0x5476f4,_0x5f4967=await this['modelsService'][_0x3c8ee9(0x18e)](model_constant_1[_0x3c8ee9(0x1e4)][_0x3c8ee9(0x205)]);let _0x595a8c={'userId':_0x426ff7[_0x3c8ee9(0x2b5)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x3c8ee9(0x2a0)],'title':_0x4b25ef[_0x3c8ee9(0x1ee)],'text':_0x4b25ef['text'],'author':_0x4b25ef[_0x3c8ee9(0x2d6)],'color':_0x4b25ef[_0x3c8ee9(0x2bd)],'style':_0x4b25ef[_0x3c8ee9(0x25f)]};_0x595a8c=await this['pptTaskEntity']['save'](_0x595a8c),await this[_0x3c8ee9(0x25a)][_0x3c8ee9(0x2d5)](_0x426ff7[_0x3c8ee9(0x2b5)]['id'],_0x595a8c['id'],_0x595a8c['type']);const _0x4ae097=await this[_0x3c8ee9(0x15a)][_0x3c8ee9(0x147)]({'data':{'title':_0x4b25ef[_0x3c8ee9(0x1ee)],'count':_0x4b25ef[_0x3c8ee9(0x29f)],'user_name':_0x4b25ef[_0x3c8ee9(0x2d6)],'color':_0x4b25ef[_0x3c8ee9(0x2bd)],'style':_0x4b25ef['style']},'baseURL':_0x5f4967['modelInfo'][_0x3c8ee9(0x16c)],'headers':{'AccessToken':_0x5f4967['modelInfo'][_0x3c8ee9(0x2de)],'AccessSecret':_0x5f4967[_0x3c8ee9(0x217)][_0x3c8ee9(0x24e)]}});return _0x595a8c[_0x3c8ee9(0x25e)]=_0x4ae097[_0x3c8ee9(0x2e3)],await this[_0x3c8ee9(0x12d)][_0x3c8ee9(0x281)](_0x595a8c),_0x595a8c;});}catch(_0x87e85a){throw new common_1['HttpException'](_0x87e85a['message'],common_1[_0x5476f4(0x2b8)][_0x5476f4(0x298)]);}}[_0x25df75(0x1da)](_0x4c80fd,_0x2cd64e){const _0x4dca96=_0x25df75;try{return this[_0x4dca96(0x191)][_0x4dca96(0x162)](async()=>{const _0x19b2d4=_0x4dca96,_0x5f0f41=await this[_0x19b2d4(0x21c)][_0x19b2d4(0x18e)](model_constant_1[_0x19b2d4(0x1e4)][_0x19b2d4(0x205)]);let _0x210d64={'userId':_0x4c80fd[_0x19b2d4(0x2b5)]['id'],'type':ppt_constant_1[_0x19b2d4(0x171)][_0x19b2d4(0x1f6)],'title':_0x2cd64e[_0x19b2d4(0x1ee)],'text':_0x2cd64e[_0x19b2d4(0x29f)],'author':_0x2cd64e['author'],'coverId':_0x2cd64e[_0x19b2d4(0x169)]};_0x210d64=await this['pptTaskEntity'][_0x19b2d4(0x281)](_0x210d64),await this['userService'][_0x19b2d4(0x2d5)](_0x4c80fd[_0x19b2d4(0x2b5)]['id'],_0x210d64['id'],_0x210d64[_0x19b2d4(0x17d)]);const _0x4d2a01=await this[_0x19b2d4(0x15a)][_0x19b2d4(0x1da)]({'data':{'title':_0x2cd64e['title'],'count':_0x2cd64e[_0x19b2d4(0x29f)],'user_name':_0x2cd64e[_0x19b2d4(0x2d6)],'cover_id':_0x2cd64e[_0x19b2d4(0x169)]},'baseURL':_0x5f0f41['modelInfo'][_0x19b2d4(0x16c)],'headers':{'AccessToken':_0x5f0f41[_0x19b2d4(0x217)]['accessToken'],'AccessSecret':_0x5f0f41[_0x19b2d4(0x217)][_0x19b2d4(0x24e)]}});return _0x210d64[_0x19b2d4(0x25e)]=_0x4d2a01[_0x19b2d4(0x2e3)],await this[_0x19b2d4(0x12d)][_0x19b2d4(0x281)](_0x210d64),_0x210d64;});}catch(_0x514253){throw new common_1[(_0x4dca96(0x2e6))](_0x514253[_0x4dca96(0x23a)],common_1[_0x4dca96(0x2b8)][_0x4dca96(0x298)]);}}['pptCreate'](_0x89c1f1,_0x5833d4){const _0x52ed97=_0x25df75;try{return this[_0x52ed97(0x191)][_0x52ed97(0x162)](async()=>{const _0x724dce=_0x52ed97;let _0x434396;const _0x4657e3=await this[_0x724dce(0x21c)]['getModelByType'](model_constant_1['EModelType'][_0x724dce(0x205)]);if(_0x5833d4[_0x724dce(0x135)]){_0x434396=await this[_0x724dce(0x12d)][_0x724dce(0x193)]({'where':{'id':_0x5833d4['originTaskId']}});if(!_0x434396)throw new Error(_0x724dce(0x24d));}let _0x18f3ca={'userId':_0x89c1f1[_0x724dce(0x2b5)]['id'],'type':ppt_constant_1['EPPTTaskType']['CREATE'],'title':_0x5833d4[_0x724dce(0x1ee)],'subTitle':_0x5833d4[_0x724dce(0x18d)],'text':_0x5833d4[_0x724dce(0x29f)],'catalogs':_0x5833d4[_0x724dce(0x192)],'contents':_0x5833d4['contents'],'author':_0x5833d4['author'],'fontName':_0x5833d4[_0x724dce(0x134)],'transition':_0x5833d4[_0x724dce(0x216)],'complex':_0x5833d4['complex'],'coverId':_0x5833d4['coverId'],'originId':_0x5833d4[_0x724dce(0x135)]};_0x18f3ca=await this[_0x724dce(0x12d)]['save'](_0x18f3ca),await this[_0x724dce(0x25a)]['debuctBalance4PPT'](_0x89c1f1['user']['id'],_0x18f3ca['id'],_0x18f3ca[_0x724dce(0x17d)]);const _0x7fc799=await this[_0x724dce(0x15a)]['pptCreate']({'data':{'text':_0x5833d4[_0x724dce(0x29f)],'custom_data':{'title':_0x5833d4[_0x724dce(0x1ee)],'sub_title':_0x5833d4[_0x724dce(0x18d)],'author':_0x5833d4[_0x724dce(0x2d6)],'catalogs':_0x5833d4[_0x724dce(0x192)],'contents':_0x5833d4[_0x724dce(0x271)]},'cover_id':_0x5833d4['coverId'],'font_name':_0x5833d4[_0x724dce(0x134)],'transition':_0x5833d4[_0x724dce(0x216)],'complex':_0x5833d4[_0x724dce(0x1ff)],'user_name':_0x5833d4['author'],'id':_0x434396[_0x724dce(0x2e5)]},'baseURL':_0x4657e3['modelInfo']['proxyUrl'],'headers':{'AccessToken':_0x4657e3[_0x724dce(0x217)][_0x724dce(0x2de)],'AccessSecret':_0x4657e3['modelInfo'][_0x724dce(0x24e)]}});return _0x18f3ca[_0x724dce(0x2e5)]=_0x7fc799[_0x724dce(0x2e3)]['id'],await this[_0x724dce(0x12d)][_0x724dce(0x281)](_0x18f3ca),setTimeout(()=>this[_0x724dce(0x282)]({'baseURL':_0x4657e3['modelInfo'][_0x724dce(0x16c)],'headers':{'AccessToken':_0x4657e3[_0x724dce(0x217)][_0x724dce(0x2de)],'AccessSecret':_0x4657e3[_0x724dce(0x217)][_0x724dce(0x24e)]},'params':{'id':_0x18f3ca[_0x724dce(0x2e5)]}}),0xbb8),_0x18f3ca;});}catch(_0x1c8a6d){throw new common_1[(_0x52ed97(0x2e6))](_0x1c8a6d[_0x52ed97(0x23a)],common_1[_0x52ed97(0x2b8)]['BAD_REQUEST']);}}['pptCreateThesis'](_0x5e18cc,_0x49e841){const _0x450e32=_0x25df75;try{return this[_0x450e32(0x191)][_0x450e32(0x162)](async()=>{const _0x595332=_0x450e32,_0x58e508=await this['modelsService'][_0x595332(0x18e)](model_constant_1[_0x595332(0x1e4)]['PPT']);let _0xb1217={'userId':_0x5e18cc[_0x595332(0x2b5)]['id'],'type':ppt_constant_1['EPPTTaskType']['THESIS'],'title':_0x49e841['title'],'color':_0x49e841[_0x595332(0x2bd)],'style':_0x49e841[_0x595332(0x25f)],'fileUrl':_0x49e841[_0x595332(0x150)],'pleader':_0x49e841[_0x595332(0x256)],'advisor':_0x49e841['advisor'],'school':_0x49e841['school'],'schoolLogo':_0x49e841[_0x595332(0x1ec)],'schoolPicture':_0x49e841[_0x595332(0x2ad)]};_0xb1217=await this[_0x595332(0x12d)][_0x595332(0x281)](_0xb1217),await this[_0x595332(0x25a)]['debuctBalance4PPT'](_0x5e18cc[_0x595332(0x2b5)]['id'],_0xb1217['id'],_0xb1217[_0x595332(0x17d)]);const _0x15d28f=await this['pptService'][_0x595332(0x233)]({'data':{'file_key':_0x49e841[_0x595332(0x150)],'title':_0x49e841[_0x595332(0x1ee)],'color':_0x49e841[_0x595332(0x2bd)],'style':_0x49e841[_0x595332(0x25f)],'pleader':_0x49e841[_0x595332(0x256)],'advisor':_0x49e841['advisor'],'school':_0x49e841[_0x595332(0x2e9)],'school_logo':_0x49e841[_0x595332(0x1ec)],'school_picture':_0x49e841[_0x595332(0x2ad)]},'baseURL':_0x58e508['modelInfo'][_0x595332(0x16c)],'headers':{'AccessToken':_0x58e508[_0x595332(0x217)]['accessToken'],'AccessSecret':_0x58e508[_0x595332(0x217)][_0x595332(0x24e)]}});return _0xb1217[_0x595332(0x2e5)]=_0x15d28f[_0x595332(0x2e3)]['id'],await this[_0x595332(0x12d)][_0x595332(0x281)](_0xb1217),setTimeout(()=>this[_0x595332(0x282)]({'baseURL':_0x58e508[_0x595332(0x217)][_0x595332(0x16c)],'headers':{'AccessToken':_0x58e508[_0x595332(0x217)][_0x595332(0x2de)],'AccessSecret':_0x58e508['modelInfo']['secret']},'params':{'id':_0xb1217[_0x595332(0x2e5)]}}),0xbb8),_0xb1217;});}catch(_0x2de558){throw new common_1[(_0x450e32(0x2e6))](_0x2de558[_0x450e32(0x23a)],common_1['HttpStatus']['BAD_REQUEST']);}}[_0x25df75(0x219)](_0x425a95,_0xcb174e){const _0x5b9f64=_0x25df75;try{return this['connection']['transaction'](async()=>{const _0x37129e=_0x1f8d,_0x1cc5bb=await this[_0x37129e(0x21c)]['getModelByType'](model_constant_1[_0x37129e(0x1e4)][_0x37129e(0x205)]);let _0x57aae2={'userId':_0x425a95[_0x37129e(0x2b5)]['id'],'type':ppt_constant_1[_0x37129e(0x171)][_0x37129e(0x204)],'fileUrl':_0xcb174e[_0x37129e(0x150)],'coverId':_0xcb174e[_0x37129e(0x169)],'author':_0xcb174e[_0x37129e(0x2d6)]};_0x57aae2=await this[_0x37129e(0x12d)][_0x37129e(0x281)](_0x57aae2),await this[_0x37129e(0x25a)][_0x37129e(0x2d5)](_0x425a95[_0x37129e(0x2b5)]['id'],_0x57aae2['id'],_0x57aae2[_0x37129e(0x17d)]);const _0x38c449=await this['pptService'][_0x37129e(0x219)]({'data':{'file_url':_0xcb174e[_0x37129e(0x150)],'cover_id':_0xcb174e[_0x37129e(0x169)],'user_name':_0xcb174e['author']},'baseURL':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x16c)],'headers':{'AccessToken':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x2de)],'AccessSecret':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x24e)]}});return _0x57aae2[_0x37129e(0x2e5)]=_0x38c449[_0x37129e(0x2e3)]['id'],await this[_0x37129e(0x12d)][_0x37129e(0x281)](_0x57aae2),setTimeout(()=>this[_0x37129e(0x282)]({'baseURL':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x16c)],'headers':{'AccessToken':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x2de)],'AccessSecret':_0x1cc5bb[_0x37129e(0x217)][_0x37129e(0x24e)]},'params':{'id':_0x57aae2[_0x37129e(0x2e5)]}}),0xbb8),_0x57aae2;});}catch(_0x3e16ee){throw new common_1[(_0x5b9f64(0x2e6))](_0x3e16ee[_0x5b9f64(0x23a)],common_1[_0x5b9f64(0x2b8)][_0x5b9f64(0x298)]);}}['pptDetail'](_0x1d98a2){const _0x4da46b=_0x25df75;return this[_0x4da46b(0x12d)][_0x4da46b(0x193)]({'where':{'id':_0x1d98a2}});}[_0x25df75(0x189)](_0x37470e,_0x5e8154){const _0x715ae4=_0x25df75;try{return this[_0x715ae4(0x191)][_0x715ae4(0x162)](async()=>{const _0xb4c0c1=_0x715ae4,_0x4fee48=await this[_0xb4c0c1(0x12d)][_0xb4c0c1(0x193)]({'where':{'id':_0x5e8154[_0xb4c0c1(0x135)]}});if(!_0x4fee48)throw new Error(_0xb4c0c1(0x24d));const _0x305e57=await this['modelsService'][_0xb4c0c1(0x18e)](model_constant_1[_0xb4c0c1(0x1e4)][_0xb4c0c1(0x205)]);let _0xce0710={'userId':_0x37470e[_0xb4c0c1(0x2b5)]['id'],'type':ppt_constant_1[_0xb4c0c1(0x171)][_0xb4c0c1(0x1b5)],'originId':_0x5e8154[_0xb4c0c1(0x135)],'coverId':_0x5e8154[_0xb4c0c1(0x169)],'fontName':_0x5e8154[_0xb4c0c1(0x134)],'transition':_0x5e8154['transition']};_0xce0710=await this[_0xb4c0c1(0x12d)][_0xb4c0c1(0x281)](_0xce0710),await this[_0xb4c0c1(0x25a)][_0xb4c0c1(0x2d5)](_0x37470e[_0xb4c0c1(0x2b5)]['id'],_0xce0710['id'],_0xce0710[_0xb4c0c1(0x17d)]);const _0x368ffb=await this[_0xb4c0c1(0x15a)][_0xb4c0c1(0x189)]({'data':{'id':_0x4fee48[_0xb4c0c1(0x2e5)],'cover_id':_0x5e8154[_0xb4c0c1(0x169)],'font_name':_0x5e8154['fontName'],'transition':_0x5e8154['transition']},'baseURL':_0x305e57[_0xb4c0c1(0x217)][_0xb4c0c1(0x16c)],'headers':{'AccessToken':_0x305e57[_0xb4c0c1(0x217)][_0xb4c0c1(0x2de)],'AccessSecret':_0x305e57[_0xb4c0c1(0x217)][_0xb4c0c1(0x24e)]}});return _0xce0710[_0xb4c0c1(0x2e5)]=_0x368ffb[_0xb4c0c1(0x2e3)]['id'],await this[_0xb4c0c1(0x12d)][_0xb4c0c1(0x281)](_0xce0710),setTimeout(()=>this[_0xb4c0c1(0x282)]({'baseURL':_0x305e57[_0xb4c0c1(0x217)][_0xb4c0c1(0x16c)],'headers':{'AccessToken':_0x305e57[_0xb4c0c1(0x217)]['accessToken'],'AccessSecret':_0x305e57[_0xb4c0c1(0x217)][_0xb4c0c1(0x24e)]},'params':{'id':_0xce0710['yooTaskId']}}),0xbb8),_0xce0710;});}catch(_0x3201b3){throw new common_1[(_0x715ae4(0x2e6))](_0x3201b3['message'],common_1['HttpStatus'][_0x715ae4(0x298)]);}}[_0x25df75(0x1b0)](_0x45344c,_0x4e7298){const _0x35b2cb=_0x25df75;try{return this['connection'][_0x35b2cb(0x162)](async()=>{const _0x4d97e6=_0x35b2cb,_0x7cb56c=await this[_0x4d97e6(0x12d)][_0x4d97e6(0x193)]({'where':{'id':_0x4e7298[_0x4d97e6(0x135)]}});if(!_0x7cb56c)throw new Error(_0x4d97e6(0x24d));const _0x5aaff6=await this[_0x4d97e6(0x21c)]['getModelByType'](model_constant_1[_0x4d97e6(0x1e4)][_0x4d97e6(0x205)]);let _0x39bf23={'userId':_0x45344c[_0x4d97e6(0x2b5)]['id'],'type':ppt_constant_1[_0x4d97e6(0x171)][_0x4d97e6(0x1a5)],'originId':_0x4e7298[_0x4d97e6(0x135)],'theme':_0x4e7298[_0x4d97e6(0x180)],'text':_0x4e7298[_0x4d97e6(0x29f)],'complex':_0x4e7298[_0x4d97e6(0x1ff)]?String(_0x4e7298['complex']):'1','author':_0x4e7298[_0x4d97e6(0x2d6)],'fontName':_0x4e7298[_0x4d97e6(0x134)],'transition':_0x4e7298[_0x4d97e6(0x216)],'slideNumber':_0x4e7298[_0x4d97e6(0x250)],'slideType':_0x4e7298[_0x4d97e6(0x2ea)]};_0x39bf23=await this[_0x4d97e6(0x12d)][_0x4d97e6(0x281)](_0x39bf23),await this[_0x4d97e6(0x25a)][_0x4d97e6(0x2d5)](_0x45344c[_0x4d97e6(0x2b5)]['id'],_0x39bf23['id'],_0x39bf23[_0x4d97e6(0x17d)]);const _0x1ec256=await this['pptService'][_0x4d97e6(0x1b0)]({'data':{'id':_0x7cb56c[_0x4d97e6(0x2e5)],'text':_0x4e7298['text'],'complex':_0x4e7298[_0x4d97e6(0x1ff)],'user_name':_0x4e7298[_0x4d97e6(0x2d6)],'font_name':_0x4e7298['fontName'],'transition':_0x4e7298['transition'],'slide_number':_0x4e7298[_0x4d97e6(0x250)],'slide_type':_0x4e7298[_0x4d97e6(0x2ea)],'theme':_0x4e7298[_0x4d97e6(0x180)]},'baseURL':_0x5aaff6[_0x4d97e6(0x217)][_0x4d97e6(0x16c)],'headers':{'AccessToken':_0x5aaff6[_0x4d97e6(0x217)][_0x4d97e6(0x2de)],'AccessSecret':_0x5aaff6['modelInfo']['secret']}});return _0x39bf23[_0x4d97e6(0x2e5)]=_0x1ec256['data']['id'],await this[_0x4d97e6(0x12d)][_0x4d97e6(0x281)](_0x39bf23),setTimeout(()=>this[_0x4d97e6(0x282)]({'baseURL':_0x5aaff6[_0x4d97e6(0x217)]['proxyUrl'],'headers':{'AccessToken':_0x5aaff6[_0x4d97e6(0x217)][_0x4d97e6(0x2de)],'AccessSecret':_0x5aaff6[_0x4d97e6(0x217)][_0x4d97e6(0x24e)]},'params':{'id':_0x39bf23['yooTaskId']}}),0xbb8),_0x39bf23;});}catch(_0x66310c){throw new common_1[(_0x35b2cb(0x2e6))](_0x66310c[_0x35b2cb(0x23a)],common_1[_0x35b2cb(0x2b8)][_0x35b2cb(0x298)]);}}[_0x25df75(0x228)](_0x5b719e,_0x729fb8){const _0x1b1ff7=_0x25df75;try{return this[_0x1b1ff7(0x191)][_0x1b1ff7(0x162)](async()=>{const _0x3cc534=_0x1b1ff7,_0x1696e0=await this[_0x3cc534(0x12d)][_0x3cc534(0x193)]({'where':{'id':_0x729fb8['originTaskId']}});if(!_0x1696e0)throw new Error(_0x3cc534(0x24d));const _0x32748d=await this[_0x3cc534(0x21c)][_0x3cc534(0x18e)](model_constant_1[_0x3cc534(0x1e4)][_0x3cc534(0x205)]);let _0x4be609={'userId':_0x5b719e[_0x3cc534(0x2b5)]['id'],'type':ppt_constant_1[_0x3cc534(0x171)][_0x3cc534(0x207)],'originId':_0x729fb8[_0x3cc534(0x135)],'notes':_0x729fb8};_0x4be609=await this[_0x3cc534(0x12d)][_0x3cc534(0x281)](_0x4be609),await this[_0x3cc534(0x25a)]['debuctBalance4PPT'](_0x5b719e[_0x3cc534(0x2b5)]['id'],_0x4be609['id'],_0x4be609['type']);const _0x350493=await this[_0x3cc534(0x15a)][_0x3cc534(0x27a)]({'data':{..._0x729fb8,'id':_0x1696e0['yooTaskId']},'baseURL':_0x32748d[_0x3cc534(0x217)][_0x3cc534(0x16c)],'headers':{'AccessToken':_0x32748d[_0x3cc534(0x217)][_0x3cc534(0x2de)],'AccessSecret':_0x32748d['modelInfo']['secret']}});return _0x4be609[_0x3cc534(0x2e5)]=_0x350493[_0x3cc534(0x2e3)]['id'],await this[_0x3cc534(0x12d)][_0x3cc534(0x281)](_0x4be609),setTimeout(()=>this[_0x3cc534(0x282)]({'baseURL':_0x32748d[_0x3cc534(0x217)]['proxyUrl'],'headers':{'AccessToken':_0x32748d[_0x3cc534(0x217)]['accessToken'],'AccessSecret':_0x32748d[_0x3cc534(0x217)][_0x3cc534(0x24e)]},'params':{'id':_0x4be609['yooTaskId']}}),0xbb8),_0x4be609;});}catch(_0x133b13){throw new common_1['HttpException'](_0x133b13[_0x1b1ff7(0x23a)],common_1[_0x1b1ff7(0x2b8)]['BAD_REQUEST']);}}async[_0x25df75(0x29c)](_0x129ccd,_0x43ede3){const _0x369017=_0x25df75,_0x210708=_0x43ede3[_0x369017(0x2b5)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x4d77fb,userKeyword:_0x101f89}=_0x129ccd,_0x272bc8='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4d77fb?'\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%'+_0x4d77fb+_0x369017(0x210)+_0x4d77fb+_0x369017(0x139):'')+_0x369017(0x2aa)+(_0x101f89?_0x369017(0x15f)+_0x101f89+_0x369017(0x240)+_0x101f89+'%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.phone\x20LIKE\x20(\x27%'+_0x101f89+_0x369017(0x174)+_0x101f89+_0x369017(0x264):'')+_0x369017(0x2aa)+(_0x210708?_0x369017(0x2c2)+_0x210708:'')+_0x369017(0x1b1),_0x42ec93=await this[_0x369017(0x191)][_0x369017(0x26c)](_0x369017(0x2ef)+_0x272bc8+'\x0a\x20\x20\x20\x20\x20\x20'),_0x4604b8=await this[_0x369017(0x191)]['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x272bc8+_0x369017(0x2a2)+size+_0x369017(0x1aa)+(page-0x1)*size+_0x369017(0x1b1));return!(0x0,utils_1[_0x369017(0x18c)])(this[_0x369017(0x187)])&&_0x4604b8['forEach'](_0x20b85c=>{const _0x444428=_0x369017;_0x20b85c[_0x444428(0x195)]=(0x0,utils_1[_0x444428(0x2d1)])(_0x20b85c[_0x444428(0x195)]),_0x20b85c[_0x444428(0x136)]=(0x0,utils_1[_0x444428(0x2d1)])(_0x20b85c['phone']);}),{'rows':_0x4604b8,'count':Number(_0x42ec93[0x0]?.['count']||0x0)};}async[_0x25df75(0x235)](_0x37de75,_0x14a5a2){const _0x11dcf1=_0x25df75;if(!_0x37de75['ids']||!_0x37de75[_0x11dcf1(0x220)][_0x11dcf1(0x20b)])return!![];const _0x3ad8ca={'id':(0x0,typeorm_1['In'])(_0x37de75['ids'])};return _0x14a5a2&&(_0x3ad8ca[_0x11dcf1(0x1d1)]=_0x14a5a2),await this[_0x11dcf1(0x12d)][_0x11dcf1(0x158)](_0x3ad8ca,{'delFlag':0x1}),!![];}async[_0x25df75(0x1fa)](_0x1385cd,_0x58ba3f){const _0x200ebd=_0x25df75;try{let _0x11dd21='';return await this[_0x200ebd(0x191)][_0x200ebd(0x162)](async()=>{const _0x3c4b86=_0x200ebd,_0x1e6c28=(0x0,utils_1[_0x3c4b86(0x2d7)])(this[_0x3c4b86(0x187)]),{modelInfo:_0x166d84}=await this[_0x3c4b86(0x21c)][_0x3c4b86(0x18e)](model_constant_1[_0x3c4b86(0x1e4)][_0x3c4b86(0x2d4)],_0x3c4b86(0x1cd));await this[_0x3c4b86(0x14e)]({'prompt':_0x58ba3f['request'][_0x3c4b86(0x29f)],'user':_0x1385cd[_0x3c4b86(0x2b5)],'currentRequestModel':_0x166d84});const _0x323393={'curIp':(0x0,utils_1['getClientIp'])(_0x1385cd),'prompt':_0x58ba3f[_0x3c4b86(0x199)][_0x3c4b86(0x29f)],'modelId':_0x166d84['id'],'modelType':_0x166d84[_0x3c4b86(0x1fe)],'answer':'','model':_0x166d84[_0x3c4b86(0x1c1)],'role':_0x3c4b86(0x2b5),'userId':_0x1385cd['user']['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x3c4b86(0x168)][_0x3c4b86(0x239)],'logType':0x1,'requestOptions':JSON[_0x3c4b86(0x2a5)](_0x58ba3f),'saasId':_0x1e6c28},_0x2e151e={..._0x323393,'role':_0x3c4b86(0x13d),'requestOptions':JSON['stringify']({'prompt':_0x58ba3f['request']['text'],'options':{'model':_0x166d84[_0x3c4b86(0x1c1)]}})};await this[_0x3c4b86(0x277)][_0x3c4b86(0x1a9)](_0x323393),await this[_0x3c4b86(0x277)][_0x3c4b86(0x1a9)](_0x2e151e),await this[_0x3c4b86(0x25a)][_0x3c4b86(0x1c2)](_0x1385cd[_0x3c4b86(0x2b5)]['id'],_0x166d84,_0x2e151e['id']);const _0x140096={'app':{'appid':_0x166d84[_0x3c4b86(0x257)],'token':_0x166d84['appid'],'cluster':_0x3c4b86(0x21f)},'user':{'uid':String(_0x1385cd['user']['id'])},'audio':{'voice_type':'BV700_streaming','encoding':_0x3c4b86(0x1a6)},'request':{'reqid':(0x0,crypto_1[_0x3c4b86(0x153)])(),'text':_0x58ba3f[_0x3c4b86(0x199)][_0x3c4b86(0x29f)],'operation':_0x3c4b86(0x26c)}},_0x50d573=await this[_0x3c4b86(0x2d2)][_0x3c4b86(0x1fa)]({'data':_0x140096,'headers':{'Authorization':_0x3c4b86(0x1e8)+_0x166d84[_0x3c4b86(0x2de)]}}),_0x266e1c=chat_constant_1[_0x3c4b86(0x190)][_0x3c4b86(0x2d4)]+'-'+_0x1e6c28+'-'+_0x1385cd['user']['id']+'-'+new Date()[_0x3c4b86(0x206)]()+_0x3c4b86(0x13e);let _0x470478=(0x0,path_1['join'])(process['cwd'](),_0x3c4b86(0x1a3),_0x3c4b86(0x1bd)),_0x193249=_0x3c4b86(0x20c);_0x193249=_0x193249+'/'+_0x266e1c;!(0x0,fs_1[_0x3c4b86(0x18b)])(_0x470478)&&(0x0,fs_1['mkdirSync'])(_0x470478,{'recursive':!![]});_0x470478=(0x0,path_1[_0x3c4b86(0x2b1)])(_0x470478,_0x266e1c),(0x0,fs_1[_0x3c4b86(0x1f0)])(_0x470478,_0x50d573['data'],_0x3c4b86(0x21d));let _0x50e9ec=process[_0x3c4b86(0x161)][_0x3c4b86(0x2eb)];_0x50e9ec[_0x3c4b86(0x275)]('http')?_0x11dd21=_0x50e9ec+_0x193249:_0x11dd21='https://'+_0x50e9ec+_0x193249,_0x2e151e[_0x3c4b86(0x197)]=_0x11dd21,await this[_0x3c4b86(0x277)][_0x3c4b86(0x1a9)](_0x2e151e);}),_0x11dd21;}catch(_0xfd19b7){throw new common_1['HttpException'](_0xfd19b7[_0x200ebd(0x23a)],common_1[_0x200ebd(0x2b8)]['BAD_REQUEST']);}}async[_0x25df75(0x2c5)](_0x551d5d,_0x56ded9,_0x322519){const _0x2c809c=_0x25df75;try{let _0x4a3178,_0xb34f31;return await this[_0x2c809c(0x191)][_0x2c809c(0x162)](async()=>{const _0x2c11de=_0x2c809c,_0x54b6d7=(0x0,utils_1[_0x2c11de(0x2d7)])(this[_0x2c11de(0x187)]),{modelInfo:_0x2ae401}=await this['modelsService']['getModelByType'](model_constant_1['EModelType'][_0x2c11de(0x1ca)],_0x2c11de(0x296));await this['userService'][_0x2c11de(0x2ca)](_0x551d5d['user']['id'],_0x2ae401);const _0x2bf76c={'groupId':_0x322519,'curIp':(0x0,utils_1[_0x2c11de(0x1e1)])(_0x551d5d),'prompt':_0x56ded9,'modelId':_0x2ae401['id'],'modelType':_0x2ae401['modelType'],'answer':'','model':_0x2ae401[_0x2c11de(0x1c1)],'role':_0x2c11de(0x2b5),'userId':_0x551d5d[_0x2c11de(0x2b5)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1['DeductionKey'][_0x2c11de(0x239)],'logType':0x1,'requestOptions':JSON[_0x2c11de(0x2a5)]({'url':_0x56ded9}),'saasId':_0x54b6d7},_0x29eccc={..._0x2bf76c,'role':_0x2c11de(0x13d),'requestOptions':JSON['stringify']({'prompt':_0x56ded9,'options':{'model':_0x2ae401[_0x2c11de(0x1c1)]}})};await this[_0x2c11de(0x277)][_0x2c11de(0x1a9)](_0x2bf76c),await this['chatLogService'][_0x2c11de(0x1a9)](_0x29eccc),await this['userService'][_0x2c11de(0x1c2)](_0x551d5d['user']['id'],_0x2ae401,_0x29eccc['id']);let _0x2e0a59=process[_0x2c11de(0x161)][_0x2c11de(0x2eb)];!/^http/['test'](_0x2e0a59)&&(_0x2e0a59=_0x2c11de(0x1d9)+_0x2e0a59);const _0x1128be={'app':{'appid':_0x2ae401[_0x2c11de(0x257)],'token':_0x2ae401[_0x2c11de(0x257)],'cluster':'volc_auc_common'},'user':{'uid':String(_0x551d5d[_0x2c11de(0x2b5)]['id'])},'audio':{'url':_0x56ded9,'format':_0x56ded9['split']('.')['pop']()},'request':{'callback':_0x2e0a59+_0x2c11de(0x29e)}},_0x2e045f=await this['doubaoService'][_0x2c11de(0x2c5)]({'data':_0x1128be,'headers':{'Authorization':'Bearer;'+_0x2ae401[_0x2c11de(0x2de)]}});_0x4a3178=_0x2e045f['id'],_0xb34f31=await this[_0x2c11de(0x277)][_0x2c11de(0x1a9)](_0x29eccc);}),new Promise(_0x3664c5=>{const _0x46ea47=_0x2c809c;utils_1['EE'][_0x46ea47(0x1e6)](chat_constant_1[_0x46ea47(0x190)][_0x46ea47(0x1ca)]+'-'+_0x4a3178,async _0x432f6d=>{const _0x28f319=_0x46ea47;_0xb34f31[_0x28f319(0x197)]=_0x432f6d[_0x28f319(0x29f)],_0xb34f31=await this[_0x28f319(0x277)][_0x28f319(0x1a9)](_0xb34f31),_0x3664c5(_0xb34f31);});});}catch(_0x2d420d){throw new common_1[(_0x2c809c(0x2e6))](_0x2d420d[_0x2c809c(0x23a)],common_1[_0x2c809c(0x2b8)][_0x2c809c(0x298)]);}}[_0x25df75(0x12b)](_0x26fead){const _0x2ee26e=_0x25df75;_0x26fead[_0x2ee26e(0x2b9)]===0x3e8&&utils_1['EE'][_0x2ee26e(0x28b)](chat_constant_1[_0x2ee26e(0x190)][_0x2ee26e(0x1ca)]+'-'+_0x26fead['id'],_0x26fead);}async[_0x25df75(0x14a)](_0x4ecc39,_0x29240a,_0x5ad92d,_0x4745c2){const _0xe20cab=_0x25df75;try{const _0x1b1dac=await this[_0xe20cab(0x191)][_0xe20cab(0x162)](async()=>{const _0x3ef6d5=_0xe20cab;let _0x2dd837=new Date()[_0x3ef6d5(0x206)](),_0x4f0d7a=new Date()[_0x3ef6d5(0x206)]();const _0x4bc2e9=_0x4ecc39[_0x3ef6d5(0x2b5)]['id'],_0x28e887=(0x0,utils_1[_0x3ef6d5(0x2d7)])(this[_0x3ef6d5(0x187)]),_0x50d455=chat_constant_1['EChatType'][_0x3ef6d5(0x1ca)]+'-'+_0x28e887+'-'+_0x4bc2e9+'-'+new Date()[_0x3ef6d5(0x206)]()+'.mp3',_0x54bacd=await this['fileService'][_0x3ef6d5(0x22e)]({'filename':_0x50d455,'buffer':_0x4745c2['buffer']});_0x4f0d7a=new Date()[_0x3ef6d5(0x206)](),console['log']('[耗时打印]保存文件耗时：',_0x4f0d7a-_0x2dd837);const _0x2794f0=await this[_0x3ef6d5(0x2c5)](_0x4ecc39,_0x54bacd,_0x5ad92d?.['options']?.['groupId']);_0x2dd837=new Date()['getTime'](),console[_0x3ef6d5(0x254)]('[耗时打印]语音转文字耗时：',_0x2dd837-_0x4f0d7a),_0x5ad92d[_0x3ef6d5(0x2bb)]=_0x2794f0['answer'];typeof _0x5ad92d[_0x3ef6d5(0x245)]===_0x3ef6d5(0x299)&&(_0x5ad92d[_0x3ef6d5(0x245)]=JSON[_0x3ef6d5(0x2a1)](_0x5ad92d[_0x3ef6d5(0x245)]));const _0x30a6a3=await this['chatProcess'](_0x5ad92d,_0x4ecc39,_0x29240a,![]);_0x4f0d7a=new Date()[_0x3ef6d5(0x206)](),console[_0x3ef6d5(0x254)]('[耗时打印]文字对话耗时：',_0x4f0d7a-_0x2dd837);const _0x835168=await this['tts'](_0x4ecc39,{'request':{'text':_0x30a6a3}});return _0x2dd837=new Date()[_0x3ef6d5(0x206)](),console[_0x3ef6d5(0x254)](_0x3ef6d5(0x145),_0x2dd837-_0x4f0d7a),_0x835168;});return _0x1b1dac;}catch(_0x2814b0){throw new common_1[(_0xe20cab(0x2e6))](_0x2814b0[_0xe20cab(0x23a)],common_1[_0xe20cab(0x2b8)]['BAD_REQUEST']);}}};ChatgptService=__decorate([(0x0,common_1[_0x25df75(0x297)])(),__param(0x0,(0x0,typeorm_2[_0x25df75(0x2d3)])(pptTask_entity_1['PPTTaskEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x25df75(0x246)],nestjs_cls_1[_0x25df75(0x278)],user_service_1[_0x25df75(0x27c)],file_service_1[_0x25df75(0x24f)],gpts_service_1[_0x25df75(0x249)],yooPPT_service_1[_0x25df75(0x202)],doubao_service_1[_0x25df75(0x1ea)],models_service_1[_0x25df75(0x276)],chatLog_service_1['ChatLogService'],lumaTask_service_1['LumaTaskService'],badwords_service_1[_0x25df75(0x234)],autoreply_service_1['AutoreplyService'],chatGroup_service_1[_0x25df75(0x2e0)],globalConfig_service_1['GlobalConfigService'],typeorm_1[_0x25df75(0x132)]])],ChatgptService),exports[_0x25df75(0x194)]=ChatgptService;