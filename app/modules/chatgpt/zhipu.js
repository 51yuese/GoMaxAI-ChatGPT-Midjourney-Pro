'use strict';const _0x383798=_0x596a;(function(_0x32ece6,_0xb9baa8){const _0x24be1c=_0x596a,_0x2fff29=_0x32ece6();while(!![]){try{const _0x45874b=-parseInt(_0x24be1c(0x21e))/0x1*(-parseInt(_0x24be1c(0x208))/0x2)+-parseInt(_0x24be1c(0x200))/0x3+-parseInt(_0x24be1c(0x217))/0x4*(-parseInt(_0x24be1c(0x1f2))/0x5)+-parseInt(_0x24be1c(0x201))/0x6+-parseInt(_0x24be1c(0x21d))/0x7+parseInt(_0x24be1c(0x1ef))/0x8+parseInt(_0x24be1c(0x21a))/0x9;if(_0x45874b===_0xb9baa8)break;else _0x2fff29['push'](_0x2fff29['shift']());}catch(_0x591f50){_0x2fff29['push'](_0x2fff29['shift']());}}}(_0x3e65,0xcf676));Object[_0x383798(0x202)](exports,_0x383798(0x20e),{'value':!![]}),exports[_0x383798(0x227)]=exports['sendMessageFromFastgpt']=exports[_0x383798(0x229)]=exports[_0x383798(0x235)]=exports[_0x383798(0x1fd)]=exports[_0x383798(0x1f0)]=void 0x0;const axios=require('axios'),jwt=require('jsonwebtoken');function generateToken(_0x7b31ab,_0x4911e8=0x3e8*0x3c*0x3c*0x18*0x168){const _0x42a19a=_0x383798,[_0x16b1ad,_0x41234e]=_0x7b31ab['split']('.'),_0x492388={'api_key':_0x16b1ad,'exp':Math[_0x42a19a(0x207)](Date[_0x42a19a(0x1fc)]())+_0x4911e8*0x3e8,'timestamp':Math[_0x42a19a(0x207)](Date[_0x42a19a(0x1fc)]())};return jwt[_0x42a19a(0x210)](_0x492388,_0x41234e,{'algorithm':_0x42a19a(0x216),'header':{'alg':_0x42a19a(0x216),'sign_type':_0x42a19a(0x21f)}});}function _0x596a(_0x33277f,_0x54f935){const _0x3e651e=_0x3e65();return _0x596a=function(_0x596a60,_0x120ba2){_0x596a60=_0x596a60-0x1ef;let _0xad5f0b=_0x3e651e[_0x596a60];return _0xad5f0b;},_0x596a(_0x33277f,_0x54f935);}exports[_0x383798(0x1f0)]=generateToken;function compilerMetaJsonStr(_0x579d2c){const _0x2bb505=_0x383798;let _0x14e3a6={};try{_0x14e3a6=JSON[_0x2bb505(0x222)](_0x579d2c);}catch(_0x48ebaa){_0x14e3a6={'usage':{'completion_tokens':0x31,'prompt_tokens':0x14d,'total_tokens':0x18f}},console[_0x2bb505(0x1f7)]('json\x20parse\x20error\x20from\x20zhipu!',_0x579d2c);}return _0x14e3a6;}exports[_0x383798(0x1fd)]=compilerMetaJsonStr;function compilerStream(_0x222d34){const _0x59a430=_0x383798;console[_0x59a430(0x22b)](_0x222d34);if(_0x222d34['length']===0x3)return{'event':_0x222d34[0x0][_0x59a430(0x209)](_0x59a430(0x233),''),'id':_0x222d34[0x1][_0x59a430(0x209)](_0x59a430(0x234),''),'is_end':![],'result':_0x222d34[0x2]['replace'](_0x59a430(0x1f3),'')[_0x59a430(0x226)]()};if(_0x222d34[_0x59a430(0x212)]===0x4)return{'event':_0x222d34[0x0]['replace']('event:',''),'id':_0x222d34[0x1]['replace'](_0x59a430(0x234),''),'result':_0x222d34[0x2][_0x59a430(0x209)](_0x59a430(0x1f3),'')['trim'](),'is_end':!![],'usage':compilerMetaJsonStr(_0x222d34[0x3][_0x59a430(0x209)]('meta:',''))?.['usage']};}exports['compilerStream']=compilerStream;async function sendMessageFromZhipu(_0x5832c7,{onProgress:_0x57ecd3,key:_0x4b8249,model:_0x59e31f,temperature:temperature=0.95}){const _0x41a89b=await generateToken(_0x4b8249);return new Promise((_0x14011b,_0xb90572)=>{const _0x13c560=_0x596a,_0x3fa44b=_0x13c560(0x220),_0x4dc747={'method':_0x13c560(0x22d),'url':_0x3fa44b,'responseType':'stream','headers':{'Content-Type':_0x13c560(0x232),'Authorization':_0x41a89b},'data':{'model':_0x59e31f,'messages':_0x5832c7,'temperature':temperature,'stream':!![]}};axios(_0x4dc747)['then'](_0x7d58a9=>{const _0x18141a=_0x13c560,_0x5b1eda=_0x7d58a9['data'];let _0x5b2fa6,_0x391eca='';_0x5b1eda['on'](_0x18141a(0x205),_0x487d10=>{const _0x55ad8e=_0x18141a,_0x413d11=_0x487d10[_0x55ad8e(0x221)]()[_0x55ad8e(0x1fb)]('\x0a')[_0x55ad8e(0x22c)](_0x54f933=>_0x54f933[_0x55ad8e(0x226)]()!==''),_0x194b8b=_0x413d11;console[_0x55ad8e(0x22b)](_0x194b8b);if(!_0x194b8b)return;let _0x467381=![],_0x2de59b='',_0x4c27c2='',_0x4559c9='',_0x729830=null;_0x194b8b[_0x55ad8e(0x1ff)](_0x2750cb=>{const _0xbb0ed=_0x55ad8e;if(_0x2750cb['indexOf']('[DONE]')>-0x1)_0x467381=!![];else{const _0x22b888=JSON['parse'](_0x2750cb[_0xbb0ed(0x209)](_0xbb0ed(0x203),''));_0x2de59b=_0x22b888['id'],_0x4c27c2=_0x22b888[_0xbb0ed(0x214)],_0x4559c9=_0x22b888[_0xbb0ed(0x211)],_0x22b888[_0xbb0ed(0x218)]&&(_0x729830=_0x22b888[_0xbb0ed(0x218)]),_0x22b888[_0xbb0ed(0x22a)][_0xbb0ed(0x1ff)](_0x4e9a1b=>{const _0x5a78ff=_0xbb0ed;_0x391eca+=_0x4e9a1b[_0x5a78ff(0x1fe)][_0x5a78ff(0x20c)];});}});let _0x4d33f9={'role':'assistant','id':_0x2de59b,'text':_0x391eca,'delta':_0x391eca,'detail':{'choices':[{'delta':{'content':_0x391eca,'role':_0x55ad8e(0x20b)},'index':0x0}],'created':_0x4c27c2,'id':_0x2de59b,'model':_0x4559c9,'object':'chat.completion.chunk','usage':_0x729830}};_0x467381&&(_0x4d33f9[_0x55ad8e(0x206)]=![],_0x5b2fa6=_0x4d33f9,_0x5b2fa6['text']=_0x391eca),_0x57ecd3(_0x4d33f9);}),_0x5b1eda['on'](_0x18141a(0x1f5),()=>{_0x14011b(_0x5b2fa6),_0x391eca='';});})['catch'](_0x59f7fb=>{const _0x5635ac=_0x13c560;console['log'](_0x5635ac(0x1f9),_0x59f7fb);});});}exports[_0x383798(0x229)]=sendMessageFromZhipu;async function sendMessageFromFastgpt(_0x2d2aad,{chatId:_0x287283,onProgress:_0x30a695,key:_0x42dc28,model:_0x396913,apiUrl:_0x21ccd8}){return new Promise((_0x3162f3,_0x405249)=>{const _0x50a417=_0x596a,_0x98cfca=_0x21ccd8+_0x50a417(0x231),_0x2727da={'method':'POST','url':_0x98cfca,'responseType':_0x50a417(0x204),'headers':{'Content-Type':_0x50a417(0x232),'Authorization':_0x50a417(0x1fa)+_0x42dc28},'data':{'model':_0x396913,'detail':![],'messages':_0x2d2aad,'stream':!![]}};axios(_0x2727da)['then'](_0x21cb14=>{const _0x491dd5=_0x50a417,_0x4f2d1b=_0x21cb14['data'];let _0x15bd67='',_0xc407c6=null;_0x4f2d1b['on'](_0x491dd5(0x205),_0x166e6c=>{const _0x4934eb=_0x491dd5;try{const _0x21e25a=_0x166e6c[_0x4934eb(0x221)]()['split']('\x0a')['filter'](_0xcd4af5=>_0xcd4af5[_0x4934eb(0x226)]()[_0x4934eb(0x230)]('data:\x20'));for(const _0x45004f of _0x21e25a){const _0x44a549=_0x45004f[_0x4934eb(0x209)](_0x4934eb(0x203),'')['trim']();if(_0x44a549===_0x4934eb(0x1f6)){_0xc407c6&&(_0xc407c6[_0x4934eb(0x206)]=![],_0xc407c6[_0x4934eb(0x21c)]=_0x15bd67);continue;}const _0x208d68=JSON[_0x4934eb(0x222)](_0x44a549);if(_0x208d68[_0x4934eb(0x22a)]&&_0x208d68[_0x4934eb(0x22a)][_0x4934eb(0x212)]>0x0){const _0x56f8c8=_0x208d68['choices'][0x0],_0x5b4e27=_0x56f8c8[_0x4934eb(0x1fe)][_0x4934eb(0x20c)]||'';_0x15bd67+=_0x5b4e27;const _0x5be4fa={'role':'assistant','id':_0x287283,'text':_0x15bd67,'delta':_0x5b4e27,'detail':{'choices':[{'delta':{'content':_0x5b4e27,'role':'assistant'},'index':0x0}],'created':_0x208d68[_0x4934eb(0x214)],'id':_0x208d68['id']||_0x287283,'model':_0x208d68[_0x4934eb(0x211)],'object':_0x4934eb(0x20d),'usage':_0x208d68['usage']}};_0xc407c6=_0x5be4fa,_0x30a695(_0x5be4fa);}}}catch(_0x471244){console[_0x4934eb(0x1f7)]('Error\x20parsing\x20stream\x20chunk:',_0x471244);}}),_0x4f2d1b['on'](_0x491dd5(0x1f5),()=>{_0x3162f3(_0xc407c6),_0x15bd67='';}),_0x4f2d1b['on'](_0x491dd5(0x1f7),_0x321424=>{const _0x433012=_0x491dd5;console[_0x433012(0x1f7)](_0x433012(0x21b),_0x321424),_0x405249(_0x321424);});})[_0x50a417(0x228)](_0x1eb511=>{const _0xeb140e=_0x50a417;console[_0xeb140e(0x1f7)](_0xeb140e(0x224),_0x1eb511),_0x405249(_0x1eb511);});});}exports[_0x383798(0x20f)]=sendMessageFromFastgpt;async function sendDifyMessage(_0x2a6168){const {chatId:_0x5c68a8,onProgress:_0x33c634,apiKey:_0x23889b,apiUrl:_0x1d838d,query:_0x5b17b7,inputs:inputs={},userId:userId='user'}=_0x2a6168;return new Promise((_0x414b4e,_0x2c2457)=>{const _0x22dc77=_0x596a,_0xa8c008=_0x1d838d+_0x22dc77(0x213),_0x18bcfe=JSON[_0x22dc77(0x20a)]({'inputs':inputs,'query':_0x5b17b7,'response_mode':_0x22dc77(0x1f4),'user':userId,..._0x5c68a8?{'conversation_id':_0x5c68a8}:{},'auto_generate_name':!![]}),_0x362131={'method':'POST','url':_0xa8c008,'responseType':'stream','headers':{'Authorization':_0x22dc77(0x1fa)+_0x23889b,'Content-Type':'application/json','Accept':_0x22dc77(0x219)},'data':_0x18bcfe};axios(_0x362131)['then'](_0x2da518=>{const _0x416460=_0x22dc77,_0x2a10ba=_0x2da518[_0x416460(0x205)];let _0xcdb7c3='',_0x819b8=null;_0x2a10ba['on'](_0x416460(0x205),_0x4f2fea=>{const _0x1ce235=_0x416460;try{const _0xff6a0e=_0x4f2fea['toString']()[_0x1ce235(0x1fb)]('\x0a')[_0x1ce235(0x22c)](_0x11b932=>_0x11b932[_0x1ce235(0x226)]()[_0x1ce235(0x230)](_0x1ce235(0x203)));for(const _0x30a7cf of _0xff6a0e){const _0x2d6a95=_0x30a7cf[_0x1ce235(0x209)](_0x1ce235(0x203),'')['trim']();if(_0x2d6a95===_0x1ce235(0x1f6)){_0x819b8&&(_0x819b8[_0x1ce235(0x206)]=![],_0x819b8[_0x1ce235(0x21c)]=_0xcdb7c3);continue;}const _0x1b0a40=JSON[_0x1ce235(0x222)](_0x2d6a95);if(_0x1b0a40[_0x1ce235(0x215)]==_0x1ce235(0x1f7)||_0x1b0a40[_0x1ce235(0x215)]==_0x1ce235(0x22e)){_0x819b8[_0x1ce235(0x206)]=!![],_0x819b8[_0x1ce235(0x21c)]=_0xcdb7c3;continue;}const _0x24ba78=_0x1b0a40[_0x1ce235(0x1f1)]||'';_0xcdb7c3+=_0x24ba78;const _0x31802d={'role':'assistant','id':_0x1b0a40[_0x1ce235(0x225)],'text':_0xcdb7c3,'delta':_0x24ba78,'detail':{'choices':[{'delta':{'content':_0x24ba78,'role':_0x1ce235(0x20b)},'index':0x0}],'created':_0x1b0a40[_0x1ce235(0x1f8)],'id':_0x1b0a40[_0x1ce235(0x223)]||_0x5c68a8,'object':'chat.completion.chunk','usage':_0x1b0a40['metadata']?.[_0x1ce235(0x218)]}};_0x819b8=_0x31802d,_0x33c634(_0x31802d);}}catch(_0x2d15f8){console[_0x1ce235(0x1f7)](_0x1ce235(0x22f),_0x2d15f8);}}),_0x2a10ba['on'](_0x416460(0x1f5),()=>{_0x414b4e(_0x819b8),_0xcdb7c3='';}),_0x2a10ba['on'](_0x416460(0x1f7),_0x369ef3=>{const _0x16612a=_0x416460;console['error'](_0x16612a(0x21b),_0x369ef3),_0x2c2457(_0x369ef3);});})[_0x22dc77(0x228)](_0x1c9f62=>{const _0x5633c5=_0x22dc77;console[_0x5633c5(0x1f7)](_0x5633c5(0x224),_0x1c9f62),_0x2c2457(_0x1c9f62);});});}exports['sendDifyMessage']=sendDifyMessage;function _0x3e65(){const _0x4450c1=['[DONE]','error','created_at','error:\x20','Bearer\x20','split','now','compilerMetaJsonStr','delta','forEach','4742928cCkdNg','5902128LhuFvb','defineProperty','data:\x20','stream','data','is_end','round','78466wxSakf','replace','stringify','assistant','content','chat.completion.chunk','__esModule','sendMessageFromFastgpt','sign','model','length','/chat-messages','created','event','HS256','128876iyTmhS','usage','text/event-stream','13349529lbfKGn','Stream\x20error:','text','5329800ivKqzq','22WPjBpR','SIGN','https://open.bigmodel.cn/api/paas/v4/chat/completions','toString','parse','message_id','Axios\x20error:','conversation_id','trim','sendDifyMessage','catch','sendMessageFromZhipu','choices','log','filter','POST','failed','Error\x20parsing\x20stream\x20chunk:','startsWith','/chat/completions','application/json','event:','id:','compilerStream','12313696lYZMCS','generateToken','answer','45dhQLHy','data:','streaming','end'];_0x3e65=function(){return _0x4450c1;};return _0x3e65();}