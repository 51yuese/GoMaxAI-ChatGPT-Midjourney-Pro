'use strict';const _0x97d640=_0x2a7c;(function(_0x179dfa,_0x754239){const _0x45781a=_0x2a7c,_0x5a16b1=_0x179dfa();while(!![]){try{const _0x2aef23=-parseInt(_0x45781a(0x13a))/0x1*(parseInt(_0x45781a(0x119))/0x2)+-parseInt(_0x45781a(0x141))/0x3*(parseInt(_0x45781a(0x10d))/0x4)+parseInt(_0x45781a(0x140))/0x5*(-parseInt(_0x45781a(0x10a))/0x6)+parseInt(_0x45781a(0x122))/0x7*(-parseInt(_0x45781a(0x113))/0x8)+parseInt(_0x45781a(0x108))/0x9+parseInt(_0x45781a(0x121))/0xa+parseInt(_0x45781a(0x11b))/0xb;if(_0x2aef23===_0x754239)break;else _0x5a16b1['push'](_0x5a16b1['shift']());}catch(_0x142909){_0x5a16b1['push'](_0x5a16b1['shift']());}}}(_0x57b9,0x62473));function _0x2a7c(_0x3bce88,_0x3d0270){const _0x57b974=_0x57b9();return _0x2a7c=function(_0x2a7cac,_0x4010d4){_0x2a7cac=_0x2a7cac-0x108;let _0x26a67f=_0x57b974[_0x2a7cac];return _0x26a67f;},_0x2a7c(_0x3bce88,_0x3d0270);}var __decorate=this&&this[_0x97d640(0x13d)]||function(_0x16916f,_0x3e534a,_0x231394,_0xdc3acc){const _0x3aef45=_0x97d640;var _0xd892f5=arguments[_0x3aef45(0x11a)],_0xbdd54f=_0xd892f5<0x3?_0x3e534a:_0xdc3acc===null?_0xdc3acc=Object['getOwnPropertyDescriptor'](_0x3e534a,_0x231394):_0xdc3acc,_0x20b2bf;if(typeof Reflect===_0x3aef45(0x147)&&typeof Reflect['decorate']===_0x3aef45(0x125))_0xbdd54f=Reflect['decorate'](_0x16916f,_0x3e534a,_0x231394,_0xdc3acc);else{for(var _0x6c8480=_0x16916f[_0x3aef45(0x11a)]-0x1;_0x6c8480>=0x0;_0x6c8480--)if(_0x20b2bf=_0x16916f[_0x6c8480])_0xbdd54f=(_0xd892f5<0x3?_0x20b2bf(_0xbdd54f):_0xd892f5>0x3?_0x20b2bf(_0x3e534a,_0x231394,_0xbdd54f):_0x20b2bf(_0x3e534a,_0x231394))||_0xbdd54f;}return _0xd892f5>0x3&&_0xbdd54f&&Object[_0x3aef45(0x11e)](_0x3e534a,_0x231394,_0xbdd54f),_0xbdd54f;},__metadata=this&&this['__metadata']||function(_0x3e52ef,_0x56c7b){const _0x3b8bea=_0x97d640;if(typeof Reflect==='object'&&typeof Reflect[_0x3b8bea(0x139)]==='function')return Reflect['metadata'](_0x3e52ef,_0x56c7b);},_a;Object['defineProperty'](exports,_0x97d640(0x13f),{'value':!![]}),exports['AsrProxyGateway']=void 0x0;function _0x57b9(){const _0x150028=['error','stringify','design:type','metadata','167OmTCSP','chunk','sendAudioChunk','__decorate','Server','__esModule','5ZSfkkn','3IlkDfy','Failed\x20to\x20initialize\x20ASR\x20connection:\x20','undefined','init','prototype','base64','object','3375405BMIgUf','WebSocketServer','426942qjIEze','close','from','2919740MFGQra','server','wav','get','audio','uuid','701896OWdwWK','parse','New\x20client\x20connected:\x20','send','dummy','websocket','5674sEoKEl','length','10585223IaEmiC','ASR\x20client\x20not\x20initialized.\x20Call\x20init\x20first.','message','defineProperty','isLast','volcengine_streaming_common','7787650WtZbgw','35DaAaMM','activeClients','AsrProxyGateway','function','ready','zh-CN','5019635732','result','set','asrClient','handleDisconnect','handleConnection','handleInit','@nestjs/websockets','initConnection','type','handleAudio','delete','onResponse','log'];_0x57b9=function(){return _0x150028;};return _0x57b9();}const websockets_1=require(_0x97d640(0x12f)),ws_1=require('ws'),uuid_1=require(_0x97d640(0x112)),asr_ws_client_1=require('./asr-ws-client');let AsrProxyGateway=class AsrProxyGateway{constructor(){const _0xd59515=_0x97d640;this[_0xd59515(0x123)]=new Map();}[_0x97d640(0x12d)](_0x3ba631){const _0x5ae09b=_0x97d640,_0xa8cf83=(0x0,uuid_1['v4'])();console['log'](_0x5ae09b(0x115)+_0xa8cf83),this[_0x5ae09b(0x123)][_0x5ae09b(0x12a)](_0xa8cf83,{'ws':_0x3ba631}),_0x3ba631['on'](_0x5ae09b(0x11d),async _0x186d2b=>{const _0x2b508a=_0x5ae09b;try{const _0x4d2383=JSON[_0x2b508a(0x114)](_0x186d2b);if(_0x4d2383['type']===_0x2b508a(0x144))await this[_0x2b508a(0x12e)](_0xa8cf83,_0x4d2383);else _0x4d2383[_0x2b508a(0x131)]===_0x2b508a(0x111)&&await this[_0x2b508a(0x132)](_0xa8cf83,_0x4d2383);}catch(_0x3dbc0c){console[_0x2b508a(0x135)]('Error\x20processing\x20message:',_0x3dbc0c),_0x3ba631[_0x2b508a(0x116)](JSON['stringify']({'type':_0x2b508a(0x136),'message':_0x3dbc0c[_0x2b508a(0x11d)]}));}});}[_0x97d640(0x12c)](_0x517fc1){const _0x2af6ed=_0x97d640;console[_0x2af6ed(0x135)]('Client\x20disconnected:\x20'+_0x517fc1);const _0x112dea=this['activeClients'][_0x2af6ed(0x110)](_0x517fc1);_0x112dea?.[_0x2af6ed(0x12b)]&&_0x112dea['asrClient'][_0x2af6ed(0x10b)](),this[_0x2af6ed(0x123)][_0x2af6ed(0x133)](_0x517fc1);}async[_0x97d640(0x12e)](_0x3759b6,_0x4cd762){const _0x350e0e=_0x97d640,_0x1ea7f7=this[_0x350e0e(0x123)]['get'](_0x3759b6);if(!_0x1ea7f7)throw new Error('Client\x20not\x20found');const {ws:_0x6d67d8}=_0x1ea7f7,{format:format=_0x350e0e(0x10f),sampleRate:sampleRate=0x3e80,language:language=_0x350e0e(0x127)}=_0x4cd762,_0xe7d2c=new asr_ws_client_1['AsrWsClient'](_0x350e0e(0x117),_0x350e0e(0x120),{'appid':_0x350e0e(0x128),'token':'VsrnA2faKbR93YlCeD63hAjbqTuzRgQU','format':format,'sampleRate':sampleRate,'language':language,'segDuration':0x1f4,'channel':0x1,'bits':0x10});try{await _0xe7d2c[_0x350e0e(0x130)](),_0xe7d2c[_0x350e0e(0x134)](_0x3a2b1f=>{const _0x50ce42=_0x350e0e;_0x6d67d8['send'](JSON[_0x50ce42(0x137)]({'type':_0x50ce42(0x129),'data':_0x3a2b1f}));}),this[_0x350e0e(0x123)][_0x350e0e(0x12a)](_0x3759b6,{'ws':_0x6d67d8,'asrClient':_0xe7d2c}),_0x6d67d8[_0x350e0e(0x116)](JSON[_0x350e0e(0x137)]({'type':_0x350e0e(0x126)}));}catch(_0x20bdd9){_0x6d67d8[_0x350e0e(0x116)](JSON[_0x350e0e(0x137)]({'type':'error','message':_0x350e0e(0x142)+_0x20bdd9[_0x350e0e(0x11d)]}));}}async[_0x97d640(0x132)](_0x4591ae,_0xfe001e){const _0x1d35f0=_0x97d640,_0x139df4=this['activeClients'][_0x1d35f0(0x110)](_0x4591ae);if(!_0x139df4||!_0x139df4['asrClient'])throw new Error(_0x1d35f0(0x11c));const {ws:_0x1866b0,asrClient:_0x5ada2c}=_0x139df4,_0x5e93f2=Buffer[_0x1d35f0(0x10c)](_0xfe001e[_0x1d35f0(0x13b)],_0x1d35f0(0x146));await _0x5ada2c[_0x1d35f0(0x13c)](_0x5e93f2,_0xfe001e[_0x1d35f0(0x11f)]||![]);}};__decorate([(0x0,websockets_1[_0x97d640(0x109)])(),__metadata(_0x97d640(0x138),typeof(_a=typeof ws_1[_0x97d640(0x13e)]!==_0x97d640(0x143)&&ws_1[_0x97d640(0x13e)])===_0x97d640(0x125)?_a:Object)],AsrProxyGateway[_0x97d640(0x145)],_0x97d640(0x10e),void 0x0),AsrProxyGateway=__decorate([(0x0,websockets_1['WebSocketGateway'])({'path':'/voice-ws','transports':[_0x97d640(0x118)],'noServer':!![],'cors':!![]})],AsrProxyGateway),exports[_0x97d640(0x124)]=AsrProxyGateway;