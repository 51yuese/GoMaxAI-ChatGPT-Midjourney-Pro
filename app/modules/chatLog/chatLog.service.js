'use strict';const _0x2cbf6e=_0x2f44;(function(_0x5d53af,_0x357a67){const _0x4e6c03=_0x2f44,_0x334a00=_0x5d53af();while(!![]){try{const _0x5c778d=-parseInt(_0x4e6c03(0x191))/0x1+-parseInt(_0x4e6c03(0x137))/0x2*(-parseInt(_0x4e6c03(0x164))/0x3)+-parseInt(_0x4e6c03(0x1c9))/0x4*(-parseInt(_0x4e6c03(0x109))/0x5)+parseInt(_0x4e6c03(0xff))/0x6*(-parseInt(_0x4e6c03(0x1d3))/0x7)+parseInt(_0x4e6c03(0x180))/0x8*(-parseInt(_0x4e6c03(0x130))/0x9)+parseInt(_0x4e6c03(0x12d))/0xa+parseInt(_0x4e6c03(0x105))/0xb;if(_0x5c778d===_0x357a67)break;else _0x334a00['push'](_0x334a00['shift']());}catch(_0x3616df){_0x334a00['push'](_0x334a00['shift']());}}}(_0xe82a,0x43a5f));var __decorate=this&&this[_0x2cbf6e(0x183)]||function(_0x53a834,_0x30cd65,_0x45165d,_0x1558c9){const _0x2d5ce2=_0x2cbf6e;var _0x1c0c85=arguments[_0x2d5ce2(0x119)],_0x29cdf0=_0x1c0c85<0x3?_0x30cd65:_0x1558c9===null?_0x1558c9=Object[_0x2d5ce2(0xd2)](_0x30cd65,_0x45165d):_0x1558c9,_0x4a7cfc;if(typeof Reflect===_0x2d5ce2(0xe1)&&typeof Reflect['decorate']===_0x2d5ce2(0x1bc))_0x29cdf0=Reflect[_0x2d5ce2(0x12b)](_0x53a834,_0x30cd65,_0x45165d,_0x1558c9);else{for(var _0x7255e0=_0x53a834['length']-0x1;_0x7255e0>=0x0;_0x7255e0--)if(_0x4a7cfc=_0x53a834[_0x7255e0])_0x29cdf0=(_0x1c0c85<0x3?_0x4a7cfc(_0x29cdf0):_0x1c0c85>0x3?_0x4a7cfc(_0x30cd65,_0x45165d,_0x29cdf0):_0x4a7cfc(_0x30cd65,_0x45165d))||_0x29cdf0;}return _0x1c0c85>0x3&&_0x29cdf0&&Object[_0x2d5ce2(0xca)](_0x30cd65,_0x45165d,_0x29cdf0),_0x29cdf0;},__metadata=this&&this['__metadata']||function(_0x11ba91,_0x359b12){const _0x2e06f0=_0x2cbf6e;if(typeof Reflect===_0x2e06f0(0xe1)&&typeof Reflect['metadata']===_0x2e06f0(0x1bc))return Reflect['metadata'](_0x11ba91,_0x359b12);},__param=this&&this[_0x2cbf6e(0xb9)]||function(_0x4f13ca,_0x746beb){return function(_0x3f84c2,_0x22ae1e){_0x746beb(_0x3f84c2,_0x22ae1e,_0x4f13ca);};};function _0x2f44(_0xc0f837,_0x5e029b){const _0xe82a4e=_0xe82a();return _0x2f44=function(_0x2f449e,_0x5233f6){_0x2f449e=_0x2f449e-0xaf;let _0x17e620=_0xe82a4e[_0x2f449e];return _0x17e620;},_0x2f44(_0xc0f837,_0x5e029b);}Object[_0x2cbf6e(0xca)](exports,_0x2cbf6e(0xfe),{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x2cbf6e(0x146)),typeorm_1=require(_0x2cbf6e(0x102)),chatLog_entity_1=require(_0x2cbf6e(0x1d8)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x2cbf6e(0x193)),utils_1=require(_0x2cbf6e(0x1c6)),file_service_1=require(_0x2cbf6e(0x16e)),redisCache_service_1=require('../redisCache/redisCache.service'),redisKey_constant_1=require(_0x2cbf6e(0x1c2)),model_constant_1=require(_0x2cbf6e(0xd5)),aiAssets_entity_1=require(_0x2cbf6e(0xc3)),aiLog_service_1=require(_0x2cbf6e(0x12a)),nestjs_cls_1=require(_0x2cbf6e(0x1b4)),class_validator_1=require(_0x2cbf6e(0xb3)),user_service_1=require(_0x2cbf6e(0xe9)),models_service_1=require(_0x2cbf6e(0x19d)),store_1=require('../../common/store'),collectType_constant_1=require(_0x2cbf6e(0x194)),openapi_1=require('@volcengine/openapi');let ChatLogService=class ChatLogService{constructor(_0x488fd6,_0x2e9416,_0x46f702,_0xc9668,_0x46154a,_0x4efd7d,_0x26730c,_0x183818,_0x4cbca4){const _0x3fb75e=_0x2cbf6e;this[_0x3fb75e(0x1cd)]=_0x488fd6,this['aiAssetsEntity']=_0x2e9416,this[_0x3fb75e(0xb2)]=_0x46f702,this['fileService']=_0xc9668,this[_0x3fb75e(0x1cc)]=_0x46154a,this[_0x3fb75e(0x154)]=_0x4efd7d,this[_0x3fb75e(0x179)]=_0x26730c,this[_0x3fb75e(0x17d)]=_0x183818,this[_0x3fb75e(0x125)]=_0x4cbca4;}async[_0x2cbf6e(0x12e)](_0x3d0fc8){const _0x4da697=_0x2cbf6e;return await this['chatLogEntity'][_0x4da697(0xf8)](_0x3d0fc8);}async[_0x2cbf6e(0x107)](_0x130f68){const _0x50c3b3=_0x2cbf6e,_0x5a35ab=_0x130f68[_0x50c3b3(0x198)];let _0x315b69={},_0x44964e={};if(_0x5a35ab[_0x50c3b3(0x16b)]('Request\x20failed')!=-0x1)throw new Error(_0x50c3b3(0x1c8)+_0x5a35ab);else{let _0x3cd372='',_0x222027='',_0x195cfd=_0x50c3b3(0x110),_0x336468=_0x50c3b3(0x110),_0xb3a7b6=_0x50c3b3(0x110),_0x121d36=_0x50c3b3(0x110),_0x2b6207=_0x50c3b3(0x110),_0x18283f=_0x50c3b3(0x110),_0x5a66ea=_0x50c3b3(0x110),_0x178000=_0x50c3b3(0x110);if(_0x5a35ab[_0x50c3b3(0x144)]('####')){const [_0x234a8f]=_0x5a35ab[_0x50c3b3(0x159)](/>(\S+)\n/g);_0x3cd372=_0x222027=_0x234a8f['substring'](0x1,_0x234a8f[_0x50c3b3(0x119)]-0x1),_0x195cfd=_0x5a35ab['split']('\x0a')[0x0][_0x50c3b3(0x115)](0x7),_0x336468=_0x5a35ab[_0x50c3b3(0x155)](_0x50c3b3(0xe2))[0x1][_0x50c3b3(0xd8)](/\[.*\]|Ôºà.*Ôºâ/g,'')[_0x50c3b3(0xd8)](/\n+/g,'\x0a');const _0x3a45f2=_0x5a35ab[_0x50c3b3(0x159)](/!\[image\].*\)/g);_0x3a45f2&&([_0xb3a7b6,_0x121d36]=_0x3a45f2[_0x50c3b3(0x104)](_0xbcaa5a=>_0xbcaa5a[_0x50c3b3(0x115)](0x9,_0xbcaa5a['length']-0x1)));const _0x21db20=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp3/g);_0x21db20&&([_0x2b6207,_0x18283f]=_0x21db20);const _0x2a72d1=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp4/g);_0x2a72d1&&([_0x5a66ea,_0x178000]=_0x2a72d1);}else{if(_0x5a35ab['startsWith']('üéµ')){_0x195cfd=_0x5a35ab[_0x50c3b3(0x155)]('\x0a')[0x0][_0x50c3b3(0xd8)](/üéµ/g,'');const _0x512128=_0x5a35ab[_0x50c3b3(0x155)]('--')[_0x50c3b3(0x1a7)](_0x34cce5=>/-\n\n\[/[_0x50c3b3(0x156)](_0x34cce5));if(_0x512128){const _0x589bf9=_0x512128['replace'](/\[.*\]|Ôºà.*Ôºâ|-/g,'')[_0x50c3b3(0xd8)](/\n+/g,'\x0a');_0x589bf9[_0x50c3b3(0x144)]('\x0a')?_0x336468=_0x589bf9['replace']('\x0a',''):_0x336468=_0x589bf9;}const _0x2e644d=_0x5a35ab['match'](/Ê≠åÊõ≤id(.+)\n/ig);_0x2e644d&&([_0x3cd372,_0x222027]=_0x2e644d[_0x50c3b3(0x104)](_0x19d896=>_0x19d896[_0x50c3b3(0x115)](0xc,_0x19d896['length']-0x1)));const _0x1df1b1=_0x5a35ab[_0x50c3b3(0x159)](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x1df1b1&&([_0xb3a7b6,_0x121d36]=_0x1df1b1['map'](_0x136603=>_0x136603[_0x50c3b3(0x115)](0x7,_0x136603['length']-0x1)));const _0x567958=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp3/g);_0x567958&&([_0x2b6207,_0x18283f]=_0x567958);const _0x4dc136=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp4/g);_0x4dc136&&([_0x5a66ea,_0x178000]=_0x4dc136);}else{if(_0x5a35ab[_0x50c3b3(0x16b)]('üíÑ')!=-0x1){let _0x39ddd0=_0x5a35ab[_0x50c3b3(0x155)]('\x0a');_0x39ddd0[_0x50c3b3(0x1bb)](_0x2b7297=>{const _0x12c4eb=_0x50c3b3;_0x2b7297[_0x12c4eb(0x16b)]('üîé')!=-0x1&&(_0x195cfd=_0x2b7297[_0x12c4eb(0x155)]('Ôºö')[0x1]);});const _0x1e94a4=_0x5a35ab['split'](_0x50c3b3(0xe7))[0x1][_0x50c3b3(0x155)]('\x0a');if(_0x1e94a4){const _0x1fbe28=_0x1e94a4[_0x50c3b3(0x19e)](_0x59141a=>_0x59141a[_0x50c3b3(0x16b)]('[')==-0x1)[_0x50c3b3(0xbd)]('');_0x1fbe28[_0x50c3b3(0x144)]('\x0a')?_0x336468=_0x1fbe28[_0x50c3b3(0xd8)]('\x0a',''):_0x336468=_0x1fbe28;}const _0x7663f=_0x5a35ab[_0x50c3b3(0x159)](/Ê≠åÊõ≤id(.+)\n/ig);_0x7663f&&([_0x3cd372,_0x222027]=_0x7663f[_0x50c3b3(0x104)](_0x1f66aa=>_0x1f66aa['substring'](0xa,_0x1f66aa[_0x50c3b3(0x119)]-0x1)));const _0x252920=_0x5a35ab[_0x50c3b3(0x159)](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x252920&&([_0xb3a7b6,_0x121d36]=_0x252920[_0x50c3b3(0x104)](_0x52e90a=>_0x52e90a['substring'](0x7,_0x52e90a['length']-0x1)));const _0x11bcd6=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp3/g);_0x11bcd6&&([_0x2b6207,_0x18283f]=_0x11bcd6);const _0x3a12a3=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp4/g);_0x3a12a3&&([_0x5a66ea,_0x178000]=_0x3a12a3);}else{if(_0x5a35ab[_0x50c3b3(0x144)]('üéÅ')){_0x195cfd=_0x5a35ab['split']('\x0a')[0x2][_0x50c3b3(0x155)](_0x50c3b3(0x1a8))[0x1];const _0x3120e4=_0x5a35ab[_0x50c3b3(0x155)](_0x50c3b3(0xe7))[0x1][_0x50c3b3(0x155)]('\x0a');if(_0x3120e4){const _0x342e0b=_0x3120e4[_0x50c3b3(0x19e)](_0x4b2d86=>_0x4b2d86[_0x50c3b3(0x16b)]('[')==-0x1)[_0x50c3b3(0xbd)]('');_0x342e0b['startsWith']('\x0a')?_0x336468=_0x342e0b[_0x50c3b3(0xd8)]('\x0a',''):_0x336468=_0x342e0b;}const _0x3df783=_0x5a35ab[_0x50c3b3(0x159)](/Ê≠åÊõ≤IDÔºö(.+)\n/ig);_0x3df783&&([_0x3cd372,_0x222027]=_0x3df783[_0x50c3b3(0x104)](_0x246064=>_0x246064[_0x50c3b3(0x115)](0x8,_0x246064[_0x50c3b3(0x119)]-0x1)));const _0x1d63b8=_0x5a35ab[_0x50c3b3(0x159)](/\[Â∞ÅÈù¢\].*\)/g);_0x1d63b8&&([_0xb3a7b6,_0x121d36]=_0x1d63b8[_0x50c3b3(0x104)](_0x3a4668=>_0x3a4668[_0x50c3b3(0x115)](0x5,_0x3a4668['length']-0x1)));const _0x133658=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp3/g);_0x133658&&([_0x2b6207,_0x18283f]=_0x133658);const _0x20a1a0=_0x5a35ab['match'](/https:\/\/(.*)\.mp4/g);_0x20a1a0&&([_0x5a66ea,_0x178000]=_0x20a1a0);}else{if(_0x5a35ab[_0x50c3b3(0x16b)](_0x50c3b3(0xc6))!==-0x1){let _0x4ef5bf=_0x5a35ab[_0x50c3b3(0x155)]('\x0a'),_0x24a8cb=![];const _0x5dbada=[];for(let _0x23c133=0x0;_0x23c133<_0x4ef5bf[_0x50c3b3(0x119)];_0x23c133++){const _0x4411bb=_0x4ef5bf[_0x23c133];_0x4411bb[_0x50c3b3(0x16b)](_0x50c3b3(0xc6))!==-0x1&&(_0x195cfd=_0x4411bb[_0x50c3b3(0x155)]('Ôºö\x20')[0x1]);if(_0x4411bb['includes'](_0x50c3b3(0x1d7)))_0x24a8cb=![];else{if(_0x24a8cb&&!_0x4411bb['startsWith']('['))_0x5dbada[_0x50c3b3(0x1c5)](_0x4411bb);else _0x4411bb[_0x50c3b3(0x1ab)](_0x50c3b3(0x1b2))&&(_0x24a8cb=!![]);}}_0x336468=_0x5dbada[_0x50c3b3(0xbd)]('\x20');const _0xdb3b9c=_0x5a35ab['match'](/ÁâàÊú¨IDÔºö(.+)\n/ig);_0xdb3b9c&&([_0x3cd372,_0x222027]=_0xdb3b9c[_0x50c3b3(0x104)](_0x183320=>_0x183320['substring'](0xa,_0x183320[_0x50c3b3(0x119)]-0x1)));const _0x396b00=_0x5a35ab['match'](/\[Â∞ÅÈù¢\].*\)/g);_0x396b00&&([_0xb3a7b6,_0x121d36]=_0x396b00[_0x50c3b3(0x104)](_0x4d362e=>_0x4d362e[_0x50c3b3(0x115)](0x5,_0x4d362e[_0x50c3b3(0x119)]-0x1)));const _0x25cedc=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp3/g);_0x25cedc&&([_0x2b6207,_0x18283f]=_0x25cedc);const _0x50359d=_0x5a35ab[_0x50c3b3(0x159)](/https:\/\/(.*)\.mp4/g);_0x50359d&&([_0x5a66ea,_0x178000]=_0x50359d);}else throw new Error(_0x50c3b3(0x110));}}}}_0x315b69={'title':_0x195cfd,'intro':_0x336468,'mp3':_0x2b6207,'mp4':_0x5a66ea,'cover':_0xb3a7b6,'sunoMusicId':_0x3cd372,'chatLogId':_0x130f68['id'],'userId':_0x130f68['userId']},_0x44964e={'title':_0x195cfd,'intro':_0x336468,'mp3':_0x18283f,'mp4':_0x178000,'cover':_0x121d36,'sunoMusicId':_0x222027,'chatLogId':_0x130f68['id'],'userId':_0x130f68[_0x50c3b3(0x176)]};}await this[_0x50c3b3(0x125)]['transaction'](async()=>{const _0x2a75a5=_0x50c3b3;await this[_0x2a75a5(0xdc)][_0x2a75a5(0xf8)](_0x315b69),await this['aiAssetsEntity'][_0x2a75a5(0xf8)](_0x44964e);});}async[_0x2cbf6e(0xcc)](_0x177f92,{id:_0x578b84,videoUrl:_0x2158d5,state:_0x5012f7,completed:_0x9c7aeb}){const _0x255ef2=_0x2cbf6e;let _0x3f543b={'mp4':_0x2158d5,'sunoMusicId':_0x578b84,'chatLogId':_0x177f92['id'],'userId':_0x177f92['userId']};if(_0x578b84){const _0x5f2049=await this[_0x255ef2(0xdc)][_0x255ef2(0xcd)]({'where':{'sunoMusicId':_0x578b84}});_0x5f2049&&(_0x3f543b=Object[_0x255ef2(0x17c)](_0x5f2049,_0x3f543b));}console[_0x255ef2(0xcf)](_0x255ef2(0xd6),_0x3f543b),_0x3f543b=await this[_0x255ef2(0xdc)][_0x255ef2(0xf8)](_0x3f543b),_0x177f92[_0x255ef2(0x198)]=_0x5012f7,this[_0x255ef2(0x1cd)]['save'](_0x177f92),_0x9c7aeb&&_0x3f543b[_0x255ef2(0xb6)]&&this[_0x255ef2(0xc4)](_0x3f543b);}async[_0x2cbf6e(0x19c)](_0xa3123d,_0x18400b){const _0x11ce29=_0x2cbf6e;try{const {id:_0x18a3e8}=_0xa3123d[_0x11ce29(0xbc)],{model:_0x4490e}=_0x18400b,_0x15b298={'userId':_0x18a3e8,'type':balance_constant_1[_0x11ce29(0xe4)]['PAINT_TYPE'],'modelType':_0x11ce29(0x106),'isDelete':![]};_0x18400b['keyType']&&(_0x15b298[_0x11ce29(0x16f)]=_0x18400b[_0x11ce29(0x13d)]);_0x4490e&&(_0x15b298['model']=_0x4490e);const _0x5ab9b4=await this[_0x11ce29(0x1cd)][_0x11ce29(0x1a7)]({'where':_0x15b298,'order':{'id':_0x11ce29(0x1a1)}});return _0x5ab9b4[_0x11ce29(0x1bb)](_0xa0ae21=>{const _0x10466c=_0x11ce29;if(_0xa0ae21[_0x10466c(0x1db)]===_0x10466c(0xd4)){const _0x36c718=_0xa0ae21['model']==='mj'?0x136:0xa0,_0x1fa6af=_0xa0ae21[_0x10466c(0x198)]['includes'](_0x10466c(0x1ce))?_0x10466c(0x178):_0x10466c(0x197),_0x2b1a8b=_0x1fa6af===_0x10466c(0x178)?_0x10466c(0x113)+_0x36c718+_0x10466c(0x182):_0x10466c(0xf0)+_0x36c718;_0xa0ae21[_0x10466c(0x122)]=_0xa0ae21['answer']+_0x2b1a8b;const _0x5a6abc=_0xa0ae21[_0x10466c(0xbe)]?JSON[_0x10466c(0xbf)](_0xa0ae21[_0x10466c(0xbe)]):null;_0x5a6abc&&(_0x5a6abc?_0xa0ae21[_0x10466c(0xec)]=_0x5a6abc?.[_0x10466c(0x13c)][0x0]?.[_0x10466c(0x13c)][_0x10466c(0x119)]===0x5:_0xa0ae21[_0x10466c(0xec)]=![]);}}),_0x5ab9b4;}catch(_0x40c8f4){return console['log'](_0x40c8f4),_0x40c8f4;}}async[_0x2cbf6e(0x177)](_0x35083d,_0x249e3f){const _0x31b24c=_0x2cbf6e;try{const {id:_0x6bec4b}=_0x35083d['user'],{model:_0x4a99fa}=_0x249e3f,_0x1dcc7d={'userId':_0x6bec4b,'type':balance_constant_1[_0x31b24c(0xe4)][_0x31b24c(0x161)],'modelType':_0x31b24c(0x106),'isDelete':![]};_0x249e3f[_0x31b24c(0x13d)]&&(_0x1dcc7d[_0x31b24c(0x16f)]=_0x249e3f[_0x31b24c(0x13d)]);_0x4a99fa&&(_0x1dcc7d['model']=_0x4a99fa);const [_0x1ab8e5,_0xc6c201]=await this[_0x31b24c(0x1cd)]['findAndCount']({'where':_0x1dcc7d,'order':{'id':_0x31b24c(0x1a1)}});let _0x3cec11=[];return _0x1ab8e5[_0x31b24c(0x1bb)](_0x3b7254=>{const _0x451c24=_0x31b24c;_0x3cec11[_0x451c24(0x1c5)](this[_0x451c24(0x11f)](_0x3b7254));}),{'result':_0x3cec11,'count':_0xc6c201};}catch(_0x2afab3){return console[_0x31b24c(0xcf)](_0x2afab3),_0x2afab3;}}async[_0x2cbf6e(0xdb)](_0x2bb92b,_0x295225){const _0x3e4000=_0x2cbf6e,_0xe9b2fc=_0x2bb92b[_0x3e4000(0xbc)]['id'],_0x3d392a=await this[_0x3e4000(0x1cd)][_0x3e4000(0xcd)]({'where':{'userId':_0xe9b2fc,'id':_0x295225}});if(!_0x3d392a)return'';return this[_0x3e4000(0x11f)](_0x3d392a);}['returnDrawDetail'](_0x361edc){const _0x52d425=_0x2cbf6e;return{'id':_0x361edc['id'],'createdAt':_0x361edc['createdAt'],'userId':_0x361edc['userId'],'model':_0x361edc[_0x52d425(0x16a)],'modelType':_0x361edc[_0x52d425(0xb1)],'modelSubType':_0x361edc[_0x52d425(0x16f)],'fullPrompt':_0x361edc['prompt'],'originPrompt':_0x361edc[_0x52d425(0x17a)],'prompt':_0x361edc[_0x52d425(0x17a)],'answer':_0x361edc[_0x52d425(0x198)],'status':_0x361edc[_0x52d425(0x198)],'failReason':_0x361edc['errMsg'],'imageUrl':_0x361edc[_0x52d425(0x1a6)],'rec':_0x361edc['rec'],'requestParams':_0x361edc[_0x52d425(0x1b9)],'isCollect':0x0,'collectNum':0x0};}async[_0x2cbf6e(0x1b1)](_0x397c55){const _0x4ff9a6=_0x2cbf6e,{page:page=0x1,size:size=0x14,rec:_0x12de72,userId:_0x409054,model:_0x3a40b2}=_0x397c55,_0x104aa8={'type':balance_constant_1[_0x4ff9a6(0xe4)][_0x4ff9a6(0x161)],'prompt':(0x0,typeorm_2[_0x4ff9a6(0x1b0)])(''),'answer':(0x0,typeorm_2[_0x4ff9a6(0x1b0)])('')};_0x12de72&&Object[_0x4ff9a6(0x17c)](_0x104aa8,{'rec':_0x12de72}),_0x409054&&Object[_0x4ff9a6(0x17c)](_0x104aa8,{'userId':_0x409054}),_0x3a40b2&&Object[_0x4ff9a6(0x17c)](_0x104aa8,{'model':_0x3a40b2});const [_0x5b0cbd,_0x1179e0]=await this['chatLogEntity'][_0x4ff9a6(0x17e)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x104aa8});return _0x5b0cbd['forEach'](_0x40cbc1=>{const _0x3b2a8b=_0x4ff9a6;if(_0x40cbc1['type']===_0x3b2a8b(0xd4)){const _0xe21ca8=_0x40cbc1[_0x3b2a8b(0x16a)]==='mj'?0x136:0xa0,_0x1c7208=_0x40cbc1[_0x3b2a8b(0x198)][_0x3b2a8b(0x1ab)](_0x3b2a8b(0x1ce))?'tencent':_0x3b2a8b(0x197),_0x5119ca=_0x1c7208===_0x3b2a8b(0x178)?'?imageView2/1/w/'+_0xe21ca8+_0x3b2a8b(0x182):_0x3b2a8b(0xf0)+_0xe21ca8;_0x40cbc1[_0x3b2a8b(0x122)]=_0x40cbc1[_0x3b2a8b(0x198)]+_0x5119ca;const _0x3bf43c=_0x40cbc1[_0x3b2a8b(0xbe)]?JSON[_0x3b2a8b(0xbf)](_0x40cbc1[_0x3b2a8b(0xbe)]):null;_0x3bf43c&&(_0x3bf43c?_0x40cbc1[_0x3b2a8b(0xec)]=_0x3bf43c?.[_0x3b2a8b(0x13c)][0x0]?.[_0x3b2a8b(0x13c)]['length']===0x5:_0x40cbc1[_0x3b2a8b(0xec)]=![]);}}),{'rows':_0x5b0cbd,'count':_0x1179e0};}async[_0x2cbf6e(0xd1)](_0x14eaab){const _0xe46b82=_0x2cbf6e,{id:_0x3b552a}=_0x14eaab,_0xd40cd5=await this['chatLogEntity'][_0xe46b82(0xcd)]({'where':{'id':_0x3b552a,'type':balance_constant_1[_0xe46b82(0xe4)][_0xe46b82(0x161)]}});if(!_0xd40cd5)throw new common_1['HttpException'](_0xe46b82(0x103),common_1[_0xe46b82(0x10b)][_0xe46b82(0x1af)]);const _0x36722c=_0xd40cd5['rec']===0x1?0x0:0x1,_0x261e0e=await this[_0xe46b82(0x1cd)][_0xe46b82(0x139)]({'id':_0x3b552a},{'rec':_0x36722c});if(_0x261e0e['affected']>0x0)return(_0x36722c?'Êé®Ëçê':'ÂèñÊ∂àÊé®Ëçê')+_0xe46b82(0xb8);throw new common_1[(_0xe46b82(0x120))](_0xe46b82(0x18c),common_1[_0xe46b82(0x10b)][_0xe46b82(0x1af)]);}async['rec'](_0x2c50fb,_0xe0a6f4,_0x1febbb){const _0x8a392f=_0x2cbf6e,_0x204207=await this[_0x8a392f(0xdc)]['findOne']({'where':{'id':_0x2c50fb}});return _0x204207&&(_0x204207[_0x8a392f(0x131)]=_0xe0a6f4,_0x1febbb&&(_0x204207[_0x8a392f(0x13b)]=_0x1febbb)),await this[_0x8a392f(0xdc)][_0x8a392f(0xf8)](_0x204207),!![];}async['querAllChatLog'](_0x5a7005,_0x4d487b){const _0x248426=_0x2cbf6e;try{const _0x4a29e5=(0x0,utils_1[_0x248426(0x165)])(this[_0x248426(0xb2)]),{page:page=0x1,size:size=0x14,userId:_0x283702,keyword:_0x4e2334,prompt:_0x3bad50,saasId:_0x74d811,modelType:_0x8e3a05}=_0x5a7005;let _0x50eaa7=_0x248426(0x1d5);_0x283702&&(_0x50eaa7=_0x50eaa7+(_0x248426(0xe0)+_0x283702));_0x3bad50&&(_0x50eaa7=_0x50eaa7+(_0x248426(0x1a2)+_0x3bad50+'%\x27'));_0x8e3a05&&(_0x50eaa7=_0x50eaa7+(_0x248426(0x181)+_0x8e3a05+'\x27'));(0x0,utils_1[_0x248426(0x1da)])(this['clsService'])?(0x0,class_validator_1[_0x248426(0x1c7)])(_0x74d811)&&(_0x50eaa7=_0x50eaa7+(_0x248426(0x126)+_0x74d811)):_0x50eaa7=_0x50eaa7+('\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20'+_0x4a29e5);_0x4e2334&&(_0x50eaa7=_0x50eaa7+(_0x248426(0x148)+_0x4e2334+_0x248426(0x14d)+_0x4e2334+_0x248426(0x1d4)+_0x4e2334+_0x248426(0xc0)+_0x4e2334+_0x248426(0x189)));const _0x2c1011=await this[_0x248426(0x125)]['query']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x50eaa7+_0x248426(0x14b)),_0x1400af=await this[_0x248426(0x125)]['query']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x50eaa7+_0x248426(0xf3)+size+_0x248426(0x123)+(page-0x1)*size+_0x248426(0xd3));return!(0x0,utils_1[_0x248426(0x1a3)])(this['clsService'])&&_0x1400af[_0x248426(0x1bb)](_0x526ce8=>{const _0x51fb35=_0x248426;_0x526ce8[_0x51fb35(0xda)]=(0x0,utils_1[_0x51fb35(0x158)])(_0x526ce8[_0x51fb35(0xda)]),_0x526ce8[_0x51fb35(0x135)]=(0x0,utils_1[_0x51fb35(0x158)])(_0x526ce8[_0x51fb35(0x135)]);}),{'rows':_0x1400af,'count':Number(_0x2c1011[0x0]?.[_0x248426(0x195)]||0x0)};}catch(_0x3b91a9){return console[_0x248426(0xcf)](_0x248426(0xe8),_0x3b91a9),{'rows':[],'count':0x0};}}async[_0x2cbf6e(0xed)](_0x2c982b){const _0xc4a174=_0x2cbf6e;if(!_0x2c982b[_0xc4a174(0x1a5)]['length'])return!![];return await this[_0xc4a174(0x1cd)][_0xc4a174(0x139)]({'id':(0x0,typeorm_2['In'])(_0x2c982b['ids'])},{'isDelete':!![]}),!![];}async[_0x2cbf6e(0xc7)](_0x3c175d,_0x47f80d){const _0x52d33e=_0x2cbf6e,{id:_0x32ae17}=_0x3c175d['user'],{groupId:_0x4b8420,logType:_0x5a2a3d,modelSubType:_0x5c379c}=_0x47f80d,_0x4d3260={'userId':_0x32ae17,'isDelete':![]};_0x4b8420&&Object[_0x52d33e(0x17c)](_0x4d3260,{'groupId':_0x4b8420}),_0x5a2a3d&&Object[_0x52d33e(0x17c)](_0x4d3260,{'logType':_0x5a2a3d}),_0x5c379c&&Object['assign'](_0x4d3260,{'modelSubType':_0x5c379c});const _0x226f32=await this[_0x52d33e(0x1cd)]['find']({'where':_0x4d3260})[_0x52d33e(0xf6)](_0xdf18ba=>{const _0xc1ac25=_0x52d33e;common_1['Logger'][_0xc1ac25(0xee)](_0xdf18ba);});if(!_0x226f32||_0x226f32[_0x52d33e(0x119)]===0x0)return[];return _0x226f32[_0x52d33e(0x104)](_0x2c0529=>{const _0x4b5c43=_0x52d33e,{prompt:_0x12d2b1,role:_0x85d2b1,answer:_0x40df5c,createdAt:_0x80ba35,model:_0x4cb50b,conversationOptions:_0x5c3efe,requestOptions:_0x238f37,id:_0x33394d,answerMp3:_0x13801d,think:_0x468c47}=_0x2c0529;return{'chatId':_0x33394d,'dateTime':(0x0,utils_1[_0x4b5c43(0x1d2)])(_0x80ba35),'text':_0x85d2b1===_0x4b5c43(0xbc)?_0x12d2b1:_0x40df5c,'think':_0x468c47,'textMp3':_0x13801d,'inversion':_0x85d2b1==='user','error':![],'conversationOptions':_0x5c3efe?JSON[_0x4b5c43(0xbf)](_0x5c3efe):null,'requestOptions':_0x238f37?JSON[_0x4b5c43(0xbf)](_0x238f37):null};});}async[_0x2cbf6e(0x12c)](_0xf83bea){const _0x57e76b=_0x2cbf6e;return this[_0x57e76b(0x1cd)][_0x57e76b(0x1a7)]({'where':{'groupId':_0xf83bea,'isDelete':![]}});}async[_0x2cbf6e(0xb5)](_0x2c5da4,_0x5533b3,_0x4745d2){const _0x1b52d2=_0x2cbf6e,_0x1a67d7=new Map();if(!_0x5533b3['length'])return _0x1a67d7;const _0x58c72a=await this[_0x1b52d2(0xdc)][_0x1b52d2(0x1a7)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x5533b3),'deleteFlag':0x0}}),_0x160d60=_0x58c72a[_0x1b52d2(0x104)](_0x22061=>_0x22061['id']),_0xd6f66c=await this[_0x1b52d2(0x1cc)][_0x1b52d2(0xc5)](_0x2c5da4,_0x160d60,_0x4745d2),_0x4589b2=await this[_0x1b52d2(0x1cc)][_0x1b52d2(0x19a)](_0x160d60,_0x4745d2);return _0x58c72a[_0x1b52d2(0x1bb)](_0x4ac8e8=>{const _0xb63221=_0x1b52d2;!_0x1a67d7[_0xb63221(0xdd)](_0x4ac8e8[_0xb63221(0x1c1)])&&_0x1a67d7[_0xb63221(0x1d1)](_0x4ac8e8[_0xb63221(0x1c1)],[]);const _0xfe0093=_0x4589b2[_0xb63221(0xba)](_0x4ac8e8['id']);_0x1a67d7[_0xb63221(0xba)](_0x4ac8e8[_0xb63221(0x1c1)])[_0xb63221(0x1c5)]({..._0x4ac8e8,'agree':_0xd6f66c['get'](_0x4ac8e8['id'])||null,'playNum':_0xfe0093?.[_0xb63221(0x166)]||0x0,'visitNum':_0xfe0093?.[_0xb63221(0xde)]||0x0,'agreeNum':_0xfe0093?.[_0xb63221(0x1c3)]||0x0});}),_0x1a67d7;}async[_0x2cbf6e(0x18d)](_0x404f71,_0x31f98a,_0x661356){const _0x2b010e=_0x2cbf6e;if(!_0x31f98a[_0x2b010e(0x119)])return[];const _0x4fc589=await this['chatLogEntity'][_0x2b010e(0x1a7)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x31f98a)}});if(!_0x4fc589[_0x2b010e(0x119)])return[];const _0x3bdccf=await this[_0x2b010e(0xb5)](_0x404f71['user']['id'],_0x31f98a,_0x661356),_0x1f415e=new Map(),_0x454393=_0x4fc589['map'](_0x4e1f98=>_0x4e1f98[_0x2b010e(0x176)])['filter'](_0x100101=>_0x100101);if(_0x454393[_0x2b010e(0x119)]){const _0x2f1f99=(await this[_0x2b010e(0x179)][_0x2b010e(0x108)](_0x454393))['map'](_0x403cc8=>{return{'id':_0x403cc8['id'],'nickname':_0x403cc8['nickname'],'avatar':_0x403cc8['avatar']};});_0x2f1f99[_0x2b010e(0x1bb)](_0x441d11=>_0x1f415e[_0x2b010e(0x1d1)](_0x441d11['id'],_0x441d11));}return _0x4fc589['map'](_0x537cd5=>{const _0x1d2349=_0x2b010e;return{..._0x537cd5,'userInfo':_0x1f415e[_0x1d2349(0xba)](_0x537cd5[_0x1d2349(0x176)]),'children':_0x3bdccf[_0x1d2349(0xba)](_0x537cd5['id'])||[]};});}async['listAssetsBychatLogIds'](_0x251257){const _0x9e4c22=_0x2cbf6e;if(!_0x251257[_0x9e4c22(0x119)])return[];return this['aiAssetsEntity']['find']({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x251257)}});}async[_0x2cbf6e(0x11c)](_0x546cf0,_0x19451f){const _0x433b49=_0x2cbf6e;let _0xd22364=collectType_constant_1[_0x433b49(0x174)][_0x433b49(0x11e)];_0x19451f[_0x433b49(0xb1)]==model_constant_1[_0x433b49(0x1cf)][_0x433b49(0x1dc)]&&(_0xd22364=collectType_constant_1[_0x433b49(0x174)]['MUSIC']);const _0xaaf91=await this[_0x433b49(0x179)]['collectPage'](_0x19451f[_0x433b49(0x10a)],_0x19451f[_0x433b49(0x127)],_0x546cf0[_0x433b49(0xbc)]['id'],collectType_constant_1[_0x433b49(0x174)][_0x433b49(0x11e)]);if(_0xaaf91[_0x433b49(0x195)]==0x0)return{'count':0x0,'records':[]};return await this[_0x433b49(0x14f)](_0x546cf0,_0x19451f,_0xaaf91[_0x433b49(0x14c)][_0x433b49(0x104)](_0x53c62d=>_0x53c62d[_0x433b49(0xf4)]));}async[_0x2cbf6e(0x15a)](_0x462f03,_0xf07fc9){const _0x1d2fc4=_0x2cbf6e;try{const _0x22427e={'isDelete':![],'role':_0x1d2fc4(0x17f),'userId':_0x462f03[_0x1d2fc4(0xbc)]['id'],'modelType':_0xf07fc9['modelType']};_0xf07fc9[_0x1d2fc4(0x16f)]?_0x22427e[_0x1d2fc4(0x16f)]=_0xf07fc9[_0x1d2fc4(0x16f)]:_0xf07fc9['modelType']===model_constant_1[_0x1d2fc4(0x1cf)][_0x1d2fc4(0x1dc)]&&(_0x22427e[_0x1d2fc4(0x16f)]=_0x1d2fc4(0x13a));const [_0x4d0118,_0x214b17]=await this['chatLogEntity']['findAndCount']({'where':_0x22427e,'take':_0xf07fc9[_0x1d2fc4(0x127)],'skip':(_0xf07fc9[_0x1d2fc4(0x10a)]-0x1)*_0xf07fc9[_0x1d2fc4(0x127)],'order':{'createdAt':_0x1d2fc4(0x1a1)}}),_0x45281e=_0x4d0118[_0x1d2fc4(0x104)](_0x4c4c19=>_0x4c4c19['id']),_0x361354=await this[_0x1d2fc4(0xb5)](_0x462f03[_0x1d2fc4(0xbc)]['id'],_0x45281e,_0xf07fc9[_0x1d2fc4(0xb1)]),_0x144717=_0x4d0118['map'](_0x2048cb=>{const _0x1e75aa=_0x1d2fc4;return{..._0x2048cb,'children':_0x361354[_0x1e75aa(0xba)](_0x2048cb['id'])||[]};});return{'count':_0x214b17,'records':_0x144717};}catch(_0x5de844){throw new common_1[(_0x1d2fc4(0x120))](_0x5de844[_0x1d2fc4(0x15e)],common_1[_0x1d2fc4(0x10b)][_0x1d2fc4(0x1af)]);}}async[_0x2cbf6e(0x145)](_0x51b1f3,_0x9152f4){const _0x5289b7=_0x2cbf6e;if(!_0x9152f4['ids']['length'])return!![];return await this['aiAssetsEntity'][_0x5289b7(0x139)]({'userId':_0x51b1f3['user']['id'],'id':(0x0,typeorm_2['In'])(_0x9152f4['ids'])},{'deleteFlag':0x1}),!![];}async[_0x2cbf6e(0x1a0)](_0x5c6f12,_0xe4f659){const _0x25c85c=_0x2cbf6e;if(!_0xe4f659[_0x25c85c(0x1a5)])return!![];return await this[_0x25c85c(0x125)]['query'](_0x25c85c(0x112)+_0x5c6f12[_0x25c85c(0xbc)]['id']+_0x25c85c(0xd7)+_0xe4f659[_0x25c85c(0x1a5)][_0x25c85c(0xbd)]()+_0x25c85c(0xc8)),!![];}async[_0x2cbf6e(0x14f)](_0x1a6f31,_0x3e19f5,_0x4b78c6=[]){const _0x239e43=_0x2cbf6e;let _0x518500=(0x0,utils_1[_0x239e43(0xd9)])(this[_0x239e43(0xb2)]);if(!_0x518500||!_0x1a6f31[_0x239e43(0xbc)]){const _0x1ab2ec=this[_0x239e43(0x179)]['getUserInfoFromHeader'](_0x1a6f31);_0x518500=_0x1ab2ec?.['id'],_0x1a6f31[_0x239e43(0xbc)]=_0x1ab2ec;}try{const {page:page=0x1,size:size=0x14,order:_0x22b067,keyword:_0x564bad,modelType:_0x2b3a46,modelSubType:_0x47ba18,classify:_0x2af22d}=_0x3e19f5;let _0x54c05b=_0x239e43(0x141);if(_0x22b067===_0x239e43(0x166))_0x54c05b=_0x239e43(0x184);else _0x22b067===_0x239e43(0x1c3)&&(_0x54c05b=_0x239e43(0x10d));const _0x2d93e5=await this[_0x239e43(0x125)][_0x239e43(0x18e)](_0x239e43(0x1b6)+_0x2b3a46+_0x239e43(0xb4)+(_0x47ba18?_0x239e43(0xf7)+_0x47ba18+'\x27':'')+_0x239e43(0x12f)+(_0x2af22d?_0x239e43(0x13f)+_0x2af22d+'\x27\x20':'')+_0x239e43(0xdf)+(_0x564bad?_0x239e43(0x138)+_0x564bad+_0x239e43(0x13e):'')+_0x239e43(0xcb)+(_0x4b78c6&&_0x4b78c6[_0x239e43(0x119)]?'\x20AND\x20aa.id\x20in\x20('+_0x4b78c6[_0x239e43(0x1ca)]()+')\x20':'')+_0x239e43(0x142)),_0x41e49d=await this[_0x239e43(0x125)]['query'](_0x239e43(0x118)+_0x2b3a46+_0x239e43(0xb4)+(_0x47ba18?_0x239e43(0xf7)+_0x47ba18+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27'+_0x2b3a46+_0x239e43(0x167)+(_0x2af22d?_0x239e43(0x13f)+_0x2af22d+'\x27\x20':'')+_0x239e43(0x196)+(_0x564bad?'AND\x20aa.title\x20LIKE\x20(\x27%'+_0x564bad+_0x239e43(0x189):'')+_0x239e43(0xaf)+(_0x4b78c6&&_0x4b78c6['length']?'\x20AND\x20aa.id\x20in\x20('+_0x4b78c6[_0x239e43(0x1ca)]()+')\x20':'')+_0x239e43(0x124)+_0x54c05b+_0x239e43(0xeb)+size+_0x239e43(0x123)+(page-0x1)*size+_0x239e43(0x1ba)),_0x4dcb41=_0x41e49d[_0x239e43(0x104)](_0x31bf4c=>_0x31bf4c['id']),_0x48454e=await this[_0x239e43(0x1cc)][_0x239e43(0xc5)](_0x518500,_0x4dcb41,_0x2b3a46),_0x57d361=await this['aiLogService'][_0x239e43(0x19a)](_0x4dcb41,_0x2b3a46),_0xd7ccc8=new Map(),_0x122536=_0x41e49d[_0x239e43(0x104)](_0x161f11=>_0x161f11[_0x239e43(0x176)])[_0x239e43(0x19e)](_0x19f096=>_0x19f096);if(_0x122536[_0x239e43(0x119)]){const _0x2f69ee=(await this[_0x239e43(0x179)][_0x239e43(0x108)](_0x122536))[_0x239e43(0x104)](_0xeb1741=>{const _0x2d3eb3=_0x239e43;return{'id':_0xeb1741['id'],'nickname':_0xeb1741['nickname'],'avatar':_0xeb1741[_0x2d3eb3(0x133)]};});_0x2f69ee[_0x239e43(0x1bb)](_0x4239d9=>_0xd7ccc8[_0x239e43(0x1d1)](_0x4239d9['id'],_0x4239d9));}_0x41e49d[_0x239e43(0x1bb)](_0x566194=>{const _0x18ae94=_0x239e43,_0x34aa82=_0x57d361[_0x18ae94(0xba)](_0x566194['id']);_0x566194['agree']=_0x48454e[_0x18ae94(0xba)](_0x566194['id'])||null,_0x566194[_0x18ae94(0x100)]=_0xd7ccc8[_0x18ae94(0xba)](_0x566194['userId']),_0x566194['agreeNum']=_0x34aa82?.[_0x18ae94(0x1c3)]||0x0;});if(_0x3e19f5[_0x239e43(0xb1)]==model_constant_1[_0x239e43(0x1cf)][_0x239e43(0x11e)]){let _0x444e17=await this[_0x239e43(0x179)][_0x239e43(0x129)](_0x41e49d,_0x1a6f31,collectType_constant_1[_0x239e43(0x174)][_0x239e43(0x11e)]);return _0x444e17=await this[_0x239e43(0x179)]['mergeCollectCountData'](_0x41e49d,collectType_constant_1[_0x239e43(0x174)]['VIDEO']),{'records':_0x444e17,'count':Number(_0x2d93e5[0x0]?.[_0x239e43(0x195)]||0x0)};}else{if(_0x3e19f5[_0x239e43(0xb1)]==model_constant_1[_0x239e43(0x1cf)]['MUSIC']){let _0x2da2d6=await this[_0x239e43(0x179)][_0x239e43(0x129)](_0x41e49d,_0x1a6f31,collectType_constant_1[_0x239e43(0x174)][_0x239e43(0x1dc)]);return _0x2da2d6=await this[_0x239e43(0x179)]['mergeCollectCountData'](_0x41e49d,collectType_constant_1[_0x239e43(0x174)][_0x239e43(0x11e)]),{'records':_0x2da2d6,'count':Number(_0x2d93e5[0x0]?.[_0x239e43(0x195)]||0x0)};}}return{'records':_0x41e49d,'count':Number(_0x2d93e5[0x0]?.[_0x239e43(0x195)]||0x0)};}catch(_0x3fddac){throw new common_1['HttpException'](_0x3fddac[_0x239e43(0x15e)],common_1[_0x239e43(0x10b)]['BAD_REQUEST']);}}async['assetsDetail'](_0x3f893a,_0x11544d){const _0x5ea472=_0x2cbf6e,_0x57d6d4=(0x0,utils_1[_0x5ea472(0xd9)])(this[_0x5ea472(0xb2)]);try{const _0x112704=await this['connection']['query'](_0x5ea472(0xbb)+_0x3f893a+_0x5ea472(0x1ba)),_0x29caf1=_0x112704['map'](_0x3acc18=>_0x3acc18['id']),_0x6be4be=await this[_0x5ea472(0x1cc)][_0x5ea472(0xc5)](_0x57d6d4,_0x29caf1,_0x11544d),_0x3f55f9=new Map(),_0x4bb2f8=_0x112704[_0x5ea472(0x104)](_0x571c28=>_0x571c28[_0x5ea472(0x176)])[_0x5ea472(0x19e)](_0x1ad0a1=>_0x1ad0a1);if(_0x4bb2f8['length']){const _0x576aa1=(await this['userService'][_0x5ea472(0x108)](_0x4bb2f8))[_0x5ea472(0x104)](_0xf4025c=>{const _0x3228b8=_0x5ea472;return{'id':_0xf4025c['id'],'nickname':_0xf4025c[_0x3228b8(0x1aa)],'avatar':_0xf4025c[_0x3228b8(0x133)]};});_0x576aa1[_0x5ea472(0x1bb)](_0x54dcb1=>_0x3f55f9[_0x5ea472(0x1d1)](_0x54dcb1['id'],_0x54dcb1));}return _0x112704[_0x5ea472(0x1bb)](_0x1577ca=>{const _0x33e91e=_0x5ea472;_0x1577ca[_0x33e91e(0x186)]=_0x6be4be[_0x33e91e(0xba)](_0x1577ca['id'])||null,_0x1577ca[_0x33e91e(0x100)]=_0x3f55f9[_0x33e91e(0xba)](_0x1577ca['userId']);}),{..._0x112704[0x0]};}catch(_0x1b8ab4){throw new common_1[(_0x5ea472(0x120))](_0x1b8ab4[_0x5ea472(0x15e)],common_1[_0x5ea472(0x10b)][_0x5ea472(0x1af)]);}}async[_0x2cbf6e(0x17b)](_0x5b3ec2,_0x1a004b){const _0x3f1266=_0x2cbf6e,{id:_0x1a6482}=_0x5b3ec2[_0x3f1266(0xbc)],{groupId:_0x2d28e6}=_0x1a004b,_0x413b85={'userId':_0x1a6482,'isDelete':![]};_0x2d28e6&&Object[_0x3f1266(0x17c)](_0x413b85,{'groupId':_0x2d28e6});const _0x4842cf=await this[_0x3f1266(0x1cd)][_0x3f1266(0x1a7)]({'where':_0x413b85});return _0x4842cf[_0x3f1266(0x104)](_0x1d0718=>{const _0x25069a=_0x3f1266,{prompt:_0x9f1cab,role:_0x30d805,answer:_0x336c0b,createdAt:_0x5b61d4,model:_0x4aac79,conversationOptions:_0x14694e,requestOptions:_0x314d04,id:_0x4c41cf}=_0x1d0718;return{'chatId':_0x4c41cf,'dateTime':(0x0,utils_1[_0x25069a(0x1d2)])(_0x5b61d4),'text':_0x30d805===_0x25069a(0xbc)?_0x9f1cab:_0x336c0b,'inversion':_0x30d805==='user','error':![],'conversationOptions':_0x14694e?JSON[_0x25069a(0xbf)](_0x14694e):null,'requestOptions':_0x314d04?JSON[_0x25069a(0xbf)](_0x314d04):null};});}async[_0x2cbf6e(0x14a)](_0x423105,_0x3dbee6){const _0x14d044=_0x2cbf6e,{id:_0x455b6e}=_0x423105[_0x14d044(0xbc)],{id:_0x5c9ee9}=_0x3dbee6,_0x302d13=await this[_0x14d044(0x1cd)]['findOne']({'where':{'id':_0x5c9ee9,'userId':_0x455b6e}});if(!_0x302d13)throw new common_1[(_0x14d044(0x120))](_0x14d044(0x1a4),common_1[_0x14d044(0x10b)][_0x14d044(0x1af)]);const _0x1f0446=await this['chatLogEntity']['update']({'id':_0x5c9ee9},{'isDelete':!![]});await this[_0x14d044(0xdc)][_0x14d044(0x139)]({'userId':_0x423105[_0x14d044(0xbc)]['id'],'chatLogId':_0x5c9ee9},{'deleteFlag':0x1});if(_0x1f0446[_0x14d044(0x173)]>0x0)return _0x14d044(0x18f);else throw new common_1[(_0x14d044(0x120))]('‰Ω†Âà†Èô§ÁöÑÂØπËØùËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ',common_1['HttpStatus']['BAD_REQUEST']);}async[_0x2cbf6e(0x11a)](_0x51aeac,_0x56d98b){const _0x3726bd=_0x2cbf6e,{groupId:_0x450021,type:_0x56f948}=_0x56d98b,{id:_0x1edb3d}=_0x51aeac[_0x3726bd(0xbc)],_0x2afabb=_0x56f948&&_0x56f948===_0x3726bd(0x1bf)?{'groupId':_0x450021,'userId':_0x1edb3d}:{'groupId':_0x450021,'userId':_0x1edb3d},_0x42ba46=await this[_0x3726bd(0x1cd)][_0x3726bd(0x1ae)](_0x2afabb);if(_0x42ba46[_0x3726bd(0x173)]>0x0)return!![];if(_0x42ba46[_0x3726bd(0x173)]===0x0)throw new common_1[(_0x3726bd(0x120))](_0x3726bd(0xf5),common_1[_0x3726bd(0x10b)]['BAD_REQUEST']);}async['removeLogsBatch'](_0x42e2a2){const _0x23e8e9=_0x2cbf6e,{ids:_0x3afae7,userId:_0x531b5f}=_0x42e2a2;return await this['chatLogEntity'][_0x23e8e9(0x1ae)]({'groupId':(0x0,typeorm_2['In'])(_0x3afae7),'userId':_0x531b5f});}async[_0x2cbf6e(0x1b8)](_0x1f15dc,_0x234e8d){const _0x5ce03a=_0x2cbf6e,{id:_0x35a1a6}=_0x1f15dc[_0x5ce03a(0xbc)],{appId:_0x13e20a,page:page=0x1,size:size=0xa}=_0x234e8d,[_0x3c05a5,_0x218fb1]=await this[_0x5ce03a(0x1cd)][_0x5ce03a(0x17e)]({'where':{'userId':_0x35a1a6,'appId':_0x13e20a,'role':'assistant'},'order':{'id':_0x5ce03a(0x1a1)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x3c05a5,'count':_0x218fb1};}async[_0x2cbf6e(0x117)](_0x4db0b9,_0x3261c7){const _0x5d1549=_0x2cbf6e,_0xe1a9b1=_0x4db0b9[_0x5d1549(0xbc)]['id'],_0x23af65=await this[_0x5d1549(0x1cd)][_0x5d1549(0xcd)]({'where':{'userId':_0xe1a9b1,'id':_0x3261c7}});if(!_0x23af65)return'';return{'chatId':_0x23af65['id'],'dateTime':(0x0,utils_1[_0x5d1549(0x1d2)])(_0x23af65[_0x5d1549(0x160)]),'text':_0x23af65[_0x5d1549(0x143)]===_0x5d1549(0xbc)?_0x23af65[_0x5d1549(0x17a)]:_0x23af65['answer'],'textMp3':_0x23af65[_0x5d1549(0x171)],'inversion':_0x23af65[_0x5d1549(0x143)]==='user'};}async[_0x2cbf6e(0x168)](_0x2eeb3b,_0x599594){const _0x1fb01f=_0x2cbf6e,_0x2e2e0f=_0x2eeb3b[_0x1fb01f(0xbc)]['id'],_0x457f8e=await this[_0x1fb01f(0x1cd)]['findOne']({'where':{'userId':_0x2e2e0f,'id':_0x599594}});if(!_0x457f8e)return'';return _0x457f8e['answer'];}async[_0x2cbf6e(0x172)](){const _0xc469e1=_0x2cbf6e,_0xc3efa3=await this[_0xc469e1(0x125)][_0xc469e1(0x18e)](_0xc469e1(0x185));return _0xc3efa3;}async['listUndoneVideoForJMeng'](){const _0x1c4408=_0x2cbf6e,_0x2a6590=await this[_0x1c4408(0x125)][_0x1c4408(0x18e)](_0x1c4408(0x10e));return _0x2a6590;}async['refundVideo'](_0x3c1a89){const _0x4daf18=_0x2cbf6e,_0xaaf2c=await this[_0x4daf18(0x17d)][_0x4daf18(0x1be)](_0x3c1a89['modelId']);_0xaaf2c&&this['userService']['refundBalance4Video'](_0x3c1a89[_0x4daf18(0x176)],_0xaaf2c,_0x3c1a89['requestParams'],_0x3c1a89['id']);}async['videoNotify'](_0x2ba4b3){const _0x5a21a8=_0x2cbf6e,_0xff6de7=await this[_0x5a21a8(0xdc)][_0x5a21a8(0xcd)]({'where':{'sunoMusicId':_0x2ba4b3['id']}});if(!_0xff6de7)return;const _0x309dd5=await this[_0x5a21a8(0x1cd)][_0x5a21a8(0xcd)]({'where':{'id':_0xff6de7[_0x5a21a8(0x1c1)]}});_0x309dd5[_0x5a21a8(0x198)]=_0x2ba4b3[_0x5a21a8(0xc9)],_0xff6de7[_0x5a21a8(0xb6)]=_0x2ba4b3['video']?.[_0x5a21a8(0xce)],await this['chatLogEntity'][_0x5a21a8(0xf8)](_0x309dd5),await this[_0x5a21a8(0xdc)][_0x5a21a8(0xf8)](_0xff6de7);if(_0x309dd5[_0x5a21a8(0x198)]===_0x5a21a8(0x147)&&_0xff6de7[_0x5a21a8(0xb6)])this[_0x5a21a8(0xc4)](_0xff6de7);else _0x309dd5[_0x5a21a8(0x198)]===_0x5a21a8(0x188)&&this[_0x5a21a8(0xc2)](_0x309dd5);}async['videoNotifyRunway'](_0x3d0f1b){const _0x1f3466=_0x2cbf6e;console[_0x1f3466(0xcf)](_0x1f3466(0x136),_0x3d0f1b);const _0x5cb20b=await this[_0x1f3466(0xdc)][_0x1f3466(0xcd)]({'where':{'sunoMusicId':_0x3d0f1b[_0x1f3466(0x170)]}});if(!_0x5cb20b)throw new Error(_0x1f3466(0xfb));const _0x3e7ae2=await this[_0x1f3466(0x1cd)][_0x1f3466(0xcd)]({'where':{'id':_0x5cb20b['chatLogId']}});_0x3e7ae2[_0x1f3466(0x198)]=_0x3d0f1b[_0x1f3466(0xc9)],_0x5cb20b[_0x1f3466(0xb6)]=_0x3d0f1b[_0x1f3466(0x18b)],await this[_0x1f3466(0x1cd)][_0x1f3466(0xf8)](_0x3e7ae2),await this[_0x1f3466(0xdc)][_0x1f3466(0xf8)](_0x5cb20b);if(_0x3d0f1b[_0x1f3466(0x1b3)]==='3'&&_0x5cb20b[_0x1f3466(0xb6)])this[_0x1f3466(0xc4)](_0x5cb20b);else _0x3e7ae2[_0x1f3466(0x198)]===_0x1f3466(0xfd)&&this['refundVideo'](_0x3e7ae2);}async[_0x2cbf6e(0x11b)](_0x295500){const _0x123264=_0x2cbf6e;console['log'](_0x123264(0x16c),_0x295500);const _0x4a9067=_0x295500['data']?_0x295500['data']:_0x295500,_0xa1a7ec=await this[_0x123264(0x1cd)]['findOne']({'where':{'message_id':_0x4a9067[_0x123264(0x170)]}});if(!_0xa1a7ec)throw new Error('ËµÑÊ∫ê‰∏çÂ≠òÂú®ÔºÅ');_0xa1a7ec[_0x123264(0x198)]=_0x4a9067[_0x123264(0x1c0)],_0x295500[_0x123264(0x1a9)]['images']&&(_0xa1a7ec[_0x123264(0x1a6)]=JSON[_0x123264(0x153)](_0x295500[_0x123264(0x1a9)][_0x123264(0x19b)]['map'](_0x36a3d9=>_0x36a3d9[_0x123264(0xce)])),await this[_0x123264(0x1cd)][_0x123264(0xf8)](_0xa1a7ec));}async[_0x2cbf6e(0x1d0)](_0x3e38ed){const _0x450e52=_0x2cbf6e;console[_0x450e52(0xcf)]('klingÈÄöÁü•Ôºö',_0x3e38ed);const _0x3a67fb=_0x3e38ed[_0x450e52(0x152)]?_0x3e38ed[_0x450e52(0x152)]:_0x3e38ed,_0x549444=await this['aiAssetsEntity'][_0x450e52(0xcd)]({'where':{'sunoMusicId':_0x3a67fb['task_id']}});if(!_0x549444)throw new Error(_0x450e52(0xfb));const _0x4d665f=await this[_0x450e52(0x1cd)][_0x450e52(0xcd)]({'where':{'id':_0x549444[_0x450e52(0x1c1)]}});_0x4d665f[_0x450e52(0x198)]=_0x3a67fb[_0x450e52(0x1c0)];_0x3a67fb[_0x450e52(0x1a9)]['videos']&&(_0x549444[_0x450e52(0xb6)]=_0x3a67fb[_0x450e52(0x1a9)][_0x450e52(0x1b7)][0x0]?.[_0x450e52(0xce)]);await this[_0x450e52(0x1cd)][_0x450e52(0xf8)](_0x4d665f),await this[_0x450e52(0xdc)]['save'](_0x549444);if(_0x4d665f[_0x450e52(0x198)]===_0x450e52(0x140)&&_0x549444[_0x450e52(0xb6)])this['syncVideo'](_0x549444);else _0x4d665f['answer']===_0x450e52(0xfd)&&this[_0x450e52(0xc2)](_0x4d665f);}async[_0x2cbf6e(0x163)](_0x3c72f3,_0x2b69ac){const _0x542cae=_0x2cbf6e;console[_0x542cae(0xcf)](_0x542cae(0xc1),_0x3c72f3);let _0x2881fb;_0x2b69ac===_0x542cae(0xe3)?(_0x2881fb=await this[_0x542cae(0x1cd)][_0x542cae(0xcd)]({'where':{'id':Number(_0x3c72f3[_0x542cae(0x170)])}}),_0x2881fb['answer']=_0x3c72f3['text']||_0x3c72f3[_0x542cae(0x152)]['text']):(_0x2881fb=await this[_0x542cae(0x1cd)]['findOne']({'where':{'message_id':_0x3c72f3['task_id']}}),_0x2881fb[_0x542cae(0x198)]=_0x3c72f3[_0x542cae(0x1b3)]);_0x2881fb[_0x542cae(0x198)]!=='timeout'&&await this['chatLogEntity'][_0x542cae(0xf8)](_0x2881fb);if(_0x2b69ac===_0x542cae(0x13a)){const _0x4fd7ba=await this[_0x542cae(0xdc)][_0x542cae(0x1a7)]({'where':{'chatLogId':_0x2881fb['id']}});for(const _0x4decb1 of _0x3c72f3[_0x542cae(0x152)]){const {title:_0x32e23f,prompt:_0x32953c,audio_url:_0x1d7377,image_url:_0x3a5eab,task_id:_0x1e0509,id:_0x2fde1c,video_url:_0x5bb40a,duration:_0x3d4d28}=_0x4decb1,_0x53b889=_0x1e0509?_0x4fd7ba['find'](_0x415076=>_0x415076[_0x542cae(0x101)]===_0x1e0509):_0x4fd7ba[_0x542cae(0x1a7)](_0x2cda3a=>_0x2cda3a[_0x542cae(0x101)]===_0x2fde1c);!_0x53b889?await this['aiAssetsEntity'][_0x542cae(0xf8)]({'title':_0x32e23f,'intro':_0x32953c||_0x4decb1[_0x542cae(0x1d6)][_0x542cae(0x17a)],'duration':_0x3d4d28||0x0,'mp3':_0x1d7377||'','mp4':_0x5bb40a||'','cover':_0x3a5eab||'','sunoMusicId':_0x1e0509||_0x2fde1c,'chatLogId':_0x2881fb['id'],'userId':_0x2881fb[_0x542cae(0x176)]}):(_0x53b889['title']=_0x32e23f,_0x53b889['intro']=_0x32953c||_0x4decb1[_0x542cae(0x1d6)]['prompt'],_0x53b889['mp3']=_0x1d7377||'',_0x53b889[_0x542cae(0xb6)]=_0x5bb40a||'',_0x53b889['cover']=_0x3a5eab||'',await this[_0x542cae(0xdc)][_0x542cae(0xf8)](_0x53b889));}}}async['syncVideoTest'](_0x41f052){const _0x4da29a=_0x2cbf6e,_0x177450=await this[_0x4da29a(0xdc)][_0x4da29a(0xcd)]({'where':{'id':_0x41f052}}),[_0x4fe6a8,_0x1d55f7]=await this[_0x4da29a(0xb0)]['transferAndCover'](_0x177450['mp4']);return console['log']('-----------TEST--------',_0x1d55f7),!![];}async[_0x2cbf6e(0xc4)](_0x9159de){const _0x186fa0=_0x2cbf6e,[_0x2a2b78,_0x3ab9b7]=await this[_0x186fa0(0xb0)][_0x186fa0(0x190)](_0x9159de[_0x186fa0(0xb6)]);_0x9159de[_0x186fa0(0xb6)]=_0x2a2b78,_0x9159de[_0x186fa0(0x150)]=_0x3ab9b7,await this['aiAssetsEntity'][_0x186fa0(0xf8)](_0x9159de);}async[_0x2cbf6e(0xea)](){const _0x46d820=_0x2cbf6e,_0xf0de09=await this[_0x46d820(0xdc)][_0x46d820(0x1a7)]({'where':[{'cover':(0x0,typeorm_2[_0x46d820(0x1b5)])(_0x46d820(0xd0))},{'mp3':(0x0,typeorm_2[_0x46d820(0x1b5)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x46d820(0x1b5)])(_0x46d820(0xd0))},{'mp4':(0x0,typeorm_2[_0x46d820(0x1b5)])(_0x46d820(0x175))}]});for(let _0xa6414b=0x0;_0xa6414b<_0xf0de09[_0x46d820(0x119)];_0xa6414b++){const _0x3248f0=_0xf0de09[_0xa6414b],_0x5a05ba=redisKey_constant_1[_0x46d820(0x14e)]+_0x3248f0['id'];try{const _0x3abce8=await this['redisCacheService'][_0x46d820(0xba)]({'key':_0x5a05ba});if(_0x3abce8)continue;await this[_0x46d820(0x154)][_0x46d820(0x1d1)]({'key':_0x5a05ba,'val':'lock'});const {cover:_0xd6edf1,mp3:_0x3fcb2c,mp4:_0x4b4fcf}=_0x3248f0;/filesystem.site/[_0x46d820(0x156)](_0xd6edf1)&&(_0x3248f0[_0x46d820(0x150)]=await this[_0x46d820(0xb0)][_0x46d820(0x116)](_0xd6edf1));/filesystem.site/['test'](_0x3fcb2c)&&(_0x3248f0[_0x46d820(0x151)]=await this[_0x46d820(0xb0)][_0x46d820(0x116)](_0x3fcb2c));if(/filesystem.site|storage.cdn-luma.com/['test'](_0x4b4fcf)){if(_0xd6edf1)_0x3248f0[_0x46d820(0xb6)]=await this[_0x46d820(0xb0)]['transferFile'](_0x4b4fcf);else{const [_0x37919e,_0x58d62e]=await this['fileService'][_0x46d820(0x190)](_0x4b4fcf);_0x3248f0[_0x46d820(0xb6)]=_0x37919e,_0x3248f0[_0x46d820(0x150)]=_0x58d62e;}}await this['aiAssetsEntity'][_0x46d820(0xf8)](_0x3248f0);}catch(_0x2db61d){common_1[_0x46d820(0x10f)][_0x46d820(0xee)](_0x2db61d);}finally{await this[_0x46d820(0x154)]['del']({'key':_0x5a05ba});}}}async[_0x2cbf6e(0x1dd)](_0x382dbe,_0x54f7f4){const _0x281e8d=_0x2cbf6e,_0x3efa6c=await this[_0x281e8d(0x1cd)]['query'](_0x281e8d(0x1cb)+_0x382dbe+_0x281e8d(0x111)+_0x54f7f4[_0x281e8d(0xbd)]()+'\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20');return _0x3efa6c;}async[_0x2cbf6e(0x132)](){const _0x2205a5=_0x2cbf6e,_0x4356d7=await this['modelsService'][_0x2205a5(0x10c)](model_constant_1[_0x2205a5(0x1cf)][_0x2205a5(0x1dc)]);try{const _0x213644=store_1[_0x2205a5(0x157)][_0x2205a5(0x1ac)]||0x5,_0x56f48e=await this[_0x2205a5(0x1cd)][_0x2205a5(0x1a7)]({'where':{'role':_0x2205a5(0x17f),'modelType':model_constant_1[_0x2205a5(0x1cf)][_0x2205a5(0x1dc)],'answer':(0x0,typeorm_2['In'])([_0x2205a5(0x15d),'']),'updatedAt':(0x0,typeorm_2['LessThan'])(new Date(Date[_0x2205a5(0x1c4)]()-_0x213644*0x3c*0x3e8))}});_0x56f48e[_0x2205a5(0x1bb)](async _0x4c6d24=>{const _0x2d54ec=_0x2205a5;_0x4c6d24['answer']='timeout',_0x4c6d24[_0x2d54ec(0x15c)]=_0x2d54ec(0x16d),this[_0x2d54ec(0x1cd)][_0x2d54ec(0xf8)](_0x4c6d24),await this[_0x2d54ec(0xdc)]['update']({'chatLogId':_0x4c6d24['id']},{'deleteFlag':0x1}),this[_0x2d54ec(0x179)]['debuctBalance4Muisc'](_0x4c6d24[_0x2d54ec(0x176)],_0x4c6d24['id'],_0x4c6d24['modelSubType'],!![]);});}catch(_0x53e79a){common_1[_0x2205a5(0x10f)][_0x2205a5(0xee)](_0x53e79a);}}async[_0x2cbf6e(0xef)](){const _0x22f460=_0x2cbf6e,_0x4c44c7=await this[_0x22f460(0x18a)]();if(!_0x4c44c7[_0x22f460(0x119)])return;const _0x213024=await this[_0x22f460(0x17d)]['getModelInfoByKeyType'](model_constant_1['EModelType'][_0x22f460(0x11e)],'5'),_0x435650=new openapi_1[(_0x22f460(0x121))]({'serviceName':'cv','region':'cn-north-1','host':_0x213024['modelInfo'][_0x22f460(0x192)],'accessKeyId':_0x213024['modelInfo'][_0x22f460(0x1d9)],'secretKey':_0x213024[_0x22f460(0x114)][_0x22f460(0x187)]}),_0x3a9a5b=_0x435650[_0x22f460(0x134)]('CVSync2AsyncGetResult',{'Version':_0x22f460(0xfa),'method':_0x22f460(0xb7),'contentType':_0x22f460(0xfc)});for(const _0x54d3fd of _0x4c44c7){if(_0x54d3fd[_0x22f460(0x162)])try{const _0xd66633=await _0x3a9a5b({'req_key':_0x54d3fd['model'],'task_id':_0x54d3fd['message_id']});console[_0x22f460(0xcf)](_0x22f460(0xf9),_0xd66633);if(_0xd66633[_0x22f460(0x1b3)]==_0x22f460(0x1bd)){_0x54d3fd[_0x22f460(0x198)]=_0xd66633[_0x22f460(0x152)][_0x22f460(0x1b3)]==_0x22f460(0x15f)?'succeed':_0xd66633[_0x22f460(0x152)][_0x22f460(0x1b3)];const _0x873d4c=await this[_0x22f460(0xdc)]['findOne']({'where':{'chatLogId':_0x54d3fd['id']}}),_0x10051b=_0xd66633[_0x22f460(0x152)]?.[_0x22f460(0x18b)];_0x873d4c[_0x22f460(0x150)]=_0xd66633['data']?.[_0x22f460(0x11d)],_0x873d4c['mp4']=_0x10051b,await this['aiAssetsEntity'][_0x22f460(0xf8)](_0x873d4c),await this['chatLogEntity'][_0x22f460(0xf8)](_0x54d3fd),this[_0x22f460(0xc4)](_0x873d4c);}}catch(_0x2e0f00){console[_0x22f460(0xcf)](_0x22f460(0x199),_0x2e0f00);}}}};ChatLogService=__decorate([(0x0,common_1[_0x2cbf6e(0x149)])(),__param(0x0,(0x0,typeorm_1[_0x2cbf6e(0x169)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x2cbf6e(0x169)])(aiAssets_entity_1['AiAssetsEntity'])),__metadata(_0x2cbf6e(0x1ad),[typeorm_2[_0x2cbf6e(0xe6)],typeorm_2[_0x2cbf6e(0xe6)],nestjs_cls_1[_0x2cbf6e(0x19f)],file_service_1[_0x2cbf6e(0x15b)],aiLog_service_1[_0x2cbf6e(0x128)],redisCache_service_1['RedisCacheService'],user_service_1[_0x2cbf6e(0xe5)],models_service_1[_0x2cbf6e(0xf2)],typeorm_2['Connection']])],ChatLogService),exports[_0x2cbf6e(0xf1)]=ChatLogService;function _0xe82a(){const _0x58e78f=['‰Ω†Âà†Èô§ÁöÑÂØπËØùËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','ids','fileInfo','find','Ôºö**','task_result','nickname','includes','musicTimeoutMs','design:paramtypes','delete','BAD_REQUEST','Not','querAllDrawLog','**Ê≠åËØçÔºö**','status','nestjs-cls','Like','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','videos','byAppId','requestParams','\x0a\x20\x20\x20\x20\x20\x20','forEach','function','10000','getModelById','gpts','task_status','chatLogId','../../common/constants/redisKey.constant','agreeNum','now','push','../../common/utils','isDefined','Èü≥‰πêÁîüÊàêÈîôËØØÔºö','51676kBzrIN','toString','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','aiLogService','chatLogEntity','cos','EModelType','videoNotifyKLing','set','formatDate','595aLrFhd','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','isDelete\x20=\x200','metadata','**ÁâàÊú¨ID','./entity/chatLog.entity','key','isPlatform','type','MUSIC','getLastByUserAndAppIds','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','fileService','modelType','clsService','class-validator','\x27\x20\x20','getMusicVoMap','mp4','POST','ÂõæÁâáÊàêÂäüÔºÅ','__param','get','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20and\x20aa.id=','user','join','extend','parse','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','sunoÈÄöÁü•Ôºö','refundVideo','./entity/aiAssets.entity','syncVideo','getAgreeMap','###üéµ\x20Ê≠åÊõ≤Âêç','chatList',')\x0a\x20\x20\x20\x20','state','defineProperty','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','parseAndSaveVideo','findOne','url','log','%filesystem.site%','recDrawImg','getOwnPropertyDescriptor','\x0a\x20\x20\x20\x20','paintCount','../../common/constants/model.constant','=======================‰øùÂ≠òËßÜÈ¢ëÂÖ•Â∫ì====================','\x20AND\x20id\x20IN\x20(','replace','getUserId','email','drawDetail','aiAssetsEntity','has','visitNum','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','object','---','lyrics','DeductionKey','UserService','Repository','```','-------------------------ChatALL----------','../user/user.service','syncAssets','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','isGroup','delChatLog','error','syncJMengTask','?x-oss-process=image/resize,w_','ChatLogService','ModelsService','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','relId','ÂΩìÂâçÈ°µÈù¢Â∑≤ÁªèÊ≤°Êúâ‰∏úË•øÂèØ‰ª•Âà†Èô§‰∫ÜÔºÅ','catch','and\x20cl.modelSubType=\x27','save','-------------------Âç≥Ê¢¶ËßÜÈ¢ë------------------','2022-08-31','ËµÑÊ∫ê‰∏çÂ≠òÂú®ÔºÅ','json','failed','__esModule','10734bFpJxT','userInfo','sunoMusicId','@nestjs/typeorm','‰Ω†Êé®ËçêÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','map','4848646vcOMfh','draw','parseAndSaveMusic','getUserListByIds','35KTJuIi','page','HttpStatus','getModelByType','ale.agree_num','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x275\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27done\x27,\x20\x27failed\x27,\x27succeed\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','Logger','Ëß£ÊûêÈîôËØØ','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','?imageView2/1/w/','modelInfo','substring','transferFile','byId','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','length','delByGroupId','videoNotifyKLingImage','collectPage','image_urls','VIDEO','returnDrawDetail','HttpException','Service','thumbImg','\x20OFFSET\x20','\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','connection','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','size','AiLogService','mergeCollectData','../aiLog/aiLog.service','decorate','listByGroupId','1979830SrgaLn','saveChatLog','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','3488967SmQruV','publishFlag','batchMusicResult','avatar','createAPI','phone','runwayÈÄöÁü•Ôºö','2yiifqL','\x20AND\x20aa.title\x20LIKE\x20(\x27%','update','create','classify','components','keyType','%\x27)\x20','\x20AND\x20aa.classify=\x27','succeed','aa.createdAt','\x20\x0a\x20\x20\x20\x20\x20\x20','role','startsWith','assetsDel','@nestjs/common','completed','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','Injectable','deleteChatLog','\x20\x0a\x20\x20\x20\x20','rows','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','MUSIC_TRANSFER','assetsSquare','cover','mp3','data','stringify','redisCacheService','split','test','MusicConfig','maskEmail','match','chatTaskLog','FileService','errMsg','IN_PROGRESS','message','done','createdAt','PAINT_TYPE','message_id','videoNotifySuno','982389MiKbdy','getReqSaasId','playNum','\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','byChatlogId','InjectRepository','model','indexOf','klingImageÈÄöÁü•Ôºö','timeout','../file/file.service','modelSubType','task_id','answerMp3','listUndoneVideoForLuma','affected','UserCollectType','%storage.cdn-luma.com%','userId','querDrawLogPage','tencent','userService','prompt','chatGptsList','assign','modelsService','findAndCount','assistant','8FGHOKn','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','/q/55','__decorate','ale.play_num','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x271\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','agree','secret','FAILED','%\x27)','listUndoneVideoForJMeng','video_url','‰Ω†Êìç‰ΩúÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','listByIds','query','Âà†Èô§ÂØπËØùËÆ∞ÂΩïÊàêÂäüÔºÅ','transferAndCover','239850ABbkEJ','proxyUrl','../../common/constants/balance.constant','../../common/constants/collectType.constant','count','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','ali','answer','----------Âç≥Ê¢¶ËßÜÈ¢ëÈîôËØØ---------','getExtByRelate','images','querDrawLog','../models/models.service','filter','ClsService','assetsPublish','DESC','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','isSuper'];_0xe82a=function(){return _0x58e78f;};return _0xe82a();}