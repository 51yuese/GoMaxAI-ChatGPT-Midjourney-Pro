'use strict';function _0x4aec(_0x5056fa,_0x25c874){const _0x559d19=_0x559d();return _0x4aec=function(_0x4aec46,_0x118e16){_0x4aec46=_0x4aec46-0x15b;let _0x40f96e=_0x559d19[_0x4aec46];return _0x40f96e;},_0x4aec(_0x5056fa,_0x25c874);}const _0x5e18f5=_0x4aec;(function(_0x2d8620,_0x639126){const _0x7d9d4f=_0x4aec,_0x479877=_0x2d8620();while(!![]){try{const _0x7c21cb=-parseInt(_0x7d9d4f(0x20a))/0x1+parseInt(_0x7d9d4f(0x1be))/0x2*(-parseInt(_0x7d9d4f(0x271))/0x3)+-parseInt(_0x7d9d4f(0x1e4))/0x4*(-parseInt(_0x7d9d4f(0x28e))/0x5)+parseInt(_0x7d9d4f(0x242))/0x6+-parseInt(_0x7d9d4f(0x17e))/0x7*(-parseInt(_0x7d9d4f(0x21d))/0x8)+parseInt(_0x7d9d4f(0x22e))/0x9*(-parseInt(_0x7d9d4f(0x214))/0xa)+-parseInt(_0x7d9d4f(0x171))/0xb;if(_0x7c21cb===_0x639126)break;else _0x479877['push'](_0x479877['shift']());}catch(_0x2e525a){_0x479877['push'](_0x479877['shift']());}}}(_0x559d,0xb285e));var __decorate=this&&this[_0x5e18f5(0x18e)]||function(_0x357d4f,_0xa60cbd,_0x44de63,_0x4be3a9){const _0x3ce2c5=_0x5e18f5;var _0x419e3f=arguments[_0x3ce2c5(0x1c3)],_0x277a51=_0x419e3f<0x3?_0xa60cbd:_0x4be3a9===null?_0x4be3a9=Object[_0x3ce2c5(0x27b)](_0xa60cbd,_0x44de63):_0x4be3a9,_0x5db421;if(typeof Reflect===_0x3ce2c5(0x1f4)&&typeof Reflect[_0x3ce2c5(0x1de)]===_0x3ce2c5(0x20d))_0x277a51=Reflect[_0x3ce2c5(0x1de)](_0x357d4f,_0xa60cbd,_0x44de63,_0x4be3a9);else{for(var _0x2f9bb6=_0x357d4f['length']-0x1;_0x2f9bb6>=0x0;_0x2f9bb6--)if(_0x5db421=_0x357d4f[_0x2f9bb6])_0x277a51=(_0x419e3f<0x3?_0x5db421(_0x277a51):_0x419e3f>0x3?_0x5db421(_0xa60cbd,_0x44de63,_0x277a51):_0x5db421(_0xa60cbd,_0x44de63))||_0x277a51;}return _0x419e3f>0x3&&_0x277a51&&Object['defineProperty'](_0xa60cbd,_0x44de63,_0x277a51),_0x277a51;},__metadata=this&&this['__metadata']||function(_0x2251e0,_0x51175f){const _0x5db831=_0x5e18f5;if(typeof Reflect===_0x5db831(0x1f4)&&typeof Reflect[_0x5db831(0x1ba)]==='function')return Reflect[_0x5db831(0x1ba)](_0x2251e0,_0x51175f);},__param=this&&this[_0x5e18f5(0x1fb)]||function(_0x140960,_0x2a9881){return function(_0x2f8a7d,_0xd5adf4){_0x2a9881(_0x2f8a7d,_0xd5adf4,_0x140960);};};function _0x559d(){const _0x40cc2a=['sunoMusicId','video_url','deleteChatLog','ï¼š**','uploadUrl','title','json','error','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','removeLogsBatch','\x20AND\x20aa.id\x20in\x20(','-------------------Veoè§†é¢‘------------------','../../common/constants/redisKey.constant','207LxBrca','refundVideo','getMusicVoMap','delete','mergeCollectCountData','VIDEO','Logger','listUndoneVideoForJMeng','connection','status','completed','\x20\x0a\x20\x20\x20\x20','UserCollectType','email','now','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','HttpException','%\x27)','toString','phone','6188094zEvnWO','Repository','\x20AND\x20id\x20IN\x20(','\x20\x0a\x20\x20\x20\x20\x20\x20','AiAssetsEntity','aiLogService','rec','log','task_result','Request\x20failed','```','stringify','recDrawImg','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x275\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27done\x27,\x20\x27failed\x27,\x27succeed\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','key','-------------------åŒæ­¥Veoè§†é¢‘------------------','klingé€šçŸ¥ï¼š','\x27\x20\x20','Not','gpts','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','assetsDetail','getReqSaasId','fileInfo','mergeCollectData','%storage.cdn-luma.com%','model','**æ­Œè¯ï¼š**','split','userService','FAILED','DRAW','mergeThumb','affected','responseResult','getExtByRelate','mp3','draw','update','collectPage','agree','videos','all','èµ„æºä¸å­˜åœ¨ï¼','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','parse','LessThan','33dckxbP','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','modelsService','CVSync2AsyncGetResult','returnDrawDetail','ä½ åˆ é™¤çš„å¯¹è¯è®°å½•ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','intro','byChatlogId','getUserId','DESC','getOwnPropertyDescriptor','findAndCount','-----------TEST--------','å–æ¶ˆæŽ¨è','defineProperty','./entity/chatLog.entity','###ðŸŽµ\x20æ­Œæ›²å','ali','MUSIC','åˆ é™¤å¯¹è¯è®°å½•æˆåŠŸï¼','succeed','aiAssetsEntity','images','transferFile','task_id','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','del','EModelType','64055tCuybO','substring','delByGroupId','relId','HttpStatus','syncVideoTest','listUndoneVideoForVeo','querDrawLogPage','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','UserService','failed','ä½ æŽ¨èçš„å›¾ç‰‡ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','userId','videoNotifyRunway','assetsSquare','Connection','startsWith','playNum','image_urls','@nestjs/common','\x20OFFSET\x20','lock','visitNum','message','5263786VfnylF','findOne','\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x276\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27failed\x27,\x20\x27completed\x27,\x27succeed\x27)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x20\x20and\x20message_id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20','../../common/constants/balance.constant','chatLogId','ale.agree_num','listUndoneVideoForLuma','userInfo','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','InjectRepository','classify','cover','87367pMSZMt','avatar','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','mergeModels','getUserInfoFromHeader','syncJMengTask','ids','ChatLogService','./entity/aiAssets.entity','../user/user.service','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','timeout','redisCacheService','task_status_msg','answer','__decorate','includes','veoTaskService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','fileService','ä½ æ“ä½œçš„å›¾ç‰‡ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','%\x27)\x20','\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20','querAllDrawLog','mp4','../file/file.service','PAINT_TYPE','typeorm','cos','message_id','chatTaskLog','role','mergeModelsByName','\x0a\x20\x20\x20\x20','getAgreeMap','nickname','join','DeductionKey','assetsPublish','videoNotifySuno','----------VEOè§†é¢‘é”™è¯¯---------','byId','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','videoNotify','\x20AND\x20aa.title\x20LIKE\x20(\x27%','user','nestjs-cls','\x0a\x20\x20\x20\x20\x20\x20','proxyUrl','è§£æžé”™è¯¯','syncAssets','class-validator','getUserListByIds','and\x20cl.modelSubType=\x27','match','chatList','drawDetail','---','errMsg','metadata','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20and\x20aa.id=','getLastByUserAndAppIds','batchRunwayVideoResult','44868lSuAwv','../models/models.service','delChatLog','task_status','=======================ä¿å­˜è§†é¢‘å…¥åº“====================','length','find','----------å³æ¢¦è§†é¢‘é”™è¯¯---------','IN_PROGRESS','AiLogService','Like','assistant','save','10000','\x20AND\x20aa.classify=\x27','BAD_REQUEST','clsService','size','Service','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','map','modelSubType','cn-north-1','listAssetsBychatLogIds','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','indexOf','test','tencent','set','design:paramtypes','transferAndCover','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','decorate','createdAt','chatLogEntity','isDelete\x20=\x200','isSuper','done','268incZTk','count','requestParams','runwayé€šçŸ¥ï¼š','push','duration','Bearer\x20','../redisCache/redisCache.service','getModelById','lyrics','AND\x20aa.title\x20LIKE\x20(\x27%','text','filter','ModelsService','saveChatLog','data','object','-------------------å³æ¢¦è§†é¢‘------------------','syncVideo','transaction','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x271\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','formatDate','VeoTaskService','__param','aa.createdAt','?x-oss-process=image/resize,w_400','assign','maskEmail','keyType','get','url','debuctBalance4Muisc','../../common/constants/collectType.constant','modelType','videoNotifyKLing','../../common/store','querDrawLog','videoNotifyKLingImage','709016tSTSIw','%filesystem.site%','-------------------------ChatALL----------','function','POST','agreeNum','getModelInfoByKeyType','page','sunoé€šçŸ¥ï¼š','createAPI','37430fjVLLP','replace','__esModule','prompt','forEach','modelInfo','PENDING','state','query','232fcqCIR','MUSIC_TRANSFER','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20'];_0x559d=function(){return _0x40cc2a;};return _0x559d();}Object[_0x5e18f5(0x27f)](exports,_0x5e18f5(0x216),{'value':!![]}),exports[_0x5e18f5(0x186)]=void 0x0;const common_1=require(_0x5e18f5(0x16c)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require(_0x5e18f5(0x280)),typeorm_2=require(_0x5e18f5(0x19a)),balance_constant_1=require(_0x5e18f5(0x175)),utils_1=require('../../common/utils'),file_service_1=require(_0x5e18f5(0x198)),redisCache_service_1=require(_0x5e18f5(0x1eb)),redisKey_constant_1=require(_0x5e18f5(0x22d)),model_constant_1=require('../../common/constants/model.constant'),aiAssets_entity_1=require(_0x5e18f5(0x187)),aiLog_service_1=require('../aiLog/aiLog.service'),nestjs_cls_1=require(_0x5e18f5(0x1ad)),class_validator_1=require(_0x5e18f5(0x1b2)),user_service_1=require(_0x5e18f5(0x188)),models_service_1=require(_0x5e18f5(0x1bf)),store_1=require(_0x5e18f5(0x207)),collectType_constant_1=require(_0x5e18f5(0x204)),openapi_1=require('@volcengine/openapi'),veoTask_service_1=require('../api/veoTask.service');let ChatLogService=class ChatLogService{constructor(_0x4cc009,_0x5d2fad,_0x5e2fb6,_0x438967,_0x452cfc,_0x1952c2,_0x406dd7,_0x243c2a,_0x4e54a0,_0x18bbdc){const _0x185040=_0x5e18f5;this[_0x185040(0x1e0)]=_0x4cc009,this[_0x185040(0x286)]=_0x5d2fad,this['clsService']=_0x5e2fb6,this[_0x185040(0x192)]=_0x438967,this[_0x185040(0x247)]=_0x452cfc,this[_0x185040(0x18b)]=_0x1952c2,this[_0x185040(0x25f)]=_0x406dd7,this[_0x185040(0x273)]=_0x243c2a,this[_0x185040(0x190)]=_0x4e54a0,this[_0x185040(0x236)]=_0x18bbdc;}async[_0x5e18f5(0x1f2)](_0x2b655a){const _0x470f56=_0x5e18f5;return await this[_0x470f56(0x1e0)][_0x470f56(0x1ca)](_0x2b655a);}async['parseAndSaveMusic'](_0x53393e){const _0x30109d=_0x5e18f5,_0x3bc3b5=_0x53393e[_0x30109d(0x18d)];let _0x3747f6={},_0x53fd12={};if(_0x3bc3b5['indexOf'](_0x30109d(0x24b))!=-0x1)throw new Error('éŸ³ä¹ç”Ÿæˆé”™è¯¯ï¼š'+_0x3bc3b5);else{let _0x2db7c8='',_0x3a9e4e='',_0x572154='è§£æžé”™è¯¯',_0x2410b7=_0x30109d(0x1b0),_0x4477db=_0x30109d(0x1b0),_0x3160c5=_0x30109d(0x1b0),_0x2c4419=_0x30109d(0x1b0),_0x5d0e86=_0x30109d(0x1b0),_0x58b17b=_0x30109d(0x1b0),_0x42b235=_0x30109d(0x1b0);if(_0x3bc3b5['startsWith']('####')){const [_0x25f430]=_0x3bc3b5[_0x30109d(0x1b5)](/>(\S+)\n/g);_0x2db7c8=_0x3a9e4e=_0x25f430[_0x30109d(0x28f)](0x1,_0x25f430[_0x30109d(0x1c3)]-0x1),_0x572154=_0x3bc3b5['split']('\x0a')[0x0][_0x30109d(0x28f)](0x7),_0x2410b7=_0x3bc3b5[_0x30109d(0x25e)](_0x30109d(0x1b8))[0x1][_0x30109d(0x215)](/\[.*\]|ï¼ˆ.*ï¼‰/g,'')[_0x30109d(0x215)](/\n+/g,'\x0a');const _0x182814=_0x3bc3b5[_0x30109d(0x1b5)](/!\[image\].*\)/g);_0x182814&&([_0x4477db,_0x3160c5]=_0x182814[_0x30109d(0x1d2)](_0x27e0ce=>_0x27e0ce[_0x30109d(0x28f)](0x9,_0x27e0ce[_0x30109d(0x1c3)]-0x1)));const _0x12d416=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp3/g);_0x12d416&&([_0x2c4419,_0x5d0e86]=_0x12d416);const _0x384079=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp4/g);_0x384079&&([_0x58b17b,_0x42b235]=_0x384079);}else{if(_0x3bc3b5[_0x30109d(0x169)]('ðŸŽµ')){_0x572154=_0x3bc3b5[_0x30109d(0x25e)]('\x0a')[0x0]['replace'](/ðŸŽµ/g,'');const _0x20f478=_0x3bc3b5[_0x30109d(0x25e)]('--')['find'](_0x1b2a2b=>/-\n\n\[/['test'](_0x1b2a2b));if(_0x20f478){const _0x5e8ae4=_0x20f478['replace'](/\[.*\]|ï¼ˆ.*ï¼‰|-/g,'')['replace'](/\n+/g,'\x0a');_0x5e8ae4['startsWith']('\x0a')?_0x2410b7=_0x5e8ae4[_0x30109d(0x215)]('\x0a',''):_0x2410b7=_0x5e8ae4;}const _0x58b653=_0x3bc3b5[_0x30109d(0x1b5)](/æ­Œæ›²id(.+)\n/ig);_0x58b653&&([_0x2db7c8,_0x3a9e4e]=_0x58b653['map'](_0x45fbe4=>_0x45fbe4[_0x30109d(0x28f)](0xc,_0x45fbe4[_0x30109d(0x1c3)]-0x1)));const _0x31c784=_0x3bc3b5[_0x30109d(0x1b5)](/\[å°é¢å›¾ç‰‡\].*\)/g);_0x31c784&&([_0x4477db,_0x3160c5]=_0x31c784[_0x30109d(0x1d2)](_0x253c45=>_0x253c45[_0x30109d(0x28f)](0x7,_0x253c45[_0x30109d(0x1c3)]-0x1)));const _0x42569f=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp3/g);_0x42569f&&([_0x2c4419,_0x5d0e86]=_0x42569f);const _0x2c1330=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp4/g);_0x2c1330&&([_0x58b17b,_0x42b235]=_0x2c1330);}else{if(_0x3bc3b5[_0x30109d(0x1d7)]('ðŸ’„')!=-0x1){let _0x47b7f8=_0x3bc3b5[_0x30109d(0x25e)]('\x0a');_0x47b7f8[_0x30109d(0x218)](_0x5a96bb=>{const _0x4cddeb=_0x30109d;_0x5a96bb[_0x4cddeb(0x1d7)]('ðŸ”Ž')!=-0x1&&(_0x572154=_0x5a96bb['split']('ï¼š')[0x1]);});const _0x7df0b3=_0x3bc3b5[_0x30109d(0x25e)](_0x30109d(0x24c))[0x1][_0x30109d(0x25e)]('\x0a');if(_0x7df0b3){const _0x5aab98=_0x7df0b3[_0x30109d(0x1f0)](_0x1a2ee3=>_0x1a2ee3[_0x30109d(0x1d7)]('[')==-0x1)[_0x30109d(0x1a3)]('');_0x5aab98['startsWith']('\x0a')?_0x2410b7=_0x5aab98[_0x30109d(0x215)]('\x0a',''):_0x2410b7=_0x5aab98;}const _0x3aab7c=_0x3bc3b5['match'](/æ­Œæ›²id(.+)\n/ig);_0x3aab7c&&([_0x2db7c8,_0x3a9e4e]=_0x3aab7c[_0x30109d(0x1d2)](_0x264db0=>_0x264db0[_0x30109d(0x28f)](0xa,_0x264db0['length']-0x1)));const _0x167b6a=_0x3bc3b5[_0x30109d(0x1b5)](/\[å°é¢å›¾ç‰‡\].*\)/g);_0x167b6a&&([_0x4477db,_0x3160c5]=_0x167b6a['map'](_0x4b586=>_0x4b586[_0x30109d(0x28f)](0x7,_0x4b586[_0x30109d(0x1c3)]-0x1)));const _0x22d164=_0x3bc3b5['match'](/https:\/\/(.*)\.mp3/g);_0x22d164&&([_0x2c4419,_0x5d0e86]=_0x22d164);const _0x41dcb3=_0x3bc3b5['match'](/https:\/\/(.*)\.mp4/g);_0x41dcb3&&([_0x58b17b,_0x42b235]=_0x41dcb3);}else{if(_0x3bc3b5[_0x30109d(0x169)]('ðŸŽ')){_0x572154=_0x3bc3b5[_0x30109d(0x25e)]('\x0a')[0x2]['split'](_0x30109d(0x224))[0x1];const _0x563d1e=_0x3bc3b5[_0x30109d(0x25e)](_0x30109d(0x24c))[0x1]['split']('\x0a');if(_0x563d1e){const _0x374895=_0x563d1e[_0x30109d(0x1f0)](_0x50b9ee=>_0x50b9ee['indexOf']('[')==-0x1)['join']('');_0x374895[_0x30109d(0x169)]('\x0a')?_0x2410b7=_0x374895['replace']('\x0a',''):_0x2410b7=_0x374895;}const _0x39e6e1=_0x3bc3b5[_0x30109d(0x1b5)](/æ­Œæ›²IDï¼š(.+)\n/ig);_0x39e6e1&&([_0x2db7c8,_0x3a9e4e]=_0x39e6e1['map'](_0x5a2c8f=>_0x5a2c8f[_0x30109d(0x28f)](0x8,_0x5a2c8f[_0x30109d(0x1c3)]-0x1)));const _0x34c916=_0x3bc3b5[_0x30109d(0x1b5)](/\[å°é¢\].*\)/g);_0x34c916&&([_0x4477db,_0x3160c5]=_0x34c916[_0x30109d(0x1d2)](_0x1f5cbe=>_0x1f5cbe[_0x30109d(0x28f)](0x5,_0x1f5cbe['length']-0x1)));const _0x2021ac=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp3/g);_0x2021ac&&([_0x2c4419,_0x5d0e86]=_0x2021ac);const _0x1ae312=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp4/g);_0x1ae312&&([_0x58b17b,_0x42b235]=_0x1ae312);}else{if(_0x3bc3b5[_0x30109d(0x1d7)](_0x30109d(0x281))!==-0x1){let _0x3b2509=_0x3bc3b5['split']('\x0a'),_0x3f9005=![];const _0x444926=[];for(let _0x3a77f0=0x0;_0x3a77f0<_0x3b2509[_0x30109d(0x1c3)];_0x3a77f0++){const _0x288c8d=_0x3b2509[_0x3a77f0];_0x288c8d['indexOf'](_0x30109d(0x281))!==-0x1&&(_0x572154=_0x288c8d[_0x30109d(0x25e)]('ï¼š\x20')[0x1]);if(_0x288c8d[_0x30109d(0x18f)]('**ç‰ˆæœ¬ID'))_0x3f9005=![];else{if(_0x3f9005&&!_0x288c8d['startsWith']('['))_0x444926['push'](_0x288c8d);else _0x288c8d[_0x30109d(0x18f)](_0x30109d(0x25d))&&(_0x3f9005=!![]);}}_0x2410b7=_0x444926[_0x30109d(0x1a3)]('\x20');const _0x2b2b9c=_0x3bc3b5[_0x30109d(0x1b5)](/ç‰ˆæœ¬IDï¼š(.+)\n/ig);_0x2b2b9c&&([_0x2db7c8,_0x3a9e4e]=_0x2b2b9c[_0x30109d(0x1d2)](_0x5903e1=>_0x5903e1[_0x30109d(0x28f)](0xa,_0x5903e1[_0x30109d(0x1c3)]-0x1)));const _0x5c37a8=_0x3bc3b5['match'](/\[å°é¢\].*\)/g);_0x5c37a8&&([_0x4477db,_0x3160c5]=_0x5c37a8['map'](_0x30d32b=>_0x30d32b['substring'](0x5,_0x30d32b[_0x30109d(0x1c3)]-0x1)));const _0x482bd5=_0x3bc3b5['match'](/https:\/\/(.*)\.mp3/g);_0x482bd5&&([_0x2c4419,_0x5d0e86]=_0x482bd5);const _0x4f6851=_0x3bc3b5[_0x30109d(0x1b5)](/https:\/\/(.*)\.mp4/g);_0x4f6851&&([_0x58b17b,_0x42b235]=_0x4f6851);}else throw new Error(_0x30109d(0x1b0));}}}}_0x3747f6={'title':_0x572154,'intro':_0x2410b7,'mp3':_0x2c4419,'mp4':_0x58b17b,'cover':_0x4477db,'sunoMusicId':_0x2db7c8,'chatLogId':_0x53393e['id'],'userId':_0x53393e[_0x30109d(0x165)]},_0x53fd12={'title':_0x572154,'intro':_0x2410b7,'mp3':_0x5d0e86,'mp4':_0x42b235,'cover':_0x3160c5,'sunoMusicId':_0x3a9e4e,'chatLogId':_0x53393e['id'],'userId':_0x53393e[_0x30109d(0x165)]};}await this[_0x30109d(0x236)][_0x30109d(0x1f7)](async()=>{const _0x34ee26=_0x30109d;await this['aiAssetsEntity'][_0x34ee26(0x1ca)](_0x3747f6),await this[_0x34ee26(0x286)]['save'](_0x53fd12);});}async['parseAndSaveVideo'](_0x202b07,{id:_0xf6161d,videoUrl:_0x2574f6,state:_0x3af11c,completed:_0x289e88}){const _0x5fecd2=_0x5e18f5;let _0x397c34={'mp4':_0x2574f6,'sunoMusicId':_0xf6161d,'chatLogId':_0x202b07['id'],'userId':_0x202b07['userId']};if(_0xf6161d){const _0x39b944=await this['aiAssetsEntity'][_0x5fecd2(0x172)]({'where':{'sunoMusicId':_0xf6161d}});_0x39b944&&(_0x397c34=Object[_0x5fecd2(0x1fe)](_0x39b944,_0x397c34));}console[_0x5fecd2(0x249)](_0x5fecd2(0x1c2),_0x397c34),_0x397c34=await this[_0x5fecd2(0x286)][_0x5fecd2(0x1ca)](_0x397c34),_0x202b07[_0x5fecd2(0x18d)]=_0x3af11c,this['chatLogEntity'][_0x5fecd2(0x1ca)](_0x202b07),_0x289e88&&_0x397c34[_0x5fecd2(0x197)]&&this[_0x5fecd2(0x1f6)](_0x397c34);}async[_0x5e18f5(0x208)](_0xebf3eb,_0x52ecf3){const _0x154020=_0x5e18f5;try{const {id:_0x150ce6}=_0xebf3eb[_0x154020(0x1ac)],{model:_0xcc7e3}=_0x52ecf3,_0x2259be={'userId':_0x150ce6,'type':balance_constant_1[_0x154020(0x1a4)][_0x154020(0x199)],'modelType':_0x154020(0x267),'isDelete':![]};_0x52ecf3[_0x154020(0x200)]&&(_0x2259be[_0x154020(0x1d3)]=_0x52ecf3['keyType']);_0xcc7e3&&(_0x2259be[_0x154020(0x25c)]=_0xcc7e3);const _0x40f200=await this[_0x154020(0x1e0)][_0x154020(0x1c4)]({'where':_0x2259be,'order':{'id':'DESC'}});return this[_0x154020(0x262)](_0x40f200),await this[_0x154020(0x273)][_0x154020(0x19f)](_0x40f200,model_constant_1[_0x154020(0x28d)]['DRAW']),_0x40f200;}catch(_0x51d7a1){return console[_0x154020(0x249)](_0x51d7a1),_0x51d7a1;}}['mergeThumb'](_0x30d433){const _0x390a8f=_0x5e18f5;_0x30d433[_0x390a8f(0x218)](_0x2059a6=>{const _0x3a0d43=_0x390a8f;_0x2059a6[_0x3a0d43(0x264)]&&_0x2059a6[_0x3a0d43(0x264)][_0x3a0d43(0x1c3)]&&_0x2059a6[_0x3a0d43(0x264)]['forEach']((_0x2d4595,_0x1952e5)=>{const _0x577dbf=_0x3a0d43;if(_0x2d4595[_0x577dbf(0x202)]){const _0x1b5c2e=_0x2d4595[_0x577dbf(0x202)]['includes'](_0x577dbf(0x19b))?_0x577dbf(0x1d9):_0x577dbf(0x282),_0xdca8ac=_0x1b5c2e==='tencent'?'?imageMogr2/thumbnail/400x':_0x577dbf(0x1fd);_0x2059a6[_0x577dbf(0x264)][_0x1952e5]['thumb']=_0x2d4595[_0x577dbf(0x202)]+_0xdca8ac;}});});}async[_0x5e18f5(0x160)](_0x53e5f2,_0x286f39){const _0x27aa4a=_0x5e18f5;try{const {id:_0x57bb71}=_0x53e5f2[_0x27aa4a(0x1ac)],{model:_0x144634}=_0x286f39,_0x12acda={'userId':_0x57bb71,'type':balance_constant_1[_0x27aa4a(0x1a4)][_0x27aa4a(0x199)],'modelType':'draw','isDelete':![]};_0x286f39[_0x27aa4a(0x200)]&&(_0x12acda[_0x27aa4a(0x1d3)]=_0x286f39[_0x27aa4a(0x200)]);_0x144634&&(_0x12acda[_0x27aa4a(0x25c)]=_0x144634);const [_0x441b11,_0x1de8f1]=await this[_0x27aa4a(0x1e0)][_0x27aa4a(0x27c)]({'where':_0x12acda,'skip':_0x286f39[_0x27aa4a(0x1cf)]*(_0x286f39[_0x27aa4a(0x211)]-0x1),'take':_0x286f39[_0x27aa4a(0x1cf)],'order':{'id':_0x27aa4a(0x27a)}});let _0x29f208=[];return _0x441b11[_0x27aa4a(0x218)](_0x2720b4=>{const _0x5265ea=_0x27aa4a;_0x29f208[_0x5265ea(0x1e8)](this[_0x5265ea(0x275)](_0x2720b4));}),this[_0x27aa4a(0x262)](_0x29f208),await this[_0x27aa4a(0x273)][_0x27aa4a(0x19f)](_0x29f208,model_constant_1[_0x27aa4a(0x28d)][_0x27aa4a(0x261)]),{'result':_0x29f208,'count':_0x1de8f1};}catch(_0x337670){return console['log'](_0x337670),_0x337670;}}async[_0x5e18f5(0x1b7)](_0x49b835,_0x36ac0c){const _0x312d2a=_0x5e18f5,_0x4b9590=_0x49b835[_0x312d2a(0x1ac)]['id'];if(_0x36ac0c[_0x312d2a(0x18f)](',')){const _0x1ab42e=await this[_0x312d2a(0x1e0)][_0x312d2a(0x1c4)]({'where':{'userId':_0x4b9590,'id':(0x0,typeorm_2['In'])(_0x36ac0c[_0x312d2a(0x25e)](',')['map'](_0x28cc3c=>parseInt(_0x28cc3c)))}});return this[_0x312d2a(0x262)](_0x1ab42e),await this[_0x312d2a(0x273)][_0x312d2a(0x19f)](_0x1ab42e,model_constant_1['EModelType'][_0x312d2a(0x261)]),_0x1ab42e[_0x312d2a(0x1d2)](_0x95913f=>this[_0x312d2a(0x275)](_0x95913f));}else{const _0x19e7f9=await this[_0x312d2a(0x1e0)][_0x312d2a(0x1c4)]({'where':{'userId':_0x4b9590,'id':parseInt(_0x36ac0c)}});if(!_0x19e7f9)return'';return this[_0x312d2a(0x262)](_0x19e7f9),await this[_0x312d2a(0x273)]['mergeModelsByName'](_0x19e7f9,model_constant_1[_0x312d2a(0x28d)][_0x312d2a(0x261)]),this[_0x312d2a(0x275)](_0x19e7f9[0x0]);}}[_0x5e18f5(0x275)](_0x46c4d6){const _0x5bbbb0=_0x5e18f5;return{'id':_0x46c4d6['id'],'createdAt':_0x46c4d6[_0x5bbbb0(0x1df)],'userId':_0x46c4d6[_0x5bbbb0(0x165)],'model':_0x46c4d6[_0x5bbbb0(0x25c)],'modelType':_0x46c4d6[_0x5bbbb0(0x205)],'modelSubType':_0x46c4d6[_0x5bbbb0(0x1d3)],'fullPrompt':_0x46c4d6[_0x5bbbb0(0x217)],'originPrompt':_0x46c4d6['prompt'],'prompt':_0x46c4d6[_0x5bbbb0(0x217)],'answer':_0x46c4d6[_0x5bbbb0(0x18d)],'status':_0x46c4d6['status'],'failReason':_0x46c4d6[_0x5bbbb0(0x1b9)],'imageUrl':_0x46c4d6[_0x5bbbb0(0x259)],'rec':_0x46c4d6['rec'],'requestParams':_0x46c4d6[_0x5bbbb0(0x1e6)],'responseResult':_0x46c4d6['responseResult'],'isCollect':0x0,'collectNum':0x0};}async[_0x5e18f5(0x196)](_0x490eb1){const _0x502bbb=_0x5e18f5,{page:page=0x1,size:size=0x14,rec:_0xdabec6,userId:_0x434bf5,model:_0x49e82a}=_0x490eb1,_0x525f81={'type':balance_constant_1[_0x502bbb(0x1a4)][_0x502bbb(0x199)],'prompt':(0x0,typeorm_2[_0x502bbb(0x254)])(''),'answer':(0x0,typeorm_2[_0x502bbb(0x254)])('')};_0xdabec6&&Object[_0x502bbb(0x1fe)](_0x525f81,{'rec':_0xdabec6}),_0x434bf5&&Object[_0x502bbb(0x1fe)](_0x525f81,{'userId':_0x434bf5}),_0x49e82a&&Object[_0x502bbb(0x1fe)](_0x525f81,{'model':_0x49e82a});const [_0x15623b,_0x45625f]=await this['chatLogEntity'][_0x502bbb(0x27c)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x525f81});return this[_0x502bbb(0x262)](_0x15623b),await this[_0x502bbb(0x273)][_0x502bbb(0x19f)](_0x15623b,model_constant_1[_0x502bbb(0x28d)]['DRAW']),{'rows':_0x15623b,'count':_0x45625f};}async[_0x5e18f5(0x24e)](_0x3161f3){const _0x27aa02=_0x5e18f5,{id:_0x218b1d}=_0x3161f3,_0x4ee913=await this[_0x27aa02(0x1e0)][_0x27aa02(0x172)]({'where':{'id':_0x218b1d,'type':balance_constant_1['DeductionKey']['PAINT_TYPE']}});if(!_0x4ee913)throw new common_1[(_0x27aa02(0x23e))](_0x27aa02(0x164),common_1['HttpStatus'][_0x27aa02(0x1cd)]);const _0x478c15=_0x4ee913[_0x27aa02(0x248)]===0x1?0x0:0x1,_0x3477b6=await this[_0x27aa02(0x1e0)]['update']({'id':_0x218b1d},{'rec':_0x478c15});if(_0x3477b6['affected']>0x0)return(_0x478c15?'æŽ¨è':_0x27aa02(0x27e))+'å›¾ç‰‡æˆåŠŸï¼';throw new common_1[(_0x27aa02(0x23e))](_0x27aa02(0x193),common_1[_0x27aa02(0x15d)]['BAD_REQUEST']);}async[_0x5e18f5(0x248)](_0x4595a8,_0x27ac32,_0x3c7dd3){const _0x45d45f=_0x5e18f5,_0x564a34=await this[_0x45d45f(0x286)]['findOne']({'where':{'id':_0x4595a8}});return _0x564a34&&(_0x564a34['publishFlag']=_0x27ac32,_0x3c7dd3&&(_0x564a34[_0x45d45f(0x17c)]=_0x3c7dd3)),await this[_0x45d45f(0x286)]['save'](_0x564a34),!![];}async['querAllChatLog'](_0x671c3b,_0x2637ed){const _0x3addd3=_0x5e18f5;try{const _0x5baa26=(0x0,utils_1[_0x3addd3(0x258)])(this[_0x3addd3(0x1ce)]),{page:page=0x1,size:size=0x14,userId:_0x4f42f6,keyword:_0xb56da1,prompt:_0x3efa28,saasId:_0x59daa6,modelType:_0x15d67c}=_0x671c3b;let _0x479a8d=_0x3addd3(0x1e1);_0x4f42f6&&(_0x479a8d=_0x479a8d+(_0x3addd3(0x161)+_0x4f42f6));_0x3efa28&&(_0x479a8d=_0x479a8d+(_0x3addd3(0x1a9)+_0x3efa28+'%\x27'));_0x15d67c&&(_0x479a8d=_0x479a8d+(_0x3addd3(0x1dd)+_0x15d67c+'\x27'));(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,class_validator_1['isDefined'])(_0x59daa6)&&(_0x479a8d=_0x479a8d+(_0x3addd3(0x272)+_0x59daa6)):_0x479a8d=_0x479a8d+(_0x3addd3(0x220)+_0x5baa26);_0xb56da1&&(_0x479a8d=_0x479a8d+(_0x3addd3(0x181)+_0xb56da1+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0xb56da1+_0x3addd3(0x17a)+_0xb56da1+_0x3addd3(0x23d)+_0xb56da1+_0x3addd3(0x23f)));const _0xd1964d=await this[_0x3addd3(0x236)][_0x3addd3(0x21c)](_0x3addd3(0x229)+_0x479a8d+_0x3addd3(0x239)),_0x2e6f4d=await this[_0x3addd3(0x236)][_0x3addd3(0x21c)](_0x3addd3(0x180)+_0x479a8d+'\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x3addd3(0x16d)+(page-0x1)*size+_0x3addd3(0x1a0));return!(0x0,utils_1[_0x3addd3(0x1e2)])(this['clsService'])&&_0x2e6f4d['forEach'](_0x1a6edc=>{const _0x130046=_0x3addd3;_0x1a6edc['email']=(0x0,utils_1[_0x130046(0x1ff)])(_0x1a6edc[_0x130046(0x23b)]),_0x1a6edc[_0x130046(0x241)]=(0x0,utils_1['maskEmail'])(_0x1a6edc[_0x130046(0x241)]);}),{'rows':_0x2e6f4d,'count':Number(_0xd1964d[0x0]?.[_0x3addd3(0x1e5)]||0x0)};}catch(_0x21c7a1){return console[_0x3addd3(0x249)](_0x3addd3(0x20c),_0x21c7a1),{'rows':[],'count':0x0};}}async[_0x5e18f5(0x1c0)](_0x2cfd11){const _0x4d7a1c=_0x5e18f5;if(!_0x2cfd11['ids']['length'])return!![];return await this['chatLogEntity'][_0x4d7a1c(0x268)]({'id':(0x0,typeorm_2['In'])(_0x2cfd11['ids'])},{'isDelete':!![]}),!![];}async[_0x5e18f5(0x1b6)](_0x2ea2f6,_0x3fa397){const _0x102768=_0x5e18f5,{id:_0x276ca2}=_0x2ea2f6['user'],{groupId:_0x2468f1,logType:_0x540625,modelSubType:_0x304b51}=_0x3fa397,_0x1a1139={'userId':_0x276ca2,'isDelete':![]};_0x2468f1&&Object[_0x102768(0x1fe)](_0x1a1139,{'groupId':_0x2468f1}),_0x540625&&Object[_0x102768(0x1fe)](_0x1a1139,{'logType':_0x540625}),_0x304b51&&Object['assign'](_0x1a1139,{'modelSubType':_0x304b51});const _0x54e883=await this[_0x102768(0x1e0)][_0x102768(0x1c4)]({'where':_0x1a1139})['catch'](_0x10a5bd=>{const _0x259ee5=_0x102768;common_1['Logger'][_0x259ee5(0x228)](_0x10a5bd);});if(!_0x54e883||_0x54e883['length']===0x0)return[];return _0x54e883[_0x102768(0x1d2)](_0x1b7baa=>{const _0x9f9260=_0x102768,{prompt:_0x1a4a02,role:_0x49f5d4,answer:_0x3d1f29,createdAt:_0x86b960,model:_0x1a3af8,conversationOptions:_0x300cae,requestOptions:_0x10438b,id:_0x1de4ca,answerMp3:_0x2364eb,think:_0x11f3cf}=_0x1b7baa;return{'chatId':_0x1de4ca,'dateTime':(0x0,utils_1['formatDate'])(_0x86b960),'text':_0x49f5d4===_0x9f9260(0x1ac)?_0x1a4a02:_0x3d1f29,'think':_0x11f3cf,'textMp3':_0x2364eb,'inversion':_0x49f5d4===_0x9f9260(0x1ac),'error':![],'conversationOptions':_0x300cae?JSON[_0x9f9260(0x26f)](_0x300cae):null,'requestOptions':_0x10438b?JSON['parse'](_0x10438b):null};});}async['listByGroupId'](_0x38dd0){const _0x385882=_0x5e18f5;return this[_0x385882(0x1e0)]['find']({'where':{'groupId':_0x38dd0,'isDelete':![]}});}async[_0x5e18f5(0x230)](_0x2fb163,_0x1b1d82,_0x15eabd){const _0x3d7be9=_0x5e18f5,_0x2da4c4=new Map();if(!_0x1b1d82['length'])return _0x2da4c4;const _0x1ff15f=await this[_0x3d7be9(0x286)][_0x3d7be9(0x1c4)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x1b1d82),'deleteFlag':0x0}}),_0x331135=_0x1ff15f[_0x3d7be9(0x1d2)](_0x111c9b=>_0x111c9b['id']),_0x47e89e=await this[_0x3d7be9(0x247)][_0x3d7be9(0x1a1)](_0x2fb163,_0x331135,_0x15eabd),_0x17eee1=await this[_0x3d7be9(0x247)][_0x3d7be9(0x265)](_0x331135,_0x15eabd);return _0x1ff15f[_0x3d7be9(0x218)](_0x494b61=>{const _0x1ab5fb=_0x3d7be9;!_0x2da4c4['has'](_0x494b61[_0x1ab5fb(0x176)])&&_0x2da4c4[_0x1ab5fb(0x1da)](_0x494b61[_0x1ab5fb(0x176)],[]);const _0x561fa0=_0x17eee1[_0x1ab5fb(0x201)](_0x494b61['id']);_0x2da4c4['get'](_0x494b61[_0x1ab5fb(0x176)])['push']({..._0x494b61,'agree':_0x47e89e[_0x1ab5fb(0x201)](_0x494b61['id'])||null,'playNum':_0x561fa0?.[_0x1ab5fb(0x16a)]||0x0,'visitNum':_0x561fa0?.[_0x1ab5fb(0x16f)]||0x0,'agreeNum':_0x561fa0?.['agreeNum']||0x0});}),_0x2da4c4;}async['listByIds'](_0x1b437e,_0xc590e8,_0x4cac73){const _0x32f05f=_0x5e18f5;if(!_0xc590e8['length'])return[];const _0x5143e6=await this[_0x32f05f(0x1e0)][_0x32f05f(0x1c4)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0xc590e8)}});if(!_0x5143e6[_0x32f05f(0x1c3)])return[];const _0x5b0eb5=await this['getMusicVoMap'](_0x1b437e['user']['id'],_0xc590e8,_0x4cac73),_0x5770db=new Map(),_0x56519c=_0x5143e6[_0x32f05f(0x1d2)](_0x44fcd5=>_0x44fcd5[_0x32f05f(0x165)])[_0x32f05f(0x1f0)](_0x29a597=>_0x29a597);if(_0x56519c[_0x32f05f(0x1c3)]){const _0x208728=(await this[_0x32f05f(0x25f)][_0x32f05f(0x1b3)](_0x56519c))['map'](_0x1d0d7b=>{const _0x4cc488=_0x32f05f;return{'id':_0x1d0d7b['id'],'nickname':_0x1d0d7b[_0x4cc488(0x1a2)],'avatar':_0x1d0d7b['avatar']};});_0x208728['forEach'](_0x40427d=>_0x5770db['set'](_0x40427d['id'],_0x40427d));}return _0x5143e6[_0x32f05f(0x1d2)](_0x179187=>{const _0x14bd8d=_0x32f05f;return{..._0x179187,'userInfo':_0x5770db[_0x14bd8d(0x201)](_0x179187[_0x14bd8d(0x165)]),'children':_0x5b0eb5[_0x14bd8d(0x201)](_0x179187['id'])||[]};});}async[_0x5e18f5(0x1d5)](_0x46cdae){const _0x4657d2=_0x5e18f5;if(!_0x46cdae[_0x4657d2(0x1c3)])return[];return this[_0x4657d2(0x286)][_0x4657d2(0x1c4)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x46cdae)}});}async[_0x5e18f5(0x269)](_0xd3e8b4,_0x3b88fb){const _0x180caa=_0x5e18f5;let _0xb10af5=collectType_constant_1[_0x180caa(0x23a)][_0x180caa(0x233)];_0x3b88fb[_0x180caa(0x205)]==model_constant_1[_0x180caa(0x28d)][_0x180caa(0x283)]&&(_0xb10af5=collectType_constant_1[_0x180caa(0x23a)]['MUSIC']);const _0x32e2b8=await this[_0x180caa(0x25f)]['collectPage'](_0x3b88fb[_0x180caa(0x211)],_0x3b88fb[_0x180caa(0x1cf)],_0xd3e8b4[_0x180caa(0x1ac)]['id'],collectType_constant_1[_0x180caa(0x23a)]['VIDEO']);if(_0x32e2b8['count']==0x0)return{'count':0x0,'records':[]};return await this[_0x180caa(0x167)](_0xd3e8b4,_0x3b88fb,_0x32e2b8['rows']['map'](_0x584f31=>_0x584f31[_0x180caa(0x15c)]));}async[_0x5e18f5(0x19d)](_0x345281,_0x2815cc){const _0x2c5637=_0x5e18f5;try{const _0x4c67a7={'isDelete':![],'role':_0x2c5637(0x1c9),'userId':_0x345281['user']['id'],'modelType':_0x2815cc[_0x2c5637(0x205)]};_0x2815cc[_0x2c5637(0x1d3)]?_0x4c67a7[_0x2c5637(0x1d3)]=_0x2815cc[_0x2c5637(0x1d3)]:_0x2815cc[_0x2c5637(0x205)]===model_constant_1[_0x2c5637(0x28d)][_0x2c5637(0x283)]&&(_0x4c67a7['modelSubType']='create');const [_0x2e46b9,_0x51f965]=await this[_0x2c5637(0x1e0)][_0x2c5637(0x27c)]({'where':_0x4c67a7,'take':_0x2815cc[_0x2c5637(0x1cf)],'skip':(_0x2815cc['page']-0x1)*_0x2815cc['size'],'order':{'createdAt':'DESC'}}),_0x462384=_0x2e46b9[_0x2c5637(0x1d2)](_0x3f8e0e=>_0x3f8e0e['id']),_0x1edc6c=await this['getMusicVoMap'](_0x345281[_0x2c5637(0x1ac)]['id'],_0x462384,_0x2815cc[_0x2c5637(0x205)]);let _0x4a22b8=_0x2e46b9['map'](_0xaa1b53=>{const _0xf33772=_0x2c5637;return{..._0xaa1b53,'children':_0x1edc6c[_0xf33772(0x201)](_0xaa1b53['id'])||[]};});return{'count':_0x51f965,'records':await this[_0x2c5637(0x273)][_0x2c5637(0x182)](_0x4a22b8)};}catch(_0x412012){throw new common_1[(_0x2c5637(0x23e))](_0x412012['message'],common_1[_0x2c5637(0x15d)][_0x2c5637(0x1cd)]);}}async['assetsDel'](_0x2ccbf6,_0x8b5e11){const _0x189b18=_0x5e18f5;if(!_0x8b5e11[_0x189b18(0x185)][_0x189b18(0x1c3)])return!![];return await this[_0x189b18(0x286)][_0x189b18(0x268)]({'userId':_0x2ccbf6[_0x189b18(0x1ac)]['id'],'id':(0x0,typeorm_2['In'])(_0x8b5e11[_0x189b18(0x185)])},{'deleteFlag':0x1}),!![];}async[_0x5e18f5(0x1a5)](_0x432ea1,_0x1d9195){const _0x46f6e1=_0x5e18f5;if(!_0x1d9195[_0x46f6e1(0x185)])return!![];return await this[_0x46f6e1(0x236)][_0x46f6e1(0x21c)](_0x46f6e1(0x28a)+_0x432ea1[_0x46f6e1(0x1ac)]['id']+_0x46f6e1(0x244)+_0x1d9195[_0x46f6e1(0x185)]['join']()+')\x0a\x20\x20\x20\x20'),!![];}async['assetsSquare'](_0x54bf3f,_0x2e3313,_0x2f36ff=[]){const _0x18fc07=_0x5e18f5;let _0x4ae168=(0x0,utils_1['getUserId'])(this[_0x18fc07(0x1ce)]);if(!_0x4ae168||!_0x54bf3f[_0x18fc07(0x1ac)]){const _0x29ec43=this[_0x18fc07(0x25f)][_0x18fc07(0x183)](_0x54bf3f);_0x4ae168=_0x29ec43?.['id'],_0x54bf3f[_0x18fc07(0x1ac)]=_0x29ec43;}try{const {page:page=0x1,size:size=0x14,order:_0xb768b4,keyword:_0xfc9de2,modelType:_0x42d2b5,modelSubType:_0x541fed,classify:_0x4b5489}=_0x2e3313;let _0x35d308=_0x18fc07(0x1fc);if(_0xb768b4==='playNum')_0x35d308='ale.play_num';else _0xb768b4===_0x18fc07(0x20f)&&(_0x35d308=_0x18fc07(0x177));const _0x56f885=await this['connection'][_0x18fc07(0x21c)](_0x18fc07(0x1d6)+_0x42d2b5+_0x18fc07(0x253)+(_0x541fed?_0x18fc07(0x1b4)+_0x541fed+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4b5489?_0x18fc07(0x1cc)+_0x4b5489+'\x27\x20':'')+_0x18fc07(0x26e)+(_0xfc9de2?_0x18fc07(0x1ab)+_0xfc9de2+_0x18fc07(0x194):'')+_0x18fc07(0x256)+(_0x2f36ff&&_0x2f36ff['length']?_0x18fc07(0x22b)+_0x2f36ff['toString']()+')\x20':'')+_0x18fc07(0x245)),_0x1c0140=await this[_0x18fc07(0x236)][_0x18fc07(0x21c)](_0x18fc07(0x1d1)+_0x42d2b5+_0x18fc07(0x253)+(_0x541fed?_0x18fc07(0x1b4)+_0x541fed+'\x27':'')+_0x18fc07(0x191)+_0x42d2b5+_0x18fc07(0x173)+(_0x4b5489?_0x18fc07(0x1cc)+_0x4b5489+'\x27\x20':'')+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(_0xfc9de2?_0x18fc07(0x1ee)+_0xfc9de2+_0x18fc07(0x23f):'')+_0x18fc07(0x189)+(_0x2f36ff&&_0x2f36ff[_0x18fc07(0x1c3)]?_0x18fc07(0x22b)+_0x2f36ff[_0x18fc07(0x240)]()+')\x20':'')+_0x18fc07(0x28b)+_0x35d308+_0x18fc07(0x21f)+size+_0x18fc07(0x16d)+(page-0x1)*size+_0x18fc07(0x1ae)),_0x51088a=_0x1c0140[_0x18fc07(0x1d2)](_0xd3f12f=>_0xd3f12f['id']),_0x3d573a=await this['aiLogService'][_0x18fc07(0x1a1)](_0x4ae168,_0x51088a,_0x42d2b5),_0x3e6b19=await this[_0x18fc07(0x247)][_0x18fc07(0x265)](_0x51088a,_0x42d2b5),_0x467753=new Map(),_0x2dae0d=_0x1c0140[_0x18fc07(0x1d2)](_0x3d933f=>_0x3d933f[_0x18fc07(0x165)])[_0x18fc07(0x1f0)](_0x2e1fb3=>_0x2e1fb3);if(_0x2dae0d['length']){const _0xa8825b=(await this[_0x18fc07(0x25f)][_0x18fc07(0x1b3)](_0x2dae0d))['map'](_0x43293a=>{const _0xe023b2=_0x18fc07;return{'id':_0x43293a['id'],'nickname':_0x43293a['nickname'],'avatar':_0x43293a[_0xe023b2(0x17f)]};});_0xa8825b[_0x18fc07(0x218)](_0x518571=>_0x467753[_0x18fc07(0x1da)](_0x518571['id'],_0x518571));}_0x1c0140[_0x18fc07(0x218)](_0x4709bb=>{const _0x37da9e=_0x18fc07,_0x173499=_0x3e6b19[_0x37da9e(0x201)](_0x4709bb['id']);_0x4709bb[_0x37da9e(0x26a)]=_0x3d573a[_0x37da9e(0x201)](_0x4709bb['id'])||null,_0x4709bb[_0x37da9e(0x179)]=_0x467753['get'](_0x4709bb['userId']),_0x4709bb[_0x37da9e(0x20f)]=_0x173499?.[_0x37da9e(0x20f)]||0x0;});if(_0x2e3313[_0x18fc07(0x205)]==model_constant_1[_0x18fc07(0x28d)][_0x18fc07(0x233)]){let _0x4ab7fb=await this[_0x18fc07(0x25f)][_0x18fc07(0x25a)](_0x1c0140,_0x54bf3f,collectType_constant_1[_0x18fc07(0x23a)][_0x18fc07(0x233)]);return _0x4ab7fb=await this[_0x18fc07(0x25f)][_0x18fc07(0x232)](_0x1c0140,collectType_constant_1[_0x18fc07(0x23a)][_0x18fc07(0x233)]),{'records':_0x4ab7fb,'count':Number(_0x56f885[0x0]?.[_0x18fc07(0x1e5)]||0x0)};}else{if(_0x2e3313[_0x18fc07(0x205)]==model_constant_1['EModelType']['MUSIC']){let _0x440695=await this[_0x18fc07(0x25f)][_0x18fc07(0x25a)](_0x1c0140,_0x54bf3f,collectType_constant_1[_0x18fc07(0x23a)]['MUSIC']);return _0x440695=await this[_0x18fc07(0x25f)][_0x18fc07(0x232)](_0x1c0140,collectType_constant_1[_0x18fc07(0x23a)]['VIDEO']),{'records':_0x440695,'count':Number(_0x56f885[0x0]?.[_0x18fc07(0x1e5)]||0x0)};}}return{'records':_0x1c0140,'count':Number(_0x56f885[0x0]?.[_0x18fc07(0x1e5)]||0x0)};}catch(_0x33340d){throw new common_1[(_0x18fc07(0x23e))](_0x33340d[_0x18fc07(0x170)],common_1[_0x18fc07(0x15d)][_0x18fc07(0x1cd)]);}}async[_0x5e18f5(0x257)](_0xde23ea,_0x50563d){const _0x1bd51a=_0x5e18f5,_0x5f220c=(0x0,utils_1[_0x1bd51a(0x279)])(this[_0x1bd51a(0x1ce)]);try{const _0xc9c2bb=await this['connection'][_0x1bd51a(0x21c)](_0x1bd51a(0x1bb)+_0xde23ea+_0x1bd51a(0x1ae)),_0x33e9e4=_0xc9c2bb['map'](_0x14cdf1=>_0x14cdf1['id']),_0x509823=await this[_0x1bd51a(0x247)][_0x1bd51a(0x1a1)](_0x5f220c,_0x33e9e4,_0x50563d),_0x3b7e56=new Map(),_0xd04ab8=_0xc9c2bb[_0x1bd51a(0x1d2)](_0x3ff8b3=>_0x3ff8b3[_0x1bd51a(0x165)])[_0x1bd51a(0x1f0)](_0x2da790=>_0x2da790);if(_0xd04ab8['length']){const _0x9ceca0=(await this['userService'][_0x1bd51a(0x1b3)](_0xd04ab8))[_0x1bd51a(0x1d2)](_0x748c8c=>{const _0x3241f9=_0x1bd51a;return{'id':_0x748c8c['id'],'nickname':_0x748c8c[_0x3241f9(0x1a2)],'avatar':_0x748c8c['avatar']};});_0x9ceca0[_0x1bd51a(0x218)](_0x4c7947=>_0x3b7e56['set'](_0x4c7947['id'],_0x4c7947));}return _0xc9c2bb[_0x1bd51a(0x218)](_0x131c18=>{const _0x31eb5a=_0x1bd51a;_0x131c18['agree']=_0x509823[_0x31eb5a(0x201)](_0x131c18['id'])||null,_0x131c18[_0x31eb5a(0x179)]=_0x3b7e56[_0x31eb5a(0x201)](_0x131c18[_0x31eb5a(0x165)]);}),{..._0xc9c2bb[0x0]};}catch(_0x3a0cf2){throw new common_1[(_0x1bd51a(0x23e))](_0x3a0cf2['message'],common_1[_0x1bd51a(0x15d)][_0x1bd51a(0x1cd)]);}}async['chatGptsList'](_0x305559,_0xcdef01){const _0x3e5c81=_0x5e18f5,{id:_0x13386d}=_0x305559[_0x3e5c81(0x1ac)],{groupId:_0x1082da}=_0xcdef01,_0x5cdd96={'userId':_0x13386d,'isDelete':![]};_0x1082da&&Object['assign'](_0x5cdd96,{'groupId':_0x1082da});const _0x2bc0fb=await this['chatLogEntity'][_0x3e5c81(0x1c4)]({'where':_0x5cdd96});return _0x2bc0fb[_0x3e5c81(0x1d2)](_0x3e2885=>{const _0x34fd90=_0x3e5c81,{prompt:_0x5e2e1a,role:_0x40cfb3,answer:_0x58cd9b,createdAt:_0x3d8da3,model:_0x28ce27,conversationOptions:_0x3fe6b2,requestOptions:_0x267708,id:_0xb595b4}=_0x3e2885;return{'chatId':_0xb595b4,'dateTime':(0x0,utils_1['formatDate'])(_0x3d8da3),'text':_0x40cfb3===_0x34fd90(0x1ac)?_0x5e2e1a:_0x58cd9b,'inversion':_0x40cfb3===_0x34fd90(0x1ac),'error':![],'conversationOptions':_0x3fe6b2?JSON[_0x34fd90(0x26f)](_0x3fe6b2):null,'requestOptions':_0x267708?JSON[_0x34fd90(0x26f)](_0x267708):null};});}async[_0x5e18f5(0x223)](_0x1d9aa3,_0x4c052c){const _0x10df86=_0x5e18f5,{id:_0x4ce1bd}=_0x1d9aa3[_0x10df86(0x1ac)],{id:_0x3d6686}=_0x4c052c,_0x5d2163=await this['chatLogEntity'][_0x10df86(0x172)]({'where':{'id':_0x3d6686,'userId':_0x4ce1bd}});if(!_0x5d2163)throw new common_1[(_0x10df86(0x23e))](_0x10df86(0x276),common_1[_0x10df86(0x15d)][_0x10df86(0x1cd)]);const _0x2b638f=await this['chatLogEntity'][_0x10df86(0x268)]({'id':_0x3d6686},{'isDelete':!![]});await this['aiAssetsEntity'][_0x10df86(0x268)]({'userId':_0x1d9aa3['user']['id'],'chatLogId':_0x3d6686},{'deleteFlag':0x1});if(_0x2b638f['affected']>0x0)return _0x10df86(0x284);else throw new common_1[(_0x10df86(0x23e))](_0x10df86(0x276),common_1['HttpStatus'][_0x10df86(0x1cd)]);}async[_0x5e18f5(0x15b)](_0x5c1e09,_0x4e3ae3){const _0x3e4ff3=_0x5e18f5,{groupId:_0x180c12,type:_0x15256b}=_0x4e3ae3,{id:_0x3ce42d}=_0x5c1e09[_0x3e4ff3(0x1ac)],_0x2c7f2d=_0x15256b&&_0x15256b===_0x3e4ff3(0x255)?{'groupId':_0x180c12,'userId':_0x3ce42d}:{'groupId':_0x180c12,'userId':_0x3ce42d},_0x46f2da=await this[_0x3e4ff3(0x1e0)][_0x3e4ff3(0x231)](_0x2c7f2d);if(_0x46f2da[_0x3e4ff3(0x263)]>0x0)return!![];if(_0x46f2da['affected']===0x0)throw new common_1[(_0x3e4ff3(0x23e))]('å½“å‰é¡µé¢å·²ç»æ²¡æœ‰ä¸œè¥¿å¯ä»¥åˆ é™¤äº†ï¼',common_1['HttpStatus'][_0x3e4ff3(0x1cd)]);}async[_0x5e18f5(0x22a)](_0x189148){const _0x25ef19=_0x5e18f5,{ids:_0x47c023,userId:_0x2d4b58}=_0x189148;return await this[_0x25ef19(0x1e0)][_0x25ef19(0x231)]({'groupId':(0x0,typeorm_2['In'])(_0x47c023),'userId':_0x2d4b58});}async['byAppId'](_0x56e4c2,_0x225f09){const _0x4e9390=_0x5e18f5,{id:_0x4187e3}=_0x56e4c2[_0x4e9390(0x1ac)],{appId:_0x200b75,page:page=0x1,size:size=0xa}=_0x225f09,[_0x58b2ed,_0x40e5c5]=await this['chatLogEntity'][_0x4e9390(0x27c)]({'where':{'userId':_0x4187e3,'appId':_0x200b75,'role':'assistant'},'order':{'id':_0x4e9390(0x27a)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x58b2ed,'count':_0x40e5c5};}async[_0x5e18f5(0x1a8)](_0x4c846f,_0x326d5e){const _0x328794=_0x5e18f5,_0x15fc67=_0x4c846f[_0x328794(0x1ac)]['id'],_0x58ed35=await this[_0x328794(0x1e0)][_0x328794(0x172)]({'where':{'userId':_0x15fc67,'id':_0x326d5e}});if(!_0x58ed35)return'';return{'chatId':_0x58ed35['id'],'dateTime':(0x0,utils_1[_0x328794(0x1f9)])(_0x58ed35[_0x328794(0x1df)]),'text':_0x58ed35[_0x328794(0x19e)]===_0x328794(0x1ac)?_0x58ed35['prompt']:_0x58ed35[_0x328794(0x18d)],'textMp3':_0x58ed35['answerMp3'],'inversion':_0x58ed35['role']===_0x328794(0x1ac)};}async[_0x5e18f5(0x278)](_0x5a2123,_0x17840d){const _0x2cd421=_0x5e18f5,_0x3aef18=_0x5a2123[_0x2cd421(0x1ac)]['id'],_0x46f993=await this[_0x2cd421(0x1e0)][_0x2cd421(0x172)]({'where':{'userId':_0x3aef18,'id':_0x17840d}});if(!_0x46f993)return'';return _0x46f993[_0x2cd421(0x18d)];}async[_0x5e18f5(0x178)](){const _0x1f5004=_0x5e18f5,_0x3d437b=await this[_0x1f5004(0x236)]['query'](_0x1f5004(0x1f8));return _0x3d437b;}async[_0x5e18f5(0x235)](){const _0x14367e=_0x5e18f5,_0x5a53e4=await this[_0x14367e(0x236)][_0x14367e(0x21c)](_0x14367e(0x24f));return _0x5a53e4;}async[_0x5e18f5(0x15f)](){const _0x52f5b5=_0x5e18f5,_0x4630e3=await this[_0x52f5b5(0x236)][_0x52f5b5(0x21c)](_0x52f5b5(0x174));return _0x4630e3;}async['refundVideo'](_0x48f9ff){const _0x37ac88=_0x5e18f5,_0x32d324=await this[_0x37ac88(0x273)][_0x37ac88(0x1ec)](_0x48f9ff['modelId']);_0x32d324&&this[_0x37ac88(0x25f)]['refundBalance4Video'](_0x48f9ff[_0x37ac88(0x165)],_0x32d324,_0x48f9ff[_0x37ac88(0x1e6)],_0x48f9ff['id']);}async[_0x5e18f5(0x1aa)](_0x215e80){const _0x3efb8b=_0x5e18f5,_0x48d448=await this[_0x3efb8b(0x286)]['findOne']({'where':{'sunoMusicId':_0x215e80['id']}});if(!_0x48d448)return;const _0x531be0=await this['chatLogEntity'][_0x3efb8b(0x172)]({'where':{'id':_0x48d448['chatLogId']}});_0x531be0[_0x3efb8b(0x18d)]=_0x215e80[_0x3efb8b(0x21b)],_0x48d448[_0x3efb8b(0x197)]=_0x215e80['video']?.[_0x3efb8b(0x202)],await this['aiAssetsEntity'][_0x3efb8b(0x1ca)](_0x48d448);if(_0x531be0[_0x3efb8b(0x18d)]===_0x3efb8b(0x238)&&_0x48d448[_0x3efb8b(0x197)])this['syncVideo'](_0x48d448);else _0x531be0[_0x3efb8b(0x18d)]===_0x3efb8b(0x260)&&(_0x531be0['errMsg']=_0x3efb8b(0x163),this[_0x3efb8b(0x22f)](_0x531be0));await this[_0x3efb8b(0x1e0)][_0x3efb8b(0x1ca)](_0x531be0);}async[_0x5e18f5(0x166)](_0x1bf373){const _0x210c23=_0x5e18f5;console[_0x210c23(0x249)](_0x210c23(0x1e7),_0x1bf373);const _0x420374=await this[_0x210c23(0x286)][_0x210c23(0x172)]({'where':{'sunoMusicId':_0x1bf373[_0x210c23(0x289)]}});if(!_0x420374)throw new Error(_0x210c23(0x26d));const _0x2f8c82=await this['chatLogEntity'][_0x210c23(0x172)]({'where':{'id':_0x420374['chatLogId']}});_0x2f8c82['answer']=_0x1bf373[_0x210c23(0x21b)],_0x420374[_0x210c23(0x197)]=_0x1bf373['video_url'],await this[_0x210c23(0x286)][_0x210c23(0x1ca)](_0x420374);if(_0x1bf373['status']==='3'&&_0x420374[_0x210c23(0x197)])this[_0x210c23(0x1f6)](_0x420374);else _0x2f8c82[_0x210c23(0x18d)]===_0x210c23(0x163)&&(_0x2f8c82[_0x210c23(0x1b9)]='failed',this[_0x210c23(0x22f)](_0x2f8c82));await this[_0x210c23(0x1e0)]['save'](_0x2f8c82);}async[_0x5e18f5(0x209)](_0x4b25a3){const _0x11ef06=_0x5e18f5;console[_0x11ef06(0x249)]('klingImageé€šçŸ¥ï¼š',_0x4b25a3);const _0x56e385=_0x4b25a3[_0x11ef06(0x1f3)]?_0x4b25a3[_0x11ef06(0x1f3)]:_0x4b25a3,_0x5e771c=await this[_0x11ef06(0x1e0)][_0x11ef06(0x172)]({'where':{'message_id':_0x56e385[_0x11ef06(0x289)]}});if(!_0x5e771c)throw new Error(_0x11ef06(0x26d));_0x5e771c[_0x11ef06(0x18d)]=_0x56e385[_0x11ef06(0x1c1)];if(_0x56e385[_0x11ef06(0x24a)]['images']&&_0x56e385['task_result'][_0x11ef06(0x287)][_0x11ef06(0x1c3)]){const _0x5468b9=[];for(const _0x5854f0 of _0x56e385[_0x11ef06(0x24a)]['images']){_0x5468b9[_0x11ef06(0x1e8)](this[_0x11ef06(0x192)][_0x11ef06(0x225)](_0x5854f0[_0x11ef06(0x202)]));}const _0x57c8be=await Promise[_0x11ef06(0x26c)](_0x5468b9);_0x5e771c['fileInfo']=JSON[_0x11ef06(0x24d)](_0x57c8be[_0x11ef06(0x1d2)](_0x2ed1b6=>_0x2ed1b6[_0x11ef06(0x202)])),_0x5e771c['responseResult']=_0x57c8be,_0x5e771c[_0x11ef06(0x237)]=0xa;}_0x5e771c[_0x11ef06(0x18d)]==_0x11ef06(0x163)&&(_0x5e771c[_0x11ef06(0x1b9)]=_0x56e385[_0x11ef06(0x18c)],_0x5e771c[_0x11ef06(0x237)]=0x4),await this[_0x11ef06(0x1e0)][_0x11ef06(0x1ca)](_0x5e771c);}async[_0x5e18f5(0x206)](_0x412575){const _0x427c2c=_0x5e18f5;console[_0x427c2c(0x249)](_0x427c2c(0x252),_0x412575);const _0x5d7cd2=_0x412575[_0x427c2c(0x1f3)]?_0x412575[_0x427c2c(0x1f3)]:_0x412575,_0x38659a=await this[_0x427c2c(0x286)][_0x427c2c(0x172)]({'where':{'sunoMusicId':_0x5d7cd2[_0x427c2c(0x289)]}});if(!_0x38659a)throw new Error(_0x427c2c(0x26d));const _0x50be38=await this['chatLogEntity'][_0x427c2c(0x172)]({'where':{'id':_0x38659a[_0x427c2c(0x176)]}});_0x50be38[_0x427c2c(0x18d)]=_0x5d7cd2[_0x427c2c(0x1c1)];_0x5d7cd2['task_result'][_0x427c2c(0x26b)]&&(console['log']('klingé€šçŸ¥ï¼š',_0x5d7cd2['task_result'][_0x427c2c(0x26b)][0x0]),_0x38659a[_0x427c2c(0x197)]=_0x5d7cd2[_0x427c2c(0x24a)][_0x427c2c(0x26b)][0x0]?.['url']);await this['aiAssetsEntity'][_0x427c2c(0x1ca)](_0x38659a);if(_0x50be38[_0x427c2c(0x18d)]==='succeed'&&_0x38659a['mp4'])this[_0x427c2c(0x1f6)](_0x38659a);else _0x50be38['answer']===_0x427c2c(0x163)&&(_0x50be38['errMsg']='failed',this[_0x427c2c(0x22f)](_0x50be38));await this['chatLogEntity'][_0x427c2c(0x1ca)](_0x50be38);}async[_0x5e18f5(0x1a6)](_0x9fdbb6,_0x33a074){const _0x55b530=_0x5e18f5;console[_0x55b530(0x249)](_0x55b530(0x212),_0x9fdbb6);let _0x4b679c;_0x33a074===_0x55b530(0x1ed)?(_0x4b679c=await this['chatLogEntity']['findOne']({'where':{'id':Number(_0x9fdbb6['task_id'])}}),_0x4b679c[_0x55b530(0x18d)]=_0x9fdbb6[_0x55b530(0x1ef)]||_0x9fdbb6['data']['text']):(_0x4b679c=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x9fdbb6[_0x55b530(0x289)]}}),_0x4b679c[_0x55b530(0x18d)]=_0x9fdbb6[_0x55b530(0x237)]);_0x4b679c[_0x55b530(0x18d)]!=='timeout'&&await this[_0x55b530(0x1e0)]['save'](_0x4b679c);if(_0x33a074==='create'){const _0x22d7f8=await this[_0x55b530(0x286)]['find']({'where':{'chatLogId':_0x4b679c['id']}});for(const _0x28d023 of _0x9fdbb6[_0x55b530(0x1f3)]){const {title:_0x17d086,prompt:_0x3247ca,audio_url:_0x29e4cf,image_url:_0x90fa47,task_id:_0x196468,id:_0x12e445,video_url:_0x4efe24,duration:_0x46fa9b}=_0x28d023,_0x1925e2=_0x196468?_0x22d7f8[_0x55b530(0x1c4)](_0x1b1ed4=>_0x1b1ed4['sunoMusicId']===_0x196468):_0x22d7f8[_0x55b530(0x1c4)](_0x3c6993=>_0x3c6993[_0x55b530(0x221)]===_0x12e445);!_0x1925e2?await this['aiAssetsEntity'][_0x55b530(0x1ca)]({'title':_0x17d086,'intro':_0x3247ca||_0x28d023[_0x55b530(0x1ba)][_0x55b530(0x217)],'duration':_0x46fa9b||0x0,'mp3':_0x29e4cf||'','mp4':_0x4efe24||'','cover':_0x90fa47||'','sunoMusicId':_0x196468||_0x12e445,'chatLogId':_0x4b679c['id'],'userId':_0x4b679c[_0x55b530(0x165)]}):(_0x1925e2[_0x55b530(0x1e9)]=_0x46fa9b||0x0,_0x1925e2[_0x55b530(0x226)]=_0x17d086,_0x1925e2[_0x55b530(0x277)]=_0x3247ca||_0x28d023[_0x55b530(0x1ba)][_0x55b530(0x217)],_0x1925e2['mp3']=_0x29e4cf||'',_0x1925e2[_0x55b530(0x197)]=_0x4efe24||'',_0x1925e2[_0x55b530(0x17d)]=_0x90fa47||'',await this[_0x55b530(0x286)][_0x55b530(0x1ca)](_0x1925e2));}}}async[_0x5e18f5(0x15e)](_0x19111c){const _0x3b1a9c=_0x5e18f5,_0x5f06cb=await this[_0x3b1a9c(0x286)][_0x3b1a9c(0x172)]({'where':{'id':_0x19111c}}),[_0x4210b3,_0x1d3b54]=await this[_0x3b1a9c(0x192)][_0x3b1a9c(0x1dc)](_0x5f06cb[_0x3b1a9c(0x197)]);return console[_0x3b1a9c(0x249)](_0x3b1a9c(0x27d),_0x1d3b54),!![];}async[_0x5e18f5(0x1f6)](_0x2cbf1f){const _0x30f70e=_0x5e18f5,[_0x56c921,_0x5bdc5c]=await this[_0x30f70e(0x192)][_0x30f70e(0x1dc)](_0x2cbf1f[_0x30f70e(0x197)]);_0x2cbf1f[_0x30f70e(0x197)]=_0x56c921,_0x2cbf1f[_0x30f70e(0x17d)]=_0x5bdc5c,await this[_0x30f70e(0x286)][_0x30f70e(0x1ca)](_0x2cbf1f);}async[_0x5e18f5(0x1b1)](){const _0x28401a=_0x5e18f5,_0x538330=await this['aiAssetsEntity'][_0x28401a(0x1c4)]({'where':[{'cover':(0x0,typeorm_2[_0x28401a(0x1c8)])(_0x28401a(0x20b))},{'mp3':(0x0,typeorm_2[_0x28401a(0x1c8)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x28401a(0x1c8)])(_0x28401a(0x20b))},{'mp4':(0x0,typeorm_2[_0x28401a(0x1c8)])(_0x28401a(0x25b))}]});for(let _0x477f9a=0x0;_0x477f9a<_0x538330['length'];_0x477f9a++){const _0x3c3645=_0x538330[_0x477f9a],_0x372f76=redisKey_constant_1[_0x28401a(0x21e)]+_0x3c3645['id'];try{const _0x4795b3=await this[_0x28401a(0x18b)][_0x28401a(0x201)]({'key':_0x372f76});if(_0x4795b3)continue;await this[_0x28401a(0x18b)][_0x28401a(0x1da)]({'key':_0x372f76,'val':_0x28401a(0x16e)});const {cover:_0x2bba0f,mp3:_0x818127,mp4:_0x239a55}=_0x3c3645;/filesystem.site/['test'](_0x2bba0f)&&(_0x3c3645[_0x28401a(0x17d)]=await this['fileService'][_0x28401a(0x288)](_0x2bba0f));/filesystem.site/[_0x28401a(0x1d8)](_0x818127)&&(_0x3c3645[_0x28401a(0x266)]=await this[_0x28401a(0x192)]['transferFile'](_0x818127));if(/filesystem.site|storage.cdn-luma.com/[_0x28401a(0x1d8)](_0x239a55)){if(_0x2bba0f)_0x3c3645[_0x28401a(0x197)]=await this[_0x28401a(0x192)][_0x28401a(0x288)](_0x239a55);else{const [_0x3f7b0d,_0x23f9f0]=await this[_0x28401a(0x192)][_0x28401a(0x1dc)](_0x239a55);_0x3c3645[_0x28401a(0x197)]=_0x3f7b0d,_0x3c3645['cover']=_0x23f9f0;}}await this['aiAssetsEntity'][_0x28401a(0x1ca)](_0x3c3645);}catch(_0x435fda){common_1[_0x28401a(0x234)][_0x28401a(0x228)](_0x435fda);}finally{await this[_0x28401a(0x18b)][_0x28401a(0x28c)]({'key':_0x372f76});}}}async[_0x5e18f5(0x1bc)](_0x33b0e4,_0x2e1a4c){const _0x46f10e=_0x5e18f5,_0x49cde7=await this[_0x46f10e(0x1e0)][_0x46f10e(0x21c)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20'+_0x33b0e4+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20'+_0x2e1a4c[_0x46f10e(0x1a3)]()+_0x46f10e(0x195));return _0x49cde7;}async['batchMusicResult'](){const _0x51f470=_0x5e18f5;try{const _0x2ebaf9=store_1['MusicConfig']['musicTimeoutMs']||0x5,_0x2340c3=await this['chatLogEntity'][_0x51f470(0x1c4)]({'where':{'role':_0x51f470(0x1c9),'modelType':model_constant_1[_0x51f470(0x28d)]['MUSIC'],'answer':(0x0,typeorm_2['In'])([_0x51f470(0x1c6),'']),'updatedAt':(0x0,typeorm_2[_0x51f470(0x270)])(new Date(Date[_0x51f470(0x23c)]()-_0x2ebaf9*0x3c*0x3e8))}});_0x2340c3[_0x51f470(0x218)](async _0x53b22e=>{const _0x31564a=_0x51f470;_0x53b22e[_0x31564a(0x18d)]='timeout',_0x53b22e['errMsg']='timeout',this['chatLogEntity'][_0x31564a(0x1ca)](_0x53b22e),await this[_0x31564a(0x286)]['update']({'chatLogId':_0x53b22e['id']},{'deleteFlag':0x1}),this[_0x31564a(0x25f)][_0x31564a(0x203)](_0x53b22e['userId'],_0x53b22e['id'],_0x53b22e[_0x31564a(0x1d3)],!![]);});}catch(_0x323899){common_1['Logger'][_0x51f470(0x228)](_0x323899);}}async[_0x5e18f5(0x1bd)](){const _0x321a4a=_0x5e18f5;try{const _0x47fe5a=0xa,_0x2e8b19=await this[_0x321a4a(0x1e0)][_0x321a4a(0x1c4)]({'where':{'role':_0x321a4a(0x1c9),'modelType':model_constant_1[_0x321a4a(0x28d)]['VIDEO'],'answer':(0x0,typeorm_2['In'])([_0x321a4a(0x21a),'']),'modelSubType':'2','updatedAt':(0x0,typeorm_2[_0x321a4a(0x270)])(new Date(Date[_0x321a4a(0x23c)]()-_0x47fe5a*0x3c*0x3e8))}});_0x2e8b19[_0x321a4a(0x218)](async _0x5cc489=>{const _0x517d22=_0x321a4a;_0x5cc489['answer']='timeout',_0x5cc489[_0x517d22(0x1b9)]=_0x517d22(0x18a),this[_0x517d22(0x1e0)][_0x517d22(0x1ca)](_0x5cc489),await this['aiAssetsEntity'][_0x517d22(0x268)]({'chatLogId':_0x5cc489['id']},{'deleteFlag':0x1}),await this[_0x517d22(0x22f)](_0x5cc489);});}catch(_0x34aee6){common_1[_0x321a4a(0x234)][_0x321a4a(0x228)](_0x34aee6);}}async[_0x5e18f5(0x184)](){const _0x1f5ebc=_0x5e18f5,_0x408a31=await this[_0x1f5ebc(0x235)]();if(!_0x408a31[_0x1f5ebc(0x1c3)])return;const _0x3418c1=await this[_0x1f5ebc(0x273)][_0x1f5ebc(0x210)](model_constant_1['EModelType'][_0x1f5ebc(0x233)],'5'),_0x2963d8=new openapi_1[(_0x1f5ebc(0x1d0))]({'serviceName':'cv','region':_0x1f5ebc(0x1d4),'host':_0x3418c1[_0x1f5ebc(0x219)]['proxyUrl'],'accessKeyId':_0x3418c1[_0x1f5ebc(0x219)]['key'],'secretKey':_0x3418c1[_0x1f5ebc(0x219)]['secret']}),_0x88c76d=_0x2963d8[_0x1f5ebc(0x213)](_0x1f5ebc(0x274),{'Version':'2022-08-31','method':_0x1f5ebc(0x20e),'contentType':_0x1f5ebc(0x227)});for(const _0x33477c of _0x408a31){if(_0x33477c[_0x1f5ebc(0x19c)])try{const _0x3e516a=await _0x88c76d({'req_key':_0x33477c[_0x1f5ebc(0x25c)],'task_id':_0x33477c[_0x1f5ebc(0x19c)]});console['log'](_0x1f5ebc(0x1f5),_0x33477c[_0x1f5ebc(0x19c)],_0x3e516a);if(_0x3e516a[_0x1f5ebc(0x237)]==_0x1f5ebc(0x1cb)){_0x33477c[_0x1f5ebc(0x18d)]=_0x3e516a[_0x1f5ebc(0x1f3)][_0x1f5ebc(0x237)]==_0x1f5ebc(0x1e3)?_0x1f5ebc(0x285):_0x3e516a[_0x1f5ebc(0x1f3)][_0x1f5ebc(0x237)];const _0x84bc03=await this[_0x1f5ebc(0x286)][_0x1f5ebc(0x172)]({'where':{'chatLogId':_0x33477c['id']}}),_0x3a3bd7=_0x3e516a['data']?.[_0x1f5ebc(0x222)];_0x84bc03[_0x1f5ebc(0x17d)]=_0x3e516a['data']?.[_0x1f5ebc(0x16b)],_0x84bc03[_0x1f5ebc(0x197)]=_0x3a3bd7,await this['aiAssetsEntity'][_0x1f5ebc(0x1ca)](_0x84bc03),await this[_0x1f5ebc(0x1e0)][_0x1f5ebc(0x1ca)](_0x33477c),this[_0x1f5ebc(0x1f6)](_0x84bc03);}}catch(_0x4aefdc){console[_0x1f5ebc(0x249)](_0x1f5ebc(0x1c5),_0x4aefdc);}}}async['syncVeoTask'](){const _0x3b83ef=_0x5e18f5,_0x3470bb=await this[_0x3b83ef(0x15f)]();if(!_0x3470bb[_0x3b83ef(0x1c3)])return;console[_0x3b83ef(0x249)](_0x3b83ef(0x251),_0x3470bb['length']);const _0x378ab7=await this[_0x3b83ef(0x273)][_0x3b83ef(0x210)](model_constant_1['EModelType'][_0x3b83ef(0x233)],'6');for(const _0x447006 of _0x3470bb){if(_0x447006[_0x3b83ef(0x19c)])try{const _0x12bca6=await this['veoTaskService'][_0x3b83ef(0x21c)]({'params':{'id':_0x447006[_0x3b83ef(0x19c)]},'baseURL':_0x378ab7['modelInfo'][_0x3b83ef(0x1af)],'headers':{'Authorization':_0x3b83ef(0x1ea)+_0x378ab7['modelInfo'][_0x3b83ef(0x250)]}});console['log'](_0x3b83ef(0x22c),_0x447006[_0x3b83ef(0x19c)],_0x12bca6),_0x447006['answer']=_0x12bca6[_0x3b83ef(0x237)]==_0x3b83ef(0x238)?_0x3b83ef(0x285):_0x12bca6[_0x3b83ef(0x237)];_0x12bca6[_0x3b83ef(0x237)]=='failed'&&(_0x447006['errMsg']=_0x12bca6[_0x3b83ef(0x237)]);const _0x14a8c6=await this[_0x3b83ef(0x286)][_0x3b83ef(0x172)]({'where':{'chatLogId':_0x447006['id']}}),_0x1acb11=_0x12bca6['video_url'];_0x14a8c6[_0x3b83ef(0x197)]=_0x1acb11,await this[_0x3b83ef(0x286)]['save'](_0x14a8c6),await this[_0x3b83ef(0x1e0)]['save'](_0x447006),this[_0x3b83ef(0x1f6)](_0x14a8c6);}catch(_0x1d23b6){console[_0x3b83ef(0x249)](_0x3b83ef(0x1a7),_0x1d23b6);}}}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5e18f5(0x17b)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x5e18f5(0x17b)])(aiAssets_entity_1[_0x5e18f5(0x246)])),__metadata(_0x5e18f5(0x1db),[typeorm_2[_0x5e18f5(0x243)],typeorm_2[_0x5e18f5(0x243)],nestjs_cls_1['ClsService'],file_service_1['FileService'],aiLog_service_1[_0x5e18f5(0x1c7)],redisCache_service_1['RedisCacheService'],user_service_1[_0x5e18f5(0x162)],models_service_1[_0x5e18f5(0x1f1)],veoTask_service_1[_0x5e18f5(0x1fa)],typeorm_2[_0x5e18f5(0x168)]])],ChatLogService),exports[_0x5e18f5(0x186)]=ChatLogService;