'use strict';const _0x579297=_0x28bf;function _0x28bf(_0x5593c5,_0xdb2915){const _0x50a812=_0x50a8();return _0x28bf=function(_0x28bff0,_0x4b9e86){_0x28bff0=_0x28bff0-0x1eb;let _0x583fba=_0x50a812[_0x28bff0];return _0x583fba;},_0x28bf(_0x5593c5,_0xdb2915);}(function(_0x22e4b5,_0x42430e){const _0x4c8fd2=_0x28bf,_0xa4e079=_0x22e4b5();while(!![]){try{const _0x310003=parseInt(_0x4c8fd2(0x226))/0x1*(-parseInt(_0x4c8fd2(0x271))/0x2)+parseInt(_0x4c8fd2(0x1ed))/0x3*(parseInt(_0x4c8fd2(0x285))/0x4)+-parseInt(_0x4c8fd2(0x224))/0x5*(parseInt(_0x4c8fd2(0x2e1))/0x6)+parseInt(_0x4c8fd2(0x2fe))/0x7*(parseInt(_0x4c8fd2(0x21b))/0x8)+parseInt(_0x4c8fd2(0x2d8))/0x9*(parseInt(_0x4c8fd2(0x2eb))/0xa)+parseInt(_0x4c8fd2(0x29a))/0xb+-parseInt(_0x4c8fd2(0x2c9))/0xc*(-parseInt(_0x4c8fd2(0x2c1))/0xd);if(_0x310003===_0x42430e)break;else _0xa4e079['push'](_0xa4e079['shift']());}catch(_0x1c2bc6){_0xa4e079['push'](_0xa4e079['shift']());}}}(_0x50a8,0x80342));var __decorate=this&&this['__decorate']||function(_0x495ad3,_0x238bc3,_0x4a6bf0,_0x31b401){const _0x74d8fc=_0x28bf;var _0x3e1747=arguments[_0x74d8fc(0x213)],_0x2551b7=_0x3e1747<0x3?_0x238bc3:_0x31b401===null?_0x31b401=Object[_0x74d8fc(0x278)](_0x238bc3,_0x4a6bf0):_0x31b401,_0x1a36b0;if(typeof Reflect===_0x74d8fc(0x291)&&typeof Reflect[_0x74d8fc(0x30c)]===_0x74d8fc(0x209))_0x2551b7=Reflect[_0x74d8fc(0x30c)](_0x495ad3,_0x238bc3,_0x4a6bf0,_0x31b401);else{for(var _0x15ed9b=_0x495ad3[_0x74d8fc(0x213)]-0x1;_0x15ed9b>=0x0;_0x15ed9b--)if(_0x1a36b0=_0x495ad3[_0x15ed9b])_0x2551b7=(_0x3e1747<0x3?_0x1a36b0(_0x2551b7):_0x3e1747>0x3?_0x1a36b0(_0x238bc3,_0x4a6bf0,_0x2551b7):_0x1a36b0(_0x238bc3,_0x4a6bf0))||_0x2551b7;}return _0x3e1747>0x3&&_0x2551b7&&Object[_0x74d8fc(0x2af)](_0x238bc3,_0x4a6bf0,_0x2551b7),_0x2551b7;},__metadata=this&&this[_0x579297(0x2c2)]||function(_0x2b97ef,_0x41fe56){const _0x48dad0=_0x579297;if(typeof Reflect===_0x48dad0(0x291)&&typeof Reflect[_0x48dad0(0x211)]===_0x48dad0(0x209))return Reflect[_0x48dad0(0x211)](_0x2b97ef,_0x41fe56);},__param=this&&this[_0x579297(0x20d)]||function(_0x30f1d0,_0x12d28f){return function(_0x3234ca,_0x381bbc){_0x12d28f(_0x3234ca,_0x381bbc,_0x30f1d0);};};Object[_0x579297(0x2af)](exports,_0x579297(0x30d),{'value':!![]}),exports[_0x579297(0x2cd)]=void 0x0;const common_1=require(_0x579297(0x20e)),typeorm_1=require(_0x579297(0x299)),chatLog_entity_1=require(_0x579297(0x231)),typeorm_2=require(_0x579297(0x2dd)),balance_constant_1=require(_0x579297(0x214)),utils_1=require(_0x579297(0x304)),file_service_1=require('../file/file.service'),redisCache_service_1=require(_0x579297(0x1ff)),redisKey_constant_1=require(_0x579297(0x27c)),model_constant_1=require('../../common/constants/model.constant'),aiAssets_entity_1=require(_0x579297(0x2e4)),aiLog_service_1=require(_0x579297(0x216)),nestjs_cls_1=require(_0x579297(0x24f)),class_validator_1=require('class-validator'),user_service_1=require('../user/user.service'),models_service_1=require(_0x579297(0x241)),store_1=require(_0x579297(0x2bf)),collectType_constant_1=require(_0x579297(0x219)),openapi_1=require('@volcengine/openapi');let ChatLogService=class ChatLogService{constructor(_0x554585,_0x50d753,_0x1a7fff,_0x323931,_0x2800d9,_0x47c914,_0x1118c8,_0x488d29,_0x2fceeb){const _0x3b49e8=_0x579297;this['chatLogEntity']=_0x554585,this[_0x3b49e8(0x217)]=_0x50d753,this['clsService']=_0x1a7fff,this[_0x3b49e8(0x22a)]=_0x323931,this[_0x3b49e8(0x2ac)]=_0x2800d9,this[_0x3b49e8(0x2ea)]=_0x47c914,this[_0x3b49e8(0x29b)]=_0x1118c8,this['modelsService']=_0x488d29,this[_0x3b49e8(0x26a)]=_0x2fceeb;}async['saveChatLog'](_0x4cb353){const _0x36cd48=_0x579297;return await this[_0x36cd48(0x1f8)][_0x36cd48(0x24b)](_0x4cb353);}async[_0x579297(0x236)](_0x3ed9bd){const _0xfc2eab=_0x579297,_0x177df6=_0x3ed9bd[_0xfc2eab(0x207)];let _0x25b2e3={},_0x5ecd29={};if(_0x177df6['indexOf'](_0xfc2eab(0x2e9))!=-0x1)throw new Error(_0xfc2eab(0x248)+_0x177df6);else{let _0x48f62b='',_0x354a68='',_0x18c5da=_0xfc2eab(0x20b),_0x13365f=_0xfc2eab(0x20b),_0x49689f=_0xfc2eab(0x20b),_0x3667b5=_0xfc2eab(0x20b),_0x3a92dc='解析错误',_0x398e17='解析错误',_0x2b257b=_0xfc2eab(0x20b),_0x136998=_0xfc2eab(0x20b);if(_0x177df6[_0xfc2eab(0x2f6)](_0xfc2eab(0x29c))){const [_0x2c6b93]=_0x177df6[_0xfc2eab(0x2c8)](/>(\S+)\n/g);_0x48f62b=_0x354a68=_0x2c6b93[_0xfc2eab(0x2c5)](0x1,_0x2c6b93[_0xfc2eab(0x213)]-0x1),_0x18c5da=_0x177df6[_0xfc2eab(0x2fb)]('\x0a')[0x0][_0xfc2eab(0x2c5)](0x7),_0x13365f=_0x177df6['split']('---')[0x1][_0xfc2eab(0x239)](/\[.*\]|（.*）/g,'')[_0xfc2eab(0x239)](/\n+/g,'\x0a');const _0x27e6ba=_0x177df6[_0xfc2eab(0x2c8)](/!\[image\].*\)/g);_0x27e6ba&&([_0x49689f,_0x3667b5]=_0x27e6ba['map'](_0x361219=>_0x361219[_0xfc2eab(0x2c5)](0x9,_0x361219[_0xfc2eab(0x213)]-0x1)));const _0x1ec364=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp3/g);_0x1ec364&&([_0x3a92dc,_0x398e17]=_0x1ec364);const _0x2c9413=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp4/g);_0x2c9413&&([_0x2b257b,_0x136998]=_0x2c9413);}else{if(_0x177df6[_0xfc2eab(0x2f6)]('🎵')){_0x18c5da=_0x177df6[_0xfc2eab(0x2fb)]('\x0a')[0x0][_0xfc2eab(0x239)](/🎵/g,'');const _0x3e02bc=_0x177df6['split']('--')[_0xfc2eab(0x203)](_0x52fed4=>/-\n\n\[/[_0xfc2eab(0x279)](_0x52fed4));if(_0x3e02bc){const _0x56c7df=_0x3e02bc[_0xfc2eab(0x239)](/\[.*\]|（.*）|-/g,'')[_0xfc2eab(0x239)](/\n+/g,'\x0a');_0x56c7df[_0xfc2eab(0x2f6)]('\x0a')?_0x13365f=_0x56c7df[_0xfc2eab(0x239)]('\x0a',''):_0x13365f=_0x56c7df;}const _0x35b34e=_0x177df6[_0xfc2eab(0x2c8)](/歌曲id(.+)\n/ig);_0x35b34e&&([_0x48f62b,_0x354a68]=_0x35b34e[_0xfc2eab(0x274)](_0x355e5f=>_0x355e5f[_0xfc2eab(0x2c5)](0xc,_0x355e5f[_0xfc2eab(0x213)]-0x1)));const _0x4aa854=_0x177df6[_0xfc2eab(0x2c8)](/\[封面图片\].*\)/g);_0x4aa854&&([_0x49689f,_0x3667b5]=_0x4aa854[_0xfc2eab(0x274)](_0xd74d26=>_0xd74d26[_0xfc2eab(0x2c5)](0x7,_0xd74d26[_0xfc2eab(0x213)]-0x1)));const _0x18347f=_0x177df6['match'](/https:\/\/(.*)\.mp3/g);_0x18347f&&([_0x3a92dc,_0x398e17]=_0x18347f);const _0x3ec481=_0x177df6['match'](/https:\/\/(.*)\.mp4/g);_0x3ec481&&([_0x2b257b,_0x136998]=_0x3ec481);}else{if(_0x177df6[_0xfc2eab(0x246)]('💄')!=-0x1){let _0x3bc858=_0x177df6[_0xfc2eab(0x2fb)]('\x0a');_0x3bc858[_0xfc2eab(0x2b9)](_0x5971ee=>{const _0x1e8a7e=_0xfc2eab;_0x5971ee['indexOf']('🔎')!=-0x1&&(_0x18c5da=_0x5971ee[_0x1e8a7e(0x2fb)]('：')[0x1]);});const _0x16de13=_0x177df6[_0xfc2eab(0x2fb)](_0xfc2eab(0x1fc))[0x1][_0xfc2eab(0x2fb)]('\x0a');if(_0x16de13){const _0x142981=_0x16de13[_0xfc2eab(0x2c4)](_0x43d2fa=>_0x43d2fa[_0xfc2eab(0x246)]('[')==-0x1)['join']('');_0x142981[_0xfc2eab(0x2f6)]('\x0a')?_0x13365f=_0x142981[_0xfc2eab(0x239)]('\x0a',''):_0x13365f=_0x142981;}const _0x5c81bf=_0x177df6[_0xfc2eab(0x2c8)](/歌曲id(.+)\n/ig);_0x5c81bf&&([_0x48f62b,_0x354a68]=_0x5c81bf[_0xfc2eab(0x274)](_0x2de91d=>_0x2de91d['substring'](0xa,_0x2de91d[_0xfc2eab(0x213)]-0x1)));const _0x1706fd=_0x177df6['match'](/\[封面图片\].*\)/g);_0x1706fd&&([_0x49689f,_0x3667b5]=_0x1706fd[_0xfc2eab(0x274)](_0x2b247d=>_0x2b247d[_0xfc2eab(0x2c5)](0x7,_0x2b247d[_0xfc2eab(0x213)]-0x1)));const _0x54c6a6=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp3/g);_0x54c6a6&&([_0x3a92dc,_0x398e17]=_0x54c6a6);const _0x3d4e4a=_0x177df6['match'](/https:\/\/(.*)\.mp4/g);_0x3d4e4a&&([_0x2b257b,_0x136998]=_0x3d4e4a);}else{if(_0x177df6[_0xfc2eab(0x2f6)]('🎁')){_0x18c5da=_0x177df6[_0xfc2eab(0x2fb)]('\x0a')[0x2][_0xfc2eab(0x2fb)]('：**')[0x1];const _0x2a4eea=_0x177df6[_0xfc2eab(0x2fb)]('```')[0x1][_0xfc2eab(0x2fb)]('\x0a');if(_0x2a4eea){const _0x117e4e=_0x2a4eea[_0xfc2eab(0x2c4)](_0x12dfea=>_0x12dfea['indexOf']('[')==-0x1)['join']('');_0x117e4e['startsWith']('\x0a')?_0x13365f=_0x117e4e[_0xfc2eab(0x239)]('\x0a',''):_0x13365f=_0x117e4e;}const _0xdd1585=_0x177df6[_0xfc2eab(0x2c8)](/歌曲ID：(.+)\n/ig);_0xdd1585&&([_0x48f62b,_0x354a68]=_0xdd1585[_0xfc2eab(0x274)](_0x5a49ab=>_0x5a49ab['substring'](0x8,_0x5a49ab[_0xfc2eab(0x213)]-0x1)));const _0x4e4661=_0x177df6[_0xfc2eab(0x2c8)](/\[封面\].*\)/g);_0x4e4661&&([_0x49689f,_0x3667b5]=_0x4e4661[_0xfc2eab(0x274)](_0x5c91e1=>_0x5c91e1[_0xfc2eab(0x2c5)](0x5,_0x5c91e1[_0xfc2eab(0x213)]-0x1)));const _0xe640d7=_0x177df6['match'](/https:\/\/(.*)\.mp3/g);_0xe640d7&&([_0x3a92dc,_0x398e17]=_0xe640d7);const _0x3fd510=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp4/g);_0x3fd510&&([_0x2b257b,_0x136998]=_0x3fd510);}else{if(_0x177df6[_0xfc2eab(0x246)](_0xfc2eab(0x247))!==-0x1){let _0x42359e=_0x177df6['split']('\x0a'),_0x3c12fa=![];const _0xb386ca=[];for(let _0xc0c2fd=0x0;_0xc0c2fd<_0x42359e['length'];_0xc0c2fd++){const _0x2f7dca=_0x42359e[_0xc0c2fd];_0x2f7dca[_0xfc2eab(0x246)](_0xfc2eab(0x247))!==-0x1&&(_0x18c5da=_0x2f7dca[_0xfc2eab(0x2fb)]('：\x20')[0x1]);if(_0x2f7dca['includes'](_0xfc2eab(0x1f0)))_0x3c12fa=![];else{if(_0x3c12fa&&!_0x2f7dca['startsWith']('['))_0xb386ca[_0xfc2eab(0x302)](_0x2f7dca);else _0x2f7dca[_0xfc2eab(0x220)](_0xfc2eab(0x2c0))&&(_0x3c12fa=!![]);}}_0x13365f=_0xb386ca[_0xfc2eab(0x227)]('\x20');const _0x194972=_0x177df6[_0xfc2eab(0x2c8)](/版本ID：(.+)\n/ig);_0x194972&&([_0x48f62b,_0x354a68]=_0x194972[_0xfc2eab(0x274)](_0x5293b2=>_0x5293b2[_0xfc2eab(0x2c5)](0xa,_0x5293b2[_0xfc2eab(0x213)]-0x1)));const _0x3b397b=_0x177df6['match'](/\[封面\].*\)/g);_0x3b397b&&([_0x49689f,_0x3667b5]=_0x3b397b[_0xfc2eab(0x274)](_0x21a4de=>_0x21a4de[_0xfc2eab(0x2c5)](0x5,_0x21a4de[_0xfc2eab(0x213)]-0x1)));const _0x22ebfe=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp3/g);_0x22ebfe&&([_0x3a92dc,_0x398e17]=_0x22ebfe);const _0x2927df=_0x177df6[_0xfc2eab(0x2c8)](/https:\/\/(.*)\.mp4/g);_0x2927df&&([_0x2b257b,_0x136998]=_0x2927df);}else throw new Error('解析错误');}}}}_0x25b2e3={'title':_0x18c5da,'intro':_0x13365f,'mp3':_0x3a92dc,'mp4':_0x2b257b,'cover':_0x49689f,'sunoMusicId':_0x48f62b,'chatLogId':_0x3ed9bd['id'],'userId':_0x3ed9bd[_0xfc2eab(0x301)]},_0x5ecd29={'title':_0x18c5da,'intro':_0x13365f,'mp3':_0x398e17,'mp4':_0x136998,'cover':_0x3667b5,'sunoMusicId':_0x354a68,'chatLogId':_0x3ed9bd['id'],'userId':_0x3ed9bd[_0xfc2eab(0x301)]};}await this[_0xfc2eab(0x26a)][_0xfc2eab(0x20c)](async()=>{const _0x50a1ba=_0xfc2eab;await this[_0x50a1ba(0x217)][_0x50a1ba(0x24b)](_0x25b2e3),await this[_0x50a1ba(0x217)][_0x50a1ba(0x24b)](_0x5ecd29);});}async[_0x579297(0x2d1)](_0x206b35,{id:_0x1a5532,videoUrl:_0x2e5965,state:_0x256bd4,completed:_0x54c8b0}){const _0x58efa2=_0x579297;let _0x40f2f1={'mp4':_0x2e5965,'sunoMusicId':_0x1a5532,'chatLogId':_0x206b35['id'],'userId':_0x206b35[_0x58efa2(0x301)]};if(_0x1a5532){const _0x4eb801=await this[_0x58efa2(0x217)]['findOne']({'where':{'sunoMusicId':_0x1a5532}});_0x4eb801&&(_0x40f2f1=Object['assign'](_0x4eb801,_0x40f2f1));}console['log']('=======================保存视频入库====================',_0x40f2f1),_0x40f2f1=await this[_0x58efa2(0x217)][_0x58efa2(0x24b)](_0x40f2f1),_0x206b35['answer']=_0x256bd4,this[_0x58efa2(0x1f8)][_0x58efa2(0x24b)](_0x206b35),_0x54c8b0&&_0x40f2f1[_0x58efa2(0x233)]&&this[_0x58efa2(0x277)](_0x40f2f1);}async[_0x579297(0x295)](_0x24d19c,_0x2472dd){const _0x344f11=_0x579297;try{const {id:_0x4655c8}=_0x24d19c[_0x344f11(0x2d6)],{model:_0x399757}=_0x2472dd,_0x4ace86={'userId':_0x4655c8,'type':balance_constant_1['DeductionKey']['PAINT_TYPE'],'modelType':_0x344f11(0x29f),'isDelete':![]};_0x2472dd[_0x344f11(0x2a7)]&&(_0x4ace86[_0x344f11(0x2b3)]=_0x2472dd['keyType']);_0x399757&&(_0x4ace86[_0x344f11(0x1f5)]=_0x399757);const _0x4f8a98=await this[_0x344f11(0x1f8)][_0x344f11(0x203)]({'where':_0x4ace86,'order':{'id':_0x344f11(0x23c)}});return _0x4f8a98[_0x344f11(0x2b9)](_0x29c0cf=>{const _0x332e06=_0x344f11;if(_0x29c0cf[_0x332e06(0x307)]===_0x332e06(0x2de)){const _0x2eeb7d=_0x29c0cf[_0x332e06(0x1f5)]==='mj'?0x136:0xa0,_0x623806=_0x29c0cf[_0x332e06(0x207)][_0x332e06(0x220)](_0x332e06(0x2bc))?'tencent':_0x332e06(0x2b4),_0x55ec73=_0x623806===_0x332e06(0x2a6)?'?imageView2/1/w/'+_0x2eeb7d+'/q/55':_0x332e06(0x309)+_0x2eeb7d;_0x29c0cf['thumbImg']=_0x29c0cf[_0x332e06(0x207)]+_0x55ec73;const _0x55fef5=_0x29c0cf[_0x332e06(0x1f6)]?JSON[_0x332e06(0x294)](_0x29c0cf[_0x332e06(0x1f6)]):null;_0x55fef5&&(_0x55fef5?_0x29c0cf[_0x332e06(0x311)]=_0x55fef5?.['components'][0x0]?.['components'][_0x332e06(0x213)]===0x5:_0x29c0cf[_0x332e06(0x311)]=![]);}}),_0x4f8a98;}catch(_0x19cbaa){return console[_0x344f11(0x26b)](_0x19cbaa),_0x19cbaa;}}async[_0x579297(0x218)](_0x5634cf,_0x20d6c8){const _0x271bf3=_0x579297;try{const {id:_0x122b48}=_0x5634cf[_0x271bf3(0x2d6)],{model:_0x1327ab}=_0x20d6c8,_0x821ab6={'userId':_0x122b48,'type':balance_constant_1[_0x271bf3(0x2f1)][_0x271bf3(0x28e)],'modelType':'draw','isDelete':![]};_0x20d6c8[_0x271bf3(0x2a7)]&&(_0x821ab6[_0x271bf3(0x2b3)]=_0x20d6c8[_0x271bf3(0x2a7)]);_0x1327ab&&(_0x821ab6[_0x271bf3(0x1f5)]=_0x1327ab);const [_0x35fc9d,_0x462d19]=await this[_0x271bf3(0x1f8)][_0x271bf3(0x2a2)]({'where':_0x821ab6,'order':{'id':_0x271bf3(0x23c)}});let _0x1c711a=[];return _0x35fc9d[_0x271bf3(0x2b9)](_0xd87355=>{const _0x5ae389=_0x271bf3;_0x1c711a[_0x5ae389(0x302)](this['returnDrawDetail'](_0xd87355));}),{'result':_0x1c711a,'count':_0x462d19};}catch(_0x1fd95d){return console[_0x271bf3(0x26b)](_0x1fd95d),_0x1fd95d;}}async['drawDetail'](_0x23f442,_0x17a0f1){const _0x34945f=_0x579297,_0x2640a5=_0x23f442[_0x34945f(0x2d6)]['id'],_0x2f45c1=await this[_0x34945f(0x1f8)][_0x34945f(0x222)]({'where':{'userId':_0x2640a5,'id':_0x17a0f1}});if(!_0x2f45c1)return'';return this[_0x34945f(0x288)](_0x2f45c1);}[_0x579297(0x288)](_0x190ba1){const _0x2ec9d3=_0x579297;return{'id':_0x190ba1['id'],'createdAt':_0x190ba1[_0x2ec9d3(0x310)],'userId':_0x190ba1[_0x2ec9d3(0x301)],'model':_0x190ba1['model'],'modelType':_0x190ba1['modelType'],'modelSubType':_0x190ba1[_0x2ec9d3(0x2b3)],'fullPrompt':_0x190ba1[_0x2ec9d3(0x2ad)],'originPrompt':_0x190ba1[_0x2ec9d3(0x2ad)],'prompt':_0x190ba1['prompt'],'answer':_0x190ba1[_0x2ec9d3(0x207)],'status':_0x190ba1[_0x2ec9d3(0x207)],'failReason':_0x190ba1[_0x2ec9d3(0x1f2)],'imageUrl':_0x190ba1[_0x2ec9d3(0x273)],'rec':_0x190ba1[_0x2ec9d3(0x2f4)],'requestParams':_0x190ba1['requestParams'],'isCollect':0x0,'collectNum':0x0};}async[_0x579297(0x2b8)](_0x4eca0f){const _0x251376=_0x579297,{page:page=0x1,size:size=0x14,rec:_0x246466,userId:_0x4a73b6,model:_0x3f07e5}=_0x4eca0f,_0x4b193d={'type':balance_constant_1[_0x251376(0x2f1)][_0x251376(0x28e)],'prompt':(0x0,typeorm_2[_0x251376(0x245)])(''),'answer':(0x0,typeorm_2[_0x251376(0x245)])('')};_0x246466&&Object['assign'](_0x4b193d,{'rec':_0x246466}),_0x4a73b6&&Object['assign'](_0x4b193d,{'userId':_0x4a73b6}),_0x3f07e5&&Object[_0x251376(0x2db)](_0x4b193d,{'model':_0x3f07e5});const [_0xa414e5,_0x75a1b2]=await this[_0x251376(0x1f8)][_0x251376(0x2a2)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x4b193d});return _0xa414e5[_0x251376(0x2b9)](_0x153073=>{const _0x4fc8e3=_0x251376;if(_0x153073['type']==='paintCount'){const _0x2948cb=_0x153073['model']==='mj'?0x136:0xa0,_0x425522=_0x153073[_0x4fc8e3(0x207)]['includes'](_0x4fc8e3(0x2bc))?'tencent':_0x4fc8e3(0x2b4),_0x3a2b55=_0x425522==='tencent'?'?imageView2/1/w/'+_0x2948cb+_0x4fc8e3(0x1fd):_0x4fc8e3(0x309)+_0x2948cb;_0x153073['thumbImg']=_0x153073[_0x4fc8e3(0x207)]+_0x3a2b55;const _0x573c8e=_0x153073[_0x4fc8e3(0x1f6)]?JSON[_0x4fc8e3(0x294)](_0x153073[_0x4fc8e3(0x1f6)]):null;_0x573c8e&&(_0x573c8e?_0x153073['isGroup']=_0x573c8e?.[_0x4fc8e3(0x256)][0x0]?.['components'][_0x4fc8e3(0x213)]===0x5:_0x153073[_0x4fc8e3(0x311)]=![]);}}),{'rows':_0xa414e5,'count':_0x75a1b2};}async[_0x579297(0x292)](_0xadfbbc){const _0x183f65=_0x579297,{id:_0x44a240}=_0xadfbbc,_0x15feb0=await this[_0x183f65(0x1f8)][_0x183f65(0x222)]({'where':{'id':_0x44a240,'type':balance_constant_1[_0x183f65(0x2f1)][_0x183f65(0x28e)]}});if(!_0x15feb0)throw new common_1[(_0x183f65(0x2aa))](_0x183f65(0x27b),common_1['HttpStatus'][_0x183f65(0x22d)]);const _0x593a42=_0x15feb0[_0x183f65(0x2f4)]===0x1?0x0:0x1,_0x26e200=await this['chatLogEntity'][_0x183f65(0x2a0)]({'id':_0x44a240},{'rec':_0x593a42});if(_0x26e200[_0x183f65(0x1f7)]>0x0)return(_0x593a42?'推荐':_0x183f65(0x22b))+_0x183f65(0x289);throw new common_1[(_0x183f65(0x2aa))]('你操作的图片不存在、请检查！',common_1[_0x183f65(0x26f)][_0x183f65(0x22d)]);}async[_0x579297(0x2f4)](_0x1cf9fe,_0x5939c0,_0x44a932){const _0x554067=_0x579297,_0x2347c7=await this[_0x554067(0x217)][_0x554067(0x222)]({'where':{'id':_0x1cf9fe}});return _0x2347c7&&(_0x2347c7[_0x554067(0x25d)]=_0x5939c0,_0x44a932&&(_0x2347c7[_0x554067(0x2e0)]=_0x44a932)),await this[_0x554067(0x217)]['save'](_0x2347c7),!![];}async[_0x579297(0x232)](_0x5e8186,_0x344734){const _0x517125=_0x579297;try{const _0x495cb7=(0x0,utils_1[_0x517125(0x26e)])(this['clsService']),{page:page=0x1,size:size=0x14,userId:_0x3383d7,keyword:_0x347c0e,prompt:_0x137b08,saasId:_0x1c2d5c,modelType:_0x4676b9}=_0x5e8186;let _0x4965cd=_0x517125(0x2b0);_0x3383d7&&(_0x4965cd=_0x4965cd+(_0x517125(0x1f4)+_0x3383d7));_0x137b08&&(_0x4965cd=_0x4965cd+(_0x517125(0x210)+_0x137b08+'%\x27'));_0x4676b9&&(_0x4965cd=_0x4965cd+(_0x517125(0x26c)+_0x4676b9+'\x27'));(0x0,utils_1[_0x517125(0x26d)])(this['clsService'])?(0x0,class_validator_1['isDefined'])(_0x1c2d5c)&&(_0x4965cd=_0x4965cd+(_0x517125(0x2e3)+_0x1c2d5c)):_0x4965cd=_0x4965cd+(_0x517125(0x2ed)+_0x495cb7);_0x347c0e&&(_0x4965cd=_0x4965cd+(_0x517125(0x306)+_0x347c0e+_0x517125(0x229)+_0x347c0e+_0x517125(0x2b7)+_0x347c0e+_0x517125(0x2b1)+_0x347c0e+'%\x27)'));const _0x50ed1f=await this['connection'][_0x517125(0x253)](_0x517125(0x22c)+_0x4965cd+_0x517125(0x25e)),_0x1dd20f=await this[_0x517125(0x26a)][_0x517125(0x253)](_0x517125(0x297)+_0x4965cd+_0x517125(0x2d5)+size+_0x517125(0x296)+(page-0x1)*size+'\x0a\x20\x20\x20\x20');return!(0x0,utils_1[_0x517125(0x25c)])(this['clsService'])&&_0x1dd20f['forEach'](_0x420d37=>{const _0x29e0e6=_0x517125;_0x420d37['email']=(0x0,utils_1['maskEmail'])(_0x420d37[_0x29e0e6(0x237)]),_0x420d37[_0x29e0e6(0x221)]=(0x0,utils_1['maskEmail'])(_0x420d37[_0x29e0e6(0x221)]);}),{'rows':_0x1dd20f,'count':Number(_0x50ed1f[0x0]?.[_0x517125(0x281)]||0x0)};}catch(_0x2954e1){return console[_0x517125(0x26b)]('-------------------------ChatALL----------',_0x2954e1),{'rows':[],'count':0x0};}}async[_0x579297(0x2cb)](_0x176e22){const _0x55cbb1=_0x579297;if(!_0x176e22[_0x55cbb1(0x286)][_0x55cbb1(0x213)])return!![];return await this[_0x55cbb1(0x1f8)][_0x55cbb1(0x2a0)]({'id':(0x0,typeorm_2['In'])(_0x176e22['ids'])},{'isDelete':!![]}),!![];}async[_0x579297(0x29e)](_0x46ad0a,_0x42df35){const _0x1391b2=_0x579297,{id:_0x644237}=_0x46ad0a[_0x1391b2(0x2d6)],{groupId:_0x53580b,logType:_0x2eb4a7,modelSubType:_0x5748b0}=_0x42df35,_0x14c59a={'userId':_0x644237,'isDelete':![]};_0x53580b&&Object[_0x1391b2(0x2db)](_0x14c59a,{'groupId':_0x53580b}),_0x2eb4a7&&Object[_0x1391b2(0x2db)](_0x14c59a,{'logType':_0x2eb4a7}),_0x5748b0&&Object['assign'](_0x14c59a,{'modelSubType':_0x5748b0});const _0x17c45e=await this['chatLogEntity']['find']({'where':_0x14c59a})[_0x1391b2(0x2ec)](_0x531c68=>{const _0x2d3983=_0x1391b2;common_1[_0x2d3983(0x250)][_0x2d3983(0x21f)](_0x531c68);});if(!_0x17c45e||_0x17c45e[_0x1391b2(0x213)]===0x0)return[];return _0x17c45e[_0x1391b2(0x274)](_0x30a50a=>{const _0x27c29b=_0x1391b2,{prompt:_0x9c54de,role:_0x42dce0,answer:_0x2c0273,createdAt:_0x24b100,model:_0x1f8586,conversationOptions:_0x4ce182,requestOptions:_0x3c22ee,id:_0x59ccd7,answerMp3:_0x2291bf,think:_0x3f6e64}=_0x30a50a;return{'chatId':_0x59ccd7,'dateTime':(0x0,utils_1[_0x27c29b(0x23d)])(_0x24b100),'text':_0x42dce0===_0x27c29b(0x2d6)?_0x9c54de:_0x2c0273,'think':_0x3f6e64,'textMp3':_0x2291bf,'inversion':_0x42dce0===_0x27c29b(0x2d6),'error':![],'conversationOptions':_0x4ce182?JSON[_0x27c29b(0x294)](_0x4ce182):null,'requestOptions':_0x3c22ee?JSON[_0x27c29b(0x294)](_0x3c22ee):null};});}async[_0x579297(0x2f0)](_0x1376aa){const _0x728bce=_0x579297;return this['chatLogEntity'][_0x728bce(0x203)]({'where':{'groupId':_0x1376aa,'isDelete':![]}});}async[_0x579297(0x266)](_0x19e1b8,_0x3e3ec8,_0x24444b){const _0x48af52=_0x579297,_0x4f8ad6=new Map();if(!_0x3e3ec8[_0x48af52(0x213)])return _0x4f8ad6;const _0x5d9683=await this[_0x48af52(0x217)][_0x48af52(0x203)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x3e3ec8),'deleteFlag':0x0}}),_0x5c64e5=_0x5d9683[_0x48af52(0x274)](_0x3afcdc=>_0x3afcdc['id']),_0x7a99fa=await this[_0x48af52(0x2ac)][_0x48af52(0x290)](_0x19e1b8,_0x5c64e5,_0x24444b),_0x472538=await this[_0x48af52(0x2ac)][_0x48af52(0x212)](_0x5c64e5,_0x24444b);return _0x5d9683['forEach'](_0x328c4d=>{const _0xa59310=_0x48af52;!_0x4f8ad6[_0xa59310(0x27f)](_0x328c4d[_0xa59310(0x2d0)])&&_0x4f8ad6[_0xa59310(0x308)](_0x328c4d[_0xa59310(0x2d0)],[]);const _0x1be4ed=_0x472538[_0xa59310(0x255)](_0x328c4d['id']);_0x4f8ad6[_0xa59310(0x255)](_0x328c4d[_0xa59310(0x2d0)])[_0xa59310(0x302)]({..._0x328c4d,'agree':_0x7a99fa[_0xa59310(0x255)](_0x328c4d['id'])||null,'playNum':_0x1be4ed?.[_0xa59310(0x25f)]||0x0,'visitNum':_0x1be4ed?.['visitNum']||0x0,'agreeNum':_0x1be4ed?.[_0xa59310(0x24a)]||0x0});}),_0x4f8ad6;}async['listByIds'](_0x2a1e42,_0x4ccc67,_0x518828){const _0x39a6dc=_0x579297;if(!_0x4ccc67[_0x39a6dc(0x213)])return[];const _0x1c402d=await this[_0x39a6dc(0x1f8)][_0x39a6dc(0x203)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x4ccc67)}});if(!_0x1c402d[_0x39a6dc(0x213)])return[];const _0x4bd371=await this['getMusicVoMap'](_0x2a1e42[_0x39a6dc(0x2d6)]['id'],_0x4ccc67,_0x518828),_0xd19c39=new Map(),_0x8cf24c=_0x1c402d[_0x39a6dc(0x274)](_0x1207e2=>_0x1207e2[_0x39a6dc(0x301)])[_0x39a6dc(0x2c4)](_0x413e5e=>_0x413e5e);if(_0x8cf24c[_0x39a6dc(0x213)]){const _0x3400bb=(await this['userService'][_0x39a6dc(0x1eb)](_0x8cf24c))['map'](_0x11a2f2=>{const _0x267777=_0x39a6dc;return{'id':_0x11a2f2['id'],'nickname':_0x11a2f2['nickname'],'avatar':_0x11a2f2[_0x267777(0x270)]};});_0x3400bb[_0x39a6dc(0x2b9)](_0x4298c1=>_0xd19c39[_0x39a6dc(0x308)](_0x4298c1['id'],_0x4298c1));}return _0x1c402d[_0x39a6dc(0x274)](_0x1c0004=>{const _0x5ec485=_0x39a6dc;return{..._0x1c0004,'userInfo':_0xd19c39[_0x5ec485(0x255)](_0x1c0004[_0x5ec485(0x301)]),'children':_0x4bd371[_0x5ec485(0x255)](_0x1c0004['id'])||[]};});}async[_0x579297(0x1ee)](_0x2f4d1e){const _0x48a682=_0x579297;if(!_0x2f4d1e[_0x48a682(0x213)])return[];return this[_0x48a682(0x217)][_0x48a682(0x203)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x2f4d1e)}});}async[_0x579297(0x215)](_0x1d3977,_0x15ef7c){const _0x21e97b=_0x579297;let _0x47df5c=collectType_constant_1['UserCollectType'][_0x21e97b(0x2d7)];_0x15ef7c['modelType']==model_constant_1[_0x21e97b(0x2f2)][_0x21e97b(0x2a9)]&&(_0x47df5c=collectType_constant_1[_0x21e97b(0x1fe)]['MUSIC']);const _0x2d3930=await this['userService'][_0x21e97b(0x215)](_0x15ef7c[_0x21e97b(0x235)],_0x15ef7c['size'],_0x1d3977[_0x21e97b(0x2d6)]['id'],collectType_constant_1['UserCollectType']['VIDEO']);if(_0x2d3930[_0x21e97b(0x281)]==0x0)return{'count':0x0,'records':[]};return await this[_0x21e97b(0x2b5)](_0x1d3977,_0x15ef7c,_0x2d3930['rows']['map'](_0x49a145=>_0x49a145['relId']));}async[_0x579297(0x2e6)](_0x16f987,_0x417268){const _0x157107=_0x579297;try{const _0x2f5f90={'isDelete':![],'role':_0x157107(0x2e8),'userId':_0x16f987[_0x157107(0x2d6)]['id'],'modelType':_0x417268[_0x157107(0x254)]};_0x417268[_0x157107(0x2b3)]?_0x2f5f90[_0x157107(0x2b3)]=_0x417268[_0x157107(0x2b3)]:_0x417268['modelType']===model_constant_1[_0x157107(0x2f2)]['MUSIC']&&(_0x2f5f90[_0x157107(0x2b3)]=_0x157107(0x251));const [_0x371809,_0x12a948]=await this[_0x157107(0x1f8)][_0x157107(0x2a2)]({'where':_0x2f5f90,'take':_0x417268[_0x157107(0x287)],'skip':(_0x417268[_0x157107(0x235)]-0x1)*_0x417268[_0x157107(0x287)],'order':{'createdAt':'DESC'}}),_0x1d059c=_0x371809[_0x157107(0x274)](_0x18ca4d=>_0x18ca4d['id']),_0x3e280f=await this['getMusicVoMap'](_0x16f987[_0x157107(0x2d6)]['id'],_0x1d059c,_0x417268[_0x157107(0x254)]),_0xc531fe=_0x371809[_0x157107(0x274)](_0x46b201=>{return{..._0x46b201,'children':_0x3e280f['get'](_0x46b201['id'])||[]};});return{'count':_0x12a948,'records':_0xc531fe};}catch(_0x2eeecc){throw new common_1[(_0x157107(0x2aa))](_0x2eeecc['message'],common_1[_0x157107(0x26f)][_0x157107(0x22d)]);}}async[_0x579297(0x30e)](_0x5631b5,_0x2b873c){const _0x1727b5=_0x579297;if(!_0x2b873c[_0x1727b5(0x286)][_0x1727b5(0x213)])return!![];return await this['aiAssetsEntity'][_0x1727b5(0x2a0)]({'userId':_0x5631b5['user']['id'],'id':(0x0,typeorm_2['In'])(_0x2b873c[_0x1727b5(0x286)])},{'deleteFlag':0x1}),!![];}async['assetsPublish'](_0x5e15a8,_0x3356f4){const _0x101f20=_0x579297;if(!_0x3356f4['ids'])return!![];return await this[_0x101f20(0x26a)]['query'](_0x101f20(0x1fa)+_0x5e15a8[_0x101f20(0x2d6)]['id']+_0x101f20(0x2ff)+_0x3356f4[_0x101f20(0x286)]['join']()+_0x101f20(0x2ab)),!![];}async[_0x579297(0x2b5)](_0xec9692,_0x4912ee,_0x1bcf42=[]){const _0x120457=_0x579297;let _0x3bb5fb=(0x0,utils_1[_0x120457(0x29d)])(this[_0x120457(0x2a1)]);if(!_0x3bb5fb||!_0xec9692[_0x120457(0x2d6)]){const _0x50e9ee=this[_0x120457(0x29b)][_0x120457(0x2cf)](_0xec9692);_0x3bb5fb=_0x50e9ee?.['id'],_0xec9692[_0x120457(0x2d6)]=_0x50e9ee;}try{const {page:page=0x1,size:size=0x14,order:_0x5881ca,keyword:_0x3c396d,modelType:_0x2154c8,modelSubType:_0x5bba10,classify:_0x3dc951}=_0x4912ee;let _0x288b39=_0x120457(0x1f1);if(_0x5881ca==='playNum')_0x288b39=_0x120457(0x318);else _0x5881ca===_0x120457(0x24a)&&(_0x288b39=_0x120457(0x305));const _0x41f37e=await this['connection']['query'](_0x120457(0x282)+_0x2154c8+_0x120457(0x238)+(_0x5bba10?'and\x20cl.modelSubType=\x27'+_0x5bba10+'\x27':'')+_0x120457(0x205)+(_0x3dc951?_0x120457(0x200)+_0x3dc951+'\x27\x20':'')+_0x120457(0x2fa)+(_0x3c396d?_0x120457(0x28d)+_0x3c396d+_0x120457(0x27a):'')+_0x120457(0x21a)+(_0x1bcf42&&_0x1bcf42[_0x120457(0x213)]?_0x120457(0x298)+_0x1bcf42[_0x120457(0x2d3)]()+')\x20':'')+'\x20\x0a\x20\x20\x20\x20\x20\x20'),_0x4a0425=await this[_0x120457(0x26a)]['query'](_0x120457(0x21e)+_0x2154c8+'\x27\x20\x20'+(_0x5bba10?_0x120457(0x1fb)+_0x5bba10+'\x27':'')+_0x120457(0x314)+_0x2154c8+_0x120457(0x242)+(_0x3dc951?_0x120457(0x200)+_0x3dc951+'\x27\x20':'')+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3c396d?_0x120457(0x2da)+_0x3c396d+_0x120457(0x2e7):'')+_0x120457(0x21d)+(_0x1bcf42&&_0x1bcf42[_0x120457(0x213)]?'\x20AND\x20aa.id\x20in\x20('+_0x1bcf42[_0x120457(0x2d3)]()+')\x20':'')+_0x120457(0x2a4)+_0x288b39+'\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x120457(0x296)+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20'),_0x11a4c1=_0x4a0425[_0x120457(0x274)](_0x1fe81b=>_0x1fe81b['id']),_0x4df156=await this[_0x120457(0x2ac)][_0x120457(0x290)](_0x3bb5fb,_0x11a4c1,_0x2154c8),_0x3e4914=await this[_0x120457(0x2ac)]['getExtByRelate'](_0x11a4c1,_0x2154c8),_0x20c8ae=new Map(),_0x15a7b9=_0x4a0425['map'](_0x3b842f=>_0x3b842f[_0x120457(0x301)])[_0x120457(0x2c4)](_0x67657b=>_0x67657b);if(_0x15a7b9['length']){const _0x1463e8=(await this[_0x120457(0x29b)][_0x120457(0x1eb)](_0x15a7b9))['map'](_0x1536a0=>{const _0x22d4ee=_0x120457;return{'id':_0x1536a0['id'],'nickname':_0x1536a0[_0x22d4ee(0x240)],'avatar':_0x1536a0['avatar']};});_0x1463e8['forEach'](_0x5ded3e=>_0x20c8ae['set'](_0x5ded3e['id'],_0x5ded3e));}_0x4a0425[_0x120457(0x2b9)](_0xbc50f4=>{const _0xe2cbce=_0x120457,_0x10279a=_0x3e4914[_0xe2cbce(0x255)](_0xbc50f4['id']);_0xbc50f4['agree']=_0x4df156[_0xe2cbce(0x255)](_0xbc50f4['id'])||null,_0xbc50f4[_0xe2cbce(0x2f8)]=_0x20c8ae[_0xe2cbce(0x255)](_0xbc50f4['userId']),_0xbc50f4[_0xe2cbce(0x24a)]=_0x10279a?.[_0xe2cbce(0x24a)]||0x0;});if(_0x4912ee[_0x120457(0x254)]==model_constant_1[_0x120457(0x2f2)][_0x120457(0x2d7)]){let _0x4c7f99=await this[_0x120457(0x29b)][_0x120457(0x28f)](_0x4a0425,_0xec9692,collectType_constant_1[_0x120457(0x1fe)][_0x120457(0x2d7)]);return _0x4c7f99=await this[_0x120457(0x29b)][_0x120457(0x300)](_0x4a0425,collectType_constant_1['UserCollectType']['VIDEO']),{'records':_0x4c7f99,'count':Number(_0x41f37e[0x0]?.[_0x120457(0x281)]||0x0)};}else{if(_0x4912ee[_0x120457(0x254)]==model_constant_1['EModelType'][_0x120457(0x2a9)]){let _0x5b946d=await this[_0x120457(0x29b)]['mergeCollectData'](_0x4a0425,_0xec9692,collectType_constant_1[_0x120457(0x1fe)][_0x120457(0x2a9)]);return _0x5b946d=await this[_0x120457(0x29b)][_0x120457(0x300)](_0x4a0425,collectType_constant_1[_0x120457(0x1fe)][_0x120457(0x2d7)]),{'records':_0x5b946d,'count':Number(_0x41f37e[0x0]?.[_0x120457(0x281)]||0x0)};}}return{'records':_0x4a0425,'count':Number(_0x41f37e[0x0]?.[_0x120457(0x281)]||0x0)};}catch(_0x2d6bc2){throw new common_1['HttpException'](_0x2d6bc2[_0x120457(0x2d9)],common_1[_0x120457(0x26f)][_0x120457(0x22d)]);}}async[_0x579297(0x1ec)](_0x42db46,_0x17197c){const _0x3c31d8=_0x579297,_0x37a666=(0x0,utils_1[_0x3c31d8(0x29d)])(this[_0x3c31d8(0x2a1)]);try{const _0x89887a=await this[_0x3c31d8(0x26a)][_0x3c31d8(0x253)](_0x3c31d8(0x265)+_0x42db46+_0x3c31d8(0x20a)),_0x5aac3d=_0x89887a[_0x3c31d8(0x274)](_0x21f216=>_0x21f216['id']),_0x15e105=await this[_0x3c31d8(0x2ac)][_0x3c31d8(0x290)](_0x37a666,_0x5aac3d,_0x17197c),_0x593f33=new Map(),_0x57ac1d=_0x89887a[_0x3c31d8(0x274)](_0x56798c=>_0x56798c[_0x3c31d8(0x301)])['filter'](_0x419680=>_0x419680);if(_0x57ac1d[_0x3c31d8(0x213)]){const _0x22fe7a=(await this[_0x3c31d8(0x29b)]['getUserListByIds'](_0x57ac1d))['map'](_0x59599b=>{const _0x144b1c=_0x3c31d8;return{'id':_0x59599b['id'],'nickname':_0x59599b[_0x144b1c(0x240)],'avatar':_0x59599b[_0x144b1c(0x270)]};});_0x22fe7a['forEach'](_0x4b9857=>_0x593f33[_0x3c31d8(0x308)](_0x4b9857['id'],_0x4b9857));}return _0x89887a[_0x3c31d8(0x2b9)](_0x46d5cc=>{const _0xd50168=_0x3c31d8;_0x46d5cc['agree']=_0x15e105[_0xd50168(0x255)](_0x46d5cc['id'])||null,_0x46d5cc[_0xd50168(0x2f8)]=_0x593f33[_0xd50168(0x255)](_0x46d5cc[_0xd50168(0x301)]);}),{..._0x89887a[0x0]};}catch(_0x25aab6){throw new common_1[(_0x3c31d8(0x2aa))](_0x25aab6[_0x3c31d8(0x2d9)],common_1[_0x3c31d8(0x26f)][_0x3c31d8(0x22d)]);}}async['chatGptsList'](_0x4ceaef,_0x494e85){const _0x29aa64=_0x579297,{id:_0x36ad5c}=_0x4ceaef[_0x29aa64(0x2d6)],{groupId:_0x24341e}=_0x494e85,_0x196f15={'userId':_0x36ad5c,'isDelete':![]};_0x24341e&&Object[_0x29aa64(0x2db)](_0x196f15,{'groupId':_0x24341e});const _0x1eaeec=await this[_0x29aa64(0x1f8)][_0x29aa64(0x203)]({'where':_0x196f15});return _0x1eaeec[_0x29aa64(0x274)](_0x3df263=>{const _0x3f42a2=_0x29aa64,{prompt:_0x46ae6a,role:_0x373717,answer:_0x4260f3,createdAt:_0x356a4e,model:_0x4a519b,conversationOptions:_0x4dc881,requestOptions:_0x16897d,id:_0x4313cb}=_0x3df263;return{'chatId':_0x4313cb,'dateTime':(0x0,utils_1[_0x3f42a2(0x23d)])(_0x356a4e),'text':_0x373717===_0x3f42a2(0x2d6)?_0x46ae6a:_0x4260f3,'inversion':_0x373717==='user','error':![],'conversationOptions':_0x4dc881?JSON[_0x3f42a2(0x294)](_0x4dc881):null,'requestOptions':_0x16897d?JSON[_0x3f42a2(0x294)](_0x16897d):null};});}async[_0x579297(0x315)](_0x1ff8f8,_0x36824a){const _0x1cfb3f=_0x579297,{id:_0x5df000}=_0x1ff8f8[_0x1cfb3f(0x2d6)],{id:_0x38863f}=_0x36824a,_0x1cfd90=await this[_0x1cfb3f(0x1f8)][_0x1cfb3f(0x222)]({'where':{'id':_0x38863f,'userId':_0x5df000}});if(!_0x1cfd90)throw new common_1[(_0x1cfb3f(0x2aa))](_0x1cfb3f(0x28a),common_1[_0x1cfb3f(0x26f)][_0x1cfb3f(0x22d)]);const _0x14c435=await this[_0x1cfb3f(0x1f8)][_0x1cfb3f(0x2a0)]({'id':_0x38863f},{'isDelete':!![]});await this['aiAssetsEntity']['update']({'userId':_0x1ff8f8[_0x1cfb3f(0x2d6)]['id'],'chatLogId':_0x38863f},{'deleteFlag':0x1});if(_0x14c435['affected']>0x0)return _0x1cfb3f(0x244);else throw new common_1[(_0x1cfb3f(0x2aa))](_0x1cfb3f(0x28a),common_1['HttpStatus']['BAD_REQUEST']);}async['delByGroupId'](_0xd92b94,_0xa90c83){const _0x601e20=_0x579297,{groupId:_0xe67c21,type:_0x4ca900}=_0xa90c83,{id:_0x577627}=_0xd92b94[_0x601e20(0x2d6)],_0x59bcfe=_0x4ca900&&_0x4ca900===_0x601e20(0x1ef)?{'groupId':_0xe67c21,'userId':_0x577627}:{'groupId':_0xe67c21,'userId':_0x577627},_0x55b131=await this['chatLogEntity'][_0x601e20(0x27d)](_0x59bcfe);if(_0x55b131[_0x601e20(0x1f7)]>0x0)return!![];if(_0x55b131[_0x601e20(0x1f7)]===0x0)throw new common_1[(_0x601e20(0x2aa))](_0x601e20(0x23f),common_1[_0x601e20(0x26f)][_0x601e20(0x22d)]);}async['removeLogsBatch'](_0x4c79bd){const _0x25a4e6=_0x579297,{ids:_0x1916a6,userId:_0x5c2136}=_0x4c79bd;return await this[_0x25a4e6(0x1f8)][_0x25a4e6(0x27d)]({'groupId':(0x0,typeorm_2['In'])(_0x1916a6),'userId':_0x5c2136});}async[_0x579297(0x23a)](_0x141eab,_0x119f15){const _0x4d1ca9=_0x579297,{id:_0x2b6801}=_0x141eab[_0x4d1ca9(0x2d6)],{appId:_0x45fd3d,page:page=0x1,size:size=0xa}=_0x119f15,[_0x13f9a0,_0x33422e]=await this[_0x4d1ca9(0x1f8)]['findAndCount']({'where':{'userId':_0x2b6801,'appId':_0x45fd3d,'role':_0x4d1ca9(0x2e8)},'order':{'id':_0x4d1ca9(0x23c)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x13f9a0,'count':_0x33422e};}async['byId'](_0x441b07,_0x5add1e){const _0x5965c7=_0x579297,_0x38eeb4=_0x441b07[_0x5965c7(0x2d6)]['id'],_0x3b1820=await this[_0x5965c7(0x1f8)]['findOne']({'where':{'userId':_0x38eeb4,'id':_0x5add1e}});if(!_0x3b1820)return'';return{'chatId':_0x3b1820['id'],'dateTime':(0x0,utils_1[_0x5965c7(0x23d)])(_0x3b1820['createdAt']),'text':_0x3b1820[_0x5965c7(0x2c3)]===_0x5965c7(0x2d6)?_0x3b1820['prompt']:_0x3b1820['answer'],'textMp3':_0x3b1820[_0x5965c7(0x2a3)],'inversion':_0x3b1820[_0x5965c7(0x2c3)]===_0x5965c7(0x2d6)};}async[_0x579297(0x2b2)](_0x4cc266,_0x2a0c9f){const _0x41162d=_0x579297,_0x337d82=_0x4cc266[_0x41162d(0x2d6)]['id'],_0x1edacf=await this[_0x41162d(0x1f8)][_0x41162d(0x222)]({'where':{'userId':_0x337d82,'id':_0x2a0c9f}});if(!_0x1edacf)return'';return _0x1edacf[_0x41162d(0x207)];}async[_0x579297(0x2ca)](){const _0x443bb6=_0x579297,_0x5321bc=await this[_0x443bb6(0x26a)][_0x443bb6(0x253)](_0x443bb6(0x2ba));return _0x5321bc;}async[_0x579297(0x264)](){const _0x5d6dc4=_0x579297,_0x3eaff8=await this[_0x5d6dc4(0x26a)][_0x5d6dc4(0x253)](_0x5d6dc4(0x30f));return _0x3eaff8;}async[_0x579297(0x272)](_0x46458e){const _0x39bd2c=_0x579297,_0x2f52fd=await this[_0x39bd2c(0x2ce)][_0x39bd2c(0x2e5)](_0x46458e[_0x39bd2c(0x223)]);_0x2f52fd&&this[_0x39bd2c(0x29b)]['refundBalance4Video'](_0x46458e[_0x39bd2c(0x301)],_0x2f52fd,_0x46458e[_0x39bd2c(0x2c7)],_0x46458e['id']);}async[_0x579297(0x2fd)](_0x5a760d){const _0x1dd3a1=_0x579297,_0x6565f=await this[_0x1dd3a1(0x217)]['findOne']({'where':{'sunoMusicId':_0x5a760d['id']}});if(!_0x6565f)return;const _0x45bf91=await this[_0x1dd3a1(0x1f8)][_0x1dd3a1(0x222)]({'where':{'id':_0x6565f[_0x1dd3a1(0x2d0)]}});_0x45bf91[_0x1dd3a1(0x207)]=_0x5a760d[_0x1dd3a1(0x2d2)],_0x6565f[_0x1dd3a1(0x233)]=_0x5a760d[_0x1dd3a1(0x275)]?.[_0x1dd3a1(0x24e)],await this[_0x1dd3a1(0x1f8)]['save'](_0x45bf91),await this['aiAssetsEntity']['save'](_0x6565f);if(_0x45bf91[_0x1dd3a1(0x207)]==='completed'&&_0x6565f['mp4'])this[_0x1dd3a1(0x277)](_0x6565f);else _0x45bf91[_0x1dd3a1(0x207)]===_0x1dd3a1(0x2bb)&&this[_0x1dd3a1(0x272)](_0x45bf91);}async[_0x579297(0x208)](_0x4b6584){const _0x570a33=_0x579297;console[_0x570a33(0x26b)](_0x570a33(0x276),_0x4b6584);const _0x18c607=await this[_0x570a33(0x217)][_0x570a33(0x222)]({'where':{'sunoMusicId':_0x4b6584[_0x570a33(0x293)]}});if(!_0x18c607)throw new Error(_0x570a33(0x263));const _0x37012f=await this[_0x570a33(0x1f8)]['findOne']({'where':{'id':_0x18c607[_0x570a33(0x2d0)]}});_0x37012f[_0x570a33(0x207)]=_0x4b6584[_0x570a33(0x2d2)],_0x18c607['mp4']=_0x4b6584[_0x570a33(0x259)],await this[_0x570a33(0x1f8)][_0x570a33(0x24b)](_0x37012f),await this[_0x570a33(0x217)][_0x570a33(0x24b)](_0x18c607);if(_0x4b6584[_0x570a33(0x28b)]==='3'&&_0x18c607[_0x570a33(0x233)])this[_0x570a33(0x277)](_0x18c607);else _0x37012f[_0x570a33(0x207)]===_0x570a33(0x317)&&this['refundVideo'](_0x37012f);}async[_0x579297(0x252)](_0x4cd406){const _0x18c55b=_0x579297;console[_0x18c55b(0x26b)](_0x18c55b(0x258),_0x4cd406);const _0x5f22dd=_0x4cd406[_0x18c55b(0x1f9)]?_0x4cd406[_0x18c55b(0x1f9)]:_0x4cd406,_0x4d1b61=await this[_0x18c55b(0x1f8)][_0x18c55b(0x222)]({'where':{'message_id':_0x5f22dd[_0x18c55b(0x293)]}});if(!_0x4d1b61)throw new Error(_0x18c55b(0x263));_0x4d1b61[_0x18c55b(0x207)]=_0x5f22dd[_0x18c55b(0x303)],_0x4cd406[_0x18c55b(0x257)][_0x18c55b(0x30b)]&&(_0x4d1b61[_0x18c55b(0x273)]=JSON[_0x18c55b(0x2ae)](_0x4cd406[_0x18c55b(0x257)][_0x18c55b(0x30b)][_0x18c55b(0x274)](_0x37f34b=>_0x37f34b[_0x18c55b(0x24e)])),await this[_0x18c55b(0x1f8)][_0x18c55b(0x24b)](_0x4d1b61));}async[_0x579297(0x230)](_0x4f371e){const _0x13d510=_0x579297;console['log']('kling通知：',_0x4f371e);const _0xc7e04f=_0x4f371e[_0x13d510(0x1f9)]?_0x4f371e[_0x13d510(0x1f9)]:_0x4f371e,_0x45ff00=await this[_0x13d510(0x217)][_0x13d510(0x222)]({'where':{'sunoMusicId':_0xc7e04f[_0x13d510(0x293)]}});if(!_0x45ff00)throw new Error(_0x13d510(0x263));const _0x3eda4a=await this[_0x13d510(0x1f8)][_0x13d510(0x222)]({'where':{'id':_0x45ff00['chatLogId']}});_0x3eda4a[_0x13d510(0x207)]=_0xc7e04f[_0x13d510(0x303)];_0xc7e04f[_0x13d510(0x257)][_0x13d510(0x312)]&&(_0x45ff00[_0x13d510(0x233)]=_0xc7e04f[_0x13d510(0x257)][_0x13d510(0x312)][0x0]?.[_0x13d510(0x24e)]);await this[_0x13d510(0x1f8)][_0x13d510(0x24b)](_0x3eda4a),await this[_0x13d510(0x217)][_0x13d510(0x24b)](_0x45ff00);if(_0x3eda4a['answer']===_0x13d510(0x267)&&_0x45ff00[_0x13d510(0x233)])this[_0x13d510(0x277)](_0x45ff00);else _0x3eda4a['answer']===_0x13d510(0x317)&&this[_0x13d510(0x272)](_0x3eda4a);}async[_0x579297(0x316)](_0xaa1b77,_0x44427f){const _0x37e53f=_0x579297;console['log'](_0x37e53f(0x204),_0xaa1b77);let _0x11eeaa;_0x44427f===_0x37e53f(0x225)?(_0x11eeaa=await this[_0x37e53f(0x1f8)][_0x37e53f(0x222)]({'where':{'id':Number(_0xaa1b77[_0x37e53f(0x293)])}}),_0x11eeaa[_0x37e53f(0x207)]=_0xaa1b77[_0x37e53f(0x20f)]||_0xaa1b77[_0x37e53f(0x1f9)]['text']):(_0x11eeaa=await this[_0x37e53f(0x1f8)][_0x37e53f(0x222)]({'where':{'message_id':_0xaa1b77['task_id']}}),_0x11eeaa[_0x37e53f(0x207)]=_0xaa1b77[_0x37e53f(0x28b)]);_0x11eeaa[_0x37e53f(0x207)]!==_0x37e53f(0x24c)&&await this[_0x37e53f(0x1f8)][_0x37e53f(0x24b)](_0x11eeaa);if(_0x44427f===_0x37e53f(0x251)){const _0x12895e=await this['aiAssetsEntity'][_0x37e53f(0x203)]({'where':{'chatLogId':_0x11eeaa['id']}});for(const _0x352d82 of _0xaa1b77[_0x37e53f(0x1f9)]){const {title:_0x1dc584,prompt:_0x49b5e9,audio_url:_0x3f6f97,image_url:_0xa42886,task_id:_0x43732d,id:_0x59012a,video_url:_0x34e0fb,duration:_0x57dd7c}=_0x352d82,_0x4fae57=_0x43732d?_0x12895e[_0x37e53f(0x203)](_0x30813a=>_0x30813a[_0x37e53f(0x25a)]===_0x43732d):_0x12895e[_0x37e53f(0x203)](_0x45900e=>_0x45900e[_0x37e53f(0x25a)]===_0x59012a);!_0x4fae57?await this[_0x37e53f(0x217)][_0x37e53f(0x24b)]({'title':_0x1dc584,'intro':_0x49b5e9||_0x352d82[_0x37e53f(0x211)]['prompt'],'duration':_0x57dd7c||0x0,'mp3':_0x3f6f97||'','mp4':_0x34e0fb||'','cover':_0xa42886||'','sunoMusicId':_0x43732d||_0x59012a,'chatLogId':_0x11eeaa['id'],'userId':_0x11eeaa[_0x37e53f(0x301)]}):(_0x4fae57[_0x37e53f(0x2a8)]=_0x1dc584,_0x4fae57[_0x37e53f(0x2df)]=_0x49b5e9||_0x352d82[_0x37e53f(0x211)][_0x37e53f(0x2ad)],_0x4fae57['mp3']=_0x3f6f97||'',_0x4fae57['mp4']=_0x34e0fb||'',_0x4fae57[_0x37e53f(0x2d4)]=_0xa42886||'',await this[_0x37e53f(0x217)][_0x37e53f(0x24b)](_0x4fae57));}}}async[_0x579297(0x249)](_0x2184c7){const _0x56d4ff=_0x579297,_0x22b88e=await this[_0x56d4ff(0x217)][_0x56d4ff(0x222)]({'where':{'id':_0x2184c7}}),[_0x3d4856,_0x5ecbec]=await this[_0x56d4ff(0x22a)][_0x56d4ff(0x2e2)](_0x22b88e[_0x56d4ff(0x233)]);return console['log']('-----------TEST--------',_0x5ecbec),!![];}async['syncVideo'](_0x2eab11){const _0x5544e2=_0x579297,[_0x1adaf5,_0x2cf179]=await this[_0x5544e2(0x22a)][_0x5544e2(0x2e2)](_0x2eab11[_0x5544e2(0x233)]);_0x2eab11[_0x5544e2(0x233)]=_0x1adaf5,_0x2eab11[_0x5544e2(0x2d4)]=_0x2cf179,await this[_0x5544e2(0x217)][_0x5544e2(0x24b)](_0x2eab11);}async[_0x579297(0x2ef)](){const _0x161c9d=_0x579297,_0x182718=await this[_0x161c9d(0x217)][_0x161c9d(0x203)]({'where':[{'cover':(0x0,typeorm_2[_0x161c9d(0x2bd)])('%filesystem.site%')},{'mp3':(0x0,typeorm_2[_0x161c9d(0x2bd)])(_0x161c9d(0x24d))},{'mp4':(0x0,typeorm_2['Like'])(_0x161c9d(0x24d))},{'mp4':(0x0,typeorm_2[_0x161c9d(0x2bd)])('%storage.cdn-luma.com%')}]});for(let _0x3f8496=0x0;_0x3f8496<_0x182718[_0x161c9d(0x213)];_0x3f8496++){const _0x18fe87=_0x182718[_0x3f8496],_0x2abd09=redisKey_constant_1[_0x161c9d(0x228)]+_0x18fe87['id'];try{const _0x346f88=await this[_0x161c9d(0x2ea)]['get']({'key':_0x2abd09});if(_0x346f88)continue;await this[_0x161c9d(0x2ea)][_0x161c9d(0x308)]({'key':_0x2abd09,'val':_0x161c9d(0x2f7)});const {cover:_0x153ca5,mp3:_0x597e42,mp4:_0x5c8280}=_0x18fe87;/filesystem.site/[_0x161c9d(0x279)](_0x153ca5)&&(_0x18fe87[_0x161c9d(0x2d4)]=await this[_0x161c9d(0x22a)][_0x161c9d(0x23b)](_0x153ca5));/filesystem.site/['test'](_0x597e42)&&(_0x18fe87['mp3']=await this[_0x161c9d(0x22a)][_0x161c9d(0x23b)](_0x597e42));if(/filesystem.site|storage.cdn-luma.com/[_0x161c9d(0x279)](_0x5c8280)){if(_0x153ca5)_0x18fe87['mp4']=await this[_0x161c9d(0x22a)][_0x161c9d(0x23b)](_0x5c8280);else{const [_0x2bb54,_0x5ca7d0]=await this[_0x161c9d(0x22a)][_0x161c9d(0x2e2)](_0x5c8280);_0x18fe87[_0x161c9d(0x233)]=_0x2bb54,_0x18fe87['cover']=_0x5ca7d0;}}await this[_0x161c9d(0x217)][_0x161c9d(0x24b)](_0x18fe87);}catch(_0x26a691){common_1[_0x161c9d(0x250)]['error'](_0x26a691);}finally{await this[_0x161c9d(0x2ea)][_0x161c9d(0x23e)]({'key':_0x2abd09});}}}async[_0x579297(0x206)](_0x20c007,_0x2443fa){const _0x5668d2=_0x579297,_0x4018c1=await this['chatLogEntity']['query'](_0x5668d2(0x202)+_0x20c007+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20'+_0x2443fa[_0x5668d2(0x227)]()+'\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20');return _0x4018c1;}async[_0x579297(0x2ee)](){const _0x46ca74=_0x579297,_0x13c9fa=await this[_0x46ca74(0x2ce)][_0x46ca74(0x269)](model_constant_1[_0x46ca74(0x2f2)][_0x46ca74(0x2a9)]);try{const _0x2d1efc=store_1[_0x46ca74(0x280)]['musicTimeoutMs']||0x5,_0x4dd8af=await this[_0x46ca74(0x1f8)]['find']({'where':{'role':_0x46ca74(0x2e8),'modelType':model_constant_1[_0x46ca74(0x2f2)][_0x46ca74(0x2a9)],'answer':(0x0,typeorm_2['In'])([_0x46ca74(0x262),'']),'updatedAt':(0x0,typeorm_2[_0x46ca74(0x234)])(new Date(Date[_0x46ca74(0x2c6)]()-_0x2d1efc*0x3c*0x3e8))}});_0x4dd8af[_0x46ca74(0x2b9)](async _0x4eee61=>{const _0x22ce3d=_0x46ca74;_0x4eee61['answer']='timeout',_0x4eee61['errMsg']=_0x22ce3d(0x24c),this[_0x22ce3d(0x1f8)]['save'](_0x4eee61),await this[_0x22ce3d(0x217)][_0x22ce3d(0x2a0)]({'chatLogId':_0x4eee61['id']},{'deleteFlag':0x1}),this[_0x22ce3d(0x29b)][_0x22ce3d(0x2fc)](_0x4eee61[_0x22ce3d(0x301)],_0x4eee61['id'],_0x4eee61['modelSubType'],!![]);});}catch(_0x4563c4){common_1[_0x46ca74(0x250)][_0x46ca74(0x21f)](_0x4563c4);}}async[_0x579297(0x27e)](){const _0x4a321f=_0x579297,_0x2f3fc8=await this[_0x4a321f(0x264)]();if(!_0x2f3fc8[_0x4a321f(0x213)])return;const _0x4089c2=await this[_0x4a321f(0x2ce)][_0x4a321f(0x268)](model_constant_1[_0x4a321f(0x2f2)][_0x4a321f(0x2d7)],'5'),_0x179614=new openapi_1[(_0x4a321f(0x28c))]({'serviceName':'cv','region':_0x4a321f(0x21c),'host':_0x4089c2[_0x4a321f(0x261)]['proxyUrl'],'accessKeyId':_0x4089c2[_0x4a321f(0x261)]['key'],'secretKey':_0x4089c2[_0x4a321f(0x261)]['secret']}),_0x764270=_0x179614[_0x4a321f(0x2cc)](_0x4a321f(0x30a),{'Version':_0x4a321f(0x284),'method':_0x4a321f(0x2a5),'contentType':'json'});for(const _0x44565b of _0x2f3fc8){if(_0x44565b['message_id'])try{const _0x281ddb=await _0x764270({'req_key':_0x44565b['model'],'task_id':_0x44565b[_0x4a321f(0x201)]});console['log'](_0x4a321f(0x25b),_0x281ddb);if(_0x281ddb[_0x4a321f(0x28b)]=='10000'){_0x44565b['answer']=_0x281ddb['data'][_0x4a321f(0x28b)]==_0x4a321f(0x260)?_0x4a321f(0x267):_0x281ddb[_0x4a321f(0x1f9)][_0x4a321f(0x28b)];const _0x330b92=await this['aiAssetsEntity'][_0x4a321f(0x222)]({'where':{'chatLogId':_0x44565b['id']}}),_0x38bcd6=_0x281ddb[_0x4a321f(0x1f9)]?.['video_url'];_0x330b92[_0x4a321f(0x2d4)]=_0x281ddb[_0x4a321f(0x1f9)]?.[_0x4a321f(0x22e)],_0x330b92[_0x4a321f(0x233)]=_0x38bcd6,await this[_0x4a321f(0x217)][_0x4a321f(0x24b)](_0x330b92),await this[_0x4a321f(0x1f8)][_0x4a321f(0x24b)](_0x44565b),this['syncVideo'](_0x330b92);}}catch(_0x5e99e0){console[_0x4a321f(0x26b)](_0x4a321f(0x313),_0x5e99e0);}}}};function _0x50a8(){const _0x477b99=['userId','push','task_status','../../common/utils','ale.agree_num','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','type','set','?x-oss-process=image/resize,w_','CVSync2AsyncGetResult','images','decorate','__esModule','assetsDel','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x275\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27done\x27,\x20\x27failed\x27,\x27succeed\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','createdAt','isGroup','videos','----------即梦视频错误---------','\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','deleteChatLog','videoNotifySuno','failed','ale.play_num','getUserListByIds','assetsDetail','6CIvakL','listAssetsBychatLogIds','gpts','**版本ID','aa.createdAt','errMsg','InjectRepository','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','model','extend','affected','chatLogEntity','data','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','and\x20cl.modelSubType=\x27','```','/q/55','UserCollectType','../redisCache/redisCache.service','\x20AND\x20aa.classify=\x27','message_id','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','find','suno通知：','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getLastByUserAndAppIds','answer','videoNotifyRunway','function','\x0a\x20\x20\x20\x20\x20\x20','解析错误','transaction','__param','@nestjs/common','text','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','metadata','getExtByRelate','length','../../common/constants/balance.constant','collectPage','../aiLog/aiLog.service','aiAssetsEntity','querDrawLogPage','../../common/constants/collectType.constant','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','8ELSwgd','cn-north-1','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','error','includes','phone','findOne','modelId','5fAdJuB','lyrics','855610IPgyWZ','join','MUSIC_TRANSFER','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','fileService','取消推荐','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','BAD_REQUEST','image_urls','FileService','videoNotifyKLing','./entity/chatLog.entity','querAllChatLog','mp4','LessThan','page','parseAndSaveMusic','email','\x27\x20\x20','replace','byAppId','transferFile','DESC','formatDate','del','当前页面已经没有东西可以删除了！','nickname','../models/models.service','\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','Connection','删除对话记录成功！','Not','indexOf','###🎵\x20歌曲名','音乐生成错误：','syncVideoTest','agreeNum','save','timeout','%filesystem.site%','url','nestjs-cls','Logger','create','videoNotifyKLingImage','query','modelType','get','components','task_result','klingImage通知：','video_url','sunoMusicId','-------------------即梦视频------------------','isSuper','publishFlag','\x20\x0a\x20\x20\x20\x20','playNum','done','modelInfo','IN_PROGRESS','资源不存在！','listUndoneVideoForJMeng','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20and\x20aa.id=','getMusicVoMap','succeed','getModelInfoByKeyType','getModelByType','connection','log','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','isPlatform','getReqSaasId','HttpStatus','avatar','2AmpCLn','refundVideo','fileInfo','map','video','runway通知：','syncVideo','getOwnPropertyDescriptor','test','%\x27)\x20','你推荐的图片不存在、请检查！','../../common/constants/redisKey.constant','delete','syncJMengTask','has','MusicConfig','count','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','AiLogService','2022-08-31','89972AuRjJs','ids','size','returnDrawDetail','图片成功！','你删除的对话记录不存在、请检查！','status','Service','\x20AND\x20aa.title\x20LIKE\x20(\x27%','PAINT_TYPE','mergeCollectData','getAgreeMap','object','recDrawImg','task_id','parse','querDrawLog','\x20OFFSET\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x20AND\x20aa.id\x20in\x20(','@nestjs/typeorm','3449369PnJbFJ','userService','####','getUserId','chatList','draw','update','clsService','findAndCount','answerMp3','\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','POST','tencent','keyType','title','MUSIC','HttpException',')\x0a\x20\x20\x20\x20','aiLogService','prompt','stringify','defineProperty','isDelete\x20=\x200','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','byChatlogId','modelSubType','ali','assetsSquare','ModelsService','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','querAllDrawLog','forEach','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x271\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','FAILED','cos','Like','Injectable','../../common/store','**歌词：**','34879WYFmQt','__metadata','role','filter','substring','now','requestParams','match','2244qonnbU','listUndoneVideoForLuma','delChatLog','createAPI','ChatLogService','modelsService','getUserInfoFromHeader','chatLogId','parseAndSaveVideo','state','toString','cover','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','user','VIDEO','2062449EqEkUn','message','AND\x20aa.title\x20LIKE\x20(\x27%','assign','Repository','typeorm','paintCount','intro','classify','4885170XmaTyH','transferAndCover','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','./entity/aiAssets.entity','getModelById','chatTaskLog','%\x27)','assistant','Request\x20failed','redisCacheService','20yISOmW','catch','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','batchMusicResult','syncAssets','listByGroupId','DeductionKey','EModelType','UserService','rec','AiAssetsEntity','startsWith','lock','userInfo','design:paramtypes','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','split','debuctBalance4Muisc','videoNotify','6134233iewvGx','\x20AND\x20id\x20IN\x20(','mergeCollectCountData'];_0x50a8=function(){return _0x477b99;};return _0x50a8();}ChatLogService=__decorate([(0x0,common_1[_0x579297(0x2be)])(),__param(0x0,(0x0,typeorm_1[_0x579297(0x1f3)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x579297(0x1f3)])(aiAssets_entity_1[_0x579297(0x2f5)])),__metadata(_0x579297(0x2f9),[typeorm_2[_0x579297(0x2dc)],typeorm_2['Repository'],nestjs_cls_1['ClsService'],file_service_1[_0x579297(0x22f)],aiLog_service_1[_0x579297(0x283)],redisCache_service_1['RedisCacheService'],user_service_1[_0x579297(0x2f3)],models_service_1[_0x579297(0x2b6)],typeorm_2[_0x579297(0x243)]])],ChatLogService),exports[_0x579297(0x2cd)]=ChatLogService;