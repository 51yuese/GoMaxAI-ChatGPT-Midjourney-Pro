'use strict';const _0x1cabea=_0x2f71;(function(_0x598743,_0x36d0ce){const _0x3dab52=_0x2f71,_0x10cd68=_0x598743();while(!![]){try{const _0x461f87=-parseInt(_0x3dab52(0x1c1))/0x1*(parseInt(_0x3dab52(0x1cf))/0x2)+parseInt(_0x3dab52(0x21c))/0x3*(parseInt(_0x3dab52(0x24f))/0x4)+parseInt(_0x3dab52(0x1d1))/0x5*(-parseInt(_0x3dab52(0x258))/0x6)+-parseInt(_0x3dab52(0x219))/0x7+parseInt(_0x3dab52(0x26a))/0x8*(-parseInt(_0x3dab52(0x1b9))/0x9)+parseInt(_0x3dab52(0x279))/0xa*(parseInt(_0x3dab52(0x1fa))/0xb)+parseInt(_0x3dab52(0x24c))/0xc;if(_0x461f87===_0x36d0ce)break;else _0x10cd68['push'](_0x10cd68['shift']());}catch(_0xcdd31e){_0x10cd68['push'](_0x10cd68['shift']());}}}(_0x11b5,0x63e64));var __decorate=this&&this['__decorate']||function(_0x22b1c5,_0x55a42d,_0x58adc2,_0x576f09){const _0x4f39f6=_0x2f71;var _0x2c84eb=arguments[_0x4f39f6(0x292)],_0x4fc140=_0x2c84eb<0x3?_0x55a42d:_0x576f09===null?_0x576f09=Object[_0x4f39f6(0x289)](_0x55a42d,_0x58adc2):_0x576f09,_0x4a0f4c;if(typeof Reflect===_0x4f39f6(0x1ce)&&typeof Reflect[_0x4f39f6(0x1e4)]==='function')_0x4fc140=Reflect[_0x4f39f6(0x1e4)](_0x22b1c5,_0x55a42d,_0x58adc2,_0x576f09);else{for(var _0x508eec=_0x22b1c5[_0x4f39f6(0x292)]-0x1;_0x508eec>=0x0;_0x508eec--)if(_0x4a0f4c=_0x22b1c5[_0x508eec])_0x4fc140=(_0x2c84eb<0x3?_0x4a0f4c(_0x4fc140):_0x2c84eb>0x3?_0x4a0f4c(_0x55a42d,_0x58adc2,_0x4fc140):_0x4a0f4c(_0x55a42d,_0x58adc2))||_0x4fc140;}return _0x2c84eb>0x3&&_0x4fc140&&Object[_0x4f39f6(0x241)](_0x55a42d,_0x58adc2,_0x4fc140),_0x4fc140;},__metadata=this&&this[_0x1cabea(0x27d)]||function(_0x229ee0,_0x2a49eb){const _0x5c4f71=_0x1cabea;if(typeof Reflect==='object'&&typeof Reflect[_0x5c4f71(0x1c3)]===_0x5c4f71(0x28f))return Reflect[_0x5c4f71(0x1c3)](_0x229ee0,_0x2a49eb);},__param=this&&this[_0x1cabea(0x1fc)]||function(_0x491683,_0x2e28ef){return function(_0x35ae11,_0x3496ed){_0x2e28ef(_0x35ae11,_0x3496ed,_0x491683);};};function _0x2f71(_0x46196b,_0x4c207a){const _0x11b53f=_0x11b5();return _0x2f71=function(_0x2f71f8,_0x299008){_0x2f71f8=_0x2f71f8-0x1b6;let _0x558b5f=_0x11b53f[_0x2f71f8];return _0x558b5f;},_0x2f71(_0x46196b,_0x4c207a);}Object[_0x1cabea(0x241)](exports,_0x1cabea(0x1e2),{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x1cabea(0x206)),typeorm_1=require(_0x1cabea(0x217)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x1cabea(0x1b8)),balance_constant_1=require(_0x1cabea(0x28b)),user_entity_1=require('../user/user.entity'),utils_1=require(_0x1cabea(0x1bd)),exceljs_1=require('exceljs'),file_service_1=require(_0x1cabea(0x25d)),redisCache_service_1=require(_0x1cabea(0x269)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),aiAssets_entity_1=require(_0x1cabea(0x204)),aiLog_service_1=require('../aiLog/aiLog.service'),jwt=require(_0x1cabea(0x293));function _0x11b5(){const _0x1f1e04=['username','UserEntity','202998memnde','components','用户邮箱','parseAndSaveVideo','chatGptsList','../file/file.service','Logger','super','图片成功！','querDrawLog','JWT_SECRET','提问问题','%storage.cdn-luma.com%','lock','env','解析错误','FileService','../redisCache/redisCache.service','2161272qVepGf','####','exportExcel','filter','提问时间','transferAndCover','音乐生成错误：','query','delChatLog','assistant','%filesystem.site%','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','setHeader','push','RedisCacheService','4990xYhEkX','parse','userId','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','__metadata','parseAndSaveMusic','ali','CHAT_TYPE','chatLogId','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','save','PAINT_TYPE','querAllDrawLog','\x0a\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','Content-Type','getOwnPropertyDescriptor','update','../../common/constants/balance.constant','delByGroupId','attachment;\x20filename=','取消推荐','function','agree','###🎵\x20歌曲名','length','jsonwebtoken','design:paramtypes','删除对话记录成功！','modelType','typeorm','18nQYWJn','chatlog','map','state','../../common/utils','fileService','你推荐的图片不存在、请检查！','isDelete\x20=\x200','5233TdlTMm','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','metadata','ids','%\x27)','getAgreeMap','InjectRepository','回答答案','test','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','user','join','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','object','304KuOawc','addRow','10jLHqXK','startsWith','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','includes','createdAt','assign','isGroup','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','find','Connection','prompt','ale.play_num','deleteChatLog','connection','AND\x20aa.title\x20LIKE\x20(\x27%','getLastByUserAndAppIds','findAndCount','__esModule','userEntity','decorate','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','forEach','?x-oss-process=image/resize,w_','Injectable','cover','formatDate','has','transaction','message','chat.xlsx','aiLogService','answer','thumbImg','Repository','chatList','mp4','\x20\x0a\x20\x20\x20\x20','Like','agreeNum','gpts','affected','13607OpgZLd','rec','__param','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','cos','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','extend','?imageView2/1/w/','AiLogService','AiAssetsEntity','./aiAssets.entity','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','@nestjs/common','video','indexOf','getMusicVoMap','split','findOne','data','transferFile','listByIds','role','substring','replace','authorization','BAD_REQUEST','你删除的对话记录不存在、请检查！','用户名','write','@nestjs/typeorm','assetsDel','4890116Koielp','del','ale.agree_num','38904gxaGiC','match','getExtByRelate','headers','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','redisCacheService','error','get','\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','default','ChatLogEntity','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','playNum','chatLogEntity','removeLogsBatch','size','listUndoneVideo','email','syncAssets','aa.createdAt','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','type','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','你操作的图片不存在、请检查！','paintCount','HttpException','xlsx','/q/55','tencent','HttpStatus','url','maskEmail','DeductionKey','：**','delete','\x20AND\x20id\x20IN\x20(','model','defineProperty','Not','Request\x20failed','ChatLogService','assetsSquare','DESC','set','saveChatLog','verify','end','phone','14168076DojVKY','listAssetsBychatLogIds','byAppId','220NCSQKi','**歌词：**','columns','当前页面已经没有东西可以删除了！','assetsPublish','recDrawImg','aiAssetsEntity'];_0x11b5=function(){return _0x1f1e04;};return _0x11b5();}let ChatLogService=class ChatLogService{constructor(_0x333e2f,_0x86a10,_0x40a237,_0x5ed319,_0x4d6352,_0x91c02,_0x56f7b8){const _0x225252=_0x1cabea;this[_0x225252(0x229)]=_0x333e2f,this[_0x225252(0x255)]=_0x86a10,this[_0x225252(0x1e3)]=_0x40a237,this[_0x225252(0x1be)]=_0x5ed319,this['aiLogService']=_0x4d6352,this['redisCacheService']=_0x91c02,this[_0x225252(0x1de)]=_0x56f7b8;}async[_0x1cabea(0x248)](_0x26486c){const _0x1d5a6f=_0x1cabea;return await this[_0x1d5a6f(0x229)][_0x1d5a6f(0x283)](_0x26486c);}async[_0x1cabea(0x27e)](_0x428270){const _0x957b1e=_0x1cabea,_0xa8900b=_0x428270[_0x957b1e(0x1f0)];let _0x36c3c5={},_0x3e8380={};if(_0xa8900b[_0x957b1e(0x208)](_0x957b1e(0x243))!=-0x1)throw new Error(_0x957b1e(0x270)+_0xa8900b);else{let _0x5f57c4='',_0x268835='',_0x4abad0='解析错误',_0x580b66=_0x957b1e(0x267),_0x5d55b8=_0x957b1e(0x267),_0x25ef25=_0x957b1e(0x267),_0x58b3ea=_0x957b1e(0x267),_0x398f41='解析错误',_0x51f4e2=_0x957b1e(0x267),_0x35009d=_0x957b1e(0x267);if(_0xa8900b['startsWith'](_0x957b1e(0x26b))){const [_0x3b8c16]=_0xa8900b[_0x957b1e(0x21d)](/>(\S+)\n/g);_0x5f57c4=_0x268835=_0x3b8c16['substring'](0x1,_0x3b8c16[_0x957b1e(0x292)]-0x1),_0x4abad0=_0xa8900b[_0x957b1e(0x20a)]('\x0a')[0x0]['substring'](0x7),_0x580b66=_0xa8900b[_0x957b1e(0x20a)]('---')[0x1][_0x957b1e(0x211)](/\[.*\]|（.*）/g,'')['replace'](/\n+/g,'\x0a');const _0x1b74a9=_0xa8900b['match'](/!\[image\].*\)/g);_0x1b74a9&&([_0x5d55b8,_0x25ef25]=_0x1b74a9[_0x957b1e(0x1bb)](_0x100253=>_0x100253[_0x957b1e(0x210)](0x9,_0x100253[_0x957b1e(0x292)]-0x1)));const _0x5e8d34=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp3/g);_0x5e8d34&&([_0x58b3ea,_0x398f41]=_0x5e8d34);const _0xfdaaf6=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp4/g);_0xfdaaf6&&([_0x51f4e2,_0x35009d]=_0xfdaaf6);}else{if(_0xa8900b[_0x957b1e(0x1d2)]('🎵')){_0x4abad0=_0xa8900b[_0x957b1e(0x20a)]('\x0a')[0x0][_0x957b1e(0x211)](/🎵/g,'');const _0x20ba9c=_0xa8900b[_0x957b1e(0x20a)]('--')['find'](_0x34b0b7=>/-\n\n\[/['test'](_0x34b0b7));if(_0x20ba9c){const _0x183b8b=_0x20ba9c[_0x957b1e(0x211)](/\[.*\]|（.*）|-/g,'')[_0x957b1e(0x211)](/\n+/g,'\x0a');_0x183b8b['startsWith']('\x0a')?_0x580b66=_0x183b8b[_0x957b1e(0x211)]('\x0a',''):_0x580b66=_0x183b8b;}const _0x26bdbf=_0xa8900b['match'](/歌曲id(.+)\n/ig);_0x26bdbf&&([_0x5f57c4,_0x268835]=_0x26bdbf[_0x957b1e(0x1bb)](_0x3bcb47=>_0x3bcb47[_0x957b1e(0x210)](0xc,_0x3bcb47[_0x957b1e(0x292)]-0x1)));const _0x5d4db8=_0xa8900b[_0x957b1e(0x21d)](/\[封面图片\].*\)/g);_0x5d4db8&&([_0x5d55b8,_0x25ef25]=_0x5d4db8[_0x957b1e(0x1bb)](_0xbac4b4=>_0xbac4b4['substring'](0x7,_0xbac4b4[_0x957b1e(0x292)]-0x1)));const _0x2703c6=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp3/g);_0x2703c6&&([_0x58b3ea,_0x398f41]=_0x2703c6);const _0x476c32=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp4/g);_0x476c32&&([_0x51f4e2,_0x35009d]=_0x476c32);}else{if(_0xa8900b[_0x957b1e(0x208)]('💄')!=-0x1){let _0x36f82c=_0xa8900b[_0x957b1e(0x20a)]('\x0a');_0x36f82c[_0x957b1e(0x1e6)](_0x1b2b0e=>{const _0x3d73a1=_0x957b1e;_0x1b2b0e[_0x3d73a1(0x208)]('🔎')!=-0x1&&(_0x4abad0=_0x1b2b0e[_0x3d73a1(0x20a)]('：')[0x1]);});const _0x503a48=_0xa8900b[_0x957b1e(0x20a)]('```')[0x1][_0x957b1e(0x20a)]('\x0a');if(_0x503a48){const _0x301ae9=_0x503a48[_0x957b1e(0x26d)](_0x2c2575=>_0x2c2575[_0x957b1e(0x208)]('[')==-0x1)[_0x957b1e(0x1cc)]('');_0x301ae9[_0x957b1e(0x1d2)]('\x0a')?_0x580b66=_0x301ae9[_0x957b1e(0x211)]('\x0a',''):_0x580b66=_0x301ae9;}const _0x304ba5=_0xa8900b[_0x957b1e(0x21d)](/歌曲id(.+)\n/ig);_0x304ba5&&([_0x5f57c4,_0x268835]=_0x304ba5[_0x957b1e(0x1bb)](_0x343966=>_0x343966[_0x957b1e(0x210)](0xa,_0x343966['length']-0x1)));const _0x126571=_0xa8900b[_0x957b1e(0x21d)](/\[封面图片\].*\)/g);_0x126571&&([_0x5d55b8,_0x25ef25]=_0x126571[_0x957b1e(0x1bb)](_0x145d3a=>_0x145d3a['substring'](0x7,_0x145d3a[_0x957b1e(0x292)]-0x1)));const _0x338071=_0xa8900b['match'](/https:\/\/(.*)\.mp3/g);_0x338071&&([_0x58b3ea,_0x398f41]=_0x338071);const _0x1a271b=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp4/g);_0x1a271b&&([_0x51f4e2,_0x35009d]=_0x1a271b);}else{if(_0xa8900b[_0x957b1e(0x1d2)]('🎁')){_0x4abad0=_0xa8900b['split']('\x0a')[0x2][_0x957b1e(0x20a)](_0x957b1e(0x23d))[0x1];const _0x23a958=_0xa8900b[_0x957b1e(0x20a)]('```')[0x1][_0x957b1e(0x20a)]('\x0a');if(_0x23a958){const _0x25ad08=_0x23a958['filter'](_0x52b3c7=>_0x52b3c7[_0x957b1e(0x208)]('[')==-0x1)[_0x957b1e(0x1cc)]('');_0x25ad08[_0x957b1e(0x1d2)]('\x0a')?_0x580b66=_0x25ad08['replace']('\x0a',''):_0x580b66=_0x25ad08;}const _0x44d09a=_0xa8900b[_0x957b1e(0x21d)](/歌曲ID：(.+)\n/ig);_0x44d09a&&([_0x5f57c4,_0x268835]=_0x44d09a[_0x957b1e(0x1bb)](_0xb6d91e=>_0xb6d91e[_0x957b1e(0x210)](0x8,_0xb6d91e[_0x957b1e(0x292)]-0x1)));const _0x50ba32=_0xa8900b[_0x957b1e(0x21d)](/\[封面\].*\)/g);_0x50ba32&&([_0x5d55b8,_0x25ef25]=_0x50ba32[_0x957b1e(0x1bb)](_0x4df697=>_0x4df697['substring'](0x5,_0x4df697['length']-0x1)));const _0x3b43c6=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp3/g);_0x3b43c6&&([_0x58b3ea,_0x398f41]=_0x3b43c6);const _0x25076e=_0xa8900b['match'](/https:\/\/(.*)\.mp4/g);_0x25076e&&([_0x51f4e2,_0x35009d]=_0x25076e);}else{if(_0xa8900b['indexOf'](_0x957b1e(0x291))!==-0x1){let _0x5911a3=_0xa8900b['split']('\x0a'),_0x1293d1=![];const _0x202cb8=[];for(let _0x4b986a=0x0;_0x4b986a<_0x5911a3['length'];_0x4b986a++){const _0x1bd33e=_0x5911a3[_0x4b986a];_0x1bd33e[_0x957b1e(0x208)](_0x957b1e(0x291))!==-0x1&&(_0x4abad0=_0x1bd33e['split']('：\x20')[0x1]);if(_0x1bd33e[_0x957b1e(0x1d4)]('**版本ID'))_0x1293d1=![];else{if(_0x1293d1&&!_0x1bd33e[_0x957b1e(0x1d2)]('['))_0x202cb8[_0x957b1e(0x277)](_0x1bd33e);else _0x1bd33e['includes'](_0x957b1e(0x250))&&(_0x1293d1=!![]);}}_0x580b66=_0x202cb8[_0x957b1e(0x1cc)]('\x20');const _0x347399=_0xa8900b[_0x957b1e(0x21d)](/版本ID：(.+)\n/ig);_0x347399&&([_0x5f57c4,_0x268835]=_0x347399[_0x957b1e(0x1bb)](_0x12c82c=>_0x12c82c['substring'](0xa,_0x12c82c[_0x957b1e(0x292)]-0x1)));const _0x5d16ba=_0xa8900b[_0x957b1e(0x21d)](/\[封面\].*\)/g);_0x5d16ba&&([_0x5d55b8,_0x25ef25]=_0x5d16ba[_0x957b1e(0x1bb)](_0x326581=>_0x326581[_0x957b1e(0x210)](0x5,_0x326581['length']-0x1)));const _0x4917f5=_0xa8900b['match'](/https:\/\/(.*)\.mp3/g);_0x4917f5&&([_0x58b3ea,_0x398f41]=_0x4917f5);const _0x283d4a=_0xa8900b[_0x957b1e(0x21d)](/https:\/\/(.*)\.mp4/g);_0x283d4a&&([_0x51f4e2,_0x35009d]=_0x283d4a);}else throw new Error(_0x957b1e(0x267));}}}}_0x36c3c5={'title':_0x4abad0,'intro':_0x580b66,'mp3':_0x58b3ea,'mp4':_0x51f4e2,'cover':_0x5d55b8,'sunoMusicId':_0x5f57c4,'chatLogId':_0x428270['id'],'userId':_0x428270['userId']},_0x3e8380={'title':_0x4abad0,'intro':_0x580b66,'mp3':_0x398f41,'mp4':_0x35009d,'cover':_0x25ef25,'sunoMusicId':_0x268835,'chatLogId':_0x428270['id'],'userId':_0x428270[_0x957b1e(0x27b)]};}await this[_0x957b1e(0x1de)][_0x957b1e(0x1ec)](async()=>{const _0x4526b6=_0x957b1e;await this[_0x4526b6(0x255)][_0x4526b6(0x283)](_0x36c3c5),await this[_0x4526b6(0x255)][_0x4526b6(0x283)](_0x3e8380);});}async[_0x1cabea(0x25b)](_0x2cd6fd,_0x244c2c){const _0xd2c321=_0x1cabea,_0x35684a={'mp4':_0x244c2c[_0xd2c321(0x207)]?.[_0xd2c321(0x23a)],'sunoMusicId':_0x244c2c['id'],'chatLogId':_0x2cd6fd['id'],'userId':_0x2cd6fd[_0xd2c321(0x27b)]};await this[_0xd2c321(0x255)][_0xd2c321(0x283)](_0x35684a);}async[_0x1cabea(0x261)](_0x3dd09a,_0x438e76){const _0x6b6b91=_0x1cabea,{id:_0x5ee6be}=_0x3dd09a[_0x6b6b91(0x1cb)],{model:_0x1d66ad}=_0x438e76,_0x34c974={'userId':_0x5ee6be,'type':balance_constant_1[_0x6b6b91(0x23c)][_0x6b6b91(0x284)]};_0x1d66ad&&(_0x34c974[_0x6b6b91(0x240)]=_0x1d66ad);const _0x5f406f=await this[_0x6b6b91(0x229)][_0x6b6b91(0x1d9)]({'where':_0x34c974,'order':{'id':_0x6b6b91(0x246)}});return _0x5f406f['forEach'](_0x4a6a26=>{const _0xe42051=_0x6b6b91;if(_0x4a6a26[_0xe42051(0x231)]===_0xe42051(0x234)){const _0x404f01=_0x4a6a26[_0xe42051(0x240)]==='mj'?0x136:0xa0,_0x1de26c=_0x4a6a26['answer']['includes']('cos')?_0xe42051(0x238):_0xe42051(0x27f),_0x276d6d=_0x1de26c===_0xe42051(0x238)?'?imageView2/1/w/'+_0x404f01+'/q/55':_0xe42051(0x1e7)+_0x404f01;_0x4a6a26['thumbImg']=_0x4a6a26[_0xe42051(0x1f0)]+_0x276d6d;const _0x51ca96=_0x4a6a26[_0xe42051(0x200)]?JSON[_0xe42051(0x27a)](_0x4a6a26[_0xe42051(0x200)]):null;_0x51ca96&&(_0x51ca96?_0x4a6a26['isGroup']=_0x51ca96?.[_0xe42051(0x259)][0x0]?.['components']['length']===0x5:_0x4a6a26['isGroup']=![]);}}),_0x5f406f;}async[_0x1cabea(0x285)](_0x5080e0){const _0x40a6aa=_0x1cabea,{page:page=0x1,size:size=0x14,rec:_0x541fbd,userId:_0x1eb490,model:_0x190972}=_0x5080e0,_0xb71dd1={'type':balance_constant_1['DeductionKey'][_0x40a6aa(0x284)],'prompt':(0x0,typeorm_2[_0x40a6aa(0x242)])(''),'answer':(0x0,typeorm_2[_0x40a6aa(0x242)])('')};_0x541fbd&&Object[_0x40a6aa(0x1d6)](_0xb71dd1,{'rec':_0x541fbd}),_0x1eb490&&Object[_0x40a6aa(0x1d6)](_0xb71dd1,{'userId':_0x1eb490}),_0x190972&&Object[_0x40a6aa(0x1d6)](_0xb71dd1,{'model':_0x190972});const [_0x2cb01c,_0x326930]=await this[_0x40a6aa(0x229)][_0x40a6aa(0x1e1)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0xb71dd1});return _0x2cb01c[_0x40a6aa(0x1e6)](_0x39666a=>{const _0x267f8e=_0x40a6aa;if(_0x39666a[_0x267f8e(0x231)]==='paintCount'){const _0x731cae=_0x39666a['model']==='mj'?0x136:0xa0,_0x37aee6=_0x39666a[_0x267f8e(0x1f0)][_0x267f8e(0x1d4)](_0x267f8e(0x1fe))?_0x267f8e(0x238):_0x267f8e(0x27f),_0x5c0e50=_0x37aee6===_0x267f8e(0x238)?_0x267f8e(0x201)+_0x731cae+_0x267f8e(0x237):_0x267f8e(0x1e7)+_0x731cae;_0x39666a[_0x267f8e(0x1f1)]=_0x39666a[_0x267f8e(0x1f0)]+_0x5c0e50;const _0x446006=_0x39666a[_0x267f8e(0x200)]?JSON[_0x267f8e(0x27a)](_0x39666a['extend']):null;_0x446006&&(_0x446006?_0x39666a['isGroup']=_0x446006?.[_0x267f8e(0x259)][0x0]?.['components'][_0x267f8e(0x292)]===0x5:_0x39666a[_0x267f8e(0x1d7)]=![]);}}),{'rows':_0x2cb01c,'count':_0x326930};}async[_0x1cabea(0x254)](_0x2a83da){const _0x51e72c=_0x1cabea,{id:_0x1a7f68}=_0x2a83da,_0x1cc449=await this['chatLogEntity']['findOne']({'where':{'id':_0x1a7f68,'type':balance_constant_1['DeductionKey'][_0x51e72c(0x284)]}});if(!_0x1cc449)throw new common_1['HttpException'](_0x51e72c(0x1bf),common_1[_0x51e72c(0x239)][_0x51e72c(0x213)]);const _0x207a08=_0x1cc449[_0x51e72c(0x1fb)]===0x1?0x0:0x1,_0x5e679e=await this[_0x51e72c(0x229)][_0x51e72c(0x28a)]({'id':_0x1a7f68},{'rec':_0x207a08});if(_0x5e679e['affected']>0x0)return(_0x207a08?'推荐':_0x51e72c(0x28e))+_0x51e72c(0x260);throw new common_1[(_0x51e72c(0x235))](_0x51e72c(0x233),common_1['HttpStatus'][_0x51e72c(0x213)]);}async[_0x1cabea(0x26c)](_0x36ed05,_0x221103){const _0x295b89=_0x1cabea,_0x1ca34a={'type':balance_constant_1[_0x295b89(0x23c)][_0x295b89(0x280)],'isDelete':![]},{page:page=0x1,size:size=0x1e,prompt:_0x1dea39,email:_0x454a5b}=_0x36ed05;_0x1dea39&&Object[_0x295b89(0x1d6)](_0x1ca34a,{'prompt':(0x0,typeorm_2[_0x295b89(0x1f6)])('%'+_0x1dea39+'%')});if(_0x454a5b){const _0x4d09c5=await this[_0x295b89(0x1e3)]['findOne']({'where':{'email':_0x454a5b}});_0x4d09c5?.['id']&&Object[_0x295b89(0x1d6)](_0x1ca34a,{'userId':_0x4d09c5['id']});}const [_0x323787,_0x169fb7]=await this['chatLogEntity'][_0x295b89(0x1e1)]({'order':{'id':_0x295b89(0x246)},'skip':(page-0x1)*size,'take':size,'where':_0x1ca34a}),_0x5beafe=_0x323787[_0x295b89(0x1bb)](_0x19bc10=>_0x19bc10['userId']),_0x47a3ad=await this[_0x295b89(0x1e3)][_0x295b89(0x1d9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5beafe)}}),_0x3a7dae=_0x323787[_0x295b89(0x1bb)](_0x57ef47=>{const _0x4814de=_0x295b89,_0x31d1ab=_0x47a3ad[_0x4814de(0x1d9)](_0xa314c4=>_0xa314c4['id']===_0x57ef47[_0x4814de(0x27b)]);return{'username':_0x31d1ab?_0x31d1ab['username']:'','email':_0x31d1ab?_0x31d1ab['email']:'','prompt':_0x57ef47[_0x4814de(0x1db)],'answer':_0x57ef47[_0x4814de(0x1f0)]};}),_0x3fe3f8=new exceljs_1[(_0x295b89(0x225))]['Workbook'](),_0x3e8650=_0x3fe3f8['addWorksheet'](_0x295b89(0x1ba));_0x3e8650[_0x295b89(0x251)]=[{'header':_0x295b89(0x215),'key':_0x295b89(0x256),'width':0x14},{'header':_0x295b89(0x25a),'key':_0x295b89(0x22d),'width':0x14},{'header':_0x295b89(0x26e),'key':_0x295b89(0x1d5),'width':0x14},{'header':_0x295b89(0x263),'key':_0x295b89(0x1db),'width':0x50},{'header':_0x295b89(0x1c8),'key':_0x295b89(0x1f0),'width':0x96}],_0x3a7dae[_0x295b89(0x1e6)](_0x573ba2=>_0x3e8650[_0x295b89(0x1d0)](_0x573ba2)),_0x221103[_0x295b89(0x276)](_0x295b89(0x288),'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'),_0x221103[_0x295b89(0x276)]('Content-Disposition',_0x295b89(0x28d)+_0x295b89(0x1ee)),await _0x3fe3f8[_0x295b89(0x236)][_0x295b89(0x216)](_0x221103),_0x221103[_0x295b89(0x24a)]();}async['querAllChatLog'](_0x6d6e57,_0x3297b0){const _0x53f909=_0x1cabea,{page:page=0x1,size:size=0x14,userId:_0x30f6a0,keyword:_0x48efd7,prompt:_0x30459b,modelType:_0xdb0ca5}=_0x6d6e57;let _0x63d257=_0x53f909(0x1c0);_0x30f6a0&&(_0x63d257=_0x63d257+(_0x53f909(0x230)+_0x30f6a0));_0x30459b&&(_0x63d257=_0x63d257+(_0x53f909(0x1e5)+_0x30459b+'%\x27'));_0xdb0ca5&&(_0x63d257=_0x63d257+(_0x53f909(0x1fd)+_0xdb0ca5+'\x27'));_0x48efd7&&(_0x63d257=_0x63d257+(_0x53f909(0x1cd)+_0x48efd7+_0x53f909(0x1c2)+_0x48efd7+_0x53f909(0x1d8)+_0x48efd7+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x48efd7+_0x53f909(0x1c5)));const _0x410a9d=await this['connection']['query'](_0x53f909(0x282)+_0x63d257+_0x53f909(0x1f5)),_0x567292=await this['connection']['query'](_0x53f909(0x1ca)+_0x63d257+_0x53f909(0x232)+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20');return _0x3297b0[_0x53f909(0x1cb)][_0x53f909(0x20f)]!==_0x53f909(0x25f)&&_0x567292[_0x53f909(0x1e6)](_0x3057be=>{const _0x3d7a95=_0x53f909;_0x3057be[_0x3d7a95(0x22d)]=(0x0,utils_1[_0x3d7a95(0x23b)])(_0x3057be['email']),_0x3057be[_0x3d7a95(0x24b)]=(0x0,utils_1[_0x3d7a95(0x23b)])(_0x3057be['phone']);}),{'rows':_0x567292,'count':Number(_0x410a9d[0x0]?.['count']||0x0)};}async[_0x1cabea(0x272)](_0x16e179){const _0x48193e=_0x1cabea;if(!_0x16e179['ids'][_0x48193e(0x292)])return!![];return await this['chatLogEntity'][_0x48193e(0x28a)]({'id':(0x0,typeorm_2['In'])(_0x16e179[_0x48193e(0x1c4)])},{'isDelete':!![]}),!![];}async[_0x1cabea(0x1f3)](_0x56e989,_0x4a62e5){const _0x4db481=_0x1cabea,{id:_0x1a713e}=_0x56e989[_0x4db481(0x1cb)],{groupId:_0x1fbe11,logType:_0x35c874}=_0x4a62e5,_0x5d7a3e={'userId':_0x1a713e,'isDelete':![]};_0x1fbe11&&Object[_0x4db481(0x1d6)](_0x5d7a3e,{'groupId':_0x1fbe11}),_0x35c874&&Object[_0x4db481(0x1d6)](_0x5d7a3e,{'logType':_0x35c874});const _0x16ab1c=await this[_0x4db481(0x229)][_0x4db481(0x1d9)]({'where':_0x5d7a3e})['catch'](_0x19e76d=>{const _0x1ff546=_0x4db481;common_1[_0x1ff546(0x25e)][_0x1ff546(0x222)](_0x19e76d);});if(!_0x16ab1c||_0x16ab1c['length']===0x0)return[];return _0x16ab1c[_0x4db481(0x1bb)](_0x29e30e=>{const _0x2cdeab=_0x4db481,{prompt:_0x1d97b3,role:_0x7ca7eb,answer:_0x29a9f6,createdAt:_0x4f361e,model:_0x2c4ae6,conversationOptions:_0x5b1cd6,requestOptions:_0x1201ec,id:_0x3c4c8f}=_0x29e30e;return{'chatId':_0x3c4c8f,'dateTime':(0x0,utils_1[_0x2cdeab(0x1ea)])(_0x4f361e),'text':_0x7ca7eb===_0x2cdeab(0x1cb)?_0x1d97b3:_0x29a9f6,'inversion':_0x7ca7eb==='user','error':![],'conversationOptions':_0x5b1cd6?JSON[_0x2cdeab(0x27a)](_0x5b1cd6):null,'requestOptions':_0x1201ec?JSON['parse'](_0x1201ec):null};});}async[_0x1cabea(0x209)](_0x328894,_0x2ee1bb,_0x1d27c5){const _0x17cc02=_0x1cabea,_0x5dd3bb=new Map();if(!_0x2ee1bb['length'])return _0x5dd3bb;const _0x3a997f=await this[_0x17cc02(0x255)][_0x17cc02(0x1d9)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x2ee1bb),'deleteFlag':0x0}}),_0x26b605=_0x3a997f[_0x17cc02(0x1bb)](_0x39f5bc=>_0x39f5bc['id']),_0x31a95d=await this[_0x17cc02(0x1ef)]['getAgreeMap'](_0x328894,_0x26b605,_0x1d27c5),_0x15fa35=await this[_0x17cc02(0x1ef)][_0x17cc02(0x21e)](_0x26b605,_0x1d27c5);return _0x3a997f['forEach'](_0x324e64=>{const _0x4eccc7=_0x17cc02;!_0x5dd3bb[_0x4eccc7(0x1eb)](_0x324e64[_0x4eccc7(0x281)])&&_0x5dd3bb[_0x4eccc7(0x247)](_0x324e64[_0x4eccc7(0x281)],[]);const _0x5eecd4=_0x15fa35[_0x4eccc7(0x223)](_0x324e64['id']);_0x5dd3bb['get'](_0x324e64[_0x4eccc7(0x281)])[_0x4eccc7(0x277)]({..._0x324e64,'agree':_0x31a95d['get'](_0x324e64['id'])||null,'playNum':_0x5eecd4?.['playNum']||0x0,'visitNum':_0x5eecd4?.['visitNum']||0x0,'agreeNum':_0x5eecd4?.[_0x4eccc7(0x1f7)]||0x0});}),_0x5dd3bb;}async[_0x1cabea(0x20e)](_0x1964d9,_0x46ffa9,_0x3dc4b3){const _0x2b39ae=_0x1cabea;if(!_0x46ffa9[_0x2b39ae(0x292)])return[];const _0x4164b6=await this[_0x2b39ae(0x229)][_0x2b39ae(0x1d9)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x46ffa9)}});if(!_0x4164b6[_0x2b39ae(0x292)])return[];const _0x73bd6d=await this[_0x2b39ae(0x209)](_0x1964d9[_0x2b39ae(0x1cb)]['id'],_0x46ffa9,_0x3dc4b3);return _0x4164b6[_0x2b39ae(0x1bb)](_0x31a6cd=>{const _0x4e03dc=_0x2b39ae;return{..._0x31a6cd,'children':_0x73bd6d[_0x4e03dc(0x223)](_0x31a6cd['id'])||[]};});}async[_0x1cabea(0x24d)](_0x497793){const _0x3b4df0=_0x1cabea;if(!_0x497793[_0x3b4df0(0x292)])return[];return this[_0x3b4df0(0x255)][_0x3b4df0(0x1d9)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x497793)}});}async['chatTaskLog'](_0x16b4fc,_0x4c5501){const _0x413f66=_0x1cabea;try{const _0x458453={'isDelete':![],'role':_0x413f66(0x273),'userId':_0x16b4fc['user']['id'],'modelType':_0x4c5501[_0x413f66(0x1b7)]},[_0x3ff5d5,_0x271db1]=await this[_0x413f66(0x229)]['findAndCount']({'where':_0x458453,'take':_0x4c5501[_0x413f66(0x22b)],'skip':(_0x4c5501['page']-0x1)*_0x4c5501[_0x413f66(0x22b)],'order':{'createdAt':'DESC'}}),_0xbbbd2c=_0x3ff5d5[_0x413f66(0x1bb)](_0x3eb6fc=>_0x3eb6fc['id']),_0x595e8d=await this[_0x413f66(0x209)](_0x16b4fc[_0x413f66(0x1cb)]['id'],_0xbbbd2c,_0x4c5501[_0x413f66(0x1b7)]),_0x52e657=_0x3ff5d5[_0x413f66(0x1bb)](_0xcaffe7=>{const _0x913109=_0x413f66;return{..._0xcaffe7,'children':_0x595e8d[_0x913109(0x223)](_0xcaffe7['id'])||[]};});return{'count':_0x271db1,'records':_0x52e657};}catch(_0x2ed34e){throw new common_1['HttpException'](_0x2ed34e[_0x413f66(0x1ed)],common_1[_0x413f66(0x239)][_0x413f66(0x213)]);}}async[_0x1cabea(0x218)](_0x23b656,_0x3a2716){const _0x5a5ce0=_0x1cabea;if(!_0x3a2716['ids']['length'])return!![];return await this[_0x5a5ce0(0x255)][_0x5a5ce0(0x28a)]({'userId':_0x23b656[_0x5a5ce0(0x1cb)]['id'],'id':(0x0,typeorm_2['In'])(_0x3a2716['ids'])},{'deleteFlag':0x1}),!![];}async[_0x1cabea(0x253)](_0x3fc1fd,_0x3a2b58){const _0xfe8f96=_0x1cabea;if(!_0x3a2b58[_0xfe8f96(0x1c4)])return!![];return await this[_0xfe8f96(0x1de)][_0xfe8f96(0x271)](_0xfe8f96(0x220)+_0x3fc1fd[_0xfe8f96(0x1cb)]['id']+_0xfe8f96(0x23f)+_0x3a2b58[_0xfe8f96(0x1c4)][_0xfe8f96(0x1cc)]()+')\x0a\x20\x20\x20\x20'),!![];}async[_0x1cabea(0x245)](_0x353aee,_0x57a1ad){const _0x111fdd=_0x1cabea;let _0x2d57e1;if(_0x353aee[_0x111fdd(0x21f)][_0x111fdd(0x212)]){const _0x13d7f8=_0x353aee['headers'][_0x111fdd(0x212)]['split']('\x20'),_0x48c94c=jwt[_0x111fdd(0x249)](_0x13d7f8[0x1],process[_0x111fdd(0x266)][_0x111fdd(0x262)]);_0x2d57e1=_0x48c94c['id'];}try{const {page:page=0x1,size:size=0x14,order:_0x17462c,keyword:_0x4bd2a5,modelType:_0x12668f}=_0x57a1ad;let _0x1a13ca=_0x111fdd(0x22f);if(_0x17462c===_0x111fdd(0x228))_0x1a13ca=_0x111fdd(0x1dc);else _0x17462c===_0x111fdd(0x1f7)&&(_0x1a13ca=_0x111fdd(0x21b));const _0x19661e=await this[_0x111fdd(0x1de)]['query'](_0x111fdd(0x275)+_0x12668f+_0x111fdd(0x227)+(_0x4bd2a5?_0x111fdd(0x1df)+_0x4bd2a5+_0x111fdd(0x1c5):'')+_0x111fdd(0x286)),_0x1b982d=await this[_0x111fdd(0x1de)][_0x111fdd(0x271)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27'+_0x12668f+_0x111fdd(0x205)+_0x12668f+_0x111fdd(0x224)+(_0x4bd2a5?_0x111fdd(0x1df)+_0x4bd2a5+'%\x27)':'')+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x1a13ca+_0x111fdd(0x1ff)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x111fdd(0x286)),_0x2a71c8=_0x1b982d['map'](_0x3d9a2d=>_0x3d9a2d['id']),_0x43957c=await this[_0x111fdd(0x1ef)][_0x111fdd(0x1c6)](_0x2d57e1,_0x2a71c8,_0x12668f);return _0x1b982d[_0x111fdd(0x1e6)](_0x433276=>{const _0x547d62=_0x111fdd;_0x433276[_0x547d62(0x290)]=_0x43957c[_0x547d62(0x223)](_0x433276['id'])||null;}),{'records':_0x1b982d,'count':Number(_0x19661e[0x0]?.['count']||0x0)};}catch(_0x33a867){throw new common_1[(_0x111fdd(0x235))](_0x33a867[_0x111fdd(0x1ed)],common_1['HttpStatus'][_0x111fdd(0x213)]);}}async[_0x1cabea(0x25c)](_0x50da9a,_0x4232de){const _0x45d1fd=_0x1cabea,{id:_0x528236}=_0x50da9a[_0x45d1fd(0x1cb)],{groupId:_0x594a53}=_0x4232de,_0x312d65={'userId':_0x528236,'isDelete':![]};_0x594a53&&Object['assign'](_0x312d65,{'groupId':_0x594a53});const _0x4e1be6=await this[_0x45d1fd(0x229)][_0x45d1fd(0x1d9)]({'where':_0x312d65});return _0x4e1be6[_0x45d1fd(0x1bb)](_0x567bcb=>{const _0x1e83bd=_0x45d1fd,{prompt:_0x3b2927,role:_0x3accf9,answer:_0x295e5d,createdAt:_0x5199a2,model:_0x1ae391,conversationOptions:_0xe4daaa,requestOptions:_0x567308,id:_0x4ce372}=_0x567bcb;return{'chatId':_0x4ce372,'dateTime':(0x0,utils_1[_0x1e83bd(0x1ea)])(_0x5199a2),'text':_0x3accf9==='user'?_0x3b2927:_0x295e5d,'inversion':_0x3accf9==='user','error':![],'conversationOptions':_0xe4daaa?JSON[_0x1e83bd(0x27a)](_0xe4daaa):null,'requestOptions':_0x567308?JSON[_0x1e83bd(0x27a)](_0x567308):null};});}async[_0x1cabea(0x1dd)](_0x39ecc6,_0x373c25){const _0x47fccb=_0x1cabea,{id:_0x118f80}=_0x39ecc6[_0x47fccb(0x1cb)],{id:_0x2a0ec3}=_0x373c25,_0x3e05e7=await this[_0x47fccb(0x229)][_0x47fccb(0x20b)]({'where':{'id':_0x2a0ec3,'userId':_0x118f80}});if(!_0x3e05e7)throw new common_1['HttpException'](_0x47fccb(0x214),common_1[_0x47fccb(0x239)][_0x47fccb(0x213)]);const _0x3f0f1b=await this[_0x47fccb(0x229)][_0x47fccb(0x28a)]({'id':_0x2a0ec3},{'isDelete':!![]});if(_0x3f0f1b[_0x47fccb(0x1f9)]>0x0)return _0x47fccb(0x1b6);else throw new common_1[(_0x47fccb(0x235))](_0x47fccb(0x214),common_1[_0x47fccb(0x239)][_0x47fccb(0x213)]);}async[_0x1cabea(0x28c)](_0x389980,_0xfd1793){const _0x401e3b=_0x1cabea,{groupId:_0x33fec8,type:_0x1a6a64}=_0xfd1793,{id:_0x29ec2f}=_0x389980[_0x401e3b(0x1cb)],_0x89e5f0=_0x1a6a64&&_0x1a6a64===_0x401e3b(0x1f8)?{'groupId':_0x33fec8,'userId':_0x29ec2f}:{'groupId':_0x33fec8,'userId':_0x29ec2f},_0x56e0c2=await this[_0x401e3b(0x229)][_0x401e3b(0x23e)](_0x89e5f0);if(_0x56e0c2[_0x401e3b(0x1f9)]>0x0)return!![];if(_0x56e0c2[_0x401e3b(0x1f9)]===0x0)throw new common_1['HttpException'](_0x401e3b(0x252),common_1[_0x401e3b(0x239)]['BAD_REQUEST']);}async[_0x1cabea(0x22a)](_0x50c960){const _0x22bdf5=_0x1cabea,{ids:_0x35493c,userId:_0x5be829}=_0x50c960;return await this[_0x22bdf5(0x229)][_0x22bdf5(0x23e)]({'groupId':(0x0,typeorm_2['In'])(_0x35493c),'userId':_0x5be829});}async[_0x1cabea(0x24e)](_0x5758b7,_0x380dac){const _0x5e2d61=_0x1cabea,{id:_0x1b87a7}=_0x5758b7['user'],{appId:_0x29f591,page:page=0x1,size:size=0xa}=_0x380dac,[_0x586a58,_0x56a953]=await this[_0x5e2d61(0x229)][_0x5e2d61(0x1e1)]({'where':{'userId':_0x1b87a7,'appId':_0x29f591,'role':'assistant'},'order':{'id':_0x5e2d61(0x246)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x586a58,'count':_0x56a953};}async[_0x1cabea(0x22c)](){const _0x32d615=_0x1cabea,_0x587da8=await this[_0x32d615(0x1de)][_0x32d615(0x271)](_0x32d615(0x287));return _0x587da8;}async['asyncVideo'](_0x364479){const _0x251099=_0x1cabea,_0x47e7d3=await this[_0x251099(0x255)][_0x251099(0x20b)]({'where':{'sunoMusicId':_0x364479['task_id']}});if(!_0x47e7d3)throw new Error('资源不存在！');const _0x516a83=await this[_0x251099(0x229)][_0x251099(0x20b)]({'where':{'id':_0x47e7d3['chatLogId']}});_0x516a83[_0x251099(0x1f0)]=_0x364479[_0x251099(0x20c)][_0x251099(0x1bc)],_0x47e7d3[_0x251099(0x1f4)]=_0x364479[_0x251099(0x20c)]['video']?.['url'],await this[_0x251099(0x229)][_0x251099(0x283)](_0x516a83),await this[_0x251099(0x255)]['save'](_0x47e7d3);}async[_0x1cabea(0x22e)](){const _0x38ae72=_0x1cabea,_0x3bcf6e=await this[_0x38ae72(0x255)][_0x38ae72(0x1d9)]({'where':[{'cover':(0x0,typeorm_2[_0x38ae72(0x1f6)])(_0x38ae72(0x274))},{'mp3':(0x0,typeorm_2[_0x38ae72(0x1f6)])(_0x38ae72(0x274))},{'mp4':(0x0,typeorm_2[_0x38ae72(0x1f6)])(_0x38ae72(0x274))},{'mp4':(0x0,typeorm_2['Like'])(_0x38ae72(0x264))}]});for(let _0x25a61b=0x0;_0x25a61b<_0x3bcf6e[_0x38ae72(0x292)];_0x25a61b++){const _0x1c8577=_0x3bcf6e[_0x25a61b],_0x5b7a89=redisKey_constant_1['MUSIC_TRANSFER']+_0x1c8577['id'];try{const _0x3062f5=await this[_0x38ae72(0x221)]['get']({'key':_0x5b7a89});if(_0x3062f5)continue;await this['redisCacheService'][_0x38ae72(0x247)]({'key':_0x5b7a89,'val':_0x38ae72(0x265)});const {cover:_0x5513e7,mp3:_0x52903d,mp4:_0x3486f6}=_0x1c8577;/filesystem.site/['test'](_0x5513e7)&&(_0x1c8577[_0x38ae72(0x1e9)]=await this[_0x38ae72(0x1be)][_0x38ae72(0x20d)](_0x5513e7));/filesystem.site/[_0x38ae72(0x1c9)](_0x52903d)&&(_0x1c8577['mp3']=await this[_0x38ae72(0x1be)][_0x38ae72(0x20d)](_0x52903d));if(/filesystem.site|storage.cdn-luma.com/['test'](_0x3486f6)){if(_0x5513e7)_0x1c8577[_0x38ae72(0x1f4)]=await this[_0x38ae72(0x1be)][_0x38ae72(0x20d)](_0x3486f6);else{const [_0x563e16,_0x4e8720]=await this['fileService'][_0x38ae72(0x26f)](_0x3486f6);_0x1c8577[_0x38ae72(0x1f4)]=_0x563e16,_0x1c8577[_0x38ae72(0x1e9)]=_0x4e8720;}}await this[_0x38ae72(0x255)][_0x38ae72(0x283)](_0x1c8577);}catch(_0x118d04){common_1[_0x38ae72(0x25e)][_0x38ae72(0x222)](_0x118d04);}finally{await this[_0x38ae72(0x221)][_0x38ae72(0x21a)]({'key':_0x5b7a89});}}}async[_0x1cabea(0x1e0)](_0x17cee9,_0x1feec0){const _0x36351b=_0x1cabea,_0x297cc3=await this[_0x36351b(0x229)]['query'](_0x36351b(0x1d3)+_0x17cee9+_0x36351b(0x27c)+_0x1feec0[_0x36351b(0x1cc)]()+'\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20');return _0x297cc3;}};ChatLogService=__decorate([(0x0,common_1[_0x1cabea(0x1e8)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x1cabea(0x226)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(aiAssets_entity_1[_0x1cabea(0x203)])),__param(0x2,(0x0,typeorm_1[_0x1cabea(0x1c7)])(user_entity_1[_0x1cabea(0x257)])),__metadata(_0x1cabea(0x294),[typeorm_2['Repository'],typeorm_2[_0x1cabea(0x1f2)],typeorm_2[_0x1cabea(0x1f2)],file_service_1[_0x1cabea(0x268)],aiLog_service_1[_0x1cabea(0x202)],redisCache_service_1[_0x1cabea(0x278)],typeorm_2[_0x1cabea(0x1da)]])],ChatLogService),exports[_0x1cabea(0x244)]=ChatLogService;