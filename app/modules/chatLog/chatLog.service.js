'use strict';const _0x2f25f7=_0x4f69;(function(_0x352f06,_0x30feaa){const _0x1c141b=_0x4f69,_0x11b779=_0x352f06();while(!![]){try{const _0x4b6b7a=-parseInt(_0x1c141b(0x11d))/0x1+parseInt(_0x1c141b(0x159))/0x2*(parseInt(_0x1c141b(0x1b9))/0x3)+-parseInt(_0x1c141b(0x1b1))/0x4+-parseInt(_0x1c141b(0x1f6))/0x5+-parseInt(_0x1c141b(0x18f))/0x6+parseInt(_0x1c141b(0x17b))/0x7*(parseInt(_0x1c141b(0x16b))/0x8)+parseInt(_0x1c141b(0x126))/0x9*(parseInt(_0x1c141b(0x1ea))/0xa);if(_0x4b6b7a===_0x30feaa)break;else _0x11b779['push'](_0x11b779['shift']());}catch(_0x5e3e7c){_0x11b779['push'](_0x11b779['shift']());}}}(_0x71e7,0x22078));function _0x71e7(){const _0x2f2c47=['data','assistant','gpts','assign','failed','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','=======================‰øùÂ≠òËßÜÈ¢ëÂÖ•Â∫ì====================','ËµÑÊ∫ê‰∏çÂ≠òÂú®ÔºÅ','agreeNum','getReqSaasId','join','status','task_result','\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20','sunoÈÄöÁü•Ôºö','playNum','rec','\x0a\x20\x20\x20\x20','Ëß£ÊûêÈîôËØØ','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','transferAndCover','match','redisCacheService','videoNotifySuno','error','video_url','HttpException','paintCount','modelSubType','save','sunoMusicId','mp4','getExtByRelate','ÂèñÊ∂àÊé®Ëçê','includes','listByIds','UserService','findAndCount','listUndoneVideo','2uGTsHO','del','function','isDelete\x20=\x200','lock','DeductionKey','?imageView2/1/w/','clsService','type','count','videoNotify','size','\x0a\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','ids','update','LessThan','text','161944robbvV','transaction','set','isGroup','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','querAllDrawLog','get','map','Âà†Èô§ÂØπËØùËÆ∞ÂΩïÊàêÂäüÔºÅ','aiLogService','__param','###üéµ\x20Ê≠åÊõ≤Âêç','Logger','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','ÂΩìÂâçÈ°µÈù¢Â∑≤ÁªèÊ≤°Êúâ‰∏úË•øÂèØ‰ª•Âà†Èô§‰∫ÜÔºÅ','aa.createdAt','7jlUxWy','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','thumbImg','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','visitNum','\x27\x20\x20','IN_PROGRESS','chatLogId','class-validator','**Ê≠åËØçÔºö**','push','title','../../common/constants/redisKey.constant','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','agree','%\x27)','url','nestjs-cls','lyrics','connection','702840jkWWgU','state','ChatLogService','cover','InjectRepository','substring','/q/55','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','getModelByType','task_id','transferFile','saveChatLog','ModelsService','ale.play_num','EModelType','formatDate','BAD_REQUEST','object','affected','isPlatform','querAllChatLog','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','indexOf','videoNotifyRunway','Not','../models/models.service','?x-oss-process=image/resize,w_','‰Ω†Âà†Èô§ÁöÑÂØπËØùËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','succeed','cos','find','log','__esModule','590880DgAxhf','Request\x20failed','../user/user.service','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','musicTimeoutMs','```','delete','fileService','280074PmNJCP','PAINT_TYPE','videoNotifyKLing','syncVideo','ChatLogEntity','\x20AND\x20id\x20IN\x20(','ali','listByGroupId','chatTaskLog','__metadata','@nestjs/common','MUSIC','modelType','typeorm','batchMusicResult','getOwnPropertyDescriptor','\x20OFFSET\x20','‰Ω†Êé®ËçêÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','chatLogEntity','email','filter','ale.agree_num','isDefined','Repository','\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','chatGptsList','getUserId','assetsSquare','errMsg','####','aiAssetsEntity','chatList','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','getLastByUserAndAppIds','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','removeLogsBatch','decorate','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','AiLogService','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','defineProperty','modelsService','maskEmail','video','MusicConfig','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','extend','delByGroupId','delChatLog','56330BmTBNX','timeout','runwayÈÄöÁü•Ôºö','intro','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','replace','getAgreeMap','length','test','answer','Injectable','userId','291900VfqQOG','./entity/aiAssets.entity','../aiLog/aiLog.service','Èü≥‰πêÁîüÊàêÈîôËØØÔºö','startsWith','deleteChatLog','‰Ω†Êìç‰ΩúÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','userService','modelId','%filesystem.site%','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','isSuper','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20',')\x0a\x20\x20\x20\x20','parse','components','prompt','metadata','and\x20cl.modelSubType=\x27','\x20\x0a\x20\x20\x20\x20','split','refundBalance4Video','query','forEach','../file/file.service','page','Ôºö**','has','HttpStatus','45287wJnoBg','findOne','querDrawLog','refundVideo','Connection','../../common/constants/model.constant','message','ÂõæÁâáÊàêÂäüÔºÅ','mp3','630lukuHn','create','tencent','user','model','Like','getMusicVoMap','assetsDel','catch','syncAssets','__decorate','DESC'];_0x71e7=function(){return _0x2f2c47;};return _0x71e7();}var __decorate=this&&this[_0x2f25f7(0x130)]||function(_0x2d03be,_0x404529,_0x4740d1,_0x3406d7){const _0x5092e5=_0x2f25f7;var _0x398213=arguments[_0x5092e5(0x1f1)],_0x18e013=_0x398213<0x3?_0x404529:_0x3406d7===null?_0x3406d7=Object[_0x5092e5(0x1c8)](_0x404529,_0x4740d1):_0x3406d7,_0x51c705;if(typeof Reflect===_0x5092e5(0x1a0)&&typeof Reflect['decorate']===_0x5092e5(0x15b))_0x18e013=Reflect[_0x5092e5(0x1dd)](_0x2d03be,_0x404529,_0x4740d1,_0x3406d7);else{for(var _0xeb862d=_0x2d03be['length']-0x1;_0xeb862d>=0x0;_0xeb862d--)if(_0x51c705=_0x2d03be[_0xeb862d])_0x18e013=(_0x398213<0x3?_0x51c705(_0x18e013):_0x398213>0x3?_0x51c705(_0x404529,_0x4740d1,_0x18e013):_0x51c705(_0x404529,_0x4740d1))||_0x18e013;}return _0x398213>0x3&&_0x18e013&&Object[_0x5092e5(0x1e1)](_0x404529,_0x4740d1,_0x18e013),_0x18e013;},__metadata=this&&this[_0x2f25f7(0x1c2)]||function(_0x4403a3,_0x5841cb){const _0x1d62ae=_0x2f25f7;if(typeof Reflect===_0x1d62ae(0x1a0)&&typeof Reflect[_0x1d62ae(0x111)]==='function')return Reflect[_0x1d62ae(0x111)](_0x4403a3,_0x5841cb);},__param=this&&this[_0x2f25f7(0x175)]||function(_0x2ed672,_0x92e312){return function(_0x3d7cca,_0x85f575){_0x92e312(_0x3d7cca,_0x85f575,_0x2ed672);};};Object[_0x2f25f7(0x1e1)](exports,_0x2f25f7(0x1b0),{'value':!![]}),exports[_0x2f25f7(0x191)]=void 0x0;function _0x4f69(_0x4606ae,_0x3fb185){const _0x71e7b5=_0x71e7();return _0x4f69=function(_0x4f697b,_0x5bf062){_0x4f697b=_0x4f697b-0x104;let _0x584a8a=_0x71e7b5[_0x4f697b];return _0x584a8a;},_0x4f69(_0x4606ae,_0x3fb185);}const common_1=require(_0x2f25f7(0x1c3)),typeorm_1=require('@nestjs/typeorm'),chatLog_entity_1=require('./entity/chatLog.entity'),typeorm_2=require(_0x2f25f7(0x1c6)),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require('../../common/utils'),file_service_1=require(_0x2f25f7(0x118)),redisCache_service_1=require('../redisCache/redisCache.service'),redisKey_constant_1=require(_0x2f25f7(0x187)),model_constant_1=require(_0x2f25f7(0x122)),aiAssets_entity_1=require(_0x2f25f7(0x1f7)),aiLog_service_1=require(_0x2f25f7(0x1f8)),nestjs_cls_1=require(_0x2f25f7(0x18c)),class_validator_1=require(_0x2f25f7(0x183)),user_service_1=require(_0x2f25f7(0x1b3)),models_service_1=require(_0x2f25f7(0x1a9)),store_1=require('../../common/store');let ChatLogService=class ChatLogService{constructor(_0x349c49,_0x287cbf,_0x3922ad,_0x49178b,_0x1d92c5,_0x46e88e,_0x1f167d,_0x1927bb,_0x1e4cf9){const _0xc93196=_0x2f25f7;this['chatLogEntity']=_0x349c49,this[_0xc93196(0x1d7)]=_0x287cbf,this['clsService']=_0x3922ad,this[_0xc93196(0x1b8)]=_0x49178b,this[_0xc93196(0x174)]=_0x1d92c5,this[_0xc93196(0x148)]=_0x46e88e,this[_0xc93196(0x107)]=_0x1f167d,this[_0xc93196(0x1e2)]=_0x1927bb,this['connection']=_0x1e4cf9;}async[_0x2f25f7(0x19a)](_0x3b629c){return await this['chatLogEntity']['save'](_0x3b629c);}async['parseAndSaveMusic'](_0x307ff9){const _0x58383f=_0x2f25f7,_0x146426=_0x307ff9['answer'];let _0x230c9b={},_0x2a52e6={};if(_0x146426['indexOf'](_0x58383f(0x1b2))!=-0x1)throw new Error(_0x58383f(0x1f9)+_0x146426);else{let _0x43f12c='',_0xc219a1='',_0x3a89ab=_0x58383f(0x144),_0x251725=_0x58383f(0x144),_0x18c8a9=_0x58383f(0x144),_0x15d342='Ëß£ÊûêÈîôËØØ',_0xc36569=_0x58383f(0x144),_0x161d86=_0x58383f(0x144),_0x57d046=_0x58383f(0x144),_0x26c501=_0x58383f(0x144);if(_0x146426[_0x58383f(0x104)](_0x58383f(0x1d6))){const [_0x3d3f53]=_0x146426[_0x58383f(0x147)](/>(\S+)\n/g);_0x43f12c=_0xc219a1=_0x3d3f53['substring'](0x1,_0x3d3f53['length']-0x1),_0x3a89ab=_0x146426['split']('\x0a')[0x0][_0x58383f(0x194)](0x7),_0x251725=_0x146426['split']('---')[0x1][_0x58383f(0x1ef)](/\[.*\]|Ôºà.*Ôºâ/g,'')['replace'](/\n+/g,'\x0a');const _0x596815=_0x146426[_0x58383f(0x147)](/!\[image\].*\)/g);_0x596815&&([_0x18c8a9,_0x15d342]=_0x596815[_0x58383f(0x172)](_0x1c9ab1=>_0x1c9ab1[_0x58383f(0x194)](0x9,_0x1c9ab1[_0x58383f(0x1f1)]-0x1)));const _0x53b6fa=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp3/g);_0x53b6fa&&([_0xc36569,_0x161d86]=_0x53b6fa);const _0x269d49=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp4/g);_0x269d49&&([_0x57d046,_0x26c501]=_0x269d49);}else{if(_0x146426['startsWith']('üéµ')){_0x3a89ab=_0x146426[_0x58383f(0x114)]('\x0a')[0x0]['replace'](/üéµ/g,'');const _0x4ac87f=_0x146426[_0x58383f(0x114)]('--')[_0x58383f(0x1ae)](_0x3b0076=>/-\n\n\[/[_0x58383f(0x1f2)](_0x3b0076));if(_0x4ac87f){const _0x4d0498=_0x4ac87f[_0x58383f(0x1ef)](/\[.*\]|Ôºà.*Ôºâ|-/g,'')[_0x58383f(0x1ef)](/\n+/g,'\x0a');_0x4d0498['startsWith']('\x0a')?_0x251725=_0x4d0498[_0x58383f(0x1ef)]('\x0a',''):_0x251725=_0x4d0498;}const _0x55d23f=_0x146426[_0x58383f(0x147)](/Ê≠åÊõ≤id(.+)\n/ig);_0x55d23f&&([_0x43f12c,_0xc219a1]=_0x55d23f['map'](_0x2fb96a=>_0x2fb96a[_0x58383f(0x194)](0xc,_0x2fb96a[_0x58383f(0x1f1)]-0x1)));const _0x46909d=_0x146426[_0x58383f(0x147)](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x46909d&&([_0x18c8a9,_0x15d342]=_0x46909d[_0x58383f(0x172)](_0x21baa8=>_0x21baa8[_0x58383f(0x194)](0x7,_0x21baa8[_0x58383f(0x1f1)]-0x1)));const _0x37cf0a=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp3/g);_0x37cf0a&&([_0xc36569,_0x161d86]=_0x37cf0a);const _0x4c62dc=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp4/g);_0x4c62dc&&([_0x57d046,_0x26c501]=_0x4c62dc);}else{if(_0x146426[_0x58383f(0x1a6)]('üíÑ')!=-0x1){let _0xf1d857=_0x146426[_0x58383f(0x114)]('\x0a');_0xf1d857['forEach'](_0x531deb=>{const _0x2198b2=_0x58383f;_0x531deb[_0x2198b2(0x1a6)]('üîé')!=-0x1&&(_0x3a89ab=_0x531deb[_0x2198b2(0x114)]('Ôºö')[0x1]);});const _0x2bb329=_0x146426['split'](_0x58383f(0x1b6))[0x1][_0x58383f(0x114)]('\x0a');if(_0x2bb329){const _0x12fc39=_0x2bb329[_0x58383f(0x1cd)](_0x1fbe99=>_0x1fbe99[_0x58383f(0x1a6)]('[')==-0x1)[_0x58383f(0x13c)]('');_0x12fc39[_0x58383f(0x104)]('\x0a')?_0x251725=_0x12fc39[_0x58383f(0x1ef)]('\x0a',''):_0x251725=_0x12fc39;}const _0x4b332f=_0x146426[_0x58383f(0x147)](/Ê≠åÊõ≤id(.+)\n/ig);_0x4b332f&&([_0x43f12c,_0xc219a1]=_0x4b332f[_0x58383f(0x172)](_0x4a6dc7=>_0x4a6dc7[_0x58383f(0x194)](0xa,_0x4a6dc7[_0x58383f(0x1f1)]-0x1)));const _0x1f874e=_0x146426['match'](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x1f874e&&([_0x18c8a9,_0x15d342]=_0x1f874e[_0x58383f(0x172)](_0xed7035=>_0xed7035['substring'](0x7,_0xed7035['length']-0x1)));const _0x16062a=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp3/g);_0x16062a&&([_0xc36569,_0x161d86]=_0x16062a);const _0x14b7d1=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp4/g);_0x14b7d1&&([_0x57d046,_0x26c501]=_0x14b7d1);}else{if(_0x146426[_0x58383f(0x104)]('üéÅ')){_0x3a89ab=_0x146426['split']('\x0a')[0x2][_0x58383f(0x114)](_0x58383f(0x11a))[0x1];const _0x27e005=_0x146426['split'](_0x58383f(0x1b6))[0x1][_0x58383f(0x114)]('\x0a');if(_0x27e005){const _0x2c6db2=_0x27e005[_0x58383f(0x1cd)](_0x5e7ad2=>_0x5e7ad2[_0x58383f(0x1a6)]('[')==-0x1)[_0x58383f(0x13c)]('');_0x2c6db2['startsWith']('\x0a')?_0x251725=_0x2c6db2[_0x58383f(0x1ef)]('\x0a',''):_0x251725=_0x2c6db2;}const _0x187569=_0x146426[_0x58383f(0x147)](/Ê≠åÊõ≤IDÔºö(.+)\n/ig);_0x187569&&([_0x43f12c,_0xc219a1]=_0x187569[_0x58383f(0x172)](_0x2d6583=>_0x2d6583[_0x58383f(0x194)](0x8,_0x2d6583['length']-0x1)));const _0x330814=_0x146426[_0x58383f(0x147)](/\[Â∞ÅÈù¢\].*\)/g);_0x330814&&([_0x18c8a9,_0x15d342]=_0x330814[_0x58383f(0x172)](_0x34f63f=>_0x34f63f[_0x58383f(0x194)](0x5,_0x34f63f[_0x58383f(0x1f1)]-0x1)));const _0x35e4f5=_0x146426['match'](/https:\/\/(.*)\.mp3/g);_0x35e4f5&&([_0xc36569,_0x161d86]=_0x35e4f5);const _0xbb5e29=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp4/g);_0xbb5e29&&([_0x57d046,_0x26c501]=_0xbb5e29);}else{if(_0x146426[_0x58383f(0x1a6)](_0x58383f(0x176))!==-0x1){let _0x384382=_0x146426['split']('\x0a'),_0x4a4a4a=![];const _0x5cd626=[];for(let _0x240557=0x0;_0x240557<_0x384382[_0x58383f(0x1f1)];_0x240557++){const _0x3e6160=_0x384382[_0x240557];_0x3e6160[_0x58383f(0x1a6)](_0x58383f(0x176))!==-0x1&&(_0x3a89ab=_0x3e6160['split']('Ôºö\x20')[0x1]);if(_0x3e6160[_0x58383f(0x154)]('**ÁâàÊú¨ID'))_0x4a4a4a=![];else{if(_0x4a4a4a&&!_0x3e6160['startsWith']('['))_0x5cd626['push'](_0x3e6160);else _0x3e6160[_0x58383f(0x154)](_0x58383f(0x184))&&(_0x4a4a4a=!![]);}}_0x251725=_0x5cd626[_0x58383f(0x13c)]('\x20');const _0x30d19a=_0x146426['match'](/ÁâàÊú¨IDÔºö(.+)\n/ig);_0x30d19a&&([_0x43f12c,_0xc219a1]=_0x30d19a['map'](_0x12a2f6=>_0x12a2f6[_0x58383f(0x194)](0xa,_0x12a2f6[_0x58383f(0x1f1)]-0x1)));const _0x12a1c4=_0x146426[_0x58383f(0x147)](/\[Â∞ÅÈù¢\].*\)/g);_0x12a1c4&&([_0x18c8a9,_0x15d342]=_0x12a1c4[_0x58383f(0x172)](_0x1141f0=>_0x1141f0[_0x58383f(0x194)](0x5,_0x1141f0['length']-0x1)));const _0x28d908=_0x146426[_0x58383f(0x147)](/https:\/\/(.*)\.mp3/g);_0x28d908&&([_0xc36569,_0x161d86]=_0x28d908);const _0x83d74e=_0x146426['match'](/https:\/\/(.*)\.mp4/g);_0x83d74e&&([_0x57d046,_0x26c501]=_0x83d74e);}else throw new Error(_0x58383f(0x144));}}}}_0x230c9b={'title':_0x3a89ab,'intro':_0x251725,'mp3':_0xc36569,'mp4':_0x57d046,'cover':_0x18c8a9,'sunoMusicId':_0x43f12c,'chatLogId':_0x307ff9['id'],'userId':_0x307ff9[_0x58383f(0x1f5)]},_0x2a52e6={'title':_0x3a89ab,'intro':_0x251725,'mp3':_0x161d86,'mp4':_0x26c501,'cover':_0x15d342,'sunoMusicId':_0xc219a1,'chatLogId':_0x307ff9['id'],'userId':_0x307ff9[_0x58383f(0x1f5)]};}await this['connection'][_0x58383f(0x16c)](async()=>{const _0x2b7e22=_0x58383f;await this[_0x2b7e22(0x1d7)]['save'](_0x230c9b),await this[_0x2b7e22(0x1d7)][_0x2b7e22(0x14f)](_0x2a52e6);});}async['parseAndSaveVideo'](_0x456d60,{id:_0x21ba5a,videoUrl:_0x1fc5e5,state:_0x47050d,completed:_0x2f345f}){const _0x3e8638=_0x2f25f7;let _0x16e72b={'mp4':_0x1fc5e5,'sunoMusicId':_0x21ba5a,'chatLogId':_0x456d60['id'],'userId':_0x456d60[_0x3e8638(0x1f5)]};if(_0x21ba5a){const _0x4182f9=await this[_0x3e8638(0x1d7)][_0x3e8638(0x11e)]({'where':{'sunoMusicId':_0x21ba5a}});_0x4182f9&&(_0x16e72b=Object[_0x3e8638(0x135)](_0x4182f9,_0x16e72b));}console[_0x3e8638(0x1af)](_0x3e8638(0x138),_0x16e72b),_0x16e72b=await this[_0x3e8638(0x1d7)][_0x3e8638(0x14f)](_0x16e72b),_0x456d60[_0x3e8638(0x1f3)]=_0x47050d,this[_0x3e8638(0x1cb)][_0x3e8638(0x14f)](_0x456d60),_0x2f345f&&_0x16e72b[_0x3e8638(0x151)]&&this[_0x3e8638(0x1bc)](_0x16e72b);}async[_0x2f25f7(0x11f)](_0x1961b9,_0x4dc613){const _0x1fbd5f=_0x2f25f7,{id:_0x581e8e}=_0x1961b9[_0x1fbd5f(0x129)],{model:_0x34b868}=_0x4dc613,_0x8740eb={'userId':_0x581e8e,'type':balance_constant_1[_0x1fbd5f(0x15e)][_0x1fbd5f(0x1ba)]};_0x34b868&&(_0x8740eb[_0x1fbd5f(0x12a)]=_0x34b868);const _0x6894ff=await this[_0x1fbd5f(0x1cb)][_0x1fbd5f(0x1ae)]({'where':_0x8740eb,'order':{'id':_0x1fbd5f(0x131)}});return _0x6894ff[_0x1fbd5f(0x117)](_0x244f43=>{const _0x18c10c=_0x1fbd5f;if(_0x244f43[_0x18c10c(0x161)]===_0x18c10c(0x14d)){const _0x4e0593=_0x244f43[_0x18c10c(0x12a)]==='mj'?0x136:0xa0,_0x385e49=_0x244f43[_0x18c10c(0x1f3)][_0x18c10c(0x154)](_0x18c10c(0x1ad))?_0x18c10c(0x128):'ali',_0x3198f2=_0x385e49===_0x18c10c(0x128)?_0x18c10c(0x15f)+_0x4e0593+_0x18c10c(0x195):_0x18c10c(0x1aa)+_0x4e0593;_0x244f43[_0x18c10c(0x17d)]=_0x244f43[_0x18c10c(0x1f3)]+_0x3198f2;const _0x3820a2=_0x244f43[_0x18c10c(0x1e7)]?JSON[_0x18c10c(0x10e)](_0x244f43['extend']):null;_0x3820a2&&(_0x3820a2?_0x244f43['isGroup']=_0x3820a2?.[_0x18c10c(0x10f)][0x0]?.['components'][_0x18c10c(0x1f1)]===0x5:_0x244f43[_0x18c10c(0x16e)]=![]);}}),_0x6894ff;}async[_0x2f25f7(0x170)](_0x425ae6){const _0x520f04=_0x2f25f7,{page:page=0x1,size:size=0x14,rec:_0x2662cd,userId:_0x193da8,model:_0x97f70b}=_0x425ae6,_0x428755={'type':balance_constant_1[_0x520f04(0x15e)]['PAINT_TYPE'],'prompt':(0x0,typeorm_2[_0x520f04(0x1a8)])(''),'answer':(0x0,typeorm_2[_0x520f04(0x1a8)])('')};_0x2662cd&&Object['assign'](_0x428755,{'rec':_0x2662cd}),_0x193da8&&Object[_0x520f04(0x135)](_0x428755,{'userId':_0x193da8}),_0x97f70b&&Object['assign'](_0x428755,{'model':_0x97f70b});const [_0xf6a1c8,_0x5586e3]=await this[_0x520f04(0x1cb)]['findAndCount']({'order':{'id':_0x520f04(0x131)},'skip':(page-0x1)*size,'take':size,'where':_0x428755});return _0xf6a1c8[_0x520f04(0x117)](_0x5af621=>{const _0x319303=_0x520f04;if(_0x5af621[_0x319303(0x161)]===_0x319303(0x14d)){const _0x44c9c2=_0x5af621['model']==='mj'?0x136:0xa0,_0x309780=_0x5af621['answer'][_0x319303(0x154)](_0x319303(0x1ad))?_0x319303(0x128):_0x319303(0x1bf),_0x227fd4=_0x309780==='tencent'?'?imageView2/1/w/'+_0x44c9c2+_0x319303(0x195):_0x319303(0x1aa)+_0x44c9c2;_0x5af621[_0x319303(0x17d)]=_0x5af621['answer']+_0x227fd4;const _0x3ba9ce=_0x5af621[_0x319303(0x1e7)]?JSON[_0x319303(0x10e)](_0x5af621[_0x319303(0x1e7)]):null;_0x3ba9ce&&(_0x3ba9ce?_0x5af621[_0x319303(0x16e)]=_0x3ba9ce?.[_0x319303(0x10f)][0x0]?.[_0x319303(0x10f)][_0x319303(0x1f1)]===0x5:_0x5af621[_0x319303(0x16e)]=![]);}}),{'rows':_0xf6a1c8,'count':_0x5586e3};}async['recDrawImg'](_0x5773fd){const _0x4080a8=_0x2f25f7,{id:_0x221e6a}=_0x5773fd,_0x3b5762=await this['chatLogEntity'][_0x4080a8(0x11e)]({'where':{'id':_0x221e6a,'type':balance_constant_1[_0x4080a8(0x15e)][_0x4080a8(0x1ba)]}});if(!_0x3b5762)throw new common_1['HttpException'](_0x4080a8(0x1ca),common_1[_0x4080a8(0x11c)][_0x4080a8(0x19f)]);const _0x578d36=_0x3b5762[_0x4080a8(0x142)]===0x1?0x0:0x1,_0x41070d=await this[_0x4080a8(0x1cb)][_0x4080a8(0x168)]({'id':_0x221e6a},{'rec':_0x578d36});if(_0x41070d[_0x4080a8(0x1a1)]>0x0)return(_0x578d36?'Êé®Ëçê':_0x4080a8(0x153))+_0x4080a8(0x124);throw new common_1[(_0x4080a8(0x14c))](_0x4080a8(0x106),common_1['HttpStatus'][_0x4080a8(0x19f)]);}async[_0x2f25f7(0x1a3)](_0x4d89a2,_0x1a1b0f){const _0x3f01e3=_0x2f25f7,_0x393dde=(0x0,utils_1[_0x3f01e3(0x13b)])(this[_0x3f01e3(0x160)]),{page:page=0x1,size:size=0x14,userId:_0x286f1d,keyword:_0x3b3c92,prompt:_0x4b3012,saasId:_0x12983c,modelType:_0x523cae}=_0x4d89a2;let _0x4ae160=_0x3f01e3(0x15c);_0x286f1d&&(_0x4ae160=_0x4ae160+(_0x3f01e3(0x188)+_0x286f1d));_0x4b3012&&(_0x4ae160=_0x4ae160+(_0x3f01e3(0x1a4)+_0x4b3012+'%\x27'));_0x523cae&&(_0x4ae160=_0x4ae160+(_0x3f01e3(0x1db)+_0x523cae+'\x27'));(0x0,utils_1[_0x3f01e3(0x1a2)])(this['clsService'])?(0x0,class_validator_1[_0x3f01e3(0x1cf)])(_0x12983c)&&(_0x4ae160=_0x4ae160+(_0x3f01e3(0x1d9)+_0x12983c)):_0x4ae160=_0x4ae160+(_0x3f01e3(0x166)+_0x393dde);_0x3b3c92&&(_0x4ae160=_0x4ae160+(_0x3f01e3(0x1b4)+_0x3b3c92+_0x3f01e3(0x196)+_0x3b3c92+_0x3f01e3(0x1a5)+_0x3b3c92+_0x3f01e3(0x1e6)+_0x3b3c92+_0x3f01e3(0x18a)));const _0xe7af2e=await this['connection'][_0x3f01e3(0x116)](_0x3f01e3(0x1e0)+_0x4ae160+_0x3f01e3(0x113)),_0x44c621=await this[_0x3f01e3(0x18e)][_0x3f01e3(0x116)](_0x3f01e3(0x178)+_0x4ae160+_0x3f01e3(0x17c)+size+_0x3f01e3(0x1c9)+(page-0x1)*size+_0x3f01e3(0x143));return!(0x0,utils_1[_0x3f01e3(0x10b)])(this[_0x3f01e3(0x160)])&&_0x44c621[_0x3f01e3(0x117)](_0xc37751=>{const _0x54dfde=_0x3f01e3;_0xc37751[_0x54dfde(0x1cc)]=(0x0,utils_1[_0x54dfde(0x1e3)])(_0xc37751[_0x54dfde(0x1cc)]),_0xc37751['phone']=(0x0,utils_1[_0x54dfde(0x1e3)])(_0xc37751['phone']);}),{'rows':_0x44c621,'count':Number(_0xe7af2e[0x0]?.[_0x3f01e3(0x162)]||0x0)};}async[_0x2f25f7(0x1e9)](_0x5a3a86){const _0x137a87=_0x2f25f7;if(!_0x5a3a86[_0x137a87(0x167)]['length'])return!![];return await this[_0x137a87(0x1cb)]['update']({'id':(0x0,typeorm_2['In'])(_0x5a3a86[_0x137a87(0x167)])},{'isDelete':!![]}),!![];}async[_0x2f25f7(0x1d8)](_0x3b124f,_0x1451ff){const _0x52185d=_0x2f25f7,{id:_0x1eb0d8}=_0x3b124f[_0x52185d(0x129)],{groupId:_0x7c73ca,logType:_0x1ff0ac,modelSubType:_0x1c8905}=_0x1451ff,_0x1ba7c5={'userId':_0x1eb0d8,'isDelete':![]};_0x7c73ca&&Object['assign'](_0x1ba7c5,{'groupId':_0x7c73ca}),_0x1ff0ac&&Object['assign'](_0x1ba7c5,{'logType':_0x1ff0ac}),_0x1c8905&&Object[_0x52185d(0x135)](_0x1ba7c5,{'modelSubType':_0x1c8905});const _0x5331ab=await this['chatLogEntity'][_0x52185d(0x1ae)]({'where':_0x1ba7c5})[_0x52185d(0x12e)](_0x5f0348=>{const _0x4cc75b=_0x52185d;common_1[_0x4cc75b(0x177)][_0x4cc75b(0x14a)](_0x5f0348);});if(!_0x5331ab||_0x5331ab[_0x52185d(0x1f1)]===0x0)return[];return _0x5331ab[_0x52185d(0x172)](_0x38aa61=>{const _0x5a0b1f=_0x52185d,{prompt:_0x2c344a,role:_0x6386fc,answer:_0x2094a6,createdAt:_0x129741,model:_0xfcc02,conversationOptions:_0x51bf3a,requestOptions:_0x5d5add,id:_0x1e949d}=_0x38aa61;return{'chatId':_0x1e949d,'dateTime':(0x0,utils_1['formatDate'])(_0x129741),'text':_0x6386fc===_0x5a0b1f(0x129)?_0x2c344a:_0x2094a6,'inversion':_0x6386fc===_0x5a0b1f(0x129),'error':![],'conversationOptions':_0x51bf3a?JSON[_0x5a0b1f(0x10e)](_0x51bf3a):null,'requestOptions':_0x5d5add?JSON[_0x5a0b1f(0x10e)](_0x5d5add):null};});}async[_0x2f25f7(0x1c0)](_0x1954d3){const _0x51d15f=_0x2f25f7;return this[_0x51d15f(0x1cb)][_0x51d15f(0x1ae)]({'where':{'groupId':_0x1954d3,'isDelete':![]}});}async[_0x2f25f7(0x12c)](_0x4c97f6,_0x14cd39,_0x13034e){const _0x595a25=_0x2f25f7,_0xf53aa2=new Map();if(!_0x14cd39[_0x595a25(0x1f1)])return _0xf53aa2;const _0x1fa69b=await this[_0x595a25(0x1d7)][_0x595a25(0x1ae)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x14cd39),'deleteFlag':0x0}}),_0xfefbd2=_0x1fa69b[_0x595a25(0x172)](_0xeea2bc=>_0xeea2bc['id']),_0x3ac754=await this[_0x595a25(0x174)][_0x595a25(0x1f0)](_0x4c97f6,_0xfefbd2,_0x13034e),_0x224214=await this[_0x595a25(0x174)][_0x595a25(0x152)](_0xfefbd2,_0x13034e);return _0x1fa69b[_0x595a25(0x117)](_0x1d0bd4=>{const _0x515e45=_0x595a25;!_0xf53aa2[_0x515e45(0x11b)](_0x1d0bd4['chatLogId'])&&_0xf53aa2[_0x515e45(0x16d)](_0x1d0bd4[_0x515e45(0x182)],[]);const _0x11fd2e=_0x224214[_0x515e45(0x171)](_0x1d0bd4['id']);_0xf53aa2[_0x515e45(0x171)](_0x1d0bd4[_0x515e45(0x182)])[_0x515e45(0x185)]({..._0x1d0bd4,'agree':_0x3ac754['get'](_0x1d0bd4['id'])||null,'playNum':_0x11fd2e?.[_0x515e45(0x141)]||0x0,'visitNum':_0x11fd2e?.[_0x515e45(0x17f)]||0x0,'agreeNum':_0x11fd2e?.['agreeNum']||0x0});}),_0xf53aa2;}async[_0x2f25f7(0x155)](_0x263a65,_0x2fa438,_0x300a1c){const _0x4bcfe7=_0x2f25f7;if(!_0x2fa438['length'])return[];const _0x2ca67a=await this[_0x4bcfe7(0x1cb)][_0x4bcfe7(0x1ae)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x2fa438)}});if(!_0x2ca67a[_0x4bcfe7(0x1f1)])return[];const _0x1ce05d=await this[_0x4bcfe7(0x12c)](_0x263a65['user']['id'],_0x2fa438,_0x300a1c);return _0x2ca67a[_0x4bcfe7(0x172)](_0x245c6c=>{const _0x2b788d=_0x4bcfe7;return{..._0x245c6c,'children':_0x1ce05d[_0x2b788d(0x171)](_0x245c6c['id'])||[]};});}async['listAssetsBychatLogIds'](_0x4ab791){if(!_0x4ab791['length'])return[];return this['aiAssetsEntity']['find']({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x4ab791)}});}async[_0x2f25f7(0x1c1)](_0x3d60ad,_0xc381b2){const _0x46f8fd=_0x2f25f7;try{const _0x1856c3={'isDelete':![],'role':'assistant','userId':_0x3d60ad[_0x46f8fd(0x129)]['id'],'modelType':_0xc381b2[_0x46f8fd(0x1c5)]};_0xc381b2[_0x46f8fd(0x14e)]&&(_0x1856c3[_0x46f8fd(0x14e)]=_0xc381b2[_0x46f8fd(0x14e)]);const [_0x14b75c,_0x5b1be9]=await this[_0x46f8fd(0x1cb)][_0x46f8fd(0x157)]({'where':_0x1856c3,'take':_0xc381b2[_0x46f8fd(0x164)],'skip':(_0xc381b2[_0x46f8fd(0x119)]-0x1)*_0xc381b2[_0x46f8fd(0x164)],'order':{'createdAt':_0x46f8fd(0x131)}}),_0x4ccdc5=_0x14b75c[_0x46f8fd(0x172)](_0x3ac1af=>_0x3ac1af['id']),_0x2b5ac6=await this[_0x46f8fd(0x12c)](_0x3d60ad[_0x46f8fd(0x129)]['id'],_0x4ccdc5,_0xc381b2[_0x46f8fd(0x1c5)]),_0x3d22ad=_0x14b75c[_0x46f8fd(0x172)](_0x3f8cc7=>{const _0x49cf4e=_0x46f8fd;return{..._0x3f8cc7,'children':_0x2b5ac6[_0x49cf4e(0x171)](_0x3f8cc7['id'])||[]};});return{'count':_0x5b1be9,'records':_0x3d22ad};}catch(_0x292460){throw new common_1[(_0x46f8fd(0x14c))](_0x292460[_0x46f8fd(0x123)],common_1[_0x46f8fd(0x11c)][_0x46f8fd(0x19f)]);}}async[_0x2f25f7(0x12d)](_0x3d8fc1,_0x47742f){const _0x46840c=_0x2f25f7;if(!_0x47742f[_0x46840c(0x167)]['length'])return!![];return await this['aiAssetsEntity'][_0x46840c(0x168)]({'userId':_0x3d8fc1['user']['id'],'id':(0x0,typeorm_2['In'])(_0x47742f['ids'])},{'deleteFlag':0x1}),!![];}async['assetsPublish'](_0x5ded2a,_0x23eef3){const _0x192233=_0x2f25f7;if(!_0x23eef3[_0x192233(0x167)])return!![];return await this[_0x192233(0x18e)][_0x192233(0x116)](_0x192233(0x10c)+_0x5ded2a[_0x192233(0x129)]['id']+_0x192233(0x1be)+_0x23eef3[_0x192233(0x167)][_0x192233(0x13c)]()+_0x192233(0x10d)),!![];}async[_0x2f25f7(0x1d4)](_0x5491c1,_0x5f07e0){const _0x441c15=_0x2f25f7,_0x53255c=(0x0,utils_1[_0x441c15(0x1d3)])(this['clsService']);try{const {page:page=0x1,size:size=0x14,order:_0x488931,keyword:_0x4620a7,modelType:_0x3ff536,modelSubType:_0x523c58}=_0x5f07e0;let _0x3db119=_0x441c15(0x17a);if(_0x488931===_0x441c15(0x141))_0x3db119=_0x441c15(0x19c);else _0x488931===_0x441c15(0x13a)&&(_0x3db119=_0x441c15(0x1ce));const _0x157704=await this[_0x441c15(0x18e)][_0x441c15(0x116)](_0x441c15(0x10a)+_0x3ff536+_0x441c15(0x180)+(_0x523c58?_0x441c15(0x112)+_0x523c58+'\x27':'')+_0x441c15(0x17e)+(_0x4620a7?'AND\x20aa.title\x20LIKE\x20(\x27%'+_0x4620a7+_0x441c15(0x18a):'')+_0x441c15(0x165)),_0x27ea9e=await this[_0x441c15(0x18e)]['query']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27'+_0x3ff536+_0x441c15(0x180)+(_0x523c58?_0x441c15(0x112)+_0x523c58+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27'+_0x3ff536+_0x441c15(0x1d1)+(_0x4620a7?'AND\x20aa.title\x20LIKE\x20(\x27%'+_0x4620a7+_0x441c15(0x18a):'')+_0x441c15(0x145)+_0x3db119+_0x441c15(0x16f)+size+_0x441c15(0x1c9)+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20'),_0x2957c7=_0x27ea9e[_0x441c15(0x172)](_0x1fc338=>_0x1fc338['id']),_0x2484d0=await this[_0x441c15(0x174)][_0x441c15(0x1f0)](_0x53255c,_0x2957c7,_0x3ff536);return _0x27ea9e[_0x441c15(0x117)](_0x3df0a9=>{const _0x7b0de4=_0x441c15;_0x3df0a9[_0x7b0de4(0x189)]=_0x2484d0[_0x7b0de4(0x171)](_0x3df0a9['id'])||null;}),{'records':_0x27ea9e,'count':Number(_0x157704[0x0]?.[_0x441c15(0x162)]||0x0)};}catch(_0x23d574){throw new common_1[(_0x441c15(0x14c))](_0x23d574[_0x441c15(0x123)],common_1[_0x441c15(0x11c)][_0x441c15(0x19f)]);}}async[_0x2f25f7(0x1d2)](_0x28e57d,_0x1fbc48){const _0x2b6864=_0x2f25f7,{id:_0x38916c}=_0x28e57d[_0x2b6864(0x129)],{groupId:_0x4c482a}=_0x1fbc48,_0x21bc7b={'userId':_0x38916c,'isDelete':![]};_0x4c482a&&Object[_0x2b6864(0x135)](_0x21bc7b,{'groupId':_0x4c482a});const _0x1ae648=await this[_0x2b6864(0x1cb)][_0x2b6864(0x1ae)]({'where':_0x21bc7b});return _0x1ae648[_0x2b6864(0x172)](_0x879124=>{const _0x4d76de=_0x2b6864,{prompt:_0x22ce86,role:_0x5347d2,answer:_0x415b98,createdAt:_0x226ea2,model:_0x542b71,conversationOptions:_0x549c17,requestOptions:_0x55fc9d,id:_0x43feaf}=_0x879124;return{'chatId':_0x43feaf,'dateTime':(0x0,utils_1[_0x4d76de(0x19e)])(_0x226ea2),'text':_0x5347d2===_0x4d76de(0x129)?_0x22ce86:_0x415b98,'inversion':_0x5347d2==='user','error':![],'conversationOptions':_0x549c17?JSON[_0x4d76de(0x10e)](_0x549c17):null,'requestOptions':_0x55fc9d?JSON[_0x4d76de(0x10e)](_0x55fc9d):null};});}async[_0x2f25f7(0x105)](_0x3ca32c,_0x16a3de){const _0x115cbc=_0x2f25f7,{id:_0x5be68b}=_0x3ca32c[_0x115cbc(0x129)],{id:_0x9db44b}=_0x16a3de,_0x2382e7=await this[_0x115cbc(0x1cb)][_0x115cbc(0x11e)]({'where':{'id':_0x9db44b,'userId':_0x5be68b}});if(!_0x2382e7)throw new common_1[(_0x115cbc(0x14c))]('‰Ω†Âà†Èô§ÁöÑÂØπËØùËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ',common_1['HttpStatus']['BAD_REQUEST']);const _0x102c28=await this[_0x115cbc(0x1cb)]['update']({'id':_0x9db44b},{'isDelete':!![]});await this[_0x115cbc(0x1d7)][_0x115cbc(0x168)]({'userId':_0x3ca32c[_0x115cbc(0x129)]['id'],'chatLogId':_0x9db44b},{'deleteFlag':0x1});if(_0x102c28[_0x115cbc(0x1a1)]>0x0)return _0x115cbc(0x173);else throw new common_1[(_0x115cbc(0x14c))](_0x115cbc(0x1ab),common_1[_0x115cbc(0x11c)][_0x115cbc(0x19f)]);}async[_0x2f25f7(0x1e8)](_0x510a2f,_0x252414){const _0x42e77e=_0x2f25f7,{groupId:_0x4a6519,type:_0x5af5df}=_0x252414,{id:_0x178e73}=_0x510a2f[_0x42e77e(0x129)],_0x9c36ce=_0x5af5df&&_0x5af5df===_0x42e77e(0x134)?{'groupId':_0x4a6519,'userId':_0x178e73}:{'groupId':_0x4a6519,'userId':_0x178e73},_0x13920a=await this[_0x42e77e(0x1cb)][_0x42e77e(0x1b7)](_0x9c36ce);if(_0x13920a['affected']>0x0)return!![];if(_0x13920a[_0x42e77e(0x1a1)]===0x0)throw new common_1[(_0x42e77e(0x14c))](_0x42e77e(0x179),common_1[_0x42e77e(0x11c)][_0x42e77e(0x19f)]);}async[_0x2f25f7(0x1dc)](_0x2821ba){const _0x471832=_0x2f25f7,{ids:_0x320bad,userId:_0x2306e5}=_0x2821ba;return await this[_0x471832(0x1cb)]['delete']({'groupId':(0x0,typeorm_2['In'])(_0x320bad),'userId':_0x2306e5});}async['byAppId'](_0x2301b9,_0x305e4f){const _0x180d18=_0x2f25f7,{id:_0x33b87d}=_0x2301b9[_0x180d18(0x129)],{appId:_0x5c3b1d,page:page=0x1,size:size=0xa}=_0x305e4f,[_0x235087,_0x24731e]=await this[_0x180d18(0x1cb)][_0x180d18(0x157)]({'where':{'userId':_0x33b87d,'appId':_0x5c3b1d,'role':_0x180d18(0x133)},'order':{'id':_0x180d18(0x131)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x235087,'count':_0x24731e};}async['byChatlogId'](_0x2a09e5,_0x373da0){const _0x2e5511=_0x2f25f7,_0x15fa49=_0x2a09e5[_0x2e5511(0x129)]['id'],_0x4b4bd2=await this[_0x2e5511(0x1cb)]['findOne']({'where':{'userId':_0x15fa49,'id':_0x373da0}});if(!_0x4b4bd2)return'';return _0x4b4bd2[_0x2e5511(0x1f3)];}async[_0x2f25f7(0x158)](){const _0xf58755=_0x2f25f7,_0x5d6548=await this[_0xf58755(0x18e)][_0xf58755(0x116)](_0xf58755(0x137));return _0x5d6548;}async[_0x2f25f7(0x120)](_0x4764b2){const _0x2a75d7=_0x2f25f7,_0x15e932=await this[_0x2a75d7(0x1e2)]['getModelById'](_0x4764b2[_0x2a75d7(0x108)]);_0x15e932&&this[_0x2a75d7(0x107)][_0x2a75d7(0x115)](_0x4764b2[_0x2a75d7(0x1f5)],_0x15e932,_0x4764b2['id']);}async[_0x2f25f7(0x163)](_0x186ccc){const _0xa39213=_0x2f25f7,_0x5ae66f=await this[_0xa39213(0x1d7)]['findOne']({'where':{'sunoMusicId':_0x186ccc['id']}});if(!_0x5ae66f)return;const _0x4e3802=await this[_0xa39213(0x1cb)][_0xa39213(0x11e)]({'where':{'id':_0x5ae66f[_0xa39213(0x182)]}});_0x4e3802[_0xa39213(0x1f3)]=_0x186ccc['state'],_0x5ae66f[_0xa39213(0x151)]=_0x186ccc[_0xa39213(0x1e4)]?.[_0xa39213(0x18b)],await this[_0xa39213(0x1cb)][_0xa39213(0x14f)](_0x4e3802),await this['aiAssetsEntity'][_0xa39213(0x14f)](_0x5ae66f);if(_0x4e3802[_0xa39213(0x1f3)]==='completed'&&_0x5ae66f['mp4'])this[_0xa39213(0x1bc)](_0x5ae66f);else _0x4e3802[_0xa39213(0x1f3)]==='FAILED'&&this[_0xa39213(0x120)](_0x4e3802);}async[_0x2f25f7(0x1a7)](_0x364cbf){const _0x4463eb=_0x2f25f7;console[_0x4463eb(0x1af)](_0x4463eb(0x1ec),_0x364cbf);const _0x33388=await this[_0x4463eb(0x1d7)]['findOne']({'where':{'sunoMusicId':_0x364cbf[_0x4463eb(0x198)]}});if(!_0x33388)throw new Error(_0x4463eb(0x139));const _0x21c389=await this['chatLogEntity'][_0x4463eb(0x11e)]({'where':{'id':_0x33388[_0x4463eb(0x182)]}});_0x21c389[_0x4463eb(0x1f3)]=_0x364cbf[_0x4463eb(0x190)],_0x33388['mp4']=_0x364cbf[_0x4463eb(0x14b)],await this['chatLogEntity'][_0x4463eb(0x14f)](_0x21c389),await this[_0x4463eb(0x1d7)][_0x4463eb(0x14f)](_0x33388);if(_0x364cbf[_0x4463eb(0x13d)]==='3'&&_0x33388[_0x4463eb(0x151)])this[_0x4463eb(0x1bc)](_0x33388);else _0x21c389[_0x4463eb(0x1f3)]===_0x4463eb(0x136)&&this[_0x4463eb(0x120)](_0x21c389);}async[_0x2f25f7(0x1bb)](_0x4b265a){const _0x23389c=_0x2f25f7;console[_0x23389c(0x1af)]('klingÈÄöÁü•Ôºö',_0x4b265a);const _0x216e07=await this[_0x23389c(0x1d7)][_0x23389c(0x11e)]({'where':{'sunoMusicId':_0x4b265a['task_id']}});if(!_0x216e07)throw new Error(_0x23389c(0x139));const _0x44ac20=await this[_0x23389c(0x1cb)]['findOne']({'where':{'id':_0x216e07[_0x23389c(0x182)]}});_0x44ac20[_0x23389c(0x1f3)]=_0x4b265a['task_status'],_0x216e07[_0x23389c(0x151)]=_0x4b265a[_0x23389c(0x13e)]['videos'][0x0]?.['url'],await this['chatLogEntity'][_0x23389c(0x14f)](_0x44ac20),await this[_0x23389c(0x1d7)]['save'](_0x216e07);if(_0x44ac20[_0x23389c(0x1f3)]===_0x23389c(0x1ac)&&_0x216e07[_0x23389c(0x151)])this[_0x23389c(0x1bc)](_0x216e07);else _0x44ac20[_0x23389c(0x1f3)]==='failed'&&this['refundVideo'](_0x44ac20);}async[_0x2f25f7(0x149)](_0x3c3538,_0x355e47){const _0x36e6f5=_0x2f25f7;console[_0x36e6f5(0x1af)](_0x36e6f5(0x140),_0x3c3538);let _0x457a4d;_0x355e47===_0x36e6f5(0x18d)?(_0x457a4d=await this[_0x36e6f5(0x1cb)][_0x36e6f5(0x11e)]({'where':{'id':Number(_0x3c3538['task_id'])}}),_0x457a4d[_0x36e6f5(0x1f3)]=_0x3c3538[_0x36e6f5(0x16a)]||_0x3c3538['data'][_0x36e6f5(0x16a)]):(_0x457a4d=await this[_0x36e6f5(0x1cb)][_0x36e6f5(0x11e)]({'where':{'message_id':_0x3c3538[_0x36e6f5(0x198)]}}),_0x457a4d[_0x36e6f5(0x1f3)]=_0x3c3538[_0x36e6f5(0x13d)]);await this['chatLogEntity'][_0x36e6f5(0x14f)](_0x457a4d);if(_0x355e47===_0x36e6f5(0x127)){const _0x2e979e=await this[_0x36e6f5(0x1d7)][_0x36e6f5(0x1ae)]({'where':{'chatLogId':_0x457a4d['id']}});for(const _0xe17d27 of _0x3c3538[_0x36e6f5(0x132)]){const {title:_0xf68380,prompt:_0x2337f0,audio_url:_0x2d7218,image_url:_0x5c5f50,task_id:_0x4e590b,id:_0x19f102,video_url:_0x33c04e}=_0xe17d27,_0xb2bfc9=_0x4e590b?_0x2e979e[_0x36e6f5(0x1ae)](_0x3ea29d=>_0x3ea29d[_0x36e6f5(0x150)]===_0x4e590b):_0x2e979e[_0x36e6f5(0x1ae)](_0x5d2cd7=>_0x5d2cd7[_0x36e6f5(0x150)]===_0x19f102);!_0xb2bfc9?await this[_0x36e6f5(0x1d7)][_0x36e6f5(0x14f)]({'title':_0xf68380,'intro':_0x2337f0||_0xe17d27[_0x36e6f5(0x111)]['prompt'],'mp3':_0x2d7218||'','mp4':_0x33c04e||'','cover':_0x5c5f50||'','sunoMusicId':_0x4e590b||_0x19f102,'chatLogId':_0x457a4d['id'],'userId':_0x457a4d[_0x36e6f5(0x1f5)]}):(_0xb2bfc9[_0x36e6f5(0x186)]=_0xf68380,_0xb2bfc9[_0x36e6f5(0x1ed)]=_0x2337f0||_0xe17d27['metadata'][_0x36e6f5(0x110)],_0xb2bfc9['mp3']=_0x2d7218||'',_0xb2bfc9[_0x36e6f5(0x151)]=_0x33c04e||'',_0xb2bfc9['cover']=_0x5c5f50||'',await this[_0x36e6f5(0x1d7)][_0x36e6f5(0x14f)](_0xb2bfc9));}}}async[_0x2f25f7(0x1bc)](_0x551e4c){const _0x2a99df=_0x2f25f7,[_0xcf072c,_0x4b94dd]=await this[_0x2a99df(0x1b8)][_0x2a99df(0x146)](_0x551e4c[_0x2a99df(0x151)]);_0x551e4c[_0x2a99df(0x151)]=_0xcf072c,_0x551e4c['cover']=_0x4b94dd,await this['aiAssetsEntity']['save'](_0x551e4c);}async[_0x2f25f7(0x12f)](){const _0x52bdf0=_0x2f25f7,_0x11e9dd=await this[_0x52bdf0(0x1d7)][_0x52bdf0(0x1ae)]({'where':[{'cover':(0x0,typeorm_2[_0x52bdf0(0x12b)])(_0x52bdf0(0x109))},{'mp3':(0x0,typeorm_2[_0x52bdf0(0x12b)])(_0x52bdf0(0x109))},{'mp4':(0x0,typeorm_2['Like'])(_0x52bdf0(0x109))},{'mp4':(0x0,typeorm_2[_0x52bdf0(0x12b)])('%storage.cdn-luma.com%')}]});for(let _0xe748a0=0x0;_0xe748a0<_0x11e9dd[_0x52bdf0(0x1f1)];_0xe748a0++){const _0x516e3d=_0x11e9dd[_0xe748a0],_0x4ef1bc=redisKey_constant_1['MUSIC_TRANSFER']+_0x516e3d['id'];try{const _0x18f4df=await this['redisCacheService'][_0x52bdf0(0x171)]({'key':_0x4ef1bc});if(_0x18f4df)continue;await this[_0x52bdf0(0x148)]['set']({'key':_0x4ef1bc,'val':_0x52bdf0(0x15d)});const {cover:_0x5aa74c,mp3:_0x5b5115,mp4:_0x215285}=_0x516e3d;/filesystem.site/[_0x52bdf0(0x1f2)](_0x5aa74c)&&(_0x516e3d['cover']=await this[_0x52bdf0(0x1b8)]['transferFile'](_0x5aa74c));/filesystem.site/[_0x52bdf0(0x1f2)](_0x5b5115)&&(_0x516e3d[_0x52bdf0(0x125)]=await this[_0x52bdf0(0x1b8)][_0x52bdf0(0x199)](_0x5b5115));if(/filesystem.site|storage.cdn-luma.com/['test'](_0x215285)){if(_0x5aa74c)_0x516e3d[_0x52bdf0(0x151)]=await this[_0x52bdf0(0x1b8)]['transferFile'](_0x215285);else{const [_0x4939ef,_0x5c72c0]=await this[_0x52bdf0(0x1b8)]['transferAndCover'](_0x215285);_0x516e3d['mp4']=_0x4939ef,_0x516e3d[_0x52bdf0(0x192)]=_0x5c72c0;}}await this[_0x52bdf0(0x1d7)]['save'](_0x516e3d);}catch(_0x1d3576){common_1[_0x52bdf0(0x177)][_0x52bdf0(0x14a)](_0x1d3576);}finally{await this['redisCacheService'][_0x52bdf0(0x15a)]({'key':_0x4ef1bc});}}}async[_0x2f25f7(0x1da)](_0x18ad4d,_0x417074){const _0x5d9c2a=_0x2f25f7,_0x33804b=await this['chatLogEntity'][_0x5d9c2a(0x116)](_0x5d9c2a(0x1de)+_0x18ad4d+_0x5d9c2a(0x1ee)+_0x417074['join']()+_0x5d9c2a(0x13f));return _0x33804b;}async[_0x2f25f7(0x1c7)](){const _0x200fd1=_0x2f25f7,_0x2dfea8=await this[_0x200fd1(0x1e2)][_0x200fd1(0x197)](model_constant_1[_0x200fd1(0x19d)][_0x200fd1(0x1c4)]);try{const _0x3d78f1=store_1[_0x200fd1(0x1e5)][_0x200fd1(0x1b5)]||0x5,_0x5a239d=await this['chatLogEntity'][_0x200fd1(0x1ae)]({'where':{'role':'assistant','modelType':model_constant_1[_0x200fd1(0x19d)][_0x200fd1(0x1c4)],'answer':(0x0,typeorm_2['In'])([_0x200fd1(0x181),'']),'updatedAt':(0x0,typeorm_2[_0x200fd1(0x169)])(new Date(Date['now']()-_0x3d78f1*0x3c*0x3e8))}});_0x5a239d[_0x200fd1(0x117)](async _0x58fd14=>{const _0x7e8c64=_0x200fd1;_0x58fd14[_0x7e8c64(0x1f3)]='timeout',_0x58fd14[_0x7e8c64(0x1d5)]=_0x7e8c64(0x1eb),this[_0x7e8c64(0x1cb)]['save'](_0x58fd14),await this['aiAssetsEntity'][_0x7e8c64(0x168)]({'chatLogId':_0x58fd14['id']},{'deleteFlag':0x1}),this[_0x7e8c64(0x107)]['debuctBalance4Muisc'](_0x58fd14[_0x7e8c64(0x1f5)],_0x58fd14['id'],_0x58fd14['modelSubType'],!![]);});}catch(_0x44a87b){common_1[_0x200fd1(0x177)][_0x200fd1(0x14a)](_0x44a87b);}}};ChatLogService=__decorate([(0x0,common_1[_0x2f25f7(0x1f4)])(),__param(0x0,(0x0,typeorm_1[_0x2f25f7(0x193)])(chatLog_entity_1[_0x2f25f7(0x1bd)])),__param(0x1,(0x0,typeorm_1[_0x2f25f7(0x193)])(aiAssets_entity_1['AiAssetsEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2f25f7(0x1d0)],typeorm_2[_0x2f25f7(0x1d0)],nestjs_cls_1['ClsService'],file_service_1['FileService'],aiLog_service_1[_0x2f25f7(0x1df)],redisCache_service_1['RedisCacheService'],user_service_1[_0x2f25f7(0x156)],models_service_1[_0x2f25f7(0x19b)],typeorm_2[_0x2f25f7(0x121)]])],ChatLogService),exports['ChatLogService']=ChatLogService;