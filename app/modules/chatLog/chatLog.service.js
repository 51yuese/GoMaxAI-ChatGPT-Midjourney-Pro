'use strict';const _0x2e7b7f=_0x45c1;(function(_0x5e1d8d,_0x2310ee){const _0x398162=_0x45c1,_0x3ac8dd=_0x5e1d8d();while(!![]){try{const _0x303637=-parseInt(_0x398162(0x1fa))/0x1*(parseInt(_0x398162(0x2c3))/0x2)+parseInt(_0x398162(0x276))/0x3+-parseInt(_0x398162(0x2b1))/0x4*(-parseInt(_0x398162(0x1e1))/0x5)+-parseInt(_0x398162(0x1be))/0x6+-parseInt(_0x398162(0x2cc))/0x7*(parseInt(_0x398162(0x24b))/0x8)+-parseInt(_0x398162(0x294))/0x9*(-parseInt(_0x398162(0x296))/0xa)+parseInt(_0x398162(0x269))/0xb;if(_0x303637===_0x2310ee)break;else _0x3ac8dd['push'](_0x3ac8dd['shift']());}catch(_0x4931f9){_0x3ac8dd['push'](_0x3ac8dd['shift']());}}}(_0x2077,0x269fb));var __decorate=this&&this[_0x2e7b7f(0x211)]||function(_0x45ec6a,_0x19238e,_0x31deb4,_0x4b6d05){const _0x7b6560=_0x2e7b7f;var _0x46128b=arguments[_0x7b6560(0x200)],_0x453632=_0x46128b<0x3?_0x19238e:_0x4b6d05===null?_0x4b6d05=Object[_0x7b6560(0x1d8)](_0x19238e,_0x31deb4):_0x4b6d05,_0xc6b60b;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x7b6560(0x29d))_0x453632=Reflect[_0x7b6560(0x2c5)](_0x45ec6a,_0x19238e,_0x31deb4,_0x4b6d05);else{for(var _0x2c172f=_0x45ec6a[_0x7b6560(0x200)]-0x1;_0x2c172f>=0x0;_0x2c172f--)if(_0xc6b60b=_0x45ec6a[_0x2c172f])_0x453632=(_0x46128b<0x3?_0xc6b60b(_0x453632):_0x46128b>0x3?_0xc6b60b(_0x19238e,_0x31deb4,_0x453632):_0xc6b60b(_0x19238e,_0x31deb4))||_0x453632;}return _0x46128b>0x3&&_0x453632&&Object[_0x7b6560(0x234)](_0x19238e,_0x31deb4,_0x453632),_0x453632;},__metadata=this&&this[_0x2e7b7f(0x252)]||function(_0x2a1224,_0x55ce2f){const _0x6bc53b=_0x2e7b7f;if(typeof Reflect===_0x6bc53b(0x1d4)&&typeof Reflect[_0x6bc53b(0x2ca)]===_0x6bc53b(0x29d))return Reflect['metadata'](_0x2a1224,_0x55ce2f);},__param=this&&this[_0x2e7b7f(0x1c7)]||function(_0x51ff20,_0x19aefc){return function(_0x227ef9,_0x312b83){_0x19aefc(_0x227ef9,_0x312b83,_0x51ff20);};};Object[_0x2e7b7f(0x234)](exports,_0x2e7b7f(0x2da),{'value':!![]}),exports[_0x2e7b7f(0x207)]=void 0x0;function _0x45c1(_0x156cc9,_0x18d683){const _0x207785=_0x2077();return _0x45c1=function(_0x45c176,_0x5f3e9c){_0x45c176=_0x45c176-0x1ac;let _0x1beeee=_0x207785[_0x45c176];return _0x1beeee;},_0x45c1(_0x156cc9,_0x18d683);}const common_1=require(_0x2e7b7f(0x240)),typeorm_1=require(_0x2e7b7f(0x280)),chatLog_entity_1=require(_0x2e7b7f(0x217)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x2e7b7f(0x1cb)),utils_1=require('../../common/utils'),file_service_1=require('../file/file.service'),redisCache_service_1=require(_0x2e7b7f(0x2c8)),redisKey_constant_1=require(_0x2e7b7f(0x208)),model_constant_1=require(_0x2e7b7f(0x245)),aiAssets_entity_1=require(_0x2e7b7f(0x227)),aiLog_service_1=require(_0x2e7b7f(0x2d6)),nestjs_cls_1=require(_0x2e7b7f(0x1c9)),class_validator_1=require('class-validator'),user_service_1=require(_0x2e7b7f(0x232)),models_service_1=require(_0x2e7b7f(0x20e)),store_1=require(_0x2e7b7f(0x2a9)),collectType_constant_1=require('../../common/constants/collectType.constant'),openapi_1=require('@volcengine/openapi'),veoTask_service_1=require(_0x2e7b7f(0x1ff));let ChatLogService=class ChatLogService{constructor(_0x345746,_0x3b4437,_0x1c4d97,_0x2dcc2c,_0x25629a,_0x21b229,_0x35d7bf,_0x2ef796,_0x586879,_0x2a2858){const _0x1ccc13=_0x2e7b7f;this[_0x1ccc13(0x223)]=_0x345746,this[_0x1ccc13(0x1c8)]=_0x3b4437,this[_0x1ccc13(0x1d2)]=_0x1c4d97,this[_0x1ccc13(0x254)]=_0x2dcc2c,this[_0x1ccc13(0x2c7)]=_0x25629a,this[_0x1ccc13(0x1d0)]=_0x21b229,this[_0x1ccc13(0x270)]=_0x35d7bf,this[_0x1ccc13(0x230)]=_0x2ef796,this['veoTaskService']=_0x586879,this[_0x1ccc13(0x28d)]=_0x2a2858;}async[_0x2e7b7f(0x2c4)](_0x550b1b){const _0x1c2cff=_0x2e7b7f;return await this[_0x1c2cff(0x223)][_0x1c2cff(0x268)](_0x550b1b);}async['parseAndSaveMusic'](_0x5b477c){const _0x5babfb=_0x2e7b7f,_0x24b915=_0x5b477c[_0x5babfb(0x27e)];let _0x1439db={},_0xdd8dd9={};if(_0x24b915[_0x5babfb(0x2d5)](_0x5babfb(0x281))!=-0x1)throw new Error(_0x5babfb(0x1c5)+_0x24b915);else{let _0x473932='',_0x36d195='',_0xf6b67e='解析错误',_0x537b16='解析错误',_0x29f351=_0x5babfb(0x219),_0x38c4dc=_0x5babfb(0x219),_0x5914d2=_0x5babfb(0x219),_0x24f66c=_0x5babfb(0x219),_0x1f7bfd=_0x5babfb(0x219),_0x3e5550=_0x5babfb(0x219);if(_0x24b915[_0x5babfb(0x20b)](_0x5babfb(0x22a))){const [_0x3b749c]=_0x24b915[_0x5babfb(0x292)](/>(\S+)\n/g);_0x473932=_0x36d195=_0x3b749c[_0x5babfb(0x1ef)](0x1,_0x3b749c[_0x5babfb(0x200)]-0x1),_0xf6b67e=_0x24b915['split']('\x0a')[0x0][_0x5babfb(0x1ef)](0x7),_0x537b16=_0x24b915[_0x5babfb(0x2bc)](_0x5babfb(0x2b2))[0x1]['replace'](/\[.*\]|（.*）/g,'')['replace'](/\n+/g,'\x0a');const _0x17cbab=_0x24b915['match'](/!\[image\].*\)/g);_0x17cbab&&([_0x29f351,_0x38c4dc]=_0x17cbab['map'](_0x292c35=>_0x292c35[_0x5babfb(0x1ef)](0x9,_0x292c35[_0x5babfb(0x200)]-0x1)));const _0x177376=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp3/g);_0x177376&&([_0x5914d2,_0x24f66c]=_0x177376);const _0x2a2322=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp4/g);_0x2a2322&&([_0x1f7bfd,_0x3e5550]=_0x2a2322);}else{if(_0x24b915[_0x5babfb(0x20b)]('🎵')){_0xf6b67e=_0x24b915[_0x5babfb(0x2bc)]('\x0a')[0x0][_0x5babfb(0x27a)](/🎵/g,'');const _0x515d12=_0x24b915[_0x5babfb(0x2bc)]('--')[_0x5babfb(0x1eb)](_0x46c39e=>/-\n\n\[/[_0x5babfb(0x289)](_0x46c39e));if(_0x515d12){const _0x3cd7d3=_0x515d12['replace'](/\[.*\]|（.*）|-/g,'')[_0x5babfb(0x27a)](/\n+/g,'\x0a');_0x3cd7d3[_0x5babfb(0x20b)]('\x0a')?_0x537b16=_0x3cd7d3[_0x5babfb(0x27a)]('\x0a',''):_0x537b16=_0x3cd7d3;}const _0x4a8ea3=_0x24b915[_0x5babfb(0x292)](/歌曲id(.+)\n/ig);_0x4a8ea3&&([_0x473932,_0x36d195]=_0x4a8ea3[_0x5babfb(0x215)](_0x3b5436=>_0x3b5436[_0x5babfb(0x1ef)](0xc,_0x3b5436['length']-0x1)));const _0x9e1241=_0x24b915[_0x5babfb(0x292)](/\[封面图片\].*\)/g);_0x9e1241&&([_0x29f351,_0x38c4dc]=_0x9e1241[_0x5babfb(0x215)](_0x476fbb=>_0x476fbb['substring'](0x7,_0x476fbb[_0x5babfb(0x200)]-0x1)));const _0x72adeb=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp3/g);_0x72adeb&&([_0x5914d2,_0x24f66c]=_0x72adeb);const _0x29d87a=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp4/g);_0x29d87a&&([_0x1f7bfd,_0x3e5550]=_0x29d87a);}else{if(_0x24b915['indexOf']('💄')!=-0x1){let _0x47887b=_0x24b915[_0x5babfb(0x2bc)]('\x0a');_0x47887b[_0x5babfb(0x273)](_0x20678a=>{const _0x58e64d=_0x5babfb;_0x20678a[_0x58e64d(0x2d5)]('🔎')!=-0x1&&(_0xf6b67e=_0x20678a[_0x58e64d(0x2bc)]('：')[0x1]);});const _0x1d9686=_0x24b915[_0x5babfb(0x2bc)](_0x5babfb(0x2ba))[0x1][_0x5babfb(0x2bc)]('\x0a');if(_0x1d9686){const _0x2971eb=_0x1d9686[_0x5babfb(0x1e9)](_0x377b72=>_0x377b72['indexOf']('[')==-0x1)[_0x5babfb(0x29c)]('');_0x2971eb[_0x5babfb(0x20b)]('\x0a')?_0x537b16=_0x2971eb[_0x5babfb(0x27a)]('\x0a',''):_0x537b16=_0x2971eb;}const _0x3091c3=_0x24b915[_0x5babfb(0x292)](/歌曲id(.+)\n/ig);_0x3091c3&&([_0x473932,_0x36d195]=_0x3091c3[_0x5babfb(0x215)](_0x3f552a=>_0x3f552a[_0x5babfb(0x1ef)](0xa,_0x3f552a[_0x5babfb(0x200)]-0x1)));const _0x5ab191=_0x24b915[_0x5babfb(0x292)](/\[封面图片\].*\)/g);_0x5ab191&&([_0x29f351,_0x38c4dc]=_0x5ab191[_0x5babfb(0x215)](_0xb0b6dd=>_0xb0b6dd[_0x5babfb(0x1ef)](0x7,_0xb0b6dd['length']-0x1)));const _0x203c2f=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp3/g);_0x203c2f&&([_0x5914d2,_0x24f66c]=_0x203c2f);const _0x52877e=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp4/g);_0x52877e&&([_0x1f7bfd,_0x3e5550]=_0x52877e);}else{if(_0x24b915['startsWith']('🎁')){_0xf6b67e=_0x24b915[_0x5babfb(0x2bc)]('\x0a')[0x2][_0x5babfb(0x2bc)]('：**')[0x1];const _0x515e9f=_0x24b915['split'](_0x5babfb(0x2ba))[0x1]['split']('\x0a');if(_0x515e9f){const _0x340f0d=_0x515e9f[_0x5babfb(0x1e9)](_0x14e387=>_0x14e387[_0x5babfb(0x2d5)]('[')==-0x1)['join']('');_0x340f0d[_0x5babfb(0x20b)]('\x0a')?_0x537b16=_0x340f0d[_0x5babfb(0x27a)]('\x0a',''):_0x537b16=_0x340f0d;}const _0x49d3bf=_0x24b915['match'](/歌曲ID：(.+)\n/ig);_0x49d3bf&&([_0x473932,_0x36d195]=_0x49d3bf[_0x5babfb(0x215)](_0x8d8818=>_0x8d8818['substring'](0x8,_0x8d8818[_0x5babfb(0x200)]-0x1)));const _0x500f11=_0x24b915[_0x5babfb(0x292)](/\[封面\].*\)/g);_0x500f11&&([_0x29f351,_0x38c4dc]=_0x500f11[_0x5babfb(0x215)](_0x4dd6d6=>_0x4dd6d6['substring'](0x5,_0x4dd6d6[_0x5babfb(0x200)]-0x1)));const _0x287120=_0x24b915['match'](/https:\/\/(.*)\.mp3/g);_0x287120&&([_0x5914d2,_0x24f66c]=_0x287120);const _0xcbeae1=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp4/g);_0xcbeae1&&([_0x1f7bfd,_0x3e5550]=_0xcbeae1);}else{if(_0x24b915[_0x5babfb(0x2d5)](_0x5babfb(0x29f))!==-0x1){let _0x2296d2=_0x24b915['split']('\x0a'),_0x5e4998=![];const _0x210da2=[];for(let _0x3ab6a1=0x0;_0x3ab6a1<_0x2296d2[_0x5babfb(0x200)];_0x3ab6a1++){const _0x20d238=_0x2296d2[_0x3ab6a1];_0x20d238[_0x5babfb(0x2d5)](_0x5babfb(0x29f))!==-0x1&&(_0xf6b67e=_0x20d238[_0x5babfb(0x2bc)]('：\x20')[0x1]);if(_0x20d238[_0x5babfb(0x250)](_0x5babfb(0x2de)))_0x5e4998=![];else{if(_0x5e4998&&!_0x20d238[_0x5babfb(0x20b)]('['))_0x210da2[_0x5babfb(0x1c6)](_0x20d238);else _0x20d238['includes'](_0x5babfb(0x213))&&(_0x5e4998=!![]);}}_0x537b16=_0x210da2[_0x5babfb(0x29c)]('\x20');const _0x3f2251=_0x24b915['match'](/版本ID：(.+)\n/ig);_0x3f2251&&([_0x473932,_0x36d195]=_0x3f2251[_0x5babfb(0x215)](_0x46100d=>_0x46100d[_0x5babfb(0x1ef)](0xa,_0x46100d[_0x5babfb(0x200)]-0x1)));const _0x274744=_0x24b915['match'](/\[封面\].*\)/g);_0x274744&&([_0x29f351,_0x38c4dc]=_0x274744[_0x5babfb(0x215)](_0x21388d=>_0x21388d[_0x5babfb(0x1ef)](0x5,_0x21388d['length']-0x1)));const _0x4f8601=_0x24b915['match'](/https:\/\/(.*)\.mp3/g);_0x4f8601&&([_0x5914d2,_0x24f66c]=_0x4f8601);const _0x15aeae=_0x24b915[_0x5babfb(0x292)](/https:\/\/(.*)\.mp4/g);_0x15aeae&&([_0x1f7bfd,_0x3e5550]=_0x15aeae);}else throw new Error(_0x5babfb(0x219));}}}}_0x1439db={'title':_0xf6b67e,'intro':_0x537b16,'mp3':_0x5914d2,'mp4':_0x1f7bfd,'cover':_0x29f351,'sunoMusicId':_0x473932,'chatLogId':_0x5b477c['id'],'userId':_0x5b477c[_0x5babfb(0x287)]},_0xdd8dd9={'title':_0xf6b67e,'intro':_0x537b16,'mp3':_0x24f66c,'mp4':_0x3e5550,'cover':_0x38c4dc,'sunoMusicId':_0x36d195,'chatLogId':_0x5b477c['id'],'userId':_0x5b477c[_0x5babfb(0x287)]};}await this[_0x5babfb(0x28d)][_0x5babfb(0x1fc)](async()=>{const _0x19dd78=_0x5babfb;await this['aiAssetsEntity'][_0x19dd78(0x268)](_0x1439db),await this[_0x19dd78(0x1c8)][_0x19dd78(0x268)](_0xdd8dd9);});}async['parseAndSaveVideo'](_0x42fd78,{id:_0x375041,videoUrl:_0x2a1f60,state:_0x320f52,completed:_0xc0e123}){const _0x561018=_0x2e7b7f;let _0x168321={'mp4':_0x2a1f60,'sunoMusicId':_0x375041,'chatLogId':_0x42fd78['id'],'userId':_0x42fd78['userId']};if(_0x375041){const _0x44b5a0=await this['aiAssetsEntity']['findOne']({'where':{'sunoMusicId':_0x375041}});_0x44b5a0&&(_0x168321=Object[_0x561018(0x28e)](_0x44b5a0,_0x168321));}console[_0x561018(0x267)](_0x561018(0x2ad),_0x168321),_0x168321=await this[_0x561018(0x1c8)][_0x561018(0x268)](_0x168321),_0x42fd78['answer']=_0x320f52,this[_0x561018(0x223)][_0x561018(0x268)](_0x42fd78),_0xc0e123&&_0x168321[_0x561018(0x204)]&&this[_0x561018(0x295)](_0x168321);}async[_0x2e7b7f(0x2bb)](_0x75e3b0,_0x128dda){const _0x412473=_0x2e7b7f;try{const {id:_0x59d499}=_0x75e3b0['user'],{model:_0x4aa946}=_0x128dda,_0x2cd36b={'userId':_0x59d499,'type':balance_constant_1[_0x412473(0x216)][_0x412473(0x25b)],'modelType':_0x412473(0x203),'isDelete':![]};_0x128dda[_0x412473(0x2df)]&&(_0x2cd36b['modelSubType']=_0x128dda[_0x412473(0x2df)]);_0x4aa946&&(_0x2cd36b[_0x412473(0x1ae)]=_0x4aa946);const _0x24363d=await this[_0x412473(0x223)]['find']({'where':_0x2cd36b,'order':{'id':_0x412473(0x266)}});return _0x24363d[_0x412473(0x273)](_0x1a51cc=>{const _0x545ee3=_0x412473;if(_0x1a51cc[_0x545ee3(0x2a5)]==='paintCount'){const _0x540e5c=_0x1a51cc[_0x545ee3(0x1ae)]==='mj'?0x136:0xa0,_0x456873=_0x1a51cc[_0x545ee3(0x27e)][_0x545ee3(0x250)](_0x545ee3(0x274))?_0x545ee3(0x1f0):_0x545ee3(0x1d5),_0x480a4d=_0x456873==='tencent'?_0x545ee3(0x2cf)+_0x540e5c+_0x545ee3(0x2a4):_0x545ee3(0x2c2)+_0x540e5c;_0x1a51cc[_0x545ee3(0x1bd)]=_0x1a51cc[_0x545ee3(0x27e)]+_0x480a4d;const _0x1eef9c=_0x1a51cc[_0x545ee3(0x26a)]?JSON[_0x545ee3(0x2b3)](_0x1a51cc['extend']):null;_0x1eef9c&&(_0x1eef9c?_0x1a51cc[_0x545ee3(0x1f1)]=_0x1eef9c?.['components'][0x0]?.[_0x545ee3(0x235)][_0x545ee3(0x200)]===0x5:_0x1a51cc[_0x545ee3(0x1f1)]=![]);}}),_0x24363d;}catch(_0x28961d){return console[_0x412473(0x267)](_0x28961d),_0x28961d;}}async[_0x2e7b7f(0x297)](_0x5791eb,_0x1d9d00){const _0x21a73e=_0x2e7b7f;try{const {id:_0x40cb96}=_0x5791eb[_0x21a73e(0x1c2)],{model:_0x44ae3d}=_0x1d9d00,_0x1b73b8={'userId':_0x40cb96,'type':balance_constant_1[_0x21a73e(0x216)]['PAINT_TYPE'],'modelType':'draw','isDelete':![]};_0x1d9d00[_0x21a73e(0x2df)]&&(_0x1b73b8[_0x21a73e(0x25c)]=_0x1d9d00[_0x21a73e(0x2df)]);_0x44ae3d&&(_0x1b73b8['model']=_0x44ae3d);const [_0x18ff28,_0x27cf32]=await this[_0x21a73e(0x223)][_0x21a73e(0x24e)]({'where':_0x1b73b8,'order':{'id':'DESC'}});let _0x119266=[];return _0x18ff28[_0x21a73e(0x273)](_0x34f0d0=>{const _0x46a767=_0x21a73e;_0x119266[_0x46a767(0x1c6)](this[_0x46a767(0x2d0)](_0x34f0d0));}),{'result':_0x119266,'count':_0x27cf32};}catch(_0x20fc93){return console[_0x21a73e(0x267)](_0x20fc93),_0x20fc93;}}async[_0x2e7b7f(0x20a)](_0x3b645c,_0x51d6ab){const _0x40690c=_0x2e7b7f,_0x1aaa5c=_0x3b645c[_0x40690c(0x1c2)]['id'],_0x328d87=await this[_0x40690c(0x223)][_0x40690c(0x1d3)]({'where':{'userId':_0x1aaa5c,'id':_0x51d6ab}});if(!_0x328d87)return'';return this[_0x40690c(0x2d0)](_0x328d87);}[_0x2e7b7f(0x2d0)](_0xb7cadb){const _0x54d924=_0x2e7b7f;return{'id':_0xb7cadb['id'],'createdAt':_0xb7cadb[_0x54d924(0x286)],'userId':_0xb7cadb[_0x54d924(0x287)],'model':_0xb7cadb[_0x54d924(0x1ae)],'modelType':_0xb7cadb[_0x54d924(0x282)],'modelSubType':_0xb7cadb[_0x54d924(0x25c)],'fullPrompt':_0xb7cadb[_0x54d924(0x20f)],'originPrompt':_0xb7cadb[_0x54d924(0x20f)],'prompt':_0xb7cadb[_0x54d924(0x20f)],'answer':_0xb7cadb[_0x54d924(0x27e)],'status':_0xb7cadb['answer'],'failReason':_0xb7cadb[_0x54d924(0x1f2)],'imageUrl':_0xb7cadb[_0x54d924(0x263)],'rec':_0xb7cadb[_0x54d924(0x243)],'requestParams':_0xb7cadb['requestParams'],'isCollect':0x0,'collectNum':0x0};}async[_0x2e7b7f(0x1bf)](_0x18c801){const _0x5d8952=_0x2e7b7f,{page:page=0x1,size:size=0x14,rec:_0x1df874,userId:_0x3e75f3,model:_0x576f75}=_0x18c801,_0x3761c7={'type':balance_constant_1[_0x5d8952(0x216)][_0x5d8952(0x25b)],'prompt':(0x0,typeorm_2[_0x5d8952(0x285)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x1df874&&Object[_0x5d8952(0x28e)](_0x3761c7,{'rec':_0x1df874}),_0x3e75f3&&Object[_0x5d8952(0x28e)](_0x3761c7,{'userId':_0x3e75f3}),_0x576f75&&Object[_0x5d8952(0x28e)](_0x3761c7,{'model':_0x576f75});const [_0x35117a,_0x3f9ec6]=await this[_0x5d8952(0x223)][_0x5d8952(0x24e)]({'order':{'id':_0x5d8952(0x266)},'skip':(page-0x1)*size,'take':size,'where':_0x3761c7});return _0x35117a['forEach'](_0xa95fa8=>{const _0xbdd00f=_0x5d8952;if(_0xa95fa8['type']==='paintCount'){const _0x5981c5=_0xa95fa8[_0xbdd00f(0x1ae)]==='mj'?0x136:0xa0,_0x3ef6b8=_0xa95fa8[_0xbdd00f(0x27e)][_0xbdd00f(0x250)](_0xbdd00f(0x274))?_0xbdd00f(0x1f0):_0xbdd00f(0x1d5),_0x35e27a=_0x3ef6b8===_0xbdd00f(0x1f0)?_0xbdd00f(0x2cf)+_0x5981c5+_0xbdd00f(0x2a4):_0xbdd00f(0x2c2)+_0x5981c5;_0xa95fa8[_0xbdd00f(0x1bd)]=_0xa95fa8[_0xbdd00f(0x27e)]+_0x35e27a;const _0x4109b5=_0xa95fa8[_0xbdd00f(0x26a)]?JSON[_0xbdd00f(0x2b3)](_0xa95fa8['extend']):null;_0x4109b5&&(_0x4109b5?_0xa95fa8[_0xbdd00f(0x1f1)]=_0x4109b5?.['components'][0x0]?.[_0xbdd00f(0x235)]['length']===0x5:_0xa95fa8[_0xbdd00f(0x1f1)]=![]);}}),{'rows':_0x35117a,'count':_0x3f9ec6};}async[_0x2e7b7f(0x26f)](_0x343bd){const _0x2863d6=_0x2e7b7f,{id:_0x46b343}=_0x343bd,_0x28fa41=await this[_0x2863d6(0x223)][_0x2863d6(0x1d3)]({'where':{'id':_0x46b343,'type':balance_constant_1['DeductionKey'][_0x2863d6(0x25b)]}});if(!_0x28fa41)throw new common_1['HttpException'](_0x2863d6(0x2b8),common_1[_0x2863d6(0x1b7)]['BAD_REQUEST']);const _0xefff7=_0x28fa41['rec']===0x1?0x0:0x1,_0x2e2c57=await this[_0x2863d6(0x223)][_0x2863d6(0x23d)]({'id':_0x46b343},{'rec':_0xefff7});if(_0x2e2c57[_0x2863d6(0x2b0)]>0x0)return(_0xefff7?'推荐':_0x2863d6(0x265))+_0x2863d6(0x1da);throw new common_1[(_0x2863d6(0x226))]('你操作的图片不存在、请检查！',common_1[_0x2863d6(0x1b7)]['BAD_REQUEST']);}async[_0x2e7b7f(0x243)](_0x4f8d65,_0x5064fb,_0xd89896){const _0x539ccc=_0x2e7b7f,_0xef6541=await this[_0x539ccc(0x1c8)]['findOne']({'where':{'id':_0x4f8d65}});return _0xef6541&&(_0xef6541[_0x539ccc(0x1b4)]=_0x5064fb,_0xd89896&&(_0xef6541[_0x539ccc(0x2c1)]=_0xd89896)),await this[_0x539ccc(0x1c8)][_0x539ccc(0x268)](_0xef6541),!![];}async[_0x2e7b7f(0x2e2)](_0x17de3f,_0x455268){const _0x30929c=_0x2e7b7f;try{const _0x311378=(0x0,utils_1[_0x30929c(0x279)])(this['clsService']),{page:page=0x1,size:size=0x14,userId:_0x28cc00,keyword:_0x437be4,prompt:_0x339e99,saasId:_0x5b520f,modelType:_0x1f1d40}=_0x17de3f;let _0x2ecab6=_0x30929c(0x249);_0x28cc00&&(_0x2ecab6=_0x2ecab6+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20'+_0x28cc00));_0x339e99&&(_0x2ecab6=_0x2ecab6+(_0x30929c(0x2d7)+_0x339e99+'%\x27'));_0x1f1d40&&(_0x2ecab6=_0x2ecab6+(_0x30929c(0x1e8)+_0x1f1d40+'\x27'));(0x0,utils_1[_0x30929c(0x210)])(this[_0x30929c(0x1d2)])?(0x0,class_validator_1[_0x30929c(0x1ad)])(_0x5b520f)&&(_0x2ecab6=_0x2ecab6+(_0x30929c(0x1cc)+_0x5b520f)):_0x2ecab6=_0x2ecab6+(_0x30929c(0x26d)+_0x311378);_0x437be4&&(_0x2ecab6=_0x2ecab6+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%'+_0x437be4+_0x30929c(0x284)+_0x437be4+_0x30929c(0x2db)+_0x437be4+_0x30929c(0x2d1)+_0x437be4+_0x30929c(0x24d)));const _0xe2c8e1=await this[_0x30929c(0x28d)][_0x30929c(0x1db)](_0x30929c(0x28f)+_0x2ecab6+_0x30929c(0x2bd)),_0x1b5d8e=await this[_0x30929c(0x28d)][_0x30929c(0x1db)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x2ecab6+_0x30929c(0x2d9)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x30929c(0x2cd));return!(0x0,utils_1['isSuper'])(this['clsService'])&&_0x1b5d8e[_0x30929c(0x273)](_0x159418=>{const _0x3b6342=_0x30929c;_0x159418['email']=(0x0,utils_1[_0x3b6342(0x288)])(_0x159418[_0x3b6342(0x1ca)]),_0x159418['phone']=(0x0,utils_1[_0x3b6342(0x288)])(_0x159418[_0x3b6342(0x205)]);}),{'rows':_0x1b5d8e,'count':Number(_0xe2c8e1[0x0]?.[_0x30929c(0x25f)]||0x0)};}catch(_0x3d58f0){return console[_0x30929c(0x267)]('-------------------------ChatALL----------',_0x3d58f0),{'rows':[],'count':0x0};}}async[_0x2e7b7f(0x1f7)](_0x5f29fb){const _0x363cde=_0x2e7b7f;if(!_0x5f29fb[_0x363cde(0x26e)][_0x363cde(0x200)])return!![];return await this[_0x363cde(0x223)][_0x363cde(0x23d)]({'id':(0x0,typeorm_2['In'])(_0x5f29fb[_0x363cde(0x26e)])},{'isDelete':!![]}),!![];}async[_0x2e7b7f(0x21c)](_0x482cfc,_0x25bff0){const _0x2d49ef=_0x2e7b7f,{id:_0x544781}=_0x482cfc[_0x2d49ef(0x1c2)],{groupId:_0x3161d1,logType:_0x41ac8c,modelSubType:_0x11e3bb}=_0x25bff0,_0x149a56={'userId':_0x544781,'isDelete':![]};_0x3161d1&&Object['assign'](_0x149a56,{'groupId':_0x3161d1}),_0x41ac8c&&Object[_0x2d49ef(0x28e)](_0x149a56,{'logType':_0x41ac8c}),_0x11e3bb&&Object[_0x2d49ef(0x28e)](_0x149a56,{'modelSubType':_0x11e3bb});const _0x3848ec=await this[_0x2d49ef(0x223)][_0x2d49ef(0x1eb)]({'where':_0x149a56})[_0x2d49ef(0x236)](_0x5042ea=>{const _0x2da214=_0x2d49ef;common_1['Logger'][_0x2da214(0x1ed)](_0x5042ea);});if(!_0x3848ec||_0x3848ec[_0x2d49ef(0x200)]===0x0)return[];return _0x3848ec[_0x2d49ef(0x215)](_0xd99e38=>{const _0x950860=_0x2d49ef,{prompt:_0x170431,role:_0x2f2f3b,answer:_0x3be86e,createdAt:_0x59d4fa,model:_0x106d7a,conversationOptions:_0x3e989a,requestOptions:_0xda86fc,id:_0x35a1ad,answerMp3:_0x3d5432,think:_0x4ce4e6}=_0xd99e38;return{'chatId':_0x35a1ad,'dateTime':(0x0,utils_1[_0x950860(0x244)])(_0x59d4fa),'text':_0x2f2f3b===_0x950860(0x1c2)?_0x170431:_0x3be86e,'think':_0x4ce4e6,'textMp3':_0x3d5432,'inversion':_0x2f2f3b===_0x950860(0x1c2),'error':![],'conversationOptions':_0x3e989a?JSON[_0x950860(0x2b3)](_0x3e989a):null,'requestOptions':_0xda86fc?JSON['parse'](_0xda86fc):null};});}async[_0x2e7b7f(0x1e3)](_0x1fa449){const _0x3fba09=_0x2e7b7f;return this[_0x3fba09(0x223)][_0x3fba09(0x1eb)]({'where':{'groupId':_0x1fa449,'isDelete':![]}});}async[_0x2e7b7f(0x2a3)](_0x461b50,_0x40eafd,_0x590364){const _0x3cc481=_0x2e7b7f,_0x4ebf13=new Map();if(!_0x40eafd[_0x3cc481(0x200)])return _0x4ebf13;const _0x290a04=await this[_0x3cc481(0x1c8)][_0x3cc481(0x1eb)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x40eafd),'deleteFlag':0x0}}),_0x4c735f=_0x290a04[_0x3cc481(0x215)](_0x2e15f8=>_0x2e15f8['id']),_0x21ca9f=await this[_0x3cc481(0x2c7)]['getAgreeMap'](_0x461b50,_0x4c735f,_0x590364),_0x3cf75a=await this[_0x3cc481(0x2c7)]['getExtByRelate'](_0x4c735f,_0x590364);return _0x290a04[_0x3cc481(0x273)](_0x46480e=>{const _0x468b3e=_0x3cc481;!_0x4ebf13[_0x468b3e(0x21f)](_0x46480e[_0x468b3e(0x239)])&&_0x4ebf13[_0x468b3e(0x1f4)](_0x46480e['chatLogId'],[]);const _0x2837b6=_0x3cf75a['get'](_0x46480e['id']);_0x4ebf13[_0x468b3e(0x2b9)](_0x46480e[_0x468b3e(0x239)])[_0x468b3e(0x1c6)]({..._0x46480e,'agree':_0x21ca9f[_0x468b3e(0x2b9)](_0x46480e['id'])||null,'playNum':_0x2837b6?.[_0x468b3e(0x1c3)]||0x0,'visitNum':_0x2837b6?.['visitNum']||0x0,'agreeNum':_0x2837b6?.[_0x468b3e(0x2a8)]||0x0});}),_0x4ebf13;}async[_0x2e7b7f(0x206)](_0x3aaca9,_0x5d8485,_0xc10561){const _0x4a42fb=_0x2e7b7f;if(!_0x5d8485[_0x4a42fb(0x200)])return[];const _0x43ff28=await this[_0x4a42fb(0x223)][_0x4a42fb(0x1eb)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x5d8485)}});if(!_0x43ff28['length'])return[];const _0x58f577=await this[_0x4a42fb(0x2a3)](_0x3aaca9[_0x4a42fb(0x1c2)]['id'],_0x5d8485,_0xc10561),_0x12a6e8=new Map(),_0x54ac2c=_0x43ff28[_0x4a42fb(0x215)](_0xba2f71=>_0xba2f71[_0x4a42fb(0x287)])['filter'](_0x1d0642=>_0x1d0642);if(_0x54ac2c[_0x4a42fb(0x200)]){const _0x2944e4=(await this[_0x4a42fb(0x270)][_0x4a42fb(0x201)](_0x54ac2c))[_0x4a42fb(0x215)](_0x455512=>{const _0x2ac1d6=_0x4a42fb;return{'id':_0x455512['id'],'nickname':_0x455512[_0x2ac1d6(0x2be)],'avatar':_0x455512[_0x2ac1d6(0x1cf)]};});_0x2944e4[_0x4a42fb(0x273)](_0x3465ac=>_0x12a6e8[_0x4a42fb(0x1f4)](_0x3465ac['id'],_0x3465ac));}return _0x43ff28[_0x4a42fb(0x215)](_0x57160a=>{const _0x4be56c=_0x4a42fb;return{..._0x57160a,'userInfo':_0x12a6e8[_0x4be56c(0x2b9)](_0x57160a['userId']),'children':_0x58f577['get'](_0x57160a['id'])||[]};});}async['listAssetsBychatLogIds'](_0x586eb5){const _0x6ba59a=_0x2e7b7f;if(!_0x586eb5['length'])return[];return this[_0x6ba59a(0x1c8)][_0x6ba59a(0x1eb)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x586eb5)}});}async[_0x2e7b7f(0x1dc)](_0xca6404,_0x15e7d4){const _0x194c31=_0x2e7b7f;let _0x58d72a=collectType_constant_1['UserCollectType'][_0x194c31(0x1d1)];_0x15e7d4[_0x194c31(0x282)]==model_constant_1['EModelType'][_0x194c31(0x27b)]&&(_0x58d72a=collectType_constant_1[_0x194c31(0x2cb)][_0x194c31(0x27b)]);const _0x55e739=await this['userService'][_0x194c31(0x1dc)](_0x15e7d4[_0x194c31(0x293)],_0x15e7d4[_0x194c31(0x237)],_0xca6404[_0x194c31(0x1c2)]['id'],collectType_constant_1['UserCollectType'][_0x194c31(0x1d1)]);if(_0x55e739[_0x194c31(0x25f)]==0x0)return{'count':0x0,'records':[]};return await this[_0x194c31(0x2ae)](_0xca6404,_0x15e7d4,_0x55e739[_0x194c31(0x246)][_0x194c31(0x215)](_0x157aea=>_0x157aea[_0x194c31(0x1d6)]));}async[_0x2e7b7f(0x1ac)](_0xb13344,_0x4875fd){const _0x12865e=_0x2e7b7f;try{const _0x2b72f9={'isDelete':![],'role':'assistant','userId':_0xb13344[_0x12865e(0x1c2)]['id'],'modelType':_0x4875fd['modelType']};_0x4875fd[_0x12865e(0x25c)]?_0x2b72f9[_0x12865e(0x25c)]=_0x4875fd[_0x12865e(0x25c)]:_0x4875fd['modelType']===model_constant_1[_0x12865e(0x22b)]['MUSIC']&&(_0x2b72f9[_0x12865e(0x25c)]=_0x12865e(0x229));const [_0x18ef40,_0x3ba98e]=await this[_0x12865e(0x223)][_0x12865e(0x24e)]({'where':_0x2b72f9,'take':_0x4875fd[_0x12865e(0x237)],'skip':(_0x4875fd[_0x12865e(0x293)]-0x1)*_0x4875fd[_0x12865e(0x237)],'order':{'createdAt':_0x12865e(0x266)}}),_0x2cde3f=_0x18ef40['map'](_0x4c9fc9=>_0x4c9fc9['id']),_0x209a7e=await this['getMusicVoMap'](_0xb13344['user']['id'],_0x2cde3f,_0x4875fd[_0x12865e(0x282)]),_0x50de58=_0x18ef40['map'](_0x3a7b4f=>{const _0x4defa1=_0x12865e;return{..._0x3a7b4f,'children':_0x209a7e[_0x4defa1(0x2b9)](_0x3a7b4f['id'])||[]};});return{'count':_0x3ba98e,'records':_0x50de58};}catch(_0x13e7bd){throw new common_1[(_0x12865e(0x226))](_0x13e7bd[_0x12865e(0x1e7)],common_1[_0x12865e(0x1b7)][_0x12865e(0x1d7)]);}}async[_0x2e7b7f(0x22f)](_0x2495bf,_0x21db02){const _0x2aa0a4=_0x2e7b7f;if(!_0x21db02[_0x2aa0a4(0x26e)][_0x2aa0a4(0x200)])return!![];return await this[_0x2aa0a4(0x1c8)]['update']({'userId':_0x2495bf['user']['id'],'id':(0x0,typeorm_2['In'])(_0x21db02[_0x2aa0a4(0x26e)])},{'deleteFlag':0x1}),!![];}async[_0x2e7b7f(0x2e1)](_0x50645,_0x25b0a2){const _0x3c5600=_0x2e7b7f;if(!_0x25b0a2[_0x3c5600(0x26e)])return!![];return await this[_0x3c5600(0x28d)]['query'](_0x3c5600(0x1f9)+_0x50645[_0x3c5600(0x1c2)]['id']+_0x3c5600(0x2d2)+_0x25b0a2[_0x3c5600(0x26e)]['join']()+_0x3c5600(0x1bb)),!![];}async[_0x2e7b7f(0x2ae)](_0x212763,_0x1d4b8b,_0x9ccf87=[]){const _0x187d7d=_0x2e7b7f;let _0xd82bfe=(0x0,utils_1[_0x187d7d(0x1e2)])(this['clsService']);if(!_0xd82bfe||!_0x212763[_0x187d7d(0x1c2)]){const _0x39b19b=this[_0x187d7d(0x270)][_0x187d7d(0x29e)](_0x212763);_0xd82bfe=_0x39b19b?.['id'],_0x212763[_0x187d7d(0x1c2)]=_0x39b19b;}try{const {page:page=0x1,size:size=0x14,order:_0x484adf,keyword:_0x13ebd9,modelType:_0x28c933,modelSubType:_0x46f367,classify:_0x1a232b}=_0x1d4b8b;let _0x31fb64=_0x187d7d(0x260);if(_0x484adf===_0x187d7d(0x1c3))_0x31fb64='ale.play_num';else _0x484adf===_0x187d7d(0x2a8)&&(_0x31fb64=_0x187d7d(0x21e));const _0x381352=await this['connection'][_0x187d7d(0x1db)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27'+_0x28c933+_0x187d7d(0x231)+(_0x46f367?'and\x20cl.modelSubType=\x27'+_0x46f367+'\x27':'')+_0x187d7d(0x1ce)+(_0x1a232b?_0x187d7d(0x2c9)+_0x1a232b+'\x27\x20':'')+_0x187d7d(0x1e6)+(_0x13ebd9?_0x187d7d(0x23c)+_0x13ebd9+_0x187d7d(0x2ac):'')+_0x187d7d(0x1fe)+(_0x9ccf87&&_0x9ccf87[_0x187d7d(0x200)]?_0x187d7d(0x257)+_0x9ccf87[_0x187d7d(0x20c)]()+')\x20':'')+_0x187d7d(0x1c1)),_0xaa7f42=await this[_0x187d7d(0x28d)][_0x187d7d(0x1db)](_0x187d7d(0x291)+_0x28c933+_0x187d7d(0x231)+(_0x46f367?'and\x20cl.modelSubType=\x27'+_0x46f367+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27'+_0x28c933+_0x187d7d(0x2d4)+(_0x1a232b?_0x187d7d(0x2c9)+_0x1a232b+'\x27\x20':'')+_0x187d7d(0x2c6)+(_0x13ebd9?_0x187d7d(0x21d)+_0x13ebd9+_0x187d7d(0x24d):'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x9ccf87&&_0x9ccf87[_0x187d7d(0x200)]?_0x187d7d(0x257)+_0x9ccf87[_0x187d7d(0x20c)]()+')\x20':'')+_0x187d7d(0x2dd)+_0x31fb64+_0x187d7d(0x22c)+size+_0x187d7d(0x277)+(page-0x1)*size+_0x187d7d(0x1b3)),_0x2360e=_0xaa7f42[_0x187d7d(0x215)](_0x55ec04=>_0x55ec04['id']),_0x343c87=await this[_0x187d7d(0x2c7)]['getAgreeMap'](_0xd82bfe,_0x2360e,_0x28c933),_0x39cfd1=await this['aiLogService'][_0x187d7d(0x271)](_0x2360e,_0x28c933),_0xf961be=new Map(),_0x22629b=_0xaa7f42[_0x187d7d(0x215)](_0x3d28cb=>_0x3d28cb[_0x187d7d(0x287)])['filter'](_0x89b520=>_0x89b520);if(_0x22629b['length']){const _0x5b46bb=(await this[_0x187d7d(0x270)][_0x187d7d(0x201)](_0x22629b))[_0x187d7d(0x215)](_0x1516ef=>{const _0x3dabe2=_0x187d7d;return{'id':_0x1516ef['id'],'nickname':_0x1516ef[_0x3dabe2(0x2be)],'avatar':_0x1516ef[_0x3dabe2(0x1cf)]};});_0x5b46bb[_0x187d7d(0x273)](_0x28203c=>_0xf961be[_0x187d7d(0x1f4)](_0x28203c['id'],_0x28203c));}_0xaa7f42['forEach'](_0x4614bb=>{const _0x1d49a2=_0x187d7d,_0x198754=_0x39cfd1[_0x1d49a2(0x2b9)](_0x4614bb['id']);_0x4614bb['agree']=_0x343c87[_0x1d49a2(0x2b9)](_0x4614bb['id'])||null,_0x4614bb[_0x1d49a2(0x261)]=_0xf961be[_0x1d49a2(0x2b9)](_0x4614bb[_0x1d49a2(0x287)]),_0x4614bb[_0x1d49a2(0x2a8)]=_0x198754?.[_0x1d49a2(0x2a8)]||0x0;});if(_0x1d4b8b[_0x187d7d(0x282)]==model_constant_1[_0x187d7d(0x22b)][_0x187d7d(0x1d1)]){let _0x3c8529=await this[_0x187d7d(0x270)][_0x187d7d(0x24a)](_0xaa7f42,_0x212763,collectType_constant_1[_0x187d7d(0x2cb)][_0x187d7d(0x1d1)]);return _0x3c8529=await this[_0x187d7d(0x270)][_0x187d7d(0x1f6)](_0xaa7f42,collectType_constant_1['UserCollectType'][_0x187d7d(0x1d1)]),{'records':_0x3c8529,'count':Number(_0x381352[0x0]?.[_0x187d7d(0x25f)]||0x0)};}else{if(_0x1d4b8b['modelType']==model_constant_1[_0x187d7d(0x22b)][_0x187d7d(0x27b)]){let _0x274bc3=await this[_0x187d7d(0x270)][_0x187d7d(0x24a)](_0xaa7f42,_0x212763,collectType_constant_1[_0x187d7d(0x2cb)][_0x187d7d(0x27b)]);return _0x274bc3=await this[_0x187d7d(0x270)][_0x187d7d(0x1f6)](_0xaa7f42,collectType_constant_1['UserCollectType'][_0x187d7d(0x1d1)]),{'records':_0x274bc3,'count':Number(_0x381352[0x0]?.[_0x187d7d(0x25f)]||0x0)};}}return{'records':_0xaa7f42,'count':Number(_0x381352[0x0]?.[_0x187d7d(0x25f)]||0x0)};}catch(_0x989802){throw new common_1[(_0x187d7d(0x226))](_0x989802[_0x187d7d(0x1e7)],common_1[_0x187d7d(0x1b7)][_0x187d7d(0x1d7)]);}}async['assetsDetail'](_0xe7a2fe,_0x180db1){const _0x4743c2=_0x2e7b7f,_0x4efed9=(0x0,utils_1[_0x4743c2(0x1e2)])(this[_0x4743c2(0x1d2)]);try{const _0xf59ef5=await this[_0x4743c2(0x28d)][_0x4743c2(0x1db)](_0x4743c2(0x1e0)+_0xe7a2fe+_0x4743c2(0x1b3)),_0x2e5c69=_0xf59ef5['map'](_0x23cf58=>_0x23cf58['id']),_0x329358=await this[_0x4743c2(0x2c7)]['getAgreeMap'](_0x4efed9,_0x2e5c69,_0x180db1),_0x480785=new Map(),_0x3b3952=_0xf59ef5[_0x4743c2(0x215)](_0x14d772=>_0x14d772[_0x4743c2(0x287)])[_0x4743c2(0x1e9)](_0x5eb157=>_0x5eb157);if(_0x3b3952['length']){const _0x156e50=(await this[_0x4743c2(0x270)]['getUserListByIds'](_0x3b3952))[_0x4743c2(0x215)](_0x1ff2c7=>{const _0x21288a=_0x4743c2;return{'id':_0x1ff2c7['id'],'nickname':_0x1ff2c7[_0x21288a(0x2be)],'avatar':_0x1ff2c7[_0x21288a(0x1cf)]};});_0x156e50[_0x4743c2(0x273)](_0x1df135=>_0x480785[_0x4743c2(0x1f4)](_0x1df135['id'],_0x1df135));}return _0xf59ef5[_0x4743c2(0x273)](_0x7a4c67=>{const _0x25d9b3=_0x4743c2;_0x7a4c67['agree']=_0x329358['get'](_0x7a4c67['id'])||null,_0x7a4c67[_0x25d9b3(0x261)]=_0x480785[_0x25d9b3(0x2b9)](_0x7a4c67[_0x25d9b3(0x287)]);}),{..._0xf59ef5[0x0]};}catch(_0x206372){throw new common_1[(_0x4743c2(0x226))](_0x206372[_0x4743c2(0x1e7)],common_1[_0x4743c2(0x1b7)][_0x4743c2(0x1d7)]);}}async[_0x2e7b7f(0x224)](_0x3ed73c,_0x3d411e){const _0x4587f3=_0x2e7b7f,{id:_0x5b6ec5}=_0x3ed73c[_0x4587f3(0x1c2)],{groupId:_0x592538}=_0x3d411e,_0x50920f={'userId':_0x5b6ec5,'isDelete':![]};_0x592538&&Object['assign'](_0x50920f,{'groupId':_0x592538});const _0x147bad=await this[_0x4587f3(0x223)][_0x4587f3(0x1eb)]({'where':_0x50920f});return _0x147bad['map'](_0x29aa75=>{const _0x3d76ca=_0x4587f3,{prompt:_0x6f2151,role:_0x45ca22,answer:_0x6ae11a,createdAt:_0x4ddacb,model:_0x46f7c1,conversationOptions:_0x1896a8,requestOptions:_0x57cf18,id:_0x445146}=_0x29aa75;return{'chatId':_0x445146,'dateTime':(0x0,utils_1['formatDate'])(_0x4ddacb),'text':_0x45ca22===_0x3d76ca(0x1c2)?_0x6f2151:_0x6ae11a,'inversion':_0x45ca22===_0x3d76ca(0x1c2),'error':![],'conversationOptions':_0x1896a8?JSON[_0x3d76ca(0x2b3)](_0x1896a8):null,'requestOptions':_0x57cf18?JSON[_0x3d76ca(0x2b3)](_0x57cf18):null};});}async[_0x2e7b7f(0x22d)](_0x456825,_0x2fdfc7){const _0x3283ec=_0x2e7b7f,{id:_0x3b0ec2}=_0x456825[_0x3283ec(0x1c2)],{id:_0x57e407}=_0x2fdfc7,_0x373e5e=await this[_0x3283ec(0x223)][_0x3283ec(0x1d3)]({'where':{'id':_0x57e407,'userId':_0x3b0ec2}});if(!_0x373e5e)throw new common_1[(_0x3283ec(0x226))](_0x3283ec(0x2af),common_1[_0x3283ec(0x1b7)][_0x3283ec(0x1d7)]);const _0x359f9f=await this[_0x3283ec(0x223)]['update']({'id':_0x57e407},{'isDelete':!![]});await this[_0x3283ec(0x1c8)]['update']({'userId':_0x456825[_0x3283ec(0x1c2)]['id'],'chatLogId':_0x57e407},{'deleteFlag':0x1});if(_0x359f9f[_0x3283ec(0x2b0)]>0x0)return _0x3283ec(0x209);else throw new common_1[(_0x3283ec(0x226))](_0x3283ec(0x2af),common_1[_0x3283ec(0x1b7)][_0x3283ec(0x1d7)]);}async['delByGroupId'](_0x478c63,_0x332b28){const _0x4d55a6=_0x2e7b7f,{groupId:_0x492259,type:_0x3c3ac8}=_0x332b28,{id:_0x47b1ed}=_0x478c63[_0x4d55a6(0x1c2)],_0x80d93b=_0x3c3ac8&&_0x3c3ac8===_0x4d55a6(0x27c)?{'groupId':_0x492259,'userId':_0x47b1ed}:{'groupId':_0x492259,'userId':_0x47b1ed},_0x4be84e=await this[_0x4d55a6(0x223)][_0x4d55a6(0x29a)](_0x80d93b);if(_0x4be84e['affected']>0x0)return!![];if(_0x4be84e['affected']===0x0)throw new common_1['HttpException'](_0x4d55a6(0x1fd),common_1[_0x4d55a6(0x1b7)][_0x4d55a6(0x1d7)]);}async['removeLogsBatch'](_0x3dc58c){const _0x1a5cdd=_0x2e7b7f,{ids:_0x43e80d,userId:_0x5d35d8}=_0x3dc58c;return await this[_0x1a5cdd(0x223)][_0x1a5cdd(0x29a)]({'groupId':(0x0,typeorm_2['In'])(_0x43e80d),'userId':_0x5d35d8});}async['byAppId'](_0x4cf980,_0x3951e8){const _0x1b8064=_0x2e7b7f,{id:_0x2797fe}=_0x4cf980[_0x1b8064(0x1c2)],{appId:_0x418b43,page:page=0x1,size:size=0xa}=_0x3951e8,[_0x384543,_0x232dcf]=await this[_0x1b8064(0x223)][_0x1b8064(0x24e)]({'where':{'userId':_0x2797fe,'appId':_0x418b43,'role':_0x1b8064(0x290)},'order':{'id':_0x1b8064(0x266)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x384543,'count':_0x232dcf};}async[_0x2e7b7f(0x222)](_0x24ab21,_0x16f8d4){const _0x47b1ce=_0x2e7b7f,_0x10b95d=_0x24ab21[_0x47b1ce(0x1c2)]['id'],_0x1ee647=await this[_0x47b1ce(0x223)]['findOne']({'where':{'userId':_0x10b95d,'id':_0x16f8d4}});if(!_0x1ee647)return'';return{'chatId':_0x1ee647['id'],'dateTime':(0x0,utils_1[_0x47b1ce(0x244)])(_0x1ee647[_0x47b1ce(0x286)]),'text':_0x1ee647[_0x47b1ce(0x24c)]==='user'?_0x1ee647[_0x47b1ce(0x20f)]:_0x1ee647[_0x47b1ce(0x27e)],'textMp3':_0x1ee647['answerMp3'],'inversion':_0x1ee647[_0x47b1ce(0x24c)]===_0x47b1ce(0x1c2)};}async['byChatlogId'](_0x3005c0,_0x476d50){const _0x8910e1=_0x2e7b7f,_0x2a46b6=_0x3005c0[_0x8910e1(0x1c2)]['id'],_0x133cbf=await this[_0x8910e1(0x223)][_0x8910e1(0x1d3)]({'where':{'userId':_0x2a46b6,'id':_0x476d50}});if(!_0x133cbf)return'';return _0x133cbf[_0x8910e1(0x27e)];}async[_0x2e7b7f(0x1f3)](){const _0x1bcc5f=_0x2e7b7f,_0x1964a0=await this[_0x1bcc5f(0x28d)][_0x1bcc5f(0x1db)](_0x1bcc5f(0x1c4));return _0x1964a0;}async[_0x2e7b7f(0x1b5)](){const _0x51b62e=_0x2e7b7f,_0x3bd80f=await this[_0x51b62e(0x28d)][_0x51b62e(0x1db)](_0x51b62e(0x25d));return _0x3bd80f;}async[_0x2e7b7f(0x1b9)](){const _0x5ca7e1=_0x2e7b7f,_0x2de5dc=await this[_0x5ca7e1(0x28d)][_0x5ca7e1(0x1db)](_0x5ca7e1(0x298));return _0x2de5dc;}async['refundVideo'](_0x46f234){const _0x42f014=_0x2e7b7f,_0x52f231=await this[_0x42f014(0x230)][_0x42f014(0x248)](_0x46f234[_0x42f014(0x1b1)]);_0x52f231&&this[_0x42f014(0x270)]['refundBalance4Video'](_0x46f234[_0x42f014(0x287)],_0x52f231,_0x46f234[_0x42f014(0x23f)],_0x46f234['id']);}async[_0x2e7b7f(0x253)](_0x239efc){const _0x419105=_0x2e7b7f,_0x2977e4=await this[_0x419105(0x1c8)][_0x419105(0x1d3)]({'where':{'sunoMusicId':_0x239efc['id']}});if(!_0x2977e4)return;const _0x1d8519=await this['chatLogEntity'][_0x419105(0x1d3)]({'where':{'id':_0x2977e4[_0x419105(0x239)]}});_0x1d8519[_0x419105(0x27e)]=_0x239efc[_0x419105(0x1f5)],_0x2977e4['mp4']=_0x239efc[_0x419105(0x258)]?.['url'],await this[_0x419105(0x1c8)][_0x419105(0x268)](_0x2977e4);if(_0x1d8519[_0x419105(0x27e)]===_0x419105(0x1b6)&&_0x2977e4[_0x419105(0x204)])this[_0x419105(0x295)](_0x2977e4);else _0x1d8519['answer']===_0x419105(0x212)&&(_0x1d8519['errMsg']='failed',this[_0x419105(0x2aa)](_0x1d8519));await this[_0x419105(0x223)][_0x419105(0x268)](_0x1d8519);}async[_0x2e7b7f(0x2a6)](_0x59bba2){const _0x24b509=_0x2e7b7f;console[_0x24b509(0x267)](_0x24b509(0x259),_0x59bba2);const _0x5982b5=await this[_0x24b509(0x1c8)][_0x24b509(0x1d3)]({'where':{'sunoMusicId':_0x59bba2[_0x24b509(0x242)]}});if(!_0x5982b5)throw new Error(_0x24b509(0x272));const _0x4fc559=await this[_0x24b509(0x223)][_0x24b509(0x1d3)]({'where':{'id':_0x5982b5['chatLogId']}});_0x4fc559[_0x24b509(0x27e)]=_0x59bba2[_0x24b509(0x1f5)],_0x5982b5['mp4']=_0x59bba2[_0x24b509(0x2a2)],await this['aiAssetsEntity'][_0x24b509(0x268)](_0x5982b5);if(_0x59bba2[_0x24b509(0x2b7)]==='3'&&_0x5982b5[_0x24b509(0x204)])this[_0x24b509(0x295)](_0x5982b5);else _0x4fc559['answer']==='failed'&&(_0x4fc559[_0x24b509(0x1f2)]=_0x24b509(0x2e0),this[_0x24b509(0x2aa)](_0x4fc559));await this[_0x24b509(0x223)][_0x24b509(0x268)](_0x4fc559);}async[_0x2e7b7f(0x247)](_0x2abddb){const _0xf0c21b=_0x2e7b7f;console[_0xf0c21b(0x267)]('klingImage通知：',_0x2abddb);const _0x185040=_0x2abddb[_0xf0c21b(0x1ba)]?_0x2abddb[_0xf0c21b(0x1ba)]:_0x2abddb,_0x1eada3=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x185040[_0xf0c21b(0x242)]}});if(!_0x1eada3)throw new Error(_0xf0c21b(0x272));_0x1eada3[_0xf0c21b(0x27e)]=_0x185040[_0xf0c21b(0x264)],_0x2abddb[_0xf0c21b(0x1cd)][_0xf0c21b(0x278)]&&(_0x1eada3[_0xf0c21b(0x263)]=JSON[_0xf0c21b(0x2a1)](_0x2abddb['task_result'][_0xf0c21b(0x278)][_0xf0c21b(0x215)](_0x338a65=>_0x338a65[_0xf0c21b(0x2a7)]))),_0x1eada3['answer']==_0xf0c21b(0x2e0)&&(_0x1eada3[_0xf0c21b(0x1f2)]=_0x185040[_0xf0c21b(0x238)]),await this['chatLogEntity'][_0xf0c21b(0x268)](_0x1eada3);}async[_0x2e7b7f(0x1df)](_0x2034dd){const _0x442688=_0x2e7b7f;console[_0x442688(0x267)](_0x442688(0x22e),_0x2034dd);const _0x193122=_0x2034dd[_0x442688(0x1ba)]?_0x2034dd['data']:_0x2034dd,_0x2dc147=await this[_0x442688(0x1c8)][_0x442688(0x1d3)]({'where':{'sunoMusicId':_0x193122[_0x442688(0x242)]}});if(!_0x2dc147)throw new Error('资源不存在！');const _0x5a4972=await this[_0x442688(0x223)][_0x442688(0x1d3)]({'where':{'id':_0x2dc147[_0x442688(0x239)]}});_0x5a4972[_0x442688(0x27e)]=_0x193122[_0x442688(0x264)];_0x193122[_0x442688(0x1cd)][_0x442688(0x1de)]&&(_0x2dc147['mp4']=_0x193122['task_result'][_0x442688(0x1de)][0x0]?.[_0x442688(0x2a7)]);await this['aiAssetsEntity'][_0x442688(0x268)](_0x2dc147);if(_0x5a4972[_0x442688(0x27e)]==='succeed'&&_0x2dc147[_0x442688(0x204)])this['syncVideo'](_0x2dc147);else _0x5a4972[_0x442688(0x27e)]===_0x442688(0x2e0)&&(_0x5a4972[_0x442688(0x1f2)]=_0x442688(0x2e0),this[_0x442688(0x2aa)](_0x5a4972));await this[_0x442688(0x223)][_0x442688(0x268)](_0x5a4972);}async[_0x2e7b7f(0x1d9)](_0xcc5c95,_0x223572){const _0x2e001e=_0x2e7b7f;console[_0x2e001e(0x267)](_0x2e001e(0x2ab),_0xcc5c95);let _0x496b01;_0x223572==='lyrics'?(_0x496b01=await this[_0x2e001e(0x223)][_0x2e001e(0x1d3)]({'where':{'id':Number(_0xcc5c95['task_id'])}}),_0x496b01[_0x2e001e(0x27e)]=_0xcc5c95[_0x2e001e(0x1ec)]||_0xcc5c95[_0x2e001e(0x1ba)][_0x2e001e(0x1ec)]):(_0x496b01=await this[_0x2e001e(0x223)][_0x2e001e(0x1d3)]({'where':{'message_id':_0xcc5c95[_0x2e001e(0x242)]}}),_0x496b01['answer']=_0xcc5c95[_0x2e001e(0x2b7)]);_0x496b01[_0x2e001e(0x27e)]!==_0x2e001e(0x225)&&await this['chatLogEntity'][_0x2e001e(0x268)](_0x496b01);if(_0x223572==='create'){const _0x31bc08=await this[_0x2e001e(0x1c8)][_0x2e001e(0x1eb)]({'where':{'chatLogId':_0x496b01['id']}});for(const _0x5ef221 of _0xcc5c95[_0x2e001e(0x1ba)]){const {title:_0x3f6c44,prompt:_0xd95faf,audio_url:_0x2c2248,image_url:_0x319634,task_id:_0x3aafbb,id:_0x72dca9,video_url:_0x50d5a0,duration:_0x4157ff}=_0x5ef221,_0x2fc831=_0x3aafbb?_0x31bc08[_0x2e001e(0x1eb)](_0x7e8abd=>_0x7e8abd['sunoMusicId']===_0x3aafbb):_0x31bc08[_0x2e001e(0x1eb)](_0x170f7d=>_0x170f7d[_0x2e001e(0x2b5)]===_0x72dca9);!_0x2fc831?await this[_0x2e001e(0x1c8)][_0x2e001e(0x268)]({'title':_0x3f6c44,'intro':_0xd95faf||_0x5ef221[_0x2e001e(0x2ca)][_0x2e001e(0x20f)],'duration':_0x4157ff||0x0,'mp3':_0x2c2248||'','mp4':_0x50d5a0||'','cover':_0x319634||'','sunoMusicId':_0x3aafbb||_0x72dca9,'chatLogId':_0x496b01['id'],'userId':_0x496b01['userId']}):(_0x2fc831[_0x2e001e(0x2d3)]=_0x4157ff||0x0,_0x2fc831[_0x2e001e(0x29b)]=_0x3f6c44,_0x2fc831['intro']=_0xd95faf||_0x5ef221[_0x2e001e(0x2ca)]['prompt'],_0x2fc831[_0x2e001e(0x233)]=_0x2c2248||'',_0x2fc831[_0x2e001e(0x204)]=_0x50d5a0||'',_0x2fc831[_0x2e001e(0x1af)]=_0x319634||'',await this[_0x2e001e(0x1c8)][_0x2e001e(0x268)](_0x2fc831));}}}async['syncVideoTest'](_0x4e38bb){const _0x44619b=_0x2e7b7f,_0x13dfe8=await this[_0x44619b(0x1c8)]['findOne']({'where':{'id':_0x4e38bb}}),[_0x49131f,_0x29323a]=await this[_0x44619b(0x254)]['transferAndCover'](_0x13dfe8['mp4']);return console[_0x44619b(0x267)](_0x44619b(0x25a),_0x29323a),!![];}async['syncVideo'](_0x239149){const _0x59257c=_0x2e7b7f,[_0x2abea9,_0x160b42]=await this[_0x59257c(0x254)]['transferAndCover'](_0x239149[_0x59257c(0x204)]);_0x239149[_0x59257c(0x204)]=_0x2abea9,_0x239149['cover']=_0x160b42,await this[_0x59257c(0x1c8)][_0x59257c(0x268)](_0x239149);}async[_0x2e7b7f(0x1c0)](){const _0x1d4978=_0x2e7b7f,_0x41fb26=await this[_0x1d4978(0x1c8)][_0x1d4978(0x1eb)]({'where':[{'cover':(0x0,typeorm_2['Like'])(_0x1d4978(0x2dc))},{'mp3':(0x0,typeorm_2[_0x1d4978(0x1b0)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x1d4978(0x1b0)])(_0x1d4978(0x2dc))},{'mp4':(0x0,typeorm_2['Like'])(_0x1d4978(0x24f))}]});for(let _0x152c97=0x0;_0x152c97<_0x41fb26[_0x1d4978(0x200)];_0x152c97++){const _0xd1acb5=_0x41fb26[_0x152c97],_0x220cf4=redisKey_constant_1[_0x1d4978(0x1f8)]+_0xd1acb5['id'];try{const _0x55fcf0=await this[_0x1d4978(0x1d0)][_0x1d4978(0x2b9)]({'key':_0x220cf4});if(_0x55fcf0)continue;await this['redisCacheService'][_0x1d4978(0x1f4)]({'key':_0x220cf4,'val':_0x1d4978(0x220)});const {cover:_0x4730e2,mp3:_0x16f768,mp4:_0x3f9d95}=_0xd1acb5;/filesystem.site/[_0x1d4978(0x289)](_0x4730e2)&&(_0xd1acb5[_0x1d4978(0x1af)]=await this[_0x1d4978(0x254)]['transferFile'](_0x4730e2));/filesystem.site/[_0x1d4978(0x289)](_0x16f768)&&(_0xd1acb5[_0x1d4978(0x233)]=await this['fileService'][_0x1d4978(0x256)](_0x16f768));if(/filesystem.site|storage.cdn-luma.com/[_0x1d4978(0x289)](_0x3f9d95)){if(_0x4730e2)_0xd1acb5[_0x1d4978(0x204)]=await this[_0x1d4978(0x254)]['transferFile'](_0x3f9d95);else{const [_0x321269,_0x3c9e03]=await this[_0x1d4978(0x254)]['transferAndCover'](_0x3f9d95);_0xd1acb5[_0x1d4978(0x204)]=_0x321269,_0xd1acb5['cover']=_0x3c9e03;}}await this[_0x1d4978(0x1c8)][_0x1d4978(0x268)](_0xd1acb5);}catch(_0x49ed8b){common_1[_0x1d4978(0x28c)]['error'](_0x49ed8b);}finally{await this[_0x1d4978(0x1d0)][_0x1d4978(0x2c0)]({'key':_0x220cf4});}}}async['getLastByUserAndAppIds'](_0xd5bb3a,_0x27d0b4){const _0x4b1119=_0x2e7b7f,_0x425b5b=await this['chatLogEntity']['query'](_0x4b1119(0x2a0)+_0xd5bb3a+_0x4b1119(0x27d)+_0x27d0b4[_0x4b1119(0x29c)]()+_0x4b1119(0x20d));return _0x425b5b;}async['batchMusicResult'](){const _0x1d76d0=_0x2e7b7f;try{const _0x35ac73=store_1['MusicConfig'][_0x1d76d0(0x27f)]||0x5,_0x48d481=await this['chatLogEntity'][_0x1d76d0(0x1eb)]({'where':{'role':_0x1d76d0(0x290),'modelType':model_constant_1[_0x1d76d0(0x22b)][_0x1d76d0(0x27b)],'answer':(0x0,typeorm_2['In'])(['IN_PROGRESS','']),'updatedAt':(0x0,typeorm_2['LessThan'])(new Date(Date[_0x1d76d0(0x1dd)]()-_0x35ac73*0x3c*0x3e8))}});_0x48d481[_0x1d76d0(0x273)](async _0x382325=>{const _0x15e33d=_0x1d76d0;_0x382325[_0x15e33d(0x27e)]=_0x15e33d(0x225),_0x382325[_0x15e33d(0x1f2)]=_0x15e33d(0x225),this[_0x15e33d(0x223)][_0x15e33d(0x268)](_0x382325),await this['aiAssetsEntity']['update']({'chatLogId':_0x382325['id']},{'deleteFlag':0x1}),this[_0x15e33d(0x270)][_0x15e33d(0x28a)](_0x382325[_0x15e33d(0x287)],_0x382325['id'],_0x382325[_0x15e33d(0x25c)],!![]);});}catch(_0x4c528f){common_1['Logger']['error'](_0x4c528f);}}async[_0x2e7b7f(0x221)](){const _0x4a66ea=_0x2e7b7f;try{const _0xb38d94=0xa,_0x1ffb4e=await this[_0x4a66ea(0x223)]['find']({'where':{'role':_0x4a66ea(0x290),'modelType':model_constant_1[_0x4a66ea(0x22b)][_0x4a66ea(0x1d1)],'answer':(0x0,typeorm_2['In'])(['PENDING','']),'modelSubType':'2','updatedAt':(0x0,typeorm_2['LessThan'])(new Date(Date[_0x4a66ea(0x1dd)]()-_0xb38d94*0x3c*0x3e8))}});_0x1ffb4e[_0x4a66ea(0x273)](async _0x56bcc9=>{const _0x293955=_0x4a66ea;_0x56bcc9[_0x293955(0x27e)]=_0x293955(0x225),_0x56bcc9['errMsg']=_0x293955(0x225),this[_0x293955(0x223)]['save'](_0x56bcc9),await this[_0x293955(0x1c8)][_0x293955(0x23d)]({'chatLogId':_0x56bcc9['id']},{'deleteFlag':0x1}),await this[_0x293955(0x2aa)](_0x56bcc9);});}catch(_0x21cfa6){common_1[_0x4a66ea(0x28c)][_0x4a66ea(0x1ed)](_0x21cfa6);}}async[_0x2e7b7f(0x241)](){const _0x178841=_0x2e7b7f,_0x30cc53=await this[_0x178841(0x1b5)]();if(!_0x30cc53[_0x178841(0x200)])return;const _0x3a4fd1=await this[_0x178841(0x230)][_0x178841(0x1ee)](model_constant_1[_0x178841(0x22b)][_0x178841(0x1d1)],'5'),_0x1bfe2a=new openapi_1['Service']({'serviceName':'cv','region':'cn-north-1','host':_0x3a4fd1[_0x178841(0x1ea)][_0x178841(0x283)],'accessKeyId':_0x3a4fd1[_0x178841(0x1ea)][_0x178841(0x28b)],'secretKey':_0x3a4fd1['modelInfo']['secret']}),_0x1dc444=_0x1bfe2a[_0x178841(0x262)](_0x178841(0x26c),{'Version':_0x178841(0x1b2),'method':'POST','contentType':_0x178841(0x251)});for(const _0xfb338e of _0x30cc53){if(_0xfb338e['message_id'])try{const _0x21abf6=await _0x1dc444({'req_key':_0xfb338e[_0x178841(0x1ae)],'task_id':_0xfb338e['message_id']});console[_0x178841(0x267)](_0x178841(0x1b8),_0xfb338e[_0x178841(0x21b)],_0x21abf6);if(_0x21abf6[_0x178841(0x2b7)]==_0x178841(0x228)){_0xfb338e['answer']=_0x21abf6['data'][_0x178841(0x2b7)]=='done'?_0x178841(0x23e):_0x21abf6['data']['status'];const _0x176cf0=await this[_0x178841(0x1c8)][_0x178841(0x1d3)]({'where':{'chatLogId':_0xfb338e['id']}}),_0x5228cf=_0x21abf6['data']?.[_0x178841(0x2a2)];_0x176cf0[_0x178841(0x1af)]=_0x21abf6[_0x178841(0x1ba)]?.[_0x178841(0x1fb)],_0x176cf0[_0x178841(0x204)]=_0x5228cf,await this['aiAssetsEntity'][_0x178841(0x268)](_0x176cf0),await this['chatLogEntity'][_0x178841(0x268)](_0xfb338e),this[_0x178841(0x295)](_0x176cf0);}}catch(_0x1428dd){console[_0x178841(0x267)](_0x178841(0x275),_0x1428dd);}}}async[_0x2e7b7f(0x214)](){const _0x51d440=_0x2e7b7f;console[_0x51d440(0x267)](_0x51d440(0x255));const _0x4b0b41=await this['listUndoneVideoForVeo']();console[_0x51d440(0x267)](_0x51d440(0x23a),_0x4b0b41[_0x51d440(0x200)]);if(!_0x4b0b41[_0x51d440(0x200)])return;const _0x3b5b24=await this[_0x51d440(0x230)][_0x51d440(0x1ee)](model_constant_1[_0x51d440(0x22b)]['VIDEO'],'6');for(const _0x557cc2 of _0x4b0b41){if(_0x557cc2[_0x51d440(0x21b)])try{const _0x1b2e0a=await this[_0x51d440(0x1bc)][_0x51d440(0x1db)]({'params':{'id':_0x557cc2[_0x51d440(0x21b)]},'baseURL':_0x3b5b24[_0x51d440(0x1ea)][_0x51d440(0x283)],'headers':{'Authorization':_0x51d440(0x2d8)+_0x3b5b24['modelInfo'][_0x51d440(0x28b)]}});console['log'](_0x51d440(0x1e4),_0x557cc2['message_id'],_0x1b2e0a),_0x557cc2[_0x51d440(0x27e)]=_0x1b2e0a[_0x51d440(0x2b7)]=='completed'?_0x51d440(0x23e):_0x1b2e0a[_0x51d440(0x2b7)];const _0xb95931=await this[_0x51d440(0x1c8)][_0x51d440(0x1d3)]({'where':{'chatLogId':_0x557cc2['id']}}),_0x5272a3=_0x1b2e0a['video_url'];_0xb95931['mp4']=_0x5272a3,await this[_0x51d440(0x1c8)][_0x51d440(0x268)](_0xb95931),await this['chatLogEntity'][_0x51d440(0x268)](_0x557cc2),this['syncVideo'](_0xb95931);}catch(_0x470ec5){console[_0x51d440(0x267)](_0x51d440(0x21a),_0x470ec5);}}}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x2e7b7f(0x299)])(chatLog_entity_1[_0x2e7b7f(0x218)])),__param(0x1,(0x0,typeorm_1[_0x2e7b7f(0x299)])(aiAssets_entity_1['AiAssetsEntity'])),__metadata(_0x2e7b7f(0x23b),[typeorm_2[_0x2e7b7f(0x1e5)],typeorm_2['Repository'],nestjs_cls_1[_0x2e7b7f(0x202)],file_service_1['FileService'],aiLog_service_1[_0x2e7b7f(0x2bf)],redisCache_service_1[_0x2e7b7f(0x25e)],user_service_1[_0x2e7b7f(0x2ce)],models_service_1[_0x2e7b7f(0x2b6)],veoTask_service_1[_0x2e7b7f(0x2b4)],typeorm_2[_0x2e7b7f(0x26b)]])],ChatLogService),exports['ChatLogService']=ChatLogService;function _0x2077(){const _0x36c074=['toString','\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20','../models/models.service','prompt','isPlatform','__decorate','FAILED','**歌词：**','syncVeoTask','map','DeductionKey','./entity/chatLog.entity','ChatLogEntity','解析错误','----------VEO视频错误---------','message_id','chatList','AND\x20aa.title\x20LIKE\x20(\x27%','ale.agree_num','has','lock','batchRunwayVideoResult','byId','chatLogEntity','chatGptsList','timeout','HttpException','./entity/aiAssets.entity','10000','create','####','EModelType','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','deleteChatLog','kling通知：','assetsDel','modelsService','\x27\x20\x20','../user/user.service','mp3','defineProperty','components','catch','size','task_status_msg','chatLogId','-------------------同步Veo视频------------------','design:paramtypes','\x20AND\x20aa.title\x20LIKE\x20(\x27%','update','succeed','requestParams','@nestjs/common','syncJMengTask','task_id','rec','formatDate','../../common/constants/model.constant','rows','videoNotifyKLingImage','getModelById','isDelete\x20=\x200','mergeCollectData','802232dcLVnW','role','%\x27)','findAndCount','%storage.cdn-luma.com%','includes','json','__metadata','videoNotify','fileService','-------------------开始同步Veo视频------------------','transferFile','\x20AND\x20aa.id\x20in\x20(','video','runway通知：','-----------TEST--------','PAINT_TYPE','modelSubType','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x275\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27done\x27,\x20\x27failed\x27,\x27succeed\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','RedisCacheService','count','aa.createdAt','userInfo','createAPI','fileInfo','task_status','取消推荐','DESC','log','save','3961375sVYGGm','extend','Connection','CVSync2AsyncGetResult','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','ids','recDrawImg','userService','getExtByRelate','资源不存在！','forEach','cos','----------即梦视频错误---------','453723IXvtAU','\x20OFFSET\x20','images','getReqSaasId','replace','MUSIC','gpts','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','answer','musicTimeoutMs','@nestjs/typeorm','Request\x20failed','modelType','proxyUrl','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','Not','createdAt','userId','maskEmail','test','debuctBalance4Muisc','key','Logger','connection','assign','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','assistant','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','match','page','179514VcobkW','syncVideo','10BBaPnJ','querDrawLogPage','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x276\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20NOT\x20IN\x20(\x20\x27failed\x27,\x20\x27completed\x27,\x27succeed\x27)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x20\x20and\x20message_id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20','InjectRepository','delete','title','join','function','getUserInfoFromHeader','###🎵\x20歌曲名','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','stringify','video_url','getMusicVoMap','/q/55','type','videoNotifyRunway','url','agreeNum','../../common/store','refundVideo','suno通知：','%\x27)\x20','=======================保存视频入库====================','assetsSquare','你删除的对话记录不存在、请检查！','affected','31796MUYueh','---','parse','VeoTaskService','sunoMusicId','ModelsService','status','你推荐的图片不存在、请检查！','get','```','querDrawLog','split','\x20\x0a\x20\x20\x20\x20','nickname','AiLogService','del','classify','?x-oss-process=image/resize,w_','28kFFgvf','saveChatLog','decorate','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','aiLogService','../redisCache/redisCache.service','\x20AND\x20aa.classify=\x27','metadata','UserCollectType','7VXyKbW','\x0a\x20\x20\x20\x20','UserService','?imageView2/1/w/','returnDrawDetail','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','\x20AND\x20id\x20IN\x20(','duration','\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','indexOf','../aiLog/aiLog.service','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','Bearer\x20','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','__esModule','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','%filesystem.site%','\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','**版本ID','keyType','failed','assetsPublish','querAllChatLog','chatTaskLog','isDefined','model','cover','Like','modelId','2022-08-31','\x0a\x20\x20\x20\x20\x20\x20','publishFlag','listUndoneVideoForJMeng','completed','HttpStatus','-------------------即梦视频------------------','listUndoneVideoForVeo','data',')\x0a\x20\x20\x20\x20','veoTaskService','thumbImg','1261674xoQOya','querAllDrawLog','syncAssets','\x20\x0a\x20\x20\x20\x20\x20\x20','user','playNum','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelSubType\x20=\x20\x271\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','音乐生成错误：','push','__param','aiAssetsEntity','nestjs-cls','email','../../common/constants/balance.constant','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','task_result','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','avatar','redisCacheService','VIDEO','clsService','findOne','object','ali','relId','BAD_REQUEST','getOwnPropertyDescriptor','videoNotifySuno','图片成功！','query','collectPage','now','videos','videoNotifyKLing','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.requestParams\x20as\x20requestParams,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20and\x20aa.id=','45jPPMaE','getUserId','listByGroupId','-------------------Veo视频------------------','Repository','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','message','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','filter','modelInfo','find','text','error','getModelInfoByKeyType','substring','tencent','isGroup','errMsg','listUndoneVideoForLuma','set','state','mergeCollectCountData','delChatLog','MUSIC_TRANSFER','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','9578ptgXfN','image_urls','transaction','当前页面已经没有东西可以删除了！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../api/veoTask.service','length','getUserListByIds','ClsService','draw','mp4','phone','listByIds','ChatLogService','../../common/constants/redisKey.constant','删除对话记录成功！','drawDetail','startsWith'];_0x2077=function(){return _0x36c074;};return _0x2077();}