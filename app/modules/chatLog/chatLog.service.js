'use strict';const _0xfd5929=_0x5ec5;(function(_0x950754,_0x391ccc){const _0x18ee2f=_0x5ec5,_0x4e4888=_0x950754();while(!![]){try{const _0x58583d=-parseInt(_0x18ee2f(0x187))/0x1+parseInt(_0x18ee2f(0xfe))/0x2+-parseInt(_0x18ee2f(0x13f))/0x3*(parseInt(_0x18ee2f(0x14b))/0x4)+-parseInt(_0x18ee2f(0x1b2))/0x5+-parseInt(_0x18ee2f(0x15d))/0x6*(-parseInt(_0x18ee2f(0x151))/0x7)+-parseInt(_0x18ee2f(0x13c))/0x8*(-parseInt(_0x18ee2f(0x15b))/0x9)+parseInt(_0x18ee2f(0x108))/0xa;if(_0x58583d===_0x391ccc)break;else _0x4e4888['push'](_0x4e4888['shift']());}catch(_0x4e2205){_0x4e4888['push'](_0x4e4888['shift']());}}}(_0x3000,0x514bb));function _0x5ec5(_0x4fb90c,_0x1b0cf4){const _0x3000e9=_0x3000();return _0x5ec5=function(_0x5ec58d,_0x3c5025){_0x5ec58d=_0x5ec58d-0xf3;let _0x563387=_0x3000e9[_0x5ec58d];return _0x563387;},_0x5ec5(_0x4fb90c,_0x1b0cf4);}var __decorate=this&&this[_0xfd5929(0x134)]||function(_0x356f3c,_0x366734,_0x5b5a2d,_0x2fd73d){const _0xa2439e=_0xfd5929;var _0xcd7fc1=arguments['length'],_0x439e53=_0xcd7fc1<0x3?_0x366734:_0x2fd73d===null?_0x2fd73d=Object['getOwnPropertyDescriptor'](_0x366734,_0x5b5a2d):_0x2fd73d,_0x1d0ce9;if(typeof Reflect===_0xa2439e(0x196)&&typeof Reflect[_0xa2439e(0x105)]==='function')_0x439e53=Reflect[_0xa2439e(0x105)](_0x356f3c,_0x366734,_0x5b5a2d,_0x2fd73d);else{for(var _0x11f957=_0x356f3c[_0xa2439e(0x107)]-0x1;_0x11f957>=0x0;_0x11f957--)if(_0x1d0ce9=_0x356f3c[_0x11f957])_0x439e53=(_0xcd7fc1<0x3?_0x1d0ce9(_0x439e53):_0xcd7fc1>0x3?_0x1d0ce9(_0x366734,_0x5b5a2d,_0x439e53):_0x1d0ce9(_0x366734,_0x5b5a2d))||_0x439e53;}return _0xcd7fc1>0x3&&_0x439e53&&Object[_0xa2439e(0x120)](_0x366734,_0x5b5a2d,_0x439e53),_0x439e53;},__metadata=this&&this[_0xfd5929(0x14d)]||function(_0x4f9ad6,_0x46a15f){const _0x71497b=_0xfd5929;if(typeof Reflect===_0x71497b(0x196)&&typeof Reflect[_0x71497b(0x193)]===_0x71497b(0x140))return Reflect[_0x71497b(0x193)](_0x4f9ad6,_0x46a15f);},__param=this&&this['__param']||function(_0x2af8d1,_0x4e8574){return function(_0x53fc8f,_0x4a2894){_0x4e8574(_0x53fc8f,_0x4a2894,_0x2af8d1);};};Object[_0xfd5929(0x120)](exports,_0xfd5929(0x19c),{'value':!![]}),exports[_0xfd5929(0x12d)]=void 0x0;const common_1=require(_0xfd5929(0x154)),typeorm_1=require(_0xfd5929(0x18b)),chatLog_entity_1=require(_0xfd5929(0x131)),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0xfd5929(0x16c)),file_service_1=require(_0xfd5929(0x184)),redisCache_service_1=require(_0xfd5929(0x1bf)),redisKey_constant_1=require(_0xfd5929(0x156)),model_constant_1=require('../../common/constants/model.constant'),aiAssets_entity_1=require(_0xfd5929(0x1aa)),aiLog_service_1=require(_0xfd5929(0x13e)),nestjs_cls_1=require(_0xfd5929(0x198)),class_validator_1=require(_0xfd5929(0x100)),user_service_1=require(_0xfd5929(0x19e)),models_service_1=require(_0xfd5929(0xf4)),store_1=require(_0xfd5929(0x18a));let ChatLogService=class ChatLogService{constructor(_0xb6046,_0x39686f,_0x4fe87b,_0x5d0b2f,_0x302904,_0x14a59e,_0x58b4a0,_0x2ee9f3,_0x8c7fc7){const _0x483148=_0xfd5929;this[_0x483148(0x143)]=_0xb6046,this[_0x483148(0x19b)]=_0x39686f,this['clsService']=_0x4fe87b,this[_0x483148(0x106)]=_0x5d0b2f,this[_0x483148(0x17b)]=_0x302904,this['redisCacheService']=_0x14a59e,this[_0x483148(0x192)]=_0x58b4a0,this[_0x483148(0x157)]=_0x2ee9f3,this[_0x483148(0x186)]=_0x8c7fc7;}async[_0xfd5929(0x160)](_0x9bcf2){const _0x41815e=_0xfd5929;return await this['chatLogEntity'][_0x41815e(0x1af)](_0x9bcf2);}async[_0xfd5929(0x179)](_0x36de4f){const _0x3eba40=_0xfd5929,_0x3d9d1c=_0x36de4f[_0x3eba40(0x148)];let _0x15498b={},_0x22b5cd={};if(_0x3d9d1c[_0x3eba40(0x1b7)]('Request\x20failed')!=-0x1)throw new Error('音乐生成错误：'+_0x3d9d1c);else{let _0x5d4ae2='',_0x31e99a='',_0x3210dd=_0x3eba40(0x14f),_0x10f14c=_0x3eba40(0x14f),_0x3b1467=_0x3eba40(0x14f),_0x230d7c='解析错误',_0x11a05a=_0x3eba40(0x14f),_0x4ca766=_0x3eba40(0x14f),_0x10f85c='解析错误',_0x20cd15=_0x3eba40(0x14f);if(_0x3d9d1c[_0x3eba40(0x10b)]('####')){const [_0xcbeb1b]=_0x3d9d1c[_0x3eba40(0x1a4)](/>(\S+)\n/g);_0x5d4ae2=_0x31e99a=_0xcbeb1b['substring'](0x1,_0xcbeb1b[_0x3eba40(0x107)]-0x1),_0x3210dd=_0x3d9d1c['split']('\x0a')[0x0][_0x3eba40(0x11c)](0x7),_0x10f14c=_0x3d9d1c[_0x3eba40(0x173)](_0x3eba40(0x125))[0x1][_0x3eba40(0x14e)](/\[.*\]|（.*）/g,'')[_0x3eba40(0x14e)](/\n+/g,'\x0a');const _0x416115=_0x3d9d1c[_0x3eba40(0x1a4)](/!\[image\].*\)/g);_0x416115&&([_0x3b1467,_0x230d7c]=_0x416115['map'](_0xe68551=>_0xe68551['substring'](0x9,_0xe68551[_0x3eba40(0x107)]-0x1)));const _0x5352c1=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp3/g);_0x5352c1&&([_0x11a05a,_0x4ca766]=_0x5352c1);const _0x4920b4=_0x3d9d1c['match'](/https:\/\/(.*)\.mp4/g);_0x4920b4&&([_0x10f85c,_0x20cd15]=_0x4920b4);}else{if(_0x3d9d1c['startsWith']('🎵')){_0x3210dd=_0x3d9d1c[_0x3eba40(0x173)]('\x0a')[0x0][_0x3eba40(0x14e)](/🎵/g,'');const _0x515be2=_0x3d9d1c[_0x3eba40(0x173)]('--')['find'](_0x26c0d1=>/-\n\n\[/[_0x3eba40(0x183)](_0x26c0d1));if(_0x515be2){const _0x2ac2e8=_0x515be2[_0x3eba40(0x14e)](/\[.*\]|（.*）|-/g,'')[_0x3eba40(0x14e)](/\n+/g,'\x0a');_0x2ac2e8[_0x3eba40(0x10b)]('\x0a')?_0x10f14c=_0x2ac2e8[_0x3eba40(0x14e)]('\x0a',''):_0x10f14c=_0x2ac2e8;}const _0x21b098=_0x3d9d1c[_0x3eba40(0x1a4)](/歌曲id(.+)\n/ig);_0x21b098&&([_0x5d4ae2,_0x31e99a]=_0x21b098['map'](_0x13c9a9=>_0x13c9a9[_0x3eba40(0x11c)](0xc,_0x13c9a9[_0x3eba40(0x107)]-0x1)));const _0x2878d7=_0x3d9d1c[_0x3eba40(0x1a4)](/\[封面图片\].*\)/g);_0x2878d7&&([_0x3b1467,_0x230d7c]=_0x2878d7[_0x3eba40(0x141)](_0x5184cb=>_0x5184cb['substring'](0x7,_0x5184cb[_0x3eba40(0x107)]-0x1)));const _0x2208ef=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp3/g);_0x2208ef&&([_0x11a05a,_0x4ca766]=_0x2208ef);const _0x52101e=_0x3d9d1c['match'](/https:\/\/(.*)\.mp4/g);_0x52101e&&([_0x10f85c,_0x20cd15]=_0x52101e);}else{if(_0x3d9d1c[_0x3eba40(0x1b7)]('💄')!=-0x1){let _0x5ea561=_0x3d9d1c[_0x3eba40(0x173)]('\x0a');_0x5ea561[_0x3eba40(0x1d2)](_0x37d74b=>{const _0x3eb7d=_0x3eba40;_0x37d74b[_0x3eb7d(0x1b7)]('🔎')!=-0x1&&(_0x3210dd=_0x37d74b[_0x3eb7d(0x173)]('：')[0x1]);});const _0x5eba43=_0x3d9d1c['split'](_0x3eba40(0x111))[0x1]['split']('\x0a');if(_0x5eba43){const _0x2de5f2=_0x5eba43[_0x3eba40(0x12e)](_0x3900dd=>_0x3900dd[_0x3eba40(0x1b7)]('[')==-0x1)[_0x3eba40(0x1b1)]('');_0x2de5f2['startsWith']('\x0a')?_0x10f14c=_0x2de5f2[_0x3eba40(0x14e)]('\x0a',''):_0x10f14c=_0x2de5f2;}const _0x5e61de=_0x3d9d1c[_0x3eba40(0x1a4)](/歌曲id(.+)\n/ig);_0x5e61de&&([_0x5d4ae2,_0x31e99a]=_0x5e61de[_0x3eba40(0x141)](_0x517590=>_0x517590[_0x3eba40(0x11c)](0xa,_0x517590[_0x3eba40(0x107)]-0x1)));const _0x15956f=_0x3d9d1c['match'](/\[封面图片\].*\)/g);_0x15956f&&([_0x3b1467,_0x230d7c]=_0x15956f[_0x3eba40(0x141)](_0x2cc729=>_0x2cc729['substring'](0x7,_0x2cc729['length']-0x1)));const _0x122ffd=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp3/g);_0x122ffd&&([_0x11a05a,_0x4ca766]=_0x122ffd);const _0x3cfd3f=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp4/g);_0x3cfd3f&&([_0x10f85c,_0x20cd15]=_0x3cfd3f);}else{if(_0x3d9d1c[_0x3eba40(0x10b)]('🎁')){_0x3210dd=_0x3d9d1c['split']('\x0a')[0x2][_0x3eba40(0x173)](_0x3eba40(0x159))[0x1];const _0x2e70a7=_0x3d9d1c[_0x3eba40(0x173)]('```')[0x1][_0x3eba40(0x173)]('\x0a');if(_0x2e70a7){const _0x323925=_0x2e70a7[_0x3eba40(0x12e)](_0x2dc72c=>_0x2dc72c['indexOf']('[')==-0x1)['join']('');_0x323925['startsWith']('\x0a')?_0x10f14c=_0x323925[_0x3eba40(0x14e)]('\x0a',''):_0x10f14c=_0x323925;}const _0x1e43ad=_0x3d9d1c[_0x3eba40(0x1a4)](/歌曲ID：(.+)\n/ig);_0x1e43ad&&([_0x5d4ae2,_0x31e99a]=_0x1e43ad[_0x3eba40(0x141)](_0x114b8d=>_0x114b8d[_0x3eba40(0x11c)](0x8,_0x114b8d[_0x3eba40(0x107)]-0x1)));const _0x5f4d14=_0x3d9d1c[_0x3eba40(0x1a4)](/\[封面\].*\)/g);_0x5f4d14&&([_0x3b1467,_0x230d7c]=_0x5f4d14['map'](_0x46ca4e=>_0x46ca4e[_0x3eba40(0x11c)](0x5,_0x46ca4e[_0x3eba40(0x107)]-0x1)));const _0x30b6cd=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp3/g);_0x30b6cd&&([_0x11a05a,_0x4ca766]=_0x30b6cd);const _0x464406=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp4/g);_0x464406&&([_0x10f85c,_0x20cd15]=_0x464406);}else{if(_0x3d9d1c[_0x3eba40(0x1b7)](_0x3eba40(0x139))!==-0x1){let _0x5b6a6d=_0x3d9d1c['split']('\x0a'),_0x2f704c=![];const _0x270534=[];for(let _0x2a2041=0x0;_0x2a2041<_0x5b6a6d[_0x3eba40(0x107)];_0x2a2041++){const _0x420ef1=_0x5b6a6d[_0x2a2041];_0x420ef1[_0x3eba40(0x1b7)](_0x3eba40(0x139))!==-0x1&&(_0x3210dd=_0x420ef1[_0x3eba40(0x173)]('：\x20')[0x1]);if(_0x420ef1[_0x3eba40(0x18f)](_0x3eba40(0x163)))_0x2f704c=![];else{if(_0x2f704c&&!_0x420ef1[_0x3eba40(0x10b)]('['))_0x270534[_0x3eba40(0x1bc)](_0x420ef1);else _0x420ef1[_0x3eba40(0x18f)](_0x3eba40(0x11a))&&(_0x2f704c=!![]);}}_0x10f14c=_0x270534[_0x3eba40(0x1b1)]('\x20');const _0x93f117=_0x3d9d1c[_0x3eba40(0x1a4)](/版本ID：(.+)\n/ig);_0x93f117&&([_0x5d4ae2,_0x31e99a]=_0x93f117['map'](_0x1e6169=>_0x1e6169[_0x3eba40(0x11c)](0xa,_0x1e6169[_0x3eba40(0x107)]-0x1)));const _0x1fe51d=_0x3d9d1c[_0x3eba40(0x1a4)](/\[封面\].*\)/g);_0x1fe51d&&([_0x3b1467,_0x230d7c]=_0x1fe51d[_0x3eba40(0x141)](_0x4513eb=>_0x4513eb[_0x3eba40(0x11c)](0x5,_0x4513eb[_0x3eba40(0x107)]-0x1)));const _0x560eaa=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp3/g);_0x560eaa&&([_0x11a05a,_0x4ca766]=_0x560eaa);const _0x46e27a=_0x3d9d1c[_0x3eba40(0x1a4)](/https:\/\/(.*)\.mp4/g);_0x46e27a&&([_0x10f85c,_0x20cd15]=_0x46e27a);}else throw new Error('解析错误');}}}}_0x15498b={'title':_0x3210dd,'intro':_0x10f14c,'mp3':_0x11a05a,'mp4':_0x10f85c,'cover':_0x3b1467,'sunoMusicId':_0x5d4ae2,'chatLogId':_0x36de4f['id'],'userId':_0x36de4f[_0x3eba40(0x10e)]},_0x22b5cd={'title':_0x3210dd,'intro':_0x10f14c,'mp3':_0x4ca766,'mp4':_0x20cd15,'cover':_0x230d7c,'sunoMusicId':_0x31e99a,'chatLogId':_0x36de4f['id'],'userId':_0x36de4f[_0x3eba40(0x10e)]};}await this[_0x3eba40(0x186)]['transaction'](async()=>{const _0x47bb5c=_0x3eba40;await this[_0x47bb5c(0x19b)][_0x47bb5c(0x1af)](_0x15498b),await this[_0x47bb5c(0x19b)][_0x47bb5c(0x1af)](_0x22b5cd);});}async[_0xfd5929(0x1b9)](_0x3c1da5,{id:_0x380817,videoUrl:_0x1e7da7,state:_0x46f74b,completed:_0x2c92c8}){const _0x3823d1=_0xfd5929;let _0x5bcaea={'mp4':_0x1e7da7,'sunoMusicId':_0x380817,'chatLogId':_0x3c1da5['id'],'userId':_0x3c1da5[_0x3823d1(0x10e)]};if(_0x380817){const _0x3a9d72=await this[_0x3823d1(0x19b)]['findOne']({'where':{'sunoMusicId':_0x380817}});_0x3a9d72&&(_0x5bcaea=Object['assign'](_0x3a9d72,_0x5bcaea));}console[_0x3823d1(0x175)]('=======================保存视频入库====================',_0x5bcaea),_0x5bcaea=await this[_0x3823d1(0x19b)]['save'](_0x5bcaea),_0x3c1da5[_0x3823d1(0x148)]=_0x46f74b,this[_0x3823d1(0x143)][_0x3823d1(0x1af)](_0x3c1da5),_0x2c92c8&&_0x5bcaea['mp4']&&this[_0x3823d1(0x129)](_0x5bcaea);}async[_0xfd5929(0x11b)](_0x718157,_0x3f9d66){const _0x47afaf=_0xfd5929,{id:_0x261353}=_0x718157['user'],{model:_0x4f6698}=_0x3f9d66,_0x1d0597={'userId':_0x261353,'type':balance_constant_1[_0x47afaf(0x117)][_0x47afaf(0x114)]};_0x4f6698&&(_0x1d0597[_0x47afaf(0x168)]=_0x4f6698);const _0x50a6af=await this[_0x47afaf(0x143)][_0x47afaf(0x155)]({'where':_0x1d0597,'order':{'id':_0x47afaf(0x199)}});return _0x50a6af['forEach'](_0x60ccc9=>{const _0x5ae42c=_0x47afaf;if(_0x60ccc9[_0x5ae42c(0x1c4)]===_0x5ae42c(0x13a)){const _0x325879=_0x60ccc9[_0x5ae42c(0x168)]==='mj'?0x136:0xa0,_0x2abab5=_0x60ccc9['answer'][_0x5ae42c(0x18f)](_0x5ae42c(0x164))?_0x5ae42c(0x122):_0x5ae42c(0x128),_0x93a1d3=_0x2abab5==='tencent'?_0x5ae42c(0x14c)+_0x325879+_0x5ae42c(0x119):'?x-oss-process=image/resize,w_'+_0x325879;_0x60ccc9[_0x5ae42c(0x12f)]=_0x60ccc9[_0x5ae42c(0x148)]+_0x93a1d3;const _0x460946=_0x60ccc9['extend']?JSON[_0x5ae42c(0xfd)](_0x60ccc9[_0x5ae42c(0x1a2)]):null;_0x460946&&(_0x460946?_0x60ccc9['isGroup']=_0x460946?.[_0x5ae42c(0x138)][0x0]?.[_0x5ae42c(0x138)]['length']===0x5:_0x60ccc9[_0x5ae42c(0x197)]=![]);}}),_0x50a6af;}async[_0xfd5929(0x1cc)](_0x2c38ac){const _0x3b6620=_0xfd5929,{page:page=0x1,size:size=0x14,rec:_0x4e9b73,userId:_0x380e7b,model:_0x19345a}=_0x2c38ac,_0x27eef9={'type':balance_constant_1[_0x3b6620(0x117)][_0x3b6620(0x114)],'prompt':(0x0,typeorm_2[_0x3b6620(0xff)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x4e9b73&&Object['assign'](_0x27eef9,{'rec':_0x4e9b73}),_0x380e7b&&Object[_0x3b6620(0x1ad)](_0x27eef9,{'userId':_0x380e7b}),_0x19345a&&Object[_0x3b6620(0x1ad)](_0x27eef9,{'model':_0x19345a});const [_0x99162c,_0x57dee0]=await this['chatLogEntity'][_0x3b6620(0x1ba)]({'order':{'id':_0x3b6620(0x199)},'skip':(page-0x1)*size,'take':size,'where':_0x27eef9});return _0x99162c[_0x3b6620(0x1d2)](_0x5bac25=>{const _0x1350a1=_0x3b6620;if(_0x5bac25[_0x1350a1(0x1c4)]==='paintCount'){const _0x4055a0=_0x5bac25[_0x1350a1(0x168)]==='mj'?0x136:0xa0,_0x253aca=_0x5bac25['answer'][_0x1350a1(0x18f)](_0x1350a1(0x164))?_0x1350a1(0x122):_0x1350a1(0x128),_0x23ca74=_0x253aca==='tencent'?'?imageView2/1/w/'+_0x4055a0+_0x1350a1(0x119):_0x1350a1(0x169)+_0x4055a0;_0x5bac25[_0x1350a1(0x12f)]=_0x5bac25['answer']+_0x23ca74;const _0x3185d1=_0x5bac25['extend']?JSON[_0x1350a1(0xfd)](_0x5bac25[_0x1350a1(0x1a2)]):null;_0x3185d1&&(_0x3185d1?_0x5bac25[_0x1350a1(0x197)]=_0x3185d1?.[_0x1350a1(0x138)][0x0]?.[_0x1350a1(0x138)][_0x1350a1(0x107)]===0x5:_0x5bac25[_0x1350a1(0x197)]=![]);}}),{'rows':_0x99162c,'count':_0x57dee0};}async[_0xfd5929(0x171)](_0x556170){const _0x2ae27a=_0xfd5929,{id:_0x5300a3}=_0x556170,_0xa9645b=await this['chatLogEntity']['findOne']({'where':{'id':_0x5300a3,'type':balance_constant_1[_0x2ae27a(0x117)]['PAINT_TYPE']}});if(!_0xa9645b)throw new common_1[(_0x2ae27a(0x17c))](_0x2ae27a(0x1c7),common_1[_0x2ae27a(0x1a8)][_0x2ae27a(0x1e0)]);const _0x4c1176=_0xa9645b['rec']===0x1?0x0:0x1,_0x71ec51=await this[_0x2ae27a(0x143)][_0x2ae27a(0x1b8)]({'id':_0x5300a3},{'rec':_0x4c1176});if(_0x71ec51[_0x2ae27a(0x104)]>0x0)return(_0x4c1176?'推荐':'取消推荐')+_0x2ae27a(0x1d8);throw new common_1['HttpException'](_0x2ae27a(0x1ac),common_1[_0x2ae27a(0x1a8)]['BAD_REQUEST']);}async['querAllChatLog'](_0x576e06,_0x47d6ff){const _0x127394=_0xfd5929,_0x3fb8bb=(0x0,utils_1[_0x127394(0x1c1)])(this[_0x127394(0x170)]),{page:page=0x1,size:size=0x14,userId:_0x9aba5,keyword:_0x128093,prompt:_0x1d9224,saasId:_0x2389a8,modelType:_0x48d132}=_0x576e06;let _0x3b6c83='isDelete\x20=\x200';_0x9aba5&&(_0x3b6c83=_0x3b6c83+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20'+_0x9aba5));_0x1d9224&&(_0x3b6c83=_0x3b6c83+(_0x127394(0x1da)+_0x1d9224+'%\x27'));_0x48d132&&(_0x3b6c83=_0x3b6c83+(_0x127394(0xfc)+_0x48d132+'\x27'));(0x0,utils_1[_0x127394(0x191)])(this[_0x127394(0x170)])?(0x0,class_validator_1[_0x127394(0xf9)])(_0x2389a8)&&(_0x3b6c83=_0x3b6c83+(_0x127394(0x1c6)+_0x2389a8)):_0x3b6c83=_0x3b6c83+(_0x127394(0x17f)+_0x3fb8bb);_0x128093&&(_0x3b6c83=_0x3b6c83+(_0x127394(0x1de)+_0x128093+_0x127394(0x1df)+_0x128093+_0x127394(0x1c2)+_0x128093+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x128093+_0x127394(0x16a)));const _0xa35873=await this[_0x127394(0x186)][_0x127394(0x177)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x3b6c83+'\x20\x0a\x20\x20\x20\x20'),_0x17c71c=await this['connection'][_0x127394(0x177)](_0x127394(0x15e)+_0x3b6c83+_0x127394(0x133)+size+_0x127394(0x1a7)+(page-0x1)*size+_0x127394(0x1ca));return!(0x0,utils_1[_0x127394(0x1d9)])(this[_0x127394(0x170)])&&_0x17c71c['forEach'](_0x57c31f=>{const _0xe1af0f=_0x127394;_0x57c31f[_0xe1af0f(0x10d)]=(0x0,utils_1[_0xe1af0f(0xf5)])(_0x57c31f[_0xe1af0f(0x10d)]),_0x57c31f[_0xe1af0f(0x10c)]=(0x0,utils_1[_0xe1af0f(0xf5)])(_0x57c31f[_0xe1af0f(0x10c)]);}),{'rows':_0x17c71c,'count':Number(_0xa35873[0x0]?.[_0x127394(0xf6)]||0x0)};}async[_0xfd5929(0x166)](_0x1278f3){const _0x449355=_0xfd5929;if(!_0x1278f3[_0x449355(0x146)]['length'])return!![];return await this[_0x449355(0x143)][_0x449355(0x1b8)]({'id':(0x0,typeorm_2['In'])(_0x1278f3[_0x449355(0x146)])},{'isDelete':!![]}),!![];}async[_0xfd5929(0x174)](_0xd11d0d,_0x3be610){const _0x5c1494=_0xfd5929,{id:_0x47f169}=_0xd11d0d['user'],{groupId:_0x2511e1,logType:_0x533d03,modelSubType:_0x4ce996}=_0x3be610,_0x394436={'userId':_0x47f169,'isDelete':![]};_0x2511e1&&Object[_0x5c1494(0x1ad)](_0x394436,{'groupId':_0x2511e1}),_0x533d03&&Object[_0x5c1494(0x1ad)](_0x394436,{'logType':_0x533d03}),_0x4ce996&&Object['assign'](_0x394436,{'modelSubType':_0x4ce996});const _0x17c06d=await this[_0x5c1494(0x143)][_0x5c1494(0x155)]({'where':_0x394436})['catch'](_0x3ee651=>{const _0x5e13b1=_0x5c1494;common_1[_0x5e13b1(0x1cb)]['error'](_0x3ee651);});if(!_0x17c06d||_0x17c06d[_0x5c1494(0x107)]===0x0)return[];return _0x17c06d['map'](_0x3c18d0=>{const _0x4a11f0=_0x5c1494,{prompt:_0x5267ce,role:_0x1ea166,answer:_0x29fe68,createdAt:_0x105b03,model:_0x1191fa,conversationOptions:_0x551630,requestOptions:_0x41b93e,id:_0x45bc6d,answerMp3:_0x4919ed}=_0x3c18d0;return{'chatId':_0x45bc6d,'dateTime':(0x0,utils_1[_0x4a11f0(0x17e)])(_0x105b03),'text':_0x1ea166===_0x4a11f0(0x17d)?_0x5267ce:_0x29fe68,'textMp3':_0x4919ed,'inversion':_0x1ea166===_0x4a11f0(0x17d),'error':![],'conversationOptions':_0x551630?JSON[_0x4a11f0(0xfd)](_0x551630):null,'requestOptions':_0x41b93e?JSON[_0x4a11f0(0xfd)](_0x41b93e):null};});}async[_0xfd5929(0x121)](_0xf8375f){const _0x399510=_0xfd5929;return this[_0x399510(0x143)][_0x399510(0x155)]({'where':{'groupId':_0xf8375f,'isDelete':![]}});}async[_0xfd5929(0x1bb)](_0x44ab29,_0x393509,_0x628f77){const _0x3b9256=_0xfd5929,_0xf917ea=new Map();if(!_0x393509[_0x3b9256(0x107)])return _0xf917ea;const _0x50b9cb=await this['aiAssetsEntity'][_0x3b9256(0x155)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x393509),'deleteFlag':0x0}}),_0x4a05d1=_0x50b9cb[_0x3b9256(0x141)](_0x35859d=>_0x35859d['id']),_0x305082=await this[_0x3b9256(0x17b)][_0x3b9256(0x115)](_0x44ab29,_0x4a05d1,_0x628f77),_0x500dac=await this['aiLogService'][_0x3b9256(0x189)](_0x4a05d1,_0x628f77);return _0x50b9cb[_0x3b9256(0x1d2)](_0x32e328=>{const _0x1c2f87=_0x3b9256;!_0xf917ea[_0x1c2f87(0x1d7)](_0x32e328[_0x1c2f87(0x1d6)])&&_0xf917ea[_0x1c2f87(0x172)](_0x32e328[_0x1c2f87(0x1d6)],[]);const _0xd01967=_0x500dac[_0x1c2f87(0x116)](_0x32e328['id']);_0xf917ea[_0x1c2f87(0x116)](_0x32e328[_0x1c2f87(0x1d6)])[_0x1c2f87(0x1bc)]({..._0x32e328,'agree':_0x305082[_0x1c2f87(0x116)](_0x32e328['id'])||null,'playNum':_0xd01967?.[_0x1c2f87(0x1dd)]||0x0,'visitNum':_0xd01967?.[_0x1c2f87(0x18d)]||0x0,'agreeNum':_0xd01967?.[_0x1c2f87(0x1be)]||0x0});}),_0xf917ea;}async['listByIds'](_0x4330b2,_0x1d051d,_0x5834b6){const _0x36bba1=_0xfd5929;if(!_0x1d051d[_0x36bba1(0x107)])return[];const _0x46b87e=await this['chatLogEntity'][_0x36bba1(0x155)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x1d051d)}});if(!_0x46b87e[_0x36bba1(0x107)])return[];const _0x2c5bc8=await this[_0x36bba1(0x1bb)](_0x4330b2[_0x36bba1(0x17d)]['id'],_0x1d051d,_0x5834b6);return _0x46b87e[_0x36bba1(0x141)](_0x321ef3=>{return{..._0x321ef3,'children':_0x2c5bc8['get'](_0x321ef3['id'])||[]};});}async[_0xfd5929(0x136)](_0x3761a3){const _0x4830a6=_0xfd5929;if(!_0x3761a3[_0x4830a6(0x107)])return[];return this['aiAssetsEntity'][_0x4830a6(0x155)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x3761a3)}});}async[_0xfd5929(0x16e)](_0x2eb31b,_0x4d02a9){const _0x36b689=_0xfd5929;try{const _0x5551cf={'isDelete':![],'role':_0x36b689(0x19d),'userId':_0x2eb31b[_0x36b689(0x17d)]['id'],'modelType':_0x4d02a9['modelType']};_0x4d02a9[_0x36b689(0x1ae)]?_0x5551cf['modelSubType']=_0x4d02a9[_0x36b689(0x1ae)]:_0x4d02a9['modelType']===model_constant_1[_0x36b689(0x15a)]['MUSIC']&&(_0x5551cf[_0x36b689(0x1ae)]='create');const [_0x159874,_0x51f476]=await this[_0x36b689(0x143)]['findAndCount']({'where':_0x5551cf,'take':_0x4d02a9['size'],'skip':(_0x4d02a9[_0x36b689(0x1dc)]-0x1)*_0x4d02a9['size'],'order':{'createdAt':_0x36b689(0x199)}}),_0x14b4f0=_0x159874['map'](_0x5afebf=>_0x5afebf['id']),_0xbef72f=await this['getMusicVoMap'](_0x2eb31b['user']['id'],_0x14b4f0,_0x4d02a9[_0x36b689(0x13d)]),_0x6cd3a1=_0x159874['map'](_0x554d09=>{const _0x3ddf00=_0x36b689;return{..._0x554d09,'children':_0xbef72f[_0x3ddf00(0x116)](_0x554d09['id'])||[]};});return{'count':_0x51f476,'records':_0x6cd3a1};}catch(_0x2ce39d){throw new common_1[(_0x36b689(0x17c))](_0x2ce39d['message'],common_1[_0x36b689(0x1a8)][_0x36b689(0x1e0)]);}}async['assetsDel'](_0x8b23cf,_0x4fe7ed){const _0x498d36=_0xfd5929;if(!_0x4fe7ed['ids']['length'])return!![];return await this[_0x498d36(0x19b)][_0x498d36(0x1b8)]({'userId':_0x8b23cf[_0x498d36(0x17d)]['id'],'id':(0x0,typeorm_2['In'])(_0x4fe7ed['ids'])},{'deleteFlag':0x1}),!![];}async[_0xfd5929(0x15c)](_0xdeb252,_0x47a181){const _0x3af188=_0xfd5929;if(!_0x47a181['ids'])return!![];return await this[_0x3af188(0x186)][_0x3af188(0x177)]('\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20'+_0xdeb252[_0x3af188(0x17d)]['id']+_0x3af188(0x1a9)+_0x47a181[_0x3af188(0x146)][_0x3af188(0x1b1)]()+_0x3af188(0x12c)),!![];}async[_0xfd5929(0x1cd)](_0x1a8d1d,_0x35b327){const _0x3ccb70=_0xfd5929,_0xd65d08=(0x0,utils_1[_0x3ccb70(0x176)])(this[_0x3ccb70(0x170)]);try{const {page:page=0x1,size:size=0x14,order:_0x3d2b39,keyword:_0x35b11d,modelType:_0x4b46e0,modelSubType:_0x3e686c}=_0x35b327;let _0x523f58=_0x3ccb70(0x19a);if(_0x3d2b39===_0x3ccb70(0x1dd))_0x523f58=_0x3ccb70(0x1a1);else _0x3d2b39==='agreeNum'&&(_0x523f58=_0x3ccb70(0x17a));const _0x1435bc=await this[_0x3ccb70(0x186)][_0x3ccb70(0x177)](_0x3ccb70(0x11d)+_0x4b46e0+'\x27\x20\x20'+(_0x3e686c?'and\x20cl.modelSubType=\x27'+_0x3e686c+'\x27':'')+_0x3ccb70(0x1c9)+(_0x35b11d?_0x3ccb70(0xf3)+_0x35b11d+_0x3ccb70(0x16a):'')+_0x3ccb70(0x101)),_0x2d1471=await this[_0x3ccb70(0x186)][_0x3ccb70(0x177)](_0x3ccb70(0x127)+_0x4b46e0+_0x3ccb70(0x15f)+(_0x3e686c?_0x3ccb70(0x1c0)+_0x3e686c+'\x27':'')+_0x3ccb70(0x149)+_0x4b46e0+_0x3ccb70(0x132)+(_0x35b11d?_0x3ccb70(0xf3)+_0x35b11d+_0x3ccb70(0x16a):'')+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x523f58+_0x3ccb70(0x10f)+size+_0x3ccb70(0x1a7)+(page-0x1)*size+_0x3ccb70(0x101)),_0x33a25c=_0x2d1471['map'](_0x33bf61=>_0x33bf61['id']),_0x24183d=await this['aiLogService'][_0x3ccb70(0x115)](_0xd65d08,_0x33a25c,_0x4b46e0);return _0x2d1471['forEach'](_0x255d9b=>{const _0x294479=_0x3ccb70;_0x255d9b[_0x294479(0x1c5)]=_0x24183d['get'](_0x255d9b['id'])||null;}),{'records':_0x2d1471,'count':Number(_0x1435bc[0x0]?.['count']||0x0)};}catch(_0x2ff08c){throw new common_1[(_0x3ccb70(0x17c))](_0x2ff08c[_0x3ccb70(0x124)],common_1['HttpStatus'][_0x3ccb70(0x1e0)]);}}async[_0xfd5929(0x1d4)](_0x302b47,_0x18edb2){const _0x594cb1=_0xfd5929,{id:_0x9686cb}=_0x302b47[_0x594cb1(0x17d)],{groupId:_0x422a1f}=_0x18edb2,_0x1aa357={'userId':_0x9686cb,'isDelete':![]};_0x422a1f&&Object[_0x594cb1(0x1ad)](_0x1aa357,{'groupId':_0x422a1f});const _0x485ce5=await this[_0x594cb1(0x143)][_0x594cb1(0x155)]({'where':_0x1aa357});return _0x485ce5['map'](_0x32175c=>{const _0xb99a60=_0x594cb1,{prompt:_0x4c84a4,role:_0x16dc1d,answer:_0x201e20,createdAt:_0xa24f58,model:_0x45b5bf,conversationOptions:_0x48e3bb,requestOptions:_0x22bff7,id:_0x2c8a20}=_0x32175c;return{'chatId':_0x2c8a20,'dateTime':(0x0,utils_1[_0xb99a60(0x17e)])(_0xa24f58),'text':_0x16dc1d===_0xb99a60(0x17d)?_0x4c84a4:_0x201e20,'inversion':_0x16dc1d===_0xb99a60(0x17d),'error':![],'conversationOptions':_0x48e3bb?JSON[_0xb99a60(0xfd)](_0x48e3bb):null,'requestOptions':_0x22bff7?JSON[_0xb99a60(0xfd)](_0x22bff7):null};});}async[_0xfd5929(0x181)](_0xead6d9,_0x45dda6){const _0x4ee7fc=_0xfd5929,{id:_0x24aae6}=_0xead6d9[_0x4ee7fc(0x17d)],{id:_0x1479c5}=_0x45dda6,_0x491649=await this[_0x4ee7fc(0x143)][_0x4ee7fc(0x11f)]({'where':{'id':_0x1479c5,'userId':_0x24aae6}});if(!_0x491649)throw new common_1[(_0x4ee7fc(0x17c))](_0x4ee7fc(0xfb),common_1['HttpStatus'][_0x4ee7fc(0x1e0)]);const _0x247134=await this[_0x4ee7fc(0x143)]['update']({'id':_0x1479c5},{'isDelete':!![]});await this[_0x4ee7fc(0x19b)][_0x4ee7fc(0x1b8)]({'userId':_0xead6d9['user']['id'],'chatLogId':_0x1479c5},{'deleteFlag':0x1});if(_0x247134['affected']>0x0)return _0x4ee7fc(0x194);else throw new common_1[(_0x4ee7fc(0x17c))]('你删除的对话记录不存在、请检查！',common_1['HttpStatus'][_0x4ee7fc(0x1e0)]);}async[_0xfd5929(0x1b3)](_0x5c36a1,_0x3d2232){const _0x30d095=_0xfd5929,{groupId:_0x3fb627,type:_0x3caf24}=_0x3d2232,{id:_0x4c31ed}=_0x5c36a1[_0x30d095(0x17d)],_0x3cda4a=_0x3caf24&&_0x3caf24===_0x30d095(0x1cf)?{'groupId':_0x3fb627,'userId':_0x4c31ed}:{'groupId':_0x3fb627,'userId':_0x4c31ed},_0x644e5=await this[_0x30d095(0x143)][_0x30d095(0x147)](_0x3cda4a);if(_0x644e5[_0x30d095(0x104)]>0x0)return!![];if(_0x644e5[_0x30d095(0x104)]===0x0)throw new common_1['HttpException']('当前页面已经没有东西可以删除了！',common_1[_0x30d095(0x1a8)][_0x30d095(0x1e0)]);}async[_0xfd5929(0x103)](_0x3094e2){const _0x4dbaa9=_0xfd5929,{ids:_0x2cebfb,userId:_0x67d52}=_0x3094e2;return await this[_0x4dbaa9(0x143)][_0x4dbaa9(0x147)]({'groupId':(0x0,typeorm_2['In'])(_0x2cebfb),'userId':_0x67d52});}async[_0xfd5929(0x152)](_0x508c0e,_0x27a6ca){const _0x2c09ec=_0xfd5929,{id:_0x110acc}=_0x508c0e['user'],{appId:_0x4ff73c,page:page=0x1,size:size=0xa}=_0x27a6ca,[_0x2b0949,_0x2f7326]=await this[_0x2c09ec(0x143)][_0x2c09ec(0x1ba)]({'where':{'userId':_0x110acc,'appId':_0x4ff73c,'role':_0x2c09ec(0x19d)},'order':{'id':_0x2c09ec(0x199)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x2b0949,'count':_0x2f7326};}async['byId'](_0x4ebfc5,_0x258717){const _0x298d59=_0xfd5929,_0xcf64e3=_0x4ebfc5['user']['id'],_0x5b20f0=await this[_0x298d59(0x143)]['findOne']({'where':{'userId':_0xcf64e3,'id':_0x258717}});if(!_0x5b20f0)return'';return{'chatId':_0x5b20f0['id'],'dateTime':(0x0,utils_1['formatDate'])(_0x5b20f0['createdAt']),'text':_0x5b20f0[_0x298d59(0x123)]==='user'?_0x5b20f0[_0x298d59(0x1c3)]:_0x5b20f0[_0x298d59(0x148)],'textMp3':_0x5b20f0['answerMp3'],'inversion':_0x5b20f0[_0x298d59(0x123)]===_0x298d59(0x17d)};}async[_0xfd5929(0x1a3)](_0x20c2b0,_0x309451){const _0x29671b=_0xfd5929,_0x164a69=_0x20c2b0[_0x29671b(0x17d)]['id'],_0x439838=await this['chatLogEntity'][_0x29671b(0x11f)]({'where':{'userId':_0x164a69,'id':_0x309451}});if(!_0x439838)return'';return _0x439838[_0x29671b(0x148)];}async[_0xfd5929(0x145)](){const _0x3fa7fa=_0xfd5929,_0x176ccf=await this[_0x3fa7fa(0x186)][_0x3fa7fa(0x177)](_0x3fa7fa(0xf7));return _0x176ccf;}async[_0xfd5929(0x109)](_0x58b5e9){const _0x39fd73=_0xfd5929,_0x57c0e4=await this[_0x39fd73(0x157)][_0x39fd73(0x16f)](_0x58b5e9[_0x39fd73(0x1bd)]);_0x57c0e4&&this[_0x39fd73(0x192)][_0x39fd73(0x178)](_0x58b5e9[_0x39fd73(0x10e)],_0x57c0e4,_0x58b5e9[_0x39fd73(0x1c8)],_0x58b5e9['id']);}async[_0xfd5929(0x153)](_0x534bc2){const _0x29a86c=_0xfd5929,_0x1ae68a=await this['aiAssetsEntity']['findOne']({'where':{'sunoMusicId':_0x534bc2['id']}});if(!_0x1ae68a)return;const _0x5c3989=await this[_0x29a86c(0x143)][_0x29a86c(0x11f)]({'where':{'id':_0x1ae68a['chatLogId']}});_0x5c3989[_0x29a86c(0x148)]=_0x534bc2['state'],_0x1ae68a[_0x29a86c(0x110)]=_0x534bc2[_0x29a86c(0x14a)]?.['url'],await this[_0x29a86c(0x143)][_0x29a86c(0x1af)](_0x5c3989),await this[_0x29a86c(0x19b)][_0x29a86c(0x1af)](_0x1ae68a);if(_0x5c3989['answer']==='completed'&&_0x1ae68a[_0x29a86c(0x110)])this[_0x29a86c(0x129)](_0x1ae68a);else _0x5c3989['answer']===_0x29a86c(0x113)&&this['refundVideo'](_0x5c3989);}async[_0xfd5929(0x1db)](_0x2fef20){const _0x2e8b7d=_0xfd5929;console[_0x2e8b7d(0x175)](_0x2e8b7d(0x162),_0x2fef20);const _0x2b5c41=await this[_0x2e8b7d(0x19b)][_0x2e8b7d(0x11f)]({'where':{'sunoMusicId':_0x2fef20['task_id']}});if(!_0x2b5c41)throw new Error(_0x2e8b7d(0x118));const _0x94e6bb=await this[_0x2e8b7d(0x143)][_0x2e8b7d(0x11f)]({'where':{'id':_0x2b5c41['chatLogId']}});_0x94e6bb['answer']=_0x2fef20['state'],_0x2b5c41[_0x2e8b7d(0x110)]=_0x2fef20[_0x2e8b7d(0x137)],await this['chatLogEntity'][_0x2e8b7d(0x1af)](_0x94e6bb),await this[_0x2e8b7d(0x19b)][_0x2e8b7d(0x1af)](_0x2b5c41);if(_0x2fef20[_0x2e8b7d(0x1b4)]==='3'&&_0x2b5c41[_0x2e8b7d(0x110)])this[_0x2e8b7d(0x129)](_0x2b5c41);else _0x94e6bb[_0x2e8b7d(0x148)]===_0x2e8b7d(0x144)&&this[_0x2e8b7d(0x109)](_0x94e6bb);}async[_0xfd5929(0x188)](_0x3af400){const _0x5ce295=_0xfd5929;console[_0x5ce295(0x175)](_0x5ce295(0x18c),_0x3af400);const _0x4126fb=_0x3af400[_0x5ce295(0x10a)],_0x11e93b=await this[_0x5ce295(0x19b)][_0x5ce295(0x11f)]({'where':{'sunoMusicId':_0x4126fb['task_id']}});if(!_0x11e93b)throw new Error(_0x5ce295(0x118));const _0x14c061=await this[_0x5ce295(0x143)][_0x5ce295(0x11f)]({'where':{'id':_0x11e93b[_0x5ce295(0x1d6)]}});_0x14c061['answer']=_0x4126fb[_0x5ce295(0x190)];_0x4126fb[_0x5ce295(0x1b5)][_0x5ce295(0x161)]&&(_0x11e93b[_0x5ce295(0x110)]=_0x4126fb['task_result'][_0x5ce295(0x161)][0x0]?.['url']);await this[_0x5ce295(0x143)]['save'](_0x14c061),await this['aiAssetsEntity'][_0x5ce295(0x1af)](_0x11e93b);if(_0x14c061[_0x5ce295(0x148)]==='succeed'&&_0x11e93b[_0x5ce295(0x110)])this[_0x5ce295(0x129)](_0x11e93b);else _0x14c061[_0x5ce295(0x148)]==='failed'&&this[_0x5ce295(0x109)](_0x14c061);}async['videoNotifySuno'](_0x7295bb,_0x376272){const _0x38de7c=_0xfd5929;console[_0x38de7c(0x175)]('suno通知：',_0x7295bb);let _0x386ed4;_0x376272===_0x38de7c(0x167)?(_0x386ed4=await this[_0x38de7c(0x143)]['findOne']({'where':{'id':Number(_0x7295bb[_0x38de7c(0x1d0)])}}),_0x386ed4['answer']=_0x7295bb[_0x38de7c(0x18e)]||_0x7295bb[_0x38de7c(0x10a)][_0x38de7c(0x18e)]):(_0x386ed4=await this[_0x38de7c(0x143)][_0x38de7c(0x11f)]({'where':{'message_id':_0x7295bb[_0x38de7c(0x1d0)]}}),_0x386ed4[_0x38de7c(0x148)]=_0x7295bb[_0x38de7c(0x1b4)]);await this[_0x38de7c(0x143)][_0x38de7c(0x1af)](_0x386ed4);if(_0x376272==='create'){const _0x11e794=await this[_0x38de7c(0x19b)][_0x38de7c(0x155)]({'where':{'chatLogId':_0x386ed4['id']}});for(const _0x2086c of _0x7295bb[_0x38de7c(0x10a)]){const {title:_0x39e1f0,prompt:_0x470bef,audio_url:_0x4d5389,image_url:_0x123a56,task_id:_0x42621f,id:_0x2d5843,video_url:_0x2e826e}=_0x2086c,_0x464292=_0x42621f?_0x11e794[_0x38de7c(0x155)](_0x1ae6a3=>_0x1ae6a3[_0x38de7c(0x1b6)]===_0x42621f):_0x11e794[_0x38de7c(0x155)](_0x3c4c31=>_0x3c4c31[_0x38de7c(0x1b6)]===_0x2d5843);!_0x464292?await this['aiAssetsEntity'][_0x38de7c(0x1af)]({'title':_0x39e1f0,'intro':_0x470bef||_0x2086c[_0x38de7c(0x193)][_0x38de7c(0x1c3)],'mp3':_0x4d5389||'','mp4':_0x2e826e||'','cover':_0x123a56||'','sunoMusicId':_0x42621f||_0x2d5843,'chatLogId':_0x386ed4['id'],'userId':_0x386ed4[_0x38de7c(0x10e)]}):(_0x464292[_0x38de7c(0x13b)]=_0x39e1f0,_0x464292[_0x38de7c(0x102)]=_0x470bef||_0x2086c[_0x38de7c(0x193)][_0x38de7c(0x1c3)],_0x464292[_0x38de7c(0x12b)]=_0x4d5389||'',_0x464292[_0x38de7c(0x110)]=_0x2e826e||'',_0x464292['cover']=_0x123a56||'',await this['aiAssetsEntity'][_0x38de7c(0x1af)](_0x464292));}}}async[_0xfd5929(0x129)](_0x58b88a){const _0x662207=_0xfd5929,[_0x227b21,_0x1b580c]=await this['fileService'][_0x662207(0x180)](_0x58b88a['mp4']);_0x58b88a[_0x662207(0x110)]=_0x227b21,_0x58b88a[_0x662207(0x16d)]=_0x1b580c,await this[_0x662207(0x19b)][_0x662207(0x1af)](_0x58b88a);}async['syncAssets'](){const _0x87967=_0xfd5929,_0x1134ab=await this[_0x87967(0x19b)][_0x87967(0x155)]({'where':[{'cover':(0x0,typeorm_2[_0x87967(0x185)])('%filesystem.site%')},{'mp3':(0x0,typeorm_2['Like'])(_0x87967(0x135))},{'mp4':(0x0,typeorm_2[_0x87967(0x185)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x87967(0x185)])(_0x87967(0x150))}]});for(let _0x2ab37c=0x0;_0x2ab37c<_0x1134ab[_0x87967(0x107)];_0x2ab37c++){const _0x34c5e6=_0x1134ab[_0x2ab37c],_0x71f46e=redisKey_constant_1['MUSIC_TRANSFER']+_0x34c5e6['id'];try{const _0x540d05=await this[_0x87967(0x1d3)]['get']({'key':_0x71f46e});if(_0x540d05)continue;await this[_0x87967(0x1d3)]['set']({'key':_0x71f46e,'val':_0x87967(0xfa)});const {cover:_0xba54f5,mp3:_0x284944,mp4:_0x25e660}=_0x34c5e6;/filesystem.site/['test'](_0xba54f5)&&(_0x34c5e6[_0x87967(0x16d)]=await this[_0x87967(0x106)][_0x87967(0x165)](_0xba54f5));/filesystem.site/['test'](_0x284944)&&(_0x34c5e6[_0x87967(0x12b)]=await this[_0x87967(0x106)][_0x87967(0x165)](_0x284944));if(/filesystem.site|storage.cdn-luma.com/['test'](_0x25e660)){if(_0xba54f5)_0x34c5e6['mp4']=await this['fileService'][_0x87967(0x165)](_0x25e660);else{const [_0xf0fa04,_0x483be4]=await this[_0x87967(0x106)][_0x87967(0x180)](_0x25e660);_0x34c5e6[_0x87967(0x110)]=_0xf0fa04,_0x34c5e6[_0x87967(0x16d)]=_0x483be4;}}await this['aiAssetsEntity'][_0x87967(0x1af)](_0x34c5e6);}catch(_0x50d534){common_1[_0x87967(0x1cb)][_0x87967(0x158)](_0x50d534);}finally{await this['redisCacheService'][_0x87967(0x142)]({'key':_0x71f46e});}}}async[_0xfd5929(0x130)](_0x4cc379,_0x52b0e5){const _0x3b52e4=_0xfd5929,_0x41dfa7=await this[_0x3b52e4(0x143)][_0x3b52e4(0x177)](_0x3b52e4(0x11e)+_0x4cc379+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20'+_0x52b0e5['join']()+_0x3b52e4(0xf8));return _0x41dfa7;}async[_0xfd5929(0x16b)](){const _0x3ae690=_0xfd5929,_0x4e0de0=await this['modelsService']['getModelByType'](model_constant_1['EModelType'][_0x3ae690(0x1b0)]);try{const _0x372d45=store_1['MusicConfig']['musicTimeoutMs']||0x5,_0x47f781=await this[_0x3ae690(0x143)]['find']({'where':{'role':'assistant','modelType':model_constant_1[_0x3ae690(0x15a)][_0x3ae690(0x1b0)],'answer':(0x0,typeorm_2['In'])(['IN_PROGRESS','']),'updatedAt':(0x0,typeorm_2[_0x3ae690(0x126)])(new Date(Date[_0x3ae690(0x182)]()-_0x372d45*0x3c*0x3e8))}});_0x47f781[_0x3ae690(0x1d2)](async _0x44d1da=>{const _0xa36550=_0x3ae690;_0x44d1da[_0xa36550(0x148)]=_0xa36550(0x1ab),_0x44d1da[_0xa36550(0x19f)]='timeout',this[_0xa36550(0x143)]['save'](_0x44d1da),await this[_0xa36550(0x19b)][_0xa36550(0x1b8)]({'chatLogId':_0x44d1da['id']},{'deleteFlag':0x1}),this['userService'][_0xa36550(0x12a)](_0x44d1da[_0xa36550(0x10e)],_0x44d1da['id'],_0x44d1da[_0xa36550(0x1ae)],!![]);});}catch(_0x204846){common_1['Logger'][_0x3ae690(0x158)](_0x204846);}}};ChatLogService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1[_0xfd5929(0x1a0)])(aiAssets_entity_1['AiAssetsEntity'])),__metadata(_0xfd5929(0x1a5),[typeorm_2['Repository'],typeorm_2[_0xfd5929(0x1ce)],nestjs_cls_1['ClsService'],file_service_1[_0xfd5929(0x195)],aiLog_service_1[_0xfd5929(0x112)],redisCache_service_1['RedisCacheService'],user_service_1[_0xfd5929(0x1a6)],models_service_1[_0xfd5929(0x1d5)],typeorm_2[_0xfd5929(0x1d1)]])],ChatLogService),exports[_0xfd5929(0x12d)]=ChatLogService;function _0x3000(){const _0x31fa9c=['delete','answer','\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','video','4MLWaqG','?imageView2/1/w/','__metadata','replace','解析错误','%storage.cdn-luma.com%','35PFVMoM','byAppId','videoNotify','@nestjs/common','find','../../common/constants/redisKey.constant','modelsService','error','：**','EModelType','189603pkRxLc','assetsPublish','335850LoHlir','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x27\x20\x20','saveChatLog','videos','runway通知：','**版本ID','cos','transferFile','delChatLog','lyrics','model','?x-oss-process=image/resize,w_','%\x27)','batchMusicResult','../../common/utils','cover','chatTaskLog','getModelById','clsService','recDrawImg','set','split','chatList','log','getUserId','query','refundBalance4Video','parseAndSaveMusic','ale.agree_num','aiLogService','HttpException','user','formatDate','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','transferAndCover','deleteChatLog','now','test','../file/file.service','Like','connection','156363zAXuCN','videoNotifyKLing','getExtByRelate','../../common/store','@nestjs/typeorm','kling通知：','visitNum','text','includes','task_status','isPlatform','userService','metadata','删除对话记录成功！','FileService','object','isGroup','nestjs-cls','DESC','aa.createdAt','aiAssetsEntity','__esModule','assistant','../user/user.service','errMsg','InjectRepository','ale.play_num','extend','byChatlogId','match','design:paramtypes','UserService','\x20OFFSET\x20','HttpStatus','\x20AND\x20id\x20IN\x20(','./entity/aiAssets.entity','timeout','你操作的图片不存在、请检查！','assign','modelSubType','save','MUSIC','join','1944710vvWDZf','delByGroupId','status','task_result','sunoMusicId','indexOf','update','parseAndSaveVideo','findAndCount','getMusicVoMap','push','modelId','agreeNum','../redisCache/redisCache.service','and\x20cl.modelSubType=\x27','getReqSaasId','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','prompt','type','agree','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','你推荐的图片不存在、请检查！','requestParams','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20','Logger','querAllDrawLog','assetsSquare','Repository','gpts','task_id','Connection','forEach','redisCacheService','chatGptsList','ModelsService','chatLogId','has','图片成功！','isSuper','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','videoNotifyRunway','page','playNum','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','BAD_REQUEST','AND\x20aa.title\x20LIKE\x20(\x27%','../models/models.service','maskEmail','count','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20','isDefined','lock','你删除的对话记录不存在、请检查！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','parse','319780zDRFIi','Not','class-validator','\x0a\x20\x20\x20\x20\x20\x20','intro','removeLogsBatch','affected','decorate','fileService','length','7929580wFOXPN','refundVideo','data','startsWith','phone','email','userId','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','mp4','```','AiLogService','FAILED','PAINT_TYPE','getAgreeMap','get','DeductionKey','资源不存在！','/q/55','**歌词：**','querDrawLog','substring','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','findOne','defineProperty','listByGroupId','tencent','role','message','---','LessThan','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','ali','syncVideo','debuctBalance4Muisc','mp3',')\x0a\x20\x20\x20\x20','ChatLogService','filter','thumbImg','getLastByUserAndAppIds','./entity/chatLog.entity','\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','__decorate','%filesystem.site%','listAssetsBychatLogIds','video_url','components','###🎵\x20歌曲名','paintCount','title','64sonsij','modelType','../aiLog/aiLog.service','1568901RoUXax','function','map','del','chatLogEntity','failed','listUndoneVideo','ids'];_0x3000=function(){return _0x31fa9c;};return _0x3000();}