'use strict';const _0x19e30d=_0x2acc;function _0x2acc(_0x1c745c,_0x251d53){const _0x3dd7fe=_0x3dd7();return _0x2acc=function(_0x2accbc,_0x4e49ac){_0x2accbc=_0x2accbc-0xbe;let _0x129692=_0x3dd7fe[_0x2accbc];return _0x129692;},_0x2acc(_0x1c745c,_0x251d53);}(function(_0x3c57a6,_0x5494e0){const _0x109316=_0x2acc,_0x3a3fa4=_0x3c57a6();while(!![]){try{const _0x3ecd63=parseInt(_0x109316(0xd2))/0x1+-parseInt(_0x109316(0x118))/0x2+-parseInt(_0x109316(0x107))/0x3+-parseInt(_0x109316(0x16d))/0x4+parseInt(_0x109316(0x14f))/0x5+parseInt(_0x109316(0x12e))/0x6+-parseInt(_0x109316(0xc2))/0x7*(-parseInt(_0x109316(0x13d))/0x8);if(_0x3ecd63===_0x5494e0)break;else _0x3a3fa4['push'](_0x3a3fa4['shift']());}catch(_0x20633e){_0x3a3fa4['push'](_0x3a3fa4['shift']());}}}(_0x3dd7,0xe99d7));var __decorate=this&&this[_0x19e30d(0x17c)]||function(_0x4e036d,_0x50bdc2,_0x514572,_0x243cb7){const _0x11d82a=_0x19e30d;var _0x1d2555=arguments['length'],_0xac2f11=_0x1d2555<0x3?_0x50bdc2:_0x243cb7===null?_0x243cb7=Object[_0x11d82a(0x198)](_0x50bdc2,_0x514572):_0x243cb7,_0x3b6f40;if(typeof Reflect==='object'&&typeof Reflect[_0x11d82a(0x194)]===_0x11d82a(0x159))_0xac2f11=Reflect[_0x11d82a(0x194)](_0x4e036d,_0x50bdc2,_0x514572,_0x243cb7);else{for(var _0x57ba20=_0x4e036d['length']-0x1;_0x57ba20>=0x0;_0x57ba20--)if(_0x3b6f40=_0x4e036d[_0x57ba20])_0xac2f11=(_0x1d2555<0x3?_0x3b6f40(_0xac2f11):_0x1d2555>0x3?_0x3b6f40(_0x50bdc2,_0x514572,_0xac2f11):_0x3b6f40(_0x50bdc2,_0x514572))||_0xac2f11;}return _0x1d2555>0x3&&_0xac2f11&&Object['defineProperty'](_0x50bdc2,_0x514572,_0xac2f11),_0xac2f11;},__metadata=this&&this[_0x19e30d(0xbf)]||function(_0x2d88bd,_0x4653f8){const _0x31d689=_0x19e30d;if(typeof Reflect===_0x31d689(0x152)&&typeof Reflect['metadata']===_0x31d689(0x159))return Reflect['metadata'](_0x2d88bd,_0x4653f8);},__param=this&&this[_0x19e30d(0x164)]||function(_0xdd23a0,_0x22db4b){return function(_0xaf079c,_0x1cff35){_0x22db4b(_0xaf079c,_0x1cff35,_0xdd23a0);};};function _0x3dd7(){const _0x351253=['listByGroupId','\x20OFFSET\x20','has','state','videoNotifyKLing','Logger','å›¾ç‰‡æˆåŠŸï¼','assetsDel','timeout','PAINT_TYPE',')\x0a\x20\x20\x20\x20','agree','log','substring','aiAssetsEntity','join','3655038hjqytc','getReqSaasId','ChatLogService','\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20user\x20ON\x20user.id\x20=\x20aa.user_id\x20\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','getModelById','ModelsService','typeorm','map','IN_PROGRESS','transferAndCover','ale.play_num','cos','musicTimeoutMs','chatLogEntity','\x0a\x20\x20\x20\x20\x20\x20','3297568oSwnJR','deleteChatLog','ï¼š**','now','includes','mp3','syncVideo','FAILED','InjectRepository','type','get','isGroup','playNum','connection','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20','../../common/constants/balance.constant','answer','find','6652390yxyVvi','Repository','catch','object','\x20AND\x20id\x20IN\x20(','transaction','listAssetsBychatLogIds','byAppId','MUSIC','phone','function','metadata','chatLogId','Not','refundVideo','../models/models.service','####','gpts','listUndoneVideo','byId','HttpStatus','__param','ä½ æ“ä½œçš„å›¾ç‰‡ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','succeed','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','@nestjs/typeorm','error','../../common/utils','../redisCache/redisCache.service','update','6313504YuUBQG','delChatLog','aa.createdAt','save','byChatlogId','query','chatTaskLog','fileService','cover','length','isSuper','set','formatDate','match','video','__decorate','getUserId','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','task_id','extend','klingé€šçŸ¥ï¼š','test','querAllDrawLog','errMsg','task_result','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','assign','removeLogsBatch','indexOf','../../common/constants/redisKey.constant','filter','getMusicVoMap','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','forEach','role','email','findAndCount','decorate','completed','../user/user.service','---','getOwnPropertyDescriptor','maskEmail','tencent','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','chatList','**æ­Œè¯ï¼š**','user','del','listByIds','visitNum','redisCacheService','isPlatform','LessThan','ali','text','%\x27)','modelSubType','ä½ åˆ é™¤çš„å¯¹è¯è®°å½•ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','getAgreeMap','\x20\x0a\x20\x20\x20\x20','ä½ æŽ¨èçš„å›¾ç‰‡ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼','ids','getModelByType','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','./entity/aiAssets.entity','runwayé€šçŸ¥ï¼š','aiLogService','__metadata','lyrics','delByGroupId','21ZOPXms','ChatLogEntity','isDelete\x20=\x200','recDrawImg','url','delete','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','modelsService','affected','AiLogService','message','###ðŸŽµ\x20æ­Œæ›²å','findOne','userId','lock','DeductionKey','1091703gppjNQ','components','startsWith','agreeNum','size','querAllChatLog','AND\x20aa.title\x20LIKE\x20(\x27%','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','sunoMusicId','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','failed','saveChatLog','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','HttpException','BAD_REQUEST','status','count','createdAt','EModelType','rec','intro','model','push','clsService','and\x20cl.modelSubType=\x27','thumbImg','prompt','getExtByRelate','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','userService','mp4','/q/55','nestjs-cls','RedisCacheService','../file/file.service','**ç‰ˆæœ¬ID','replace','batchMusicResult','Injectable','MUSIC_TRANSFER','parseAndSaveMusic','å–æ¶ˆæŽ¨è','Connection','split','parse','ale.agree_num','%filesystem.site%','Like','class-validator','è§£æžé”™è¯¯','%storage.cdn-luma.com%','?imageView2/1/w/','AiAssetsEntity','5045586JRcGlR','\x0a\x20\x20\x20\x20','querDrawLog','DESC','title','debuctBalance4Muisc','modelType','èµ„æºä¸å­˜åœ¨ï¼','transferFile','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','MusicConfig','data','../../common/store','./entity/chatLog.entity','UserService','videoNotifySuno','?x-oss-process=image/resize,w_','101634KLTQBr','assistant','éŸ³ä¹ç”Ÿæˆé”™è¯¯ï¼š','```','videos','\x27\x20\x20'];_0x3dd7=function(){return _0x351253;};return _0x3dd7();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x19e30d(0x130)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x19e30d(0x168)),chatLog_entity_1=require(_0x19e30d(0x114)),typeorm_2=require(_0x19e30d(0x134)),balance_constant_1=require(_0x19e30d(0x14c)),utils_1=require(_0x19e30d(0x16a)),file_service_1=require(_0x19e30d(0xf4)),redisCache_service_1=require(_0x19e30d(0x16b)),redisKey_constant_1=require(_0x19e30d(0x18c)),model_constant_1=require('../../common/constants/model.constant'),aiAssets_entity_1=require(_0x19e30d(0x1b1)),aiLog_service_1=require('../aiLog/aiLog.service'),nestjs_cls_1=require(_0x19e30d(0xf2)),class_validator_1=require(_0x19e30d(0x102)),user_service_1=require(_0x19e30d(0x196)),models_service_1=require(_0x19e30d(0x15e)),store_1=require(_0x19e30d(0x113));let ChatLogService=class ChatLogService{constructor(_0x4ef0d2,_0x468225,_0xd37341,_0x27849b,_0x5af710,_0x21bc10,_0x563bf2,_0xd0a3fa,_0x4ff6cf){const _0x16d7d1=_0x19e30d;this['chatLogEntity']=_0x4ef0d2,this[_0x16d7d1(0x12c)]=_0x468225,this[_0x16d7d1(0xe9)]=_0xd37341,this[_0x16d7d1(0x174)]=_0x27849b,this['aiLogService']=_0x5af710,this[_0x16d7d1(0x1a3)]=_0x21bc10,this[_0x16d7d1(0xef)]=_0x563bf2,this[_0x16d7d1(0xc9)]=_0xd0a3fa,this[_0x16d7d1(0x14a)]=_0x4ff6cf;}async[_0x19e30d(0xdd)](_0xeafed3){const _0x10da94=_0x19e30d;return await this[_0x10da94(0x13b)]['save'](_0xeafed3);}async[_0x19e30d(0xfa)](_0x7a8be){const _0x1b87ff=_0x19e30d,_0x3877ab=_0x7a8be[_0x1b87ff(0x14d)];let _0x23dfe4={},_0x43c37c={};if(_0x3877ab[_0x1b87ff(0x18b)]('Request\x20failed')!=-0x1)throw new Error(_0x1b87ff(0x11a)+_0x3877ab);else{let _0x40d07b='',_0x644fe0='',_0x54c279=_0x1b87ff(0x103),_0xf8c941=_0x1b87ff(0x103),_0x318f2d=_0x1b87ff(0x103),_0x579e53=_0x1b87ff(0x103),_0x19c508=_0x1b87ff(0x103),_0x159f78='è§£æžé”™è¯¯',_0x4fd75c=_0x1b87ff(0x103),_0x1f741c='è§£æžé”™è¯¯';if(_0x3877ab[_0x1b87ff(0xd4)](_0x1b87ff(0x15f))){const [_0x421cab]=_0x3877ab[_0x1b87ff(0x17a)](/>(\S+)\n/g);_0x40d07b=_0x644fe0=_0x421cab[_0x1b87ff(0x12b)](0x1,_0x421cab[_0x1b87ff(0x176)]-0x1),_0x54c279=_0x3877ab[_0x1b87ff(0xfd)]('\x0a')[0x0][_0x1b87ff(0x12b)](0x7),_0xf8c941=_0x3877ab[_0x1b87ff(0xfd)](_0x1b87ff(0x197))[0x1][_0x1b87ff(0xf6)](/\[.*\]|ï¼ˆ.*ï¼‰/g,'')[_0x1b87ff(0xf6)](/\n+/g,'\x0a');const _0x1bff62=_0x3877ab[_0x1b87ff(0x17a)](/!\[image\].*\)/g);_0x1bff62&&([_0x318f2d,_0x579e53]=_0x1bff62[_0x1b87ff(0x135)](_0x4cd6b8=>_0x4cd6b8[_0x1b87ff(0x12b)](0x9,_0x4cd6b8['length']-0x1)));const _0x5d7ed8=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp3/g);_0x5d7ed8&&([_0x19c508,_0x159f78]=_0x5d7ed8);const _0x26b0f5=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp4/g);_0x26b0f5&&([_0x4fd75c,_0x1f741c]=_0x26b0f5);}else{if(_0x3877ab[_0x1b87ff(0xd4)]('ðŸŽµ')){_0x54c279=_0x3877ab[_0x1b87ff(0xfd)]('\x0a')[0x0][_0x1b87ff(0xf6)](/ðŸŽµ/g,'');const _0x22a3c0=_0x3877ab[_0x1b87ff(0xfd)]('--')[_0x1b87ff(0x14e)](_0x133f0e=>/-\n\n\[/['test'](_0x133f0e));if(_0x22a3c0){const _0x426add=_0x22a3c0[_0x1b87ff(0xf6)](/\[.*\]|ï¼ˆ.*ï¼‰|-/g,'')[_0x1b87ff(0xf6)](/\n+/g,'\x0a');_0x426add[_0x1b87ff(0xd4)]('\x0a')?_0xf8c941=_0x426add['replace']('\x0a',''):_0xf8c941=_0x426add;}const _0x195b38=_0x3877ab['match'](/æ­Œæ›²id(.+)\n/ig);_0x195b38&&([_0x40d07b,_0x644fe0]=_0x195b38[_0x1b87ff(0x135)](_0x1e0132=>_0x1e0132[_0x1b87ff(0x12b)](0xc,_0x1e0132[_0x1b87ff(0x176)]-0x1)));const _0x24d049=_0x3877ab[_0x1b87ff(0x17a)](/\[å°é¢å›¾ç‰‡\].*\)/g);_0x24d049&&([_0x318f2d,_0x579e53]=_0x24d049[_0x1b87ff(0x135)](_0x3694a9=>_0x3694a9['substring'](0x7,_0x3694a9[_0x1b87ff(0x176)]-0x1)));const _0x2ca0a3=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp3/g);_0x2ca0a3&&([_0x19c508,_0x159f78]=_0x2ca0a3);const _0x14af1c=_0x3877ab['match'](/https:\/\/(.*)\.mp4/g);_0x14af1c&&([_0x4fd75c,_0x1f741c]=_0x14af1c);}else{if(_0x3877ab[_0x1b87ff(0x18b)]('ðŸ’„')!=-0x1){let _0x282122=_0x3877ab['split']('\x0a');_0x282122[_0x1b87ff(0x190)](_0x324b75=>{const _0x37df35=_0x1b87ff;_0x324b75[_0x37df35(0x18b)]('ðŸ”Ž')!=-0x1&&(_0x54c279=_0x324b75[_0x37df35(0xfd)]('ï¼š')[0x1]);});const _0x95b61d=_0x3877ab['split'](_0x1b87ff(0x11b))[0x1][_0x1b87ff(0xfd)]('\x0a');if(_0x95b61d){const _0x58acf1=_0x95b61d[_0x1b87ff(0x18d)](_0x2bc7fb=>_0x2bc7fb[_0x1b87ff(0x18b)]('[')==-0x1)[_0x1b87ff(0x12d)]('');_0x58acf1[_0x1b87ff(0xd4)]('\x0a')?_0xf8c941=_0x58acf1['replace']('\x0a',''):_0xf8c941=_0x58acf1;}const _0x2acf37=_0x3877ab[_0x1b87ff(0x17a)](/æ­Œæ›²id(.+)\n/ig);_0x2acf37&&([_0x40d07b,_0x644fe0]=_0x2acf37[_0x1b87ff(0x135)](_0x2c15d0=>_0x2c15d0[_0x1b87ff(0x12b)](0xa,_0x2c15d0['length']-0x1)));const _0x2c67c5=_0x3877ab[_0x1b87ff(0x17a)](/\[å°é¢å›¾ç‰‡\].*\)/g);_0x2c67c5&&([_0x318f2d,_0x579e53]=_0x2c67c5[_0x1b87ff(0x135)](_0x57d6b7=>_0x57d6b7[_0x1b87ff(0x12b)](0x7,_0x57d6b7[_0x1b87ff(0x176)]-0x1)));const _0x585f8a=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp3/g);_0x585f8a&&([_0x19c508,_0x159f78]=_0x585f8a);const _0xfb5bfa=_0x3877ab['match'](/https:\/\/(.*)\.mp4/g);_0xfb5bfa&&([_0x4fd75c,_0x1f741c]=_0xfb5bfa);}else{if(_0x3877ab['startsWith']('ðŸŽ')){_0x54c279=_0x3877ab[_0x1b87ff(0xfd)]('\x0a')[0x2][_0x1b87ff(0xfd)](_0x1b87ff(0x13f))[0x1];const _0x2d72cf=_0x3877ab[_0x1b87ff(0xfd)]('```')[0x1]['split']('\x0a');if(_0x2d72cf){const _0x3b9f0f=_0x2d72cf[_0x1b87ff(0x18d)](_0x1df50d=>_0x1df50d[_0x1b87ff(0x18b)]('[')==-0x1)['join']('');_0x3b9f0f['startsWith']('\x0a')?_0xf8c941=_0x3b9f0f[_0x1b87ff(0xf6)]('\x0a',''):_0xf8c941=_0x3b9f0f;}const _0x5deaba=_0x3877ab[_0x1b87ff(0x17a)](/æ­Œæ›²IDï¼š(.+)\n/ig);_0x5deaba&&([_0x40d07b,_0x644fe0]=_0x5deaba[_0x1b87ff(0x135)](_0xacb099=>_0xacb099[_0x1b87ff(0x12b)](0x8,_0xacb099[_0x1b87ff(0x176)]-0x1)));const _0x1fe59c=_0x3877ab[_0x1b87ff(0x17a)](/\[å°é¢\].*\)/g);_0x1fe59c&&([_0x318f2d,_0x579e53]=_0x1fe59c[_0x1b87ff(0x135)](_0x1b5300=>_0x1b5300[_0x1b87ff(0x12b)](0x5,_0x1b5300[_0x1b87ff(0x176)]-0x1)));const _0x175179=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp3/g);_0x175179&&([_0x19c508,_0x159f78]=_0x175179);const _0x2cec13=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp4/g);_0x2cec13&&([_0x4fd75c,_0x1f741c]=_0x2cec13);}else{if(_0x3877ab[_0x1b87ff(0x18b)](_0x1b87ff(0xcd))!==-0x1){let _0x31a356=_0x3877ab[_0x1b87ff(0xfd)]('\x0a'),_0x2df0e9=![];const _0xb58498=[];for(let _0x15b037=0x0;_0x15b037<_0x31a356[_0x1b87ff(0x176)];_0x15b037++){const _0x365e26=_0x31a356[_0x15b037];_0x365e26[_0x1b87ff(0x18b)]('###ðŸŽµ\x20æ­Œæ›²å')!==-0x1&&(_0x54c279=_0x365e26[_0x1b87ff(0xfd)]('ï¼š\x20')[0x1]);if(_0x365e26[_0x1b87ff(0x141)](_0x1b87ff(0xf5)))_0x2df0e9=![];else{if(_0x2df0e9&&!_0x365e26['startsWith']('['))_0xb58498[_0x1b87ff(0xe8)](_0x365e26);else _0x365e26[_0x1b87ff(0x141)](_0x1b87ff(0x19e))&&(_0x2df0e9=!![]);}}_0xf8c941=_0xb58498[_0x1b87ff(0x12d)]('\x20');const _0x40b4b6=_0x3877ab['match'](/ç‰ˆæœ¬IDï¼š(.+)\n/ig);_0x40b4b6&&([_0x40d07b,_0x644fe0]=_0x40b4b6['map'](_0x4cbe65=>_0x4cbe65['substring'](0xa,_0x4cbe65[_0x1b87ff(0x176)]-0x1)));const _0x560105=_0x3877ab[_0x1b87ff(0x17a)](/\[å°é¢\].*\)/g);_0x560105&&([_0x318f2d,_0x579e53]=_0x560105[_0x1b87ff(0x135)](_0x4ef77d=>_0x4ef77d['substring'](0x5,_0x4ef77d[_0x1b87ff(0x176)]-0x1)));const _0x45eb34=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp3/g);_0x45eb34&&([_0x19c508,_0x159f78]=_0x45eb34);const _0xfcc19=_0x3877ab[_0x1b87ff(0x17a)](/https:\/\/(.*)\.mp4/g);_0xfcc19&&([_0x4fd75c,_0x1f741c]=_0xfcc19);}else throw new Error(_0x1b87ff(0x103));}}}}_0x23dfe4={'title':_0x54c279,'intro':_0xf8c941,'mp3':_0x19c508,'mp4':_0x4fd75c,'cover':_0x318f2d,'sunoMusicId':_0x40d07b,'chatLogId':_0x7a8be['id'],'userId':_0x7a8be[_0x1b87ff(0xcf)]},_0x43c37c={'title':_0x54c279,'intro':_0xf8c941,'mp3':_0x159f78,'mp4':_0x1f741c,'cover':_0x579e53,'sunoMusicId':_0x644fe0,'chatLogId':_0x7a8be['id'],'userId':_0x7a8be[_0x1b87ff(0xcf)]};}await this[_0x1b87ff(0x14a)][_0x1b87ff(0x154)](async()=>{const _0x516c08=_0x1b87ff;await this[_0x516c08(0x12c)][_0x516c08(0x170)](_0x23dfe4),await this[_0x516c08(0x12c)]['save'](_0x43c37c);});}async['parseAndSaveVideo'](_0x23b43c,{id:_0x3fb9c1,videoUrl:_0x4dfb6c,state:_0x458d70,completed:_0xd55e6a}){const _0x3eba03=_0x19e30d;let _0x4da562={'mp4':_0x4dfb6c,'sunoMusicId':_0x3fb9c1,'chatLogId':_0x23b43c['id'],'userId':_0x23b43c[_0x3eba03(0xcf)]};if(_0x3fb9c1){const _0x44c535=await this[_0x3eba03(0x12c)]['findOne']({'where':{'sunoMusicId':_0x3fb9c1}});_0x44c535&&(_0x4da562=Object[_0x3eba03(0x189)](_0x44c535,_0x4da562));}console[_0x3eba03(0x12a)]('=======================ä¿å­˜è§†é¢‘å…¥åº“====================',_0x4da562),_0x4da562=await this['aiAssetsEntity'][_0x3eba03(0x170)](_0x4da562),_0x23b43c['answer']=_0x458d70,this[_0x3eba03(0x13b)][_0x3eba03(0x170)](_0x23b43c),_0xd55e6a&&_0x4da562['mp4']&&this[_0x3eba03(0x143)](_0x4da562);}async[_0x19e30d(0x109)](_0x5ad214,_0x31aeb6){const _0x3f3126=_0x19e30d,{id:_0x17b768}=_0x5ad214[_0x3f3126(0x19f)],{model:_0x2250cc}=_0x31aeb6,_0x50e492={'userId':_0x17b768,'type':balance_constant_1[_0x3f3126(0xd1)][_0x3f3126(0x127)]};_0x2250cc&&(_0x50e492[_0x3f3126(0xe7)]=_0x2250cc);const _0x1d66bb=await this[_0x3f3126(0x13b)]['find']({'where':_0x50e492,'order':{'id':_0x3f3126(0x10a)}});return _0x1d66bb[_0x3f3126(0x190)](_0x31697e=>{const _0x33bdab=_0x3f3126;if(_0x31697e['type']==='paintCount'){const _0x78ec77=_0x31697e[_0x33bdab(0xe7)]==='mj'?0x136:0xa0,_0x10f8eb=_0x31697e[_0x33bdab(0x14d)][_0x33bdab(0x141)](_0x33bdab(0x139))?_0x33bdab(0x19a):_0x33bdab(0x1a6),_0x2b1894=_0x10f8eb===_0x33bdab(0x19a)?_0x33bdab(0x105)+_0x78ec77+_0x33bdab(0xf1):_0x33bdab(0x117)+_0x78ec77;_0x31697e[_0x33bdab(0xeb)]=_0x31697e[_0x33bdab(0x14d)]+_0x2b1894;const _0x4f5e37=_0x31697e[_0x33bdab(0x181)]?JSON[_0x33bdab(0xfe)](_0x31697e[_0x33bdab(0x181)]):null;_0x4f5e37&&(_0x4f5e37?_0x31697e[_0x33bdab(0x148)]=_0x4f5e37?.['components'][0x0]?.['components']['length']===0x5:_0x31697e[_0x33bdab(0x148)]=![]);}}),_0x1d66bb;}async[_0x19e30d(0x184)](_0x152660){const _0x541e42=_0x19e30d,{page:page=0x1,size:size=0x14,rec:_0x1b1e8b,userId:_0x2e1161,model:_0x57d42b}=_0x152660,_0x5ad0be={'type':balance_constant_1['DeductionKey'][_0x541e42(0x127)],'prompt':(0x0,typeorm_2[_0x541e42(0x15c)])(''),'answer':(0x0,typeorm_2['Not'])('')};_0x1b1e8b&&Object['assign'](_0x5ad0be,{'rec':_0x1b1e8b}),_0x2e1161&&Object[_0x541e42(0x189)](_0x5ad0be,{'userId':_0x2e1161}),_0x57d42b&&Object[_0x541e42(0x189)](_0x5ad0be,{'model':_0x57d42b});const [_0x5e9983,_0x254275]=await this['chatLogEntity'][_0x541e42(0x193)]({'order':{'id':_0x541e42(0x10a)},'skip':(page-0x1)*size,'take':size,'where':_0x5ad0be});return _0x5e9983[_0x541e42(0x190)](_0x2ed22b=>{const _0x2db47f=_0x541e42;if(_0x2ed22b[_0x2db47f(0x146)]==='paintCount'){const _0x2bbeb6=_0x2ed22b[_0x2db47f(0xe7)]==='mj'?0x136:0xa0,_0x13bf6b=_0x2ed22b[_0x2db47f(0x14d)][_0x2db47f(0x141)](_0x2db47f(0x139))?'tencent':_0x2db47f(0x1a6),_0xc777e0=_0x13bf6b===_0x2db47f(0x19a)?_0x2db47f(0x105)+_0x2bbeb6+_0x2db47f(0xf1):_0x2db47f(0x117)+_0x2bbeb6;_0x2ed22b[_0x2db47f(0xeb)]=_0x2ed22b[_0x2db47f(0x14d)]+_0xc777e0;const _0x5f368e=_0x2ed22b[_0x2db47f(0x181)]?JSON[_0x2db47f(0xfe)](_0x2ed22b[_0x2db47f(0x181)]):null;_0x5f368e&&(_0x5f368e?_0x2ed22b[_0x2db47f(0x148)]=_0x5f368e?.[_0x2db47f(0xd3)][0x0]?.[_0x2db47f(0xd3)][_0x2db47f(0x176)]===0x5:_0x2ed22b['isGroup']=![]);}}),{'rows':_0x5e9983,'count':_0x254275};}async[_0x19e30d(0xc5)](_0x33cd95){const _0x2e7bf5=_0x19e30d,{id:_0x113574}=_0x33cd95,_0x29d3f9=await this[_0x2e7bf5(0x13b)][_0x2e7bf5(0xce)]({'where':{'id':_0x113574,'type':balance_constant_1[_0x2e7bf5(0xd1)][_0x2e7bf5(0x127)]}});if(!_0x29d3f9)throw new common_1[(_0x2e7bf5(0xdf))](_0x2e7bf5(0x1ad),common_1[_0x2e7bf5(0x163)]['BAD_REQUEST']);const _0x951e8b=_0x29d3f9[_0x2e7bf5(0xe5)]===0x1?0x0:0x1,_0x15c7a4=await this['chatLogEntity'][_0x2e7bf5(0x16c)]({'id':_0x113574},{'rec':_0x951e8b});if(_0x15c7a4[_0x2e7bf5(0xca)]>0x0)return(_0x951e8b?'æŽ¨è':_0x2e7bf5(0xfb))+_0x2e7bf5(0x124);throw new common_1[(_0x2e7bf5(0xdf))](_0x2e7bf5(0x165),common_1[_0x2e7bf5(0x163)]['BAD_REQUEST']);}async[_0x19e30d(0xd7)](_0x3af718,_0x4c46e0){const _0x326627=_0x19e30d,_0x47ce40=(0x0,utils_1[_0x326627(0x12f)])(this[_0x326627(0xe9)]),{page:page=0x1,size:size=0x14,userId:_0x4c78ea,keyword:_0xa1d481,prompt:_0x1a3c00,saasId:_0x491cdc,modelType:_0xec03eb}=_0x3af718;let _0x24cfea=_0x326627(0xc4);_0x4c78ea&&(_0x24cfea=_0x24cfea+(_0x326627(0x187)+_0x4c78ea));_0x1a3c00&&(_0x24cfea=_0x24cfea+(_0x326627(0x188)+_0x1a3c00+'%\x27'));_0xec03eb&&(_0x24cfea=_0x24cfea+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27'+_0xec03eb+'\x27'));(0x0,utils_1[_0x326627(0x1a4)])(this[_0x326627(0xe9)])?(0x0,class_validator_1['isDefined'])(_0x491cdc)&&(_0x24cfea=_0x24cfea+(_0x326627(0x1b0)+_0x491cdc)):_0x24cfea=_0x24cfea+('\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20'+_0x47ce40);_0xa1d481&&(_0x24cfea=_0x24cfea+(_0x326627(0xdb)+_0xa1d481+_0x326627(0xc8)+_0xa1d481+_0x326627(0xd9)+_0xa1d481+_0x326627(0xee)+_0xa1d481+'%\x27)'));const _0x11ec7f=await this[_0x326627(0x14a)]['query'](_0x326627(0xde)+_0x24cfea+_0x326627(0x1ac)),_0x3c3959=await this['connection'][_0x326627(0x172)](_0x326627(0x110)+_0x24cfea+_0x326627(0x19c)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x326627(0x108));return!(0x0,utils_1[_0x326627(0x177)])(this[_0x326627(0xe9)])&&_0x3c3959[_0x326627(0x190)](_0x594dd8=>{const _0x36daf9=_0x326627;_0x594dd8[_0x36daf9(0x192)]=(0x0,utils_1[_0x36daf9(0x199)])(_0x594dd8[_0x36daf9(0x192)]),_0x594dd8[_0x36daf9(0x158)]=(0x0,utils_1['maskEmail'])(_0x594dd8[_0x36daf9(0x158)]);}),{'rows':_0x3c3959,'count':Number(_0x11ec7f[0x0]?.['count']||0x0)};}async[_0x19e30d(0x16e)](_0x598a80){const _0xaf85a8=_0x19e30d;if(!_0x598a80[_0xaf85a8(0x1ae)][_0xaf85a8(0x176)])return!![];return await this[_0xaf85a8(0x13b)]['update']({'id':(0x0,typeorm_2['In'])(_0x598a80[_0xaf85a8(0x1ae)])},{'isDelete':!![]}),!![];}async[_0x19e30d(0x19d)](_0x20a1ee,_0x21e1d5){const _0x9aefef=_0x19e30d,{id:_0x50009a}=_0x20a1ee['user'],{groupId:_0x2c6773,logType:_0x2fda17,modelSubType:_0xf58dc}=_0x21e1d5,_0x3ad68f={'userId':_0x50009a,'isDelete':![]};_0x2c6773&&Object[_0x9aefef(0x189)](_0x3ad68f,{'groupId':_0x2c6773}),_0x2fda17&&Object['assign'](_0x3ad68f,{'logType':_0x2fda17}),_0xf58dc&&Object['assign'](_0x3ad68f,{'modelSubType':_0xf58dc});const _0x356813=await this['chatLogEntity']['find']({'where':_0x3ad68f})[_0x9aefef(0x151)](_0x310a3c=>{const _0x19e436=_0x9aefef;common_1[_0x19e436(0x123)][_0x19e436(0x169)](_0x310a3c);});if(!_0x356813||_0x356813['length']===0x0)return[];return _0x356813[_0x9aefef(0x135)](_0x1177da=>{const _0x22541f=_0x9aefef,{prompt:_0x5d97df,role:_0x4ed3fb,answer:_0x147b91,createdAt:_0x14ac8a,model:_0x43b5ba,conversationOptions:_0x258b33,requestOptions:_0x64fb31,id:_0x53b0b2,answerMp3:_0x5b20c4}=_0x1177da;return{'chatId':_0x53b0b2,'dateTime':(0x0,utils_1[_0x22541f(0x179)])(_0x14ac8a),'text':_0x4ed3fb==='user'?_0x5d97df:_0x147b91,'textMp3':_0x5b20c4,'inversion':_0x4ed3fb===_0x22541f(0x19f),'error':![],'conversationOptions':_0x258b33?JSON[_0x22541f(0xfe)](_0x258b33):null,'requestOptions':_0x64fb31?JSON[_0x22541f(0xfe)](_0x64fb31):null};});}async[_0x19e30d(0x11e)](_0x158af5){const _0x57ce0e=_0x19e30d;return this['chatLogEntity'][_0x57ce0e(0x14e)]({'where':{'groupId':_0x158af5,'isDelete':![]}});}async[_0x19e30d(0x18e)](_0x3e28d8,_0x1f96f3,_0x100b9c){const _0xbec848=_0x19e30d,_0x499f33=new Map();if(!_0x1f96f3[_0xbec848(0x176)])return _0x499f33;const _0x36db49=await this[_0xbec848(0x12c)]['find']({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x1f96f3),'deleteFlag':0x0}}),_0x102079=_0x36db49[_0xbec848(0x135)](_0x461eff=>_0x461eff['id']),_0x5e3571=await this[_0xbec848(0xbe)][_0xbec848(0x1ab)](_0x3e28d8,_0x102079,_0x100b9c),_0xd3e0aa=await this[_0xbec848(0xbe)][_0xbec848(0xed)](_0x102079,_0x100b9c);return _0x36db49[_0xbec848(0x190)](_0x2284d5=>{const _0x20faa5=_0xbec848;!_0x499f33[_0x20faa5(0x120)](_0x2284d5['chatLogId'])&&_0x499f33[_0x20faa5(0x178)](_0x2284d5[_0x20faa5(0x15b)],[]);const _0x4b5c69=_0xd3e0aa[_0x20faa5(0x147)](_0x2284d5['id']);_0x499f33[_0x20faa5(0x147)](_0x2284d5['chatLogId'])[_0x20faa5(0xe8)]({..._0x2284d5,'agree':_0x5e3571['get'](_0x2284d5['id'])||null,'playNum':_0x4b5c69?.[_0x20faa5(0x149)]||0x0,'visitNum':_0x4b5c69?.[_0x20faa5(0x1a2)]||0x0,'agreeNum':_0x4b5c69?.[_0x20faa5(0xd5)]||0x0});}),_0x499f33;}async[_0x19e30d(0x1a1)](_0x59a73a,_0x4dec63,_0x5f237a){const _0x4b5fdc=_0x19e30d;if(!_0x4dec63[_0x4b5fdc(0x176)])return[];const _0x39465c=await this[_0x4b5fdc(0x13b)][_0x4b5fdc(0x14e)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x4dec63)}});if(!_0x39465c['length'])return[];const _0x4c9278=await this[_0x4b5fdc(0x18e)](_0x59a73a[_0x4b5fdc(0x19f)]['id'],_0x4dec63,_0x5f237a);return _0x39465c[_0x4b5fdc(0x135)](_0x505490=>{const _0xfa885a=_0x4b5fdc;return{..._0x505490,'children':_0x4c9278[_0xfa885a(0x147)](_0x505490['id'])||[]};});}async[_0x19e30d(0x155)](_0x47eb3a){const _0x4cc5e5=_0x19e30d;if(!_0x47eb3a[_0x4cc5e5(0x176)])return[];return this['aiAssetsEntity'][_0x4cc5e5(0x14e)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x47eb3a)}});}async[_0x19e30d(0x173)](_0x347993,_0x572c58){const _0x4524e6=_0x19e30d;try{const _0x360337={'isDelete':![],'role':_0x4524e6(0x119),'userId':_0x347993[_0x4524e6(0x19f)]['id'],'modelType':_0x572c58[_0x4524e6(0x10d)]};_0x572c58['modelSubType']?_0x360337[_0x4524e6(0x1a9)]=_0x572c58[_0x4524e6(0x1a9)]:_0x572c58[_0x4524e6(0x10d)]===model_constant_1[_0x4524e6(0xe4)][_0x4524e6(0x157)]&&(_0x360337['modelSubType']='create');const [_0xf6d96b,_0x19482c]=await this[_0x4524e6(0x13b)]['findAndCount']({'where':_0x360337,'take':_0x572c58[_0x4524e6(0xd6)],'skip':(_0x572c58['page']-0x1)*_0x572c58['size'],'order':{'createdAt':_0x4524e6(0x10a)}}),_0x227af9=_0xf6d96b[_0x4524e6(0x135)](_0x226397=>_0x226397['id']),_0x5c8c9a=await this[_0x4524e6(0x18e)](_0x347993['user']['id'],_0x227af9,_0x572c58[_0x4524e6(0x10d)]),_0x33a0f2=_0xf6d96b['map'](_0x118b0a=>{const _0x37d013=_0x4524e6;return{..._0x118b0a,'children':_0x5c8c9a[_0x37d013(0x147)](_0x118b0a['id'])||[]};});return{'count':_0x19482c,'records':_0x33a0f2};}catch(_0x1dbf47){throw new common_1[(_0x4524e6(0xdf))](_0x1dbf47['message'],common_1[_0x4524e6(0x163)][_0x4524e6(0xe0)]);}}async[_0x19e30d(0x125)](_0x783d3a,_0x135f15){const _0x5347b1=_0x19e30d;if(!_0x135f15[_0x5347b1(0x1ae)][_0x5347b1(0x176)])return!![];return await this[_0x5347b1(0x12c)][_0x5347b1(0x16c)]({'userId':_0x783d3a[_0x5347b1(0x19f)]['id'],'id':(0x0,typeorm_2['In'])(_0x135f15['ids'])},{'deleteFlag':0x1}),!![];}async['assetsPublish'](_0x37999f,_0x5a1743){const _0x9a2f0c=_0x19e30d;if(!_0x5a1743[_0x9a2f0c(0x1ae)])return!![];return await this['connection'][_0x9a2f0c(0x172)]('\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20'+_0x37999f[_0x9a2f0c(0x19f)]['id']+_0x9a2f0c(0x153)+_0x5a1743[_0x9a2f0c(0x1ae)][_0x9a2f0c(0x12d)]()+_0x9a2f0c(0x128)),!![];}async['assetsSquare'](_0x5ad151,_0x5952ae){const _0x41b80f=_0x19e30d,_0x3b88dc=(0x0,utils_1[_0x41b80f(0x17d)])(this['clsService']);try{const {page:page=0x1,size:size=0x14,order:_0x5dfb4a,keyword:_0x2a9d19,modelType:_0x460204,modelSubType:_0x9c174d}=_0x5952ae;let _0x296393=_0x41b80f(0x16f);if(_0x5dfb4a===_0x41b80f(0x149))_0x296393=_0x41b80f(0x138);else _0x5dfb4a===_0x41b80f(0xd5)&&(_0x296393=_0x41b80f(0xff));const _0x150818=await this[_0x41b80f(0x14a)][_0x41b80f(0x172)](_0x41b80f(0x19b)+_0x460204+_0x41b80f(0x11d)+(_0x9c174d?'and\x20cl.modelSubType=\x27'+_0x9c174d+'\x27':'')+_0x41b80f(0x17f)+(_0x2a9d19?_0x41b80f(0xd8)+_0x2a9d19+_0x41b80f(0x1a8):'')+_0x41b80f(0x13c)),_0x457268=await this[_0x41b80f(0x14a)][_0x41b80f(0x172)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.nickname\x20as\x20nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user.avatar\x20as\x20avatar\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27'+_0x460204+'\x27\x20\x20'+(_0x9c174d?_0x41b80f(0xea)+_0x9c174d+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27'+_0x460204+_0x41b80f(0x131)+(_0x2a9d19?_0x41b80f(0xd8)+_0x2a9d19+_0x41b80f(0x1a8):'')+_0x41b80f(0x18f)+_0x296393+_0x41b80f(0x167)+size+_0x41b80f(0x11f)+(page-0x1)*size+_0x41b80f(0x13c)),_0x3fbdff=_0x457268[_0x41b80f(0x135)](_0x40a0f9=>_0x40a0f9['id']),_0x526f47=await this[_0x41b80f(0xbe)][_0x41b80f(0x1ab)](_0x3b88dc,_0x3fbdff,_0x460204);return _0x457268['forEach'](_0x46cac6=>{const _0x38b6b2=_0x41b80f;_0x46cac6[_0x38b6b2(0x129)]=_0x526f47[_0x38b6b2(0x147)](_0x46cac6['id'])||null;}),{'records':_0x457268,'count':Number(_0x150818[0x0]?.[_0x41b80f(0xe2)]||0x0)};}catch(_0x516a7a){throw new common_1['HttpException'](_0x516a7a[_0x41b80f(0xcc)],common_1[_0x41b80f(0x163)][_0x41b80f(0xe0)]);}}async['chatGptsList'](_0x39e00e,_0x5c117e){const _0x2c0409=_0x19e30d,{id:_0x404915}=_0x39e00e[_0x2c0409(0x19f)],{groupId:_0x574f32}=_0x5c117e,_0x380801={'userId':_0x404915,'isDelete':![]};_0x574f32&&Object[_0x2c0409(0x189)](_0x380801,{'groupId':_0x574f32});const _0x544e59=await this[_0x2c0409(0x13b)][_0x2c0409(0x14e)]({'where':_0x380801});return _0x544e59[_0x2c0409(0x135)](_0x4180fa=>{const _0x5425fe=_0x2c0409,{prompt:_0x126050,role:_0x593dd1,answer:_0x4cae50,createdAt:_0x528a51,model:_0x591b8b,conversationOptions:_0x446dfc,requestOptions:_0x50824c,id:_0x5f54ad}=_0x4180fa;return{'chatId':_0x5f54ad,'dateTime':(0x0,utils_1[_0x5425fe(0x179)])(_0x528a51),'text':_0x593dd1===_0x5425fe(0x19f)?_0x126050:_0x4cae50,'inversion':_0x593dd1==='user','error':![],'conversationOptions':_0x446dfc?JSON[_0x5425fe(0xfe)](_0x446dfc):null,'requestOptions':_0x50824c?JSON[_0x5425fe(0xfe)](_0x50824c):null};});}async[_0x19e30d(0x13e)](_0x59958e,_0x1b1122){const _0x147892=_0x19e30d,{id:_0x158163}=_0x59958e[_0x147892(0x19f)],{id:_0x31f8dc}=_0x1b1122,_0x20d10e=await this[_0x147892(0x13b)][_0x147892(0xce)]({'where':{'id':_0x31f8dc,'userId':_0x158163}});if(!_0x20d10e)throw new common_1['HttpException'](_0x147892(0x1aa),common_1[_0x147892(0x163)]['BAD_REQUEST']);const _0x316b85=await this['chatLogEntity'][_0x147892(0x16c)]({'id':_0x31f8dc},{'isDelete':!![]});await this[_0x147892(0x12c)][_0x147892(0x16c)]({'userId':_0x59958e['user']['id'],'chatLogId':_0x31f8dc},{'deleteFlag':0x1});if(_0x316b85[_0x147892(0xca)]>0x0)return'åˆ é™¤å¯¹è¯è®°å½•æˆåŠŸï¼';else throw new common_1['HttpException']('ä½ åˆ é™¤çš„å¯¹è¯è®°å½•ä¸å­˜åœ¨ã€è¯·æ£€æŸ¥ï¼',common_1[_0x147892(0x163)][_0x147892(0xe0)]);}async[_0x19e30d(0xc1)](_0xc3906,_0x54fa58){const _0x2db560=_0x19e30d,{groupId:_0x4f03d3,type:_0x32c127}=_0x54fa58,{id:_0x9edea5}=_0xc3906[_0x2db560(0x19f)],_0x48508c=_0x32c127&&_0x32c127===_0x2db560(0x160)?{'groupId':_0x4f03d3,'userId':_0x9edea5}:{'groupId':_0x4f03d3,'userId':_0x9edea5},_0x2e703d=await this[_0x2db560(0x13b)][_0x2db560(0xc7)](_0x48508c);if(_0x2e703d[_0x2db560(0xca)]>0x0)return!![];if(_0x2e703d[_0x2db560(0xca)]===0x0)throw new common_1['HttpException']('å½“å‰é¡µé¢å·²ç»æ²¡æœ‰ä¸œè¥¿å¯ä»¥åˆ é™¤äº†ï¼',common_1['HttpStatus'][_0x2db560(0xe0)]);}async[_0x19e30d(0x18a)](_0x1affcd){const _0x3efda9=_0x19e30d,{ids:_0x92be95,userId:_0x46429d}=_0x1affcd;return await this[_0x3efda9(0x13b)][_0x3efda9(0xc7)]({'groupId':(0x0,typeorm_2['In'])(_0x92be95),'userId':_0x46429d});}async[_0x19e30d(0x156)](_0x4fb8a1,_0x1e178a){const _0x5b9736=_0x19e30d,{id:_0x72d3ae}=_0x4fb8a1[_0x5b9736(0x19f)],{appId:_0x5c7fab,page:page=0x1,size:size=0xa}=_0x1e178a,[_0x3bfce3,_0x5ec518]=await this[_0x5b9736(0x13b)][_0x5b9736(0x193)]({'where':{'userId':_0x72d3ae,'appId':_0x5c7fab,'role':_0x5b9736(0x119)},'order':{'id':_0x5b9736(0x10a)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x3bfce3,'count':_0x5ec518};}async[_0x19e30d(0x162)](_0x16d23b,_0x212370){const _0x127989=_0x19e30d,_0x18bacc=_0x16d23b[_0x127989(0x19f)]['id'],_0x35c3a0=await this[_0x127989(0x13b)]['findOne']({'where':{'userId':_0x18bacc,'id':_0x212370}});if(!_0x35c3a0)return'';return{'chatId':_0x35c3a0['id'],'dateTime':(0x0,utils_1['formatDate'])(_0x35c3a0[_0x127989(0xe3)]),'text':_0x35c3a0[_0x127989(0x191)]===_0x127989(0x19f)?_0x35c3a0[_0x127989(0xec)]:_0x35c3a0[_0x127989(0x14d)],'textMp3':_0x35c3a0['answerMp3'],'inversion':_0x35c3a0[_0x127989(0x191)]==='user'};}async[_0x19e30d(0x171)](_0x11c8ae,_0x43106e){const _0x4d6fc0=_0x19e30d,_0xd15fe6=_0x11c8ae[_0x4d6fc0(0x19f)]['id'],_0xc8dec3=await this['chatLogEntity'][_0x4d6fc0(0xce)]({'where':{'userId':_0xd15fe6,'id':_0x43106e}});if(!_0xc8dec3)return'';return _0xc8dec3[_0x4d6fc0(0x14d)];}async[_0x19e30d(0x161)](){const _0x5d6941=_0x19e30d,_0x161a8f=await this[_0x5d6941(0x14a)][_0x5d6941(0x172)](_0x5d6941(0x17e));return _0x161a8f;}async[_0x19e30d(0x15d)](_0x5df266){const _0x23246a=_0x19e30d,_0x11e8cd=await this[_0x23246a(0xc9)][_0x23246a(0x132)](_0x5df266['modelId']);_0x11e8cd&&this[_0x23246a(0xef)]['refundBalance4Video'](_0x5df266[_0x23246a(0xcf)],_0x11e8cd,_0x5df266['requestParams'],_0x5df266['id']);}async['videoNotify'](_0xe7807c){const _0x3dce96=_0x19e30d,_0x2a9bfc=await this[_0x3dce96(0x12c)]['findOne']({'where':{'sunoMusicId':_0xe7807c['id']}});if(!_0x2a9bfc)return;const _0x13dc38=await this[_0x3dce96(0x13b)][_0x3dce96(0xce)]({'where':{'id':_0x2a9bfc[_0x3dce96(0x15b)]}});_0x13dc38[_0x3dce96(0x14d)]=_0xe7807c['state'],_0x2a9bfc['mp4']=_0xe7807c[_0x3dce96(0x17b)]?.[_0x3dce96(0xc6)],await this[_0x3dce96(0x13b)][_0x3dce96(0x170)](_0x13dc38),await this[_0x3dce96(0x12c)][_0x3dce96(0x170)](_0x2a9bfc);if(_0x13dc38[_0x3dce96(0x14d)]===_0x3dce96(0x195)&&_0x2a9bfc[_0x3dce96(0xf0)])this[_0x3dce96(0x143)](_0x2a9bfc);else _0x13dc38[_0x3dce96(0x14d)]===_0x3dce96(0x144)&&this['refundVideo'](_0x13dc38);}async['videoNotifyRunway'](_0x9ef09c){const _0x5bc7e9=_0x19e30d;console[_0x5bc7e9(0x12a)](_0x5bc7e9(0x1b2),_0x9ef09c);const _0x411894=await this[_0x5bc7e9(0x12c)][_0x5bc7e9(0xce)]({'where':{'sunoMusicId':_0x9ef09c[_0x5bc7e9(0x180)]}});if(!_0x411894)throw new Error(_0x5bc7e9(0x10e));const _0x43f055=await this[_0x5bc7e9(0x13b)]['findOne']({'where':{'id':_0x411894[_0x5bc7e9(0x15b)]}});_0x43f055['answer']=_0x9ef09c[_0x5bc7e9(0x121)],_0x411894[_0x5bc7e9(0xf0)]=_0x9ef09c['video_url'],await this[_0x5bc7e9(0x13b)][_0x5bc7e9(0x170)](_0x43f055),await this[_0x5bc7e9(0x12c)][_0x5bc7e9(0x170)](_0x411894);if(_0x9ef09c[_0x5bc7e9(0xe1)]==='3'&&_0x411894['mp4'])this[_0x5bc7e9(0x143)](_0x411894);else _0x43f055['answer']===_0x5bc7e9(0xdc)&&this['refundVideo'](_0x43f055);}async[_0x19e30d(0x122)](_0x449e97){const _0x33e1ad=_0x19e30d;console['log'](_0x33e1ad(0x182),_0x449e97);const _0x55f12b=_0x449e97['data']?_0x449e97[_0x33e1ad(0x112)]:_0x449e97,_0x598922=await this['aiAssetsEntity'][_0x33e1ad(0xce)]({'where':{'sunoMusicId':_0x55f12b[_0x33e1ad(0x180)]}});if(!_0x598922)throw new Error(_0x33e1ad(0x10e));const _0x4ecba0=await this[_0x33e1ad(0x13b)]['findOne']({'where':{'id':_0x598922[_0x33e1ad(0x15b)]}});_0x4ecba0[_0x33e1ad(0x14d)]=_0x55f12b['task_status'];_0x55f12b[_0x33e1ad(0x186)]['videos']&&(_0x598922[_0x33e1ad(0xf0)]=_0x55f12b['task_result'][_0x33e1ad(0x11c)][0x0]?.[_0x33e1ad(0xc6)]);await this['chatLogEntity'][_0x33e1ad(0x170)](_0x4ecba0),await this[_0x33e1ad(0x12c)][_0x33e1ad(0x170)](_0x598922);if(_0x4ecba0['answer']===_0x33e1ad(0x166)&&_0x598922[_0x33e1ad(0xf0)])this[_0x33e1ad(0x143)](_0x598922);else _0x4ecba0['answer']===_0x33e1ad(0xdc)&&this[_0x33e1ad(0x15d)](_0x4ecba0);}async[_0x19e30d(0x116)](_0x44b68a,_0x3b8910){const _0x4d100a=_0x19e30d;console[_0x4d100a(0x12a)]('sunoé€šçŸ¥ï¼š',_0x44b68a);let _0x4cd717;_0x3b8910===_0x4d100a(0xc0)?(_0x4cd717=await this['chatLogEntity'][_0x4d100a(0xce)]({'where':{'id':Number(_0x44b68a[_0x4d100a(0x180)])}}),_0x4cd717[_0x4d100a(0x14d)]=_0x44b68a[_0x4d100a(0x1a7)]||_0x44b68a['data']['text']):(_0x4cd717=await this[_0x4d100a(0x13b)][_0x4d100a(0xce)]({'where':{'message_id':_0x44b68a[_0x4d100a(0x180)]}}),_0x4cd717[_0x4d100a(0x14d)]=_0x44b68a['status']);_0x4cd717[_0x4d100a(0x14d)]!==_0x4d100a(0x126)&&await this[_0x4d100a(0x13b)][_0x4d100a(0x170)](_0x4cd717);if(_0x3b8910==='create'){const _0x2fead1=await this[_0x4d100a(0x12c)]['find']({'where':{'chatLogId':_0x4cd717['id']}});for(const _0x228360 of _0x44b68a[_0x4d100a(0x112)]){const {title:_0x592f66,prompt:_0x9ae763,audio_url:_0x26c156,image_url:_0x20147b,task_id:_0x4370d4,id:_0x3da63c,video_url:_0x1acba8}=_0x228360,_0x5daacc=_0x4370d4?_0x2fead1['find'](_0xad49c6=>_0xad49c6[_0x4d100a(0xda)]===_0x4370d4):_0x2fead1['find'](_0x395d37=>_0x395d37[_0x4d100a(0xda)]===_0x3da63c);!_0x5daacc?await this[_0x4d100a(0x12c)][_0x4d100a(0x170)]({'title':_0x592f66,'intro':_0x9ae763||_0x228360[_0x4d100a(0x15a)]['prompt'],'mp3':_0x26c156||'','mp4':_0x1acba8||'','cover':_0x20147b||'','sunoMusicId':_0x4370d4||_0x3da63c,'chatLogId':_0x4cd717['id'],'userId':_0x4cd717[_0x4d100a(0xcf)]}):(_0x5daacc[_0x4d100a(0x10b)]=_0x592f66,_0x5daacc[_0x4d100a(0xe6)]=_0x9ae763||_0x228360['metadata'][_0x4d100a(0xec)],_0x5daacc[_0x4d100a(0x142)]=_0x26c156||'',_0x5daacc[_0x4d100a(0xf0)]=_0x1acba8||'',_0x5daacc[_0x4d100a(0x175)]=_0x20147b||'',await this[_0x4d100a(0x12c)][_0x4d100a(0x170)](_0x5daacc));}}}async['syncVideo'](_0x5f0d58){const _0x701a57=_0x19e30d,[_0x442fe3,_0x2b87f2]=await this['fileService'][_0x701a57(0x137)](_0x5f0d58[_0x701a57(0xf0)]);_0x5f0d58[_0x701a57(0xf0)]=_0x442fe3,_0x5f0d58[_0x701a57(0x175)]=_0x2b87f2,await this['aiAssetsEntity']['save'](_0x5f0d58);}async['syncAssets'](){const _0x1eb19b=_0x19e30d,_0x1df5f3=await this[_0x1eb19b(0x12c)][_0x1eb19b(0x14e)]({'where':[{'cover':(0x0,typeorm_2[_0x1eb19b(0x101)])(_0x1eb19b(0x100))},{'mp3':(0x0,typeorm_2[_0x1eb19b(0x101)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x1eb19b(0x101)])(_0x1eb19b(0x100))},{'mp4':(0x0,typeorm_2['Like'])(_0x1eb19b(0x104))}]});for(let _0x4eafd4=0x0;_0x4eafd4<_0x1df5f3['length'];_0x4eafd4++){const _0x5e300e=_0x1df5f3[_0x4eafd4],_0xdefd67=redisKey_constant_1[_0x1eb19b(0xf9)]+_0x5e300e['id'];try{const _0x4e7a8d=await this[_0x1eb19b(0x1a3)]['get']({'key':_0xdefd67});if(_0x4e7a8d)continue;await this[_0x1eb19b(0x1a3)]['set']({'key':_0xdefd67,'val':_0x1eb19b(0xd0)});const {cover:_0x4f7d33,mp3:_0x20ef90,mp4:_0x36c920}=_0x5e300e;/filesystem.site/['test'](_0x4f7d33)&&(_0x5e300e[_0x1eb19b(0x175)]=await this[_0x1eb19b(0x174)][_0x1eb19b(0x10f)](_0x4f7d33));/filesystem.site/[_0x1eb19b(0x183)](_0x20ef90)&&(_0x5e300e[_0x1eb19b(0x142)]=await this[_0x1eb19b(0x174)]['transferFile'](_0x20ef90));if(/filesystem.site|storage.cdn-luma.com/[_0x1eb19b(0x183)](_0x36c920)){if(_0x4f7d33)_0x5e300e['mp4']=await this[_0x1eb19b(0x174)][_0x1eb19b(0x10f)](_0x36c920);else{const [_0x5dfaa8,_0x3b58f3]=await this[_0x1eb19b(0x174)][_0x1eb19b(0x137)](_0x36c920);_0x5e300e[_0x1eb19b(0xf0)]=_0x5dfaa8,_0x5e300e[_0x1eb19b(0x175)]=_0x3b58f3;}}await this[_0x1eb19b(0x12c)][_0x1eb19b(0x170)](_0x5e300e);}catch(_0xa6059f){common_1[_0x1eb19b(0x123)]['error'](_0xa6059f);}finally{await this[_0x1eb19b(0x1a3)][_0x1eb19b(0x1a0)]({'key':_0xdefd67});}}}async['getLastByUserAndAppIds'](_0x1649ee,_0x42193d){const _0x2db558=_0x19e30d,_0x3b7621=await this[_0x2db558(0x13b)][_0x2db558(0x172)](_0x2db558(0x14b)+_0x1649ee+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20'+_0x42193d[_0x2db558(0x12d)]()+'\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20');return _0x3b7621;}async[_0x19e30d(0xf7)](){const _0x2eefb2=_0x19e30d,_0x1ef825=await this[_0x2eefb2(0xc9)][_0x2eefb2(0x1af)](model_constant_1['EModelType'][_0x2eefb2(0x157)]);try{const _0x19a0ca=store_1[_0x2eefb2(0x111)][_0x2eefb2(0x13a)]||0x5,_0xe32070=await this[_0x2eefb2(0x13b)][_0x2eefb2(0x14e)]({'where':{'role':_0x2eefb2(0x119),'modelType':model_constant_1[_0x2eefb2(0xe4)][_0x2eefb2(0x157)],'answer':(0x0,typeorm_2['In'])([_0x2eefb2(0x136),'']),'updatedAt':(0x0,typeorm_2[_0x2eefb2(0x1a5)])(new Date(Date[_0x2eefb2(0x140)]()-_0x19a0ca*0x3c*0x3e8))}});_0xe32070[_0x2eefb2(0x190)](async _0x3d484f=>{const _0x10e2fc=_0x2eefb2;_0x3d484f[_0x10e2fc(0x14d)]=_0x10e2fc(0x126),_0x3d484f[_0x10e2fc(0x185)]=_0x10e2fc(0x126),this['chatLogEntity'][_0x10e2fc(0x170)](_0x3d484f),await this[_0x10e2fc(0x12c)][_0x10e2fc(0x16c)]({'chatLogId':_0x3d484f['id']},{'deleteFlag':0x1}),this['userService'][_0x10e2fc(0x10c)](_0x3d484f[_0x10e2fc(0xcf)],_0x3d484f['id'],_0x3d484f[_0x10e2fc(0x1a9)],!![]);});}catch(_0x296c21){common_1[_0x2eefb2(0x123)][_0x2eefb2(0x169)](_0x296c21);}}};ChatLogService=__decorate([(0x0,common_1[_0x19e30d(0xf8)])(),__param(0x0,(0x0,typeorm_1[_0x19e30d(0x145)])(chatLog_entity_1[_0x19e30d(0xc3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(aiAssets_entity_1[_0x19e30d(0x106)])),__metadata('design:paramtypes',[typeorm_2[_0x19e30d(0x150)],typeorm_2[_0x19e30d(0x150)],nestjs_cls_1['ClsService'],file_service_1['FileService'],aiLog_service_1[_0x19e30d(0xcb)],redisCache_service_1[_0x19e30d(0xf3)],user_service_1[_0x19e30d(0x115)],models_service_1[_0x19e30d(0x133)],typeorm_2[_0x19e30d(0xfc)]])],ChatLogService),exports[_0x19e30d(0x130)]=ChatLogService;