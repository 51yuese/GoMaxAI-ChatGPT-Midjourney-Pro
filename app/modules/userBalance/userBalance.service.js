'use strict';const _0x25d75a=_0x27b3;(function(_0x584385,_0x1dbd39){const _0x3cf326=_0x27b3,_0x4915cb=_0x584385();while(!![]){try{const _0x589d3c=-parseInt(_0x3cf326(0x19d))/0x1+parseInt(_0x3cf326(0x160))/0x2+-parseInt(_0x3cf326(0x16d))/0x3+parseInt(_0x3cf326(0x1ab))/0x4+-parseInt(_0x3cf326(0x198))/0x5+-parseInt(_0x3cf326(0x166))/0x6+-parseInt(_0x3cf326(0x154))/0x7*(-parseInt(_0x3cf326(0x191))/0x8);if(_0x589d3c===_0x1dbd39)break;else _0x4915cb['push'](_0x4915cb['shift']());}catch(_0x5ef17f){_0x4915cb['push'](_0x4915cb['shift']());}}}(_0x69b0,0xb22d9));var __decorate=this&&this[_0x25d75a(0x14d)]||function(_0x132541,_0xce4537,_0x5e7169,_0x418167){const _0x5250e8=_0x25d75a;var _0x7ed0d7=arguments[_0x5250e8(0x182)],_0x52555e=_0x7ed0d7<0x3?_0xce4537:_0x418167===null?_0x418167=Object[_0x5250e8(0x18c)](_0xce4537,_0x5e7169):_0x418167,_0x2658eb;if(typeof Reflect===_0x5250e8(0x163)&&typeof Reflect[_0x5250e8(0x155)]===_0x5250e8(0x15b))_0x52555e=Reflect[_0x5250e8(0x155)](_0x132541,_0xce4537,_0x5e7169,_0x418167);else{for(var _0x76f55e=_0x132541[_0x5250e8(0x182)]-0x1;_0x76f55e>=0x0;_0x76f55e--)if(_0x2658eb=_0x132541[_0x76f55e])_0x52555e=(_0x7ed0d7<0x3?_0x2658eb(_0x52555e):_0x7ed0d7>0x3?_0x2658eb(_0xce4537,_0x5e7169,_0x52555e):_0x2658eb(_0xce4537,_0x5e7169))||_0x52555e;}return _0x7ed0d7>0x3&&_0x52555e&&Object[_0x5250e8(0x149)](_0xce4537,_0x5e7169,_0x52555e),_0x52555e;},__metadata=this&&this[_0x25d75a(0x17f)]||function(_0x4a5ab3,_0x4b6707){const _0x3c2bac=_0x25d75a;if(typeof Reflect==='object'&&typeof Reflect[_0x3c2bac(0x150)]===_0x3c2bac(0x15b))return Reflect[_0x3c2bac(0x150)](_0x4a5ab3,_0x4b6707);},__param=this&&this[_0x25d75a(0x1a4)]||function(_0x3e5806,_0x850bbc){return function(_0x30ead4,_0x37891f){_0x850bbc(_0x30ead4,_0x37891f,_0x3e5806);};};Object[_0x25d75a(0x149)](exports,_0x25d75a(0x194),{'value':!![]}),exports[_0x25d75a(0x180)]=void 0x0;const typeorm_1=require(_0x25d75a(0x14a)),common_1=require(_0x25d75a(0x19e)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x25d75a(0x14b)),accountLog_entity_1=require(_0x25d75a(0x186)),cramiPackage_entity_1=require(_0x25d75a(0x17a)),user_entity_1=require(_0x25d75a(0x187)),salesUsers_entity_1=require(_0x25d75a(0x183)),sales_service_1=require('../sales/sales.service'),user_service_1=require(_0x25d75a(0x176)),accountVipLog_entity_1=require('./accountVipLog.entity'),utils_1=require(_0x25d75a(0x190));let UserBalanceService=class UserBalanceService{constructor(_0x57e6a4,_0x19804e,_0x4a36ac,_0x2d1d8f,_0x53a469,_0x3f7432,_0x1dd73e,_0x1b63e5){const _0xe5941f=_0x25d75a;this[_0xe5941f(0x159)]=_0x57e6a4,this[_0xe5941f(0x15d)]=_0x19804e,this[_0xe5941f(0x18e)]=_0x4a36ac,this[_0xe5941f(0x18f)]=_0x2d1d8f,this[_0xe5941f(0x196)]=_0x53a469,this[_0xe5941f(0x16e)]=_0x3f7432,this[_0xe5941f(0x19b)]=_0x1dd73e,this['connection']=_0x1b63e5;}async[_0x25d75a(0x19a)](_0x1f6935){const _0x217d48=_0x25d75a;console[_0x217d48(0x147)]('充值的订单信息:',_0x1f6935);try{const {userId:_0x489239,goodsId:_0x391424}=_0x1f6935,_0x296039=await this[_0x217d48(0x18e)]['findOne']({'where':{'id':_0x391424,'status':0x1}});if(!_0x296039)throw new common_1[(_0x217d48(0x18a))](_0x217d48(0x193),common_1[_0x217d48(0x1a8)][_0x217d48(0x178)]);const _0x3b0305=await this[_0x217d48(0x18f)][_0x217d48(0x175)]({'where':{'id':_0x489239}});_0x296039['score']>0x0&&await this['userService'][_0x217d48(0x165)](_0x3b0305,balance_constant_1['EChangeType'][_0x217d48(0x19c)],_0x296039['score'],_0x217d48(0x1aa)+_0x296039[_0x217d48(0x18d)],_0x296039['id']);_0x296039['days']!==0x0&&await this[_0x217d48(0x16e)][_0x217d48(0x17e)](_0x3b0305,balance_constant_1[_0x217d48(0x15e)]['PurchasePackage'],_0x296039['days'],_0x217d48(0x19f)+_0x296039[_0x217d48(0x18d)],_0x296039['id']);if(_0x3b0305[_0x217d48(0x162)]){const _0x5069d0=await this[_0x217d48(0x18f)][_0x217d48(0x175)]({'where':{'inviteCode':_0x3b0305[_0x217d48(0x162)]}}),_0x367fe5=await this['salesUsersEntity'][_0x217d48(0x175)]({'where':{'userId':_0x5069d0['id']}});if(!_0x5069d0)return;const {id:_0xb00bf4}=_0x5069d0,{performanceRatio:_0x47f432}=_0x367fe5,_0x5748e6={'inviterUserId':_0xb00bf4,'inviteeUserId':_0x489239,'orderId':_0x1f6935['id'],'orderPrice':_0x1f6935[_0x217d48(0x151)],'commissionPercentage':_0x47f432,'commissionAmount':(_0x1f6935[_0x217d48(0x151)]*_0x47f432/0x64)[_0x217d48(0x181)](0x2)};await this[_0x217d48(0x19b)][_0x217d48(0x18b)](_0x5748e6),await this['salesService']['saveCommissionAmount'](_0xb00bf4,_0x5748e6[_0x217d48(0x146)]);}}catch(_0x3966b7){console[_0x217d48(0x147)](_0x217d48(0x153),_0x3966b7);throw new common_1[(_0x217d48(0x18a))](_0x217d48(0x168),common_1[_0x217d48(0x1a8)][_0x217d48(0x178)]);}}async[_0x25d75a(0x1a7)](_0x174a66,_0x3a4962,_0x10b5c3){const _0x42be1b=_0x25d75a,{page:page=0x1,size:size=0x14,startTime:_0x23e098,endTime:_0x108dd4,keyword:_0x1f2f02,changeType:_0x2c5b3c,creaseType:_0x302637}=_0x3a4962,_0x496ea3=_0x42be1b(0x167)+(_0x10b5c3?_0x42be1b(0x1a3)+_0x10b5c3:'')+_0x42be1b(0x161)+(_0x2c5b3c?_0x42be1b(0x174)+_0x2c5b3c:'')+_0x42be1b(0x161)+(_0x302637?'\x20AND\x20al.change_score\x20'+(_0x302637==='increase'?_0x42be1b(0x16a):_0x42be1b(0x16c)):'')+_0x42be1b(0x161)+(_0x23e098?_0x42be1b(0x17c)+_0x23e098:'')+_0x42be1b(0x161)+(_0x108dd4?_0x42be1b(0x164)+_0x108dd4:'')+_0x42be1b(0x161)+(_0x1f2f02?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x1f2f02+_0x42be1b(0x14c)+_0x1f2f02+_0x42be1b(0x1a6)+_0x1f2f02+_0x42be1b(0x173)+_0x1f2f02+_0x42be1b(0x156):'')+_0x42be1b(0x184),_0xb41e08=_0x42be1b(0x192)+_0x496ea3+_0x42be1b(0x184),_0x2c4fb0=_0x42be1b(0x1a1)+_0x496ea3+_0x42be1b(0x158)+size+_0x42be1b(0x148)+(page-0x1)*size+_0x42be1b(0x184),_0x5e5694=await this[_0x42be1b(0x179)][_0x42be1b(0x185)](_0xb41e08),_0x5463af=await this[_0x42be1b(0x179)][_0x42be1b(0x185)](_0x2c4fb0);return _0x174a66[_0x42be1b(0x15c)][_0x42be1b(0x14e)]!==_0x42be1b(0x152)&&_0x5463af[_0x42be1b(0x17b)](_0x301974=>{const _0x5e3849=_0x42be1b;_0x301974[_0x5e3849(0x1a0)]=(0x0,utils_1['maskEmail'])(_0x301974['email']),_0x301974[_0x5e3849(0x188)]=(0x0,utils_1[_0x5e3849(0x15f)])(_0x301974['phone']);}),{'rows':_0x5463af,'count':Number(_0x5e5694[0x0]?.[_0x42be1b(0x157)]||0x0)};}async[_0x25d75a(0x195)](_0x4d489f,_0x4fac2a){const _0x69ba84=_0x25d75a;return this[_0x69ba84(0x1a7)](_0x4d489f,_0x4fac2a,_0x4d489f[_0x69ba84(0x15c)]['id']);}async[_0x25d75a(0x17d)](_0x26ff7b){const _0x3a811a=_0x25d75a;if(!_0x26ff7b[_0x3a811a(0x199)]['length'])return!![];return await this['accountLogEntity'][_0x3a811a(0x16f)]({'id':(0x0,typeorm_2['In'])(_0x26ff7b['ids'])},{'delFlag':0x1}),!![];}async[_0x25d75a(0x1a2)](_0x4c8aa7){const _0xc149f2=_0x25d75a;await this[_0xc149f2(0x159)][_0xc149f2(0x1a5)](_0x4c8aa7);}async[_0x25d75a(0x1a9)](_0x198b7f){await this['accountVipLogEntity']['save'](_0x198b7f);}};function _0x27b3(_0x385196,_0x4dac65){const _0x69b0d8=_0x69b0();return _0x27b3=function(_0x27b33e,_0x2a4eaf){_0x27b33e=_0x27b33e-0x146;let _0x8681ba=_0x69b0d8[_0x27b33e];return _0x8681ba;},_0x27b3(_0x385196,_0x4dac65);}function _0x69b0(){const _0x399a54=['function','user','accountVipLogEntity','EChangeType','maskEmail','1996046newsbu','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','invitedBy','object','\x20AND\x20al.createdAt\x20<=\x20','changeScore4Other','1518426wEeWbh','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','充值失败！','AccountLogEntity','>\x200','UserService','<\x200','3447216SJNLua','userService','update','forwardRef','SalesUsersEntity','SalesService','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','\x20AND\x20al.change_type\x20=\x20','findOne','../user/user.service','Repository','BAD_REQUEST','connection','../crami/cramiPackage.entity','forEach','\x20AND\x20al.createdAt\x20>=\x20','deleteAccountLog','updateVipExpire','__metadata','UserBalanceService','toFixed','length','../sales/salesUsers.entity','\x0a\x20\x20\x20\x20','query','./accountLog.entity','../user/user.entity','phone','InjectRepository','HttpException','createSalesRecords','getOwnPropertyDescriptor','name','cramiPackageEntity','userEntity','../../common/utils','16Favoyd','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','非法操作、当前充值套餐暂不存在！','__esModule','myPage','salesUsersEntity','UserEntity','5475625UCLdqy','ids','addBalanceToOrder','salesService','PurchasePackage','137422vcQiRz','@nestjs/common','购买套餐:\x20','email','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','insertAccountLog','\x20AND\x20al.userId\x20=\x20','__param','save','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','userPage','HttpStatus','insertAccountVipLog','购买套餐：','1833320fNfaoG','commissionAmount','log','\x20OFFSET\x20','defineProperty','@nestjs/typeorm','../../common/constants/balance.constant','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','__decorate','role','Injectable','metadata','total','super','error:\x20','6678539hliQrg','decorate','%\x27\x20)','count','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','accountLogEntity','Inject'];_0x69b0=function(){return _0x399a54;};return _0x69b0();}UserBalanceService=__decorate([(0x0,common_1[_0x25d75a(0x14f)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x25d75a(0x169)])),__param(0x1,(0x0,typeorm_1[_0x25d75a(0x189)])(accountVipLog_entity_1['AccountVipLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x25d75a(0x189)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x25d75a(0x197)])),__param(0x4,(0x0,typeorm_1[_0x25d75a(0x189)])(salesUsers_entity_1[_0x25d75a(0x171)])),__param(0x5,(0x0,common_1[_0x25d75a(0x15a)])((0x0,common_1[_0x25d75a(0x170)])(()=>user_service_1[_0x25d75a(0x16b)]))),__metadata('design:paramtypes',[typeorm_2[_0x25d75a(0x177)],typeorm_2[_0x25d75a(0x177)],typeorm_2[_0x25d75a(0x177)],typeorm_2['Repository'],typeorm_2[_0x25d75a(0x177)],user_service_1['UserService'],sales_service_1[_0x25d75a(0x172)],typeorm_2['Connection']])],UserBalanceService),exports[_0x25d75a(0x180)]=UserBalanceService;