'use strict';const _0x585947=_0x3708;(function(_0x25966d,_0x22913e){const _0x2054c0=_0x3708,_0x5e23a0=_0x25966d();while(!![]){try{const _0x1cff32=parseInt(_0x2054c0(0x162))/0x1*(-parseInt(_0x2054c0(0x11b))/0x2)+parseInt(_0x2054c0(0x127))/0x3+parseInt(_0x2054c0(0x11c))/0x4+parseInt(_0x2054c0(0x131))/0x5*(parseInt(_0x2054c0(0x170))/0x6)+parseInt(_0x2054c0(0x153))/0x7+-parseInt(_0x2054c0(0x166))/0x8+-parseInt(_0x2054c0(0x151))/0x9;if(_0x1cff32===_0x22913e)break;else _0x5e23a0['push'](_0x5e23a0['shift']());}catch(_0x1806da){_0x5e23a0['push'](_0x5e23a0['shift']());}}}(_0x344d,0x37417));function _0x3708(_0x22a6a3,_0x44fbb0){const _0x344d7d=_0x344d();return _0x3708=function(_0x3708a5,_0x5c9d27){_0x3708a5=_0x3708a5-0x116;let _0x3db6fb=_0x344d7d[_0x3708a5];return _0x3db6fb;},_0x3708(_0x22a6a3,_0x44fbb0);}var __decorate=this&&this[_0x585947(0x128)]||function(_0xe66ea9,_0x28f3f5,_0xd80844,_0x248b69){const _0x4bc593=_0x585947;var _0xdd3df9=arguments[_0x4bc593(0x16e)],_0x80b0e3=_0xdd3df9<0x3?_0x28f3f5:_0x248b69===null?_0x248b69=Object[_0x4bc593(0x11a)](_0x28f3f5,_0xd80844):_0x248b69,_0x310055;if(typeof Reflect===_0x4bc593(0x173)&&typeof Reflect[_0x4bc593(0x155)]==='function')_0x80b0e3=Reflect['decorate'](_0xe66ea9,_0x28f3f5,_0xd80844,_0x248b69);else{for(var _0x1636fd=_0xe66ea9[_0x4bc593(0x16e)]-0x1;_0x1636fd>=0x0;_0x1636fd--)if(_0x310055=_0xe66ea9[_0x1636fd])_0x80b0e3=(_0xdd3df9<0x3?_0x310055(_0x80b0e3):_0xdd3df9>0x3?_0x310055(_0x28f3f5,_0xd80844,_0x80b0e3):_0x310055(_0x28f3f5,_0xd80844))||_0x80b0e3;}return _0xdd3df9>0x3&&_0x80b0e3&&Object[_0x4bc593(0x11f)](_0x28f3f5,_0xd80844,_0x80b0e3),_0x80b0e3;},__metadata=this&&this['__metadata']||function(_0x1cc1e4,_0x181455){const _0x21e9b7=_0x585947;if(typeof Reflect===_0x21e9b7(0x173)&&typeof Reflect[_0x21e9b7(0x13a)]==='function')return Reflect['metadata'](_0x1cc1e4,_0x181455);},__param=this&&this[_0x585947(0x12b)]||function(_0x7e75ad,_0x4f8f3f){return function(_0x3e234a,_0xfac820){_0x4f8f3f(_0x3e234a,_0xfac820,_0x7e75ad);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x585947(0x12a)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x585947(0x132)),typeorm_2=require(_0x585947(0x13f)),balance_constant_1=require(_0x585947(0x161)),accountLog_entity_1=require(_0x585947(0x140)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),salesUsers_entity_1=require(_0x585947(0x179)),sales_service_1=require('../sales/sales.service'),user_service_1=require(_0x585947(0x154)),accountVipLog_entity_1=require(_0x585947(0x13c)),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x585947(0x163));let UserBalanceService=class UserBalanceService{constructor(_0xc3abc5,_0xb07dae,_0x11882d,_0x4df487,_0x561a94,_0x3b2af6,_0x25cbb7,_0x4b8ecd){const _0x29ab1b=_0x585947;this[_0x29ab1b(0x152)]=_0xc3abc5,this[_0x29ab1b(0x14d)]=_0xb07dae,this[_0x29ab1b(0x176)]=_0x11882d,this['salesUsersEntity']=_0x4df487,this[_0x29ab1b(0x123)]=_0x561a94,this[_0x29ab1b(0x177)]=_0x3b2af6,this[_0x29ab1b(0x167)]=_0x25cbb7,this['connection']=_0x4b8ecd;}async[_0x585947(0x14c)](_0x3308de){const _0x4c8e5e=_0x585947;console['log']('充值的订单信息:',_0x3308de);try{const {userId:_0x1d5909,goodsId:_0x2f377a}=_0x3308de,_0x195e09=await this[_0x4c8e5e(0x176)][_0x4c8e5e(0x14f)]({'where':{'id':_0x2f377a,'status':0x1}});if(!_0x195e09)throw new common_1[(_0x4c8e5e(0x15d))](_0x4c8e5e(0x175),common_1['HttpStatus'][_0x4c8e5e(0x12d)]);const _0x866f1c=await this['userService'][_0x4c8e5e(0x141)](_0x1d5909);_0x195e09[_0x4c8e5e(0x16d)]>0x0&&await this[_0x4c8e5e(0x123)][_0x4c8e5e(0x149)](_0x866f1c,balance_constant_1[_0x4c8e5e(0x129)]['PurchasePackage'],_0x195e09[_0x4c8e5e(0x16d)],_0x4c8e5e(0x12e)+_0x195e09[_0x4c8e5e(0x16c)],_0x195e09['id']);_0x195e09['days']!==0x0&&await this[_0x4c8e5e(0x123)][_0x4c8e5e(0x126)](_0x866f1c,balance_constant_1[_0x4c8e5e(0x129)][_0x4c8e5e(0x13d)],_0x195e09[_0x4c8e5e(0x157)],_0x4c8e5e(0x13e)+_0x195e09[_0x4c8e5e(0x16c)],_0x195e09['id']);if(_0x866f1c[_0x4c8e5e(0x146)]){const _0x3057a2=await this['userService']['getUserByInviteCode'](_0x866f1c[_0x4c8e5e(0x146)]);if(!_0x3057a2)return;const _0x2a9c12=await this[_0x4c8e5e(0x116)]['findOne']({'where':{'userId':_0x3057a2['id']}}),{id:_0x575731}=_0x3057a2,{performanceRatio:_0x5c833f}=_0x2a9c12,_0x4b2ce5={'inviterUserId':_0x575731,'inviteeUserId':_0x1d5909,'orderId':_0x3308de['id'],'orderPrice':_0x3308de[_0x4c8e5e(0x120)],'commissionPercentage':_0x5c833f,'commissionAmount':(_0x3308de['total']*_0x5c833f/0x64)[_0x4c8e5e(0x14e)](0x2)};await this[_0x4c8e5e(0x177)][_0x4c8e5e(0x135)](_0x4b2ce5),await this[_0x4c8e5e(0x177)][_0x4c8e5e(0x156)](_0x575731,_0x4b2ce5[_0x4c8e5e(0x160)]);}}catch(_0x4f9b58){console[_0x4c8e5e(0x11e)](_0x4c8e5e(0x17a),_0x4f9b58);throw new common_1[(_0x4c8e5e(0x15d))](_0x4c8e5e(0x144),common_1[_0x4c8e5e(0x13b)][_0x4c8e5e(0x12d)]);}}async['userPage'](_0x51ec64,_0x375db8,_0x529a76){const _0x4ffee2=_0x585947,_0x241ba2=(0x0,utils_1[_0x4ffee2(0x15f)])(this[_0x4ffee2(0x167)]),{page:page=0x1,size:size=0x14,startTime:_0x2ced97,endTime:_0x358d97,keyword:_0x52fcdc,saasId:_0x2ea940,changeType:_0xadeae7,creaseType:_0x49c5f2}=_0x375db8;let _0x13c9d0='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x529a76?_0x4ffee2(0x16f)+_0x529a76:'')+_0x4ffee2(0x124)+(_0xadeae7?'\x20AND\x20al.change_type\x20=\x20'+_0xadeae7:'')+_0x4ffee2(0x124)+(_0x49c5f2?'\x20AND\x20al.change_score\x20'+(_0x49c5f2===_0x4ffee2(0x15e)?'>\x200':_0x4ffee2(0x130)):'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x2ced97?_0x4ffee2(0x121)+_0x2ced97+'\x27':'')+_0x4ffee2(0x124)+(_0x358d97?_0x4ffee2(0x14b)+_0x358d97+'\x27':'')+_0x4ffee2(0x124)+(_0x52fcdc?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x52fcdc+_0x4ffee2(0x125)+_0x52fcdc+_0x4ffee2(0x133)+_0x52fcdc+_0x4ffee2(0x148)+_0x52fcdc+_0x4ffee2(0x178):'')+'\x0a\x20\x20\x20\x20';(0x0,utils_1['isPlatform'])(this[_0x4ffee2(0x167)])?(0x0,utils_1[_0x4ffee2(0x137)])(this[_0x4ffee2(0x167)])&&_0x2ea940&&(_0x13c9d0=_0x13c9d0+('\x20AND\x20al.saasId\x20=\x20'+_0x2ea940)):_0x13c9d0=_0x13c9d0+(_0x4ffee2(0x136)+_0x241ba2);const _0x3160e0=_0x4ffee2(0x16a)+_0x13c9d0+_0x4ffee2(0x145),_0x5c1e55=_0x4ffee2(0x11d)+_0x13c9d0+_0x4ffee2(0x147)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x4ffee2(0x145),_0x389973=await this['connection'][_0x4ffee2(0x16b)](_0x3160e0),_0x2ff6be=await this[_0x4ffee2(0x17b)][_0x4ffee2(0x16b)](_0x5c1e55);return!(0x0,utils_1[_0x4ffee2(0x172)])(this[_0x4ffee2(0x167)])&&_0x2ff6be[_0x4ffee2(0x12f)](_0x4658e2=>{const _0x316b28=_0x4ffee2;_0x4658e2[_0x316b28(0x164)]=(0x0,utils_1[_0x316b28(0x150)])(_0x4658e2[_0x316b28(0x164)]),_0x4658e2['phone']=(0x0,utils_1['maskEmail'])(_0x4658e2[_0x316b28(0x159)]);}),{'rows':_0x2ff6be,'count':Number(_0x389973[0x0]?.[_0x4ffee2(0x139)]||0x0)};}async[_0x585947(0x15a)](_0x5d4c0f,_0x1e7b5f){const _0x43c176=_0x585947;return this[_0x43c176(0x119)](_0x5d4c0f,_0x1e7b5f,_0x5d4c0f[_0x43c176(0x12c)]['id']);}async['deleteAccountLog'](_0x480ade){const _0x251fd1=_0x585947;if(!_0x480ade[_0x251fd1(0x117)][_0x251fd1(0x16e)])return!![];return await this[_0x251fd1(0x152)]['update']({'id':(0x0,typeorm_2['In'])(_0x480ade['ids'])},{'delFlag':0x1}),!![];}async['insertAccountLog'](_0x2d5f91){const _0x3f012c=_0x585947,_0x3226d8=(0x0,utils_1[_0x3f012c(0x15f)])(this['clsService']);await this['accountLogEntity']['save']({..._0x2d5f91,'saasId':_0x3226d8});}async[_0x585947(0x15b)](_0xa88726){const _0x164e0e=_0x585947;await this[_0x164e0e(0x14d)][_0x164e0e(0x174)](_0xa88726);}};function _0x344d(){const _0x539197=['changeScore4Other','Repository','\x20AND\x20al.createdAt\x20<=\x20\x27','addBalanceToOrder','accountVipLogEntity','toFixed','findOne','maskEmail','4188825SFledu','accountLogEntity','1439564NqQjgI','../user/user.service','decorate','saveCommissionAmount','days','CramiPackageEntity','phone','myPage','insertAccountVipLog','SalesService','HttpException','increase','getReqSaasId','commissionAmount','../../common/constants/balance.constant','2TBINyt','nestjs-cls','email','AccountLogEntity','447080WOnVeI','clsService','AccountVipLogEntity','UserService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','query','name','score','length','\x20AND\x20al.userId\x20=\x20','6qrOkut','Inject','isSuper','object','save','非法操作、当前充值套餐暂不存在！','cramiPackageEntity','salesService','%\x27\x20)','../sales/salesUsers.entity','error:\x20','connection','salesUsersEntity','ids','Connection','userPage','getOwnPropertyDescriptor','81906QgNWbv','138232zWQEUq','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','log','defineProperty','total','\x20AND\x20al.createdAt\x20>=\x20\x27','design:paramtypes','userService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','updateVipExpire','578061ywCXtt','__decorate','EChangeType','UserBalanceService','__param','user','BAD_REQUEST','购买套餐：','forEach','<\x200','1983230qfVCAq','@nestjs/common','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','InjectRepository','createSalesRecords','\x20AND\x20al.saasId\x20=\x20','isManage','ClsService','count','metadata','HttpStatus','./accountVipLog.entity','PurchasePackage','购买套餐:\x20','typeorm','./accountLog.entity','getUserById','Injectable','forwardRef','充值失败！','\x0a\x20\x20\x20\x20','invitedBy','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'];_0x344d=function(){return _0x539197;};return _0x344d();}UserBalanceService=__decorate([(0x0,common_1[_0x585947(0x142)])(),__param(0x0,(0x0,typeorm_1[_0x585947(0x134)])(accountLog_entity_1[_0x585947(0x165)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(accountVipLog_entity_1[_0x585947(0x168)])),__param(0x2,(0x0,typeorm_1[_0x585947(0x134)])(cramiPackage_entity_1[_0x585947(0x158)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x4,(0x0,common_1[_0x585947(0x171)])((0x0,common_1[_0x585947(0x143)])(()=>user_service_1['UserService']))),__metadata(_0x585947(0x122),[typeorm_2[_0x585947(0x14a)],typeorm_2['Repository'],typeorm_2[_0x585947(0x14a)],typeorm_2[_0x585947(0x14a)],user_service_1[_0x585947(0x169)],sales_service_1[_0x585947(0x15c)],nestjs_cls_1[_0x585947(0x138)],typeorm_2[_0x585947(0x118)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;