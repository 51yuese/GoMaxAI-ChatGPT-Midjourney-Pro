'use strict';function _0x5acc(_0x2e9dbd,_0x15fada){const _0x29a343=_0x29a3();return _0x5acc=function(_0x5acc39,_0x4d9607){_0x5acc39=_0x5acc39-0x162;let _0x5d2beb=_0x29a343[_0x5acc39];return _0x5d2beb;},_0x5acc(_0x2e9dbd,_0x15fada);}const _0x41aa9e=_0x5acc;(function(_0x4c9807,_0x577dd9){const _0x26381c=_0x5acc,_0x25afc2=_0x4c9807();while(!![]){try{const _0x4b3b52=parseInt(_0x26381c(0x18b))/0x1*(parseInt(_0x26381c(0x1c0))/0x2)+parseInt(_0x26381c(0x184))/0x3+-parseInt(_0x26381c(0x1b6))/0x4+-parseInt(_0x26381c(0x1a7))/0x5+parseInt(_0x26381c(0x163))/0x6*(parseInt(_0x26381c(0x19d))/0x7)+-parseInt(_0x26381c(0x165))/0x8*(-parseInt(_0x26381c(0x198))/0x9)+-parseInt(_0x26381c(0x177))/0xa;if(_0x4b3b52===_0x577dd9)break;else _0x25afc2['push'](_0x25afc2['shift']());}catch(_0x21d939){_0x25afc2['push'](_0x25afc2['shift']());}}}(_0x29a3,0x47ffd));var __decorate=this&&this[_0x41aa9e(0x18c)]||function(_0x8f52f2,_0xd2e332,_0x1c3256,_0x5a175f){const _0x28a572=_0x41aa9e;var _0x1804ea=arguments[_0x28a572(0x1b3)],_0x503dee=_0x1804ea<0x3?_0xd2e332:_0x5a175f===null?_0x5a175f=Object['getOwnPropertyDescriptor'](_0xd2e332,_0x1c3256):_0x5a175f,_0x3abcbf;if(typeof Reflect===_0x28a572(0x19f)&&typeof Reflect[_0x28a572(0x194)]===_0x28a572(0x16d))_0x503dee=Reflect[_0x28a572(0x194)](_0x8f52f2,_0xd2e332,_0x1c3256,_0x5a175f);else{for(var _0x5d5eb9=_0x8f52f2[_0x28a572(0x1b3)]-0x1;_0x5d5eb9>=0x0;_0x5d5eb9--)if(_0x3abcbf=_0x8f52f2[_0x5d5eb9])_0x503dee=(_0x1804ea<0x3?_0x3abcbf(_0x503dee):_0x1804ea>0x3?_0x3abcbf(_0xd2e332,_0x1c3256,_0x503dee):_0x3abcbf(_0xd2e332,_0x1c3256))||_0x503dee;}return _0x1804ea>0x3&&_0x503dee&&Object[_0x28a572(0x1a8)](_0xd2e332,_0x1c3256,_0x503dee),_0x503dee;},__metadata=this&&this[_0x41aa9e(0x1ad)]||function(_0x3647ce,_0x367c54){const _0x1e5150=_0x41aa9e;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x1e5150(0x16d))return Reflect[_0x1e5150(0x169)](_0x3647ce,_0x367c54);},__param=this&&this['__param']||function(_0x38a376,_0xe1d699){return function(_0x31e7e2,_0x4bd607){_0xe1d699(_0x31e7e2,_0x4bd607,_0x38a376);};};function _0x29a3(){const _0x30058d=['1347493OFwIgi','addBalanceToOrder','object','\x20AND\x20al.saasId\x20=\x20','error:\x20','salesUsersEntity','AccountLogEntity','design:paramtypes','connection','getReqSaasId','482395ZTXRYt','defineProperty','score','insertAccountVipLog','UserService','forwardRef','__metadata','ClsService','Injectable','update','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','SalesService','length','>\x200','days','2026968SQGLZG','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','increase','PurchasePackage','typeorm','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','isManage','%\x27\x20)','changeScore4Other','email','34954ZVNrFH','userPage','query','充值的订单信息:','Connection','isSuper','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','6ePSRUG','./accountVipLog.entity','1490704XEanwN','InjectRepository','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','__esModule','metadata','\x0a\x20\x20\x20\x20','AccountVipLogEntity','log','function','CramiPackageEntity','../../common/constants/balance.constant','Repository','HttpException','total','deleteAccountLog','insertAccountLog','toFixed','forEach','1616390XCHETA','购买套餐:\x20','<\x200','name','\x20OFFSET\x20','HttpStatus','\x20AND\x20al.createdAt\x20<=\x20\x27','getUserById','\x20AND\x20al.change_score\x20','nestjs-cls','EChangeType','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','UserBalanceService','382731lXwNfW','userService','../crami/cramiPackage.entity','invitedBy','accountLogEntity','accountVipLogEntity','cramiPackageEntity','21YfQMfv','__decorate','Inject','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','phone','\x20AND\x20al.change_type\x20=\x20','clsService','../sales/salesUsers.entity','ids','decorate','salesService','getUserByInviteCode','\x20AND\x20al.createdAt\x20>=\x20\x27','18GkWOlr','commissionAmount','../user/user.service','updateVipExpire','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'];_0x29a3=function(){return _0x30058d;};return _0x29a3();}Object[_0x41aa9e(0x1a8)](exports,_0x41aa9e(0x168),{'value':!![]}),exports[_0x41aa9e(0x183)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),common_1=require('@nestjs/common'),typeorm_2=require(_0x41aa9e(0x1ba)),balance_constant_1=require(_0x41aa9e(0x16f)),accountLog_entity_1=require('./accountLog.entity'),cramiPackage_entity_1=require(_0x41aa9e(0x186)),salesUsers_entity_1=require(_0x41aa9e(0x192)),sales_service_1=require('../sales/sales.service'),user_service_1=require(_0x41aa9e(0x19a)),accountVipLog_entity_1=require(_0x41aa9e(0x164)),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x41aa9e(0x180));let UserBalanceService=class UserBalanceService{constructor(_0x8cb92c,_0x2afaf1,_0x4ee100,_0x3037d4,_0x53531e,_0x438b01,_0x3be0a2,_0x53a49b){const _0xcf658f=_0x41aa9e;this[_0xcf658f(0x188)]=_0x8cb92c,this[_0xcf658f(0x189)]=_0x2afaf1,this[_0xcf658f(0x18a)]=_0x4ee100,this[_0xcf658f(0x1a2)]=_0x3037d4,this['userService']=_0x53531e,this[_0xcf658f(0x195)]=_0x438b01,this[_0xcf658f(0x191)]=_0x3be0a2,this[_0xcf658f(0x1a5)]=_0x53a49b;}async[_0x41aa9e(0x19e)](_0x49c693){const _0xb114c=_0x41aa9e;console[_0xb114c(0x16c)](_0xb114c(0x1c3),_0x49c693);try{const {userId:_0x2eca66,goodsId:_0x40f5a9}=_0x49c693,_0x515ac6=await this[_0xb114c(0x18a)]['findOne']({'where':{'id':_0x40f5a9,'status':0x1}});if(!_0x515ac6)throw new common_1[(_0xb114c(0x171))]('非法操作、当前充值套餐暂不存在！',common_1[_0xb114c(0x17c)]['BAD_REQUEST']);const _0x5a9bbc=await this[_0xb114c(0x185)][_0xb114c(0x17e)](_0x2eca66);_0x515ac6[_0xb114c(0x1a9)]>0x0&&await this[_0xb114c(0x185)][_0xb114c(0x1be)](_0x5a9bbc,balance_constant_1[_0xb114c(0x181)][_0xb114c(0x1b9)],_0x515ac6['score'],'购买套餐：'+_0x515ac6[_0xb114c(0x17a)],_0x515ac6['id']);_0x515ac6[_0xb114c(0x1b5)]!==0x0&&await this['userService'][_0xb114c(0x19b)](_0x5a9bbc,balance_constant_1[_0xb114c(0x181)]['PurchasePackage'],_0x515ac6['days'],_0xb114c(0x178)+_0x515ac6[_0xb114c(0x17a)],_0x515ac6['id']);if(_0x5a9bbc[_0xb114c(0x187)]){const _0x4b80c2=await this[_0xb114c(0x185)][_0xb114c(0x196)](_0x5a9bbc[_0xb114c(0x187)]);if(!_0x4b80c2)return;const _0x189a05=await this[_0xb114c(0x1a2)]['findOne']({'where':{'userId':_0x4b80c2['id']}}),{id:_0x169739}=_0x4b80c2,{performanceRatio:_0x1da244}=_0x189a05,_0x3d2c08={'inviterUserId':_0x169739,'inviteeUserId':_0x2eca66,'orderId':_0x49c693['id'],'orderPrice':_0x49c693[_0xb114c(0x172)],'commissionPercentage':_0x1da244,'commissionAmount':(_0x49c693[_0xb114c(0x172)]*_0x1da244/0x64)[_0xb114c(0x175)](0x2)};await this['salesService']['createSalesRecords'](_0x3d2c08),await this['salesService']['saveCommissionAmount'](_0x169739,_0x3d2c08[_0xb114c(0x199)]);}}catch(_0x1bc690){console['log'](_0xb114c(0x1a1),_0x1bc690);throw new common_1[(_0xb114c(0x171))]('充值失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async['userPage'](_0x18d749,_0x83602b,_0x3bde7e){const _0x21ebec=_0x41aa9e,_0x57532b=(0x0,utils_1[_0x21ebec(0x1a6)])(this[_0x21ebec(0x191)]),{page:page=0x1,size:size=0x14,startTime:_0x2797ee,endTime:_0xa1d98e,keyword:_0x1f1448,saasId:_0x393e22,changeType:_0x10df5d,creaseType:_0x26255d}=_0x83602b;let _0xa34c70=_0x21ebec(0x19c)+(_0x3bde7e?'\x20AND\x20al.userId\x20=\x20'+_0x3bde7e:'')+_0x21ebec(0x18e)+(_0x10df5d?_0x21ebec(0x190)+_0x10df5d:'')+_0x21ebec(0x18e)+(_0x26255d?_0x21ebec(0x17f)+(_0x26255d===_0x21ebec(0x1b8)?_0x21ebec(0x1b4):_0x21ebec(0x179)):'')+_0x21ebec(0x18e)+(_0x2797ee?_0x21ebec(0x197)+_0x2797ee+'\x27':'')+_0x21ebec(0x18e)+(_0xa1d98e?_0x21ebec(0x17d)+_0xa1d98e+'\x27':'')+_0x21ebec(0x18e)+(_0x1f1448?_0x21ebec(0x1bb)+_0x1f1448+_0x21ebec(0x167)+_0x1f1448+_0x21ebec(0x1b1)+_0x1f1448+_0x21ebec(0x162)+_0x1f1448+_0x21ebec(0x1bd):'')+'\x0a\x20\x20\x20\x20';(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1[_0x21ebec(0x1bc)])(this['clsService'])&&_0x393e22&&(_0xa34c70=_0xa34c70+(_0x21ebec(0x1a0)+_0x393e22)):_0xa34c70=_0xa34c70+(_0x21ebec(0x1a0)+_0x57532b);const _0x53ff23='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0xa34c70+_0x21ebec(0x16a),_0x2cddc1=_0x21ebec(0x182)+_0xa34c70+_0x21ebec(0x1b7)+size+_0x21ebec(0x17b)+(page-0x1)*size+'\x0a\x20\x20\x20\x20',_0x7e3481=await this[_0x21ebec(0x1a5)]['query'](_0x53ff23),_0x2d5620=await this[_0x21ebec(0x1a5)][_0x21ebec(0x1c2)](_0x2cddc1);return!(0x0,utils_1[_0x21ebec(0x1c5)])(this[_0x21ebec(0x191)])&&_0x2d5620[_0x21ebec(0x176)](_0x538f41=>{const _0x4411a0=_0x21ebec;_0x538f41['email']=(0x0,utils_1['maskEmail'])(_0x538f41[_0x4411a0(0x1bf)]),_0x538f41[_0x4411a0(0x18f)]=(0x0,utils_1['maskEmail'])(_0x538f41[_0x4411a0(0x18f)]);}),{'rows':_0x2d5620,'count':Number(_0x7e3481[0x0]?.['count']||0x0)};}async['myPage'](_0x1acc36,_0x500574){const _0xe894f3=_0x41aa9e;return this[_0xe894f3(0x1c1)](_0x1acc36,_0x500574,_0x1acc36['user']['id']);}async[_0x41aa9e(0x173)](_0x217bdc){const _0x1bafc5=_0x41aa9e;if(!_0x217bdc[_0x1bafc5(0x193)]['length'])return!![];return await this[_0x1bafc5(0x188)][_0x1bafc5(0x1b0)]({'id':(0x0,typeorm_2['In'])(_0x217bdc['ids'])},{'delFlag':0x1}),!![];}async[_0x41aa9e(0x174)](_0x5cdd3e){const _0x13c0e4=_0x41aa9e,_0x400e14=(0x0,utils_1[_0x13c0e4(0x1a6)])(this[_0x13c0e4(0x191)]);await this['accountLogEntity']['save']({..._0x5cdd3e,'saasId':_0x400e14});}async[_0x41aa9e(0x1aa)](_0x58b3ab){await this['accountVipLogEntity']['save'](_0x58b3ab);}};UserBalanceService=__decorate([(0x0,common_1[_0x41aa9e(0x1af)])(),__param(0x0,(0x0,typeorm_1[_0x41aa9e(0x166)])(accountLog_entity_1[_0x41aa9e(0x1a3)])),__param(0x1,(0x0,typeorm_1[_0x41aa9e(0x166)])(accountVipLog_entity_1[_0x41aa9e(0x16b)])),__param(0x2,(0x0,typeorm_1[_0x41aa9e(0x166)])(cramiPackage_entity_1[_0x41aa9e(0x16e)])),__param(0x3,(0x0,typeorm_1[_0x41aa9e(0x166)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x4,(0x0,common_1[_0x41aa9e(0x18d)])((0x0,common_1[_0x41aa9e(0x1ac)])(()=>user_service_1[_0x41aa9e(0x1ab)]))),__metadata(_0x41aa9e(0x1a4),[typeorm_2[_0x41aa9e(0x170)],typeorm_2[_0x41aa9e(0x170)],typeorm_2['Repository'],typeorm_2[_0x41aa9e(0x170)],user_service_1[_0x41aa9e(0x1ab)],sales_service_1[_0x41aa9e(0x1b2)],nestjs_cls_1[_0x41aa9e(0x1ae)],typeorm_2[_0x41aa9e(0x1c4)]])],UserBalanceService),exports[_0x41aa9e(0x183)]=UserBalanceService;