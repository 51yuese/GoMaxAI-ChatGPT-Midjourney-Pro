'use strict';function _0x27de(){const _0x4e611a=['11wEyzTf','>\x200','nestjs-cls','name','maskEmail','HttpStatus','clsService','充值的订单信息:','length','719898PgQggF','10695sDcRaH','getReqSaasId','__esModule','\x20AND\x20al.change_score\x20','ids','user','UserBalanceService','invitedBy','Repository','phone','query','forEach','createSalesRecords','design:paramtypes','3953979vFjZcm','EChangeType','购买套餐:\x20','isSuper','\x20AND\x20al.change_type\x20=\x20','SalesService','../sales/salesUsers.entity','typeorm','Injectable','forwardRef','BAD_REQUEST','userPage','connection','6723384mTpUTt','__decorate','9GrzbQK','saveCommissionAmount','%\x27\x20)','HttpException','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','days','insertAccountLog','decorate','\x20AND\x20al.saasId\x20=\x20','update','function','salesService','findOne','8141qfvVmX','../../common/utils','__param','../user/user.service','1403276GOSGQW','ClsService','购买套餐：','./accountLog.entity','../sales/sales.service','@nestjs/common','salesUsersEntity','log','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','CramiPackageEntity','object','cramiPackageEntity','1656BZJsEC','accountVipLogEntity','getUserById','PurchasePackage','<\x200','\x0a\x20\x20\x20\x20','increase','非法操作、当前充值套餐暂不存在！','Connection','metadata','save','accountLogEntity','\x20AND\x20al.createdAt\x20>=\x20\x27','SalesUsersEntity','Inject','55053340JQgFzt','count','defineProperty','email','score','toFixed','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','updateVipExpire','insertAccountVipLog','474NiRCCZ','./accountVipLog.entity','\x20AND\x20al.userId\x20=\x20','changeScore4Other','userType','userService','isPlatform','InjectRepository'];_0x27de=function(){return _0x4e611a;};return _0x27de();}const _0x4c6d22=_0x15da;(function(_0x1d953c,_0x1efadb){const _0x236ee9=_0x15da,_0x17f364=_0x1d953c();while(!![]){try{const _0x4004b9=-parseInt(_0x236ee9(0x134))/0x1+parseInt(_0x236ee9(0x169))/0x2*(-parseInt(_0x236ee9(0x123))/0x3)+-parseInt(_0x236ee9(0x121))/0x4+parseInt(_0x236ee9(0x106))/0x5*(-parseInt(_0x236ee9(0x158))/0x6)+parseInt(_0x236ee9(0x130))/0x7*(parseInt(_0x236ee9(0x140))/0x8)+-parseInt(_0x236ee9(0x114))/0x9+-parseInt(_0x236ee9(0x14f))/0xa*(-parseInt(_0x236ee9(0x160))/0xb);if(_0x4004b9===_0x1efadb)break;else _0x17f364['push'](_0x17f364['shift']());}catch(_0x27a071){_0x17f364['push'](_0x17f364['shift']());}}}(_0x27de,0xedbe2));var __decorate=this&&this[_0x4c6d22(0x122)]||function(_0x3b1c09,_0x3d15f7,_0x4cc0b1,_0x29a2e3){const _0x16d453=_0x4c6d22;var _0x43cd33=arguments[_0x16d453(0x168)],_0x3b35ba=_0x43cd33<0x3?_0x3d15f7:_0x29a2e3===null?_0x29a2e3=Object['getOwnPropertyDescriptor'](_0x3d15f7,_0x4cc0b1):_0x29a2e3,_0x31dee0;if(typeof Reflect===_0x16d453(0x13e)&&typeof Reflect[_0x16d453(0x12a)]===_0x16d453(0x12d))_0x3b35ba=Reflect['decorate'](_0x3b1c09,_0x3d15f7,_0x4cc0b1,_0x29a2e3);else{for(var _0x4b0731=_0x3b1c09[_0x16d453(0x168)]-0x1;_0x4b0731>=0x0;_0x4b0731--)if(_0x31dee0=_0x3b1c09[_0x4b0731])_0x3b35ba=(_0x43cd33<0x3?_0x31dee0(_0x3b35ba):_0x43cd33>0x3?_0x31dee0(_0x3d15f7,_0x4cc0b1,_0x3b35ba):_0x31dee0(_0x3d15f7,_0x4cc0b1))||_0x3b35ba;}return _0x43cd33>0x3&&_0x3b35ba&&Object[_0x16d453(0x151)](_0x3d15f7,_0x4cc0b1,_0x3b35ba),_0x3b35ba;},__metadata=this&&this['__metadata']||function(_0x524605,_0x118c20){const _0x4c633f=_0x4c6d22;if(typeof Reflect===_0x4c633f(0x13e)&&typeof Reflect['metadata']==='function')return Reflect[_0x4c633f(0x149)](_0x524605,_0x118c20);},__param=this&&this[_0x4c6d22(0x132)]||function(_0x23909e,_0x3d121c){return function(_0x38e7d7,_0x2861ba){_0x3d121c(_0x38e7d7,_0x2861ba,_0x23909e);};};Object[_0x4c6d22(0x151)](exports,_0x4c6d22(0x108),{'value':!![]}),exports[_0x4c6d22(0x10c)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x4c6d22(0x139)),typeorm_2=require(_0x4c6d22(0x11b)),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x4c6d22(0x137)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),salesUsers_entity_1=require(_0x4c6d22(0x11a)),sales_service_1=require(_0x4c6d22(0x138)),user_service_1=require(_0x4c6d22(0x133)),accountVipLog_entity_1=require(_0x4c6d22(0x159)),utils_1=require(_0x4c6d22(0x131)),nestjs_cls_1=require(_0x4c6d22(0x162));let UserBalanceService=class UserBalanceService{constructor(_0x4b82cc,_0x24c6d0,_0x537284,_0xa4559c,_0x5a16a8,_0x46e15,_0x4cdeb8,_0x436c65){const _0x2d6fd4=_0x4c6d22;this[_0x2d6fd4(0x14b)]=_0x4b82cc,this['accountVipLogEntity']=_0x24c6d0,this[_0x2d6fd4(0x13f)]=_0x537284,this[_0x2d6fd4(0x13a)]=_0xa4559c,this[_0x2d6fd4(0x15d)]=_0x5a16a8,this[_0x2d6fd4(0x12e)]=_0x46e15,this[_0x2d6fd4(0x166)]=_0x4cdeb8,this[_0x2d6fd4(0x120)]=_0x436c65;}async['addBalanceToOrder'](_0x51e324){const _0x1ab7ad=_0x4c6d22;console['log'](_0x1ab7ad(0x167),_0x51e324);try{const {userId:_0x3f5cdc,goodsId:_0x18add8}=_0x51e324,_0xd128fc=await this[_0x1ab7ad(0x13f)][_0x1ab7ad(0x12f)]({'where':{'id':_0x18add8,'status':0x1}});if(!_0xd128fc)throw new common_1[(_0x1ab7ad(0x126))](_0x1ab7ad(0x147),common_1[_0x1ab7ad(0x165)][_0x1ab7ad(0x11e)]);const _0x38be0f=await this[_0x1ab7ad(0x15d)][_0x1ab7ad(0x142)](_0x3f5cdc);_0xd128fc[_0x1ab7ad(0x153)]>0x0&&await this['userService'][_0x1ab7ad(0x15b)](_0x38be0f,balance_constant_1[_0x1ab7ad(0x115)][_0x1ab7ad(0x143)],_0xd128fc[_0x1ab7ad(0x153)],_0x1ab7ad(0x136)+_0xd128fc[_0x1ab7ad(0x163)],_0xd128fc['id']);_0xd128fc['days']!==0x0&&await this['userService'][_0x1ab7ad(0x156)](_0x38be0f,balance_constant_1['EChangeType'][_0x1ab7ad(0x143)],_0xd128fc[_0x1ab7ad(0x128)],_0x1ab7ad(0x116)+_0xd128fc[_0x1ab7ad(0x163)],_0xd128fc['id']);_0xd128fc[_0x1ab7ad(0x15c)]&&await this['userService']['updateVipType'](_0x38be0f,parseInt(_0xd128fc[_0x1ab7ad(0x15c)]));if(_0x38be0f[_0x1ab7ad(0x10d)]){const _0x24c9c3=await this[_0x1ab7ad(0x15d)]['getUserByInviteCode'](_0x38be0f[_0x1ab7ad(0x10d)]);if(!_0x24c9c3)return;const _0x2d8b85=await this['salesUsersEntity'][_0x1ab7ad(0x12f)]({'where':{'userId':_0x24c9c3['id']}}),{id:_0x441b9b}=_0x24c9c3,{performanceRatio:_0x4c7c03}=_0x2d8b85,_0x2a013e={'inviterUserId':_0x441b9b,'inviteeUserId':_0x3f5cdc,'orderId':_0x51e324['id'],'orderPrice':_0x51e324['total'],'commissionPercentage':_0x4c7c03,'commissionAmount':(_0x51e324['total']*_0x4c7c03/0x64)[_0x1ab7ad(0x154)](0x2)};await this[_0x1ab7ad(0x12e)][_0x1ab7ad(0x112)](_0x2a013e),await this[_0x1ab7ad(0x12e)][_0x1ab7ad(0x124)](_0x441b9b,_0x2a013e['commissionAmount']);}}catch(_0x362905){console[_0x1ab7ad(0x13b)]('error:\x20',_0x362905);throw new common_1[(_0x1ab7ad(0x126))]('充值失败！',common_1['HttpStatus'][_0x1ab7ad(0x11e)]);}}async['userPage'](_0x3f639c,_0x2f842c,_0x595602){const _0x33a9d7=_0x4c6d22,_0x6c6eea=(0x0,utils_1[_0x33a9d7(0x107)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0xeb3c59,endTime:_0x138082,keyword:_0x42156a,saasId:_0x1d4885,changeType:_0x27f93f,creaseType:_0x32fa36}=_0x2f842c;let _0x1297a6='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x595602?_0x33a9d7(0x15a)+_0x595602:'')+_0x33a9d7(0x155)+(_0x27f93f?_0x33a9d7(0x118)+_0x27f93f:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x32fa36?_0x33a9d7(0x109)+(_0x32fa36===_0x33a9d7(0x146)?_0x33a9d7(0x161):_0x33a9d7(0x144)):'')+_0x33a9d7(0x155)+(_0xeb3c59?_0x33a9d7(0x14c)+_0xeb3c59+'\x27':'')+_0x33a9d7(0x155)+(_0x138082?'\x20AND\x20al.createdAt\x20<=\x20\x27'+_0x138082+'\x27':'')+_0x33a9d7(0x155)+(_0x42156a?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x42156a+'%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%'+_0x42156a+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x42156a+_0x33a9d7(0x127)+_0x42156a+_0x33a9d7(0x125):'')+_0x33a9d7(0x145);(0x0,utils_1[_0x33a9d7(0x15e)])(this[_0x33a9d7(0x166)])?(0x0,utils_1['isManage'])(this[_0x33a9d7(0x166)])&&_0x1d4885&&(_0x1297a6=_0x1297a6+(_0x33a9d7(0x12b)+_0x1d4885)):_0x1297a6=_0x1297a6+('\x20AND\x20al.saasId\x20=\x20'+_0x6c6eea);const _0x46a092=_0x33a9d7(0x13c)+_0x1297a6+_0x33a9d7(0x145),_0x5cb6b7='\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x1297a6+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x33a9d7(0x145),_0x4bf59c=await this[_0x33a9d7(0x120)][_0x33a9d7(0x110)](_0x46a092),_0x53ed86=await this[_0x33a9d7(0x120)]['query'](_0x5cb6b7);return!(0x0,utils_1[_0x33a9d7(0x117)])(this[_0x33a9d7(0x166)])&&_0x53ed86[_0x33a9d7(0x111)](_0x594b81=>{const _0xe069e6=_0x33a9d7;_0x594b81[_0xe069e6(0x152)]=(0x0,utils_1[_0xe069e6(0x164)])(_0x594b81[_0xe069e6(0x152)]),_0x594b81['phone']=(0x0,utils_1[_0xe069e6(0x164)])(_0x594b81[_0xe069e6(0x10f)]);}),{'rows':_0x53ed86,'count':Number(_0x4bf59c[0x0]?.[_0x33a9d7(0x150)]||0x0)};}async['myPage'](_0x1d086f,_0x1c6110){const _0x28c4cd=_0x4c6d22;return this[_0x28c4cd(0x11f)](_0x1d086f,_0x1c6110,_0x1d086f[_0x28c4cd(0x10b)]['id']);}async['deleteAccountLog'](_0x39275e){const _0x9d652=_0x4c6d22;if(!_0x39275e[_0x9d652(0x10a)][_0x9d652(0x168)])return!![];return await this[_0x9d652(0x14b)][_0x9d652(0x12c)]({'id':(0x0,typeorm_2['In'])(_0x39275e[_0x9d652(0x10a)])},{'delFlag':0x1}),!![];}async[_0x4c6d22(0x129)](_0x3ac797){const _0x5f0606=_0x4c6d22,_0x3b9d6a=(0x0,utils_1[_0x5f0606(0x107)])(this[_0x5f0606(0x166)]);await this[_0x5f0606(0x14b)][_0x5f0606(0x14a)]({..._0x3ac797,'saasId':_0x3b9d6a});}async[_0x4c6d22(0x157)](_0x1606d0){const _0x1b8f72=_0x4c6d22;await this[_0x1b8f72(0x141)][_0x1b8f72(0x14a)](_0x1606d0);}};function _0x15da(_0x442bd2,_0x3bf529){const _0x27ded2=_0x27de();return _0x15da=function(_0x15da0f,_0x35ab62){_0x15da0f=_0x15da0f-0x106;let _0x1cba79=_0x27ded2[_0x15da0f];return _0x1cba79;},_0x15da(_0x442bd2,_0x3bf529);}UserBalanceService=__decorate([(0x0,common_1[_0x4c6d22(0x11c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1['AccountLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x4c6d22(0x15f)])(accountVipLog_entity_1['AccountVipLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x4c6d22(0x15f)])(cramiPackage_entity_1[_0x4c6d22(0x13d)])),__param(0x3,(0x0,typeorm_1[_0x4c6d22(0x15f)])(salesUsers_entity_1[_0x4c6d22(0x14d)])),__param(0x4,(0x0,common_1[_0x4c6d22(0x14e)])((0x0,common_1[_0x4c6d22(0x11d)])(()=>user_service_1['UserService']))),__metadata(_0x4c6d22(0x113),[typeorm_2[_0x4c6d22(0x10e)],typeorm_2[_0x4c6d22(0x10e)],typeorm_2[_0x4c6d22(0x10e)],typeorm_2[_0x4c6d22(0x10e)],user_service_1['UserService'],sales_service_1[_0x4c6d22(0x119)],nestjs_cls_1[_0x4c6d22(0x135)],typeorm_2[_0x4c6d22(0x148)]])],UserBalanceService),exports[_0x4c6d22(0x10c)]=UserBalanceService;