'use strict';const _0x581e90=_0x4b22;function _0x2018(){const _0x4d8478=['__metadata','accountLogEntity','Repository','design:paramtypes','length','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','myPage','typeorm','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','salesUsersEntity','isManage','save','isSuper','432864fqsBbu','../crami/cramiPackage.entity','score','update','changeScore4Other','5868QVggpH','function','../sales/sales.service','EChangeType','购买套餐:\x20','\x20AND\x20al.change_score\x20','22805xIXKPB','accountVipLogEntity','76561MRvQJy','Injectable','days','PurchasePackage','forEach','../sales/salesUsers.entity','invitedBy','insertAccountVipLog','isPlatform','%\x27\x20)','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','cramiPackageEntity','metadata','commissionAmount','getOwnPropertyDescriptor','ids','UserBalanceService','SalesUsersEntity','\x20AND\x20al.createdAt\x20>=\x20\x27','user','236264vzWuoz','deleteAccountLog','userPage','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','充值的订单信息:','@nestjs/common','BAD_REQUEST','HttpStatus','total','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','maskEmail','\x20AND\x20al.saasId\x20=\x20','query','addBalanceToOrder','createSalesRecords','./accountVipLog.entity','63193960CBYczc','userService','__decorate','phone','connection','count','name','279zjUWUM','\x20AND\x20al.change_type\x20=\x20','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','decorate','11256jxgGfh','salesService','../../common/utils','insertAccountLog','getUserById','../../common/constants/balance.constant','ClsService','Connection','CramiPackageEntity','1376eVrIxh','3810363xQglyw','log','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./accountLog.entity','InjectRepository','\x0a\x20\x20\x20\x20','clsService','defineProperty','UserService'];_0x2018=function(){return _0x4d8478;};return _0x2018();}(function(_0x4bea95,_0x4b1c97){const _0x36efd8=_0x4b22,_0x2c4238=_0x4bea95();while(!![]){try{const _0x571d9b=parseInt(_0x36efd8(0x1fd))/0x1+-parseInt(_0x36efd8(0x1f0))/0x2+-parseInt(_0x36efd8(0x1da))/0x3+parseInt(_0x36efd8(0x1d9))/0x4*(-parseInt(_0x36efd8(0x1fb))/0x5)+parseInt(_0x36efd8(0x1f5))/0x6*(-parseInt(_0x36efd8(0x1d0))/0x7)+parseInt(_0x36efd8(0x211))/0x8*(-parseInt(_0x36efd8(0x1cc))/0x9)+parseInt(_0x36efd8(0x221))/0xa;if(_0x571d9b===_0x4b1c97)break;else _0x2c4238['push'](_0x2c4238['shift']());}catch(_0x1cd5f2){_0x2c4238['push'](_0x2c4238['shift']());}}}(_0x2018,0xd0131));var __decorate=this&&this[_0x581e90(0x1c7)]||function(_0x2f211a,_0x3a7cfe,_0x7b2224,_0x282653){const _0x1a80e0=_0x581e90;var _0x108fa5=arguments[_0x1a80e0(0x1e7)],_0x3fcca4=_0x108fa5<0x3?_0x3a7cfe:_0x282653===null?_0x282653=Object[_0x1a80e0(0x20b)](_0x3a7cfe,_0x7b2224):_0x282653,_0x38cea4;if(typeof Reflect==='object'&&typeof Reflect[_0x1a80e0(0x1cf)]===_0x1a80e0(0x1f6))_0x3fcca4=Reflect['decorate'](_0x2f211a,_0x3a7cfe,_0x7b2224,_0x282653);else{for(var _0x272f66=_0x2f211a['length']-0x1;_0x272f66>=0x0;_0x272f66--)if(_0x38cea4=_0x2f211a[_0x272f66])_0x3fcca4=(_0x108fa5<0x3?_0x38cea4(_0x3fcca4):_0x108fa5>0x3?_0x38cea4(_0x3a7cfe,_0x7b2224,_0x3fcca4):_0x38cea4(_0x3a7cfe,_0x7b2224))||_0x3fcca4;}return _0x108fa5>0x3&&_0x3fcca4&&Object[_0x1a80e0(0x1e1)](_0x3a7cfe,_0x7b2224,_0x3fcca4),_0x3fcca4;},__metadata=this&&this[_0x581e90(0x1e3)]||function(_0x1de43e,_0x54362){const _0x3670d7=_0x581e90;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x3670d7(0x209)](_0x1de43e,_0x54362);},__param=this&&this['__param']||function(_0x1269ca,_0x59652b){return function(_0x4dcedb,_0x312006){_0x59652b(_0x4dcedb,_0x312006,_0x1269ca);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x581e90(0x20d)]=void 0x0;function _0x4b22(_0x10e0f8,_0x5f4475){const _0x20186e=_0x2018();return _0x4b22=function(_0x4b2254,_0x23e331){_0x4b2254=_0x4b2254-0x1c7;let _0x29a839=_0x20186e[_0x4b2254];return _0x29a839;},_0x4b22(_0x10e0f8,_0x5f4475);}const typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x581e90(0x216)),typeorm_2=require(_0x581e90(0x1ea)),balance_constant_1=require(_0x581e90(0x1d5)),accountLog_entity_1=require(_0x581e90(0x1dd)),cramiPackage_entity_1=require(_0x581e90(0x1f1)),salesUsers_entity_1=require(_0x581e90(0x202)),sales_service_1=require(_0x581e90(0x1f7)),user_service_1=require('../user/user.service'),accountVipLog_entity_1=require(_0x581e90(0x220)),utils_1=require(_0x581e90(0x1d2)),nestjs_cls_1=require('nestjs-cls');let UserBalanceService=class UserBalanceService{constructor(_0x39fa8f,_0x5d8b6b,_0xb32c2,_0x595e78,_0x138eba,_0x51448a,_0x8868a2,_0x3d6430){const _0x5842d5=_0x581e90;this[_0x5842d5(0x1e4)]=_0x39fa8f,this[_0x5842d5(0x1fc)]=_0x5d8b6b,this[_0x5842d5(0x208)]=_0xb32c2,this[_0x5842d5(0x1ec)]=_0x595e78,this[_0x5842d5(0x222)]=_0x138eba,this['salesService']=_0x51448a,this['clsService']=_0x8868a2,this[_0x5842d5(0x1c9)]=_0x3d6430;}async[_0x581e90(0x21e)](_0xb2bb2c){const _0x5f4718=_0x581e90;console[_0x5f4718(0x1db)](_0x5f4718(0x215),_0xb2bb2c);try{const {userId:_0x55c4ac,goodsId:_0x515238}=_0xb2bb2c,_0x3585f6=await this[_0x5f4718(0x208)]['findOne']({'where':{'id':_0x515238,'status':0x1}});if(!_0x3585f6)throw new common_1['HttpException']('非法操作、当前充值套餐暂不存在！',common_1[_0x5f4718(0x218)][_0x5f4718(0x217)]);const _0x569fda=await this[_0x5f4718(0x222)][_0x5f4718(0x1d4)](_0x55c4ac);_0x3585f6[_0x5f4718(0x1f2)]>0x0&&await this[_0x5f4718(0x222)][_0x5f4718(0x1f4)](_0x569fda,balance_constant_1[_0x5f4718(0x1f8)][_0x5f4718(0x200)],_0x3585f6['score'],'购买套餐：'+_0x3585f6[_0x5f4718(0x1cb)],_0x3585f6['id']);_0x3585f6[_0x5f4718(0x1ff)]!==0x0&&await this[_0x5f4718(0x222)]['updateVipExpire'](_0x569fda,balance_constant_1[_0x5f4718(0x1f8)][_0x5f4718(0x200)],_0x3585f6[_0x5f4718(0x1ff)],_0x5f4718(0x1f9)+_0x3585f6[_0x5f4718(0x1cb)],_0x3585f6['id']);if(_0x569fda[_0x5f4718(0x203)]){const _0x2442ba=await this[_0x5f4718(0x222)]['getUserByInviteCode'](_0x569fda['invitedBy']);if(!_0x2442ba)return;const _0x46be87=await this[_0x5f4718(0x1ec)]['findOne']({'where':{'userId':_0x2442ba['id']}}),{id:_0x395aef}=_0x2442ba,{performanceRatio:_0x33a0bd}=_0x46be87,_0x519e81={'inviterUserId':_0x395aef,'inviteeUserId':_0x55c4ac,'orderId':_0xb2bb2c['id'],'orderPrice':_0xb2bb2c[_0x5f4718(0x219)],'commissionPercentage':_0x33a0bd,'commissionAmount':(_0xb2bb2c[_0x5f4718(0x219)]*_0x33a0bd/0x64)['toFixed'](0x2)};await this['salesService'][_0x5f4718(0x21f)](_0x519e81),await this[_0x5f4718(0x1d1)]['saveCommissionAmount'](_0x395aef,_0x519e81[_0x5f4718(0x20a)]);}}catch(_0x34aa89){console[_0x5f4718(0x1db)]('error:\x20',_0x34aa89);throw new common_1['HttpException']('充值失败！',common_1['HttpStatus'][_0x5f4718(0x217)]);}}async[_0x581e90(0x213)](_0x616b07,_0x1e73e8,_0x3d0fb5){const _0x5ef78c=_0x581e90,_0x2f6da9=(0x0,utils_1['getReqSaasId'])(this[_0x5ef78c(0x1e0)]),{page:page=0x1,size:size=0x14,startTime:_0x398315,endTime:_0x484ad8,keyword:_0x34b09e,saasId:_0x21fb04,changeType:_0x202c0d,creaseType:_0x2a146f}=_0x1e73e8;let _0x21a82a=_0x5ef78c(0x1dc)+(_0x3d0fb5?'\x20AND\x20al.userId\x20=\x20'+_0x3d0fb5:'')+_0x5ef78c(0x21a)+(_0x202c0d?_0x5ef78c(0x1cd)+_0x202c0d:'')+_0x5ef78c(0x21a)+(_0x2a146f?_0x5ef78c(0x1fa)+(_0x2a146f==='increase'?'>\x200':'<\x200'):'')+_0x5ef78c(0x21a)+(_0x398315?_0x5ef78c(0x20f)+_0x398315+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x484ad8?'\x20AND\x20al.createdAt\x20<=\x20\x27'+_0x484ad8+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x34b09e?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x34b09e+_0x5ef78c(0x214)+_0x34b09e+_0x5ef78c(0x1ce)+_0x34b09e+_0x5ef78c(0x207)+_0x34b09e+_0x5ef78c(0x206):'')+_0x5ef78c(0x1df);(0x0,utils_1[_0x5ef78c(0x205)])(this[_0x5ef78c(0x1e0)])?(0x0,utils_1[_0x5ef78c(0x1ed)])(this[_0x5ef78c(0x1e0)])&&_0x21fb04&&(_0x21a82a=_0x21a82a+(_0x5ef78c(0x21c)+_0x21fb04)):_0x21a82a=_0x21a82a+(_0x5ef78c(0x21c)+_0x2f6da9);const _0x5acf94='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x21a82a+_0x5ef78c(0x1df),_0x522e7a=_0x5ef78c(0x1e8)+_0x21a82a+_0x5ef78c(0x1eb)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x5ef78c(0x1df),_0x22ecde=await this[_0x5ef78c(0x1c9)][_0x5ef78c(0x21d)](_0x5acf94),_0x2cbab5=await this[_0x5ef78c(0x1c9)][_0x5ef78c(0x21d)](_0x522e7a);return!(0x0,utils_1[_0x5ef78c(0x1ef)])(this[_0x5ef78c(0x1e0)])&&_0x2cbab5[_0x5ef78c(0x201)](_0xcebe2f=>{const _0x570f2d=_0x5ef78c;_0xcebe2f['email']=(0x0,utils_1[_0x570f2d(0x21b)])(_0xcebe2f['email']),_0xcebe2f['phone']=(0x0,utils_1[_0x570f2d(0x21b)])(_0xcebe2f[_0x570f2d(0x1c8)]);}),{'rows':_0x2cbab5,'count':Number(_0x22ecde[0x0]?.[_0x5ef78c(0x1ca)]||0x0)};}async[_0x581e90(0x1e9)](_0x41bdbd,_0xee36cf){const _0x38cb3e=_0x581e90;return this[_0x38cb3e(0x213)](_0x41bdbd,_0xee36cf,_0x41bdbd[_0x38cb3e(0x210)]['id']);}async[_0x581e90(0x212)](_0x29a015){const _0x3c5613=_0x581e90;if(!_0x29a015[_0x3c5613(0x20c)][_0x3c5613(0x1e7)])return!![];return await this[_0x3c5613(0x1e4)][_0x3c5613(0x1f3)]({'id':(0x0,typeorm_2['In'])(_0x29a015[_0x3c5613(0x20c)])},{'delFlag':0x1}),!![];}async[_0x581e90(0x1d3)](_0xd7ff2b){const _0x6874b3=_0x581e90,_0x40c77c=(0x0,utils_1['getReqSaasId'])(this[_0x6874b3(0x1e0)]);await this[_0x6874b3(0x1e4)][_0x6874b3(0x1ee)]({..._0xd7ff2b,'saasId':_0x40c77c});}async[_0x581e90(0x204)](_0x1d8907){const _0x35400a=_0x581e90;await this[_0x35400a(0x1fc)][_0x35400a(0x1ee)](_0x1d8907);}};UserBalanceService=__decorate([(0x0,common_1[_0x581e90(0x1fe)])(),__param(0x0,(0x0,typeorm_1[_0x581e90(0x1de)])(accountLog_entity_1['AccountLogEntity'])),__param(0x1,(0x0,typeorm_1[_0x581e90(0x1de)])(accountVipLog_entity_1['AccountVipLogEntity'])),__param(0x2,(0x0,typeorm_1[_0x581e90(0x1de)])(cramiPackage_entity_1[_0x581e90(0x1d8)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x581e90(0x20e)])),__param(0x4,(0x0,common_1['Inject'])((0x0,common_1['forwardRef'])(()=>user_service_1['UserService']))),__metadata(_0x581e90(0x1e6),[typeorm_2[_0x581e90(0x1e5)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x581e90(0x1e5)],user_service_1[_0x581e90(0x1e2)],sales_service_1['SalesService'],nestjs_cls_1[_0x581e90(0x1d6)],typeorm_2[_0x581e90(0x1d7)]])],UserBalanceService),exports[_0x581e90(0x20d)]=UserBalanceService;