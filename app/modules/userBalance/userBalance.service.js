'use strict';function _0x43ac(_0x427b3e,_0x4d2944){const _0x3226ef=_0x3226();return _0x43ac=function(_0x43ac6f,_0x1ed9f1){_0x43ac6f=_0x43ac6f-0xb6;let _0x3c3b01=_0x3226ef[_0x43ac6f];return _0x3c3b01;},_0x43ac(_0x427b3e,_0x4d2944);}const _0x50617e=_0x43ac;function _0x3226(){const _0x27ebcc=['3999560BPaWJV','increase','SalesService','phone','160AQsrVC','HttpException','findOne','@nestjs/typeorm','20zPxcuD','log','save','HttpStatus','decorate','../user/user.service','name','../sales/salesUsers.entity','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getUserById','<\x200','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','__esModule','metadata','ids','Connection','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../../common/constants/balance.constant','addBalanceToOrder','getReqSaasId','accountLogEntity','10265715kFXraW','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','userPage','964383lAPABI','\x0a\x20\x20\x20\x20','getOwnPropertyDescriptor','createSalesRecords','AccountVipLogEntity','score','\x20AND\x20al.createdAt\x20>=\x20\x27','PurchasePackage','3756948iBrMtV','length','UserService','ClsService','update','CramiPackageEntity','object','function','deleteAccountLog','__metadata','forwardRef','__param','accountVipLogEntity','%\x27\x20)','total','购买套餐:\x20','maskEmail','124fSAEkH','\x20OFFSET\x20','userService','UserBalanceService','query','Inject','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','InjectRepository','\x20AND\x20al.createdAt\x20<=\x20\x27','112451xishkh','\x20AND\x20al.change_type\x20=\x20','saveCommissionAmount','\x20AND\x20al.saasId\x20=\x20','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','design:paramtypes','./accountVipLog.entity','myPage','commissionAmount','Repository','481796PJBlmj','isPlatform','insertAccountLog','getUserByInviteCode','connection','salesService','invitedBy','toFixed','clsService','133415iJwUhZ','typeorm','AccountLogEntity','@nestjs/common','defineProperty','email','../sales/sales.service','../crami/cramiPackage.entity','../../common/utils'];_0x3226=function(){return _0x27ebcc;};return _0x3226();}(function(_0x17634b,_0x13aa47){const _0x534868=_0x43ac,_0x20bbd4=_0x17634b();while(!![]){try{const _0x411239=-parseInt(_0x534868(0xf7))/0x1*(-parseInt(_0x534868(0xbc))/0x2)+parseInt(_0x534868(0xd4))/0x3+-parseInt(_0x534868(0xed))/0x4*(-parseInt(_0x534868(0x10a))/0x5)+parseInt(_0x534868(0xdc))/0x6+-parseInt(_0x534868(0x101))/0x7*(parseInt(_0x534868(0xb8))/0x8)+-parseInt(_0x534868(0xd1))/0x9+parseInt(_0x534868(0x113))/0xa;if(_0x411239===_0x13aa47)break;else _0x20bbd4['push'](_0x20bbd4['shift']());}catch(_0x4ac223){_0x20bbd4['push'](_0x20bbd4['shift']());}}}(_0x3226,0xbeeef));var __decorate=this&&this['__decorate']||function(_0x45822d,_0x2d1213,_0x35e160,_0x37a9ac){const _0x3aa0e6=_0x43ac;var _0x52c5c5=arguments[_0x3aa0e6(0xdd)],_0x168995=_0x52c5c5<0x3?_0x2d1213:_0x37a9ac===null?_0x37a9ac=Object[_0x3aa0e6(0xd6)](_0x2d1213,_0x35e160):_0x37a9ac,_0x581ed0;if(typeof Reflect==='object'&&typeof Reflect[_0x3aa0e6(0xc0)]===_0x3aa0e6(0xe3))_0x168995=Reflect[_0x3aa0e6(0xc0)](_0x45822d,_0x2d1213,_0x35e160,_0x37a9ac);else{for(var _0x17ad76=_0x45822d[_0x3aa0e6(0xdd)]-0x1;_0x17ad76>=0x0;_0x17ad76--)if(_0x581ed0=_0x45822d[_0x17ad76])_0x168995=(_0x52c5c5<0x3?_0x581ed0(_0x168995):_0x52c5c5>0x3?_0x581ed0(_0x2d1213,_0x35e160,_0x168995):_0x581ed0(_0x2d1213,_0x35e160))||_0x168995;}return _0x52c5c5>0x3&&_0x168995&&Object[_0x3aa0e6(0x10e)](_0x2d1213,_0x35e160,_0x168995),_0x168995;},__metadata=this&&this[_0x50617e(0xe5)]||function(_0x452c05,_0x3c009d){const _0x140a87=_0x50617e;if(typeof Reflect===_0x140a87(0xe2)&&typeof Reflect[_0x140a87(0xc9)]===_0x140a87(0xe3))return Reflect[_0x140a87(0xc9)](_0x452c05,_0x3c009d);},__param=this&&this[_0x50617e(0xe7)]||function(_0xd87ed7,_0x45ae7a){return function(_0x564a94,_0x1285d0){_0x45ae7a(_0x564a94,_0x1285d0,_0xd87ed7);};};Object['defineProperty'](exports,_0x50617e(0xc8),{'value':!![]}),exports[_0x50617e(0xf0)]=void 0x0;const typeorm_1=require(_0x50617e(0xbb)),common_1=require(_0x50617e(0x10d)),typeorm_2=require(_0x50617e(0x10b)),balance_constant_1=require(_0x50617e(0xcd)),accountLog_entity_1=require('./accountLog.entity'),cramiPackage_entity_1=require(_0x50617e(0x111)),salesUsers_entity_1=require(_0x50617e(0xc3)),sales_service_1=require(_0x50617e(0x110)),user_service_1=require(_0x50617e(0xc1)),accountVipLog_entity_1=require(_0x50617e(0xfd)),utils_1=require(_0x50617e(0x112)),nestjs_cls_1=require('nestjs-cls');let UserBalanceService=class UserBalanceService{constructor(_0x3f0331,_0x3b0de2,_0x4a06dc,_0x551dc4,_0x1653b3,_0x3bedab,_0x53fcb6,_0x34a888){const _0x2740b3=_0x50617e;this[_0x2740b3(0xd0)]=_0x3f0331,this[_0x2740b3(0xe8)]=_0x3b0de2,this['cramiPackageEntity']=_0x4a06dc,this['salesUsersEntity']=_0x551dc4,this[_0x2740b3(0xef)]=_0x1653b3,this[_0x2740b3(0x106)]=_0x3bedab,this[_0x2740b3(0x109)]=_0x53fcb6,this[_0x2740b3(0x105)]=_0x34a888;}async[_0x50617e(0xce)](_0x143f13){const _0x3d36eb=_0x50617e;console[_0x3d36eb(0xbd)]('充值的订单信息:',_0x143f13);try{const {userId:_0x273008,goodsId:_0x44e260}=_0x143f13,_0x3d1840=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x44e260,'status':0x1}});if(!_0x3d1840)throw new common_1[(_0x3d36eb(0xb9))]('非法操作、当前充值套餐暂不存在！',common_1[_0x3d36eb(0xbf)]['BAD_REQUEST']);const _0x4489a5=await this['userService'][_0x3d36eb(0xc5)](_0x273008);_0x3d1840[_0x3d36eb(0xd9)]>0x0&&await this['userService']['changeScore4Other'](_0x4489a5,balance_constant_1['EChangeType'][_0x3d36eb(0xdb)],_0x3d1840[_0x3d36eb(0xd9)],'购买套餐：'+_0x3d1840[_0x3d36eb(0xc2)],_0x3d1840['id']);_0x3d1840['days']!==0x0&&await this[_0x3d36eb(0xef)]['updateVipExpire'](_0x4489a5,balance_constant_1['EChangeType'][_0x3d36eb(0xdb)],_0x3d1840['days'],_0x3d36eb(0xeb)+_0x3d1840[_0x3d36eb(0xc2)],_0x3d1840['id']);if(_0x4489a5[_0x3d36eb(0x107)]){const _0x13e5b5=await this[_0x3d36eb(0xef)][_0x3d36eb(0x104)](_0x4489a5[_0x3d36eb(0x107)]);if(!_0x13e5b5)return;const _0x533c4e=await this['salesUsersEntity'][_0x3d36eb(0xba)]({'where':{'userId':_0x13e5b5['id']}}),{id:_0x3efc13}=_0x13e5b5,{performanceRatio:_0x15440a}=_0x533c4e,_0x45db6a={'inviterUserId':_0x3efc13,'inviteeUserId':_0x273008,'orderId':_0x143f13['id'],'orderPrice':_0x143f13[_0x3d36eb(0xea)],'commissionPercentage':_0x15440a,'commissionAmount':(_0x143f13[_0x3d36eb(0xea)]*_0x15440a/0x64)[_0x3d36eb(0x108)](0x2)};await this['salesService'][_0x3d36eb(0xd7)](_0x45db6a),await this[_0x3d36eb(0x106)][_0x3d36eb(0xf9)](_0x3efc13,_0x45db6a[_0x3d36eb(0xff)]);}}catch(_0x28cb49){console[_0x3d36eb(0xbd)]('error:\x20',_0x28cb49);throw new common_1['HttpException']('充值失败！',common_1[_0x3d36eb(0xbf)]['BAD_REQUEST']);}}async[_0x50617e(0xd3)](_0x25cade,_0x70eef9,_0x92ecdf){const _0x5c2c2b=_0x50617e,_0x211d35=(0x0,utils_1[_0x5c2c2b(0xcf)])(this[_0x5c2c2b(0x109)]),{page:page=0x1,size:size=0x14,startTime:_0x57d1a6,endTime:_0x184cf6,keyword:_0x133899,saasId:_0x27db69,changeType:_0x50a52e,creaseType:_0xe8aeba}=_0x70eef9;let _0x25e97b=_0x5c2c2b(0xc4)+(_0x92ecdf?'\x20AND\x20al.userId\x20=\x20'+_0x92ecdf:'')+_0x5c2c2b(0xcc)+(_0x50a52e?_0x5c2c2b(0xf8)+_0x50a52e:'')+_0x5c2c2b(0xcc)+(_0xe8aeba?'\x20AND\x20al.change_score\x20'+(_0xe8aeba===_0x5c2c2b(0x114)?'>\x200':_0x5c2c2b(0xc6)):'')+_0x5c2c2b(0xcc)+(_0x57d1a6?_0x5c2c2b(0xda)+_0x57d1a6+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x184cf6?_0x5c2c2b(0xf6)+_0x184cf6+'\x27':'')+_0x5c2c2b(0xcc)+(_0x133899?_0x5c2c2b(0xd2)+_0x133899+_0x5c2c2b(0xf4)+_0x133899+_0x5c2c2b(0xf3)+_0x133899+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x133899+_0x5c2c2b(0xe9):'')+_0x5c2c2b(0xd5);(0x0,utils_1[_0x5c2c2b(0x102)])(this['clsService'])?(0x0,utils_1['isManage'])(this[_0x5c2c2b(0x109)])&&_0x27db69&&(_0x25e97b=_0x25e97b+(_0x5c2c2b(0xfa)+_0x27db69)):_0x25e97b=_0x25e97b+(_0x5c2c2b(0xfa)+_0x211d35);const _0x1fca0f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x25e97b+_0x5c2c2b(0xd5),_0x55b999=_0x5c2c2b(0xc7)+_0x25e97b+_0x5c2c2b(0xfb)+size+_0x5c2c2b(0xee)+(page-0x1)*size+'\x0a\x20\x20\x20\x20',_0x16c6d1=await this['connection'][_0x5c2c2b(0xf1)](_0x1fca0f),_0x31b243=await this[_0x5c2c2b(0x105)][_0x5c2c2b(0xf1)](_0x55b999);return!(0x0,utils_1['isSuper'])(this[_0x5c2c2b(0x109)])&&_0x31b243['forEach'](_0x23d850=>{const _0x3c8dc7=_0x5c2c2b;_0x23d850[_0x3c8dc7(0x10f)]=(0x0,utils_1[_0x3c8dc7(0xec)])(_0x23d850['email']),_0x23d850['phone']=(0x0,utils_1[_0x3c8dc7(0xec)])(_0x23d850[_0x3c8dc7(0xb7)]);}),{'rows':_0x31b243,'count':Number(_0x16c6d1[0x0]?.['count']||0x0)};}async[_0x50617e(0xfe)](_0x3357c0,_0xf9a8b2){const _0x4c308c=_0x50617e;return this[_0x4c308c(0xd3)](_0x3357c0,_0xf9a8b2,_0x3357c0['user']['id']);}async[_0x50617e(0xe4)](_0x2c3a57){const _0x485079=_0x50617e;if(!_0x2c3a57[_0x485079(0xca)][_0x485079(0xdd)])return!![];return await this[_0x485079(0xd0)][_0x485079(0xe0)]({'id':(0x0,typeorm_2['In'])(_0x2c3a57['ids'])},{'delFlag':0x1}),!![];}async[_0x50617e(0x103)](_0x59d48a){const _0x47549b=_0x50617e,_0x2a1b93=(0x0,utils_1['getReqSaasId'])(this[_0x47549b(0x109)]);await this[_0x47549b(0xd0)]['save']({..._0x59d48a,'saasId':_0x2a1b93});}async['insertAccountVipLog'](_0x1d27fe){const _0x3e28a7=_0x50617e;await this[_0x3e28a7(0xe8)][_0x3e28a7(0xbe)](_0x1d27fe);}};UserBalanceService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x50617e(0xf5)])(accountLog_entity_1[_0x50617e(0x10c)])),__param(0x1,(0x0,typeorm_1[_0x50617e(0xf5)])(accountVipLog_entity_1[_0x50617e(0xd8)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x50617e(0xe1)])),__param(0x3,(0x0,typeorm_1[_0x50617e(0xf5)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x4,(0x0,common_1[_0x50617e(0xf2)])((0x0,common_1[_0x50617e(0xe6)])(()=>user_service_1[_0x50617e(0xde)]))),__metadata(_0x50617e(0xfc),[typeorm_2[_0x50617e(0x100)],typeorm_2[_0x50617e(0x100)],typeorm_2[_0x50617e(0x100)],typeorm_2[_0x50617e(0x100)],user_service_1[_0x50617e(0xde)],sales_service_1[_0x50617e(0xb6)],nestjs_cls_1[_0x50617e(0xdf)],typeorm_2[_0x50617e(0xcb)]])],UserBalanceService),exports[_0x50617e(0xf0)]=UserBalanceService;