'use strict';const _0x27ab22=_0x11c0;(function(_0x4289e3,_0x41c919){const _0x53a875=_0x11c0,_0x1d9d24=_0x4289e3();while(!![]){try{const _0x43175f=-parseInt(_0x53a875(0x19d))/0x1+-parseInt(_0x53a875(0x170))/0x2+-parseInt(_0x53a875(0x18e))/0x3*(-parseInt(_0x53a875(0x183))/0x4)+-parseInt(_0x53a875(0x191))/0x5+-parseInt(_0x53a875(0x15b))/0x6+-parseInt(_0x53a875(0x185))/0x7+parseInt(_0x53a875(0x168))/0x8;if(_0x43175f===_0x41c919)break;else _0x1d9d24['push'](_0x1d9d24['shift']());}catch(_0x4e5aa0){_0x1d9d24['push'](_0x1d9d24['shift']());}}}(_0x3130,0xb97f7));var __decorate=this&&this[_0x27ab22(0x145)]||function(_0x1cee0f,_0x3f2aaa,_0x43c142,_0xb448ad){const _0x19d23c=_0x27ab22;var _0x172d0a=arguments[_0x19d23c(0x150)],_0x5458a3=_0x172d0a<0x3?_0x3f2aaa:_0xb448ad===null?_0xb448ad=Object[_0x19d23c(0x16c)](_0x3f2aaa,_0x43c142):_0xb448ad,_0x8d6e56;if(typeof Reflect===_0x19d23c(0x1a7)&&typeof Reflect['decorate']===_0x19d23c(0x174))_0x5458a3=Reflect[_0x19d23c(0x14b)](_0x1cee0f,_0x3f2aaa,_0x43c142,_0xb448ad);else{for(var _0x4b2b2b=_0x1cee0f[_0x19d23c(0x150)]-0x1;_0x4b2b2b>=0x0;_0x4b2b2b--)if(_0x8d6e56=_0x1cee0f[_0x4b2b2b])_0x5458a3=(_0x172d0a<0x3?_0x8d6e56(_0x5458a3):_0x172d0a>0x3?_0x8d6e56(_0x3f2aaa,_0x43c142,_0x5458a3):_0x8d6e56(_0x3f2aaa,_0x43c142))||_0x5458a3;}return _0x172d0a>0x3&&_0x5458a3&&Object['defineProperty'](_0x3f2aaa,_0x43c142,_0x5458a3),_0x5458a3;},__metadata=this&&this[_0x27ab22(0x1a8)]||function(_0x5b70f6,_0x2c4e4a){const _0x246193=_0x27ab22;if(typeof Reflect===_0x246193(0x1a7)&&typeof Reflect['metadata']===_0x246193(0x174))return Reflect[_0x246193(0x182)](_0x5b70f6,_0x2c4e4a);},__param=this&&this[_0x27ab22(0x173)]||function(_0x43672d,_0x2366de){return function(_0x1012bf,_0x2e08d0){_0x2366de(_0x1012bf,_0x2e08d0,_0x43672d);};};Object['defineProperty'](exports,_0x27ab22(0x151),{'value':!![]}),exports[_0x27ab22(0x15d)]=void 0x0;function _0x11c0(_0x4960ff,_0x26ab58){const _0x3130a2=_0x3130();return _0x11c0=function(_0x11c09f,_0x59f6b2){_0x11c09f=_0x11c09f-0x142;let _0x3ac288=_0x3130a2[_0x11c09f];return _0x3ac288;},_0x11c0(_0x4960ff,_0x26ab58);}function _0x3130(){const _0x417cc9=['721725XSdqEr','>\x200','insertAccountVipLog','EChangeType','getReqSaasId','../sales/salesUsers.entity','\x0a\x20\x20\x20\x20','insertAccountLog','invitedBy','@nestjs/typeorm','update','SalesUsersEntity','634891vYcTcS','forwardRef','SalesService','myPage','../../common/utils','score','getUserByInviteCode','count','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','connection','object','__metadata','forEach','phone','<\x200','__decorate','ClsService','deleteAccountLog','clsService','非法操作、当前充值套餐暂不存在！','../user/user.service','decorate','salesUsersEntity','salesService','./accountLog.entity','log','length','__esModule','accountLogEntity','购买套餐：','\x20AND\x20al.createdAt\x20>=\x20\x27','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','name','total','\x20AND\x20al.createdAt\x20<=\x20\x27','days','UserService','3052518fQpdJP','@nestjs/common','UserBalanceService','createSalesRecords','Connection','../sales/sales.service','email','Repository','BAD_REQUEST','Injectable','Inject','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','17217928OHujrn','充值失败！','HttpStatus','query','getOwnPropertyDescriptor','PurchasePackage','accountVipLogEntity','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','1009814bMHzEW','findOne','cramiPackageEntity','__param','function','commissionAmount','AccountLogEntity','AccountVipLogEntity','userType','userPage','save','\x20AND\x20al.change_type\x20=\x20','maskEmail','addBalanceToOrder','\x20AND\x20al.saasId\x20=\x20','userService','nestjs-cls','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','metadata','3312932vuZPuS','changeScore4Other','2994453PJnWrD','HttpException','购买套餐:\x20','updateVipType','\x20OFFSET\x20','InjectRepository','ids','./accountVipLog.entity','\x20AND\x20al.change_score\x20','3MLkUwE','\x20AND\x20al.userId\x20=\x20','toFixed'];_0x3130=function(){return _0x417cc9;};return _0x3130();}const typeorm_1=require(_0x27ab22(0x19a)),common_1=require(_0x27ab22(0x15c)),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),accountLog_entity_1=require(_0x27ab22(0x14e)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),salesUsers_entity_1=require(_0x27ab22(0x196)),sales_service_1=require(_0x27ab22(0x160)),user_service_1=require(_0x27ab22(0x14a)),accountVipLog_entity_1=require(_0x27ab22(0x18c)),utils_1=require(_0x27ab22(0x1a1)),nestjs_cls_1=require(_0x27ab22(0x180));let UserBalanceService=class UserBalanceService{constructor(_0x134ba5,_0x149c39,_0x4562d6,_0x271e66,_0x18bb3c,_0x3179ec,_0x7f56ad,_0x3f3a82){const _0x2f69f1=_0x27ab22;this['accountLogEntity']=_0x134ba5,this[_0x2f69f1(0x16e)]=_0x149c39,this[_0x2f69f1(0x172)]=_0x4562d6,this[_0x2f69f1(0x14c)]=_0x271e66,this[_0x2f69f1(0x17f)]=_0x18bb3c,this[_0x2f69f1(0x14d)]=_0x3179ec,this[_0x2f69f1(0x148)]=_0x7f56ad,this['connection']=_0x3f3a82;}async[_0x27ab22(0x17d)](_0x5b0ce7){const _0x3e51e4=_0x27ab22;console['log']('充值的订单信息:',_0x5b0ce7);try{const {userId:_0x590675,goodsId:_0x4c7430}=_0x5b0ce7,_0x3104e6=await this[_0x3e51e4(0x172)][_0x3e51e4(0x171)]({'where':{'id':_0x4c7430,'status':0x1}});if(!_0x3104e6)throw new common_1[(_0x3e51e4(0x186))](_0x3e51e4(0x149),common_1['HttpStatus'][_0x3e51e4(0x163)]);const _0x5da9fa=await this[_0x3e51e4(0x17f)]['getUserById'](_0x590675);_0x3104e6[_0x3e51e4(0x1a2)]>0x0&&await this[_0x3e51e4(0x17f)][_0x3e51e4(0x184)](_0x5da9fa,balance_constant_1[_0x3e51e4(0x194)][_0x3e51e4(0x16d)],_0x3104e6[_0x3e51e4(0x1a2)],_0x3e51e4(0x153)+_0x3104e6[_0x3e51e4(0x156)],_0x3104e6['id']);_0x3104e6[_0x3e51e4(0x159)]!==0x0&&await this[_0x3e51e4(0x17f)]['updateVipExpire'](_0x5da9fa,balance_constant_1[_0x3e51e4(0x194)]['PurchasePackage'],_0x3104e6[_0x3e51e4(0x159)],_0x3e51e4(0x187)+_0x3104e6['name'],_0x3104e6['id']);_0x3104e6['userType']&&await this[_0x3e51e4(0x17f)][_0x3e51e4(0x188)](_0x5da9fa,parseInt(_0x3104e6[_0x3e51e4(0x178)]));if(_0x5da9fa[_0x3e51e4(0x199)]){const _0x505f73=await this['userService'][_0x3e51e4(0x1a3)](_0x5da9fa[_0x3e51e4(0x199)]);if(!_0x505f73)return;const _0x54e36b=await this['salesUsersEntity'][_0x3e51e4(0x171)]({'where':{'userId':_0x505f73['id']}}),{id:_0x10f5ee}=_0x505f73,{performanceRatio:_0xf011e4}=_0x54e36b,_0x222949={'inviterUserId':_0x10f5ee,'inviteeUserId':_0x590675,'orderId':_0x5b0ce7['id'],'orderPrice':_0x5b0ce7['total'],'commissionPercentage':_0xf011e4,'commissionAmount':(_0x5b0ce7[_0x3e51e4(0x157)]*_0xf011e4/0x64)[_0x3e51e4(0x190)](0x2)};await this[_0x3e51e4(0x14d)][_0x3e51e4(0x15e)](_0x222949),await this[_0x3e51e4(0x14d)]['saveCommissionAmount'](_0x10f5ee,_0x222949[_0x3e51e4(0x175)]);}}catch(_0x5b1c9c){console[_0x3e51e4(0x14f)]('error:\x20',_0x5b1c9c);throw new common_1[(_0x3e51e4(0x186))](_0x3e51e4(0x169),common_1[_0x3e51e4(0x16a)][_0x3e51e4(0x163)]);}}async['userPage'](_0x2a322d,_0x563cc7,_0x277f3d){const _0x161361=_0x27ab22,_0xf97bc=(0x0,utils_1[_0x161361(0x195)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0x444aac,endTime:_0x2cc150,keyword:_0x20d7b9,saasId:_0x2dbb67,changeType:_0x23d72e,creaseType:_0x439d57}=_0x563cc7;let _0x12e89f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x277f3d?_0x161361(0x18f)+_0x277f3d:'')+_0x161361(0x166)+(_0x23d72e?_0x161361(0x17b)+_0x23d72e:'')+_0x161361(0x166)+(_0x439d57?_0x161361(0x18d)+(_0x439d57==='increase'?_0x161361(0x192):_0x161361(0x144)):'')+_0x161361(0x166)+(_0x444aac?_0x161361(0x154)+_0x444aac+'\x27':'')+_0x161361(0x166)+(_0x2cc150?_0x161361(0x158)+_0x2cc150+'\x27':'')+_0x161361(0x166)+(_0x20d7b9?_0x161361(0x155)+_0x20d7b9+_0x161361(0x16f)+_0x20d7b9+_0x161361(0x167)+_0x20d7b9+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x20d7b9+'%\x27\x20)':'')+_0x161361(0x197);(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1['isManage'])(this[_0x161361(0x148)])&&_0x2dbb67&&(_0x12e89f=_0x12e89f+(_0x161361(0x17e)+_0x2dbb67)):_0x12e89f=_0x12e89f+('\x20AND\x20al.saasId\x20=\x20'+_0xf97bc);const _0x3a31a6=_0x161361(0x181)+_0x12e89f+'\x0a\x20\x20\x20\x20',_0x5d396e=_0x161361(0x1a5)+_0x12e89f+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x161361(0x189)+(page-0x1)*size+_0x161361(0x197),_0x3fed41=await this[_0x161361(0x1a6)][_0x161361(0x16b)](_0x3a31a6),_0x37d8ea=await this[_0x161361(0x1a6)][_0x161361(0x16b)](_0x5d396e);return!(0x0,utils_1['isSuper'])(this[_0x161361(0x148)])&&_0x37d8ea[_0x161361(0x142)](_0x1439dc=>{const _0x153a38=_0x161361;_0x1439dc[_0x153a38(0x161)]=(0x0,utils_1[_0x153a38(0x17c)])(_0x1439dc['email']),_0x1439dc[_0x153a38(0x143)]=(0x0,utils_1[_0x153a38(0x17c)])(_0x1439dc[_0x153a38(0x143)]);}),{'rows':_0x37d8ea,'count':Number(_0x3fed41[0x0]?.[_0x161361(0x1a4)]||0x0)};}async[_0x27ab22(0x1a0)](_0x5ca16c,_0x59490f){const _0x4c7dd5=_0x27ab22;return this[_0x4c7dd5(0x179)](_0x5ca16c,_0x59490f,_0x5ca16c['user']['id']);}async[_0x27ab22(0x147)](_0xac92c6){const _0x3a8bd1=_0x27ab22;if(!_0xac92c6[_0x3a8bd1(0x18b)][_0x3a8bd1(0x150)])return!![];return await this[_0x3a8bd1(0x152)][_0x3a8bd1(0x19b)]({'id':(0x0,typeorm_2['In'])(_0xac92c6[_0x3a8bd1(0x18b)])},{'delFlag':0x1}),!![];}async[_0x27ab22(0x198)](_0x2a64f7){const _0xe9f058=_0x27ab22,_0x37e1b7=(0x0,utils_1[_0xe9f058(0x195)])(this[_0xe9f058(0x148)]);await this[_0xe9f058(0x152)][_0xe9f058(0x17a)]({..._0x2a64f7,'saasId':_0x37e1b7});}async[_0x27ab22(0x193)](_0x3e7b7b){const _0x31e89f=_0x27ab22;await this[_0x31e89f(0x16e)][_0x31e89f(0x17a)](_0x3e7b7b);}};UserBalanceService=__decorate([(0x0,common_1[_0x27ab22(0x164)])(),__param(0x0,(0x0,typeorm_1[_0x27ab22(0x18a)])(accountLog_entity_1[_0x27ab22(0x176)])),__param(0x1,(0x0,typeorm_1[_0x27ab22(0x18a)])(accountVipLog_entity_1[_0x27ab22(0x177)])),__param(0x2,(0x0,typeorm_1[_0x27ab22(0x18a)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x27ab22(0x19c)])),__param(0x4,(0x0,common_1[_0x27ab22(0x165)])((0x0,common_1[_0x27ab22(0x19e)])(()=>user_service_1[_0x27ab22(0x15a)]))),__metadata('design:paramtypes',[typeorm_2[_0x27ab22(0x162)],typeorm_2['Repository'],typeorm_2[_0x27ab22(0x162)],typeorm_2['Repository'],user_service_1[_0x27ab22(0x15a)],sales_service_1[_0x27ab22(0x19f)],nestjs_cls_1[_0x27ab22(0x146)],typeorm_2[_0x27ab22(0x15f)]])],UserBalanceService),exports[_0x27ab22(0x15d)]=UserBalanceService;