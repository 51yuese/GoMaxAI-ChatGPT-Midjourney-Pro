'use strict';const _0x3a73a1=_0x5601;(function(_0x2aec06,_0x12bced){const _0x2cff12=_0x5601,_0x1ac2eb=_0x2aec06();while(!![]){try{const _0x1058b3=parseInt(_0x2cff12(0x1bf))/0x1*(parseInt(_0x2cff12(0x1cc))/0x2)+parseInt(_0x2cff12(0x1b6))/0x3*(parseInt(_0x2cff12(0x18a))/0x4)+-parseInt(_0x2cff12(0x17d))/0x5*(parseInt(_0x2cff12(0x167))/0x6)+-parseInt(_0x2cff12(0x1cb))/0x7*(parseInt(_0x2cff12(0x189))/0x8)+-parseInt(_0x2cff12(0x1ab))/0x9+-parseInt(_0x2cff12(0x16d))/0xa*(-parseInt(_0x2cff12(0x182))/0xb)+-parseInt(_0x2cff12(0x1c9))/0xc*(parseInt(_0x2cff12(0x1a8))/0xd);if(_0x1058b3===_0x12bced)break;else _0x1ac2eb['push'](_0x1ac2eb['shift']());}catch(_0x596cf3){_0x1ac2eb['push'](_0x1ac2eb['shift']());}}}(_0x1d9c,0xd37bb));var __decorate=this&&this[_0x3a73a1(0x1c6)]||function(_0x98ad8b,_0x155bee,_0x58f824,_0x17aeaa){const _0x22635d=_0x3a73a1;var _0x47960c=arguments[_0x22635d(0x1b8)],_0x384dca=_0x47960c<0x3?_0x155bee:_0x17aeaa===null?_0x17aeaa=Object[_0x22635d(0x191)](_0x155bee,_0x58f824):_0x17aeaa,_0x4aacac;if(typeof Reflect===_0x22635d(0x18b)&&typeof Reflect[_0x22635d(0x173)]===_0x22635d(0x16f))_0x384dca=Reflect[_0x22635d(0x173)](_0x98ad8b,_0x155bee,_0x58f824,_0x17aeaa);else{for(var _0x1bf7b4=_0x98ad8b['length']-0x1;_0x1bf7b4>=0x0;_0x1bf7b4--)if(_0x4aacac=_0x98ad8b[_0x1bf7b4])_0x384dca=(_0x47960c<0x3?_0x4aacac(_0x384dca):_0x47960c>0x3?_0x4aacac(_0x155bee,_0x58f824,_0x384dca):_0x4aacac(_0x155bee,_0x58f824))||_0x384dca;}return _0x47960c>0x3&&_0x384dca&&Object[_0x22635d(0x190)](_0x155bee,_0x58f824,_0x384dca),_0x384dca;},__metadata=this&&this['__metadata']||function(_0x43ee6,_0xf2c593){const _0x510cf2=_0x3a73a1;if(typeof Reflect===_0x510cf2(0x18b)&&typeof Reflect['metadata']===_0x510cf2(0x16f))return Reflect['metadata'](_0x43ee6,_0xf2c593);},__param=this&&this[_0x3a73a1(0x197)]||function(_0x1f8119,_0x22cca0){return function(_0x1f4f78,_0x8ef20d){_0x22cca0(_0x1f4f78,_0x8ef20d,_0x1f8119);};};function _0x1d9c(){const _0x1baf43=['isPlatform','\x20OFFSET\x20','AccountVipLogEntity','@nestjs/common','count','getReqSaasId','2571378AYuKXt','购买套餐:\x20','forEach','deleteAccountLog','Connection','score','930vINpUR','Injectable','function','>\x200','AccountLogEntity','EChangeType','decorate','isSuper','insertAccountLog','\x20AND\x20al.change_type\x20=\x20','BAD_REQUEST','UserBalanceService','name','toFixed','insertAccountVipLog','increase','10lVxWCH','./accountVipLog.entity','error:\x20','nestjs-cls','salesService','154341kRATVd','%\x27\x20)','\x20AND\x20al.userId\x20=\x20','\x20AND\x20al.createdAt\x20<=\x20\x27','design:paramtypes','../sales/salesUsers.entity','email','4581624TedTuB','148KRZRJq','object','getUserById','typeorm','ids','../user/user.service','defineProperty','getOwnPropertyDescriptor','accountLogEntity','createSalesRecords','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','cramiPackageEntity','maskEmail','__param','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','findOne','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','SalesUsersEntity','total','ClsService','salesUsersEntity','../../common/utils','SalesService','log','PurchasePackage','connection','userPage','HttpStatus','myPage','\x20AND\x20al.saasId\x20=\x20','52CsBPCG','phone','HttpException','4728951IQwyxw','<\x200','forwardRef','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','../../common/constants/balance.constant','充值失败！','InjectRepository','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','./accountLog.entity','user','Repository','126663cEtHwb','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','length','changeScore4Other','query','save','accountVipLogEntity','UserService','update','11733SeTPni','非法操作、当前充值套餐暂不存在！','userService','clsService','invitedBy','commissionAmount','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','__decorate','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20','1227840fhwGLi','days','7hLLKgl','62EKQjoa'];_0x1d9c=function(){return _0x1baf43;};return _0x1d9c();}Object[_0x3a73a1(0x190)](exports,'__esModule',{'value':!![]}),exports['UserBalanceService']=void 0x0;function _0x5601(_0x3543ca,_0xc5d105){const _0x1d9c58=_0x1d9c();return _0x5601=function(_0x5601ae,_0x46d7e5){_0x5601ae=_0x5601ae-0x162;let _0x508d20=_0x1d9c58[_0x5601ae];return _0x508d20;},_0x5601(_0x3543ca,_0xc5d105);}const typeorm_1=require('@nestjs/typeorm'),common_1=require(_0x3a73a1(0x164)),typeorm_2=require(_0x3a73a1(0x18d)),balance_constant_1=require(_0x3a73a1(0x1af)),accountLog_entity_1=require(_0x3a73a1(0x1b3)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),salesUsers_entity_1=require(_0x3a73a1(0x187)),sales_service_1=require('../sales/sales.service'),user_service_1=require(_0x3a73a1(0x18f)),accountVipLog_entity_1=require(_0x3a73a1(0x17e)),utils_1=require(_0x3a73a1(0x19f)),nestjs_cls_1=require(_0x3a73a1(0x180));let UserBalanceService=class UserBalanceService{constructor(_0x413339,_0x4b36ba,_0x1fbeb6,_0x1db2cf,_0x378efb,_0x294d43,_0x383ea1,_0x89924a){const _0xe414a8=_0x3a73a1;this['accountLogEntity']=_0x413339,this[_0xe414a8(0x1bc)]=_0x4b36ba,this['cramiPackageEntity']=_0x1fbeb6,this[_0xe414a8(0x19e)]=_0x1db2cf,this[_0xe414a8(0x1c1)]=_0x378efb,this[_0xe414a8(0x181)]=_0x294d43,this[_0xe414a8(0x1c2)]=_0x383ea1,this[_0xe414a8(0x1a3)]=_0x89924a;}async['addBalanceToOrder'](_0x547411){const _0x2e2695=_0x3a73a1;console[_0x2e2695(0x1a1)]('充值的订单信息:',_0x547411);try{const {userId:_0x76a09e,goodsId:_0x912c47}=_0x547411,_0x4c3534=await this[_0x2e2695(0x195)][_0x2e2695(0x199)]({'where':{'id':_0x912c47,'status':0x1}});if(!_0x4c3534)throw new common_1[(_0x2e2695(0x1aa))](_0x2e2695(0x1c0),common_1[_0x2e2695(0x1a5)][_0x2e2695(0x177)]);const _0x25f00b=await this['userService'][_0x2e2695(0x18c)](_0x76a09e);_0x4c3534[_0x2e2695(0x16c)]>0x0&&await this[_0x2e2695(0x1c1)][_0x2e2695(0x1b9)](_0x25f00b,balance_constant_1[_0x2e2695(0x172)]['PurchasePackage'],_0x4c3534['score'],'购买套餐：'+_0x4c3534[_0x2e2695(0x179)],_0x4c3534['id']);_0x4c3534[_0x2e2695(0x1ca)]!==0x0&&await this[_0x2e2695(0x1c1)]['updateVipExpire'](_0x25f00b,balance_constant_1[_0x2e2695(0x172)][_0x2e2695(0x1a2)],_0x4c3534['days'],_0x2e2695(0x168)+_0x4c3534[_0x2e2695(0x179)],_0x4c3534['id']);if(_0x25f00b['invitedBy']){const _0xee0e82=await this[_0x2e2695(0x1c1)]['getUserByInviteCode'](_0x25f00b[_0x2e2695(0x1c3)]);if(!_0xee0e82)return;const _0x83a06f=await this[_0x2e2695(0x19e)][_0x2e2695(0x199)]({'where':{'userId':_0xee0e82['id']}}),{id:_0x564921}=_0xee0e82,{performanceRatio:_0x57ab7c}=_0x83a06f,_0x4c4e87={'inviterUserId':_0x564921,'inviteeUserId':_0x76a09e,'orderId':_0x547411['id'],'orderPrice':_0x547411[_0x2e2695(0x19c)],'commissionPercentage':_0x57ab7c,'commissionAmount':(_0x547411[_0x2e2695(0x19c)]*_0x57ab7c/0x64)[_0x2e2695(0x17a)](0x2)};await this['salesService'][_0x2e2695(0x193)](_0x4c4e87),await this['salesService']['saveCommissionAmount'](_0x564921,_0x4c4e87[_0x2e2695(0x1c4)]);}}catch(_0x243be0){console[_0x2e2695(0x1a1)](_0x2e2695(0x17f),_0x243be0);throw new common_1[(_0x2e2695(0x1aa))](_0x2e2695(0x1b0),common_1[_0x2e2695(0x1a5)][_0x2e2695(0x177)]);}}async['userPage'](_0x90e6a7,_0xd97d53,_0x19fdb3){const _0x13b10c=_0x3a73a1,_0x22017d=(0x0,utils_1[_0x13b10c(0x166)])(this[_0x13b10c(0x1c2)]),{page:page=0x1,size:size=0x14,startTime:_0x3aa723,endTime:_0x2a2d52,keyword:_0xd279d4,saasId:_0x242cb4,changeType:_0x18de82,creaseType:_0xaed48b}=_0xd97d53;let _0x3b1c59=_0x13b10c(0x1ae)+(_0x19fdb3?_0x13b10c(0x184)+_0x19fdb3:'')+_0x13b10c(0x198)+(_0x18de82?_0x13b10c(0x176)+_0x18de82:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0xaed48b?'\x20AND\x20al.change_score\x20'+(_0xaed48b===_0x13b10c(0x17c)?_0x13b10c(0x170):_0x13b10c(0x1ac)):'')+_0x13b10c(0x198)+(_0x3aa723?'\x20AND\x20al.createdAt\x20>=\x20\x27'+_0x3aa723+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x2a2d52?_0x13b10c(0x185)+_0x2a2d52+'\x27':'')+_0x13b10c(0x198)+(_0xd279d4?_0x13b10c(0x19a)+_0xd279d4+_0x13b10c(0x1b7)+_0xd279d4+_0x13b10c(0x1b2)+_0xd279d4+_0x13b10c(0x1c5)+_0xd279d4+_0x13b10c(0x183):'')+_0x13b10c(0x1c8);(0x0,utils_1[_0x13b10c(0x1cd)])(this[_0x13b10c(0x1c2)])?(0x0,utils_1['isManage'])(this[_0x13b10c(0x1c2)])&&_0x242cb4&&(_0x3b1c59=_0x3b1c59+(_0x13b10c(0x1a7)+_0x242cb4)):_0x3b1c59=_0x3b1c59+(_0x13b10c(0x1a7)+_0x22017d);const _0x4c87f8='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x3b1c59+_0x13b10c(0x1c8),_0x1618bc=_0x13b10c(0x1c7)+_0x3b1c59+_0x13b10c(0x194)+size+_0x13b10c(0x162)+(page-0x1)*size+_0x13b10c(0x1c8),_0x418152=await this[_0x13b10c(0x1a3)][_0x13b10c(0x1ba)](_0x4c87f8),_0x377ddd=await this[_0x13b10c(0x1a3)]['query'](_0x1618bc);return!(0x0,utils_1[_0x13b10c(0x174)])(this[_0x13b10c(0x1c2)])&&_0x377ddd[_0x13b10c(0x169)](_0x178f25=>{const _0x35011a=_0x13b10c;_0x178f25[_0x35011a(0x188)]=(0x0,utils_1[_0x35011a(0x196)])(_0x178f25[_0x35011a(0x188)]),_0x178f25['phone']=(0x0,utils_1[_0x35011a(0x196)])(_0x178f25[_0x35011a(0x1a9)]);}),{'rows':_0x377ddd,'count':Number(_0x418152[0x0]?.[_0x13b10c(0x165)]||0x0)};}async[_0x3a73a1(0x1a6)](_0x57ca7c,_0x2af857){const _0x4c2c4d=_0x3a73a1;return this[_0x4c2c4d(0x1a4)](_0x57ca7c,_0x2af857,_0x57ca7c[_0x4c2c4d(0x1b4)]['id']);}async[_0x3a73a1(0x16a)](_0x2f9cb4){const _0x5c7b2e=_0x3a73a1;if(!_0x2f9cb4[_0x5c7b2e(0x18e)][_0x5c7b2e(0x1b8)])return!![];return await this[_0x5c7b2e(0x192)][_0x5c7b2e(0x1be)]({'id':(0x0,typeorm_2['In'])(_0x2f9cb4[_0x5c7b2e(0x18e)])},{'delFlag':0x1}),!![];}async[_0x3a73a1(0x175)](_0x17a93e){const _0x4186ac=_0x3a73a1,_0x6e0aba=(0x0,utils_1[_0x4186ac(0x166)])(this[_0x4186ac(0x1c2)]);await this['accountLogEntity'][_0x4186ac(0x1bb)]({..._0x17a93e,'saasId':_0x6e0aba});}async[_0x3a73a1(0x17b)](_0x26a336){const _0x2a8d7b=_0x3a73a1;await this[_0x2a8d7b(0x1bc)][_0x2a8d7b(0x1bb)](_0x26a336);}};UserBalanceService=__decorate([(0x0,common_1[_0x3a73a1(0x16e)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x3a73a1(0x171)])),__param(0x1,(0x0,typeorm_1[_0x3a73a1(0x1b1)])(accountVipLog_entity_1[_0x3a73a1(0x163)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x3,(0x0,typeorm_1[_0x3a73a1(0x1b1)])(salesUsers_entity_1[_0x3a73a1(0x19b)])),__param(0x4,(0x0,common_1['Inject'])((0x0,common_1[_0x3a73a1(0x1ad)])(()=>user_service_1[_0x3a73a1(0x1bd)]))),__metadata(_0x3a73a1(0x186),[typeorm_2[_0x3a73a1(0x1b5)],typeorm_2[_0x3a73a1(0x1b5)],typeorm_2[_0x3a73a1(0x1b5)],typeorm_2['Repository'],user_service_1[_0x3a73a1(0x1bd)],sales_service_1[_0x3a73a1(0x1a0)],nestjs_cls_1[_0x3a73a1(0x19d)],typeorm_2[_0x3a73a1(0x16b)]])],UserBalanceService),exports[_0x3a73a1(0x178)]=UserBalanceService;