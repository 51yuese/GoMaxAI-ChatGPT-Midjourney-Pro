'use strict';const _0x1b495a=_0x30a2;(function(_0x38a3b6,_0x4f7727){const _0x4ae9be=_0x30a2,_0x261628=_0x38a3b6();while(!![]){try{const _0x332672=parseInt(_0x4ae9be(0x1e1))/0x1+-parseInt(_0x4ae9be(0x202))/0x2*(parseInt(_0x4ae9be(0x220))/0x3)+-parseInt(_0x4ae9be(0x1ce))/0x4+parseInt(_0x4ae9be(0x211))/0x5+-parseInt(_0x4ae9be(0x229))/0x6+-parseInt(_0x4ae9be(0x1dd))/0x7+parseInt(_0x4ae9be(0x1f9))/0x8;if(_0x332672===_0x4f7727)break;else _0x261628['push'](_0x261628['shift']());}catch(_0x4ed039){_0x261628['push'](_0x261628['shift']());}}}(_0x11d3,0xa67cf));var __decorate=this&&this['__decorate']||function(_0x55cf06,_0x57c2a3,_0x401f96,_0x43c1bb){const _0x4411bc=_0x30a2;var _0x49c86d=arguments[_0x4411bc(0x1f2)],_0x3e10ea=_0x49c86d<0x3?_0x57c2a3:_0x43c1bb===null?_0x43c1bb=Object[_0x4411bc(0x1ee)](_0x57c2a3,_0x401f96):_0x43c1bb,_0x883117;if(typeof Reflect==='object'&&typeof Reflect[_0x4411bc(0x205)]===_0x4411bc(0x200))_0x3e10ea=Reflect[_0x4411bc(0x205)](_0x55cf06,_0x57c2a3,_0x401f96,_0x43c1bb);else{for(var _0x339d4c=_0x55cf06['length']-0x1;_0x339d4c>=0x0;_0x339d4c--)if(_0x883117=_0x55cf06[_0x339d4c])_0x3e10ea=(_0x49c86d<0x3?_0x883117(_0x3e10ea):_0x49c86d>0x3?_0x883117(_0x57c2a3,_0x401f96,_0x3e10ea):_0x883117(_0x57c2a3,_0x401f96))||_0x3e10ea;}return _0x49c86d>0x3&&_0x3e10ea&&Object[_0x4411bc(0x1c9)](_0x57c2a3,_0x401f96,_0x3e10ea),_0x3e10ea;},__metadata=this&&this[_0x1b495a(0x1de)]||function(_0x1c62ee,_0x5f04da){const _0x141b35=_0x1b495a;if(typeof Reflect===_0x141b35(0x222)&&typeof Reflect[_0x141b35(0x226)]===_0x141b35(0x200))return Reflect[_0x141b35(0x226)](_0x1c62ee,_0x5f04da);};Object['defineProperty'](exports,_0x1b495a(0x21d),{'value':!![]}),exports['OfficialService']=void 0x0;function _0x11d3(){const _0x32ea3e=['userService','verify','4306944DTiImu','./../autoreply/autoreply.service','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','scanedSceneStrMap','errmsg','BAD_REQUEST','bindWxBySceneStr','HttpException','defineProperty','./vo/Login.vo','openId','&noncestr=','wechatAccessToken','3477016VVuMpD','crypto','OfficialService','loginByCode','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','authToken','AutoreplyService','fromusername','post',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','GlobalConfigService','get','sha1','../../common/utils','jiangly','9236822nGQXJC','__metadata','genXmlMsg','sceneStrMap','1241719cgxnWt','AuthService','非法参数','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','HttpStatus','log','hex',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','getJwtToken','WE_MINI_ACCESS_KEY','user','join',']]></Content>\x0a\x20\x20\x20\x20</xml>','getOwnPropertyDescriptor','&redirect_uri=','sort','scanBindWx','length','&grant_type=authorization_code','split','authService','wechatOfficialAppId','wechatUser','official','22786616TXsHSY','str:\x20','error','bindWx','default','scan','autoreplyService','function','&url=','826138OHPynD','@nestjs/common','tousername','decorate','getQRSceneStr','getUserOpenId','jsapi_ticket=','officialAutoReplyText','appId:\x20','getRedirectUrl','../redisCache/redisCache.service','RedisCacheService','design:paramtypes','axios','fetchQRCodeTicket','1623255oUFGcq','jsapiTicket:\x20','./../globalConfig/globalConfig.service','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','globalConfigService','valueOf','OfficialLoginVO','&timestamp=','&code=','getQRCodeTicket','toFixed','getQRSceneStrByBind','__esModule','getConfigByKeys','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','6fIsehz','loginBySceneStr','object','./../auth/auth.service','checkAutoReply','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','metadata'];_0x11d3=function(){return _0x32ea3e;};return _0x11d3();}function _0x30a2(_0x5a6889,_0x2b3258){const _0x11d316=_0x11d3();return _0x30a2=function(_0x30a264,_0x3a8ec7){_0x30a264=_0x30a264-0x1c6;let _0x1c75eb=_0x11d316[_0x30a264];return _0x1c75eb;},_0x30a2(_0x5a6889,_0x2b3258);}const globalConfig_service_1=require(_0x1b495a(0x213)),auth_service_1=require(_0x1b495a(0x223)),user_service_1=require('./../user/user.service'),autoreply_service_1=require(_0x1b495a(0x22a)),common_1=require(_0x1b495a(0x203)),crypto=require(_0x1b495a(0x1cf)),axios_1=require(_0x1b495a(0x20f)),utils_1=require(_0x1b495a(0x1db)),Login_vo_1=require(_0x1b495a(0x1ca)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),redisCache_service_1=require(_0x1b495a(0x20c)),date_1=require('../../common/utils/date');let OfficialService=class OfficialService{constructor(_0x34b6fa,_0x431c37,_0x4371da,_0xabc2ba,_0x1d570e){const _0x232459=_0x1b495a;this[_0x232459(0x1ff)]=_0x34b6fa,this['userService']=_0x431c37,this[_0x232459(0x1f5)]=_0x4371da,this[_0x232459(0x215)]=_0xabc2ba,this['redisCacheService']=_0x1d570e,this['sceneStrMap']={},this['scanedSceneStrMap']={};}async[_0x1b495a(0x206)](_0x55d745){const {invitedBy:_0x556ec5}=_0x55d745;let _0x491583=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x556ec5&&(_0x491583+=':'+_0x556ec5),this['sceneStrMap'][_0x491583]=!![],_0x491583;}async[_0x1b495a(0x21c)](_0x4c9e1d){const _0x447234=_0x1b495a,{id:_0x27898f}=_0x4c9e1d[_0x447234(0x1eb)],_0x5dd15d=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x27898f;return this[_0x447234(0x1e0)][_0x5dd15d]=!![],_0x5dd15d;}async[_0x1b495a(0x21a)](_0x4c5b62){const _0x5085a0=_0x1b495a;return this[_0x5085a0(0x210)](_0x4c5b62);}async[_0x1b495a(0x20b)](_0x330e3b){const _0x537937=_0x1b495a,_0x318d3c=await this[_0x537937(0x215)][_0x537937(0x21e)]([_0x537937(0x1f6)]),_0x397883=_0x537937(0x1e4)+_0x318d3c+_0x537937(0x1ef)+encodeURIComponent(_0x330e3b)+_0x537937(0x1d2);return console[_0x537937(0x1e6)]('回跳跳转地址:\x20',_0x397883),_0x397883;}async['getJsapiTicket'](_0x169305){const _0x20fbe6=_0x1b495a,_0x315a03=(0x0,utils_1['createRandomNonceStr'])(0x20),_0xfe166c=(Date['now']()/0x3e8)[_0x20fbe6(0x21b)](0x0),_0x3d3a55=await this[_0x20fbe6(0x215)][_0x20fbe6(0x21e)](['wechatJsapiTicket',_0x20fbe6(0x1f6)]),{wechatJsapiTicket:_0x53e7ac,wechatOfficialAppId:_0x380702}=_0x3d3a55;console[_0x20fbe6(0x1e6)](_0x20fbe6(0x212),_0x53e7ac),console[_0x20fbe6(0x1e6)](_0x20fbe6(0x20a),_0x380702);const _0x2b76aa=_0x20fbe6(0x208)+_0x53e7ac+_0x20fbe6(0x1cc)+_0x315a03+_0x20fbe6(0x218)+_0xfe166c+_0x20fbe6(0x201)+_0x169305;console[_0x20fbe6(0x1e6)](_0x20fbe6(0x1fa),_0x2b76aa);const _0x41e3e1=this['sha1'](_0x2b76aa);return{'appId':_0x380702,'nonceStr':_0x315a03,'timestamp':_0xfe166c,'signature':_0x41e3e1};}async[_0x1b495a(0x210)](_0x7b0aa0){const _0x50d551=_0x1b495a,_0x135b40=await this[_0x50d551(0x215)]['getConfigByKeys']([_0x50d551(0x1cd)]),_0x39f26e={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x7b0aa0}}},_0x188c77=await axios_1['default'][_0x50d551(0x1d6)](_0x50d551(0x214)+_0x135b40,_0x39f26e),{data:{errmsg:_0x5e68be,ticket:_0x4ec027}}=_0x188c77;if(_0x5e68be)throw new common_1[(_0x50d551(0x1c8))](_0x5e68be,common_1[_0x50d551(0x1e5)][_0x50d551(0x1c6)]);return _0x4ec027;}async[_0x1b495a(0x1d1)](_0xf5d8bc,_0x5acf7a){const _0x813f10=_0x1b495a,_0x1a7f7d=await this[_0x813f10(0x215)][_0x813f10(0x21e)]([_0x813f10(0x1f6),'wechatOfficialAppSecret']),{wechatOfficialAppId:_0x33ad3c,wechatOfficialAppSecret:_0x7c5a66}=_0x1a7f7d,_0x4020f8=await axios_1[_0x813f10(0x1fd)][_0x813f10(0x1d9)](_0x813f10(0x225)+_0x33ad3c+'&secret='+_0x7c5a66+_0x813f10(0x219)+_0x5acf7a+_0x813f10(0x1f3)),{data:{errmsg:_0x30eaa8,openid:_0x38fdab,access_token:_0x5333a7}}=_0x4020f8;if(_0x30eaa8)throw new common_1[(_0x813f10(0x1c8))](_0x30eaa8,common_1[_0x813f10(0x1e5)]['BAD_REQUEST']);let _0x48c58e=new Login_vo_1[(_0x813f10(0x217))]();_0x48c58e[_0x813f10(0x1cb)]=_0x38fdab;const _0x151f16=await this['userService'][_0x813f10(0x207)](_0x38fdab);if(_0x151f16)_0x48c58e[_0x813f10(0x1d3)]=await this[_0x813f10(0x1f5)][_0x813f10(0x1e9)](_0x151f16,_0xf5d8bc);else{if(_0x5333a7){const {data:_0x4a8d44}=await axios_1[_0x813f10(0x1fd)][_0x813f10(0x1d9)](_0x813f10(0x22b)+_0x5333a7+'&openid='+_0x38fdab+'&lang=zh_CN');!_0x4a8d44[_0x813f10(0x22d)]&&console[_0x813f10(0x1fb)](_0x4a8d44[_0x813f10(0x22d)]),_0x48c58e[_0x813f10(0x1f7)]=_0x4a8d44;}}return _0x48c58e;}async[_0x1b495a(0x1fe)](_0x473f56,_0x2266eb){const _0x5bcc3d=_0x1b495a;if(!this[_0x5bcc3d(0x1e0)][_0x2266eb])throw new common_1[(_0x5bcc3d(0x1c8))]('非法参数',common_1[_0x5bcc3d(0x1e5)]['BAD_REQUEST']);this[_0x5bcc3d(0x22c)][_0x2266eb]=_0x473f56;}async[_0x1b495a(0x221)](_0x3a7de1,_0x4eaef6){const _0x3830af=_0x1b495a;if(!this[_0x3830af(0x1e0)][_0x4eaef6])return;const _0x1d4f16=this[_0x3830af(0x22c)][_0x4eaef6];if(!_0x1d4f16)return new Login_vo_1['OfficialLoginVO']();let _0x22d0fe=new Login_vo_1[(_0x3830af(0x217))]();_0x22d0fe['openId']=_0x1d4f16;const _0xc65256=await this[_0x3830af(0x227)][_0x3830af(0x207)](_0x1d4f16);return _0xc65256&&(_0x22d0fe[_0x3830af(0x1d3)]=await this[_0x3830af(0x1f5)][_0x3830af(0x1e9)](_0xc65256,_0x3a7de1)),delete this[_0x3830af(0x22c)][_0x4eaef6],_0x22d0fe;}async[_0x1b495a(0x1f1)](_0x13da86,_0x42e169){const _0x4850cf=_0x1b495a;if(!this[_0x4850cf(0x1e0)][_0x42e169])throw new common_1[(_0x4850cf(0x1c8))](_0x4850cf(0x1e3),common_1['HttpStatus'][_0x4850cf(0x1c6)]);const _0x5f2d98=_0x42e169[_0x4850cf(0x1f4)]('/')[0x1],_0x4fba4f=await this[_0x4850cf(0x227)][_0x4850cf(0x1fc)](_0x13da86,_0x5f2d98);this['scanedSceneStrMap'][_0x42e169]=_0x4fba4f;}async[_0x1b495a(0x1c7)](_0x10f91b,_0x985491){const _0x14b3fb=_0x1b495a;if(!this[_0x14b3fb(0x1e0)][_0x985491])throw new common_1[(_0x14b3fb(0x1c8))](_0x14b3fb(0x1e3),common_1[_0x14b3fb(0x1e5)][_0x14b3fb(0x1c6)]);const {id:_0x135e3f}=_0x10f91b[_0x14b3fb(0x1eb)],_0x373944=this[_0x14b3fb(0x22c)][_0x985491];if(!_0x373944)return'';return delete this[_0x14b3fb(0x22c)][_0x985491],_0x373944;}async[_0x1b495a(0x228)](_0x397a1a,_0x2cb21e,_0xa4da68){const _0x1d7906=_0x1b495a,_0x3714b1=await this[_0x1d7906(0x215)][_0x1d7906(0x21e)](['wechatOfficialToken']),_0x39d2ee=_0x3714b1||_0x1d7906(0x1dc);return await this[_0x1d7906(0x1da)]([_0x39d2ee,_0x2cb21e,_0xa4da68][_0x1d7906(0x1f0)]()[_0x1d7906(0x1ec)](''))==_0x397a1a;}[_0x1b495a(0x1da)](_0x42c805){const _0x48f1de=_0x1b495a;return crypto['createHash'](_0x48f1de(0x1da))['update'](_0x42c805)['digest'](_0x48f1de(0x1e7));}async['genXmlMsgByConfig'](_0x1ba0f6,_0x5f5a54){const _0x109418=_0x1b495a,_0x20e142=await this[_0x109418(0x215)][_0x109418(0x21e)]([_0x5f5a54]);return this['genXmlMsg'](_0x1ba0f6,_0x20e142);}async[_0x1b495a(0x1df)](_0x35c8a5,_0x3fde3a){const _0x1d7428=_0x1b495a;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x35c8a5[_0x1d7428(0x1d5)][0x0]+_0x1d7428(0x1e8)+_0x35c8a5[_0x1d7428(0x204)][0x0]+_0x1d7428(0x1d7)+(0x0,date_1['default'])()[_0x1d7428(0x216)]()+_0x1d7428(0x21f)+_0x3fde3a+_0x1d7428(0x1ed);}async['aotoPlay'](_0x26207d){const _0x345535=_0x1b495a;let _0x283e16=await this[_0x345535(0x1ff)][_0x345535(0x224)](_0x26207d);if(!_0x283e16){const _0x1be7db=await this[_0x345535(0x215)][_0x345535(0x21e)]([_0x345535(0x209)]);_0x283e16=_0x1be7db;}return _0x283e16;}async['getAccessToken'](_0x38067a,_0x33b30b){const _0x2926f3=_0x1b495a;console[_0x2926f3(0x1e6)](_0x38067a['ip']);if(_0x33b30b===_0x2926f3(0x1f8)){const _0x55e600=await this['globalConfigService'][_0x2926f3(0x21e)]([_0x2926f3(0x1cd)]);return _0x55e600;}else{if(_0x33b30b==='mini'){const _0x40a781=await this['redisCacheService'][_0x2926f3(0x1d9)]({'key':redisKey_constant_1[_0x2926f3(0x1ea)]});return _0x40a781;}else throw new common_1['HttpException'](null,common_1[_0x2926f3(0x1e5)]['BAD_REQUEST']);}}};OfficialService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x1b495a(0x20e),[autoreply_service_1[_0x1b495a(0x1d4)],user_service_1['UserService'],auth_service_1[_0x1b495a(0x1e2)],globalConfig_service_1[_0x1b495a(0x1d8)],redisCache_service_1[_0x1b495a(0x20d)]])],OfficialService),exports[_0x1b495a(0x1d0)]=OfficialService;