'use strict';function _0x106a(){const _0x445270=['28kHScNC','authService','GlobalConfigService','getUnionId','./vo/Login.vo','wechatOfficialAppId','error','official','log','defineProperty','autoreplyService','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','getUserUnionId','114xJGBSQ','./../globalConfig/globalConfig.service','__metadata','../../common/constants/redisKey.constant','officialAutoReplyText','crypto','errmsg','verify','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','wechatAccessToken','4527WVtVdd','&openid=',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','globalConfigService','HttpStatus','&redirect_uri=','getConfigByKeys','16952cUZPtW','update','bindWxBySceneStr','19553080SjDCUQ','toFixed','get','&code=','genXmlMsg','----------------获取微信登录令牌AccessToken----------------','default','jiangly','WE_MINI_ACCESS_KEY','length','sceneStrMap','valueOf','Injectable','@nestjs/common','bindWx','fetchQRCodeTicket','scan','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','authToken','loginByCode','aotoPlay','&grant_type=authorization_code','genXmlMsgByConfig',']]></Content>\x0a\x20\x20\x20\x20</xml>','566699CLimqN','decorate','checkAutoReply','UserService','jsapi_ticket=','sort','非法参数','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','getQRSceneStr','HttpException','sha1','QR_STR_SCENE','unionid','wechatUser','updateUserOpenId','392469gbHxGV','getJsapiTicket','&secret=','wechatOfficialAppSecret','OfficialService','900630CcclVe','object','userService',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','user','getRedirectUrl','post','redisCacheService','1707758kOLnSE','scanedSceneStrMap','AuthService','./../user/user.service','&url=','fromusername','getQRSceneStrByBind','join','metadata','1717969JGpDnw','&lang=zh_CN','RedisCacheService','getJwtToken','loginBySceneStr','__decorate','OfficialLoginVO','./../autoreply/autoreply.service','openId','wechatOfficialToken','&noncestr=','../redisCache/redisCache.service','mini','wechatJsapiTicket','BAD_REQUEST','createHash','appId:\x20','回跳跳转地址:\x20','AutoreplyService','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect'];_0x106a=function(){return _0x445270;};return _0x106a();}const _0x4be4df=_0x9718;(function(_0x4011a6,_0x37d0bc){const _0x591d94=_0x9718,_0x1c3f10=_0x4011a6();while(!![]){try{const _0x3ecdaf=-parseInt(_0x591d94(0x182))/0x1+-parseInt(_0x591d94(0x179))/0x2+-parseInt(_0x591d94(0x16c))/0x3*(parseInt(_0x591d94(0x124))/0x4)+-parseInt(_0x591d94(0x171))/0x5+-parseInt(_0x591d94(0x131))/0x6*(-parseInt(_0x591d94(0x15d))/0x7)+parseInt(_0x591d94(0x142))/0x8*(parseInt(_0x591d94(0x13b))/0x9)+parseInt(_0x591d94(0x145))/0xa;if(_0x3ecdaf===_0x37d0bc)break;else _0x1c3f10['push'](_0x1c3f10['shift']());}catch(_0x3a95e){_0x1c3f10['push'](_0x1c3f10['shift']());}}}(_0x106a,0xd9add));var __decorate=this&&this[_0x4be4df(0x187)]||function(_0x21e117,_0x5933d3,_0x2c2753,_0x567c43){const _0x14fda8=_0x4be4df;var _0x1a57e7=arguments[_0x14fda8(0x14e)],_0x464ccd=_0x1a57e7<0x3?_0x5933d3:_0x567c43===null?_0x567c43=Object['getOwnPropertyDescriptor'](_0x5933d3,_0x2c2753):_0x567c43,_0x518cd1;if(typeof Reflect===_0x14fda8(0x172)&&typeof Reflect[_0x14fda8(0x15e)]==='function')_0x464ccd=Reflect['decorate'](_0x21e117,_0x5933d3,_0x2c2753,_0x567c43);else{for(var _0x1eddbe=_0x21e117[_0x14fda8(0x14e)]-0x1;_0x1eddbe>=0x0;_0x1eddbe--)if(_0x518cd1=_0x21e117[_0x1eddbe])_0x464ccd=(_0x1a57e7<0x3?_0x518cd1(_0x464ccd):_0x1a57e7>0x3?_0x518cd1(_0x5933d3,_0x2c2753,_0x464ccd):_0x518cd1(_0x5933d3,_0x2c2753))||_0x464ccd;}return _0x1a57e7>0x3&&_0x464ccd&&Object[_0x14fda8(0x12d)](_0x5933d3,_0x2c2753,_0x464ccd),_0x464ccd;},__metadata=this&&this[_0x4be4df(0x133)]||function(_0x240a06,_0x39ece9){const _0xf345ea=_0x4be4df;if(typeof Reflect===_0xf345ea(0x172)&&typeof Reflect[_0xf345ea(0x181)]==='function')return Reflect[_0xf345ea(0x181)](_0x240a06,_0x39ece9);};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['OfficialService']=void 0x0;const globalConfig_service_1=require(_0x4be4df(0x132)),auth_service_1=require('./../auth/auth.service'),user_service_1=require(_0x4be4df(0x17c)),autoreply_service_1=require(_0x4be4df(0x189)),common_1=require(_0x4be4df(0x152)),crypto=require(_0x4be4df(0x136)),axios_1=require('axios'),utils_1=require('../../common/utils'),Login_vo_1=require(_0x4be4df(0x128)),redisKey_constant_1=require(_0x4be4df(0x134)),redisCache_service_1=require(_0x4be4df(0x18d)),date_1=require('../../common/utils/date');let OfficialService=class OfficialService{constructor(_0x24ca86,_0x45fb85,_0x5ba86f,_0x1734e3,_0xf5c251){const _0x549b72=_0x4be4df;this[_0x549b72(0x12e)]=_0x24ca86,this[_0x549b72(0x173)]=_0x45fb85,this[_0x549b72(0x125)]=_0x5ba86f,this[_0x549b72(0x13e)]=_0x1734e3,this[_0x549b72(0x178)]=_0xf5c251,this[_0x549b72(0x14f)]={},this[_0x549b72(0x17a)]={};}async[_0x4be4df(0x165)](_0x1a72af){const {invitedBy:_0x59c27e}=_0x1a72af;let _0x5beb6b=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x59c27e&&(_0x5beb6b+=':'+_0x59c27e),this['sceneStrMap'][_0x5beb6b]=!![],_0x5beb6b;}async[_0x4be4df(0x17f)](_0x4f8f0f){const _0x11b88d=_0x4be4df,{id:_0x482345}=_0x4f8f0f[_0x11b88d(0x175)],_0x510f7e=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x482345;return this[_0x11b88d(0x14f)][_0x510f7e]=!![],_0x510f7e;}async['getQRCodeTicket'](_0x4d1398){const _0x272e1b=_0x4be4df;return this[_0x272e1b(0x154)](_0x4d1398);}async[_0x4be4df(0x176)](_0xa96bc6){const _0x3f3770=_0x4be4df,_0x37c80d=await this[_0x3f3770(0x13e)]['getConfigByKeys']([_0x3f3770(0x129)]),_0x2945d3='https://open.weixin.qq.com/connect/oauth2/authorize?appid='+_0x37c80d+_0x3f3770(0x140)+encodeURIComponent(_0xa96bc6)+_0x3f3770(0x123);return console['log'](_0x3f3770(0x121),_0x2945d3),_0x2945d3;}async[_0x4be4df(0x16d)](_0x22a6d9){const _0x22a118=_0x4be4df,_0x62b3fb=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x3b56bf=(Date['now']()/0x3e8)[_0x22a118(0x146)](0x0),_0x4b5ecb=await this[_0x22a118(0x13e)][_0x22a118(0x141)]([_0x22a118(0x18f),'wechatOfficialAppId']),{wechatJsapiTicket:_0x2f1ec7,wechatOfficialAppId:_0x42dd2f}=_0x4b5ecb;console[_0x22a118(0x12c)]('jsapiTicket:\x20',_0x2f1ec7),console[_0x22a118(0x12c)](_0x22a118(0x120),_0x42dd2f);const _0x74c6ef=_0x22a118(0x161)+_0x2f1ec7+_0x22a118(0x18c)+_0x62b3fb+'&timestamp='+_0x3b56bf+_0x22a118(0x17d)+_0x22a6d9;console[_0x22a118(0x12c)]('str:\x20',_0x74c6ef);const _0x507b77=this[_0x22a118(0x167)](_0x74c6ef);return{'appId':_0x42dd2f,'nonceStr':_0x62b3fb,'timestamp':_0x3b56bf,'signature':_0x507b77};}async[_0x4be4df(0x154)](_0x56495b){const _0x3ebf2e=_0x4be4df,_0x49a701=await this[_0x3ebf2e(0x13e)]['getConfigByKeys']([_0x3ebf2e(0x13a)]);console['log'](_0x3ebf2e(0x14a),_0x49a701);const _0x52c5b7={'action_name':_0x3ebf2e(0x168),'action_info':{'scene':{'scene_str':_0x56495b}}},_0x5e2285=await axios_1['default'][_0x3ebf2e(0x177)](_0x3ebf2e(0x12f)+_0x49a701,_0x52c5b7),{data:{errmsg:_0x405065,ticket:_0x4b696b}}=_0x5e2285;if(_0x405065)throw new common_1['HttpException'](_0x405065,common_1[_0x3ebf2e(0x13f)][_0x3ebf2e(0x190)]);return _0x4b696b;}async[_0x4be4df(0x158)](_0x56c0b5,_0x526318){const _0x8547a=_0x4be4df,_0x2d05ce=await this[_0x8547a(0x13e)][_0x8547a(0x141)]([_0x8547a(0x129),_0x8547a(0x16f)]),{wechatOfficialAppId:_0x33937c,wechatOfficialAppSecret:_0x3a6fa7}=_0x2d05ce,_0x344e0b=await axios_1[_0x8547a(0x14b)][_0x8547a(0x147)]('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+_0x33937c+_0x8547a(0x16e)+_0x3a6fa7+_0x8547a(0x148)+_0x526318+_0x8547a(0x15a)),{data:{errmsg:_0x565e65,openid:_0x2468d6,access_token:_0x456dc0,unionid:_0x1ad334}}=_0x344e0b;if(_0x565e65)throw new common_1[(_0x8547a(0x166))](_0x565e65,common_1['HttpStatus']['BAD_REQUEST']);let _0x2ff9d8=new Login_vo_1[(_0x8547a(0x188))]();_0x2ff9d8[_0x8547a(0x18a)]=_0x2468d6,_0x2ff9d8[_0x8547a(0x169)]=_0x1ad334;let _0x33e952;_0x1ad334&&(_0x33e952=await this[_0x8547a(0x173)][_0x8547a(0x130)](_0x1ad334));!_0x33e952&&(_0x33e952=await this[_0x8547a(0x173)]['getUserOpenId'](_0x2468d6));if(_0x33e952)_0x33e952[_0x8547a(0x169)]=_0x1ad334,_0x33e952[_0x8547a(0x18a)]=_0x2468d6,await this[_0x8547a(0x173)][_0x8547a(0x16b)](_0x33e952['id'],_0x2468d6,_0x1ad334),_0x2ff9d8[_0x8547a(0x157)]=await this[_0x8547a(0x125)][_0x8547a(0x185)](_0x33e952,_0x56c0b5);else{if(_0x456dc0){const {data:_0x52e178}=await axios_1[_0x8547a(0x14b)][_0x8547a(0x147)](_0x8547a(0x164)+_0x456dc0+_0x8547a(0x13c)+_0x2468d6+_0x8547a(0x183));!_0x52e178[_0x8547a(0x137)]&&console[_0x8547a(0x12a)](_0x52e178[_0x8547a(0x137)]),_0x2ff9d8[_0x8547a(0x16a)]=_0x52e178;}}return _0x2ff9d8;}async[_0x4be4df(0x155)](_0x99455d,_0x2e401a){const _0x158379=_0x4be4df;if(!this['sceneStrMap'][_0x2e401a])throw new common_1[(_0x158379(0x166))](_0x158379(0x163),common_1[_0x158379(0x13f)][_0x158379(0x190)]);this[_0x158379(0x17a)][_0x2e401a]=_0x99455d;}async[_0x4be4df(0x186)](_0x52b5db,_0x147c9e){const _0x354a4c=_0x4be4df;if(!this[_0x354a4c(0x14f)][_0x147c9e])return;const _0x18789b=this['scanedSceneStrMap'][_0x147c9e];if(!_0x18789b)return new Login_vo_1['OfficialLoginVO']();let _0x36a6f1=new Login_vo_1['OfficialLoginVO']();_0x36a6f1['openId']=_0x18789b;const _0x40b275=await this['userService']['getUserOpenId'](_0x18789b);return _0x40b275&&(_0x36a6f1[_0x354a4c(0x157)]=await this[_0x354a4c(0x125)][_0x354a4c(0x185)](_0x40b275,_0x52b5db)),delete this['scanedSceneStrMap'][_0x147c9e],_0x36a6f1;}async[_0x4be4df(0x127)](_0x24d472){const _0x4b26f1=_0x4be4df,_0xecdd4c=await this[_0x4b26f1(0x13e)][_0x4b26f1(0x141)]([_0x4b26f1(0x13a)]),{data:_0xec3f24}=await axios_1[_0x4b26f1(0x14b)][_0x4b26f1(0x147)](_0x4b26f1(0x139)+_0xecdd4c+_0x4b26f1(0x13c)+_0x24d472+'&lang=zh_CN');return _0xec3f24?.[_0x4b26f1(0x169)];}async['scanBindWx'](_0xbc59bb,_0x303101){const _0x51a766=_0x4be4df;if(!this[_0x51a766(0x14f)][_0x303101])throw new common_1[(_0x51a766(0x166))](_0x51a766(0x163),common_1[_0x51a766(0x13f)][_0x51a766(0x190)]);const _0x3caf60=_0x303101['split']('/')[0x1],_0x614d5f=await this[_0x51a766(0x127)](_0xbc59bb),_0x54df6c=await this['userService'][_0x51a766(0x153)](_0xbc59bb,_0x614d5f,_0x3caf60);this['scanedSceneStrMap'][_0x303101]=_0x54df6c;}async[_0x4be4df(0x144)](_0x13da7b,_0x3952e1){const _0x52f659=_0x4be4df;if(!this[_0x52f659(0x14f)][_0x3952e1])throw new common_1[(_0x52f659(0x166))](_0x52f659(0x163),common_1[_0x52f659(0x13f)][_0x52f659(0x190)]);const {id:_0x2c3526}=_0x13da7b['user'],_0x4709ba=this[_0x52f659(0x17a)][_0x3952e1];if(!_0x4709ba)return'';return delete this[_0x52f659(0x17a)][_0x3952e1],_0x4709ba;}async[_0x4be4df(0x138)](_0x316aa8,_0x2c5201,_0xac9859){const _0x19769a=_0x4be4df,_0x236961=await this[_0x19769a(0x13e)][_0x19769a(0x141)]([_0x19769a(0x18b)]),_0x8b6fd=_0x236961||_0x19769a(0x14c);return await this[_0x19769a(0x167)]([_0x8b6fd,_0x2c5201,_0xac9859][_0x19769a(0x162)]()[_0x19769a(0x180)](''))==_0x316aa8;}[_0x4be4df(0x167)](_0x43cc20){const _0x1af344=_0x4be4df;return crypto[_0x1af344(0x11f)](_0x1af344(0x167))[_0x1af344(0x143)](_0x43cc20)['digest']('hex');}async[_0x4be4df(0x15b)](_0x5afabe,_0x1c51c6){const _0x31eb6e=_0x4be4df,_0x1935fb=await this['globalConfigService'][_0x31eb6e(0x141)]([_0x1c51c6]);return this[_0x31eb6e(0x149)](_0x5afabe,_0x1935fb);}async[_0x4be4df(0x149)](_0x2cc3c3,_0x455597){const _0x2f041d=_0x4be4df;return _0x2f041d(0x156)+_0x2cc3c3[_0x2f041d(0x17e)][0x0]+_0x2f041d(0x13d)+_0x2cc3c3['tousername'][0x0]+_0x2f041d(0x174)+(0x0,date_1[_0x2f041d(0x14b)])()[_0x2f041d(0x150)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x455597+_0x2f041d(0x15c);}async[_0x4be4df(0x159)](_0x5a3dd1){const _0x8423e7=_0x4be4df;let _0x29040e=await this['autoreplyService'][_0x8423e7(0x15f)](_0x5a3dd1);if(!_0x29040e){const _0x27bf1e=await this['globalConfigService'][_0x8423e7(0x141)]([_0x8423e7(0x135)]);_0x29040e=_0x27bf1e;}return _0x29040e;}async['getAccessToken'](_0x14ebd7,_0x12dbfa){const _0x55cfbf=_0x4be4df;console[_0x55cfbf(0x12c)](_0x14ebd7['ip']);if(_0x12dbfa===_0x55cfbf(0x12b)){const _0xf95c7b=await this[_0x55cfbf(0x13e)][_0x55cfbf(0x141)]([_0x55cfbf(0x13a)]);return _0xf95c7b;}else{if(_0x12dbfa===_0x55cfbf(0x18e)){const _0x999039=await this[_0x55cfbf(0x178)][_0x55cfbf(0x147)]({'key':redisKey_constant_1[_0x55cfbf(0x14d)]});return _0x999039;}else throw new common_1[(_0x55cfbf(0x166))](null,common_1[_0x55cfbf(0x13f)][_0x55cfbf(0x190)]);}}};function _0x9718(_0x35bad0,_0x244b3d){const _0x106aec=_0x106a();return _0x9718=function(_0x971873,_0x18e8be){_0x971873=_0x971873-0x11f;let _0x1f657b=_0x106aec[_0x971873];return _0x1f657b;},_0x9718(_0x35bad0,_0x244b3d);}OfficialService=__decorate([(0x0,common_1[_0x4be4df(0x151)])(),__metadata('design:paramtypes',[autoreply_service_1[_0x4be4df(0x122)],user_service_1[_0x4be4df(0x160)],auth_service_1[_0x4be4df(0x17b)],globalConfig_service_1[_0x4be4df(0x126)],redisCache_service_1[_0x4be4df(0x184)]])],OfficialService),exports[_0x4be4df(0x170)]=OfficialService;