'use strict';const _0x46d409=_0x5d53;(function(_0x5d69b6,_0x55249c){const _0x388d03=_0x5d53,_0x30331a=_0x5d69b6();while(!![]){try{const _0x184d5e=-parseInt(_0x388d03(0x1cf))/0x1+parseInt(_0x388d03(0x183))/0x2+parseInt(_0x388d03(0x1ac))/0x3+-parseInt(_0x388d03(0x175))/0x4*(parseInt(_0x388d03(0x16e))/0x5)+parseInt(_0x388d03(0x1b9))/0x6*(-parseInt(_0x388d03(0x185))/0x7)+-parseInt(_0x388d03(0x1b2))/0x8+parseInt(_0x388d03(0x17c))/0x9;if(_0x184d5e===_0x55249c)break;else _0x30331a['push'](_0x30331a['shift']());}catch(_0x53c5d8){_0x30331a['push'](_0x30331a['shift']());}}}(_0x2ade,0x26dbb));var __decorate=this&&this['__decorate']||function(_0x1cca7d,_0x2d4aab,_0x5ee862,_0x367fab){const _0x4a7b0b=_0x5d53;var _0x5373bf=arguments[_0x4a7b0b(0x195)],_0x5698cb=_0x5373bf<0x3?_0x2d4aab:_0x367fab===null?_0x367fab=Object[_0x4a7b0b(0x19b)](_0x2d4aab,_0x5ee862):_0x367fab,_0xd30655;if(typeof Reflect==='object'&&typeof Reflect[_0x4a7b0b(0x190)]===_0x4a7b0b(0x167))_0x5698cb=Reflect[_0x4a7b0b(0x190)](_0x1cca7d,_0x2d4aab,_0x5ee862,_0x367fab);else{for(var _0x598486=_0x1cca7d[_0x4a7b0b(0x195)]-0x1;_0x598486>=0x0;_0x598486--)if(_0xd30655=_0x1cca7d[_0x598486])_0x5698cb=(_0x5373bf<0x3?_0xd30655(_0x5698cb):_0x5373bf>0x3?_0xd30655(_0x2d4aab,_0x5ee862,_0x5698cb):_0xd30655(_0x2d4aab,_0x5ee862))||_0x5698cb;}return _0x5373bf>0x3&&_0x5698cb&&Object[_0x4a7b0b(0x1bd)](_0x2d4aab,_0x5ee862,_0x5698cb),_0x5698cb;},__metadata=this&&this[_0x46d409(0x1c8)]||function(_0x190db3,_0x3a9457){const _0x1ffe92=_0x46d409;if(typeof Reflect===_0x1ffe92(0x1bb)&&typeof Reflect[_0x1ffe92(0x1d1)]===_0x1ffe92(0x167))return Reflect['metadata'](_0x190db3,_0x3a9457);};Object[_0x46d409(0x1bd)](exports,'__esModule',{'value':!![]}),exports[_0x46d409(0x16c)]=void 0x0;const globalConfig_service_1=require(_0x46d409(0x1c1)),auth_service_1=require(_0x46d409(0x18d)),user_service_1=require(_0x46d409(0x1c0)),autoreply_service_1=require(_0x46d409(0x1bf)),common_1=require(_0x46d409(0x16f)),crypto=require('crypto'),axios_1=require(_0x46d409(0x1b4)),utils_1=require('../../common/utils'),Login_vo_1=require(_0x46d409(0x1b1)),redisKey_constant_1=require(_0x46d409(0x1d2)),redisCache_service_1=require('../redisCache/redisCache.service'),date_1=require(_0x46d409(0x16a));let OfficialService=class OfficialService{constructor(_0x5ea949,_0x18dfa4,_0x351c8f,_0x3c858b,_0x2e269a){const _0x5be617=_0x46d409;this[_0x5be617(0x182)]=_0x5ea949,this[_0x5be617(0x1ae)]=_0x18dfa4,this[_0x5be617(0x1c6)]=_0x351c8f,this['globalConfigService']=_0x3c858b,this[_0x5be617(0x1d8)]=_0x2e269a,this['sceneStrMap']={},this[_0x5be617(0x17d)]={};}async['getQRSceneStr'](_0x122eb6){const _0x2f1155=_0x46d409,{invitedBy:_0xf14a86}=_0x122eb6;let _0x9c3b3b=(0x0,utils_1[_0x2f1155(0x1d0)])(0x20);return _0xf14a86&&(_0x9c3b3b+=':'+_0xf14a86),this[_0x2f1155(0x174)][_0x9c3b3b]=!![],_0x9c3b3b;}async['getQRSceneStrByBind'](_0xa2437a){const _0x21605b=_0x46d409,{id:_0x13ce04}=_0xa2437a[_0x21605b(0x176)],_0x30de4d=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x13ce04;return this[_0x21605b(0x174)][_0x30de4d]=!![],_0x30de4d;}async['getQRCodeTicket'](_0x58159f){return this['fetchQRCodeTicket'](_0x58159f);}async[_0x46d409(0x1ba)](_0x4e6ba7){const _0x5b01f5=_0x46d409,_0x56b96c=await this[_0x5b01f5(0x1d4)][_0x5b01f5(0x1af)](['wechatOfficialAppId']),_0x2d9156=_0x5b01f5(0x197)+_0x56b96c+_0x5b01f5(0x17e)+encodeURIComponent(_0x4e6ba7)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x5b01f5(0x18c)]('回跳跳转地址:\x20',_0x2d9156),_0x2d9156;}async[_0x46d409(0x1d6)](_0x3fc1b9){const _0x5d59ba=_0x46d409,_0x30ee7e=(0x0,utils_1[_0x5d59ba(0x1d0)])(0x20),_0x168bba=(Date['now']()/0x3e8)['toFixed'](0x0),_0x3518b4=await this[_0x5d59ba(0x1d4)][_0x5d59ba(0x1af)]([_0x5d59ba(0x1c3),_0x5d59ba(0x169)]),{wechatJsapiTicket:_0x400ba6,wechatOfficialAppId:_0x158e98}=_0x3518b4;console['log'](_0x5d59ba(0x173),_0x400ba6),console['log']('appId:\x20',_0x158e98);const _0x392b21=_0x5d59ba(0x1cb)+_0x400ba6+_0x5d59ba(0x193)+_0x30ee7e+_0x5d59ba(0x1a1)+_0x168bba+_0x5d59ba(0x19a)+_0x3fc1b9;console[_0x5d59ba(0x18c)](_0x5d59ba(0x168),_0x392b21);const _0x3c070c=this[_0x5d59ba(0x1cc)](_0x392b21);return{'appId':_0x158e98,'nonceStr':_0x30ee7e,'timestamp':_0x168bba,'signature':_0x3c070c};}async[_0x46d409(0x189)](_0x5c0dbd){const _0x246414=_0x46d409,_0x3dfbfa=await this[_0x246414(0x1d4)][_0x246414(0x1af)]([_0x246414(0x1d7)]),_0x5b3bef={'action_name':_0x246414(0x1a8),'action_info':{'scene':{'scene_str':_0x5c0dbd}}},_0x1dccc3=await axios_1[_0x246414(0x1be)][_0x246414(0x1a2)](_0x246414(0x19e)+_0x3dfbfa,_0x5b3bef),{data:{errmsg:_0x53e8aa,ticket:_0xfa0dfa}}=_0x1dccc3;if(_0x53e8aa)throw new common_1[(_0x246414(0x181))](_0x53e8aa,common_1[_0x246414(0x18e)][_0x246414(0x19f)]);return _0xfa0dfa;}async[_0x46d409(0x17f)](_0x39afc4,_0xa3fb46){const _0x550d39=_0x46d409,_0x90375b=await this['globalConfigService'][_0x550d39(0x1af)]([_0x550d39(0x169),_0x550d39(0x1b5)]),{wechatOfficialAppId:_0x5eeaf6,wechatOfficialAppSecret:_0x8db492}=_0x90375b,_0x190240=await axios_1['default'][_0x550d39(0x164)](_0x550d39(0x180)+_0x5eeaf6+_0x550d39(0x1a9)+_0x8db492+_0x550d39(0x17a)+_0xa3fb46+_0x550d39(0x178)),{data:{errmsg:_0x4ddc51,openid:_0x221b82,access_token:_0x1e084a,unionid:_0x340714}}=_0x190240;if(_0x4ddc51)throw new common_1[(_0x550d39(0x181))](_0x4ddc51,common_1[_0x550d39(0x18e)]['BAD_REQUEST']);let _0x3e7b5a=new Login_vo_1[(_0x550d39(0x166))]();_0x3e7b5a[_0x550d39(0x186)]=_0x221b82,_0x3e7b5a['unionid']=_0x340714;let _0x1097b7;_0x340714&&(_0x1097b7=await this[_0x550d39(0x1ae)][_0x550d39(0x1aa)](_0x340714));!_0x1097b7&&(_0x1097b7=await this[_0x550d39(0x1ae)]['getUserOpenId'](_0x221b82));if(_0x1097b7)_0x1097b7[_0x550d39(0x170)]=_0x340714,_0x1097b7[_0x550d39(0x186)]=_0x221b82,await this[_0x550d39(0x1ae)][_0x550d39(0x1a3)](_0x1097b7['id'],_0x221b82,_0x340714),_0x3e7b5a[_0x550d39(0x187)]=await this['authService'][_0x550d39(0x1ab)](_0x1097b7,_0x39afc4);else{if(_0x1e084a){const {data:_0x27cc48}=await axios_1['default'][_0x550d39(0x164)](_0x550d39(0x1a0)+_0x1e084a+_0x550d39(0x1a6)+_0x221b82+_0x550d39(0x177));!_0x27cc48[_0x550d39(0x1c7)]&&console[_0x550d39(0x191)](_0x27cc48[_0x550d39(0x1c7)]),_0x3e7b5a[_0x550d39(0x17b)]=_0x27cc48;}}return _0x3e7b5a;}async[_0x46d409(0x1d5)](_0x56316e,_0x44966e){const _0x46b05d=_0x46d409;if(!this[_0x46b05d(0x174)][_0x44966e])throw new common_1[(_0x46b05d(0x181))](_0x46b05d(0x188),common_1[_0x46b05d(0x18e)][_0x46b05d(0x19f)]);this[_0x46b05d(0x17d)][_0x44966e]=_0x56316e;}async['loginBySceneStr'](_0x4d8a31,_0x4cabd4){const _0x18217a=_0x46d409;if(!this[_0x18217a(0x174)][_0x4cabd4])return;const _0x5d1715=this[_0x18217a(0x17d)][_0x4cabd4];if(!_0x5d1715)return new Login_vo_1[(_0x18217a(0x166))]();let _0x425006=new Login_vo_1[(_0x18217a(0x166))]();_0x425006['openId']=_0x5d1715;const _0x15d65e=await this[_0x18217a(0x1ae)]['getUserOpenId'](_0x5d1715);return _0x15d65e&&(_0x425006['authToken']=await this[_0x18217a(0x1c6)][_0x18217a(0x1ab)](_0x15d65e,_0x4d8a31)),delete this[_0x18217a(0x17d)][_0x4cabd4],_0x425006;}async[_0x46d409(0x1ce)](_0x203159,_0x284b87){const _0x3992bb=_0x46d409;if(!this[_0x3992bb(0x174)][_0x284b87])throw new common_1['HttpException']('非法参数',common_1[_0x3992bb(0x18e)][_0x3992bb(0x19f)]);const _0x1dfc54=_0x284b87[_0x3992bb(0x18b)]('/')[0x1],_0x8f5786=await this[_0x3992bb(0x1ae)][_0x3992bb(0x165)](_0x203159,_0x1dfc54);this[_0x3992bb(0x17d)][_0x284b87]=_0x8f5786;}async[_0x46d409(0x19d)](_0x2c420d,_0x2d47f7){const _0x3b5ca7=_0x46d409;if(!this[_0x3b5ca7(0x174)][_0x2d47f7])throw new common_1[(_0x3b5ca7(0x181))](_0x3b5ca7(0x188),common_1[_0x3b5ca7(0x18e)]['BAD_REQUEST']);const {id:_0xc9e72e}=_0x2c420d[_0x3b5ca7(0x176)],_0x2e2acf=this[_0x3b5ca7(0x17d)][_0x2d47f7];if(!_0x2e2acf)return'';return delete this[_0x3b5ca7(0x17d)][_0x2d47f7],_0x2e2acf;}async[_0x46d409(0x1a7)](_0x447332,_0x2a5223,_0x15ca83){const _0x2c1996=_0x46d409,_0x4c7c78=await this[_0x2c1996(0x1d4)]['getConfigByKeys']([_0x2c1996(0x16b)]),_0x25768a=_0x4c7c78||_0x2c1996(0x199);return await this[_0x2c1996(0x1cc)]([_0x25768a,_0x2a5223,_0x15ca83][_0x2c1996(0x1a4)]()[_0x2c1996(0x192)](''))==_0x447332;}['sha1'](_0x5470cb){const _0x3d01d0=_0x46d409;return crypto[_0x3d01d0(0x1b0)](_0x3d01d0(0x1cc))[_0x3d01d0(0x1a5)](_0x5470cb)[_0x3d01d0(0x1b3)](_0x3d01d0(0x1ca));}async[_0x46d409(0x19c)](_0x4dee88,_0x4cf82f){const _0x57e625=_0x46d409,_0x12a60e=await this[_0x57e625(0x1d4)][_0x57e625(0x1af)]([_0x4cf82f]);return this[_0x57e625(0x172)](_0x4dee88,_0x12a60e);}async['genXmlMsg'](_0x1fea7b,_0x123644){const _0x10ae08=_0x46d409;return _0x10ae08(0x1ad)+_0x1fea7b[_0x10ae08(0x1c9)][0x0]+_0x10ae08(0x16d)+_0x1fea7b[_0x10ae08(0x1c4)][0x0]+_0x10ae08(0x1b6)+(0x0,date_1['default'])()[_0x10ae08(0x1d3)]()+_0x10ae08(0x179)+_0x123644+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x46d409(0x1b7)](_0xc8f3c0){const _0x37b08b=_0x46d409;let _0x47a170=await this[_0x37b08b(0x182)][_0x37b08b(0x171)](_0xc8f3c0);if(!_0x47a170){const _0x1f067c=await this[_0x37b08b(0x1d4)][_0x37b08b(0x1af)]([_0x37b08b(0x194)]);_0x47a170=_0x1f067c;}return _0x47a170;}async[_0x46d409(0x1bc)](_0x26c6d1,_0x1b8748){const _0x4d7055=_0x46d409;console[_0x4d7055(0x18c)](_0x26c6d1['ip']);if(_0x1b8748==='official'){const _0x2d5afb=await this[_0x4d7055(0x1d4)][_0x4d7055(0x1af)]([_0x4d7055(0x1d7)]);return _0x2d5afb;}else{if(_0x1b8748===_0x4d7055(0x184)){const _0x121a61=await this[_0x4d7055(0x1d8)][_0x4d7055(0x164)]({'key':redisKey_constant_1[_0x4d7055(0x1c2)]});return _0x121a61;}else throw new common_1['HttpException'](null,common_1[_0x4d7055(0x18e)]['BAD_REQUEST']);}}};function _0x2ade(){const _0xdf80fe=['userService','getConfigByKeys','createHash','./vo/Login.vo','2177800lGeZZJ','digest','axios','wechatOfficialAppSecret',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','aotoPlay','RedisCacheService','6TuOMkG','getRedirectUrl','object','getAccessToken','defineProperty','default','./../autoreply/autoreply.service','./../user/user.service','./../globalConfig/globalConfig.service','WE_MINI_ACCESS_KEY','wechatJsapiTicket','tousername','AuthService','authService','errmsg','__metadata','fromusername','hex','jsapi_ticket=','sha1','Injectable','scanBindWx','92356gXFOJu','createRandomNonceStr','metadata','../../common/constants/redisKey.constant','valueOf','globalConfigService','scan','getJsapiTicket','wechatAccessToken','redisCacheService','get','bindWx','OfficialLoginVO','function','str:\x20','wechatOfficialAppId','../../common/utils/date','wechatOfficialToken','OfficialService',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','10WYAmOR','@nestjs/common','unionid','checkAutoReply','genXmlMsg','jsapiTicket:\x20','sceneStrMap','159012GDgyBX','user','&lang=zh_CN','&grant_type=authorization_code','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','&code=','wechatUser','2957445nbqbkx','scanedSceneStrMap','&redirect_uri=','loginByCode','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','HttpException','autoreplyService','62060rFHYTK','mini','267547kZTRIf','openId','authToken','非法参数','fetchQRCodeTicket','GlobalConfigService','split','log','./../auth/auth.service','HttpStatus','UserService','decorate','error','join','&noncestr=','officialAutoReplyText','length','AutoreplyService','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','design:paramtypes','jiangly','&url=','getOwnPropertyDescriptor','genXmlMsgByConfig','bindWxBySceneStr','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','BAD_REQUEST','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','&timestamp=','post','updateUserOpenId','sort','update','&openid=','verify','QR_STR_SCENE','&secret=','getUserUnionId','getJwtToken','845508GvQHpz','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['];_0x2ade=function(){return _0xdf80fe;};return _0x2ade();}function _0x5d53(_0x424720,_0x401179){const _0x2adebc=_0x2ade();return _0x5d53=function(_0x5d533e,_0x325c66){_0x5d533e=_0x5d533e-0x164;let _0xd3c374=_0x2adebc[_0x5d533e];return _0xd3c374;},_0x5d53(_0x424720,_0x401179);}OfficialService=__decorate([(0x0,common_1[_0x46d409(0x1cd)])(),__metadata(_0x46d409(0x198),[autoreply_service_1[_0x46d409(0x196)],user_service_1[_0x46d409(0x18f)],auth_service_1[_0x46d409(0x1c5)],globalConfig_service_1[_0x46d409(0x18a)],redisCache_service_1[_0x46d409(0x1b8)]])],OfficialService),exports[_0x46d409(0x16c)]=OfficialService;