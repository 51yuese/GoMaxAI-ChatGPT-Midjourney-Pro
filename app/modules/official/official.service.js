'use strict';const _0x2a614b=_0x4b00;(function(_0x2cf4de,_0x4a11ee){const _0x222952=_0x4b00,_0x4f1b50=_0x2cf4de();while(!![]){try{const _0x2e4eee=-parseInt(_0x222952(0x1d8))/0x1*(-parseInt(_0x222952(0x218))/0x2)+-parseInt(_0x222952(0x234))/0x3*(parseInt(_0x222952(0x1db))/0x4)+parseInt(_0x222952(0x21c))/0x5*(-parseInt(_0x222952(0x1e2))/0x6)+parseInt(_0x222952(0x225))/0x7+parseInt(_0x222952(0x23a))/0x8*(parseInt(_0x222952(0x1d0))/0x9)+parseInt(_0x222952(0x236))/0xa*(-parseInt(_0x222952(0x20d))/0xb)+-parseInt(_0x222952(0x1f2))/0xc*(-parseInt(_0x222952(0x217))/0xd);if(_0x2e4eee===_0x4a11ee)break;else _0x4f1b50['push'](_0x4f1b50['shift']());}catch(_0x5cc14d){_0x4f1b50['push'](_0x4f1b50['shift']());}}}(_0x4ab0,0xc1265));var __decorate=this&&this[_0x2a614b(0x212)]||function(_0x36db34,_0x33ff0a,_0x434150,_0x2872ca){const _0x147baf=_0x2a614b;var _0x43e159=arguments[_0x147baf(0x221)],_0x281ab6=_0x43e159<0x3?_0x33ff0a:_0x2872ca===null?_0x2872ca=Object[_0x147baf(0x23f)](_0x33ff0a,_0x434150):_0x2872ca,_0x1f5fef;if(typeof Reflect===_0x147baf(0x23d)&&typeof Reflect[_0x147baf(0x202)]===_0x147baf(0x206))_0x281ab6=Reflect[_0x147baf(0x202)](_0x36db34,_0x33ff0a,_0x434150,_0x2872ca);else{for(var _0xd894b0=_0x36db34[_0x147baf(0x221)]-0x1;_0xd894b0>=0x0;_0xd894b0--)if(_0x1f5fef=_0x36db34[_0xd894b0])_0x281ab6=(_0x43e159<0x3?_0x1f5fef(_0x281ab6):_0x43e159>0x3?_0x1f5fef(_0x33ff0a,_0x434150,_0x281ab6):_0x1f5fef(_0x33ff0a,_0x434150))||_0x281ab6;}return _0x43e159>0x3&&_0x281ab6&&Object[_0x147baf(0x21d)](_0x33ff0a,_0x434150,_0x281ab6),_0x281ab6;},__metadata=this&&this[_0x2a614b(0x232)]||function(_0x596093,_0x880b5e){const _0x25c95e=_0x2a614b;if(typeof Reflect==='object'&&typeof Reflect[_0x25c95e(0x204)]===_0x25c95e(0x206))return Reflect['metadata'](_0x596093,_0x880b5e);};function _0x4b00(_0x131dc5,_0x168941){const _0x4ab049=_0x4ab0();return _0x4b00=function(_0x4b00be,_0xd14862){_0x4b00be=_0x4b00be-0x1c9;let _0x1a4cd6=_0x4ab049[_0x4b00be];return _0x1a4cd6;},_0x4b00(_0x131dc5,_0x168941);}Object[_0x2a614b(0x21d)](exports,_0x2a614b(0x237),{'value':!![]}),exports[_0x2a614b(0x22b)]=void 0x0;const globalConfig_service_1=require(_0x2a614b(0x21a)),auth_service_1=require(_0x2a614b(0x21e)),user_service_1=require(_0x2a614b(0x1de)),autoreply_service_1=require(_0x2a614b(0x1df)),common_1=require('@nestjs/common'),crypto=require('crypto'),axios_1=require(_0x2a614b(0x1cc)),utils_1=require(_0x2a614b(0x229)),Login_vo_1=require(_0x2a614b(0x223)),redisKey_constant_1=require(_0x2a614b(0x22f)),redisCache_service_1=require('../redisCache/redisCache.service'),date_1=require(_0x2a614b(0x1f6));let OfficialService=class OfficialService{constructor(_0x39e766,_0xf82fdb,_0x3a36c5,_0x445d5b,_0x47cf52){const _0x12a645=_0x2a614b;this[_0x12a645(0x1e6)]=_0x39e766,this['userService']=_0xf82fdb,this[_0x12a645(0x1d6)]=_0x3a36c5,this[_0x12a645(0x235)]=_0x445d5b,this[_0x12a645(0x209)]=_0x47cf52,this[_0x12a645(0x1e0)]={},this[_0x12a645(0x208)]={};}async[_0x2a614b(0x213)](_0x1985af){const _0x1c70cc=_0x2a614b,{invitedBy:_0x26fe12}=_0x1985af;let _0x2209d8=(0x0,utils_1[_0x1c70cc(0x210)])(0x20);return _0x26fe12&&(_0x2209d8+=':'+_0x26fe12),this[_0x1c70cc(0x1e0)][_0x2209d8]=!![],_0x2209d8;}async[_0x2a614b(0x1d3)](_0x5abd75){const _0xde6368=_0x2a614b,{id:_0x4ded78}=_0x5abd75['user'],_0x53f7d0=(0x0,utils_1[_0xde6368(0x210)])(0x20)+'/'+_0x4ded78;return this[_0xde6368(0x1e0)][_0x53f7d0]=!![],_0x53f7d0;}async[_0x2a614b(0x207)](_0xee2409){return this['fetchQRCodeTicket'](_0xee2409);}async[_0x2a614b(0x1d7)](_0x20dfd0){const _0x52c8e1=_0x2a614b,_0x2debfe=await this[_0x52c8e1(0x235)][_0x52c8e1(0x1d4)](['wechatOfficialAppId']),_0xed098f=_0x52c8e1(0x239)+_0x2debfe+_0x52c8e1(0x1ea)+encodeURIComponent(_0x20dfd0)+_0x52c8e1(0x1e4);return console[_0x52c8e1(0x21b)](_0x52c8e1(0x227),_0xed098f),_0xed098f;}async['getJsapiTicket'](_0x26645f){const _0x34f664=_0x2a614b,_0x1fa407=(0x0,utils_1[_0x34f664(0x210)])(0x20),_0x16d012=(Date[_0x34f664(0x230)]()/0x3e8)[_0x34f664(0x23c)](0x0),_0x56274c=await this[_0x34f664(0x235)][_0x34f664(0x1d4)]([_0x34f664(0x1cf),_0x34f664(0x240)]),{wechatJsapiTicket:_0x2c6417,wechatOfficialAppId:_0xdae3e6}=_0x56274c;console[_0x34f664(0x21b)]('jsapiTicket:\x20',_0x2c6417),console[_0x34f664(0x21b)](_0x34f664(0x21f),_0xdae3e6);const _0x5985ee=_0x34f664(0x22e)+_0x2c6417+_0x34f664(0x1e3)+_0x1fa407+_0x34f664(0x1c9)+_0x16d012+_0x34f664(0x22d)+_0x26645f;console[_0x34f664(0x21b)](_0x34f664(0x1eb),_0x5985ee);const _0x1b2e0d=this[_0x34f664(0x1e8)](_0x5985ee);return{'appId':_0xdae3e6,'nonceStr':_0x1fa407,'timestamp':_0x16d012,'signature':_0x1b2e0d};}async[_0x2a614b(0x1fe)](_0xbfc0d6){const _0x27cdd3=_0x2a614b,_0x18cf1f=await this['globalConfigService'][_0x27cdd3(0x1d4)]([_0x27cdd3(0x1f0)]),_0x49a98b={'action_name':_0x27cdd3(0x1d9),'action_info':{'scene':{'scene_str':_0xbfc0d6}}},_0x27c830=await axios_1[_0x27cdd3(0x1f7)]['post'](_0x27cdd3(0x1f5)+_0x18cf1f,_0x49a98b),{data:{errmsg:_0xac8a4c,ticket:_0x22998f}}=_0x27c830;if(_0xac8a4c)throw new common_1[(_0x27cdd3(0x1e7))](_0xac8a4c,common_1[_0x27cdd3(0x1d5)][_0x27cdd3(0x23e)]);return _0x22998f;}async['loginByCode'](_0x3b861f,_0x21919e){const _0x7cba75=_0x2a614b,_0x3c08b0=await this[_0x7cba75(0x235)]['getConfigByKeys']([_0x7cba75(0x240),_0x7cba75(0x1cb)]),{wechatOfficialAppId:_0x414692,wechatOfficialAppSecret:_0x1b7ba2}=_0x3c08b0,_0x3a4880=await axios_1[_0x7cba75(0x1f7)]['get'](_0x7cba75(0x1fc)+_0x414692+_0x7cba75(0x22c)+_0x1b7ba2+_0x7cba75(0x1dd)+_0x21919e+'&grant_type=authorization_code'),{data:{errmsg:_0x151af6,openid:_0x3b4f87,access_token:_0x9017f4,unionid:_0x152db2}}=_0x3a4880;if(_0x151af6)throw new common_1[(_0x7cba75(0x1e7))](_0x151af6,common_1[_0x7cba75(0x1d5)]['BAD_REQUEST']);let _0x338af6=new Login_vo_1[(_0x7cba75(0x1ef))]();_0x338af6[_0x7cba75(0x1e9)]=_0x3b4f87,_0x338af6[_0x7cba75(0x1d2)]=_0x152db2;let _0x1cf27d;_0x152db2&&(_0x1cf27d=await this[_0x7cba75(0x1ca)][_0x7cba75(0x205)](_0x152db2));!_0x1cf27d&&(_0x1cf27d=await this[_0x7cba75(0x1ca)][_0x7cba75(0x222)](_0x3b4f87));if(_0x1cf27d)_0x1cf27d[_0x7cba75(0x1d2)]=_0x152db2,_0x1cf27d['openId']=_0x3b4f87,await this[_0x7cba75(0x1ca)][_0x7cba75(0x203)](_0x1cf27d['id'],_0x3b4f87,_0x152db2),_0x338af6[_0x7cba75(0x231)]=await this[_0x7cba75(0x1d6)][_0x7cba75(0x1ff)](_0x1cf27d,_0x3b861f);else{if(_0x9017f4){const {data:_0x51dd65}=await axios_1[_0x7cba75(0x1f7)][_0x7cba75(0x20e)](_0x7cba75(0x200)+_0x9017f4+_0x7cba75(0x20b)+_0x3b4f87+_0x7cba75(0x20a));!_0x51dd65['errmsg']&&console[_0x7cba75(0x1da)](_0x51dd65[_0x7cba75(0x226)]),_0x338af6[_0x7cba75(0x211)]=_0x51dd65;}}return _0x338af6;}async['scan'](_0x4c2787,_0x23c6c1){const _0x6c9dc2=_0x2a614b;if(!this[_0x6c9dc2(0x1e0)][_0x23c6c1])throw new common_1['HttpException']('非法参数',common_1[_0x6c9dc2(0x1d5)][_0x6c9dc2(0x23e)]);this[_0x6c9dc2(0x208)][_0x23c6c1]=_0x4c2787;}async[_0x2a614b(0x241)](_0x43b21b,_0xcad75f){const _0x53c8e6=_0x2a614b;if(!this[_0x53c8e6(0x1e0)][_0xcad75f])return;const _0x471b81=this[_0x53c8e6(0x208)][_0xcad75f];if(!_0x471b81)return new Login_vo_1[(_0x53c8e6(0x1ef))]();let _0x234b91=new Login_vo_1[(_0x53c8e6(0x1ef))]();_0x234b91['openId']=_0x471b81;const _0x379cf5=await this[_0x53c8e6(0x1ca)][_0x53c8e6(0x222)](_0x471b81);return _0x379cf5&&(_0x234b91[_0x53c8e6(0x231)]=await this[_0x53c8e6(0x1d6)]['getJwtToken'](_0x379cf5,_0x43b21b)),delete this['scanedSceneStrMap'][_0xcad75f],_0x234b91;}async[_0x2a614b(0x20c)](_0x5c5544,_0x2fd55b){const _0x1f3d54=_0x2a614b;if(!this[_0x1f3d54(0x1e0)][_0x2fd55b])throw new common_1[(_0x1f3d54(0x1e7))](_0x1f3d54(0x216),common_1[_0x1f3d54(0x1d5)]['BAD_REQUEST']);const _0x56ffb7=_0x2fd55b['split']('/')[0x1],_0x20942a=await this[_0x1f3d54(0x1ca)]['bindWx'](_0x5c5544,_0x56ffb7);this[_0x1f3d54(0x208)][_0x2fd55b]=_0x20942a;}async[_0x2a614b(0x1f3)](_0x11f806,_0x1a0599){const _0x3a74d7=_0x2a614b;if(!this[_0x3a74d7(0x1e0)][_0x1a0599])throw new common_1[(_0x3a74d7(0x1e7))](_0x3a74d7(0x216),common_1[_0x3a74d7(0x1d5)][_0x3a74d7(0x23e)]);const {id:_0x2987e7}=_0x11f806[_0x3a74d7(0x23b)],_0x45c486=this[_0x3a74d7(0x208)][_0x1a0599];if(!_0x45c486)return'';return delete this['scanedSceneStrMap'][_0x1a0599],_0x45c486;}async[_0x2a614b(0x1fb)](_0x625bbf,_0x4205d9,_0x4d9b7c){const _0x5697e4=_0x2a614b,_0x520284=await this['globalConfigService'][_0x5697e4(0x1d4)]([_0x5697e4(0x1e1)]),_0x27f06c=_0x520284||_0x5697e4(0x215);return await this['sha1']([_0x27f06c,_0x4205d9,_0x4d9b7c]['sort']()[_0x5697e4(0x1ce)](''))==_0x625bbf;}[_0x2a614b(0x1e8)](_0x1ca44c){const _0x147b13=_0x2a614b;return crypto[_0x147b13(0x214)](_0x147b13(0x1e8))[_0x147b13(0x1d1)](_0x1ca44c)[_0x147b13(0x1e5)](_0x147b13(0x1ee));}async[_0x2a614b(0x219)](_0x518e69,_0x53d127){const _0x37f298=_0x2a614b,_0x4f3b97=await this[_0x37f298(0x235)][_0x37f298(0x1d4)]([_0x53d127]);return this['genXmlMsg'](_0x518e69,_0x4f3b97);}async[_0x2a614b(0x1ed)](_0x236b90,_0x4967f1){const _0x4726dd=_0x2a614b;return _0x4726dd(0x1f8)+_0x236b90[_0x4726dd(0x20f)][0x0]+_0x4726dd(0x1ec)+_0x236b90[_0x4726dd(0x1fd)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+(0x0,date_1[_0x4726dd(0x1f7)])()[_0x4726dd(0x201)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x4967f1+_0x4726dd(0x1f1);}async[_0x2a614b(0x238)](_0x29d5d6){const _0x422088=_0x2a614b;let _0x5a7a4d=await this[_0x422088(0x1e6)]['checkAutoReply'](_0x29d5d6);if(!_0x5a7a4d){const _0x490984=await this[_0x422088(0x235)][_0x422088(0x1d4)]([_0x422088(0x1cd)]);_0x5a7a4d=_0x490984;}return _0x5a7a4d;}async[_0x2a614b(0x22a)](_0xcdf636,_0x1a9293){const _0x1a1092=_0x2a614b;console[_0x1a1092(0x21b)](_0xcdf636['ip']);if(_0x1a9293===_0x1a1092(0x220)){const _0x4f16db=await this['globalConfigService'][_0x1a1092(0x1d4)]([_0x1a1092(0x1f0)]);return _0x4f16db;}else{if(_0x1a9293==='mini'){const _0x2891a1=await this['redisCacheService'][_0x1a1092(0x20e)]({'key':redisKey_constant_1[_0x1a1092(0x1f4)]});return _0x2891a1;}else throw new common_1['HttpException'](null,common_1[_0x1a1092(0x1d5)][_0x1a1092(0x23e)]);}}};OfficialService=__decorate([(0x0,common_1[_0x2a614b(0x228)])(),__metadata(_0x2a614b(0x1fa),[autoreply_service_1[_0x2a614b(0x1f9)],user_service_1[_0x2a614b(0x224)],auth_service_1[_0x2a614b(0x1dc)],globalConfig_service_1[_0x2a614b(0x233)],redisCache_service_1['RedisCacheService']])],OfficialService),exports[_0x2a614b(0x22b)]=OfficialService;function _0x4ab0(){const _0x10276f=['length','getUserOpenId','./vo/Login.vo','UserService','2946146WrDPLX','errmsg','回跳跳转地址:\x20','Injectable','../../common/utils','getAccessToken','OfficialService','&secret=','&url=','jsapi_ticket=','../../common/constants/redisKey.constant','now','authToken','__metadata','GlobalConfigService','6WdQHnG','globalConfigService','1480bhsXKg','__esModule','aotoPlay','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','163728iJjcbU','user','toFixed','object','BAD_REQUEST','getOwnPropertyDescriptor','wechatOfficialAppId','loginBySceneStr','&timestamp=','userService','wechatOfficialAppSecret','axios','officialAutoReplyText','join','wechatJsapiTicket','657iwEHcg','update','unionid','getQRSceneStrByBind','getConfigByKeys','HttpStatus','authService','getRedirectUrl','109wUAaCV','QR_STR_SCENE','error','1637044PMhsIN','AuthService','&code=','./../user/user.service','./../autoreply/autoreply.service','sceneStrMap','wechatOfficialToken','24vlGuPp','&noncestr=','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','digest','autoreplyService','HttpException','sha1','openId','&redirect_uri=','str:\x20',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','genXmlMsg','hex','OfficialLoginVO','wechatAccessToken',']]></Content>\x0a\x20\x20\x20\x20</xml>','214476DMappo','bindWxBySceneStr','WE_MINI_ACCESS_KEY','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','../../common/utils/date','default','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','AutoreplyService','design:paramtypes','verify','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','tousername','fetchQRCodeTicket','getJwtToken','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','valueOf','decorate','updateUserOpenId','metadata','getUserUnionId','function','getQRCodeTicket','scanedSceneStrMap','redisCacheService','&lang=zh_CN','&openid=','scanBindWx','80190yBkfIF','get','fromusername','createRandomNonceStr','wechatUser','__decorate','getQRSceneStr','createHash','jiangly','非法参数','1157RjMhsO','11668opeVwl','genXmlMsgByConfig','./../globalConfig/globalConfig.service','log','1816145EorvMC','defineProperty','./../auth/auth.service','appId:\x20','official'];_0x4ab0=function(){return _0x10276f;};return _0x4ab0();}