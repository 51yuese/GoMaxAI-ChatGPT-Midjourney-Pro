'use strict';const _0x377e73=_0x511c;(function(_0x109288,_0x28cbda){const _0x3fc5d6=_0x511c,_0x387e61=_0x109288();while(!![]){try{const _0xf2b5fb=-parseInt(_0x3fc5d6(0x17f))/0x1*(parseInt(_0x3fc5d6(0x174))/0x2)+parseInt(_0x3fc5d6(0x141))/0x3+parseInt(_0x3fc5d6(0x133))/0x4+parseInt(_0x3fc5d6(0x16e))/0x5+-parseInt(_0x3fc5d6(0x12c))/0x6+parseInt(_0x3fc5d6(0x153))/0x7*(parseInt(_0x3fc5d6(0x12f))/0x8)+parseInt(_0x3fc5d6(0x139))/0x9*(-parseInt(_0x3fc5d6(0x15e))/0xa);if(_0xf2b5fb===_0x28cbda)break;else _0x387e61['push'](_0x387e61['shift']());}catch(_0x2cbe53){_0x387e61['push'](_0x387e61['shift']());}}}(_0x3977,0x6cba1));function _0x511c(_0x54ca2c,_0x419f55){const _0x3977e3=_0x3977();return _0x511c=function(_0x511cc3,_0x59f9c6){_0x511cc3=_0x511cc3-0x116;let _0x17a390=_0x3977e3[_0x511cc3];return _0x17a390;},_0x511c(_0x54ca2c,_0x419f55);}var __decorate=this&&this['__decorate']||function(_0x3239da,_0x2e3a67,_0xf47d7d,_0x1a7b31){const _0x14fefb=_0x511c;var _0x58aa19=arguments[_0x14fefb(0x120)],_0x318062=_0x58aa19<0x3?_0x2e3a67:_0x1a7b31===null?_0x1a7b31=Object['getOwnPropertyDescriptor'](_0x2e3a67,_0xf47d7d):_0x1a7b31,_0x4e506c;if(typeof Reflect===_0x14fefb(0x14e)&&typeof Reflect['decorate']==='function')_0x318062=Reflect['decorate'](_0x3239da,_0x2e3a67,_0xf47d7d,_0x1a7b31);else{for(var _0x10073b=_0x3239da[_0x14fefb(0x120)]-0x1;_0x10073b>=0x0;_0x10073b--)if(_0x4e506c=_0x3239da[_0x10073b])_0x318062=(_0x58aa19<0x3?_0x4e506c(_0x318062):_0x58aa19>0x3?_0x4e506c(_0x2e3a67,_0xf47d7d,_0x318062):_0x4e506c(_0x2e3a67,_0xf47d7d))||_0x318062;}return _0x58aa19>0x3&&_0x318062&&Object[_0x14fefb(0x175)](_0x2e3a67,_0xf47d7d,_0x318062),_0x318062;},__metadata=this&&this[_0x377e73(0x166)]||function(_0xde1f13,_0x23261d){const _0x102ab3=_0x377e73;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x102ab3(0x170))return Reflect[_0x102ab3(0x160)](_0xde1f13,_0x23261d);};Object[_0x377e73(0x175)](exports,'__esModule',{'value':!![]}),exports['OfficialService']=void 0x0;const globalConfig_service_1=require(_0x377e73(0x12d)),auth_service_1=require(_0x377e73(0x173)),user_service_1=require(_0x377e73(0x150)),autoreply_service_1=require(_0x377e73(0x140)),common_1=require(_0x377e73(0x176)),crypto=require('crypto'),axios_1=require(_0x377e73(0x12e)),utils_1=require(_0x377e73(0x134)),Login_vo_1=require(_0x377e73(0x179)),redisKey_constant_1=require(_0x377e73(0x165)),redisCache_service_1=require('../redisCache/redisCache.service'),date_1=require(_0x377e73(0x11e));let OfficialService=class OfficialService{constructor(_0x3ed43c,_0x2a8a59,_0x5b5f28,_0x4d3aea,_0x522b6c){const _0x258fdf=_0x377e73;this[_0x258fdf(0x151)]=_0x3ed43c,this[_0x258fdf(0x16a)]=_0x2a8a59,this['authService']=_0x5b5f28,this['globalConfigService']=_0x4d3aea,this[_0x258fdf(0x15a)]=_0x522b6c,this[_0x258fdf(0x168)]={},this[_0x258fdf(0x14a)]={};}async[_0x377e73(0x17b)](_0x46f5fc){const _0x5511b5=_0x377e73,{invitedBy:_0x15985f}=_0x46f5fc;let _0x27ca29=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x15985f&&(_0x27ca29+=':'+_0x15985f),this[_0x5511b5(0x168)][_0x27ca29]=!![],_0x27ca29;}async['getQRSceneStrByBind'](_0x5de682){const _0x45b1b6=_0x377e73,{id:_0x1bbe7a}=_0x5de682[_0x45b1b6(0x15f)],_0x30ae9a=(0x0,utils_1[_0x45b1b6(0x117)])(0x20)+'/'+_0x1bbe7a;return this[_0x45b1b6(0x168)][_0x30ae9a]=!![],_0x30ae9a;}async[_0x377e73(0x157)](_0x260770){return this['fetchQRCodeTicket'](_0x260770);}async[_0x377e73(0x13b)](_0x340280){const _0x19c6e9=_0x377e73,_0xd5a87=await this[_0x19c6e9(0x178)]['getConfigByKeys']([_0x19c6e9(0x14c)]),_0x15de2f=_0x19c6e9(0x17d)+_0xd5a87+_0x19c6e9(0x122)+encodeURIComponent(_0x340280)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console['log'](_0x19c6e9(0x119),_0x15de2f),_0x15de2f;}async[_0x377e73(0x146)](_0x411c25){const _0x469d59=_0x377e73,_0x35b375=(0x0,utils_1[_0x469d59(0x117)])(0x20),_0x235be1=(Date['now']()/0x3e8)['toFixed'](0x0),_0x5c7f78=await this['globalConfigService'][_0x469d59(0x147)](['wechatJsapiTicket',_0x469d59(0x14c)]),{wechatJsapiTicket:_0x54ccfb,wechatOfficialAppId:_0x475d86}=_0x5c7f78;console[_0x469d59(0x159)](_0x469d59(0x11b),_0x54ccfb),console[_0x469d59(0x159)](_0x469d59(0x15c),_0x475d86);const _0x29e90b=_0x469d59(0x135)+_0x54ccfb+_0x469d59(0x162)+_0x35b375+_0x469d59(0x11f)+_0x235be1+_0x469d59(0x126)+_0x411c25;console[_0x469d59(0x159)]('str:\x20',_0x29e90b);const _0x5ae8b9=this[_0x469d59(0x172)](_0x29e90b);return{'appId':_0x475d86,'nonceStr':_0x35b375,'timestamp':_0x235be1,'signature':_0x5ae8b9};}async['fetchQRCodeTicket'](_0x3373d7){const _0x264305=_0x377e73,_0x4b93a6=await this[_0x264305(0x178)][_0x264305(0x147)]([_0x264305(0x16f)]),_0x109b1c={'action_name':_0x264305(0x143),'action_info':{'scene':{'scene_str':_0x3373d7}}},_0x4f4bd0=await axios_1[_0x264305(0x137)][_0x264305(0x16d)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x4b93a6,_0x109b1c),{data:{errmsg:_0x4ad524,ticket:_0x10b7e1}}=_0x4f4bd0;if(_0x4ad524)throw new common_1['HttpException'](_0x4ad524,common_1[_0x264305(0x138)][_0x264305(0x132)]);return _0x10b7e1;}async['loginByCode'](_0x16589b,_0x248d0a){const _0x517b9b=_0x377e73,_0x4ee8d2=await this[_0x517b9b(0x178)][_0x517b9b(0x147)]([_0x517b9b(0x14c),_0x517b9b(0x142)]),{wechatOfficialAppId:_0x267abd,wechatOfficialAppSecret:_0x51f089}=_0x4ee8d2,_0x46edba=await axios_1['default'][_0x517b9b(0x13d)]('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+_0x267abd+_0x517b9b(0x11d)+_0x51f089+_0x517b9b(0x169)+_0x248d0a+_0x517b9b(0x118)),{data:{errmsg:_0x501bf0,openid:_0x351503,access_token:_0x2c1ae2,unionid:_0x16c34f}}=_0x46edba;if(_0x501bf0)throw new common_1[(_0x517b9b(0x17e))](_0x501bf0,common_1[_0x517b9b(0x138)][_0x517b9b(0x132)]);let _0x522efe=new Login_vo_1[(_0x517b9b(0x152))]();_0x522efe[_0x517b9b(0x131)]=_0x351503,_0x522efe[_0x517b9b(0x128)]=_0x16c34f;let _0x3f4f05;_0x16c34f&&(_0x3f4f05=await this[_0x517b9b(0x16a)][_0x517b9b(0x116)](_0x16c34f));!_0x3f4f05&&(_0x3f4f05=await this['userService'][_0x517b9b(0x171)](_0x351503));if(_0x3f4f05)_0x3f4f05['unionid']=_0x16c34f,_0x3f4f05[_0x517b9b(0x131)]=_0x351503,await this[_0x517b9b(0x16a)][_0x517b9b(0x12a)](_0x3f4f05['id'],_0x351503,_0x16c34f),_0x522efe['authToken']=await this[_0x517b9b(0x125)]['getJwtToken'](_0x3f4f05,_0x16589b);else{if(_0x2c1ae2){const {data:_0x5bc5c7}=await axios_1[_0x517b9b(0x137)][_0x517b9b(0x13d)](_0x517b9b(0x14b)+_0x2c1ae2+'&openid='+_0x351503+_0x517b9b(0x121));!_0x5bc5c7[_0x517b9b(0x144)]&&console['error'](_0x5bc5c7[_0x517b9b(0x144)]),_0x522efe[_0x517b9b(0x12b)]=_0x5bc5c7;}}return _0x522efe;}async[_0x377e73(0x13a)](_0x523e0e,_0x546b3e){const _0x1a00da=_0x377e73;if(!this[_0x1a00da(0x168)][_0x546b3e])throw new common_1[(_0x1a00da(0x17e))](_0x1a00da(0x124),common_1[_0x1a00da(0x138)]['BAD_REQUEST']);this[_0x1a00da(0x14a)][_0x546b3e]=_0x523e0e;}async[_0x377e73(0x17a)](_0x1704a1,_0x29104e){const _0x2b0a2e=_0x377e73;if(!this[_0x2b0a2e(0x168)][_0x29104e])return;const _0x2ccb29=this[_0x2b0a2e(0x14a)][_0x29104e];if(!_0x2ccb29)return new Login_vo_1[(_0x2b0a2e(0x152))]();let _0x4a6815=new Login_vo_1[(_0x2b0a2e(0x152))]();_0x4a6815[_0x2b0a2e(0x131)]=_0x2ccb29;const _0x34125a=await this[_0x2b0a2e(0x16a)][_0x2b0a2e(0x171)](_0x2ccb29);return _0x34125a&&(_0x4a6815[_0x2b0a2e(0x16b)]=await this[_0x2b0a2e(0x125)][_0x2b0a2e(0x155)](_0x34125a,_0x1704a1)),delete this[_0x2b0a2e(0x14a)][_0x29104e],_0x4a6815;}async['scanBindWx'](_0x483db5,_0x2a9b27){const _0x1217cd=_0x377e73;if(!this[_0x1217cd(0x168)][_0x2a9b27])throw new common_1[(_0x1217cd(0x17e))](_0x1217cd(0x124),common_1[_0x1217cd(0x138)][_0x1217cd(0x132)]);const _0x274435=_0x2a9b27['split']('/')[0x1],_0x280877=await this[_0x1217cd(0x16a)][_0x1217cd(0x145)](_0x483db5,_0x274435);this[_0x1217cd(0x14a)][_0x2a9b27]=_0x280877;}async[_0x377e73(0x123)](_0x442408,_0x1c8046){const _0x122443=_0x377e73;if(!this['sceneStrMap'][_0x1c8046])throw new common_1[(_0x122443(0x17e))]('非法参数',common_1[_0x122443(0x138)][_0x122443(0x132)]);const {id:_0x18d3d7}=_0x442408['user'],_0x5d7a55=this['scanedSceneStrMap'][_0x1c8046];if(!_0x5d7a55)return'';return delete this[_0x122443(0x14a)][_0x1c8046],_0x5d7a55;}async[_0x377e73(0x16c)](_0xaaaf68,_0x4eaa9f,_0x19ff11){const _0x3cd389=_0x377e73,_0x592072=await this[_0x3cd389(0x178)][_0x3cd389(0x147)](['wechatOfficialToken']),_0x3fa30a=_0x592072||_0x3cd389(0x164);return await this[_0x3cd389(0x172)]([_0x3fa30a,_0x4eaa9f,_0x19ff11]['sort']()['join'](''))==_0xaaaf68;}[_0x377e73(0x172)](_0x2cd8db){const _0x3730a1=_0x377e73;return crypto[_0x3730a1(0x15d)]('sha1')[_0x3730a1(0x127)](_0x2cd8db)[_0x3730a1(0x148)](_0x3730a1(0x136));}async[_0x377e73(0x177)](_0x263c3e,_0x3a1514){const _0x1483cb=_0x377e73,_0x4b30ae=await this[_0x1483cb(0x178)]['getConfigByKeys']([_0x3a1514]);return this['genXmlMsg'](_0x263c3e,_0x4b30ae);}async[_0x377e73(0x13f)](_0x378b24,_0x32c649){const _0x27bdae=_0x377e73;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x378b24[_0x27bdae(0x167)][0x0]+_0x27bdae(0x14f)+_0x378b24[_0x27bdae(0x11c)][0x0]+_0x27bdae(0x17c)+(0x0,date_1[_0x27bdae(0x137)])()[_0x27bdae(0x13e)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x32c649+_0x27bdae(0x156);}async[_0x377e73(0x154)](_0x47307b){const _0x557f17=_0x377e73;let _0x29df53=await this[_0x557f17(0x151)]['checkAutoReply'](_0x47307b);if(!_0x29df53){const _0x41da38=await this[_0x557f17(0x178)][_0x557f17(0x147)]([_0x557f17(0x130)]);_0x29df53=_0x41da38;}return _0x29df53;}async[_0x377e73(0x14d)](_0x44f404,_0x5ef4db){const _0x434196=_0x377e73;console[_0x434196(0x159)](_0x44f404['ip']);if(_0x5ef4db===_0x434196(0x11a)){const _0x539871=await this[_0x434196(0x178)][_0x434196(0x147)]([_0x434196(0x16f)]);return _0x539871;}else{if(_0x5ef4db===_0x434196(0x161)){const _0x3c892a=await this[_0x434196(0x15a)][_0x434196(0x13d)]({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY']});return _0x3c892a;}else throw new common_1[(_0x434196(0x17e))](null,common_1[_0x434196(0x138)][_0x434196(0x132)]);}}};function _0x3977(){const _0x8e0454=['createHash','3310rIJLNM','user','metadata','mini','&noncestr=','design:paramtypes','jiangly','../../common/constants/redisKey.constant','__metadata','fromusername','sceneStrMap','&code=','userService','authToken','verify','post','2858465kEsrEj','wechatAccessToken','function','getUserOpenId','sha1','./../auth/auth.service','5358rXwiyS','defineProperty','@nestjs/common','genXmlMsgByConfig','globalConfigService','./vo/Login.vo','loginBySceneStr','getQRSceneStr',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','HttpException','3XlUgiY','getUserUnionId','createRandomNonceStr','&grant_type=authorization_code','回跳跳转地址:\x20','official','jsapiTicket:\x20','tousername','&secret=','../../common/utils/date','&timestamp=','length','&lang=zh_CN','&redirect_uri=','bindWxBySceneStr','非法参数','authService','&url=','update','unionid','OfficialService','updateUserOpenId','wechatUser','2367726jMqVzg','./../globalConfig/globalConfig.service','axios','56ZGPCRK','officialAutoReplyText','openId','BAD_REQUEST','2185240EscNzF','../../common/utils','jsapi_ticket=','hex','default','HttpStatus','32688AGGOqY','scan','getRedirectUrl','AuthService','get','valueOf','genXmlMsg','./../autoreply/autoreply.service','2612091wQasQq','wechatOfficialAppSecret','QR_STR_SCENE','errmsg','bindWx','getJsapiTicket','getConfigByKeys','digest','AutoreplyService','scanedSceneStrMap','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','wechatOfficialAppId','getAccessToken','object',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','./../user/user.service','autoreplyService','OfficialLoginVO','61495RYdzJb','aotoPlay','getJwtToken',']]></Content>\x0a\x20\x20\x20\x20</xml>','getQRCodeTicket','UserService','log','redisCacheService','Injectable','appId:\x20'];_0x3977=function(){return _0x8e0454;};return _0x3977();}OfficialService=__decorate([(0x0,common_1[_0x377e73(0x15b)])(),__metadata(_0x377e73(0x163),[autoreply_service_1[_0x377e73(0x149)],user_service_1[_0x377e73(0x158)],auth_service_1[_0x377e73(0x13c)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1['RedisCacheService']])],OfficialService),exports[_0x377e73(0x129)]=OfficialService;