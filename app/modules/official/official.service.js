'use strict';function _0x36d3(_0x2008ac,_0x268c48){const _0x291ddc=_0x291d();return _0x36d3=function(_0x36d394,_0x485eb8){_0x36d394=_0x36d394-0xb2;let _0x39629b=_0x291ddc[_0x36d394];return _0x39629b;},_0x36d3(_0x2008ac,_0x268c48);}const _0x4fc5a0=_0x36d3;function _0x291d(){const _0x3c4578=['./vo/Login.vo','getRedirectUrl','split','BAD_REQUEST','hex','1450544hZBNCz','&code=','jiangly','crypto','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','getUserOpenId','wechatOfficialToken','&lang=zh_CN','bindWx',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','get','getUserUnionId','sort','digest','13538qhNjZB','OfficialService','sceneStrMap','decorate','./../globalConfig/globalConfig.service','&secret=','../redisCache/redisCache.service','1233852XyOcgt','length','log','genXmlMsgByConfig','HttpStatus',']]></Content>\x0a\x20\x20\x20\x20</xml>','default','getAccessToken','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','sha1','jsapiTicket:\x20','246771GgyhfG','getOwnPropertyDescriptor','fromusername','wechatAccessToken','UserService','&openid=','Injectable','getConfigByKeys','design:paramtypes','非法参数','getQRSceneStrByBind','getJwtToken','join','authToken','tousername','WE_MINI_ACCESS_KEY','post','unionid','../../common/constants/redisKey.constant','RedisCacheService','AuthService','error','toFixed','1252320QKHybw','official','scanedSceneStrMap','&url=','3401442SBkWOE','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','genXmlMsg','fetchQRCodeTicket','getJsapiTicket','redisCacheService','&grant_type=authorization_code','globalConfigService','authService','user','1438415GKvxrp','openId','update','wechatOfficialAppId','createRandomNonceStr','errmsg','defineProperty','object','createHash','loginBySceneStr','&timestamp=','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','wechatUser','wechatOfficialAppSecret','getQRSceneStr','__decorate','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','metadata','960IEAVYF','bindWxBySceneStr','../../common/utils','jsapi_ticket=','valueOf','function','verify',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','AutoreplyService','autoreplyService','HttpException','officialAutoReplyText','str:\x20','../../common/utils/date','axios','userService','4eRpFZj','__esModule','@nestjs/common','OfficialLoginVO','getQRCodeTicket','&redirect_uri=','__metadata','aotoPlay','mini'];_0x291d=function(){return _0x3c4578;};return _0x291d();}(function(_0x5f36f8,_0x2832f7){const _0x27f427=_0x36d3,_0x76f250=_0x5f36f8();while(!![]){try{const _0x427566=parseInt(_0x27f427(0x125))/0x1+-parseInt(_0x27f427(0xc5))/0x2+parseInt(_0x27f427(0xd0))/0x3+-parseInt(_0x27f427(0x117))/0x4*(parseInt(_0x27f427(0xf5))/0x5)+parseInt(_0x27f427(0xe7))/0x6+-parseInt(_0x27f427(0xbe))/0x7*(parseInt(_0x27f427(0x107))/0x8)+parseInt(_0x27f427(0xeb))/0x9;if(_0x427566===_0x2832f7)break;else _0x76f250['push'](_0x76f250['shift']());}catch(_0x3568b3){_0x76f250['push'](_0x76f250['shift']());}}}(_0x291d,0xefef2));var __decorate=this&&this[_0x4fc5a0(0x104)]||function(_0x3d3466,_0x5eaf89,_0x1f3915,_0x327e82){const _0x38e59a=_0x4fc5a0;var _0x2b6aab=arguments[_0x38e59a(0xc6)],_0x4a9b7a=_0x2b6aab<0x3?_0x5eaf89:_0x327e82===null?_0x327e82=Object[_0x38e59a(0xd1)](_0x5eaf89,_0x1f3915):_0x327e82,_0xc11b1a;if(typeof Reflect===_0x38e59a(0xfc)&&typeof Reflect[_0x38e59a(0xc1)]===_0x38e59a(0x10c))_0x4a9b7a=Reflect[_0x38e59a(0xc1)](_0x3d3466,_0x5eaf89,_0x1f3915,_0x327e82);else{for(var _0x3c2367=_0x3d3466[_0x38e59a(0xc6)]-0x1;_0x3c2367>=0x0;_0x3c2367--)if(_0xc11b1a=_0x3d3466[_0x3c2367])_0x4a9b7a=(_0x2b6aab<0x3?_0xc11b1a(_0x4a9b7a):_0x2b6aab>0x3?_0xc11b1a(_0x5eaf89,_0x1f3915,_0x4a9b7a):_0xc11b1a(_0x5eaf89,_0x1f3915))||_0x4a9b7a;}return _0x2b6aab>0x3&&_0x4a9b7a&&Object[_0x38e59a(0xfb)](_0x5eaf89,_0x1f3915,_0x4a9b7a),_0x4a9b7a;},__metadata=this&&this[_0x4fc5a0(0x11d)]||function(_0x56ea70,_0x4352a6){const _0x7f6c38=_0x4fc5a0;if(typeof Reflect===_0x7f6c38(0xfc)&&typeof Reflect[_0x7f6c38(0x106)]===_0x7f6c38(0x10c))return Reflect[_0x7f6c38(0x106)](_0x56ea70,_0x4352a6);};Object[_0x4fc5a0(0xfb)](exports,_0x4fc5a0(0x118),{'value':!![]}),exports[_0x4fc5a0(0xbf)]=void 0x0;const globalConfig_service_1=require(_0x4fc5a0(0xc2)),auth_service_1=require('./../auth/auth.service'),user_service_1=require('./../user/user.service'),autoreply_service_1=require('./../autoreply/autoreply.service'),common_1=require(_0x4fc5a0(0x119)),crypto=require(_0x4fc5a0(0xb2)),axios_1=require(_0x4fc5a0(0x115)),utils_1=require(_0x4fc5a0(0x109)),Login_vo_1=require(_0x4fc5a0(0x120)),redisKey_constant_1=require(_0x4fc5a0(0xe2)),redisCache_service_1=require(_0x4fc5a0(0xc4)),date_1=require(_0x4fc5a0(0x114));let OfficialService=class OfficialService{constructor(_0x44d2da,_0x55d754,_0x416e6c,_0x1ee407,_0x58844b){const _0x43e79b=_0x4fc5a0;this[_0x43e79b(0x110)]=_0x44d2da,this['userService']=_0x55d754,this[_0x43e79b(0xf3)]=_0x416e6c,this[_0x43e79b(0xf2)]=_0x1ee407,this[_0x43e79b(0xf0)]=_0x58844b,this[_0x43e79b(0xc0)]={},this[_0x43e79b(0xe9)]={};}async[_0x4fc5a0(0x103)](_0x1fe66a){const _0x53856e=_0x4fc5a0,{invitedBy:_0x11cf51}=_0x1fe66a;let _0x4cd63e=(0x0,utils_1[_0x53856e(0xf9)])(0x20);return _0x11cf51&&(_0x4cd63e+=':'+_0x11cf51),this['sceneStrMap'][_0x4cd63e]=!![],_0x4cd63e;}async[_0x4fc5a0(0xda)](_0x469936){const _0xd7a191=_0x4fc5a0,{id:_0x46f5cc}=_0x469936['user'],_0x487471=(0x0,utils_1[_0xd7a191(0xf9)])(0x20)+'/'+_0x46f5cc;return this[_0xd7a191(0xc0)][_0x487471]=!![],_0x487471;}async[_0x4fc5a0(0x11b)](_0x58ffd6){const _0x2ef903=_0x4fc5a0;return this[_0x2ef903(0xee)](_0x58ffd6);}async[_0x4fc5a0(0x121)](_0x4ffdc6){const _0x58e648=_0x4fc5a0,_0x46a1d1=await this['globalConfigService'][_0x58e648(0xd7)]([_0x58e648(0xf8)]),_0x529773=_0x58e648(0x105)+_0x46a1d1+_0x58e648(0x11c)+encodeURIComponent(_0x4ffdc6)+_0x58e648(0xb3);return console['log']('回跳跳转地址:\x20',_0x529773),_0x529773;}async[_0x4fc5a0(0xef)](_0x13e1dc){const _0x233b4d=_0x4fc5a0,_0xc78d14=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x13afbb=(Date['now']()/0x3e8)[_0x233b4d(0xe6)](0x0),_0x158ffc=await this['globalConfigService']['getConfigByKeys'](['wechatJsapiTicket',_0x233b4d(0xf8)]),{wechatJsapiTicket:_0x29a8c6,wechatOfficialAppId:_0x1d9fdb}=_0x158ffc;console['log'](_0x233b4d(0xcf),_0x29a8c6),console[_0x233b4d(0xc7)]('appId:\x20',_0x1d9fdb);const _0x33f288=_0x233b4d(0x10a)+_0x29a8c6+'&noncestr='+_0xc78d14+_0x233b4d(0xff)+_0x13afbb+_0x233b4d(0xea)+_0x13e1dc;console['log'](_0x233b4d(0x113),_0x33f288);const _0x53fbf6=this[_0x233b4d(0xce)](_0x33f288);return{'appId':_0x1d9fdb,'nonceStr':_0xc78d14,'timestamp':_0x13afbb,'signature':_0x53fbf6};}async[_0x4fc5a0(0xee)](_0x2b283b){const _0x33c73c=_0x4fc5a0,_0x25c93c=await this['globalConfigService'][_0x33c73c(0xd7)]([_0x33c73c(0xd3)]),_0x3a9f2c={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x2b283b}}},_0x27bf82=await axios_1[_0x33c73c(0xcb)][_0x33c73c(0xe0)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x25c93c,_0x3a9f2c),{data:{errmsg:_0x594870,ticket:_0x1ca334}}=_0x27bf82;if(_0x594870)throw new common_1['HttpException'](_0x594870,common_1[_0x33c73c(0xc9)][_0x33c73c(0x123)]);return _0x1ca334;}async['loginByCode'](_0xde7262,_0x20c326){const _0x18bc8a=_0x4fc5a0,_0x13f92a=await this['globalConfigService']['getConfigByKeys']([_0x18bc8a(0xf8),_0x18bc8a(0x102)]),{wechatOfficialAppId:_0xd11e62,wechatOfficialAppSecret:_0x4451d2}=_0x13f92a,_0x2fce83=await axios_1['default'][_0x18bc8a(0xba)](_0x18bc8a(0xb9)+_0xd11e62+_0x18bc8a(0xc3)+_0x4451d2+_0x18bc8a(0x126)+_0x20c326+_0x18bc8a(0xf1)),{data:{errmsg:_0x5d1c71,openid:_0x17034e,access_token:_0x11a20a,unionid:_0x257fdd}}=_0x2fce83;if(_0x5d1c71)throw new common_1[(_0x18bc8a(0x111))](_0x5d1c71,common_1['HttpStatus'][_0x18bc8a(0x123)]);let _0x2ee2fe=new Login_vo_1['OfficialLoginVO']();_0x2ee2fe['openId']=_0x17034e,_0x2ee2fe['unionid']=_0x257fdd;let _0x330208;_0x257fdd&&(_0x330208=await this[_0x18bc8a(0x116)][_0x18bc8a(0xbb)](_0x257fdd));!_0x330208&&(_0x330208=await this[_0x18bc8a(0x116)]['getUserOpenId'](_0x17034e));if(_0x330208)_0x330208[_0x18bc8a(0xe1)]=_0x257fdd,_0x330208[_0x18bc8a(0xf6)]=_0x17034e,await this['userService']['updateUserOpenId'](_0x330208['id'],_0x17034e,_0x257fdd),_0x2ee2fe[_0x18bc8a(0xdd)]=await this['authService']['getJwtToken'](_0x330208,_0xde7262);else{if(_0x11a20a){const {data:_0x3e6513}=await axios_1[_0x18bc8a(0xcb)][_0x18bc8a(0xba)](_0x18bc8a(0xec)+_0x11a20a+_0x18bc8a(0xd5)+_0x17034e+_0x18bc8a(0xb6));!_0x3e6513[_0x18bc8a(0xfa)]&&console[_0x18bc8a(0xe5)](_0x3e6513['errmsg']),_0x2ee2fe[_0x18bc8a(0x101)]=_0x3e6513;}}return _0x2ee2fe;}async['scan'](_0x132890,_0x4c47f0){const _0x2c9205=_0x4fc5a0;if(!this[_0x2c9205(0xc0)][_0x4c47f0])throw new common_1[(_0x2c9205(0x111))](_0x2c9205(0xd9),common_1[_0x2c9205(0xc9)][_0x2c9205(0x123)]);this[_0x2c9205(0xe9)][_0x4c47f0]=_0x132890;}async[_0x4fc5a0(0xfe)](_0x1a2587,_0x2a37b4){const _0x40a5cb=_0x4fc5a0;if(!this[_0x40a5cb(0xc0)][_0x2a37b4])return;const _0x398b02=this['scanedSceneStrMap'][_0x2a37b4];if(!_0x398b02)return new Login_vo_1[(_0x40a5cb(0x11a))]();let _0x550cda=new Login_vo_1[(_0x40a5cb(0x11a))]();_0x550cda['openId']=_0x398b02;const _0x1153e8=await this[_0x40a5cb(0x116)][_0x40a5cb(0xb4)](_0x398b02);return _0x1153e8&&(_0x550cda[_0x40a5cb(0xdd)]=await this[_0x40a5cb(0xf3)][_0x40a5cb(0xdb)](_0x1153e8,_0x1a2587)),delete this[_0x40a5cb(0xe9)][_0x2a37b4],_0x550cda;}async['scanBindWx'](_0x1ed541,_0x389924){const _0x55339e=_0x4fc5a0;if(!this[_0x55339e(0xc0)][_0x389924])throw new common_1[(_0x55339e(0x111))](_0x55339e(0xd9),common_1[_0x55339e(0xc9)]['BAD_REQUEST']);const _0x1078ca=_0x389924[_0x55339e(0x122)]('/')[0x1],_0xcdf9e5=await this[_0x55339e(0x116)][_0x55339e(0xb7)](_0x1ed541,_0x1078ca);this[_0x55339e(0xe9)][_0x389924]=_0xcdf9e5;}async[_0x4fc5a0(0x108)](_0x23ba7c,_0x39cc66){const _0x11a8ef=_0x4fc5a0;if(!this[_0x11a8ef(0xc0)][_0x39cc66])throw new common_1[(_0x11a8ef(0x111))](_0x11a8ef(0xd9),common_1[_0x11a8ef(0xc9)][_0x11a8ef(0x123)]);const {id:_0xbe959a}=_0x23ba7c[_0x11a8ef(0xf4)],_0x2d8b9c=this['scanedSceneStrMap'][_0x39cc66];if(!_0x2d8b9c)return'';return delete this[_0x11a8ef(0xe9)][_0x39cc66],_0x2d8b9c;}async[_0x4fc5a0(0x10d)](_0x36e240,_0x5f5308,_0x23b81d){const _0x4c9001=_0x4fc5a0,_0x349ec4=await this[_0x4c9001(0xf2)]['getConfigByKeys']([_0x4c9001(0xb5)]),_0x274535=_0x349ec4||_0x4c9001(0x127);return await this[_0x4c9001(0xce)]([_0x274535,_0x5f5308,_0x23b81d][_0x4c9001(0xbc)]()[_0x4c9001(0xdc)](''))==_0x36e240;}[_0x4fc5a0(0xce)](_0x20a531){const _0x23ed41=_0x4fc5a0;return crypto[_0x23ed41(0xfd)](_0x23ed41(0xce))[_0x23ed41(0xf7)](_0x20a531)[_0x23ed41(0xbd)](_0x23ed41(0x124));}async[_0x4fc5a0(0xc8)](_0x31ecb9,_0x37f2af){const _0x5c74cb=_0x4fc5a0,_0x2bf73e=await this[_0x5c74cb(0xf2)]['getConfigByKeys']([_0x37f2af]);return this['genXmlMsg'](_0x31ecb9,_0x2bf73e);}async[_0x4fc5a0(0xed)](_0x3efb7e,_0x430b82){const _0x46411a=_0x4fc5a0;return _0x46411a(0xcd)+_0x3efb7e[_0x46411a(0xd2)][0x0]+_0x46411a(0x10e)+_0x3efb7e[_0x46411a(0xde)][0x0]+_0x46411a(0xb8)+(0x0,date_1['default'])()[_0x46411a(0x10b)]()+_0x46411a(0x100)+_0x430b82+_0x46411a(0xca);}async[_0x4fc5a0(0x11e)](_0x502df9){const _0x36e882=_0x4fc5a0;let _0x5e3dd6=await this[_0x36e882(0x110)]['checkAutoReply'](_0x502df9);if(!_0x5e3dd6){const _0x3280a1=await this[_0x36e882(0xf2)]['getConfigByKeys']([_0x36e882(0x112)]);_0x5e3dd6=_0x3280a1;}return _0x5e3dd6;}async[_0x4fc5a0(0xcc)](_0x2757e2,_0x106cdc){const _0x5ba005=_0x4fc5a0;console[_0x5ba005(0xc7)](_0x2757e2['ip']);if(_0x106cdc===_0x5ba005(0xe8)){const _0x41e9fd=await this[_0x5ba005(0xf2)][_0x5ba005(0xd7)]([_0x5ba005(0xd3)]);return _0x41e9fd;}else{if(_0x106cdc===_0x5ba005(0x11f)){const _0x5059d6=await this[_0x5ba005(0xf0)][_0x5ba005(0xba)]({'key':redisKey_constant_1[_0x5ba005(0xdf)]});return _0x5059d6;}else throw new common_1[(_0x5ba005(0x111))](null,common_1[_0x5ba005(0xc9)]['BAD_REQUEST']);}}};OfficialService=__decorate([(0x0,common_1[_0x4fc5a0(0xd6)])(),__metadata(_0x4fc5a0(0xd8),[autoreply_service_1[_0x4fc5a0(0x10f)],user_service_1[_0x4fc5a0(0xd4)],auth_service_1[_0x4fc5a0(0xe4)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x4fc5a0(0xe3)]])],OfficialService),exports[_0x4fc5a0(0xbf)]=OfficialService;