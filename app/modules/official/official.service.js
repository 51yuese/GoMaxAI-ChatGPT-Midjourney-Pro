'use strict';const _0x4438b4=_0x12ce;(function(_0x4834a9,_0x393574){const _0x50f194=_0x12ce,_0x5be494=_0x4834a9();while(!![]){try{const _0x35768e=parseInt(_0x50f194(0x76))/0x1*(parseInt(_0x50f194(0xd1))/0x2)+-parseInt(_0x50f194(0xd2))/0x3+parseInt(_0x50f194(0x80))/0x4*(-parseInt(_0x50f194(0x8b))/0x5)+parseInt(_0x50f194(0x84))/0x6+-parseInt(_0x50f194(0x87))/0x7*(-parseInt(_0x50f194(0xa7))/0x8)+parseInt(_0x50f194(0xc5))/0x9+parseInt(_0x50f194(0x82))/0xa*(-parseInt(_0x50f194(0x9f))/0xb);if(_0x35768e===_0x393574)break;else _0x5be494['push'](_0x5be494['shift']());}catch(_0x22c274){_0x5be494['push'](_0x5be494['shift']());}}}(_0x289f,0x21a13));function _0x289f(){const _0x2da78d=['OfficialService','./../user/user.service','hex','57195tgCUIG','./../auth/auth.service','&redirect_uri=','post','非法参数','../redisCache/redisCache.service','createRandomNonceStr','../../common/utils','https://api.weixin.qq.com/sns/oauth2/access_token?appid=',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','appId:\x20','loginByCode','106gYKRix','466209VpsjeL','&grant_type=authorization_code','update','user','authService','Injectable','metadata','getQRSceneStrByBind','get','tousername','checkAutoReply','design:paramtypes','jiangly','errmsg','OfficialLoginVO','4512CFVkud','./../autoreply/autoreply.service','getRedirectUrl','回跳跳转地址:\x20','defineProperty','getOwnPropertyDescriptor','../../common/constants/redisKey.constant','openId','log','autoreplyService','336AOXPDb','HttpStatus','30Xvhzox','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','1545828aBXqet','UserService','&secret=','7861EZgCAe','scanedSceneStrMap','scan','genXmlMsg','5585VpCRok','WE_MINI_ACCESS_KEY','fromusername','sceneStrMap','BAD_REQUEST','default','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','wechatOfficialToken','&url=','getJsapiTicket','sha1','function','userService','&noncestr=','jsapi_ticket=','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','getConfigByKeys','toFixed','GlobalConfigService','1154714KvNuhQ','verify','jsapiTicket:\x20','globalConfigService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','redisCacheService','getQRCodeTicket','valueOf','1416zTMEEN','__esModule','HttpException','wechatAccessToken','aotoPlay','object','scanBindWx','wechatUser','&lang=zh_CN','decorate','./../globalConfig/globalConfig.service','sort','bindWx','fetchQRCodeTicket','wechatOfficialAppId','getUserOpenId',']]></Content>\x0a\x20\x20\x20\x20</xml>','AutoreplyService','getAccessToken','@nestjs/common','crypto','axios','./vo/Login.vo','&openid=','join','length','RedisCacheService'];_0x289f=function(){return _0x2da78d;};return _0x289f();}var __decorate=this&&this['__decorate']||function(_0x2eb160,_0x410490,_0x2d5ac5,_0x1533b2){const _0x173799=_0x12ce;var _0x20fe43=arguments[_0x173799(0xc0)],_0x28fd16=_0x20fe43<0x3?_0x410490:_0x1533b2===null?_0x1533b2=Object[_0x173799(0x7b)](_0x410490,_0x2d5ac5):_0x1533b2,_0x3afd4d;if(typeof Reflect===_0x173799(0xac)&&typeof Reflect['decorate']===_0x173799(0x97))_0x28fd16=Reflect[_0x173799(0xb0)](_0x2eb160,_0x410490,_0x2d5ac5,_0x1533b2);else{for(var _0x3a0b87=_0x2eb160[_0x173799(0xc0)]-0x1;_0x3a0b87>=0x0;_0x3a0b87--)if(_0x3afd4d=_0x2eb160[_0x3a0b87])_0x28fd16=(_0x20fe43<0x3?_0x3afd4d(_0x28fd16):_0x20fe43>0x3?_0x3afd4d(_0x410490,_0x2d5ac5,_0x28fd16):_0x3afd4d(_0x410490,_0x2d5ac5))||_0x28fd16;}return _0x20fe43>0x3&&_0x28fd16&&Object[_0x173799(0x7a)](_0x410490,_0x2d5ac5,_0x28fd16),_0x28fd16;},__metadata=this&&this['__metadata']||function(_0x1905cd,_0x5ac8f1){const _0x49f85e=_0x12ce;if(typeof Reflect===_0x49f85e(0xac)&&typeof Reflect[_0x49f85e(0x6d)]==='function')return Reflect[_0x49f85e(0x6d)](_0x1905cd,_0x5ac8f1);};Object['defineProperty'](exports,_0x4438b4(0xa8),{'value':!![]}),exports[_0x4438b4(0xc2)]=void 0x0;function _0x12ce(_0x5ce0cd,_0x216050){const _0x289f2d=_0x289f();return _0x12ce=function(_0x12ce0a,_0x10b518){_0x12ce0a=_0x12ce0a-0x6b;let _0x448d12=_0x289f2d[_0x12ce0a];return _0x448d12;},_0x12ce(_0x5ce0cd,_0x216050);}const globalConfig_service_1=require(_0x4438b4(0xb1)),auth_service_1=require(_0x4438b4(0xc6)),user_service_1=require(_0x4438b4(0xc3)),autoreply_service_1=require(_0x4438b4(0x77)),common_1=require(_0x4438b4(0xba)),crypto=require(_0x4438b4(0xbb)),axios_1=require(_0x4438b4(0xbc)),utils_1=require(_0x4438b4(0xcc)),Login_vo_1=require(_0x4438b4(0xbd)),redisKey_constant_1=require(_0x4438b4(0x7c)),redisCache_service_1=require(_0x4438b4(0xca)),date_1=require('../../common/utils/date');let OfficialService=class OfficialService{constructor(_0x516535,_0x25e679,_0x1b9794,_0x263e56,_0x3bc933){const _0x3615a2=_0x4438b4;this['autoreplyService']=_0x516535,this['userService']=_0x25e679,this[_0x3615a2(0x6b)]=_0x1b9794,this[_0x3615a2(0xa2)]=_0x263e56,this[_0x3615a2(0xa4)]=_0x3bc933,this[_0x3615a2(0x8e)]={},this[_0x3615a2(0x88)]={};}async['getQRSceneStr'](_0x4ff405){const _0x3861ee=_0x4438b4,{invitedBy:_0x342dae}=_0x4ff405;let _0x801e1d=(0x0,utils_1[_0x3861ee(0xcb)])(0x20);return _0x342dae&&(_0x801e1d+=':'+_0x342dae),this[_0x3861ee(0x8e)][_0x801e1d]=!![],_0x801e1d;}async[_0x4438b4(0x6e)](_0x4b5362){const _0x53a018=_0x4438b4,{id:_0x89f870}=_0x4b5362[_0x53a018(0xd5)],_0x357366=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x89f870;return this['sceneStrMap'][_0x357366]=!![],_0x357366;}async[_0x4438b4(0xa5)](_0x113158){const _0x42ba9e=_0x4438b4;return this[_0x42ba9e(0xb4)](_0x113158);}async[_0x4438b4(0x78)](_0x3ba974){const _0x3d0ef4=_0x4438b4,_0x416e3a=await this[_0x3d0ef4(0xa2)][_0x3d0ef4(0x9c)]([_0x3d0ef4(0xb5)]),_0x1d2632=_0x3d0ef4(0x9b)+_0x416e3a+_0x3d0ef4(0xc7)+encodeURIComponent(_0x3ba974)+_0x3d0ef4(0x91);return console['log'](_0x3d0ef4(0x79),_0x1d2632),_0x1d2632;}async[_0x4438b4(0x95)](_0x242515){const _0x46ba52=_0x4438b4,_0x36e1a7=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x45d634=(Date['now']()/0x3e8)[_0x46ba52(0x9d)](0x0),_0x31f9da=await this[_0x46ba52(0xa2)]['getConfigByKeys'](['wechatJsapiTicket',_0x46ba52(0xb5)]),{wechatJsapiTicket:_0x4895eb,wechatOfficialAppId:_0x4b05b7}=_0x31f9da;console[_0x46ba52(0x7e)](_0x46ba52(0xa1),_0x4895eb),console[_0x46ba52(0x7e)](_0x46ba52(0xcf),_0x4b05b7);const _0x4486b8=_0x46ba52(0x9a)+_0x4895eb+_0x46ba52(0x99)+_0x36e1a7+'&timestamp='+_0x45d634+_0x46ba52(0x94)+_0x242515;console[_0x46ba52(0x7e)]('str:\x20',_0x4486b8);const _0x55239c=this['sha1'](_0x4486b8);return{'appId':_0x4b05b7,'nonceStr':_0x36e1a7,'timestamp':_0x45d634,'signature':_0x55239c};}async[_0x4438b4(0xb4)](_0x5a6215){const _0x474866=_0x4438b4,_0x338ac4=await this[_0x474866(0xa2)]['getConfigByKeys']([_0x474866(0xaa)]),_0x54620f={'action_name':'QR_STR_SCENE','action_info':{'scene':{'scene_str':_0x5a6215}}},_0x5c8f1d=await axios_1[_0x474866(0x90)][_0x474866(0xc8)]('https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token='+_0x338ac4,_0x54620f),{data:{errmsg:_0x14e30c,ticket:_0x1907a4}}=_0x5c8f1d;if(_0x14e30c)throw new common_1[(_0x474866(0xa9))](_0x14e30c,common_1[_0x474866(0x81)]['BAD_REQUEST']);return _0x1907a4;}async[_0x4438b4(0xd0)](_0x473899,_0x2c5568){const _0xebea78=_0x4438b4,_0x3ffa95=await this[_0xebea78(0xa2)][_0xebea78(0x9c)]([_0xebea78(0xb5),'wechatOfficialAppSecret']),{wechatOfficialAppId:_0x29b55c,wechatOfficialAppSecret:_0x1f76e8}=_0x3ffa95,_0x3747af=await axios_1[_0xebea78(0x90)][_0xebea78(0x6f)](_0xebea78(0xcd)+_0x29b55c+_0xebea78(0x86)+_0x1f76e8+'&code='+_0x2c5568+_0xebea78(0xd3)),{data:{errmsg:_0x20ecfa,openid:_0x2881e2,access_token:_0x377547}}=_0x3747af;if(_0x20ecfa)throw new common_1[(_0xebea78(0xa9))](_0x20ecfa,common_1['HttpStatus']['BAD_REQUEST']);let _0x50f17e=new Login_vo_1['OfficialLoginVO']();_0x50f17e[_0xebea78(0x7d)]=_0x2881e2;const _0x32b84d=await this[_0xebea78(0x98)][_0xebea78(0xb6)](_0x2881e2);if(_0x32b84d)_0x50f17e['authToken']=await this[_0xebea78(0x6b)]['getJwtToken'](_0x32b84d,_0x473899);else{if(_0x377547){const {data:_0x2d1b15}=await axios_1['default'][_0xebea78(0x6f)](_0xebea78(0xa3)+_0x377547+_0xebea78(0xbe)+_0x2881e2+_0xebea78(0xaf));!_0x2d1b15[_0xebea78(0x74)]&&console['error'](_0x2d1b15[_0xebea78(0x74)]),_0x50f17e[_0xebea78(0xae)]=_0x2d1b15;}}return _0x50f17e;}async[_0x4438b4(0x89)](_0x329216,_0x1d1574){const _0x4233e9=_0x4438b4;if(!this[_0x4233e9(0x8e)][_0x1d1574])throw new common_1['HttpException'](_0x4233e9(0xc9),common_1[_0x4233e9(0x81)][_0x4233e9(0x8f)]);this['scanedSceneStrMap'][_0x1d1574]=_0x329216;}async['loginBySceneStr'](_0xaa5505,_0x5c6d7d){const _0x14c8c4=_0x4438b4;if(!this[_0x14c8c4(0x8e)][_0x5c6d7d])return;const _0x46aa18=this['scanedSceneStrMap'][_0x5c6d7d];if(!_0x46aa18)return new Login_vo_1[(_0x14c8c4(0x75))]();let _0x5bb6e9=new Login_vo_1['OfficialLoginVO']();_0x5bb6e9[_0x14c8c4(0x7d)]=_0x46aa18;const _0x439f9b=await this[_0x14c8c4(0x98)][_0x14c8c4(0xb6)](_0x46aa18);return _0x439f9b&&(_0x5bb6e9['authToken']=await this[_0x14c8c4(0x6b)]['getJwtToken'](_0x439f9b,_0xaa5505)),delete this['scanedSceneStrMap'][_0x5c6d7d],_0x5bb6e9;}async[_0x4438b4(0xad)](_0x34108b,_0x2ee90e){const _0x7de13=_0x4438b4;if(!this['sceneStrMap'][_0x2ee90e])throw new common_1[(_0x7de13(0xa9))](_0x7de13(0xc9),common_1[_0x7de13(0x81)][_0x7de13(0x8f)]);const _0x122f19=_0x2ee90e['split']('/')[0x1],_0x3e986b=await this[_0x7de13(0x98)][_0x7de13(0xb3)](_0x34108b,_0x122f19);this['scanedSceneStrMap'][_0x2ee90e]=_0x3e986b;}async['bindWxBySceneStr'](_0x5c2151,_0x42b96a){const _0x37acfe=_0x4438b4;if(!this['sceneStrMap'][_0x42b96a])throw new common_1[(_0x37acfe(0xa9))]('非法参数',common_1[_0x37acfe(0x81)]['BAD_REQUEST']);const {id:_0x53b057}=_0x5c2151['user'],_0x4da39c=this[_0x37acfe(0x88)][_0x42b96a];if(!_0x4da39c)return'';return delete this[_0x37acfe(0x88)][_0x42b96a],_0x4da39c;}async[_0x4438b4(0xa0)](_0x228dca,_0x1a03b7,_0x43cac6){const _0x118f2c=_0x4438b4,_0x1ff5b1=await this['globalConfigService']['getConfigByKeys']([_0x118f2c(0x93)]),_0x4a0523=_0x1ff5b1||_0x118f2c(0x73);return await this[_0x118f2c(0x96)]([_0x4a0523,_0x1a03b7,_0x43cac6][_0x118f2c(0xb2)]()[_0x118f2c(0xbf)](''))==_0x228dca;}['sha1'](_0x5b544b){const _0x3a7b83=_0x4438b4;return crypto['createHash'](_0x3a7b83(0x96))[_0x3a7b83(0xd4)](_0x5b544b)['digest'](_0x3a7b83(0xc4));}async['genXmlMsgByConfig'](_0x204f9f,_0x47c4bd){const _0x3f8adf=_0x4438b4,_0x1ee7fd=await this[_0x3f8adf(0xa2)]['getConfigByKeys']([_0x47c4bd]);return this[_0x3f8adf(0x8a)](_0x204f9f,_0x1ee7fd);}async[_0x4438b4(0x8a)](_0x5e2b4c,_0x4cc906){const _0x32af9a=_0x4438b4;return _0x32af9a(0x83)+_0x5e2b4c[_0x32af9a(0x8d)][0x0]+_0x32af9a(0xce)+_0x5e2b4c[_0x32af9a(0x70)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+(0x0,date_1[_0x32af9a(0x90)])()[_0x32af9a(0xa6)]()+_0x32af9a(0x92)+_0x4cc906+_0x32af9a(0xb7);}async[_0x4438b4(0xab)](_0x3c5db6){const _0x306ad4=_0x4438b4;let _0x731ef8=await this[_0x306ad4(0x7f)][_0x306ad4(0x71)](_0x3c5db6);if(!_0x731ef8){const _0x35bc97=await this['globalConfigService'][_0x306ad4(0x9c)](['officialAutoReplyText']);_0x731ef8=_0x35bc97;}return _0x731ef8;}async[_0x4438b4(0xb9)](_0x3c9863,_0x3063e1){const _0x4d44ba=_0x4438b4;console[_0x4d44ba(0x7e)](_0x3c9863['ip']);if(_0x3063e1==='official'){const _0x57f9cb=await this[_0x4d44ba(0xa2)][_0x4d44ba(0x9c)]([_0x4d44ba(0xaa)]);return _0x57f9cb;}else{if(_0x3063e1==='mini'){const _0x4d1566=await this[_0x4d44ba(0xa4)][_0x4d44ba(0x6f)]({'key':redisKey_constant_1[_0x4d44ba(0x8c)]});return _0x4d1566;}else throw new common_1[(_0x4d44ba(0xa9))](null,common_1[_0x4d44ba(0x81)][_0x4d44ba(0x8f)]);}}};OfficialService=__decorate([(0x0,common_1[_0x4438b4(0x6c)])(),__metadata(_0x4438b4(0x72),[autoreply_service_1[_0x4438b4(0xb8)],user_service_1[_0x4438b4(0x85)],auth_service_1['AuthService'],globalConfig_service_1[_0x4438b4(0x9e)],redisCache_service_1[_0x4438b4(0xc1)]])],OfficialService),exports['OfficialService']=OfficialService;