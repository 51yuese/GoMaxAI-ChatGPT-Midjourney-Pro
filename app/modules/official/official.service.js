'use strict';const _0x5c9b82=_0x4252;(function(_0xb8dc41,_0xef8740){const _0x440da1=_0x4252,_0x205607=_0xb8dc41();while(!![]){try{const _0x15c563=-parseInt(_0x440da1(0x1f1))/0x1*(parseInt(_0x440da1(0x1a5))/0x2)+parseInt(_0x440da1(0x1d0))/0x3*(-parseInt(_0x440da1(0x1e9))/0x4)+-parseInt(_0x440da1(0x1df))/0x5*(-parseInt(_0x440da1(0x200))/0x6)+parseInt(_0x440da1(0x19d))/0x7*(-parseInt(_0x440da1(0x1b2))/0x8)+parseInt(_0x440da1(0x1a7))/0x9*(-parseInt(_0x440da1(0x1ad))/0xa)+parseInt(_0x440da1(0x204))/0xb*(parseInt(_0x440da1(0x1e1))/0xc)+parseInt(_0x440da1(0x1cf))/0xd*(parseInt(_0x440da1(0x1ef))/0xe);if(_0x15c563===_0xef8740)break;else _0x205607['push'](_0x205607['shift']());}catch(_0xebf263){_0x205607['push'](_0x205607['shift']());}}}(_0x21e5,0xa77ea));function _0x21e5(){const _0x454456=['authService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','getAccessToken','@nestjs/common',']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>','default','loginByCode','wechatUser','&secret=','crypto','defineProperty','scanBindWx','decorate','errmsg','wechatOfficialAppId','../../common/utils/date','get','updateUserOpenId','13mXbUAk','907377NUfElK','getUserOpenId','getOwnPropertyDescriptor','genXmlMsgByConfig','checkAutoReply','bindWxBySceneStr','getQRCodeTicket','QR_STR_SCENE','&lang=zh_CN','HttpStatus','unionid','globalConfigService','officialAutoReplyText','split','tousername','26575ZiWdiy','wechatOfficialAppSecret','47604gunYPY','AuthService','loginBySceneStr','../../common/constants/redisKey.constant','scanedSceneStrMap','fetchQRCodeTicket','valueOf','./vo/Login.vo','16KsbIgm','RedisCacheService','sort','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','&openid=','openId','16616894TgbnWC','./../autoreply/autoreply.service','1PzyOAo','回跳跳转地址:\x20','----------------获取微信登录令牌AccessToken----------------','&redirect_uri=','getConfigByKeys','__metadata','GlobalConfigService','getUnionId','log','design:paramtypes','sceneStrMap','now','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','getUserUnionId','autoreplyService','1542RhygGx','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','getJwtToken','HttpException','3036xoGNuu','wechatOfficialToken','length','wechatJsapiTicket','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','hex','genXmlMsg','./../globalConfig/globalConfig.service','../redisCache/redisCache.service','update','wechatAccessToken','13727rHmPbB','user','bindWx','./../user/user.service','&noncestr=','aotoPlay','getQRSceneStr','sha1','1755150uvwiGt','__decorate','657hFmiWD','WE_MINI_ACCESS_KEY','createRandomNonceStr','BAD_REQUEST','UserService','object','107410qCekxB','userService',']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA[','&code=','appId:\x20','368cjdyTf','&grant_type=authorization_code','jsapi_ticket=',']]></Content>\x0a\x20\x20\x20\x20</xml>','OfficialLoginVO','&timestamp=','axios','official','Injectable','非法参数','authToken'];_0x21e5=function(){return _0x454456;};return _0x21e5();}var __decorate=this&&this[_0x5c9b82(0x1a6)]||function(_0x47f95d,_0x39f6a3,_0x518e4f,_0x31d15f){const _0x537736=_0x5c9b82;var _0x1203e6=arguments[_0x537736(0x206)],_0x681483=_0x1203e6<0x3?_0x39f6a3:_0x31d15f===null?_0x31d15f=Object[_0x537736(0x1d2)](_0x39f6a3,_0x518e4f):_0x31d15f,_0x45f267;if(typeof Reflect===_0x537736(0x1ac)&&typeof Reflect[_0x537736(0x1c9)]==='function')_0x681483=Reflect[_0x537736(0x1c9)](_0x47f95d,_0x39f6a3,_0x518e4f,_0x31d15f);else{for(var _0x4fed77=_0x47f95d[_0x537736(0x206)]-0x1;_0x4fed77>=0x0;_0x4fed77--)if(_0x45f267=_0x47f95d[_0x4fed77])_0x681483=(_0x1203e6<0x3?_0x45f267(_0x681483):_0x1203e6>0x3?_0x45f267(_0x39f6a3,_0x518e4f,_0x681483):_0x45f267(_0x39f6a3,_0x518e4f))||_0x681483;}return _0x1203e6>0x3&&_0x681483&&Object[_0x537736(0x1c7)](_0x39f6a3,_0x518e4f,_0x681483),_0x681483;},__metadata=this&&this[_0x5c9b82(0x1f6)]||function(_0x5bc975,_0x56d5a4){const _0x3c2d5d=_0x5c9b82;if(typeof Reflect===_0x3c2d5d(0x1ac)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x5bc975,_0x56d5a4);};function _0x4252(_0x542c6e,_0x56661d){const _0x21e543=_0x21e5();return _0x4252=function(_0x42522f,_0x56b537){_0x42522f=_0x42522f-0x197;let _0x4379e6=_0x21e543[_0x42522f];return _0x4379e6;},_0x4252(_0x542c6e,_0x56661d);}Object[_0x5c9b82(0x1c7)](exports,'__esModule',{'value':!![]}),exports['OfficialService']=void 0x0;const globalConfig_service_1=require(_0x5c9b82(0x199)),auth_service_1=require('./../auth/auth.service'),user_service_1=require(_0x5c9b82(0x1a0)),autoreply_service_1=require(_0x5c9b82(0x1f0)),common_1=require(_0x5c9b82(0x1c0)),crypto=require(_0x5c9b82(0x1c6)),axios_1=require(_0x5c9b82(0x1b8)),utils_1=require('../../common/utils'),Login_vo_1=require(_0x5c9b82(0x1e8)),redisKey_constant_1=require(_0x5c9b82(0x1e4)),redisCache_service_1=require(_0x5c9b82(0x19a)),date_1=require(_0x5c9b82(0x1cc));let OfficialService=class OfficialService{constructor(_0x3e1bee,_0x6f2632,_0x17aca9,_0x262320,_0x711072){const _0x5afb24=_0x5c9b82;this[_0x5afb24(0x1ff)]=_0x3e1bee,this[_0x5afb24(0x1ae)]=_0x6f2632,this[_0x5afb24(0x1bd)]=_0x17aca9,this[_0x5afb24(0x1db)]=_0x262320,this['redisCacheService']=_0x711072,this[_0x5afb24(0x1fb)]={},this[_0x5afb24(0x1e5)]={};}async[_0x5c9b82(0x1a3)](_0x21ba58){const _0x427cbf=_0x5c9b82,{invitedBy:_0x40a778}=_0x21ba58;let _0x224744=(0x0,utils_1[_0x427cbf(0x1a9)])(0x20);return _0x40a778&&(_0x224744+=':'+_0x40a778),this[_0x427cbf(0x1fb)][_0x224744]=!![],_0x224744;}async['getQRSceneStrByBind'](_0x16bbfd){const _0x441219=_0x5c9b82,{id:_0x4c482b}=_0x16bbfd['user'],_0x33abd7=(0x0,utils_1[_0x441219(0x1a9)])(0x20)+'/'+_0x4c482b;return this[_0x441219(0x1fb)][_0x33abd7]=!![],_0x33abd7;}async[_0x5c9b82(0x1d6)](_0x493bee){return this['fetchQRCodeTicket'](_0x493bee);}async['getRedirectUrl'](_0x2481ed){const _0x37c8df=_0x5c9b82,_0x4225e9=await this[_0x37c8df(0x1db)][_0x37c8df(0x1f5)]([_0x37c8df(0x1cb)]),_0x581934=_0x37c8df(0x1fd)+_0x4225e9+_0x37c8df(0x1f4)+encodeURIComponent(_0x2481ed)+'&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect';return console[_0x37c8df(0x1f9)](_0x37c8df(0x1f2),_0x581934),_0x581934;}async['getJsapiTicket'](_0x2585be){const _0x4ac6c3=_0x5c9b82,_0x1910f0=(0x0,utils_1[_0x4ac6c3(0x1a9)])(0x20),_0x2e661c=(Date[_0x4ac6c3(0x1fc)]()/0x3e8)['toFixed'](0x0),_0x57b7c8=await this['globalConfigService'][_0x4ac6c3(0x1f5)]([_0x4ac6c3(0x207),'wechatOfficialAppId']),{wechatJsapiTicket:_0x5df10e,wechatOfficialAppId:_0x387273}=_0x57b7c8;console[_0x4ac6c3(0x1f9)]('jsapiTicket:\x20',_0x5df10e),console[_0x4ac6c3(0x1f9)](_0x4ac6c3(0x1b1),_0x387273);const _0x34febc=_0x4ac6c3(0x1b4)+_0x5df10e+_0x4ac6c3(0x1a1)+_0x1910f0+_0x4ac6c3(0x1b7)+_0x2e661c+'&url='+_0x2585be;console['log']('str:\x20',_0x34febc);const _0x20b025=this[_0x4ac6c3(0x1a4)](_0x34febc);return{'appId':_0x387273,'nonceStr':_0x1910f0,'timestamp':_0x2e661c,'signature':_0x20b025};}async[_0x5c9b82(0x1e6)](_0x409423){const _0x1e527b=_0x5c9b82,_0x375cfd=await this[_0x1e527b(0x1db)][_0x1e527b(0x1f5)]([_0x1e527b(0x19c)]);console[_0x1e527b(0x1f9)](_0x1e527b(0x1f3),_0x375cfd);const _0x251ab={'action_name':_0x1e527b(0x1d7),'action_info':{'scene':{'scene_str':_0x409423}}},_0x435765=await axios_1[_0x1e527b(0x1c2)]['post'](_0x1e527b(0x1ec)+_0x375cfd,_0x251ab),{data:{errmsg:_0x25fb8f,ticket:_0x177888}}=_0x435765;if(_0x25fb8f)throw new common_1[(_0x1e527b(0x203))](_0x25fb8f,common_1[_0x1e527b(0x1d9)]['BAD_REQUEST']);return _0x177888;}async[_0x5c9b82(0x1c3)](_0x3f8a89,_0x2ec2dd){const _0x2e2103=_0x5c9b82,_0x501942=await this['globalConfigService'][_0x2e2103(0x1f5)]([_0x2e2103(0x1cb),_0x2e2103(0x1e0)]),{wechatOfficialAppId:_0x4278c6,wechatOfficialAppSecret:_0x3c7721}=_0x501942,_0x5a08ee=await axios_1[_0x2e2103(0x1c2)][_0x2e2103(0x1cd)](_0x2e2103(0x208)+_0x4278c6+_0x2e2103(0x1c5)+_0x3c7721+_0x2e2103(0x1b0)+_0x2ec2dd+_0x2e2103(0x1b3)),{data:{errmsg:_0x470f0c,openid:_0x2fb4d1,access_token:_0x40300a,unionid:_0x393741}}=_0x5a08ee;if(_0x470f0c)throw new common_1[(_0x2e2103(0x203))](_0x470f0c,common_1['HttpStatus'][_0x2e2103(0x1aa)]);let _0x6f6b2f=new Login_vo_1[(_0x2e2103(0x1b6))]();_0x6f6b2f[_0x2e2103(0x1ee)]=_0x2fb4d1,_0x6f6b2f[_0x2e2103(0x1da)]=_0x393741;let _0xf379b4;_0x393741&&(_0xf379b4=await this['userService'][_0x2e2103(0x1fe)](_0x393741));!_0xf379b4&&(_0xf379b4=await this[_0x2e2103(0x1ae)][_0x2e2103(0x1d1)](_0x2fb4d1));if(_0xf379b4)_0xf379b4['unionid']=_0x393741,_0xf379b4[_0x2e2103(0x1ee)]=_0x2fb4d1,await this[_0x2e2103(0x1ae)][_0x2e2103(0x1ce)](_0xf379b4['id'],_0x2fb4d1,_0x393741),_0x6f6b2f[_0x2e2103(0x1bc)]=await this[_0x2e2103(0x1bd)][_0x2e2103(0x202)](_0xf379b4,_0x3f8a89);else{if(_0x40300a){const {data:_0x30af2a}=await axios_1['default'][_0x2e2103(0x1cd)](_0x2e2103(0x1be)+_0x40300a+_0x2e2103(0x1ed)+_0x2fb4d1+'&lang=zh_CN');!_0x30af2a[_0x2e2103(0x1ca)]&&console['error'](_0x30af2a[_0x2e2103(0x1ca)]),_0x6f6b2f[_0x2e2103(0x1c4)]=_0x30af2a;}}return _0x6f6b2f;}async['scan'](_0x297f70,_0x13b32b){const _0x5aa0db=_0x5c9b82;if(!this[_0x5aa0db(0x1fb)][_0x13b32b])throw new common_1[(_0x5aa0db(0x203))](_0x5aa0db(0x1bb),common_1[_0x5aa0db(0x1d9)][_0x5aa0db(0x1aa)]);this[_0x5aa0db(0x1e5)][_0x13b32b]=_0x297f70;}async[_0x5c9b82(0x1e3)](_0x2e4fae,_0x44c9ac){const _0x47506f=_0x5c9b82;if(!this[_0x47506f(0x1fb)][_0x44c9ac])return;const _0x34a41f=this['scanedSceneStrMap'][_0x44c9ac];if(!_0x34a41f)return new Login_vo_1[(_0x47506f(0x1b6))]();let _0x258397=new Login_vo_1['OfficialLoginVO']();_0x258397[_0x47506f(0x1ee)]=_0x34a41f;const _0x31daf5=await this['userService']['getUserOpenId'](_0x34a41f);return _0x31daf5&&(_0x258397['authToken']=await this['authService'][_0x47506f(0x202)](_0x31daf5,_0x2e4fae)),delete this[_0x47506f(0x1e5)][_0x44c9ac],_0x258397;}async['getUnionId'](_0x40ffd2){const _0x1067f6=_0x5c9b82,_0x1e750c=await this['globalConfigService']['getConfigByKeys']([_0x1067f6(0x19c)]),{data:_0x214821}=await axios_1[_0x1067f6(0x1c2)][_0x1067f6(0x1cd)](_0x1067f6(0x201)+_0x1e750c+'&openid='+_0x40ffd2+_0x1067f6(0x1d8));return _0x214821?.[_0x1067f6(0x1da)];}async[_0x5c9b82(0x1c8)](_0x1603cd,_0x287ea2){const _0x1f5d34=_0x5c9b82;if(!this[_0x1f5d34(0x1fb)][_0x287ea2])throw new common_1[(_0x1f5d34(0x203))](_0x1f5d34(0x1bb),common_1[_0x1f5d34(0x1d9)]['BAD_REQUEST']);const _0xdfe693=_0x287ea2[_0x1f5d34(0x1dd)]('/')[0x1],_0x3d2e0e=await this[_0x1f5d34(0x1f8)](_0x1603cd),_0x404e6b=await this[_0x1f5d34(0x1ae)][_0x1f5d34(0x19f)](_0x1603cd,_0x3d2e0e,_0xdfe693);this['scanedSceneStrMap'][_0x287ea2]=_0x404e6b;}async[_0x5c9b82(0x1d5)](_0x379278,_0x4fa9dd){const _0x4dd606=_0x5c9b82;if(!this[_0x4dd606(0x1fb)][_0x4fa9dd])throw new common_1[(_0x4dd606(0x203))](_0x4dd606(0x1bb),common_1[_0x4dd606(0x1d9)][_0x4dd606(0x1aa)]);const {id:_0x585770}=_0x379278[_0x4dd606(0x19e)],_0x14c52a=this['scanedSceneStrMap'][_0x4fa9dd];if(!_0x14c52a)return'';return delete this[_0x4dd606(0x1e5)][_0x4fa9dd],_0x14c52a;}async['verify'](_0x56031c,_0x38f0a3,_0x30e877){const _0x7418b2=_0x5c9b82,_0x50f1ec=await this[_0x7418b2(0x1db)][_0x7418b2(0x1f5)]([_0x7418b2(0x205)]),_0x4d834f=_0x50f1ec||'jiangly';return await this[_0x7418b2(0x1a4)]([_0x4d834f,_0x38f0a3,_0x30e877][_0x7418b2(0x1eb)]()['join'](''))==_0x56031c;}[_0x5c9b82(0x1a4)](_0x4e2a0a){const _0x3448df=_0x5c9b82;return crypto['createHash'](_0x3448df(0x1a4))[_0x3448df(0x19b)](_0x4e2a0a)['digest'](_0x3448df(0x197));}async[_0x5c9b82(0x1d3)](_0x14b571,_0x17ec9f){const _0x4df6c1=_0x5c9b82,_0x17101d=await this[_0x4df6c1(0x1db)]['getConfigByKeys']([_0x17ec9f]);return this[_0x4df6c1(0x198)](_0x14b571,_0x17101d);}async[_0x5c9b82(0x198)](_0x890a79,_0x1b4e91){const _0x3d329a=_0x5c9b82;return'\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA['+_0x890a79['fromusername'][0x0]+_0x3d329a(0x1af)+_0x890a79[_0x3d329a(0x1de)][0x0]+_0x3d329a(0x1c1)+(0x0,date_1[_0x3d329a(0x1c2)])()[_0x3d329a(0x1e7)]()+'</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA['+_0x1b4e91+_0x3d329a(0x1b5);}async[_0x5c9b82(0x1a2)](_0x29bbce){const _0x33b192=_0x5c9b82;let _0x2aa3b3=await this['autoreplyService'][_0x33b192(0x1d4)](_0x29bbce);if(!_0x2aa3b3){const _0x5ad2da=await this['globalConfigService'][_0x33b192(0x1f5)]([_0x33b192(0x1dc)]);_0x2aa3b3=_0x5ad2da;}return _0x2aa3b3;}async[_0x5c9b82(0x1bf)](_0x54790e,_0x1dcf35){const _0x42e64f=_0x5c9b82;console[_0x42e64f(0x1f9)](_0x54790e['ip']);if(_0x1dcf35===_0x42e64f(0x1b9)){const _0x261535=await this['globalConfigService'][_0x42e64f(0x1f5)]([_0x42e64f(0x19c)]);return _0x261535;}else{if(_0x1dcf35==='mini'){const _0x224230=await this['redisCacheService'][_0x42e64f(0x1cd)]({'key':redisKey_constant_1[_0x42e64f(0x1a8)]});return _0x224230;}else throw new common_1[(_0x42e64f(0x203))](null,common_1[_0x42e64f(0x1d9)][_0x42e64f(0x1aa)]);}}};OfficialService=__decorate([(0x0,common_1[_0x5c9b82(0x1ba)])(),__metadata(_0x5c9b82(0x1fa),[autoreply_service_1['AutoreplyService'],user_service_1[_0x5c9b82(0x1ab)],auth_service_1[_0x5c9b82(0x1e2)],globalConfig_service_1[_0x5c9b82(0x1f7)],redisCache_service_1[_0x5c9b82(0x1ea)]])],OfficialService),exports['OfficialService']=OfficialService;