'use strict';const _0x2c2ad8=_0x1e10;(function(_0x46ad18,_0x568d3d){const _0x5d22d3=_0x1e10,_0x4838c0=_0x46ad18();while(!![]){try{const _0x1028e5=parseInt(_0x5d22d3(0x171))/0x1*(-parseInt(_0x5d22d3(0x1aa))/0x2)+-parseInt(_0x5d22d3(0xbc))/0x3+parseInt(_0x5d22d3(0x1c8))/0x4*(-parseInt(_0x5d22d3(0x192))/0x5)+parseInt(_0x5d22d3(0xe9))/0x6+parseInt(_0x5d22d3(0xbd))/0x7+-parseInt(_0x5d22d3(0xe1))/0x8+parseInt(_0x5d22d3(0xc3))/0x9;if(_0x1028e5===_0x568d3d)break;else _0x4838c0['push'](_0x4838c0['shift']());}catch(_0x58ea50){_0x4838c0['push'](_0x4838c0['shift']());}}}(_0x5aca,0x6b845));function _0x1e10(_0x4fc2f2,_0x3efd33){const _0x5acad2=_0x5aca();return _0x1e10=function(_0x1e103c,_0xc96a89){_0x1e103c=_0x1e103c-0xb9;let _0x473093=_0x5acad2[_0x1e103c];return _0x473093;},_0x1e10(_0x4fc2f2,_0x3efd33);}var __decorate=this&&this['__decorate']||function(_0x44e747,_0x5380c5,_0xbbba6c,_0x5201fe){const _0xc3895d=_0x1e10;var _0x4d5ef8=arguments[_0xc3895d(0x14e)],_0x2383db=_0x4d5ef8<0x3?_0x5380c5:_0x5201fe===null?_0x5201fe=Object[_0xc3895d(0x130)](_0x5380c5,_0xbbba6c):_0x5201fe,_0x15d308;if(typeof Reflect===_0xc3895d(0x1a6)&&typeof Reflect[_0xc3895d(0x142)]==='function')_0x2383db=Reflect[_0xc3895d(0x142)](_0x44e747,_0x5380c5,_0xbbba6c,_0x5201fe);else{for(var _0xf08f16=_0x44e747['length']-0x1;_0xf08f16>=0x0;_0xf08f16--)if(_0x15d308=_0x44e747[_0xf08f16])_0x2383db=(_0x4d5ef8<0x3?_0x15d308(_0x2383db):_0x4d5ef8>0x3?_0x15d308(_0x5380c5,_0xbbba6c,_0x2383db):_0x15d308(_0x5380c5,_0xbbba6c))||_0x2383db;}return _0x4d5ef8>0x3&&_0x2383db&&Object[_0xc3895d(0xed)](_0x5380c5,_0xbbba6c,_0x2383db),_0x2383db;},__metadata=this&&this[_0x2c2ad8(0x13a)]||function(_0xd22ff2,_0x477889){const _0x237d13=_0x2c2ad8;if(typeof Reflect===_0x237d13(0x1a6)&&typeof Reflect[_0x237d13(0xcc)]==='function')return Reflect[_0x237d13(0xcc)](_0xd22ff2,_0x477889);},__param=this&&this['__param']||function(_0x281fec,_0x224ce5){return function(_0x14ae7b,_0x3fd857){_0x224ce5(_0x14ae7b,_0x3fd857,_0x281fec);};};function _0x5aca(){const _0x228874=['inviteLink','set','Inject','configKey','\x20AND\x20u.createdAt\x20>=\x20','diff','userEntity','formatCreateOrUpdateDate','MUSIC','getUserOpenId','lifetimeVip','fast','username','createdAt','getOwnPropertyDescriptor','updateStatus','configEntity','createUser','getMjPrice','registerIp','getUserById','map','PPT','genInviteCode','__metadata','getConfigs','days','startsWith','1\x20=\x201','concat','../userBalance/userBalance.service','cloneDeep','decorate','forEach','assign','endOf','重置密码失败！','ConfigEntity','registerBaseUrl','validateBalance4MJ','mj123456admin','HttpException','description','inviteRewards','length','generateRandomString','hideString','genUserNames','inviteRewardVip','giftVip','手机号格式错误！','log','bcryptjs','VIDEO','email','super','type1','APP','userInitVip','transaction','手机号已被使用！','EChangeType','当前密码错误！','changeScore4Other','queryUserByUsername','pSubscribe','design:paramtypes','changeScore4registe','connection','inviterEmail','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(vipExpire\x20IS\x20NOT\x20NULL\x20OR\x20lifetimeVip\x20=\x201)',']成功!','modelName','upscale|describe|picread::retry|faceswap|shorten','inviterPhone','UserStatusEnum','isEmail','DESC','queryByPage','7097GHURfB','avatar','registerVerifyEmailFrom','VIP_EXPIRE','Injectable','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','save','\x20OFFSET\x20','compareSync','get','score','createVerification','当前账户不存在！','./user_init_vip.entity','DRAW','vipFreeKey','phone','%\x27\x20OR\x20u1.phone\x20LIKE\x20\x27%','delete','UserEntity','ActionCN','price','封面任务','论文生成PPT','没有变更，无需更改！','您的账户已被封禁、如有疑问、请联系管理员！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20username\x20LIKE\x20\x27%','invitedRewards','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Repository','insertAccountVipLog','message','MjDraw','55tJIiFl','updateUserPsd','exists','BLACKLISTED','findAndCount','用户名或者邮箱已被注册！','deductBalance4MJ','pptOutline','】使用扣减','hashSync','vipExpire','PPT【','绑定微信失败、请联系管理员！','当前用户不存在！','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','resetUserPass','getOne','../../common/constants/verification.constant','__keyevent@0__:expired','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','object','query','getUserInfo','未激活用户不可手动变更状态！','52GhUMhB','vipLeavelId','Music','用户余额不足，请充值','VipFree','createUserAndVerifycation','Chat','恭喜您绑定成功、后续可直接扫码登录了！','REDIS_SUBSCRIBER','onModuleInit','查询用户不存在！','validateBalance4Chat','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20phone\x20LIKE\x20\x27%','relax_vip_free','Connection','模型【','updateUserStatus','registerSendStatus','%\x27)','user','用户名已存在！','fast_mjDeduction','修改用户信息成功！','class-validator','】会员每日限免','当前用户信息失效、请重新登录！','用户名已被使用！','GPTS','当前手机号已注册、请勿重复注册！','BAD_REQUEST','118808aVvgvj','密码重置为[','qureyUserInfoByInviteCode','./../globalConfig/globalConfig.service','role','】会员永久免费','relax','PENDING','增加PPT单页','debuctBalance4PPT','includes','updateVipExpire','InjectRepository','%\x27\x20OR\x20email\x20LIKE\x20\x27%','bindWx','userBalanceService','add','Price','toLowerCase','增加PPT备注','../../common/utils/date','key','UserService','无效的邀请码！','then','BadRequest','modelType','受邀请注册赠送','重新生成封面任务','subscriber','day','getConfigByKeys','default','LessThanOrEqual','register','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','pptCreate','MoreThan','../../common/constants/balance.constant','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20*\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20users\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','verifyUserCredentials','startOf','deductBalance4Chat','isMobilePhone','%\x27\x20OR\x20nickname\x20LIKE\x20\x27%','update','getMiniOpenIdByUserId','registerVerifyExpir','DrawSpeed','relax_mjDeduction','VerificationEnum','affected','floor','redisCacheService','error:\x20','修改密码失败、请重新试试吧。','getVipLeavelRelById','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','InvitationReward','./user.entity','giftScore','../../common/constants/redisKey.constant','用户不存在！','LOCKED','userInitVipEntity','947238EkgJRq','646779XwYVvm','queryOne','HttpStatus','reduce','OTHER','生成邀请码失败，请重新试一次吧！','12698028ZunHPW','getOpenIdByUserId','EModelType','ACTIVE','userDefautlAvatar','管理员赠送','globalConfigService','UNAUTHORIZED','configVal','metadata','insertAccountLog','filter','AdminGift','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20`status`\x20=\x20','邀请新用户注册奖励','vlrk','turbo','genUserName','openId','__esModule','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(username\x20LIKE\x20\x27%','vipDays','turbo_mjDeduction','123456','%\x27\x20OR\x20phone\x20LIKE\x20\x27%','createBatch','visitor','registerRewards','maskEmail','VIP_FREE','2743856tzvera','不可将用户置为未激活状态！','increment','获取邀请记录失败！','create','更换模板','UserInitVipEntity','action','642432KvYrwA','inviteSendStatus','count','status','defineProperty','vipLeavelName','push','./../verification/verification.service','Tool','\x20\x0a\x20\x20\x20\x20','userId','toDate','MJ绘画【','yes','@nestjs/typeorm','type2','%\x27\x20)','的账号激活','mj-','\x20AND\x20(\x20u1.username\x20LIKE\x20\x27%','Invited','VerificationService','fetch|listbyids|modal|seed','修改用户状态失败！','find','\x20AND\x20u.userId\x20=\x20','../globalConfig/config.entity','nickname','queryOneUserInfo','queryUserInfoByIds','邮箱格式错误！','deduct','invitedRewardVip','@nestjs/common','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x20u\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u1\x20ON\x20u.invitedBy\x20=\x20u1.inviteCode\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20','UserStatusErrMsg','用户名已存在、请更换用户名！','vipFreeNum','../redisCache/redisCache.service','getClientIp','%\x27\x20OR\x20u1.nickname\x20LIKE\x20\x27%','已生成过邀请码、请勿重复生成','Draw','mailerService','findOne','】调用失败退还','%\x27\x20OR\x20u1.email\x20LIKE\x20\x27%','verificationService','verifyUserPassword','updateInfo','password','test','type3','isVerifyEmail','zh-CN','desc'];_0x5aca=function(){return _0x228874;};return _0x5aca();}Object[_0x2c2ad8(0xed)](exports,_0x2c2ad8(0xd6),{'value':!![]}),exports[_0x2c2ad8(0x1de)]=void 0x0;const globalConfig_service_1=require(_0x2c2ad8(0x1cb)),user_constant_1=require('../../common/constants/user.constant'),mailer_1=require('@nestjs-modules/mailer'),verification_service_1=require(_0x2c2ad8(0xf0)),common_1=require(_0x2c2ad8(0x10a)),typeorm_1=require(_0x2c2ad8(0xf7)),typeorm_2=require('typeorm'),user_entity_1=require(_0x2c2ad8(0x203)),bcrypt=require(_0x2c2ad8(0x156)),_=require('lodash'),verification_constant_1=require(_0x2c2ad8(0x1a3)),userBalance_service_1=require(_0x2c2ad8(0x140)),utils_1=require('../../common/utils'),balance_constant_1=require(_0x2c2ad8(0x1ee)),config_entity_1=require(_0x2c2ad8(0x103)),class_validator_1=require(_0x2c2ad8(0x1c1)),redisKey_constant_1=require(_0x2c2ad8(0x205)),redisCache_service_1=require(_0x2c2ad8(0x110)),model_constant_1=require('../../common/constants/model.constant'),midjourney_constant_1=require('../../common/constants/midjourney.constant'),user_init_vip_entity_1=require(_0x2c2ad8(0x17e)),axios_1=require('axios'),date_1=require(_0x2c2ad8(0x1dc));let UserService=class UserService{constructor(_0x180621,_0x33dd8e,_0x48c3fb,_0x21c616,_0x11115d,_0x15ad3d,_0x3f8920,_0x9ac427,_0x54b060,_0x296c7a){const _0x2db07f=_0x2c2ad8;this[_0x2db07f(0x1e5)]=_0x180621,this[_0x2db07f(0x128)]=_0x33dd8e,this['userInitVipEntity']=_0x48c3fb,this[_0x2db07f(0x132)]=_0x21c616,this[_0x2db07f(0x115)]=_0x11115d,this[_0x2db07f(0x1fd)]=_0x15ad3d,this[_0x2db07f(0x1d7)]=_0x3f8920,this[_0x2db07f(0xc9)]=_0x9ac427,this[_0x2db07f(0x119)]=_0x54b060,this[_0x2db07f(0x166)]=_0x296c7a;}[_0x2c2ad8(0x1b3)](){const _0x33e50e=_0x2c2ad8;console[_0x33e50e(0x155)]('==============================================================='),this[_0x33e50e(0x1e5)][_0x33e50e(0x163)](_0x33e50e(0x1a4),async _0xc1045b=>{const _0x2c8076=_0x33e50e;if(_0xc1045b[_0x2c8076(0x13d)](redisKey_constant_1[_0x2c8076(0x174)])){const _0x43f32c=_0xc1045b['replace'](redisKey_constant_1[_0x2c8076(0x174)],'');this['userEntity'][_0x2c8076(0x1f5)]({'id':Number(_0x43f32c)},{'vipExpire':null});}});}async['findByIds'](_0x1882df){const _0x38b8ab=_0x2c2ad8;if(!_0x1882df[_0x38b8ab(0x14e)])return[];const _0x432322=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x1882df)}});return _0x432322;}async[_0x2c2ad8(0x1af)](_0x180bc2,_0x498fb4){const _0x466306=_0x2c2ad8,{username:_0x52009b,email:_0x4a6e2f,password:_0x24d884,invitedBy:_0x2fafca,client:client=0x0}=_0x180bc2;if(_0x2fafca){const _0x30c1b1=await this[_0x466306(0x128)][_0x466306(0x116)]({'where':{'inviteCode':_0x2fafca}});if(!_0x30c1b1)throw new common_1[(_0x466306(0x14b))](_0x466306(0x1df),common_1[_0x466306(0xbf)][_0x466306(0x1c7)]);}const _0x5cdfda=[{'username':_0x52009b},{'email':_0x4a6e2f}],_0x44d5ad=await this[_0x466306(0x128)][_0x466306(0x116)]({'where':_0x5cdfda});if(_0x44d5ad&&_0x44d5ad[_0x466306(0xec)]!==user_constant_1[_0x466306(0x16d)]['PENDING'])throw new common_1[(_0x466306(0x14b))](_0x466306(0x197),common_1[_0x466306(0xbf)][_0x466306(0x1c7)]);try{const _0x3c3ed3=_[_0x466306(0x141)](_0x180bc2),_0xa24d70=bcrypt[_0x466306(0x19b)](_0x24d884,0xa),_0x38d5b0=(0x0,utils_1[_0x466306(0x111)])(_0x498fb4);_0x3c3ed3[_0x466306(0x11c)]=_0xa24d70,_0x3c3ed3[_0x466306(0x135)]=_0x38d5b0,_0x3c3ed3['client']=client;let _0x47a5ea;if(!_0x44d5ad){const _0x24db51=await this[_0x466306(0xc9)][_0x466306(0x13b)]([_0x466306(0xc7)]);_0x3c3ed3[_0x466306(0x172)]=_0x24db51,_0x47a5ea=await this[_0x466306(0x128)][_0x466306(0x177)](_0x3c3ed3);}else _0x47a5ea=_0x44d5ad;const _0x3b28c3=await this[_0x466306(0x132)][_0x466306(0x101)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x466306(0x11f),_0x466306(0x148),'registerVerifyEmailTitle','registerVerifyEmailDesc',_0x466306(0x173),_0x466306(0x1f7)])}}),_0x2c0e1f=_0x3b28c3[_0x466306(0xc0)]((_0x92acfc,_0x1d8eb6)=>{const _0x7d0aaa=_0x466306;return _0x92acfc[_0x1d8eb6[_0x7d0aaa(0x125)]]=_0x1d8eb6[_0x7d0aaa(0xcb)],_0x92acfc;},{}),_0x36029b=_0x2c0e1f[_0x466306(0x11f)]?Number(_0x2c0e1f[_0x466306(0x11f)]):0x1;if(_0x36029b){const _0x4f6645=_0x2c0e1f['registerVerifyExpir']?Number(_0x2c0e1f[_0x466306(0x1f7)]):0x1e*0x3c,_0x566c84=await this[_0x466306(0x119)][_0x466306(0x17c)](_0x47a5ea,verification_constant_1[_0x466306(0x1fa)]['Registration'],_0x4f6645),{code:_0xc504bb,email:_0xaa0048,id:_0x5b724c}=_0x566c84,{registerVerifyEmailFrom:_0x42912d}=_0x2c0e1f;await this[_0x466306(0x115)]['sendMail']({'to':_0xaa0048,'subject':'来自'+_0x42912d+_0x466306(0xfa),'template':_0x466306(0x1ea),'context':{'baseUrl':_0x2c0e1f[_0x466306(0x148)],'code':_0xc504bb,'id':_0x5b724c,..._0x2c0e1f}});}else{const {id:_0x41e6d3,invitedBy:_0x2a4403}=_0x47a5ea;await this[_0x466306(0x1ba)](_0x41e6d3,user_constant_1[_0x466306(0x16d)][_0x466306(0xc6)]);let _0x1ac0d3;_0x2a4403&&(_0x1ac0d3=await this['qureyUserInfoByInviteCode'](_0x2a4403)),await this['changeScore4registe'](_0x47a5ea,_0x1ac0d3);}return _0x47a5ea;}catch(_0x1e9895){console[_0x466306(0x155)](_0x466306(0x1fe),_0x1e9895);throw _0x1e9895;}}async[_0x2c2ad8(0x1f0)](_0x279c7b){const _0x3bd0ee=_0x2c2ad8,{username:_0x31e020,password:_0x5cca06,uid:uid=0x0,phone:_0x338b13}=_0x279c7b;let _0x4b66d5=null;if(uid>0x0){_0x4b66d5=await this[_0x3bd0ee(0x128)][_0x3bd0ee(0x116)]({'where':{'id':uid}});if(!_0x4b66d5)throw new common_1[(_0x3bd0ee(0x14b))](_0x3bd0ee(0x17d),common_1[_0x3bd0ee(0xbf)][_0x3bd0ee(0x1c7)]);if(!bcrypt[_0x3bd0ee(0x179)](_0x5cca06,_0x4b66d5[_0x3bd0ee(0x11c)]))throw new common_1[(_0x3bd0ee(0x14b))]('当前密码错误！',common_1[_0x3bd0ee(0xbf)][_0x3bd0ee(0x1c7)]);}if(_0x31e020&&_0x5cca06){const _0x5acc7e=[{'username':_0x31e020},{'email':_0x31e020}];_0x4b66d5=await this['userEntity'][_0x3bd0ee(0x116)]({'where':_0x5acc7e});if(!_0x4b66d5)throw new common_1[(_0x3bd0ee(0x14b))](_0x3bd0ee(0x17d),common_1[_0x3bd0ee(0xbf)]['BAD_REQUEST']);if(!bcrypt['compareSync'](_0x5cca06,_0x4b66d5[_0x3bd0ee(0x11c)]))throw new common_1[(_0x3bd0ee(0x14b))](_0x3bd0ee(0x160),common_1[_0x3bd0ee(0xbf)][_0x3bd0ee(0x1c7)]);}if(_0x338b13&&_0x5cca06){const _0x16d62e=[{'phone':_0x338b13}];_0x4b66d5=await this['userEntity'][_0x3bd0ee(0x116)]({'where':_0x16d62e});if(!_0x4b66d5)throw new common_1[(_0x3bd0ee(0x14b))](_0x3bd0ee(0x17d),common_1['HttpStatus'][_0x3bd0ee(0x1c7)]);if(!bcrypt[_0x3bd0ee(0x179)](_0x5cca06,_0x4b66d5['password']))throw new common_1['HttpException']('当前密码错误！',common_1[_0x3bd0ee(0xbf)][_0x3bd0ee(0x1c7)]);}if(!_0x4b66d5)throw new common_1['HttpException'](_0x3bd0ee(0x17d),common_1['HttpStatus']['BAD_REQUEST']);if(_0x4b66d5[_0x3bd0ee(0xec)]!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x3bd0ee(0x14b))](user_constant_1[_0x3bd0ee(0x10d)][_0x4b66d5[_0x3bd0ee(0xec)]],common_1[_0x3bd0ee(0xbf)][_0x3bd0ee(0x1c7)]);if(_0x4b66d5['username']&&!_0x4b66d5['lastLoginIp']){const _0x142353=await this[_0x3bd0ee(0xbb)][_0x3bd0ee(0x116)]({'where':{'username':_0x4b66d5[_0x3bd0ee(0x12e)]}});_0x142353&&await this['connection']['transaction'](async()=>{const _0x4b5b0f=_0x3bd0ee;_0x142353[_0x4b5b0f(0xd8)]===-0x1?_0x4b66d5['lifetimeVip']=0x1:_0x4b66d5[_0x4b5b0f(0x19c)]=(0x0,date_1['default'])()[_0x4b5b0f(0x1d8)](_0x142353[_0x4b5b0f(0xd8)],'day')[_0x4b5b0f(0xf4)](),_0x4b66d5=await this[_0x4b5b0f(0x128)]['save'](_0x4b66d5),await this[_0x4b5b0f(0xbb)][_0x4b5b0f(0x183)]({'id':_0x142353['id']});});}return _0x4b66d5;}async[_0x2c2ad8(0x11a)](_0x270b31,_0x33d68c){const _0x34eb75=_0x2c2ad8,_0x26ca35=await this['userEntity'][_0x34eb75(0x116)]({'where':{'id':_0x270b31}});return bcrypt[_0x34eb75(0x179)](_0x33d68c,_0x26ca35[_0x34eb75(0x11c)]);}async[_0x2c2ad8(0x1ba)](_0x5abf62,_0x14f065){const _0x1e1d32=_0x2c2ad8,_0x30afdf=await this[_0x1e1d32(0x128)][_0x1e1d32(0x1f5)]({'id':_0x5abf62},{'status':_0x14f065});return _0x30afdf[_0x1e1d32(0x1fb)]>0x0;}async['getUserStatus'](_0x173a00){const _0x925b28=_0x2c2ad8,_0x21fd2b=await this[_0x925b28(0x128)]['findOne']({'where':{'id':_0x173a00}});return _0x21fd2b[_0x925b28(0xec)];}async['queryUserInfoById'](_0x1d2a75){const _0xaed058=_0x2c2ad8;return await this[_0xaed058(0x128)]['findOne']({'where':{'id':_0x1d2a75}});}async[_0x2c2ad8(0x106)](_0x3a91bc){const _0x33aa60=_0x2c2ad8;return await this[_0x33aa60(0x128)]['findBy']({'id':(0x0,typeorm_2['In'])(_0x3a91bc)});}async[_0x2c2ad8(0x162)](_0x51633d){const _0x5f911=_0x2c2ad8;return await this[_0x5f911(0x128)][_0x5f911(0x116)]({'where':{'username':_0x51633d}});}async[_0x2c2ad8(0x193)](_0xe208fb){const _0x4b9bb6=_0x2c2ad8,{id:_0x13babe,username:_0x5bf02a,password:_0x44893f}=_0xe208fb;return await this[_0x4b9bb6(0x128)][_0x4b9bb6(0x1f5)](_0x13babe,{'username':_0x5bf02a,'password':_0x44893f});}async[_0x2c2ad8(0x105)](_0x16a783){const _0x150f00=_0x2c2ad8;return await this[_0x150f00(0x128)][_0x150f00(0x116)]({'where':{'id':_0x16a783}});}async['checkUserStatus'](_0x325ffe){const _0x566070=_0x2c2ad8,{id:_0x1df72e,role:_0x4e99f5}=_0x325ffe;if(_0x4e99f5===_0x566070(0xdd))return!![];const _0x58e5bd=await this[_0x566070(0x128)][_0x566070(0x116)]({'where':{'id':_0x1df72e}});if(!_0x58e5bd)throw new common_1[(_0x566070(0x14b))](_0x566070(0x1c3),common_1[_0x566070(0xbf)][_0x566070(0xca)]);if(_0x58e5bd[_0x566070(0xec)]===user_constant_1[_0x566070(0x16d)][_0x566070(0x195)])throw new common_1[(_0x566070(0x14b))](_0x566070(0x176),common_1[_0x566070(0xbf)][_0x566070(0x1c7)]);if(_0x58e5bd[_0x566070(0xec)]===user_constant_1[_0x566070(0x16d)][_0x566070(0xba)])throw new common_1[(_0x566070(0x14b))](_0x566070(0x18a),common_1[_0x566070(0xbf)][_0x566070(0x1c7)]);}async[_0x2c2ad8(0x1a8)](_0x1d970c){const _0x3f45d1=_0x2c2ad8,_0x21c44c=await this[_0x3f45d1(0xbe)]({'id':_0x1d970c});return{'userInfo':_0x21c44c};}async['getUserById'](_0x5bf79b){return await this['userEntity']['findOne']({'where':{'id':_0x5bf79b}});}async[_0x2c2ad8(0x12b)](_0x1dd1ff){const _0x1d8803=_0x2c2ad8;return await this[_0x1d8803(0x128)]['findOne']({'where':{'openId':_0x1dd1ff}});}async[_0x2c2ad8(0x11b)](_0x25aa96,_0x150247){const _0x724251=_0x2c2ad8,{id:_0x1710a3}=_0x150247['user'],_0xbe28f9=await this[_0x724251(0x128)][_0x724251(0x116)]({'where':{'id':_0x1710a3}});if(!_0xbe28f9)throw new common_1[(_0x724251(0x14b))](_0x724251(0x19f),common_1[_0x724251(0xbf)][_0x724251(0x1c7)]);if(_0x25aa96[_0x724251(0x12e)]&&_0xbe28f9[_0x724251(0x12e)]===_0x25aa96[_0x724251(0x12e)])throw new common_1[(_0x724251(0x14b))](_0x724251(0x189),common_1[_0x724251(0xbf)]['BAD_REQUEST']);if(_0x25aa96[_0x724251(0x12e)]){const _0x3f6a04=await this['userEntity'][_0x724251(0x116)]({'where':{'username':_0x25aa96['username'],'id':(0x0,typeorm_2['Not'])(_0x1710a3)}});if(_0x3f6a04)throw new common_1[(_0x724251(0x14b))](_0x724251(0x1be),common_1['HttpStatus'][_0x724251(0x1c7)]);}const _0x220bc7=await this[_0x724251(0x128)]['update']({'id':_0x1710a3},_0x25aa96);if(_0x220bc7['affected']<=0x0)throw new common_1[(_0x724251(0x14b))]('修改用户信息失败！',common_1['HttpStatus']['BAD_REQUEST']);return _0x724251(0x1c0);}async['updateUserPassword'](_0x50aa08,_0x49b94d){const _0x80480b=_0x2c2ad8,_0x427d7c=bcrypt[_0x80480b(0x19b)](_0x49b94d,0xa),_0x3c81ba=await this['userEntity'][_0x80480b(0x1f5)]({'id':_0x50aa08},{'password':_0x427d7c});if(_0x3c81ba['affected']<=0x0)throw new common_1[(_0x80480b(0x14b))](_0x80480b(0x1ff),common_1[_0x80480b(0xbf)][_0x80480b(0x1c7)]);}async[_0x2c2ad8(0x139)](_0x5382c9){const _0x32c819=_0x2c2ad8,{id:_0x20258f}=_0x5382c9['user'],_0x4e146b=await this[_0x32c819(0x128)]['findOne']({'where':{'id':_0x20258f}});if(!_0x4e146b||_0x4e146b['inviteCode'])throw new common_1[(_0x32c819(0x14b))](_0x32c819(0x113),common_1[_0x32c819(0xbf)]['BAD_REQUEST']);const _0x40b3f3=(0x0,utils_1[_0x32c819(0x14f)])(),_0x2b7367=await this[_0x32c819(0x128)][_0x32c819(0x116)]({'where':{'inviteCode':_0x40b3f3}});if(_0x2b7367)throw new common_1['HttpException'](_0x32c819(0xc2),common_1[_0x32c819(0xbf)][_0x32c819(0x1c7)]);const _0x222529=await this['userEntity']['update']({'id':_0x20258f},{'inviteCode':_0x40b3f3});if(_0x222529['affected']<=0x0)throw new common_1[(_0x32c819(0x14b))](_0x32c819(0xc2),common_1['HttpStatus'][_0x32c819(0x1c7)]);return _0x40b3f3;}async['getInviteRecord'](_0x3e76fb,_0x54dd69){const _0x5b28a7=_0x2c2ad8;try{const {id:_0x3cb504}=_0x3e76fb[_0x5b28a7(0x1bd)],{page:page=0x1,size:size=0xa}=_0x54dd69,_0x48ed6c=await this[_0x5b28a7(0x128)][_0x5b28a7(0x116)]({'where':{'id':_0x3cb504}}),{inviteCode:_0x28f3d6}=_0x48ed6c;if(!_0x28f3d6)return[];const [_0x2d2f84,_0x51b92d]=await this['userEntity'][_0x5b28a7(0x196)]({'where':{'inviteCode':_0x28f3d6},'order':{'id':_0x5b28a7(0x16f)},'select':[_0x5b28a7(0x12e),_0x5b28a7(0x158),_0x5b28a7(0x12f),_0x5b28a7(0xec),_0x5b28a7(0x172)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x5b28a7(0x129)])(_0x2d2f84)[_0x5b28a7(0x137)](_0x595fa6=>{const _0x564ccf=_0x5b28a7;return _0x595fa6[_0x564ccf(0x158)]=(0x0,utils_1['maskEmail'])(_0x595fa6[_0x564ccf(0x158)]),_0x595fa6;}),{'rows':_0x2d2f84,'count':_0x51b92d};}catch(_0x20a2dd){console[_0x5b28a7(0x155)](_0x5b28a7(0x1fe),_0x20a2dd);throw new common_1[(_0x5b28a7(0x14b))](_0x5b28a7(0xe4),common_1[_0x5b28a7(0xbf)][_0x5b28a7(0x1c7)]);}}async['invitePage'](_0x71b0b4,_0xc7efb0,_0x22b453){const _0x1005f6=_0x2c2ad8,{page:page=0x1,size:size=0x14,startTime:_0xf3b96b,endTime:_0x5403f2,keyword:_0xb291e5,inviterKeyword:_0x106ccf}=_0xc7efb0,_0x9950fc='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.invitedBy\x20!=\x20\x27\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20u.invitedBy\x20IS\x20NOT\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x22b453?_0x1005f6(0x102)+_0x22b453:'')+_0x1005f6(0x18d)+(_0x5403f2?'\x20AND\x20u.createdAt\x20<=\x20'+_0x5403f2:'')+_0x1005f6(0x18d)+(_0xf3b96b?_0x1005f6(0x126)+_0xf3b96b:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0xb291e5?_0x1005f6(0x1a5)+_0xb291e5+_0x1005f6(0x1eb)+_0xb291e5+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0xb291e5+_0x1005f6(0x1a0)+_0xb291e5+_0x1005f6(0xf9):'')+_0x1005f6(0x18d)+(_0x106ccf?_0x1005f6(0xfc)+_0x106ccf+_0x1005f6(0x182)+_0x106ccf+_0x1005f6(0x112)+_0x106ccf+_0x1005f6(0x118)+_0x106ccf+_0x1005f6(0xf9):'')+_0x1005f6(0x10c),_0xc74110=_0x1005f6(0x10b)+_0x9950fc+_0x1005f6(0x10c),_0x3edee5='\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.id\x20AS\x20inviterId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.avatar\x20AS\x20inviterAvatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.username\x20AS\x20inviterUsername,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.nickname\x20AS\x20inviterNickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.phone\x20AS\x20inviterPhone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u1.email\x20AS\x20inviterEmail\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20users\x20u\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u1\x20ON\x20u.invitedBy\x20=\x20u1.inviteCode\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x9950fc+_0x1005f6(0x201)+size+_0x1005f6(0x178)+(page-0x1)*size+_0x1005f6(0x10c),_0x11209d=await this[_0x1005f6(0x166)]['query'](_0xc74110),_0x1473aa=await this[_0x1005f6(0x166)][_0x1005f6(0x1a7)](_0x3edee5);return _0x71b0b4['user']['role']!==_0x1005f6(0x159)&&_0x1473aa[_0x1005f6(0x143)](_0x46caa7=>{const _0x1a1b00=_0x1005f6;_0x46caa7[_0x1a1b00(0x181)]=(0x0,utils_1[_0x1a1b00(0x150)])(_0x46caa7[_0x1a1b00(0x181)]),_0x46caa7[_0x1a1b00(0x158)]=(0x0,utils_1[_0x1a1b00(0x150)])(_0x46caa7['email']),_0x46caa7['inviterPhone']=(0x0,utils_1[_0x1a1b00(0x150)])(_0x46caa7[_0x1a1b00(0x16c)]),_0x46caa7[_0x1a1b00(0x167)]=(0x0,utils_1['hideString'])(_0x46caa7[_0x1a1b00(0x167)]);}),{'rows':_0x1473aa,'count':Number(_0x11209d[0x0]?.['count']||0x0)};}async[_0x2c2ad8(0x122)](_0x3a3b29){const _0x29c435=_0x2c2ad8,_0x463b83=await this[_0x29c435(0x128)][_0x29c435(0x116)]({'where':{'inviteCode':_0x3a3b29}});if(!_0x463b83)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x463b83,_0x493c4b=await this[_0x29c435(0x128)][_0x29c435(0x1f5)]({'inviteCode':_0x3a3b29},{'inviteLinkCount':inviteLinkCount+0x1});return _0x493c4b[_0x29c435(0x1fb)]?0x1:0x0;}async[_0x2c2ad8(0x1ca)](_0x1d1419){const _0xf040fe=_0x2c2ad8;return await this[_0xf040fe(0x128)]['findOne']({'where':{'inviteCode':_0x1d1419}});}async['queryAll'](_0x3be2bc,_0x143d77){const _0x14b533=_0x2c2ad8;let {page:page=0x1,size:size=0xa,username:_0x523b12,phone:_0x153616,email:_0x405e3c,status:_0x192beb,keyword:_0x471945,vip:_0x2e68fe}=_0x3be2bc,_0x23125f=_0x14b533(0x13e);_0x192beb&&(_0x23125f=_0x23125f+(_0x14b533(0xd0)+_0x192beb));_0x2e68fe&&(_0x2e68fe=Number(_0x2e68fe));if(_0x2e68fe===0x1)_0x23125f=_0x23125f+_0x14b533(0x168);else _0x2e68fe===0x0&&(_0x23125f=_0x23125f+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20lifetimeVip\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20vipExpire\x20IS\x20NULL');_0x471945?_0x23125f=_0x23125f+(_0x14b533(0xd7)+_0x471945+_0x14b533(0x1f4)+_0x471945+_0x14b533(0xdb)+_0x471945+_0x14b533(0x1d5)+_0x471945+_0x14b533(0x1bc)):(_0x523b12&&(_0x23125f=_0x23125f+(_0x14b533(0x18b)+_0x523b12+'%\x27')),_0x405e3c&&(_0x23125f=_0x23125f+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20email\x20LIKE\x20\x27%'+_0x405e3c+'%\x27')),_0x153616&&(_0x23125f=_0x23125f+(_0x14b533(0x1b6)+_0x153616+'%\x27')));const _0x2fc33c=await this[_0x14b533(0x166)][_0x14b533(0x1a7)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20users\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x23125f+_0x14b533(0xf2)),_0x1ae357=await this['connection'][_0x14b533(0x1a7)](_0x14b533(0x1ef)+_0x23125f+'\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x14b533(0x178)+(page-0x1)*size+_0x14b533(0x10c)),_0x1e27b7=_0x143d77['user'][_0x14b533(0x1cc)]===_0x14b533(0x159),_0x5309a4=_0x1ae357['map'](_0x55c783=>{const _0x5506a9=_0x14b533;return{..._0x55c783,'isBindWx':!!_0x55c783?.['openId'],'password':_0x55c783[_0x5506a9(0x11c)]?_0x5506a9(0xf6):'no','email':_0x1e27b7?_0x55c783[_0x5506a9(0x158)]:(0x0,utils_1[_0x5506a9(0xdf)])(_0x55c783[_0x5506a9(0x158)]),'phone':_0x1e27b7?_0x55c783[_0x5506a9(0x181)]:(0x0,utils_1[_0x5506a9(0xdf)])(_0x55c783[_0x5506a9(0x181)]),'lastLoginIp':_0x1e27b7?_0x55c783['lastLoginIp']:(0x0,utils_1['maskIpAddress'])(_0x55c783['lastLoginIp'])};});return{'rows':_0x5309a4,'count':Number(_0x2fc33c[0x0]?.[_0x14b533(0xeb)]||0x0)};}async[_0x2c2ad8(0x170)](_0x107f1f){const _0x254e32=_0x2c2ad8,{page:page=0x1,size:size=0xa,username:_0x35f7a9,status:_0x2f6480}=_0x107f1f;let _0xf529c2={};_0x35f7a9&&Object[_0x254e32(0x144)](_0xf529c2,{'username':(0x0,typeorm_2['Like'])('%'+_0x35f7a9+'%')}),_0x2f6480&&Object[_0x254e32(0x144)](_0xf529c2,{'status':_0x2f6480});const [_0x1b9894,_0x58afe8]=await this[_0x254e32(0x128)][_0x254e32(0x196)]({'skip':(page-0x1)*size,'where':_0xf529c2,'take':size,'cache':!![],'order':{'createdAt':_0x254e32(0x16f)},'select':[_0x254e32(0x12e),_0x254e32(0x11c),_0x254e32(0x1cc),_0x254e32(0xec),'id']});return{'rows':_0x1b9894,'count':_0x58afe8};}async['queryOne']({id:_0x2bb913}){const _0xfda8e2=_0x2c2ad8,_0x59e738=await this[_0xfda8e2(0x128)][_0xfda8e2(0x116)]({'where':{'id':_0x2bb913}});if(!_0x59e738)throw new common_1[(_0xfda8e2(0x14b))](_0xfda8e2(0x1b4),common_1[_0xfda8e2(0xbf)][_0xfda8e2(0xca)]);return{..._0x59e738,'isBindWx':!!_0x59e738?.[_0xfda8e2(0xd5)],'password':_0x59e738[_0xfda8e2(0x11c)]?_0xfda8e2(0xf6):'no'};}async[_0x2c2ad8(0x1a2)](_0x4444ad){const _0x733d10=_0x2c2ad8;return await this[_0x733d10(0x128)]['findOne']({'where':{'username':_0x4444ad}});}async[_0x2c2ad8(0x131)](_0x4e36c1){const _0x431571=_0x2c2ad8,{id:_0x2090c7,status:_0x330a1b}=_0x4e36c1,_0x4878c7=await this[_0x431571(0x128)][_0x431571(0x116)]({'where':{'id':_0x2090c7}});if(!_0x4878c7)throw new common_1[(_0x431571(0x14b))](_0x431571(0xb9),common_1[_0x431571(0xbf)][_0x431571(0x1c7)]);if(_0x4878c7[_0x431571(0x1cc)]==='super')throw new common_1[(_0x431571(0x14b))]('超级管理员不可被操作！',common_1[_0x431571(0xbf)][_0x431571(0x1c7)]);if(_0x4878c7[_0x431571(0xec)]===user_constant_1[_0x431571(0x16d)][_0x431571(0x1cf)])throw new common_1[(_0x431571(0x14b))](_0x431571(0x1a9),common_1[_0x431571(0xbf)][_0x431571(0x1c7)]);if(_0x4878c7[_0x431571(0x1cc)]===_0x431571(0x159))throw new common_1[(_0x431571(0x14b))]('超级管理员不可被操作！',common_1[_0x431571(0xbf)][_0x431571(0x1c7)]);if(_0x330a1b===user_constant_1[_0x431571(0x16d)][_0x431571(0x1cf)])throw new common_1[(_0x431571(0x14b))](_0x431571(0xe2),common_1['HttpStatus'][_0x431571(0x1c7)]);const _0x5ba1b7=await this[_0x431571(0x128)][_0x431571(0x1f5)]({'id':_0x2090c7},{'status':_0x330a1b});if(_0x5ba1b7[_0x431571(0x1fb)]<=0x0)throw new common_1['HttpException'](_0x431571(0x100),common_1['HttpStatus'][_0x431571(0x1c7)]);return'修改用户状态成功！';}async[_0x2c2ad8(0x1a1)](_0x1a16ed){const _0x38e5ff=_0x2c2ad8,{id:_0x5ecb60}=_0x1a16ed,_0x3352fd=await this[_0x38e5ff(0x128)]['findOne']({'where':{'id':_0x5ecb60}});if(!_0x3352fd)throw new common_1['HttpException'](_0x38e5ff(0xb9),common_1[_0x38e5ff(0xbf)][_0x38e5ff(0x1c7)]);const _0x52a9db=_0x38e5ff(0xda),_0x118f5b=bcrypt[_0x38e5ff(0x19b)](_0x52a9db,0xa),_0x1b3b0f=await this[_0x38e5ff(0x128)][_0x38e5ff(0x1f5)]({'id':_0x5ecb60},{'password':_0x118f5b});if(_0x1b3b0f[_0x38e5ff(0x1fb)]<=0x0)throw new common_1[(_0x38e5ff(0x14b))](_0x38e5ff(0x146),common_1[_0x38e5ff(0xbf)][_0x38e5ff(0x1c7)]);return _0x38e5ff(0x1c9)+_0x52a9db+_0x38e5ff(0x169);}async['savaLoginIp'](_0x52ca19,_0xc3f094){const _0x4bc156=_0x2c2ad8;return await this[_0x4bc156(0x128)][_0x4bc156(0x1f5)]({'id':_0x52ca19},{'lastLoginIp':_0xc3f094});}async[_0x2c2ad8(0x1d6)](_0x1b25de,_0x3c5a32){const _0x5deb9d=_0x2c2ad8;try{const _0x1094db=await this[_0x5deb9d(0x128)][_0x5deb9d(0x116)]({'where':{'id':_0x3c5a32}});if(!_0x1094db)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x1f788b=await this['userEntity'][_0x5deb9d(0x116)]({'where':{'openId':_0x1b25de}});if(_0x1f788b)return{'status':![],'msg':'该微信已绑定其他账号！'};const _0x39b65d=await this[_0x5deb9d(0x128)][_0x5deb9d(0x1f5)]({'id':_0x3c5a32},{'openId':_0x1b25de});if(_0x39b65d[_0x5deb9d(0x1fb)]<=0x0)return{'status':![],'msg':'绑定微信失败、请联系管理员！'};return{'status':!![],'msg':_0x5deb9d(0x1b1)};}catch(_0x45b671){return{'status':![],'msg':_0x5deb9d(0x19e)};}}async[_0x2c2ad8(0xc4)](_0xa894c7){const _0x380cd3=_0x2c2ad8,_0x5f13eb=await this[_0x380cd3(0x128)][_0x380cd3(0x116)]({'where':{'id':_0xa894c7}});return _0x5f13eb?.[_0x380cd3(0xd5)];}async[_0x2c2ad8(0x1f6)](_0xc3a69d){const _0x30bbf8=_0x2c2ad8,_0x5e8d38=await this[_0x30bbf8(0x128)]['findOne']({'where':{'id':_0xc3a69d}});return _0x5e8d38?.['miniOpenId'];}async['verifyUserRegisterByPhone'](_0x40f34c){const _0xe243c3=_0x2c2ad8,{username:_0x4fb83c,password:_0x1e7ac5,phone:_0x49ea5a,phoneCode:_0xd537bf}=_0x40f34c,_0x5a705c=await this[_0xe243c3(0x128)][_0xe243c3(0x116)]({'where':[{'username':_0x4fb83c},{'phone':_0x49ea5a}]});if(_0x5a705c&&_0x5a705c[_0xe243c3(0x12e)]===_0x4fb83c)throw new common_1[(_0xe243c3(0x14b))](_0xe243c3(0x10e),common_1[_0xe243c3(0xbf)]['BAD_REQUEST']);if(_0x5a705c&&_0x5a705c[_0xe243c3(0x181)]===_0x49ea5a)throw new common_1[(_0xe243c3(0x14b))](_0xe243c3(0x1c6),common_1[_0xe243c3(0xbf)]['BAD_REQUEST']);}async[_0x2c2ad8(0x133)](_0x37e2fa){const _0x2117d4=_0x2c2ad8;return await this['userEntity'][_0x2117d4(0x177)](_0x37e2fa);}async['delUser'](_0x5bd44e){const _0x141b29=_0x2c2ad8,{id:_0xc0cdfd,moreId:_0x26bb93}=_0x5bd44e;if(_0xc0cdfd)return await this[_0x141b29(0x128)][_0x141b29(0x183)]({'id':_0xc0cdfd});if(_0x26bb93)return await this['userEntity'][_0x141b29(0x183)]({'id':(0x0,typeorm_2[_0x141b29(0x1ed)])(_0x26bb93)});}async['destroyAccount'](_0x14166d){const _0xfe6725=_0x2c2ad8,_0x43fa60=_0x14166d[_0xfe6725(0x1bd)]['id'];return await this[_0xfe6725(0x128)]['delete']({'id':_0x43fa60})[_0xfe6725(0x1e0)](_0x244128=>_0x244128[_0xfe6725(0x1fb)]>0x0);}async[_0x2c2ad8(0xe5)](_0x516aac,_0x35829a){const _0xd0230b=_0x2c2ad8;try{if(!_0x516aac['username']&&!_0x516aac[_0xd0230b(0x181)]&&!_0x516aac['email'])throw new Error('账号、手机、邮箱必须存在一个');if(_0x516aac[_0xd0230b(0x12e)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0xd0230b(0x11d)](_0x516aac[_0xd0230b(0x12e)]))throw new Error('用户名格式错误,\x20用户名只能由字母+数字，且不包含特殊字符');if(!_0x516aac['password'])throw new Error('账号注册时密码不能为空！');}if(_0x516aac['phone']){if(!(0x0,class_validator_1[_0xd0230b(0x1f3)])(_0x516aac[_0xd0230b(0x181)],_0xd0230b(0x120)))throw new Error(_0xd0230b(0x154));}if(_0x516aac[_0xd0230b(0x158)]){if(!(0x0,class_validator_1[_0xd0230b(0x16e)])(_0x516aac['email']))throw new Error(_0xd0230b(0x107));}if(_0x516aac[_0xd0230b(0x12e)]){const _0x169d9c=await this['userEntity'][_0xd0230b(0x194)]({'where':{'username':_0x516aac[_0xd0230b(0x12e)]}});if(_0x169d9c)throw new Error(_0xd0230b(0x1c4));}if(_0x516aac['phone']){const _0x548d53=await this['userEntity'][_0xd0230b(0x194)]({'where':{'phone':_0x516aac[_0xd0230b(0x181)]}});if(_0x548d53)throw new Error(_0xd0230b(0x15e));}if(_0x516aac[_0xd0230b(0x158)]){const _0x5098e0=await this[_0xd0230b(0x128)][_0xd0230b(0x194)]({'where':{'email':_0x516aac[_0xd0230b(0x158)]}});if(_0x5098e0)throw new Error('邮箱已被使用！');}const _0x35d46f=new user_entity_1['UserEntity']();for(let _0x7504e2 in _0x516aac){_0x516aac[_0x7504e2]&&(_0x35d46f[_0x7504e2]=_0x516aac[_0x7504e2]);}return _0x35d46f[_0xd0230b(0x11c)]&&(_0x35d46f[_0xd0230b(0x11c)]=bcrypt[_0xd0230b(0x19b)](_0x516aac[_0xd0230b(0x11c)],0xa)),_0x35d46f[_0xd0230b(0xec)]=user_constant_1[_0xd0230b(0x16d)][_0xd0230b(0xc6)],!_0x35d46f[_0xd0230b(0x104)]&&(_0x35d46f[_0xd0230b(0x104)]=_0x35d46f[_0xd0230b(0x104)]||'小智'),!_0x35d46f[_0xd0230b(0x172)]&&(_0x35d46f[_0xd0230b(0x172)]=await this[_0xd0230b(0xc9)][_0xd0230b(0x13b)](['userDefautlAvatar'])),await this[_0xd0230b(0x133)](_0x35d46f),!![];}catch(_0xda3145){throw new common_1[(_0xd0230b(0x14b))](_0xda3145['message'],common_1[_0xd0230b(0xbf)][_0xd0230b(0x1c7)]);}}[_0x2c2ad8(0xd4)](){const _0x1fa851=_0x2c2ad8;let _0x4854b3=_0x1fa851(0xfb);const _0x39cd90=[0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,'-','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];for(let _0x213ba8=0x0;_0x213ba8<0xa;_0x213ba8++){_0x4854b3=_0x4854b3+_0x39cd90[Math[_0x1fa851(0x1fc)](Math['random']()*0x3f)];}return _0x4854b3;}async[_0x2c2ad8(0x151)](_0x1c15a5){const _0x2a9624=_0x2c2ad8;let _0x2dabbf=[];for(let _0x293ff7=0x0;_0x293ff7<_0x1c15a5;_0x293ff7++){_0x2dabbf[_0x2a9624(0xef)](this[_0x2a9624(0xd4)]());}const _0x17dbe3=await this['userEntity'][_0x2a9624(0x101)]({'where':{'username':(0x0,typeorm_2['In'])(_0x2dabbf)}});if(!_0x17dbe3['length'])return _0x2dabbf;else{const _0x5d8e73=new Set(_0x17dbe3[_0x2a9624(0x137)](_0x5b933e=>_0x5b933e[_0x2a9624(0x12e)]));_0x2dabbf=_0x2dabbf[_0x2a9624(0xce)](_0x5b7f51=>!_0x5d8e73['has'](_0x5b7f51));const _0x58156a=await this['genUserNames'](_0x5d8e73['size']);return _0x2dabbf=_0x2dabbf[_0x2a9624(0x13f)](_0x58156a),_0x2dabbf;}}async[_0x2c2ad8(0xdc)](_0x23824e,_0x9927ea){const _0x3df364=_0x2c2ad8,_0xef1507=await this[_0x3df364(0x151)](_0x23824e['num']),_0x671347=[],_0x65e4d7=[],_0x18c546=await this[_0x3df364(0xc9)][_0x3df364(0x13b)](['userDefautlAvatar']);for(let _0x5de5a9=0x0;_0x5de5a9<_0x23824e['num'];_0x5de5a9++){const _0x5130da=new user_entity_1[(_0x3df364(0x184))]();_0x5130da[_0x3df364(0xec)]=0x1,_0x5130da[_0x3df364(0x172)]=_0x18c546,_0x5130da[_0x3df364(0x12e)]=_0xef1507[_0x5de5a9],_0x5130da[_0x3df364(0x104)]=_0xef1507[_0x5de5a9],_0x5130da[_0x3df364(0x11c)]=bcrypt[_0x3df364(0x19b)](_0x3df364(0x14a),0xa),_0x23824e[_0x3df364(0x1ab)]&&(_0x5130da[_0x3df364(0x1ab)]=Number(_0x23824e[_0x3df364(0x1ab)])),_0x23824e['vipLeavelName']&&(_0x5130da[_0x3df364(0xee)]=_0x23824e[_0x3df364(0xee)]),_0x23824e[_0x3df364(0x17b)]&&(_0x5130da[_0x3df364(0x17b)]=_0x23824e[_0x3df364(0x17b)]),_0x23824e[_0x3df364(0xd8)]&&_0x65e4d7['push']({'username':_0xef1507[_0x5de5a9],'vipDays':_0x23824e[_0x3df364(0xd8)]}),_0x671347[_0x3df364(0xef)](_0x5130da);}try{return await this['connection'][_0x3df364(0x15d)](async()=>{const _0x418ca3=_0x3df364;await this['userEntity'][_0x418ca3(0x177)](_0x671347),await this[_0x418ca3(0xbb)][_0x418ca3(0x177)](_0x65e4d7);}),!![];}catch(_0x38ef86){throw new common_1[(_0x3df364(0x14b))](_0x38ef86[_0x3df364(0x190)],axios_1['HttpStatusCode'][_0x3df364(0x1e1)]);}}async[_0x2c2ad8(0x204)](_0x240d18,_0x3bcb11){const _0x52b9e3=_0x2c2ad8,_0x5dcce2=await this['userEntity'][_0x52b9e3(0x116)]({'where':{'id':_0x3bcb11[_0x52b9e3(0xf3)]}});await this[_0x52b9e3(0x128)][_0x52b9e3(0xe3)]({'id':_0x5dcce2['id']},_0x52b9e3(0x17b),_0x3bcb11['score']),await this[_0x52b9e3(0x1d7)]['insertAccountLog']({'userId':_0x5dcce2['id'],'rawScore':_0x5dcce2[_0x52b9e3(0x17b)],'newScore':_0x5dcce2[_0x52b9e3(0x17b)]+_0x3bcb11[_0x52b9e3(0x17b)],'changeScore':_0x3bcb11[_0x52b9e3(0x17b)],'changeType':balance_constant_1[_0x52b9e3(0x15f)][_0x52b9e3(0xcf)],'rebateUserId':_0x240d18[_0x52b9e3(0x1bd)]['id'],'description':_0x52b9e3(0xc8)});}async[_0x2c2ad8(0x153)](_0x1b6c67,_0x1be260){const _0x151b30=_0x2c2ad8,_0x30cee2=await this[_0x151b30(0x128)]['findOne']({'where':{'id':_0x1be260[_0x151b30(0xf3)]}});return await this[_0x151b30(0x1d3)](_0x30cee2,balance_constant_1['EChangeType'][_0x151b30(0xcf)],_0x1be260[_0x151b30(0x13c)],_0x151b30(0xc8),_0x1b6c67[_0x151b30(0x1bd)]['id']),!![];}async[_0x2c2ad8(0x15c)](_0x22b146){const _0x4aded9=_0x2c2ad8,_0x2de724=await this[_0x4aded9(0xbb)]['findOne']({'where':{'username':_0x22b146[_0x4aded9(0x12e)]}});_0x2de724&&await this[_0x4aded9(0x166)][_0x4aded9(0x15d)](async()=>{const _0x491fb5=_0x4aded9;_0x2de724['vipDays']===-0x1?_0x22b146[_0x491fb5(0x12c)]=0x1:_0x22b146[_0x491fb5(0x19c)]=(0x0,date_1[_0x491fb5(0x1e8)])()[_0x491fb5(0x1d8)](_0x2de724[_0x491fb5(0xd8)],_0x491fb5(0x1e6))[_0x491fb5(0xf4)](),_0x22b146=await this[_0x491fb5(0x128)][_0x491fb5(0x177)](_0x22b146),await this['userInitVipEntity']['delete']({'id':_0x2de724['id']});});}async[_0x2c2ad8(0x165)](_0x4b6f77,_0x156db3){const _0x12a691=_0x2c2ad8,_0x3d8cbd=await this[_0x12a691(0x132)][_0x12a691(0x101)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x12a691(0x1bb),'registerRewards',_0x12a691(0xea),_0x12a691(0x14d),_0x12a691(0x152),_0x12a691(0x18c),_0x12a691(0x109)])}}),_0x167a57=_0x3d8cbd[_0x12a691(0xc0)]((_0x41cbe4,_0x31b446)=>{const _0x347618=_0x12a691,_0x2a36b3=Number(_0x31b446[_0x347618(0xcb)]),_0x39683d=Number['isInteger'](_0x2a36b3)&&_0x2a36b3>0x0?_0x2a36b3:0x0;return _0x41cbe4[_0x31b446['configKey']]=_0x39683d,_0x41cbe4;},{});_0x167a57[_0x12a691(0x1bb)]&&(await this[_0x12a691(0x128)]['update']({'id':_0x4b6f77['id']},{'score':_0x167a57[_0x12a691(0xde)]}),await this[_0x12a691(0x1d7)][_0x12a691(0xcd)]({'userId':_0x4b6f77['id'],'rawScore':0x0,'newScore':_0x167a57['registerRewards'],'changeScore':_0x167a57['registerRewards'],'changeType':balance_constant_1[_0x12a691(0x15f)]['Registe'],'description':'注册赠送'}));if(_0x156db3&&_0x167a57['inviteSendStatus']){_0x167a57[_0x12a691(0x14d)]&&(await this[_0x12a691(0x128)][_0x12a691(0xe3)]({'id':_0x156db3['id']},_0x12a691(0x17b),_0x167a57[_0x12a691(0x14d)]),await this[_0x12a691(0x1d7)][_0x12a691(0xcd)]({'userId':_0x156db3['id'],'rawScore':_0x156db3[_0x12a691(0x17b)],'newScore':_0x156db3['score']+_0x167a57[_0x12a691(0x14d)],'changeScore':_0x167a57[_0x12a691(0x14d)],'changeType':balance_constant_1['EChangeType'][_0x12a691(0x202)],'rebateUserId':_0x4b6f77['id'],'description':_0x12a691(0xd1)}));_0x167a57[_0x12a691(0x152)]&&await this[_0x12a691(0x1d3)](_0x156db3,balance_constant_1[_0x12a691(0x15f)][_0x12a691(0x202)],_0x167a57[_0x12a691(0x152)],_0x12a691(0xd1),_0x4b6f77['id']);const _0x5503ad=await this['userEntity']['findOne']({'where':{'id':_0x4b6f77['id']}});_0x167a57[_0x12a691(0x18c)]&&(await this[_0x12a691(0x128)][_0x12a691(0xe3)]({'id':_0x5503ad['id']},'score',_0x167a57[_0x12a691(0x18c)]),await this['userBalanceService'][_0x12a691(0xcd)]({'userId':_0x4b6f77['id'],'rawScore':_0x5503ad[_0x12a691(0x17b)],'newScore':_0x5503ad[_0x12a691(0x17b)]+_0x167a57[_0x12a691(0x18c)],'changeScore':_0x167a57[_0x12a691(0x18c)],'changeType':balance_constant_1['EChangeType'][_0x12a691(0xfd)],'rebateUserId':_0x156db3['id'],'description':_0x12a691(0x1e3)})),_0x167a57[_0x12a691(0x109)]&&await this[_0x12a691(0x1d3)](_0x5503ad,balance_constant_1['EChangeType'][_0x12a691(0xfd)],_0x167a57[_0x12a691(0x109)],_0x12a691(0x1e3),_0x156db3['id']);}}async[_0x2c2ad8(0x161)](_0x3ddebb,_0xf23e8a,_0x4502db,_0x976bdf,_0x2fbe96){const _0x9a1804=_0x2c2ad8;await this[_0x9a1804(0x128)][_0x9a1804(0x1f5)]({'id':_0x3ddebb['id']},{'score':_0x3ddebb['score']+_0x4502db}),await this[_0x9a1804(0x1d7)][_0x9a1804(0xcd)]({'userId':_0x3ddebb['id'],'rawScore':_0x3ddebb[_0x9a1804(0x17b)],'newScore':_0x3ddebb[_0x9a1804(0x17b)]+_0x4502db,'changeScore':_0x4502db,'changeType':_0xf23e8a,'relateId':_0x2fbe96?String(_0x2fbe96):null,'description':_0x976bdf});}async[_0x2c2ad8(0x1d3)](_0x18cb68,_0x4d569c,_0x243a27,_0x1986ad,_0xb07ea3){const _0x5efd2e=_0x2c2ad8;if(_0x18cb68[_0x5efd2e(0x12c)])return;_0x243a27===-0x1?await this['userEntity'][_0x5efd2e(0x1f5)]({'id':_0x18cb68['id']},{'lifetimeVip':0x1}):(_0x18cb68[_0x5efd2e(0x19c)]?_0x18cb68[_0x5efd2e(0x19c)]=(0x0,date_1[_0x5efd2e(0x1e8)])(_0x18cb68[_0x5efd2e(0x19c)])[_0x5efd2e(0x1d8)](_0x243a27,_0x5efd2e(0x1e6))[_0x5efd2e(0xf4)]():_0x18cb68[_0x5efd2e(0x19c)]=(0x0,date_1['default'])()[_0x5efd2e(0x1d8)](_0x243a27,_0x5efd2e(0x1e6))[_0x5efd2e(0xf4)](),await this[_0x5efd2e(0x128)][_0x5efd2e(0x1f5)]({'id':_0x18cb68['id']},{'vipExpire':_0x18cb68[_0x5efd2e(0x19c)]})),_0x18cb68=await this[_0x5efd2e(0x128)][_0x5efd2e(0x116)]({'where':{'id':_0x18cb68['id']}}),await this['userBalanceService'][_0x5efd2e(0x18f)]({'userId':_0x18cb68['id'],'vipDays':_0x243a27,'vipExpire':_0x18cb68[_0x5efd2e(0x19c)],'relateType':_0x4d569c,'relateId':_0xb07ea3?String(_0xb07ea3):'','description':_0x1986ad});}async[_0x2c2ad8(0x1b5)](_0x3e690a,_0x16c506){const _0x46448a=_0x2c2ad8;let _0x3d2b8f=!![];const _0x141121=await this[_0x46448a(0x136)](_0x3e690a);if(_0x141121[_0x46448a(0x12c)]||_0x141121[_0x46448a(0x19c)]){if(_0x16c506['vipFreeNum']<0x0)_0x3d2b8f=!![];else{if(_0x16c506['vipFreeNum']>0x0){const _0x43bc35=redisKey_constant_1['VIP_FREE']+'-'+_0x3e690a+'-'+_0x16c506['id'];let _0x3b4d2c=await this[_0x46448a(0x1fd)]['get']({'key':_0x43bc35});console[_0x46448a(0x155)](_0x3b4d2c);let _0x3e32a3=Number(_0x3b4d2c||0x0);_0x3e32a3<_0x16c506[_0x46448a(0x10f)]?_0x3d2b8f=!![]:_0x3d2b8f=_0x141121['score']>=_0x16c506[_0x46448a(0x108)];}else _0x3d2b8f=_0x141121[_0x46448a(0x17b)]>=_0x16c506[_0x46448a(0x108)];}}else _0x3d2b8f=_0x141121[_0x46448a(0x17b)]>=_0x16c506[_0x46448a(0x108)];if(!_0x3d2b8f)throw new common_1[(_0x46448a(0x14b))](_0x46448a(0x1ad),common_1[_0x46448a(0xbf)][_0x46448a(0x1c7)]);}async[_0x2c2ad8(0x1f2)](_0xbcdd20,_0x107961,_0x1a7b41){const _0x1b4d71=_0x2c2ad8,_0x117f8b=await this[_0x1b4d71(0x136)](_0xbcdd20);let _0x124511;switch(_0x107961['modelType']){case model_constant_1[_0x1b4d71(0xc5)][_0x1b4d71(0x138)]:_0x124511=balance_constant_1[_0x1b4d71(0x15f)][_0x1b4d71(0x138)];break;case model_constant_1[_0x1b4d71(0xc5)][_0x1b4d71(0x15b)]:_0x124511=balance_constant_1[_0x1b4d71(0x15f)][_0x1b4d71(0x1c5)];break;case model_constant_1[_0x1b4d71(0xc5)][_0x1b4d71(0x12a)]:_0x124511=balance_constant_1[_0x1b4d71(0x15f)][_0x1b4d71(0x1ac)];break;case model_constant_1[_0x1b4d71(0xc5)]['VIDEO']:_0x124511=balance_constant_1['EChangeType'][_0x1b4d71(0x157)];break;case model_constant_1[_0x1b4d71(0xc5)][_0x1b4d71(0x17f)]:_0x124511=balance_constant_1['EChangeType'][_0x1b4d71(0x114)];break;case model_constant_1[_0x1b4d71(0xc5)]['CHAT']:_0x124511=balance_constant_1[_0x1b4d71(0x15f)][_0x1b4d71(0x1b0)];break;case model_constant_1[_0x1b4d71(0xc5)]['OTHER']:_0x124511=balance_constant_1['EChangeType']['Tool'];break;default:_0x124511=balance_constant_1[_0x1b4d71(0x15f)]['Chat'];}if(_0x117f8b[_0x1b4d71(0x12c)]||_0x117f8b['vipExpire']){if(_0x107961['vipFreeNum']<0x0)await this[_0x1b4d71(0x161)](_0x117f8b,_0x124511,0x0,'模型【'+_0x107961[_0x1b4d71(0x16a)]+_0x1b4d71(0x1cd),_0x1a7b41);else{if(_0x107961[_0x1b4d71(0x10f)]>0x0){const _0x3bf774=redisKey_constant_1[_0x1b4d71(0xe0)]+'-'+_0xbcdd20+'-'+_0x107961['id'];let _0x5a8c73=await this['redisCacheService'][_0x1b4d71(0x17a)]({'key':_0x3bf774}),_0x176738=Number(_0x5a8c73||0x0);if(_0x176738<_0x107961['vipFreeNum']){const _0x3a5aa=(0x0,date_1[_0x1b4d71(0x1e8)])()['endOf']('d')['diff']((0x0,date_1[_0x1b4d71(0x1e8)])(),'s');await this[_0x1b4d71(0x1fd)][_0x1b4d71(0x123)]({'key':_0x3bf774,'val':_0x176738+0x1},_0x3a5aa),await this[_0x1b4d71(0x161)](_0x117f8b,_0x124511,0x0,'模型【'+_0x107961[_0x1b4d71(0x16a)]+_0x1b4d71(0x1c2),_0x1a7b41);}else await this['changeScore4Other'](_0x117f8b,_0x124511,-_0x107961['deduct'],_0x1b4d71(0x1b9)+_0x107961[_0x1b4d71(0x16a)]+_0x1b4d71(0x19a),_0x1a7b41);}else await this[_0x1b4d71(0x161)](_0x117f8b,_0x124511,-_0x107961['deduct'],'模型【'+_0x107961[_0x1b4d71(0x16a)]+_0x1b4d71(0x19a),_0x1a7b41);}}else await this[_0x1b4d71(0x161)](_0x117f8b,_0x124511,-_0x107961[_0x1b4d71(0x108)],_0x1b4d71(0x1b9)+_0x107961[_0x1b4d71(0x16a)]+'】使用扣减',_0x1a7b41);}async['refundBalance4Chat'](_0x118930,_0x2c14cf,_0x5b7d7b){const _0x4561f8=_0x2c2ad8,_0x3f7dfa=await this[_0x4561f8(0x136)](_0x118930);let _0x4b070f;switch(_0x2c14cf[_0x4561f8(0x1e2)]){case model_constant_1[_0x4561f8(0xc5)][_0x4561f8(0x15b)]:_0x4b070f=balance_constant_1[_0x4561f8(0x15f)][_0x4561f8(0x1c5)];break;case model_constant_1['EModelType']['MUSIC']:_0x4b070f=balance_constant_1['EChangeType'][_0x4561f8(0x1ac)];break;case model_constant_1[_0x4561f8(0xc5)]['DRAW']:_0x4b070f=balance_constant_1['EChangeType'][_0x4561f8(0x114)];break;case model_constant_1[_0x4561f8(0xc5)]['CHAT']:_0x4b070f=balance_constant_1['EChangeType']['Chat'];break;case model_constant_1['EModelType'][_0x4561f8(0xc1)]:_0x4b070f=balance_constant_1[_0x4561f8(0x15f)][_0x4561f8(0xf1)];break;default:_0x4b070f=balance_constant_1[_0x4561f8(0x15f)][_0x4561f8(0x1b0)];}await this['changeScore4Other'](_0x3f7dfa,_0x4b070f,_0x2c14cf[_0x4561f8(0x108)],'模型【'+_0x2c14cf[_0x4561f8(0x16a)]+_0x4561f8(0x117),_0x5b7d7b);}async[_0x2c2ad8(0x134)](_0x40ab57,_0x1c9925,_0xa050e3){const _0x11fca4=_0x2c2ad8;let _0x3e814e='',_0x435659='',_0x1518a7='',_0x22f45f=_0x1c9925;const _0x11381d=_0x1c9925[_0x11fca4(0x1da)](),_0x117724=new RegExp('imagine|variation|outpaint|pan|blend|inpaint|upsample|picreader|reroll'),_0x43cadb=new RegExp(_0x11fca4(0x16b)),_0x1c2f20=new RegExp(_0x11fca4(0xff));if(_0x40ab57===midjourney_constant_1[_0x11fca4(0x1f8)][_0x11fca4(0x12d)])_0x435659=_0x11fca4(0x15a),_0x3e814e=_0x11fca4(0x1bf),_0x1518a7='fast_vip_free';else{if(_0x40ab57===midjourney_constant_1[_0x11fca4(0x1f8)][_0x11fca4(0x1ce)])_0x435659=_0x11fca4(0xf8),_0x3e814e=_0x11fca4(0x1f9),_0x1518a7=_0x11fca4(0x1b7);else _0x40ab57===midjourney_constant_1[_0x11fca4(0x1f8)][_0x11fca4(0xd3)]&&(_0x435659=_0x11fca4(0x11e),_0x3e814e=_0x11fca4(0xd9),_0x1518a7='turbo_vip_free');}if(_0x117724[_0x11fca4(0x11d)](_0x11381d))_0x3e814e=_0x3e814e+0x1;else{if(_0x43cadb['test'](_0x11381d))_0x3e814e=_0x3e814e+0x2;else _0x1c2f20[_0x11fca4(0x11d)](_0x11381d)&&(_0x3e814e=_0x3e814e+0x3);}const _0x56b11e={},_0x378cd3=await this[_0x11fca4(0xc9)][_0x11fca4(0x1e7)]([_0x3e814e,_0x1518a7]);for(let _0x5bd8b0 in _0x378cd3){_0x56b11e[_0x5bd8b0]=Number(_0x378cd3[_0x5bd8b0])||0x0;}if(_0xa050e3[_0x11fca4(0x1ab)]){const _0x4f7817=await this[_0x11fca4(0xc9)][_0x11fca4(0x200)](_0xa050e3[_0x11fca4(0x1ab)],'mj');_0x4f7817&&(_0x56b11e[_0x1518a7]=_0x4f7817[_0x435659]||0x0);}for(let _0x517b0e in midjourney_constant_1[_0x11fca4(0x185)]){if(_0x11381d[_0x11fca4(0x1d2)](midjourney_constant_1[_0x11fca4(0x185)][_0x517b0e][_0x11fca4(0xe8)])){_0x22f45f=midjourney_constant_1[_0x11fca4(0x185)][_0x517b0e]['cn'];break;}}return{'price':_0x56b11e[_0x3e814e],'vipFreeNum':_0x56b11e[_0x1518a7],'vipFreeKey':_0x1518a7,'description':_0x22f45f};}async[_0x2c2ad8(0x149)](_0x2acf8d,_0x3aa138,_0xde3fec){const _0x2b378b=_0x2c2ad8;let _0x2778d8=!![];const _0x1afdd8=await this[_0x2b378b(0x136)](_0x2acf8d),_0x1b49f5=await this[_0x2b378b(0x134)](_0x3aa138,_0xde3fec,_0x1afdd8);if(_0x1afdd8[_0x2b378b(0x12c)]||_0x1afdd8[_0x2b378b(0x19c)]){if(_0x1b49f5['vipFreeNum']<0x0)_0x2778d8=!![];else{if(_0x1b49f5[_0x2b378b(0x10f)]>0x0){const _0x2a0a05=redisKey_constant_1['VIP_FREE']+'-'+_0x2acf8d+'-'+_0x1b49f5[_0x2b378b(0x180)];let _0x47ea18=await this[_0x2b378b(0x1fd)][_0x2b378b(0x17a)]({'key':_0x2a0a05}),_0x57f819=Number(_0x47ea18||0x0);_0x57f819<_0x1b49f5[_0x2b378b(0x10f)]?_0x2778d8=!![]:_0x2778d8=_0x1afdd8[_0x2b378b(0x17b)]>=_0x1b49f5[_0x2b378b(0x186)];}else _0x2778d8=_0x1afdd8[_0x2b378b(0x17b)]>=_0x1b49f5[_0x2b378b(0x186)];}}else _0x2778d8=_0x1afdd8[_0x2b378b(0x17b)]>=_0x1b49f5[_0x2b378b(0x186)];if(!_0x2778d8)throw new common_1[(_0x2b378b(0x14b))](_0x2b378b(0x1ad),common_1[_0x2b378b(0xbf)][_0x2b378b(0x1c7)]);}async[_0x2c2ad8(0x198)](_0x1d0843,_0x27d39a,_0x3a30cf,_0x133d3c){const _0x3f0998=_0x2c2ad8,_0x2e0a58=await this['getUserById'](_0x1d0843),_0x733ec5=await this['getMjPrice'](_0x27d39a,_0x3a30cf,_0x2e0a58),_0xb35a0f=balance_constant_1[_0x3f0998(0x15f)][_0x3f0998(0x191)];if(_0x2e0a58[_0x3f0998(0x12c)]||_0x2e0a58['vipExpire']){if(_0x733ec5[_0x3f0998(0x10f)]<0x0)await this[_0x3f0998(0x161)](_0x2e0a58,_0xb35a0f,0x0,'MJ绘画【'+_0x733ec5[_0x3f0998(0x14c)]+_0x3f0998(0x1cd),_0x133d3c);else{if(_0x733ec5[_0x3f0998(0x10f)]>0x0){const _0x1dd6f8=redisKey_constant_1[_0x3f0998(0xe0)]+'-'+_0x1d0843+'-'+_0x733ec5[_0x3f0998(0x180)];let _0x522fb7=await this[_0x3f0998(0x1fd)]['get']({'key':_0x1dd6f8}),_0x4bfe5f=Number(_0x522fb7||0x0);if(_0x4bfe5f<_0x733ec5[_0x3f0998(0x10f)]){const _0x5199eb=(0x0,date_1[_0x3f0998(0x1e8)])()[_0x3f0998(0x145)]('d')[_0x3f0998(0x127)]((0x0,date_1[_0x3f0998(0x1e8)])(),'s');await this['redisCacheService']['set']({'key':_0x1dd6f8,'val':_0x4bfe5f+0x1},_0x5199eb),await this[_0x3f0998(0x161)](_0x2e0a58,_0xb35a0f,0x0,_0x3f0998(0xf5)+_0x733ec5[_0x3f0998(0x14c)]+_0x3f0998(0x1c2),_0x133d3c);}else await this[_0x3f0998(0x161)](_0x2e0a58,_0xb35a0f,-_0x733ec5['price'],'MJ绘画【'+_0x733ec5[_0x3f0998(0x14c)]+'】使用扣减',_0x133d3c);}else await this[_0x3f0998(0x161)](_0x2e0a58,_0xb35a0f,-_0x733ec5[_0x3f0998(0x186)],'MJ绘画【'+_0x733ec5[_0x3f0998(0x14c)]+'】使用扣减',_0x133d3c);}}else await this[_0x3f0998(0x161)](_0x2e0a58,_0xb35a0f,-_0x733ec5[_0x3f0998(0x186)],_0x3f0998(0xf5)+_0x733ec5[_0x3f0998(0x14c)]+_0x3f0998(0x19a),_0x133d3c);}async[_0x2c2ad8(0x1d1)](_0x50d6b1,_0x583b6b,_0x18a1f0,_0x4ae400=![]){const _0xdf02d0=_0x2c2ad8,_0x846c1d={'structure':{'key':_0xdf02d0(0x199),'vlrk':'type1','desc':'标题大纲任务'},'cover':{'key':_0xdf02d0(0x199),'vlrk':_0xdf02d0(0x15a),'desc':_0xdf02d0(0x187)},'recover':{'key':_0xdf02d0(0x199),'vlrk':_0xdf02d0(0x15a),'desc':_0xdf02d0(0x1e4)},'create':{'key':'pptCreate','vlrk':_0xdf02d0(0xf8),'desc':'模板生成PPT'},'thesis':{'key':'pptThesis','vlrk':_0xdf02d0(0x11e),'desc':_0xdf02d0(0x188)},'file':{'key':_0xdf02d0(0x1ec),'vlrk':_0xdf02d0(0xf8),'desc':'文件生成PPT'},'theme':{'key':_0xdf02d0(0x1ec),'vlrk':_0xdf02d0(0xf8),'desc':_0xdf02d0(0xe6)},'addpage':{'key':_0xdf02d0(0x1ec),'vlrk':_0xdf02d0(0xf8),'desc':_0xdf02d0(0x1d0)},'addNotes':{'key':'pptCreate','vlrk':'type2','desc':_0xdf02d0(0x1db)}},_0x128aaf=_0x846c1d[_0x18a1f0][_0xdf02d0(0x121)],_0x1d81d2=_0x846c1d[_0x18a1f0][_0xdf02d0(0x1dd)]+_0xdf02d0(0x1d9),_0x4659f8=_0x846c1d[_0x18a1f0][_0xdf02d0(0x1dd)]+_0xdf02d0(0x1ae),_0x3dfee5={},_0x4514ea=await this[_0xdf02d0(0xc9)][_0xdf02d0(0x1e7)]([_0x1d81d2,_0x4659f8]);for(let _0x536638 in _0x4514ea){_0x3dfee5[_0x536638]=Number(_0x4514ea[_0x536638])||0x0;}const _0x1bbd0b=await this[_0xdf02d0(0x136)](_0x50d6b1);if(_0x1bbd0b[_0xdf02d0(0x1ab)]){const _0x39b950=await this[_0xdf02d0(0xc9)]['getVipLeavelRelById'](_0x1bbd0b[_0xdf02d0(0x1ab)],model_constant_1[_0xdf02d0(0xc5)]['PPT']);_0x39b950&&(_0x3dfee5[_0x4659f8]=_0x39b950[_0x846c1d[_0x18a1f0][_0xdf02d0(0xd2)]]||0x0);}if(_0x1bbd0b['lifetimeVip']||_0x1bbd0b['vipExpire']){if(_0x3dfee5[_0x4659f8]<0x0)await this[_0xdf02d0(0x161)](_0x1bbd0b,balance_constant_1['EChangeType'][_0xdf02d0(0x138)],0x0,'PPT【'+_0x128aaf+_0xdf02d0(0x1cd),_0x583b6b);else{if(_0x3dfee5[_0x4659f8]>0x0){const _0x4062fa=redisKey_constant_1['VIP_FREE']+'-'+_0x50d6b1+'-'+_0x4659f8;let _0x50bc50=await this[_0xdf02d0(0x1fd)]['get']({'key':_0x4062fa}),_0xbb7e9c=Number(_0x50bc50||0x0);if(_0xbb7e9c<_0x3dfee5[_0x4659f8]){const _0x312cc5=(0x0,date_1['default'])()[_0xdf02d0(0x145)]('d')['diff']((0x0,date_1['default'])(),'s');await this[_0xdf02d0(0x1fd)][_0xdf02d0(0x123)]({'key':_0x4062fa,'val':_0xbb7e9c+0x1},_0x312cc5),await this[_0xdf02d0(0x161)](_0x1bbd0b,balance_constant_1[_0xdf02d0(0x15f)][_0xdf02d0(0x138)],0x0,_0xdf02d0(0x19d)+_0x128aaf+_0xdf02d0(0x1c2),_0x583b6b);}else await this[_0xdf02d0(0x161)](_0x1bbd0b,balance_constant_1[_0xdf02d0(0x15f)]['PPT'],-_0x3dfee5[_0x1d81d2],_0xdf02d0(0x19d)+_0x128aaf+'】使用扣减',_0x583b6b);}else await this[_0xdf02d0(0x161)](_0x1bbd0b,balance_constant_1[_0xdf02d0(0x15f)][_0xdf02d0(0x138)],-_0x3dfee5[_0x1d81d2],_0xdf02d0(0x19d)+_0x128aaf+_0xdf02d0(0x19a),_0x583b6b);}}else await this[_0xdf02d0(0x161)](_0x1bbd0b,balance_constant_1[_0xdf02d0(0x15f)]['PPT'],-_0x3dfee5[_0x1d81d2],'PPT【'+_0x128aaf+_0xdf02d0(0x19a),_0x583b6b);}async['updateVipExpire2Redis'](){const _0x4e76b4=_0x2c2ad8,_0x243b72=await this[_0x4e76b4(0x128)]['find']({'where':{'vipExpire':(0x0,typeorm_2['Between'])((0x0,date_1['default'])()[_0x4e76b4(0x1f1)]('d')['toDate'](),(0x0,date_1['default'])()[_0x4e76b4(0x145)]('d')[_0x4e76b4(0xf4)]())}});if(_0x243b72['length'])for(let _0x290a28=0x0;_0x290a28<_0x243b72[_0x4e76b4(0x14e)];_0x290a28++){const _0x28b330=_0x243b72[_0x290a28];await this[_0x4e76b4(0x1fd)][_0x4e76b4(0x123)]({'key':redisKey_constant_1['VIP_EXPIRE']+_0x28b330['id'],'val':''},(0x0,date_1[_0x4e76b4(0x1e8)])()[_0x4e76b4(0x145)]('d')['diff']((0x0,date_1[_0x4e76b4(0x1e8)])(),'s'));}const _0x109320=await this[_0x4e76b4(0x128)][_0x4e76b4(0x101)]({'where':{'vipExpire':(0x0,typeorm_2[_0x4e76b4(0x1e9)])((0x0,date_1[_0x4e76b4(0x1e8)])()[_0x4e76b4(0xf4)]())}});if(_0x109320[_0x4e76b4(0x14e)]){const _0x570c24=_0x109320[_0x4e76b4(0x137)](_0x582a98=>_0x582a98['id']);await this[_0x4e76b4(0x128)][_0x4e76b4(0x1f5)]({'id':(0x0,typeorm_2['In'])(_0x570c24)},{'vipExpire':null});}}};UserService=__decorate([(0x0,common_1[_0x2c2ad8(0x175)])(),__param(0x0,(0x0,common_1[_0x2c2ad8(0x124)])(_0x2c2ad8(0x1b2))),__param(0x1,(0x0,typeorm_1[_0x2c2ad8(0x1d4)])(user_entity_1[_0x2c2ad8(0x184)])),__param(0x2,(0x0,typeorm_1[_0x2c2ad8(0x1d4)])(user_init_vip_entity_1[_0x2c2ad8(0xe7)])),__param(0x3,(0x0,typeorm_1[_0x2c2ad8(0x1d4)])(config_entity_1[_0x2c2ad8(0x147)])),__metadata(_0x2c2ad8(0x164),[Object,typeorm_2[_0x2c2ad8(0x18e)],typeorm_2[_0x2c2ad8(0x18e)],typeorm_2[_0x2c2ad8(0x18e)],mailer_1['MailerService'],redisCache_service_1['RedisCacheService'],userBalance_service_1['UserBalanceService'],globalConfig_service_1['GlobalConfigService'],verification_service_1[_0x2c2ad8(0xfe)],typeorm_2[_0x2c2ad8(0x1b8)]])],UserService),exports[_0x2c2ad8(0x1de)]=UserService;