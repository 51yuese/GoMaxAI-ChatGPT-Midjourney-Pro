'use strict';const _0x589cf8=_0x1557;(function(_0x191232,_0x54775f){const _0x5d2540=_0x1557,_0x350248=_0x191232();while(!![]){try{const _0x163b87=parseInt(_0x5d2540(0x1d5))/0x1+-parseInt(_0x5d2540(0x1bc))/0x2+parseInt(_0x5d2540(0x1f7))/0x3+parseInt(_0x5d2540(0x187))/0x4*(-parseInt(_0x5d2540(0x1b8))/0x5)+parseInt(_0x5d2540(0x1f9))/0x6+parseInt(_0x5d2540(0x219))/0x7*(-parseInt(_0x5d2540(0x1e1))/0x8)+parseInt(_0x5d2540(0x1d7))/0x9;if(_0x163b87===_0x54775f)break;else _0x350248['push'](_0x350248['shift']());}catch(_0x3a1f6c){_0x350248['push'](_0x350248['shift']());}}}(_0x5082,0x21ebb));function _0x1557(_0x3ce0b5,_0xd06f40){const _0x508224=_0x5082();return _0x1557=function(_0x15579d,_0xe06e38){_0x15579d=_0x15579d-0x180;let _0x11e5c7=_0x508224[_0x15579d];return _0x11e5c7;},_0x1557(_0x3ce0b5,_0xd06f40);}var __decorate=this&&this[_0x589cf8(0x1c2)]||function(_0x2f246e,_0x14efc4,_0x5483ff,_0x89ca0b){const _0x53d0e7=_0x589cf8;var _0x13f8a9=arguments['length'],_0x173873=_0x13f8a9<0x3?_0x14efc4:_0x89ca0b===null?_0x89ca0b=Object['getOwnPropertyDescriptor'](_0x14efc4,_0x5483ff):_0x89ca0b,_0x53caba;if(typeof Reflect==='object'&&typeof Reflect[_0x53d0e7(0x1c9)]===_0x53d0e7(0x1d8))_0x173873=Reflect[_0x53d0e7(0x1c9)](_0x2f246e,_0x14efc4,_0x5483ff,_0x89ca0b);else{for(var _0x3d5c75=_0x2f246e[_0x53d0e7(0x1a8)]-0x1;_0x3d5c75>=0x0;_0x3d5c75--)if(_0x53caba=_0x2f246e[_0x3d5c75])_0x173873=(_0x13f8a9<0x3?_0x53caba(_0x173873):_0x13f8a9>0x3?_0x53caba(_0x14efc4,_0x5483ff,_0x173873):_0x53caba(_0x14efc4,_0x5483ff))||_0x173873;}return _0x13f8a9>0x3&&_0x173873&&Object[_0x53d0e7(0x189)](_0x14efc4,_0x5483ff,_0x173873),_0x173873;},__metadata=this&&this[_0x589cf8(0x1c6)]||function(_0x1eff9d,_0x3b271d){const _0x2f5ed5=_0x589cf8;if(typeof Reflect==='object'&&typeof Reflect[_0x2f5ed5(0x19d)]===_0x2f5ed5(0x1d8))return Reflect[_0x2f5ed5(0x19d)](_0x1eff9d,_0x3b271d);},__param=this&&this[_0x589cf8(0x1d1)]||function(_0x1bc5ac,_0x4ddaf1){return function(_0x1fd7ea,_0x1ba2cd){_0x4ddaf1(_0x1fd7ea,_0x1ba2cd,_0x1bc5ac);};};Object[_0x589cf8(0x189)](exports,_0x589cf8(0x21e),{'value':!![]}),exports[_0x589cf8(0x21b)]=void 0x0;const common_1=require(_0x589cf8(0x1e2)),TENCENTCOS=require('cos-nodejs-sdk-v5'),ALIOSS=require(_0x589cf8(0x1db)),axios_1=require('axios'),image_size_1=require('image-size'),utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x589cf8(0x19e)),FormData=require(_0x589cf8(0x1e8)),midjourney_entity_1=require('../midjourney/midjourney.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x589cf8(0x1cc)),redisKey_constant_1=require(_0x589cf8(0x1e6)),redisCache_service_1=require(_0x589cf8(0x1ba)),store_1=require(_0x589cf8(0x196)),path_1=require(_0x589cf8(0x180)),promises_1=require('fs/promises'),fs_1=require('fs'),child_process_1=require(_0x589cf8(0x220)),uuid_1=require(_0x589cf8(0x1b5));let FileService=class FileService{constructor(_0x1bd671,_0x2085dd,_0x5a8bf6){const _0x5ab188=_0x589cf8;this[_0x5ab188(0x1b4)]=_0x1bd671,this[_0x5ab188(0x218)]=_0x2085dd,this['redisCacheService']=_0x5a8bf6;}async[_0x589cf8(0x193)](){const _0x3b88db=_0x589cf8,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x3b88db(0x218)][_0x3b88db(0x1a0)]([_0x3b88db(0x1ab),_0x3b88db(0x183),_0x3b88db(0x1fd)]);!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&common_1['Logger'][_0x3b88db(0x201)](_0x3b88db(0x1f3));if(Number(tencentCosStatus)===0x1){const {SecretId:_0x4dd9cb,SecretKey:_0x4d5eaa}=await this['getUploadConfig'](_0x3b88db(0x1c7));this[_0x3b88db(0x1fb)]=new TENCENTCOS({'SecretId':_0x4dd9cb,'SecretKey':_0x4d5eaa,'FileParallelLimit':0xa});}if(Number(aliOssStatus)===0x1){const {region:_0x332c25,bucket:_0x52b106,accessKeyId:_0x3aef94,accessKeySecret:_0x2a26b1}=await this[_0x3b88db(0x191)](_0x3b88db(0x1a6));this[_0x3b88db(0x20d)]=new ALIOSS({'region':(0x0,utils_1[_0x3b88db(0x1b1)])(_0x332c25),'accessKeyId':_0x3aef94,'accessKeySecret':_0x2a26b1,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x52b106)});}}async[_0x589cf8(0x191)](_0x4eba66){const _0x3b8ceb=_0x589cf8;if(_0x4eba66==='ali'){const {aliOssRegion:_0x430fdb,aliOssBucket:_0x18cd4d,aliOssAccessKeyId:_0x4c610e,aliOssAccessKeySecret:_0x3cb4aa}=await this[_0x3b8ceb(0x218)][_0x3b8ceb(0x1a0)]([_0x3b8ceb(0x1aa),_0x3b8ceb(0x1ca),_0x3b8ceb(0x1a5),_0x3b8ceb(0x1e9)]);return{'region':_0x430fdb,'bucket':_0x18cd4d,'accessKeyId':_0x4c610e,'accessKeySecret':_0x3cb4aa};}if(_0x4eba66==='tencent'){const {cosBucket:_0x394343,cosRegion:_0x55531d,cosSecretId:_0x330eb0,cosSecretKey:_0x2eb7b6,tencentCosAcceleratedDomain:_0x8d3d53}=await this[_0x3b8ceb(0x218)][_0x3b8ceb(0x1a0)]([_0x3b8ceb(0x18b),_0x3b8ceb(0x186),'cosSecretId','cosSecretKey','tencentCosAcceleratedDomain']);return{'Bucket':_0x394343,'Region':_0x55531d,'SecretId':_0x330eb0,'SecretKey':_0x2eb7b6,'acceleratedDomain':_0x8d3d53};}if(_0x4eba66===_0x3b8ceb(0x216)){const {cheveretoKey:_0x2bdec7,cheveretoUploadPath:_0x52ec32}=await this[_0x3b8ceb(0x218)][_0x3b8ceb(0x1a0)]([_0x3b8ceb(0x1b9),_0x3b8ceb(0x223)]);return{'key':_0x2bdec7,'uploadPath':_0x52ec32};}}async[_0x589cf8(0x1b3)](_0xab279c){const _0x108020=_0x589cf8,{filename:_0x230c44,buffer:_0x4509a5,returnDuration:_0x4154c5}=_0xab279c;if(_0x230c44['endsWith']('m4a'))return this[_0x108020(0x18a)](_0x4509a5);const _0x4e3a69=await this[_0x108020(0x213)](_0xab279c);if(_0x4154c5){const _0x355f7f=await this['getAudioDurationByFFmpeg'](_0x4e3a69);return{'url':_0x4e3a69,'duration':_0x355f7f};}return _0x4e3a69;}async[_0x589cf8(0x213)](_0x43b321){const _0x462e25=_0x589cf8,{filename:_0x1327ca,buffer:_0x2e9c07,dir:dir='ai'}=_0x43b321,{aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this[_0x462e25(0x218)]['getConfigByKeys']([_0x462e25(0x1ab),_0x462e25(0x183),_0x462e25(0x1fd)]);if(Number(tencentCosStatus)===0x1)return this['uploadFileByTencentCos']({'filename':_0x1327ca,'buffer':_0x2e9c07,'dir':dir});if(Number(aliOssStatus)===0x1)return this[_0x462e25(0x18f)]({'filename':_0x1327ca,'buffer':_0x2e9c07,'dir':dir});if(Number(cheveretoStatus)){const {filename:_0x59911b,buffer:_0x44fb2e,dir:_0x1fbcf9}=_0x43b321;return this[_0x462e25(0x227)]({'filename':_0x59911b,'buffer':_0x44fb2e[_0x462e25(0x197)](_0x462e25(0x19b)),'dir':_0x1fbcf9});}const [_0x4f4ad1,_0x15e8d7]=await this['uploadFileByLocal']({'filename':_0x1327ca,'buffer':_0x2e9c07,'dir':dir});return _0x4f4ad1;}async[_0x589cf8(0x203)](_0x3ed8aa){const _0xe168ba=_0x589cf8,{filename:_0x2bbbee,buffer:_0x5bed86,dir:dir='ai'}=_0x3ed8aa,[_0x4b7af9,_0x4c84e3]=await this['uploadFileByLocal']({'filename':_0x2bbbee,'buffer':_0x5bed86,'dir':dir});return _0x4b7af9+_0xe168ba(0x19a);}async[_0x589cf8(0x1d3)]({filename:_0x24a9c3,buffer:_0x207aa1,dir:_0x14ec9d}){const _0x2fe2f1=_0x589cf8;try{const {Bucket:_0xa97a63,Region:_0x41242f,SecretId:_0x277a63,SecretKey:_0x41f878}=await this[_0x2fe2f1(0x191)]('tencent');!this[_0x2fe2f1(0x1fb)]&&(this['tencentCos']=new TENCENTCOS({'SecretId':_0x277a63,'SecretKey':_0x41f878,'FileParallelLimit':0xa}));const _0x3e361b=await this[_0x2fe2f1(0x1fb)][_0x2fe2f1(0x1c0)]({'Bucket':(0x0,utils_1[_0x2fe2f1(0x1b1)])(_0xa97a63),'Region':(0x0,utils_1[_0x2fe2f1(0x1b1)])(_0x41242f),'Key':_0x14ec9d+'/'+(_0x24a9c3||(0x0,utils_1[_0x2fe2f1(0x1cf)])()+_0x2fe2f1(0x1b6)),'StorageClass':_0x2fe2f1(0x1f6),'Body':_0x207aa1});let _0x1ee3ef=_0x3e361b[_0x2fe2f1(0x1d0)][_0x2fe2f1(0x207)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x2fe2f1(0x19c));const {acceleratedDomain:_0x5c3864}=await this[_0x2fe2f1(0x191)](_0x2fe2f1(0x1c7));return _0x5c3864&&(_0x1ee3ef=_0x1ee3ef['replace'](/^(https:\/\/[^/]+)(\/.*)$/,'https://'+_0x5c3864+'$2'),console[_0x2fe2f1(0x1ea)](_0x2fe2f1(0x1da),_0x1ee3ef)),_0x1ee3ef;}catch(_0x39496a){console[_0x2fe2f1(0x1ea)](_0x2fe2f1(0x21f),_0x39496a);throw new common_1[(_0x2fe2f1(0x1f0))]('上传图片失败[ten]',common_1[_0x2fe2f1(0x1ac)][_0x2fe2f1(0x208)]);}}async[_0x589cf8(0x18f)]({filename:_0x3a9e94,buffer:_0x46456c,dir:_0xf7025}){const _0xc316db=_0x589cf8;if(!this[_0xc316db(0x20d)]){const {region:_0x8b146a,bucket:_0x1d84ba,accessKeyId:_0x4c8819,accessKeySecret:_0x1a3570}=await this[_0xc316db(0x191)](_0xc316db(0x1a6));this['aliCos']=new ALIOSS({'region':(0x0,utils_1[_0xc316db(0x1b1)])(_0x8b146a),'accessKeyId':_0x4c8819,'accessKeySecret':_0x1a3570,'bucket':(0x0,utils_1[_0xc316db(0x1b1)])(_0x1d84ba)});}try{console['log'](_0xc316db(0x1bf));const _0x8f94ef=await this[_0xc316db(0x20d)]['put'](_0xf7025+'/'+(_0x3a9e94||(0x0,utils_1[_0xc316db(0x1cf)])()+_0xc316db(0x1b6)),_0x46456c);return _0x8f94ef['url'];}catch(_0x19d602){throw new common_1[(_0xc316db(0x1f0))](_0xc316db(0x215),common_1[_0xc316db(0x1ac)]['BAD_REQUEST']);}}async[_0x589cf8(0x227)]({filename:filename='',buffer:_0x97e3b,dir:dir='ai'}){const _0x254a84=_0x589cf8,{key:_0x51597b,uploadPath:_0x5b8a05}=await this['getUploadConfig'](_0x254a84(0x216)),_0x12277f=new FormData();_0x12277f['append'](_0x254a84(0x224),_0x97e3b[_0x254a84(0x197)](_0x254a84(0x19b))),_0x12277f[_0x254a84(0x1fa)](_0x254a84(0x1e3),_0x51597b);try{const _0x4c7b79=await axios_1[_0x254a84(0x1ec)][_0x254a84(0x1c8)](_0x5b8a05,_0x12277f,{'headers':{'X-API-Key':_0x51597b},'timeout':0xa*0x3c*0x3e8});if(_0x4c7b79?.[_0x254a84(0x1c5)]===0xc8)return _0x4c7b79[_0x254a84(0x1e5)][_0x254a84(0x1d4)]['url'];else{common_1['Logger'][_0x254a84(0x201)]('上传图片失败[Chevereto]',JSON[_0x254a84(0x205)](_0x4c7b79['data']));throw new Error('上传图片失败[Chevereto]');}}catch(_0x5df239){console[_0x254a84(0x1ea)](_0x254a84(0x21f),_0x5df239['response']);throw new common_1[(_0x254a84(0x1f0))](_0x254a84(0x1ad)+_0x5df239[_0x254a84(0x222)]?.['data'][_0x254a84(0x201)]['message'],common_1[_0x254a84(0x1ac)][_0x254a84(0x208)]);}}async['uploadFileByLocal']({filename:_0x10a27b,buffer:_0x3904b2,dir:_0x3f4cd1}){const _0x4053cd=_0x589cf8;let _0x54db0b=(0x0,path_1['join'])(process['cwd'](),_0x4053cd(0x1ae),_0x4053cd(0x20c)),_0x372ed1='/upload',_0x5b2291='';_0x3f4cd1&&(_0x54db0b=(0x0,path_1[_0x4053cd(0x1c4)])(_0x54db0b,_0x3f4cd1),_0x372ed1='/upload/'+_0x3f4cd1);_0x372ed1=_0x372ed1+'/'+_0x10a27b;!(0x0,fs_1[_0x4053cd(0x1a3)])(_0x54db0b)&&(0x0,fs_1[_0x4053cd(0x1dc)])(_0x54db0b,{'recursive':!![]});_0x54db0b=(0x0,path_1['join'])(_0x54db0b,_0x10a27b),await(0x0,promises_1['writeFile'])(_0x54db0b,_0x3904b2);let _0x25f910=process[_0x4053cd(0x18d)][_0x4053cd(0x214)];return _0x25f910['startsWith']('http')?_0x5b2291=_0x25f910+_0x372ed1:_0x5b2291=_0x4053cd(0x1af)+_0x25f910+_0x372ed1,[_0x5b2291,_0x54db0b];}async[_0x589cf8(0x1a7)](_0x27275f,_0x2e9890,_0x52beb1){const _0x1ee7c7=_0x589cf8;try{const _0x31f964=_0x27275f[_0x1ee7c7(0x1e4)]('/')[_0x1ee7c7(0x1f5)](),_0x36fd3e=await(0x0,axios_1[_0x1ee7c7(0x1ec)])(_0x27275f,{'headers':{'Content-Type':_0x1ee7c7(0x1df)},'responseType':_0x1ee7c7(0x217),'timeout':0x493e0});_0x52beb1[_0x1ee7c7(0x195)](0xc8,{'Content-Type':_0x36fd3e['headers'][_0x1ee7c7(0x194)],'Content-Disposition':_0x31f964}),_0x52beb1[_0x1ee7c7(0x221)](_0x36fd3e[_0x1ee7c7(0x1e5)],'binary');}catch(_0x25bdfa){throw new common_1['HttpException'](_0x25bdfa[_0x1ee7c7(0x209)],common_1[_0x1ee7c7(0x1ac)][_0x1ee7c7(0x208)]);}}async[_0x589cf8(0x1b2)](_0x30a572){const _0x4a2c9a=_0x589cf8;try{const _0xc75087=await this[_0x4a2c9a(0x1b4)][_0x4a2c9a(0x1a1)]({'where':{'id':Number(_0x30a572[_0x4a2c9a(0x18e)][_0x4a2c9a(0x188)])}});let _0x39097e;if(_0xc75087[_0x4a2c9a(0x1fc)])_0x39097e=_0xc75087[_0x4a2c9a(0x1fc)];else{const _0x2cb8c6=await this[_0x4a2c9a(0x1b4)][_0x4a2c9a(0x1a1)]({'where':{'id':Number(_0xc75087[_0x4a2c9a(0x1fe)])}});_0x39097e=_0x2cb8c6[_0x4a2c9a(0x1fc)];}if(!_0x39097e)throw new Error(_0x4a2c9a(0x185));const _0x4f11ce=await axios_1[_0x4a2c9a(0x1ec)][_0x4a2c9a(0x1ce)](_0x39097e,{'responseType':'arraybuffer'}),_0x2b8cd4=Buffer[_0x4a2c9a(0x21d)](_0x4f11ce[_0x4a2c9a(0x1e5)])[_0x4a2c9a(0x197)](_0x4a2c9a(0x19b));return _0x4a2c9a(0x21a)+_0x2b8cd4;}catch(_0x5cf808){throw new common_1[(_0x4a2c9a(0x1f0))](_0x5cf808['message'],common_1[_0x4a2c9a(0x1ac)][_0x4a2c9a(0x208)]);}}async[_0x589cf8(0x1f8)](_0x1d932e){const _0x5ec71c=_0x589cf8;try{const _0x531752=await axios_1[_0x5ec71c(0x1ec)][_0x5ec71c(0x1ce)](_0x1d932e,{'responseType':_0x5ec71c(0x217)}),_0x3c4b73=_0x1d932e[_0x5ec71c(0x1e4)]('/')[_0x5ec71c(0x1f5)]()[_0x5ec71c(0x1e4)]('?')[0x0],_0x2a3ef0=await this[_0x5ec71c(0x1b3)]({'filename':_0x3c4b73,'buffer':_0x531752[_0x5ec71c(0x1e5)]});return _0x2a3ef0;}catch(_0xd89f9a){return common_1[_0x5ec71c(0x1bb)][_0x5ec71c(0x201)](_0x5ec71c(0x20a),_0xd89f9a),null;}}async[_0x589cf8(0x20e)](_0x5b4d5c){return new Promise((_0x13f809,_0x2c431b)=>{const _0x425edf=_0x1557,_0x3679cf=_0x5b4d5c[_0x425edf(0x207)]('.mp4','.jpg');(0x0,child_process_1[_0x425edf(0x1dd)])(_0x425edf(0x212)+_0x5b4d5c+'\x20-y\x20-f\x20image2\x20-ss\x202\x20-frames:v\x201\x20-update\x20true\x20'+_0x3679cf+_0x425edf(0x198),function(_0x1844ea,_0x25b120,_0xbf8435){const _0x3fb961=_0x425edf;_0x1844ea?(console[_0x3fb961(0x1ea)](_0xbf8435),_0x2c431b(_0x1844ea)):_0x13f809(_0x3679cf);});});}async[_0x589cf8(0x18c)](_0x32c95a){return new Promise((_0x141088,_0x4f9f51)=>{const _0x2124d5=_0x1557,_0x6cd658=_0x32c95a[_0x2124d5(0x207)](_0x2124d5(0x192),_0x2124d5(0x1d9));(0x0,child_process_1['exec'])(_0x2124d5(0x1bd)+_0x32c95a+_0x2124d5(0x1e0)+_0x6cd658,function(_0x47be4e,_0x17125e,_0x451ab8){const _0x824e1a=_0x2124d5;_0x47be4e?(console[_0x824e1a(0x1ea)]('------------转换失败Mp3--------',_0x451ab8),_0x4f9f51(_0x47be4e)):(console[_0x824e1a(0x1ea)](_0x824e1a(0x211),_0x6cd658),_0x141088(_0x6cd658));});});}async['getAudioDurationByFFmpeg'](_0x458e3f){return new Promise((_0x315a93,_0x41c208)=>{const _0x49bb7e=_0x1557;(0x0,child_process_1[_0x49bb7e(0x1dd)])(_0x49bb7e(0x206)+_0x458e3f+'\x22',function(_0x55b26c,_0x920bc4,_0x1b01c4){const _0x3b1ab2=_0x49bb7e;if(_0x55b26c)console[_0x3b1ab2(0x1ea)](_0x3b1ab2(0x1de),_0x1b01c4),(0x0,child_process_1[_0x3b1ab2(0x1dd)])(_0x3b1ab2(0x1c1)+_0x458e3f+_0x3b1ab2(0x181),function(_0x1e8a6c,_0x1b78ed,_0x397e42){const _0x4c01b7=_0x3b1ab2;if(_0x1e8a6c)console[_0x4c01b7(0x1ea)](_0x4c01b7(0x1a2),_0x397e42),_0x41c208(_0x1e8a6c);else{const _0x33bb7e=_0x397e42['match'](/time=(\d+\.\d+)/);if(!_0x33bb7e)_0x41c208(_0x4c01b7(0x1b0));else{const _0x1de42c=parseFloat(_0x33bb7e[0x1]);console[_0x4c01b7(0x1ea)]('-------------------获取音频时长（备用方法）-----------------',_0x1de42c),_0x315a93(_0x1de42c);}}});else{const _0x29bc49=parseFloat(_0x920bc4[_0x3b1ab2(0x1ee)]());isNaN(_0x29bc49)?_0x41c208(_0x3b1ab2(0x1f4)):(console[_0x3b1ab2(0x1ea)](_0x3b1ab2(0x1b7),_0x29bc49),_0x315a93(_0x29bc49));}});});}async[_0x589cf8(0x1ed)](_0x38b5ce){return new Promise((_0x4759ce,_0x187e1b)=>{const _0xa22d4=_0x1557;(0x0,child_process_1[_0xa22d4(0x1dd)])(_0xa22d4(0x1bd)+_0x38b5ce+_0xa22d4(0x1cb),function(_0x255825,_0x5eac94,_0x4356f4){const _0x5deae5=_0xa22d4;if(_0x255825)console[_0x5deae5(0x1ea)](_0x5deae5(0x1cd),_0x4356f4),_0x187e1b(_0x255825);else{const _0x92cdd6=_0x4356f4[_0x5deae5(0x19f)](/Duration: (\d+:\d+:\d+\.\d+)/);if(!_0x92cdd6)_0x187e1b(_0x5deae5(0x1b0));else{const _0x29cc21=_0x92cdd6[0x1]['split'](':'),_0x302db4=parseInt(_0x29cc21[0x0],0xa),_0x2c2cf0=parseInt(_0x29cc21[0x1],0xa),_0x698983=parseFloat(_0x29cc21[0x2]);console[_0x5deae5(0x1ea)](_0x5deae5(0x225),_0x302db4*0xe10+_0x2c2cf0*0x3c+_0x698983),_0x4759ce(_0x302db4*0xe10+_0x2c2cf0*0x3c+_0x698983);}}});});}async['transferM4a'](_0x149701){const _0x24f038=_0x589cf8;let _0xa9bedb=null;try{let _0x1859b5=(0x0,uuid_1['v4'])(),_0xc57da8=_0x1859b5[_0x24f038(0x207)](/-/g,'')+_0x24f038(0x192);const [_0xe8a67b,_0xa88ccf]=await this['uploadFileByLocal']({'filename':_0xc57da8,'buffer':_0x149701,'dir':_0x24f038(0x184)}),_0x4b8abb=await this[_0x24f038(0x18c)](_0xa88ccf);let {aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this['globalConfigService'][_0x24f038(0x1a0)]([_0x24f038(0x1ab),'aliOssStatus','cheveretoStatus']);aliOssStatus=Number(aliOssStatus),cheveretoStatus=Number(cheveretoStatus),tencentCosStatus=Number(tencentCosStatus);if(aliOssStatus||cheveretoStatus||tencentCosStatus){console[_0x24f038(0x1ea)](_0x24f038(0x1d6));const _0x454517=(0x0,fs_1[_0x24f038(0x226)])(_0x4b8abb);_0xa9bedb=await this[_0x24f038(0x213)]({'filename':_0xc57da8['replace'](/m4a$/,'mp3'),'buffer':_0x454517}),(0x0,fs_1['rmSync'])(_0xa88ccf),(0x0,fs_1[_0x24f038(0x1ef)])(_0x4b8abb);}else _0xa9bedb=_0xe8a67b['replace'](_0x24f038(0x192),_0x24f038(0x1d9));return _0xa9bedb;}catch(_0x13da08){return console['log']('-----------------------transferM4a-----------------',_0x13da08),common_1['Logger'][_0x24f038(0x201)](_0x24f038(0x1c3),_0x13da08),'';}}async[_0x589cf8(0x1eb)](_0x252c5b){const _0x3a1cc1=_0x589cf8;let _0x5a070d=null,_0x2b6cac=null;try{const _0x2af562=await axios_1['default'][_0x3a1cc1(0x1ce)](_0x252c5b,{'responseType':_0x3a1cc1(0x217)});let _0x298173=(0x0,uuid_1['v4'])(),_0x22be75=_0x298173['replace'](/-/g,'')+_0x3a1cc1(0x199);const [_0x468329,_0x41395d]=await this[_0x3a1cc1(0x1d2)]({'filename':_0x22be75,'buffer':_0x2af562[_0x3a1cc1(0x1e5)],'dir':'ai'}),_0x156076=await this[_0x3a1cc1(0x20e)](_0x41395d);let {aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this['globalConfigService'][_0x3a1cc1(0x1a0)](['tencentCosStatus',_0x3a1cc1(0x183),_0x3a1cc1(0x1fd)]);aliOssStatus=Number(aliOssStatus),cheveretoStatus=Number(cheveretoStatus),tencentCosStatus=Number(tencentCosStatus);if(aliOssStatus||cheveretoStatus||tencentCosStatus){console[_0x3a1cc1(0x1ea)](_0x3a1cc1(0x1d6)),_0x5a070d=await this[_0x3a1cc1(0x1b3)]({'filename':_0x22be75,'buffer':_0x2af562['data']});const _0x2c3058=(0x0,fs_1[_0x3a1cc1(0x226)])(_0x156076);_0x2b6cac=await this[_0x3a1cc1(0x1b3)]({'filename':_0x22be75[_0x3a1cc1(0x207)](/mp4$/,'jpg'),'buffer':_0x2c3058}),(0x0,fs_1['rmSync'])(_0x41395d),(0x0,fs_1[_0x3a1cc1(0x1ef)])(_0x156076);}else _0x5a070d=_0x468329,_0x2b6cac=_0x468329[_0x3a1cc1(0x207)](_0x3a1cc1(0x199),_0x3a1cc1(0x1be));return[_0x5a070d,_0x2b6cac];}catch(_0x313176){return console['log'](_0x3a1cc1(0x20f),_0x313176),common_1[_0x3a1cc1(0x1bb)][_0x3a1cc1(0x201)](_0x3a1cc1(0x1c3),_0x313176),[null,null];}}async[_0x589cf8(0x20b)](_0xda4b3d,_0x1961ff){const _0x1e17d3=_0x589cf8,_0x52310f=redisKey_constant_1[_0x1e17d3(0x1a9)]+_0xda4b3d;try{const _0x4c8deb=await this[_0x1e17d3(0x202)]['get']({'key':_0x52310f});if(_0x4c8deb)return;this[_0x1e17d3(0x202)][_0x1e17d3(0x190)]({'key':_0x52310f,'val':_0x1e17d3(0x21c)});const _0x5d1d80=await axios_1[_0x1e17d3(0x1ec)][_0x1e17d3(0x1ce)](_0x1961ff,{'responseType':_0x1e17d3(0x217)}),{width:_0x19530a,height:_0x30cf68}=await(0x0,image_size_1[_0x1e17d3(0x1ec)])(_0x5d1d80[_0x1e17d3(0x1e5)]);!store_1[_0x1e17d3(0x1ff)][_0x1e17d3(0x1e7)]&&(_0x1961ff=await this[_0x1e17d3(0x1b3)]({'filename':'mj-'+_0xda4b3d+'.png','buffer':_0x5d1d80[_0x1e17d3(0x1e5)]})),await this[_0x1e17d3(0x1b4)][_0x1e17d3(0x1f1)]({'id':_0xda4b3d,'imageUrl':_0x1961ff,'fileInfo':JSON[_0x1e17d3(0x205)]({'width':_0x19530a,'height':_0x30cf68})});}catch(_0x1c82fe){common_1['Logger'][_0x1e17d3(0x201)](_0x52310f,'：',_0x1c82fe);}finally{this[_0x1e17d3(0x202)][_0x1e17d3(0x182)]({'key':_0x52310f});}}};FileService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x589cf8(0x1a4)])(midjourney_entity_1[_0x589cf8(0x204)])),__metadata(_0x589cf8(0x228),[typeorm_2[_0x589cf8(0x210)],globalConfig_service_1[_0x589cf8(0x1f2)],redisCache_service_1[_0x589cf8(0x200)]])],FileService),exports[_0x589cf8(0x21b)]=FileService;function _0x5082(){const _0x5973f1=['2486691tRCxQf','function','.mp3','当前已开启全球加速----------------->','ali-oss','mkdirSync','exec','----------------获取音频时长失败--------------','application/json;charset=UTF-8','\x20-acodec\x20libmp3lame\x20-q:a\x202\x20','8ykNWNy','@nestjs/common','key','split','data','../../common/constants/redisKey.constant','mjNotSaveImg','form-data','aliOssAccessKeySecret','log','transferAndCover','default','getVideoDurationByFFmpeg','trim','rmSync','HttpException','save','GlobalConfigService','请先前往后台配置上传图片的方式','无法解析音频时长','pop','STANDARD','152676LskIuu','transferFile','1161174HCUVma','append','tencentCos','imageUrl','cheveretoStatus','originTaskId','MjConfig','RedisCacheService','error','redisCacheService','upload2Local','MidjourneyEntity','stringify','ffprobe\x20-v\x20error\x20-show_entries\x20format=duration\x20-of\x20default=noprint_wrappers=1:nokey=1\x20\x22','replace','BAD_REQUEST','message','transferFile\x20error:\x20','transferImg','upload','aliCos','getCover','-----------------------ERRROR______________________________','Repository','---------------转换成功Mp3-------------','\x0a\x20\x20\x20\x20\x20\x20\x20\x20ffmpeg\x20-i\x20','uploadFileBase','GOMAXAI_HOST','上传图片失败[ali]','chevereto','arraybuffer','globalConfigService','262486GvtymQ','data:image/jpeg;base64,','FileService','lock','from','__esModule','error:\x20','child_process','end','response','cheveretoUploadPath','source','-------------------获取视频时长-----------------','readFileSync','uploadFileByChevereto','design:paramtypes','path','\x22\x20-f\x20null\x20-t\x200.1\x20-','del','aliOssStatus','human','任务原始图片获取失败','cosRegion','57336RBRWeJ','taskId','defineProperty','transferM4a','cosBucket','convertM4aToMp3','env','query','uploadFileByAliOss','set','getUploadConfig','.m4a','onModuleInit','content-type','writeHead','../../common/store','toString','\x0a\x20\x20\x20\x20\x20\x20','.mp4','?from=local','base64','https://$2','metadata','../globalConfig/globalConfig.service','match','getConfigByKeys','findOne','----------------备用方法获取音频时长失败--------------','existsSync','InjectRepository','aliOssAccessKeyId','ali','downFile','length','MJ_IMG_TRANSFER','aliOssRegion','tencentCosStatus','HttpStatus','上传图片失败[Chevereto|buffer]\x20-->\x20','webroot','https://','无法从输出中提取时长信息','removeSpecialCharacters','getModalImgById','uploadFile','midjourneyEntity','uuid','.png','-------------------获取音频时长-----------------','95HlawEK','cheveretoKey','../redisCache/redisCache.service','Logger','507214BsoKSa','ffmpeg\x20-i\x20','.jpg','ali\x20开始上传','putObject','ffmpeg\x20-i\x20\x22','__decorate','transferAndCover\x20error:\x20','join','status','__metadata','tencent','post','decorate','aliOssBucket','\x20-ss\x20999999\x20-vframes\x201\x20-f\x20null\x20-','typeorm','----------------获取视频时长失败--------------','get','createRandomUid','Location','__param','uploadFileByLocal','uploadFileByTencentCos','image','181670EhmWsC','需要转存到云'];_0x5082=function(){return _0x5973f1;};return _0x5082();}