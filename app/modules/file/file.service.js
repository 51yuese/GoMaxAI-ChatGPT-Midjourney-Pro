'use strict';const _0x4759cc=_0x3788;(function(_0xbd4a4,_0x16f645){const _0x564389=_0x3788,_0x58cfe3=_0xbd4a4();while(!![]){try{const _0x5c21a6=-parseInt(_0x564389(0x1b7))/0x1+parseInt(_0x564389(0x1a9))/0x2+-parseInt(_0x564389(0x193))/0x3+parseInt(_0x564389(0x134))/0x4+-parseInt(_0x564389(0x148))/0x5*(parseInt(_0x564389(0x152))/0x6)+-parseInt(_0x564389(0x13b))/0x7+parseInt(_0x564389(0x14f))/0x8;if(_0x5c21a6===_0x16f645)break;else _0x58cfe3['push'](_0x58cfe3['shift']());}catch(_0x4196f1){_0x58cfe3['push'](_0x58cfe3['shift']());}}}(_0x4e9d,0xc72ad));function _0x4e9d(){const _0x2476ca=['data','6760621WAOjNN','\x20-acodec\x20libmp3lame\x20-q:a\x202\x20','STANDARD','FileService','url','__decorate','getCover','upload2Local','请先前往后台配置上传图片的方式','mjNotSaveImg','uploadFile','existsSync','content-type','80255PknNFr','@nestjs/typeorm','getConfigByKeys','任务原始图片获取失败','from','default','message','40524016ZLoMGc','findOne','upload','348tWtNIX','rmSync','taskId','cosSecretKey','error:\x20','无法解析音频时长','uploadFileByAliOss','\x20-ss\x20999999\x20-vframes\x201\x20-f\x20null\x20-','.png','https://$2','object','removeSpecialCharacters','webroot','source','../../common/store','__metadata','readFileSync','application/json;charset=UTF-8','transferFile','exec','mj-','cheveretoUploadPath','Location','/upload','toString','chevereto','path','put','cosBucket','HttpException','HttpStatus','tencentCosAcceleratedDomain','defineProperty','---------------转换成功Mp3-------------','cosRegion','response','fs/promises','decorate','\x0a\x20\x20\x20\x20\x20\x20','metadata','cwd','base64','log','getVideoDurationByFFmpeg','http','map','无法从输出中提取时长信息','trim','../midjourney/midjourney.entity','match','__param','-------------------获取视频时长-----------------','ali\x20开始上传','tencentCosStatus','split','image','uuid','\x20-y\x20-f\x20image2\x20-ss\x202\x20-frames:v\x201\x20-update\x20true\x20','function','ffmpeg\x20-i\x20\x22','image-size','globalConfigService','set','get','transferAndCover\x20error:\x20','3909954QmFWjc','originTaskId','length','.mp3','BAD_REQUEST','join','上传图片失败[Chevereto|buffer]\x20-->\x20','-----------------------------------UploadUrlError----------','----------------获取视频时长失败--------------','cheveretoKey','createRandomUid','imageUrl','ali-oss','/upload/','----------------备用方法获取音频时长失败--------------','midjourneyEntity','form-data','uploadFileByLocal','aliCos','ffmpeg\x20-i\x20','-------------------获取音频时长（备用方法）-----------------','headers','95130Kfince','save','https://','post','transferM4a','uploadFileByTencentCos','del','上传图片失败[Chevereto]','Injectable','arraybuffer','child_process','Repository','@nestjs/common','jpg','1368442rFqudy','.mp4','RedisCacheService','tencent','append','aliOssBucket','__esModule','cheveretoStatus','.m4a','aliOssStatus','图片地址不可访问','getUploadConfig','cosSecretId','GOMAXAI_HOST','MidjourneyEntity','上传图片失败[ali]','uploadFileByChevereto','tencentCos','end','Logger','convertM4aToMp3','--------------TransferImgError---------------：','error','uploadFileBase','putObject','pop','MJ_IMG_TRANSFER','getAudioDurationByFFmpeg','stringify','aliOssRegion','?from=local','InjectRepository','axios','startsWith','cos-nodejs-sdk-v5','ali','replace','writeHead','aliOssAccessKeyId','1084972zvYpfi','\x22\x20-f\x20null\x20-t\x200.1\x20-','redisCacheService','../globalConfig/globalConfig.service','uploadUrl','onModuleInit'];_0x4e9d=function(){return _0x2476ca;};return _0x4e9d();}var __decorate=this&&this[_0x4759cc(0x140)]||function(_0x796a7d,_0x10ffbf,_0x2e6821,_0x509e5e){const _0x33457b=_0x4759cc;var _0x181cd3=arguments['length'],_0x3f6b0f=_0x181cd3<0x3?_0x10ffbf:_0x509e5e===null?_0x509e5e=Object['getOwnPropertyDescriptor'](_0x10ffbf,_0x2e6821):_0x509e5e,_0x394a7a;if(typeof Reflect==='object'&&typeof Reflect[_0x33457b(0x177)]===_0x33457b(0x18c))_0x3f6b0f=Reflect[_0x33457b(0x177)](_0x796a7d,_0x10ffbf,_0x2e6821,_0x509e5e);else{for(var _0x3f123f=_0x796a7d[_0x33457b(0x195)]-0x1;_0x3f123f>=0x0;_0x3f123f--)if(_0x394a7a=_0x796a7d[_0x3f123f])_0x3f6b0f=(_0x181cd3<0x3?_0x394a7a(_0x3f6b0f):_0x181cd3>0x3?_0x394a7a(_0x10ffbf,_0x2e6821,_0x3f6b0f):_0x394a7a(_0x10ffbf,_0x2e6821))||_0x3f6b0f;}return _0x181cd3>0x3&&_0x3f6b0f&&Object[_0x33457b(0x172)](_0x10ffbf,_0x2e6821,_0x3f6b0f),_0x3f6b0f;},__metadata=this&&this[_0x4759cc(0x161)]||function(_0xdd371a,_0x32baa4){const _0x3c22d2=_0x4759cc;if(typeof Reflect===_0x3c22d2(0x15c)&&typeof Reflect[_0x3c22d2(0x179)]===_0x3c22d2(0x18c))return Reflect[_0x3c22d2(0x179)](_0xdd371a,_0x32baa4);},__param=this&&this[_0x4759cc(0x184)]||function(_0x41003b,_0x42965a){return function(_0x318ce4,_0x2887f2){_0x42965a(_0x318ce4,_0x2887f2,_0x41003b);};};Object['defineProperty'](exports,_0x4759cc(0x1bd),{'value':!![]}),exports[_0x4759cc(0x13e)]=void 0x0;const common_1=require(_0x4759cc(0x1b5)),TENCENTCOS=require(_0x4759cc(0x12f)),ALIOSS=require(_0x4759cc(0x19f)),axios_1=require(_0x4759cc(0x12d)),image_size_1=require(_0x4759cc(0x18e)),utils_1=require('../../common/utils'),globalConfig_service_1=require(_0x4759cc(0x137)),FormData=require(_0x4759cc(0x1a3)),midjourney_entity_1=require(_0x4759cc(0x182)),typeorm_1=require(_0x4759cc(0x149)),typeorm_2=require('typeorm'),redisKey_constant_1=require('../../common/constants/redisKey.constant'),redisCache_service_1=require('../redisCache/redisCache.service'),store_1=require(_0x4759cc(0x160)),path_1=require(_0x4759cc(0x16c)),promises_1=require(_0x4759cc(0x176)),fs_1=require('fs'),child_process_1=require(_0x4759cc(0x1b3)),uuid_1=require(_0x4759cc(0x18a));let FileService=class FileService{constructor(_0x4a65aa,_0x5f3ca7,_0x441f89){const _0x1e7b08=_0x4759cc;this['midjourneyEntity']=_0x4a65aa,this[_0x1e7b08(0x18f)]=_0x5f3ca7,this['redisCacheService']=_0x441f89;}async[_0x4759cc(0x139)](){const _0x33d2ce=_0x4759cc,{tencentCosStatus:tencentCosStatus=0x0,aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0}=await this[_0x33d2ce(0x18f)]['getConfigByKeys']([_0x33d2ce(0x187),_0x33d2ce(0x1c0),'cheveretoStatus']);!Number(tencentCosStatus)&&!Number(aliOssStatus)&&!Number(cheveretoStatus)&&common_1[_0x33d2ce(0x120)]['error'](_0x33d2ce(0x143));if(Number(tencentCosStatus)===0x1){const {SecretId:_0x4b7862,SecretKey:_0x40cc2a}=await this[_0x33d2ce(0x1c2)](_0x33d2ce(0x1ba));this[_0x33d2ce(0x11e)]=new TENCENTCOS({'SecretId':_0x4b7862,'SecretKey':_0x40cc2a,'FileParallelLimit':0xa});}if(Number(aliOssStatus)===0x1){const {region:_0xb9817d,bucket:_0x34123b,accessKeyId:_0x5c1c98,accessKeySecret:_0x293a61}=await this[_0x33d2ce(0x1c2)](_0x33d2ce(0x130));this[_0x33d2ce(0x1a5)]=new ALIOSS({'region':(0x0,utils_1[_0x33d2ce(0x15d)])(_0xb9817d),'accessKeyId':_0x5c1c98,'accessKeySecret':_0x293a61,'bucket':(0x0,utils_1[_0x33d2ce(0x15d)])(_0x34123b)});}}async['getUploadConfig'](_0x10e5d8){const _0x4ba70c=_0x4759cc;if(_0x10e5d8===_0x4ba70c(0x130)){const {aliOssRegion:_0x42a47f,aliOssBucket:_0xe1d484,aliOssAccessKeyId:_0x16de0b,aliOssAccessKeySecret:_0x5e66a8}=await this[_0x4ba70c(0x18f)][_0x4ba70c(0x14a)]([_0x4ba70c(0x12a),_0x4ba70c(0x1bc),_0x4ba70c(0x133),'aliOssAccessKeySecret']);return{'region':_0x42a47f,'bucket':_0xe1d484,'accessKeyId':_0x16de0b,'accessKeySecret':_0x5e66a8};}if(_0x10e5d8==='tencent'){const {cosBucket:_0x2c08be,cosRegion:_0x317d2a,cosSecretId:_0x36ce51,cosSecretKey:_0x423639,tencentCosAcceleratedDomain:_0xc2026a}=await this['globalConfigService']['getConfigByKeys']([_0x4ba70c(0x16e),_0x4ba70c(0x174),_0x4ba70c(0x119),_0x4ba70c(0x155),_0x4ba70c(0x171)]);return{'Bucket':_0x2c08be,'Region':_0x317d2a,'SecretId':_0x36ce51,'SecretKey':_0x423639,'acceleratedDomain':_0xc2026a};}if(_0x10e5d8===_0x4ba70c(0x16b)){const {cheveretoKey:_0x7f3906,cheveretoUploadPath:_0x39d952}=await this[_0x4ba70c(0x18f)][_0x4ba70c(0x14a)]([_0x4ba70c(0x19c),_0x4ba70c(0x167)]);return{'key':_0x7f3906,'uploadPath':_0x39d952};}}async[_0x4759cc(0x138)](_0x36dbbf){const _0xff4973=_0x4759cc;try{const _0x30f45f=await axios_1[_0xff4973(0x14d)]['get'](_0x36dbbf,{'responseType':_0xff4973(0x1b2)}),_0x58adc3=_0x30f45f['data'],{width:_0x5bee76,height:_0x5ee866}=await(0x0,image_size_1[_0xff4973(0x14d)])(_0x58adc3);let _0xaa6e78=(0x0,uuid_1['v4'])();const _0x260117=await this[_0xff4973(0x145)]({'filename':_0xaa6e78,'buffer':_0x58adc3});return{'url':_0x260117,'width':_0x5bee76,'height':_0x5ee866};}catch(_0x195047){console['log'](_0xff4973(0x19a),_0x195047);}return _0x36dbbf;}async[_0x4759cc(0x145)](_0x4c422e){const _0x1c2a85=_0x4759cc,{filename:_0x503360,buffer:_0x4824e5,returnDuration:_0x287cb8}=_0x4c422e;if(_0x503360['endsWith']('m4a'))return this['transferM4a'](_0x4824e5);const _0x5e1582=await this[_0x1c2a85(0x124)](_0x4c422e);if(_0x287cb8){const _0x204458=await this[_0x1c2a85(0x128)](_0x5e1582);return{'url':_0x5e1582,'duration':_0x204458};}return _0x5e1582;}async[_0x4759cc(0x124)](_0x3b7967){const _0x11cc03=_0x4759cc,{filename:_0xcf78be,buffer:_0x3d51ae,dir:dir='ai'}=_0x3b7967,{aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this['globalConfigService'][_0x11cc03(0x14a)]([_0x11cc03(0x187),_0x11cc03(0x1c0),_0x11cc03(0x1be)]);if(Number(tencentCosStatus)===0x1)return this[_0x11cc03(0x1ae)]({'filename':_0xcf78be,'buffer':_0x3d51ae,'dir':dir});if(Number(aliOssStatus)===0x1)return this[_0x11cc03(0x158)]({'filename':_0xcf78be,'buffer':_0x3d51ae,'dir':dir});if(Number(cheveretoStatus)){const {filename:_0x2a824f,buffer:_0x4ff3b5,dir:_0x5d61f6}=_0x3b7967;return this['uploadFileByChevereto']({'filename':_0x2a824f,'buffer':_0x4ff3b5['toString'](_0x11cc03(0x17b)),'dir':_0x5d61f6});}const [_0xcf517d,_0x314b11]=await this[_0x11cc03(0x1a4)]({'filename':_0xcf78be,'buffer':_0x3d51ae,'dir':dir});return _0xcf517d;}async[_0x4759cc(0x142)](_0x3a79b4){const _0x2b275e=_0x4759cc,{filename:_0x321b12,buffer:_0x8d53f2,dir:dir='ai'}=_0x3a79b4,[_0x247154,_0x28e373]=await this[_0x2b275e(0x1a4)]({'filename':_0x321b12,'buffer':_0x8d53f2,'dir':dir});return _0x247154+_0x2b275e(0x12b);}async['uploadFileByTencentCos']({filename:_0x5f2e18,buffer:_0x17821a,dir:_0x26fcc9}){const _0x399200=_0x4759cc;try{const {Bucket:_0x3650b7,Region:_0x417e7c,SecretId:_0x4be9c5,SecretKey:_0x3ae3a0}=await this['getUploadConfig'](_0x399200(0x1ba));!this[_0x399200(0x11e)]&&(this[_0x399200(0x11e)]=new TENCENTCOS({'SecretId':_0x4be9c5,'SecretKey':_0x3ae3a0,'FileParallelLimit':0xa,'Timeout':0x3e8*0x3c*0xa}));const _0x56187e=await this['tencentCos'][_0x399200(0x125)]({'Bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x3650b7),'Region':(0x0,utils_1[_0x399200(0x15d)])(_0x417e7c),'Key':_0x26fcc9+'/'+(_0x5f2e18||(0x0,utils_1[_0x399200(0x19d)])()+_0x399200(0x15a)),'StorageClass':_0x399200(0x13d),'Body':_0x17821a});let _0x50aa22=_0x56187e[_0x399200(0x168)][_0x399200(0x131)](/^(http:\/\/|https:\/\/|\/\/|)(.*)/,_0x399200(0x15b));const {acceleratedDomain:_0x3e145c}=await this[_0x399200(0x1c2)](_0x399200(0x1ba));return _0x3e145c&&(_0x50aa22=_0x50aa22[_0x399200(0x131)](/^(https:\/\/[^/]+)(\/.*)$/,_0x399200(0x1ab)+_0x3e145c+'$2'),console['log']('当前已开启全球加速----------------->',_0x50aa22)),_0x50aa22;}catch(_0x2aab9c){console[_0x399200(0x17c)](_0x399200(0x156),_0x2aab9c);throw new common_1[(_0x399200(0x16f))]('上传图片失败[ten]',common_1[_0x399200(0x170)][_0x399200(0x197)]);}}async[_0x4759cc(0x158)]({filename:_0x3115e0,buffer:_0x983d51,dir:_0x2c5678}){const _0x328920=_0x4759cc;if(!this[_0x328920(0x1a5)]){const {region:_0x1016f4,bucket:_0x310a88,accessKeyId:_0x4f6947,accessKeySecret:_0x2562a0}=await this[_0x328920(0x1c2)](_0x328920(0x130));this[_0x328920(0x1a5)]=new ALIOSS({'region':(0x0,utils_1['removeSpecialCharacters'])(_0x1016f4),'accessKeyId':_0x4f6947,'accessKeySecret':_0x2562a0,'bucket':(0x0,utils_1['removeSpecialCharacters'])(_0x310a88),'timeout':0x3e8*0x3c*0xa});}try{console[_0x328920(0x17c)](_0x328920(0x186));const _0x327685=await this[_0x328920(0x1a5)][_0x328920(0x16d)](_0x2c5678+'/'+(_0x3115e0||(0x0,utils_1[_0x328920(0x19d)])()+'.png'),_0x983d51);return _0x327685['url'];}catch(_0x46492c){throw new common_1[(_0x328920(0x16f))](_0x328920(0x11c),common_1['HttpStatus'][_0x328920(0x197)]);}}async[_0x4759cc(0x11d)]({filename:filename='',buffer:_0x2bde22,dir:dir='ai'}){const _0x55ede6=_0x4759cc,{key:_0x3fc79f,uploadPath:_0x283694}=await this[_0x55ede6(0x1c2)]('chevereto'),_0x205516=new FormData();_0x205516[_0x55ede6(0x1bb)](_0x55ede6(0x15f),_0x2bde22[_0x55ede6(0x16a)](_0x55ede6(0x17b))),_0x205516[_0x55ede6(0x1bb)]('key',_0x3fc79f);try{const _0x4bfbff=await axios_1['default'][_0x55ede6(0x1ac)](_0x283694,_0x205516,{'headers':{'X-API-Key':_0x3fc79f},'timeout':0xa*0x3c*0x3e8});if(_0x4bfbff?.['status']===0xc8)return _0x4bfbff[_0x55ede6(0x13a)][_0x55ede6(0x189)]['url'];else{common_1[_0x55ede6(0x120)][_0x55ede6(0x123)]('上传图片失败[Chevereto]',JSON[_0x55ede6(0x129)](_0x4bfbff[_0x55ede6(0x13a)]));throw new Error(_0x55ede6(0x1b0));}}catch(_0x2501cd){console[_0x55ede6(0x17c)](_0x55ede6(0x156),_0x2501cd[_0x55ede6(0x175)]);throw new common_1['HttpException'](_0x55ede6(0x199)+_0x2501cd[_0x55ede6(0x175)]?.[_0x55ede6(0x13a)][_0x55ede6(0x123)]['message'],common_1[_0x55ede6(0x170)]['BAD_REQUEST']);}}async['uploadFileByLocal']({filename:_0x23a8af,buffer:_0x2af11f,dir:_0x20ebbc}){const _0x297ab4=_0x4759cc;let _0x482d07=(0x0,path_1[_0x297ab4(0x198)])(process[_0x297ab4(0x17a)](),_0x297ab4(0x15e),_0x297ab4(0x151)),_0x1f0284=_0x297ab4(0x169),_0x55d358='';_0x20ebbc&&(_0x482d07=(0x0,path_1[_0x297ab4(0x198)])(_0x482d07,_0x20ebbc),_0x1f0284=_0x297ab4(0x1a0)+_0x20ebbc);_0x1f0284=_0x1f0284+'/'+_0x23a8af;!(0x0,fs_1[_0x297ab4(0x146)])(_0x482d07)&&(0x0,fs_1['mkdirSync'])(_0x482d07,{'recursive':!![]});_0x482d07=(0x0,path_1[_0x297ab4(0x198)])(_0x482d07,_0x23a8af),await(0x0,promises_1['writeFile'])(_0x482d07,_0x2af11f);let _0x93fc72=process['env'][_0x297ab4(0x11a)];return _0x93fc72[_0x297ab4(0x12e)](_0x297ab4(0x17e))?_0x55d358=_0x93fc72+_0x1f0284:_0x55d358=_0x297ab4(0x1ab)+_0x93fc72+_0x1f0284,[_0x55d358,_0x482d07];}async['downFile'](_0x230c38,_0x167e89,_0x1cd51b){const _0x41d8ae=_0x4759cc;try{const _0x194c49=_0x230c38[_0x41d8ae(0x188)]('/')[_0x41d8ae(0x126)](),_0x3adaa4=await(0x0,axios_1[_0x41d8ae(0x14d)])(_0x230c38,{'headers':{'Content-Type':_0x41d8ae(0x163)},'responseType':'arraybuffer','timeout':0x493e0});_0x1cd51b[_0x41d8ae(0x132)](0xc8,{'Content-Type':_0x3adaa4[_0x41d8ae(0x1a8)][_0x41d8ae(0x147)],'Content-Disposition':_0x194c49}),_0x1cd51b[_0x41d8ae(0x11f)](_0x3adaa4['data'],'binary');}catch(_0x54e6fd){throw new common_1[(_0x41d8ae(0x16f))](_0x54e6fd[_0x41d8ae(0x14e)],common_1['HttpStatus']['BAD_REQUEST']);}}async['getModalImgById'](_0x2691e1){const _0x147348=_0x4759cc;try{const _0x13f8d3=await this['midjourneyEntity']['findOne']({'where':{'id':Number(_0x2691e1['query'][_0x147348(0x154)])}});let _0x42eb70;if(_0x13f8d3['imageUrl'])_0x42eb70=_0x13f8d3['imageUrl'];else{const _0x1da8f1=await this[_0x147348(0x1a2)][_0x147348(0x150)]({'where':{'id':Number(_0x13f8d3[_0x147348(0x194)])}});_0x42eb70=_0x1da8f1[_0x147348(0x19e)];}if(!_0x42eb70)throw new Error(_0x147348(0x14b));const _0x19b847=await axios_1[_0x147348(0x14d)]['get'](_0x42eb70,{'responseType':'arraybuffer'}),_0x45af2c=Buffer[_0x147348(0x14c)](_0x19b847['data'])[_0x147348(0x16a)](_0x147348(0x17b));return'data:image/jpeg;base64,'+_0x45af2c;}catch(_0x296037){throw new common_1[(_0x147348(0x16f))](_0x296037[_0x147348(0x14e)],common_1[_0x147348(0x170)]['BAD_REQUEST']);}}async[_0x4759cc(0x164)](_0x1156eb){const _0x322a40=_0x4759cc;try{const _0x3fb2bf=await axios_1[_0x322a40(0x14d)]['get'](_0x1156eb,{'responseType':_0x322a40(0x1b2)}),_0x467ab6=_0x1156eb[_0x322a40(0x188)]('/')[_0x322a40(0x126)]()[_0x322a40(0x188)]('?')[0x0],_0x3c3111=await this[_0x322a40(0x145)]({'filename':_0x467ab6,'buffer':_0x3fb2bf[_0x322a40(0x13a)]});return _0x3c3111;}catch(_0x430ca0){return common_1[_0x322a40(0x120)]['error']('transferFile\x20error:\x20',_0x430ca0),null;}}async[_0x4759cc(0x141)](_0x4841f9){return new Promise((_0x1d0439,_0xb2fe97)=>{const _0x35ec7b=_0x3788,_0x4a1fff=_0x4841f9[_0x35ec7b(0x131)]('.mp4','.jpg');(0x0,child_process_1[_0x35ec7b(0x165)])('\x0a\x20\x20\x20\x20\x20\x20\x20\x20ffmpeg\x20-i\x20'+_0x4841f9+_0x35ec7b(0x18b)+_0x4a1fff+_0x35ec7b(0x178),function(_0x2d20e4,_0x4b4e8f,_0x1ff671){const _0x37f7a7=_0x35ec7b;_0x2d20e4?(console[_0x37f7a7(0x17c)](_0x1ff671),_0xb2fe97(_0x2d20e4)):_0x1d0439(_0x4a1fff);});});}async[_0x4759cc(0x121)](_0x14094b){return new Promise((_0x5341f1,_0x4ac087)=>{const _0x12240b=_0x3788,_0x4e0d63=_0x14094b[_0x12240b(0x131)](_0x12240b(0x1bf),_0x12240b(0x196));(0x0,child_process_1[_0x12240b(0x165)])(_0x12240b(0x1a6)+_0x14094b+_0x12240b(0x13c)+_0x4e0d63,function(_0x9d4e9c,_0x1aadbf,_0x3c7607){const _0x335a5e=_0x12240b;_0x9d4e9c?(console[_0x335a5e(0x17c)]('------------转换失败Mp3--------',_0x3c7607),_0x4ac087(_0x9d4e9c)):(console['log'](_0x335a5e(0x173),_0x4e0d63),_0x5341f1(_0x4e0d63));});});}async['getAudioDurationByFFmpeg'](_0x12376e){return new Promise((_0x42b382,_0x572674)=>{const _0x2003ff=_0x3788;(0x0,child_process_1[_0x2003ff(0x165)])('ffprobe\x20-v\x20error\x20-show_entries\x20format=duration\x20-of\x20default=noprint_wrappers=1:nokey=1\x20\x22'+_0x12376e+'\x22',function(_0x2e5ce0,_0x2c878d,_0x2f6ce2){const _0x3ad9db=_0x2003ff;if(_0x2e5ce0)console[_0x3ad9db(0x17c)]('----------------获取音频时长失败--------------',_0x2f6ce2),(0x0,child_process_1[_0x3ad9db(0x165)])(_0x3ad9db(0x18d)+_0x12376e+_0x3ad9db(0x135),function(_0x1dfffa,_0x3743fa,_0x2dd700){const _0x7b1a62=_0x3ad9db;if(_0x1dfffa)console['log'](_0x7b1a62(0x1a1),_0x2dd700),_0x572674(_0x1dfffa);else{const _0x37c992=_0x2dd700[_0x7b1a62(0x183)](/time=(\d+\.\d+)/);if(!_0x37c992)_0x572674(_0x7b1a62(0x180));else{const _0x5703bb=parseFloat(_0x37c992[0x1]);console[_0x7b1a62(0x17c)](_0x7b1a62(0x1a7),_0x5703bb),_0x42b382(_0x5703bb);}}});else{const _0x4c8557=parseFloat(_0x2c878d[_0x3ad9db(0x181)]());isNaN(_0x4c8557)?_0x572674(_0x3ad9db(0x157)):(console[_0x3ad9db(0x17c)]('-------------------获取音频时长-----------------',_0x4c8557),_0x42b382(_0x4c8557));}});});}async[_0x4759cc(0x17d)](_0x39d249){return new Promise((_0x120920,_0x564a4d)=>{const _0x152061=_0x3788;(0x0,child_process_1[_0x152061(0x165)])(_0x152061(0x1a6)+_0x39d249+_0x152061(0x159),function(_0x44887c,_0x2427ff,_0x5408b5){const _0x2daef4=_0x152061;if(_0x44887c)console[_0x2daef4(0x17c)](_0x2daef4(0x19b),_0x5408b5),_0x564a4d(_0x44887c);else{const _0x44e866=_0x5408b5[_0x2daef4(0x183)](/Duration: (\d+:\d+:\d+\.\d+)/);if(!_0x44e866)_0x564a4d('无法从输出中提取时长信息');else{const _0x502bb3=_0x44e866[0x1][_0x2daef4(0x188)](':'),_0x37788a=parseInt(_0x502bb3[0x0],0xa),_0x5537a0=parseInt(_0x502bb3[0x1],0xa),_0x2588ff=parseFloat(_0x502bb3[0x2]);console[_0x2daef4(0x17c)](_0x2daef4(0x185),_0x37788a*0xe10+_0x5537a0*0x3c+_0x2588ff),_0x120920(_0x37788a*0xe10+_0x5537a0*0x3c+_0x2588ff);}}});});}async[_0x4759cc(0x1ad)](_0x50bac5){const _0x19f26f=_0x4759cc;let _0x4b1f0e=null;try{let _0x5741c9=(0x0,uuid_1['v4'])(),_0x2ac724=_0x5741c9['replace'](/-/g,'')+_0x19f26f(0x1bf);const [_0x10dfea,_0x5b97bb]=await this[_0x19f26f(0x1a4)]({'filename':_0x2ac724,'buffer':_0x50bac5,'dir':'human'}),_0x399619=await this[_0x19f26f(0x121)](_0x5b97bb);let {aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this['globalConfigService']['getConfigByKeys'](['tencentCosStatus','aliOssStatus',_0x19f26f(0x1be)]);aliOssStatus=Number(aliOssStatus),cheveretoStatus=Number(cheveretoStatus),tencentCosStatus=Number(tencentCosStatus);if(aliOssStatus||cheveretoStatus||tencentCosStatus){console[_0x19f26f(0x17c)]('需要转存到云');const _0x18283e=(0x0,fs_1[_0x19f26f(0x162)])(_0x399619);_0x4b1f0e=await this[_0x19f26f(0x124)]({'filename':_0x2ac724[_0x19f26f(0x131)](/m4a$/,'mp3'),'buffer':_0x18283e}),(0x0,fs_1['rmSync'])(_0x5b97bb),(0x0,fs_1[_0x19f26f(0x153)])(_0x399619);}else _0x4b1f0e=_0x10dfea[_0x19f26f(0x131)](_0x19f26f(0x1bf),_0x19f26f(0x196));return _0x4b1f0e;}catch(_0x53abe8){return common_1[_0x19f26f(0x120)]['error'](_0x19f26f(0x192),_0x53abe8),'';}}async['transferAndCover'](_0x1dfb2a){const _0xe75581=_0x4759cc;let _0x594834=null,_0x421d74=null;try{const _0x17c4ff=await axios_1['default'][_0xe75581(0x191)](_0x1dfb2a,{'responseType':_0xe75581(0x1b2)});let _0x4c05d7=(0x0,uuid_1['v4'])(),_0x4d47ba=_0x4c05d7[_0xe75581(0x131)](/-/g,'')+_0xe75581(0x1b8);const [_0x4e528e,_0x5076dc]=await this[_0xe75581(0x1a4)]({'filename':_0x4d47ba,'buffer':_0x17c4ff[_0xe75581(0x13a)],'dir':'ai'}),_0x3e265b=await this[_0xe75581(0x141)](_0x5076dc);let {aliOssStatus:aliOssStatus=0x0,cheveretoStatus:cheveretoStatus=0x0,tencentCosStatus:tencentCosStatus=0x0}=await this[_0xe75581(0x18f)]['getConfigByKeys']([_0xe75581(0x187),'aliOssStatus','cheveretoStatus']);aliOssStatus=Number(aliOssStatus),cheveretoStatus=Number(cheveretoStatus),tencentCosStatus=Number(tencentCosStatus);if(aliOssStatus||cheveretoStatus||tencentCosStatus){console[_0xe75581(0x17c)]('需要转存到云'),_0x594834=await this[_0xe75581(0x145)]({'filename':_0x4d47ba,'buffer':_0x17c4ff['data']});const _0x329772=(0x0,fs_1[_0xe75581(0x162)])(_0x3e265b);_0x421d74=await this[_0xe75581(0x145)]({'filename':_0x4d47ba[_0xe75581(0x131)](/mp4$/,_0xe75581(0x1b6)),'buffer':_0x329772}),(0x0,fs_1['rmSync'])(_0x5076dc),(0x0,fs_1['rmSync'])(_0x3e265b);}else _0x594834=_0x4e528e,_0x421d74=_0x4e528e[_0xe75581(0x131)](_0xe75581(0x1b8),'.jpg');return[_0x594834,_0x421d74];}catch(_0x5f4db3){return common_1[_0xe75581(0x120)]['error'](_0xe75581(0x192),_0x5f4db3),[_0x1dfb2a,_0x421d74];}}async['transferImg'](_0x546d87,_0x2bcb7a,_0xff15a6){const _0x930f65=_0x4759cc,_0x29fe82=redisKey_constant_1[_0x930f65(0x127)]+_0x546d87;try{const _0x1e07da=await this[_0x930f65(0x136)][_0x930f65(0x191)]({'key':_0x29fe82});if(_0x1e07da)return;this[_0x930f65(0x136)][_0x930f65(0x190)]({'key':_0x29fe82,'val':'lock'});const _0x49278f=await axios_1['default'][_0x930f65(0x191)](_0x2bcb7a,{'responseType':_0x930f65(0x1b2)}),{width:_0x5b6c5a,height:_0x55b343}=await(0x0,image_size_1[_0x930f65(0x14d)])(_0x49278f[_0x930f65(0x13a)]);let _0x424512=[{'url':_0x2bcb7a,'width':_0x5b6c5a,'height':_0x55b343}];!store_1['MjConfig'][_0x930f65(0x144)]&&(_0x2bcb7a=await this['uploadFile']({'filename':_0x930f65(0x166)+_0x546d87+_0x930f65(0x15a),'buffer':_0x49278f[_0x930f65(0x13a)]}),_0xff15a6&&_0xff15a6['length']&&(_0x424512=[{'url':_0x2bcb7a,'width':_0x5b6c5a,'height':_0x55b343,'children':_0xff15a6[_0x930f65(0x17f)](_0x1f0f13=>({'url':_0x1f0f13[_0x930f65(0x13f)],'width':_0x5b6c5a,'height':_0x55b343}))}])),await this['midjourneyEntity'][_0x930f65(0x1aa)]({'id':_0x546d87,'imageUrl':_0x2bcb7a,'progress':0x64,'fileInfo':JSON[_0x930f65(0x129)]({'width':_0x5b6c5a,'height':_0x55b343}),'responseResult':_0x424512,'status':0xa});}catch(_0x2f9721){await this[_0x930f65(0x1a2)][_0x930f65(0x1aa)]({'id':_0x546d87,'status':0x4,'errMsg':_0x930f65(0x1c1)}),common_1[_0x930f65(0x120)][_0x930f65(0x123)](_0x930f65(0x122),_0x2f9721);}finally{this[_0x930f65(0x136)][_0x930f65(0x1af)]({'key':_0x29fe82});}}};function _0x3788(_0x7336af,_0xba7920){const _0x4e9d56=_0x4e9d();return _0x3788=function(_0x37881c,_0x5aa004){_0x37881c=_0x37881c-0x119;let _0x22f498=_0x4e9d56[_0x37881c];return _0x22f498;},_0x3788(_0x7336af,_0xba7920);}FileService=__decorate([(0x0,common_1[_0x4759cc(0x1b1)])(),__param(0x0,(0x0,typeorm_1[_0x4759cc(0x12c)])(midjourney_entity_1[_0x4759cc(0x11b)])),__metadata('design:paramtypes',[typeorm_2[_0x4759cc(0x1b4)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x4759cc(0x1b9)]])],FileService),exports['FileService']=FileService;