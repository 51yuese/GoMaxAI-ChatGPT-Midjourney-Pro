'use strict';const _0x320751=_0x33bf;(function(_0x217c06,_0xee75d1){const _0x17bf5f=_0x33bf,_0x3a4660=_0x217c06();while(!![]){try{const _0x171b17=parseInt(_0x17bf5f(0x20f))/0x1+-parseInt(_0x17bf5f(0x1df))/0x2+parseInt(_0x17bf5f(0x191))/0x3*(parseInt(_0x17bf5f(0x1d2))/0x4)+parseInt(_0x17bf5f(0x1a0))/0x5*(parseInt(_0x17bf5f(0x190))/0x6)+-parseInt(_0x17bf5f(0x1c6))/0x7+-parseInt(_0x17bf5f(0x220))/0x8*(parseInt(_0x17bf5f(0x1a9))/0x9)+parseInt(_0x17bf5f(0x214))/0xa;if(_0x171b17===_0xee75d1)break;else _0x3a4660['push'](_0x3a4660['shift']());}catch(_0x2ecc1d){_0x3a4660['push'](_0x3a4660['shift']());}}}(_0x1bc9,0x9d35c));var __decorate=this&&this[_0x320751(0x1a8)]||function(_0x32f69f,_0x52ef8e,_0x4d248d,_0x4043ea){const _0x2ad8a8=_0x320751;var _0x24cd78=arguments[_0x2ad8a8(0x225)],_0x10d0ac=_0x24cd78<0x3?_0x52ef8e:_0x4043ea===null?_0x4043ea=Object[_0x2ad8a8(0x1fb)](_0x52ef8e,_0x4d248d):_0x4043ea,_0x418feb;if(typeof Reflect===_0x2ad8a8(0x1e5)&&typeof Reflect[_0x2ad8a8(0x1dc)]===_0x2ad8a8(0x1a4))_0x10d0ac=Reflect['decorate'](_0x32f69f,_0x52ef8e,_0x4d248d,_0x4043ea);else{for(var _0x16df6a=_0x32f69f[_0x2ad8a8(0x225)]-0x1;_0x16df6a>=0x0;_0x16df6a--)if(_0x418feb=_0x32f69f[_0x16df6a])_0x10d0ac=(_0x24cd78<0x3?_0x418feb(_0x10d0ac):_0x24cd78>0x3?_0x418feb(_0x52ef8e,_0x4d248d,_0x10d0ac):_0x418feb(_0x52ef8e,_0x4d248d))||_0x10d0ac;}return _0x24cd78>0x3&&_0x10d0ac&&Object[_0x2ad8a8(0x233)](_0x52ef8e,_0x4d248d,_0x10d0ac),_0x10d0ac;},__metadata=this&&this['__metadata']||function(_0xd5d4f,_0x22f35b){const _0x2f6d5a=_0x320751;if(typeof Reflect===_0x2f6d5a(0x1e5)&&typeof Reflect['metadata']===_0x2f6d5a(0x1a4))return Reflect[_0x2f6d5a(0x1cd)](_0xd5d4f,_0x22f35b);},__param=this&&this[_0x320751(0x1d0)]||function(_0x31eb23,_0x57969e){return function(_0x41d5aa,_0x3d23da){_0x57969e(_0x41d5aa,_0x3d23da,_0x31eb23);};};function _0x33bf(_0x51ec60,_0x3cccd5){const _0x1bc9f8=_0x1bc9();return _0x33bf=function(_0x33bf95,_0x462ef5){_0x33bf95=_0x33bf95-0x190;let _0x5d50ae=_0x1bc9f8[_0x33bf95];return _0x5d50ae;},_0x33bf(_0x51ec60,_0x3cccd5);}Object[_0x320751(0x233)](exports,_0x320751(0x1ab),{'value':!![]}),exports[_0x320751(0x1c3)]=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x320751(0x1a7)),typeorm_2=require(_0x320751(0x19b)),gpts_model_entity_1=require(_0x320751(0x223)),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require('../chatLog/chatLog.service'),utils_1=require(_0x320751(0x1b8)),models_service_1=require(_0x320751(0x218)),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x320751(0x1f2)),nestjs_cls_1=require(_0x320751(0x19c)),chatGroup_service_1=require(_0x320751(0x22f));let GptsService=class GptsService{constructor(_0x1d0061,_0x5242be,_0x407f4a,_0x2d4c69,_0x33ab34,_0x5b4f95,_0x556863,_0x167d12){const _0x524742=_0x320751;this[_0x524742(0x20d)]=_0x1d0061,this['gptsGroupEntity']=_0x5242be,this[_0x524742(0x1f3)]=_0x407f4a,this['gptsChatEntity']=_0x2d4c69,this[_0x524742(0x198)]=_0x33ab34,this[_0x524742(0x1af)]=_0x5b4f95,this['chatLogService']=_0x556863,this['chatGroupService']=_0x167d12;}async[_0x320751(0x195)](_0x5d3520){const _0x1ebcce=_0x320751;try{const _0x519cf3=_0x5d3520['groupName'],_0x618921=(0x0,utils_1[_0x1ebcce(0x228)])(this[_0x1ebcce(0x198)]),_0x2a3b9e=await this[_0x1ebcce(0x22b)][_0x1ebcce(0x1fd)]({'where':{'groupName':_0x519cf3,'saasId':_0x618921}});if(_0x2a3b9e)throw new common_1['HttpException'](_0x1ebcce(0x1c1),common_1[_0x1ebcce(0x21f)][_0x1ebcce(0x19f)]);return await this[_0x1ebcce(0x22b)][_0x1ebcce(0x1b3)]({..._0x5d3520,'saasId':_0x618921}),!![];}catch(_0x291c5d){throw new common_1[(_0x1ebcce(0x1cb))](_0x291c5d[_0x1ebcce(0x224)],common_1[_0x1ebcce(0x21f)][_0x1ebcce(0x19f)]);}}async[_0x320751(0x1d7)](_0x586ca9){const _0x319d54=_0x320751;try{const _0x325456=await this[_0x319d54(0x22b)][_0x319d54(0x1fd)]({'where':{'id':_0x586ca9['id']}});if(!_0x325456)throw new common_1['HttpException'](_0x319d54(0x1d4),common_1[_0x319d54(0x21f)][_0x319d54(0x19f)]);return await this[_0x319d54(0x22b)][_0x319d54(0x211)]({'id':_0x586ca9['id']},_0x586ca9),!![];}catch(_0x4d1ac0){throw new common_1['HttpException'](_0x4d1ac0[_0x319d54(0x224)],common_1[_0x319d54(0x21f)][_0x319d54(0x19f)]);}}async['handleRemoveGroup'](_0x29525f){const _0x263536=_0x320751;try{const _0x51a027=_0x29525f['id'],_0x2108c7=await this[_0x263536(0x22b)]['findOne']({'where':{'id':_0x51a027}});if(!_0x2108c7)throw new common_1['HttpException'](_0x263536(0x1bf),common_1[_0x263536(0x21f)][_0x263536(0x19f)]);const _0x17f950=await this[_0x263536(0x1f3)]['count']({'where':{'groupId':_0x2108c7['id']}});if(_0x17f950>0x0)throw new common_1[(_0x263536(0x1cb))](_0x263536(0x1ba),common_1[_0x263536(0x21f)]['BAD_REQUEST']);else await this[_0x263536(0x22b)][_0x263536(0x1c2)]({'id':_0x51a027});}catch(_0x4c556b){throw new common_1['HttpException'](_0x4c556b['message'],common_1[_0x263536(0x21f)][_0x263536(0x19f)]);}}async['handleQueryGroup'](_0x238cee,_0x3082a2){const _0x24e28d=_0x320751;try{const _0x265376=(0x0,utils_1[_0x24e28d(0x228)])(this[_0x24e28d(0x198)]),{page:page=0x1,size:size=0x14,status:_0x43d5b2,saasId:_0x206f34,groupName:_0x533062}=_0x238cee,_0x19e0bf={};return _0x533062&&(_0x19e0bf[_0x24e28d(0x1bc)]=_0x533062),_0x43d5b2>=0x0&&(_0x19e0bf['status']=_0x43d5b2),(0x0,utils_1['isPlatform'])(this[_0x24e28d(0x198)])?(0x0,utils_1[_0x24e28d(0x206)])(_0x206f34)&&(_0x19e0bf[_0x24e28d(0x1d3)]=_0x206f34):_0x19e0bf[_0x24e28d(0x1d3)]=_0x265376,await this[_0x24e28d(0x22b)]['findAndCount']({'where':_0x19e0bf,'skip':(page-0x1)*size,'take':size,'order':{'weight':'DESC','id':_0x24e28d(0x1ad)}})['then'](([_0x158ff1,_0x5daae1])=>({'rows':_0x158ff1,'count':_0x5daae1}))[_0x24e28d(0x1d1)](_0x54b115=>{throw new Error(_0x54b115);});}catch(_0x1816ed){console[_0x24e28d(0x1a1)](_0x24e28d(0x1a6),_0x1816ed);throw new common_1[(_0x24e28d(0x1cb))](_0x1816ed,common_1[_0x24e28d(0x21f)][_0x24e28d(0x19f)]);}}async['handleGetGroup'](_0x168fe0,_0x133a00){const _0x3e814d=_0x320751;try{const {groupId:_0x44762b}=_0x168fe0;return await this[_0x3e814d(0x22b)][_0x3e814d(0x1fd)]({'where':{'id':Number(_0x44762b)}})[_0x3e814d(0x216)](_0x197f54=>{return _0x197f54;})[_0x3e814d(0x1d1)](_0x849506=>{throw new Error(_0x849506);});}catch(_0x521151){console[_0x3e814d(0x1a1)](_0x3e814d(0x1a6),_0x521151);throw new common_1[(_0x3e814d(0x1cb))](_0x521151,common_1[_0x3e814d(0x21f)]['BAD_REQUEST']);}}async[_0x320751(0x204)](_0xc66d2e,_0x9a5ab8){const _0x430859=_0x320751;try{const _0x12074b=_0xc66d2e[_0x430859(0x1e9)]['id'],_0x122907=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x9c5c28=Object[_0x430859(0x1e6)](new gpts_model_entity_1[(_0x430859(0x1ce))](),_0x9a5ab8);_0x9c5c28[_0x430859(0x1f7)]=Number(_0x9a5ab8['status']);if(_0x9c5c28['id']){const _0x1e85a3=await this[_0x430859(0x1f3)][_0x430859(0x1fd)]({'where':{'id':_0x9c5c28['id']}});if(!_0x1e85a3)throw new common_1[(_0x430859(0x1cb))](_0x430859(0x1b2),common_1[_0x430859(0x21f)]['BAD_REQUEST']);if(_0x1e85a3['gptsApp']!==_0x9c5c28[_0x430859(0x231)])throw new common_1[(_0x430859(0x1cb))](_0x430859(0x1bb),common_1[_0x430859(0x21f)]['BAD_REQUEST']);return await this[_0x430859(0x1f3)][_0x430859(0x211)]({'id':_0x9c5c28['id']},{..._0x9c5c28,'useCount':_0x9c5c28['useCount']??_0x1e85a3[_0x430859(0x219)],'collectCount':_0x9c5c28[_0x430859(0x197)]??_0x1e85a3['collectCount']})[_0x430859(0x216)](_0x18ee0c=>_0x18ee0c[_0x430859(0x229)]>0x0)['catch'](_0x2a918c=>{throw new Error(_0x2a918c);});}else{const _0x5b6d62=await this[_0x430859(0x22b)][_0x430859(0x1fd)]({'where':{'id':_0x9c5c28[_0x430859(0x202)]}});if(!_0x5b6d62)throw new common_1[(_0x430859(0x1cb))]('应用分类不存在！',common_1['HttpStatus'][_0x430859(0x19f)]);const _0x3ffbdb=await this[_0x430859(0x1f3)][_0x430859(0x1b3)]({..._0x9c5c28,'saasId':_0x122907,'userId':_0xc66d2e[_0x430859(0x1c9)][_0x430859(0x1b0)]?_0x12074b:null});return _0x3ffbdb['id'];}}catch(_0x3a6359){throw new common_1[(_0x430859(0x1cb))](_0x3a6359,common_1[_0x430859(0x21f)]['BAD_REQUEST']);}}async[_0x320751(0x21b)](){const _0x298415=_0x320751;return await this[_0x298415(0x1f3)][_0x298415(0x1a3)]()[_0x298415(0x216)](_0x3650d7=>_0x3650d7[_0x298415(0x210)](_0x9c8577=>_0x9c8577['modelName']));}async['handleAddGptsBatch'](_0x3f226e){const _0x2a0f36=_0x320751;try{const _0x1aadf0=(0x0,utils_1['getReqSaasId'])(this[_0x2a0f36(0x198)]),_0x20e969=await this['getExistGpts'](),_0x190eee=_0x3f226e['filter'](_0x4664b7=>!_0x20e969[_0x2a0f36(0x1b5)](_0x4664b7[_0x2a0f36(0x1d8)]))[_0x2a0f36(0x210)](_0xf24810=>({'groupId':_0xf24810[_0x2a0f36(0x202)],'relModel':_0xf24810[_0x2a0f36(0x1c5)],'logo':_0xf24810[_0x2a0f36(0x1c0)],'desc':_0xf24810[_0x2a0f36(0x207)],'modelName':_0xf24810[_0x2a0f36(0x1d8)],'modelId':_0xf24810[_0x2a0f36(0x1a5)],'saasId':_0x1aadf0}));return await this[_0x2a0f36(0x1f3)][_0x2a0f36(0x1b3)](_0x190eee)['catch'](_0x29b0a5=>{throw new Error(_0x29b0a5);});}catch(_0x3ac83c){console[_0x2a0f36(0x1a1)](_0x2a0f36(0x1a6),_0x3ac83c);throw new common_1[(_0x2a0f36(0x1cb))](_0x3ac83c,common_1[_0x2a0f36(0x21f)][_0x2a0f36(0x19f)]);}}async[_0x320751(0x1fc)](_0x114405,_0x250530){const _0x481f4c=_0x320751;try{const _0x1830e6=(0x0,utils_1['getUserId'])(this[_0x481f4c(0x198)]),_0x1c38f3=(0x0,utils_1[_0x481f4c(0x228)])(this['clsService']),_0x441a97=new Set(),_0x1cdf1e=new Map(),{modelId:_0x582670,modelName:_0x4d6ec7,groupId:_0xb3040f,back:_0x539d02,status:_0x14fe92,page:page=0x1,size:size=0x14,saasId:_0x95d29d}=_0x114405,_0x3abb4e={'delFlag':![]};_0x1830e6?_0x3abb4e[_0x481f4c(0x1ea)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x481f4c(0x1ca)])(_0x1830e6),(0x0,typeorm_2[_0x481f4c(0x1e7)])()):_0x3abb4e[_0x481f4c(0x1ea)]=(0x0,typeorm_2[_0x481f4c(0x1e7)])();(0x0,utils_1[_0x481f4c(0x1f1)])(this[_0x481f4c(0x198)])?(0x0,utils_1[_0x481f4c(0x206)])(_0x95d29d)&&(_0x3abb4e[_0x481f4c(0x1d3)]=_0x95d29d):_0x3abb4e[_0x481f4c(0x1d3)]=_0x1c38f3;!_0x539d02?_0x3abb4e[_0x481f4c(0x1f7)]=0x1:(_0x14fe92!==undefined&&_0x14fe92!==null&&(_0x3abb4e[_0x481f4c(0x1f7)]=_0x14fe92),delete _0x3abb4e[_0x481f4c(0x1ea)]);_0x582670&&(_0x3abb4e['modelId']=_0x582670),_0xb3040f&&(_0x3abb4e[_0x481f4c(0x202)]=_0xb3040f),_0x4d6ec7&&(_0x3abb4e[_0x481f4c(0x1d8)]=(0x0,typeorm_2[_0x481f4c(0x1d5)])('%'+_0x4d6ec7+'%'));const [_0x2cbfcd,_0x246c87]=await this[_0x481f4c(0x1f3)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x3abb4e,'order':{'sortId':_0x481f4c(0x1ad)}});if(_0x2cbfcd[_0x481f4c(0x225)]){const _0x52c39a=[],_0x5c91d7=[];_0x2cbfcd[_0x481f4c(0x1b6)](_0x27e47e=>{const _0x27712b=_0x481f4c;_0x52c39a[_0x27712b(0x1cf)](_0x27e47e['id']),_0x5c91d7[_0x27712b(0x1cf)](_0x27e47e[_0x27712b(0x202)]);});if(_0x1830e6){const _0x5e82cb=await this[_0x481f4c(0x20d)]['find']({'where':{'userId':_0x1830e6,'appId':(0x0,typeorm_2['In'])(_0x52c39a)}});_0x5e82cb[_0x481f4c(0x1b6)](_0x2f088b=>_0x441a97[_0x481f4c(0x1f5)](_0x2f088b[_0x481f4c(0x1da)]));}const _0x17caf8=await this['gptsGroupEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5c91d7)}});_0x17caf8['forEach'](_0x4dd447=>_0x1cdf1e[_0x481f4c(0x20c)](_0x4dd447['id'],_0x4dd447));}return{'count':_0x246c87,'rows':_0x2cbfcd['map'](_0x135df1=>({..._0x135df1,'collected':_0x441a97[_0x481f4c(0x1b1)](_0x135df1['id']),'groupName':_0x1cdf1e[_0x481f4c(0x1db)](_0x135df1[_0x481f4c(0x202)])?.[_0x481f4c(0x1bc)]}))};}catch(_0x37f4df){console[_0x481f4c(0x1a1)](_0x481f4c(0x1a6),_0x37f4df);throw new common_1['HttpException'](_0x37f4df,common_1[_0x481f4c(0x21f)][_0x481f4c(0x19f)]);}}async[_0x320751(0x1a2)](_0x1dedeb,_0x4291cc){const _0x5452ca=_0x320751,_0x54f832=(0x0,utils_1[_0x5452ca(0x21d)])(this['clsService']),_0x47d5ed=(0x0,utils_1[_0x5452ca(0x228)])(this[_0x5452ca(0x198)]),_0x1f189e={'take':0x1e};if(_0x4291cc=='recommend')_0x1f189e[_0x5452ca(0x205)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x1f189e[_0x5452ca(0x200)]={'createdAt':_0x5452ca(0x1ad)};else{if(_0x4291cc===_0x5452ca(0x209))_0x1f189e[_0x5452ca(0x205)]={'status':0x1,'delFlag':![]},_0x1f189e[_0x5452ca(0x200)]={'useCount':_0x5452ca(0x1ad)};else{if(_0x4291cc===_0x5452ca(0x22e))_0x1f189e[_0x5452ca(0x205)]={'status':0x1,'delFlag':![]},_0x1f189e[_0x5452ca(0x200)]={'collectCount':_0x5452ca(0x1ad)};else{if(_0x4291cc==='mine'){if(!_0x54f832)throw new common_1[(_0x5452ca(0x1cb))]('请先登录！',common_1['HttpStatus'][_0x5452ca(0x1cc)]);_0x1f189e[_0x5452ca(0x205)]={'status':0x1,'delFlag':![],'userId':_0x54f832},_0x1f189e[_0x5452ca(0x200)]={'createdAt':_0x5452ca(0x1ad)};}else _0x1f189e[_0x5452ca(0x205)]={'status':0x1,'delFlag':![]},_0x1f189e['order']={'createdAt':_0x5452ca(0x1ad)};}}}_0x1f189e[_0x5452ca(0x205)][_0x5452ca(0x1d3)]=_0x47d5ed;const _0x1aae2c=await this[_0x5452ca(0x1f3)][_0x5452ca(0x1a3)](_0x1f189e),_0x49eeae=new Set(),_0x52ddb6=new Map(),_0x2f812d=new Map(),_0xcce6fb=[],_0x5c2f8a=[];_0x1aae2c[_0x5452ca(0x1b6)](_0x33c3b0=>{const _0x4df6f4=_0x5452ca;_0xcce6fb[_0x4df6f4(0x1cf)](_0x33c3b0['id']),_0x5c2f8a[_0x4df6f4(0x1cf)](_0x33c3b0['groupId']);});if(_0xcce6fb[_0x5452ca(0x225)]){if(_0x54f832){const _0x45dcbb=await this[_0x5452ca(0x20d)][_0x5452ca(0x1a3)]({'where':{'userId':_0x54f832,'appId':(0x0,typeorm_2['In'])(_0xcce6fb)}});_0x45dcbb[_0x5452ca(0x1b6)](_0x1eda41=>_0x49eeae[_0x5452ca(0x1f5)](_0x1eda41[_0x5452ca(0x1da)]));const _0x5d8014=await this[_0x5452ca(0x19e)][_0x5452ca(0x21c)](_0x54f832,_0xcce6fb);_0x5d8014['forEach'](_0xa4b6ea=>_0x52ddb6[_0x5452ca(0x20c)](_0xa4b6ea[_0x5452ca(0x1da)],_0xa4b6ea[_0x5452ca(0x235)]));}const _0x21214e=await this[_0x5452ca(0x22b)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5c2f8a)}});_0x21214e[_0x5452ca(0x1b6)](_0x40d186=>_0x2f812d[_0x5452ca(0x20c)](_0x40d186['id'],_0x40d186));}return _0x1aae2c[_0x5452ca(0x210)](_0x48ba33=>({..._0x48ba33,'collected':_0x49eeae[_0x5452ca(0x1b1)](_0x48ba33['id']),'lastTime':_0x52ddb6[_0x5452ca(0x1db)](_0x48ba33['id'])||null,'groupName':_0x2f812d['get'](_0x48ba33[_0x5452ca(0x202)])?.[_0x5452ca(0x1bc)]}));}async[_0x320751(0x1b4)](_0x4334ba){const _0x52523b=_0x320751;try{const {id:_0x3de3aa}=_0x4334ba,_0x3ce5b4=await this[_0x52523b(0x1f3)][_0x52523b(0x1fd)]({'where':{'id':_0x3de3aa}});if(!_0x3ce5b4)throw new common_1[(_0x52523b(0x1cb))](_0x52523b(0x21a),common_1[_0x52523b(0x21f)][_0x52523b(0x19f)]);return await this[_0x52523b(0x1f3)][_0x52523b(0x1c2)](_0x3de3aa)['then'](_0x50af11=>_0x50af11[_0x52523b(0x229)]>0x0)[_0x52523b(0x1d1)](_0x1fbf9b=>{throw new Error(_0x1fbf9b);});}catch(_0x5b9fbb){console['log'](_0x52523b(0x1a6),_0x5b9fbb);throw new common_1[(_0x52523b(0x1cb))](_0x5b9fbb,common_1[_0x52523b(0x21f)]['BAD_REQUEST']);}}async[_0x320751(0x1b7)](_0x2aeb78,_0x2516fe){const _0x168ca4=_0x320751,_0x507d99=_0x2aeb78['appId'],_0x3b35d4=_0x2516fe['user']['id'],_0x2b46d5=(0x0,utils_1['getReqSaasId'])(this[_0x168ca4(0x198)]);let _0x3e8646=null,_0x1d2c20={'title':_0x168ca4(0x19a),'userId':_0x3b35d4,'saasId':_0x2b46d5};try{_0x3e8646=await this[_0x168ca4(0x1f3)][_0x168ca4(0x1fd)]({'where':{'id':_0x507d99}});if(!_0x3e8646)throw new Error(_0x168ca4(0x230));if(_0x3e8646['status']!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');if(!_0x2aeb78[_0x168ca4(0x203)]){const _0xb613a7=await this[_0x168ca4(0x199)][_0x168ca4(0x20e)]({'where':{'modelId':_0x507d99,'userId':_0x3b35d4,'isDelete':![]}});if(_0xb613a7>0x0)throw new Error(_0x168ca4(0x22d));}_0x1d2c20[_0x168ca4(0x1a5)]=_0x3e8646['id'],_0x1d2c20[_0x168ca4(0x194)]=_0x3e8646[_0x168ca4(0x1a5)],_0x1d2c20['groupId']=_0x3e8646[_0x168ca4(0x202)],_0x1d2c20[_0x168ca4(0x207)]=_0x3e8646[_0x168ca4(0x207)]||'',_0x1d2c20['logo']=_0x3e8646['logo']||'',_0x1d2c20[_0x168ca4(0x213)]=_0x2aeb78['hasHistory']?'新对话':_0x3e8646[_0x168ca4(0x1d8)],_0x1d2c20[_0x168ca4(0x1f4)]=_0x3e8646[_0x168ca4(0x1f4)]||'';let _0x72565b=await this[_0x168ca4(0x1af)][_0x168ca4(0x1f6)](model_constant_1[_0x168ca4(0x1dd)][_0x168ca4(0x1ed)]);_0x72565b[_0x168ca4(0x1e4)][_0x168ca4(0x215)]=_0x3e8646[_0x168ca4(0x215)],_0x72565b[_0x168ca4(0x1e4)][_0x168ca4(0x1d8)]=_0x3e8646[_0x168ca4(0x1d8)],_0x72565b[_0x168ca4(0x1e4)][_0x168ca4(0x1c8)]=_0x3e8646['canUpload'];_0x3e8646['gptsApp']?_0x72565b[_0x168ca4(0x1e4)][_0x168ca4(0x194)]=_0x3e8646['modelId']:_0x72565b[_0x168ca4(0x1e4)][_0x168ca4(0x194)]=_0x3e8646[_0x168ca4(0x1c5)];_0x1d2c20['config']=JSON[_0x168ca4(0x208)](_0x72565b);const _0x4e03c3=await this['gptsChatEntity']['save'](_0x1d2c20);return _0x3e8646&&(_0x3e8646[_0x168ca4(0x219)]=_0x3e8646['useCount']+Math['ceil'](Math[_0x168ca4(0x1d9)]()*0xa),await this[_0x168ca4(0x1f3)]['save'](_0x3e8646)),_0x4e03c3;}catch(_0x3623b4){throw new common_1['HttpException'](_0x3623b4[_0x168ca4(0x224)],common_1[_0x168ca4(0x21f)][_0x168ca4(0x19f)]);}}async[_0x320751(0x1f8)](_0x418507){const _0xa5bc6f=_0x320751,_0x109418=await this[_0xa5bc6f(0x1ec)]['query'](model_constant_1[_0xa5bc6f(0x1dd)][_0xa5bc6f(0x212)],_0x418507),_0x2f69d7=await this['handleGetChat'](_0x418507),_0x366e44=[];for(const _0x2757b0 of _0x109418){_0x366e44[_0xa5bc6f(0x1cf)]({'id':_0x2757b0['id'],'config':_0x2757b0[_0xa5bc6f(0x226)],'createdAt':_0x2757b0[_0xa5bc6f(0x235)],'lastMessage':_0x2757b0[_0xa5bc6f(0x1be)],'modelType':_0xa5bc6f(0x221),'title':_0x2757b0[_0xa5bc6f(0x213)],'updatedAt':_0x2757b0[_0xa5bc6f(0x1ef)],'isSticky':_0x2757b0['isSticky'],'appId':_0x2757b0[_0xa5bc6f(0x1da)],'logo':'','desc':''});}for(const _0x1bae45 of _0x2f69d7){_0x366e44['push']({'id':_0x1bae45['id'],'config':_0x1bae45['config'],'createdAt':_0x1bae45[_0xa5bc6f(0x235)],'logo':_0x1bae45[_0xa5bc6f(0x1c0)],'lastMessage':_0x1bae45[_0xa5bc6f(0x1be)],'desc':_0x1bae45[_0xa5bc6f(0x207)],'modelId':_0x1bae45['modelId'],'modelType':_0xa5bc6f(0x1de),'title':_0x1bae45[_0xa5bc6f(0x213)],'updatedAt':_0x1bae45[_0xa5bc6f(0x1ef)],'isSticky':_0x1bae45[_0xa5bc6f(0x1eb)]});}return _0x366e44[_0xa5bc6f(0x1ff)]((_0x4b2793,_0x5854cd)=>{const _0xc17206=_0xa5bc6f;if(_0x4b2793[_0xc17206(0x1eb)]!==_0x5854cd['isSticky'])return _0x5854cd['isSticky']-_0x4b2793[_0xc17206(0x1eb)];return _0x5854cd[_0xc17206(0x1ef)]-_0x4b2793[_0xc17206(0x1ef)];}),_0x366e44;}async['handleGetChat'](_0x1ee3d0,_0x1ce4c8){const _0xba7d59=_0x320751;try{const _0x373a72=_0x1ee3d0[_0xba7d59(0x1e9)]['id'],_0x3cf5f9={'userId':_0x373a72,'isDelete':![]};_0x1ce4c8&&(_0x3cf5f9['modelId']=_0x1ce4c8);let _0x54285f=[];_0x1ce4c8?_0x54285f=await this[_0xba7d59(0x199)][_0xba7d59(0x1a3)]({'where':_0x3cf5f9,'order':{'isSticky':_0xba7d59(0x1ad),'updatedAt':_0xba7d59(0x1ad)}}):_0x54285f=await this['gptsChatEntity'][_0xba7d59(0x1bd)]()['where'](_0x3cf5f9)[_0xba7d59(0x1ac)](_0xba7d59(0x1a5))['orderBy']({'isSticky':'DESC','updatedAt':_0xba7d59(0x1ad)})[_0xba7d59(0x1d6)]();const _0x30db95=new Set(),_0x10ad85=new Map(),_0x2b147a=new Map(),_0x456630=[],_0x5cd04e=[];_0x54285f[_0xba7d59(0x1b6)](_0x2c539a=>{const _0x5c6a13=_0xba7d59;_0x456630[_0x5c6a13(0x1cf)](_0x2c539a[_0x5c6a13(0x1a5)]),_0x5cd04e[_0x5c6a13(0x1cf)](_0x2c539a[_0x5c6a13(0x202)]);});if(_0x456630[_0xba7d59(0x225)]){const _0x450186=await this[_0xba7d59(0x20d)]['find']({'where':{'userId':_0x373a72,'appId':(0x0,typeorm_2['In'])(_0x456630)}});_0x450186['forEach'](_0x2e3e03=>_0x30db95[_0xba7d59(0x1f5)](_0x2e3e03[_0xba7d59(0x1da)]));const _0x8f2862=await this['gptsModelEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x456630),'status':0x1,'delFlag':![]}});_0x8f2862[_0xba7d59(0x1b6)](_0x2dd69a=>_0x10ad85[_0xba7d59(0x20c)](_0x2dd69a['id'],_0x2dd69a));const _0x3d1ebc=await this[_0xba7d59(0x22b)][_0xba7d59(0x1a3)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5cd04e)}});_0x3d1ebc['forEach'](_0x4ef943=>_0x2b147a[_0xba7d59(0x20c)](_0x4ef943['id'],_0x4ef943));}return _0x54285f['map'](_0x294548=>{const _0x3be162=_0xba7d59,_0x11fba1=_0x10ad85[_0x3be162(0x1db)](_0x294548[_0x3be162(0x1a5)]);if(_0x11fba1?.['gptsApp']){const _0x394510=JSON['parse'](_0x294548[_0x3be162(0x226)]);_0x394510[_0x3be162(0x1e4)]['model']=_0x11fba1[_0x3be162(0x1a5)],_0x294548[_0x3be162(0x226)]=JSON[_0x3be162(0x208)](_0x394510);}return{..._0x294548,'modelName':_0x11fba1?.[_0x3be162(0x1d8)]||_0x294548['title'],'gptsApp':_0x11fba1?.[_0x3be162(0x231)],'customParams':_0x11fba1?.[_0x3be162(0x1ae)],'customConfig':_0x11fba1?.[_0x3be162(0x226)],'collected':_0x30db95[_0x3be162(0x1b1)](_0x294548['modelId']),'groupName':_0x2b147a[_0x3be162(0x1db)](_0x294548[_0x3be162(0x202)])?.['groupName']};});}catch(_0x2a88ec){console[_0xba7d59(0x1a1)](_0xba7d59(0x1a6),_0x2a88ec);throw new common_1['HttpException'](_0x2a88ec,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x320751(0x22c)](_0x34cd0d,_0x3f5f00){const _0x583311=_0x320751,{title:_0x2c6e4c,isSticky:_0x2fdbe4,groupId:_0x520cf2,config:_0x317028}=_0x34cd0d,{id:_0x43b187}=_0x3f5f00[_0x583311(0x1e9)],_0x45d302=await this[_0x583311(0x199)][_0x583311(0x1fd)]({'where':{'id':_0x520cf2,'userId':_0x43b187}});if(!_0x45d302)throw new common_1[(_0x583311(0x1cb))](_0x583311(0x217),common_1[_0x583311(0x21f)][_0x583311(0x19f)]);const _0x53a9a1={};_0x53a9a1[_0x583311(0x213)]=_0x2c6e4c||_0x45d302[_0x583311(0x213)],_0x53a9a1['config']=_0x317028||_0x45d302[_0x583311(0x226)],_0x53a9a1['isSticky']=_0x2fdbe4??_0x45d302['isSticky'];const _0x4f40ee=await this[_0x583311(0x199)][_0x583311(0x211)]({'id':_0x520cf2},_0x53a9a1);if(_0x4f40ee[_0x583311(0x229)])return!![];else throw new common_1['HttpException'](_0x583311(0x1e3),common_1[_0x583311(0x21f)][_0x583311(0x19f)]);}async[_0x320751(0x1aa)](_0x2a2721,_0x811f2c){const _0x5e5588=_0x320751;try{const {groupId:_0x2c3bc5}=_0x2a2721,{id:_0x444acc}=_0x811f2c[_0x5e5588(0x1e9)],_0x2b7021=await this[_0x5e5588(0x199)][_0x5e5588(0x1fd)]({'where':{'id':_0x2c3bc5,'userId':_0x444acc}})[_0x5e5588(0x1d1)](_0x3e79a3=>{const _0x2378dc=_0x5e5588;common_1[_0x2378dc(0x196)]['error'](_0x3e79a3);throw new Error(_0x3e79a3);});if(!_0x2b7021)throw new Error(_0x5e5588(0x1c4));await this[_0x5e5588(0x19e)]['removeLogsBatch']({'userId':_0x444acc,'ids':[_0x2c3bc5]})['catch'](_0x24b4af=>{throw new Error(_0x24b4af);});const _0x4e825c=await this[_0x5e5588(0x199)][_0x5e5588(0x1c2)]({'id':_0x2c3bc5})['catch'](_0x3ae290=>{throw new Error(_0x3ae290);});if(!_0x4e825c)throw new Error('删除失败！');return!![];}catch(_0x27aece){throw new common_1[(_0x5e5588(0x1cb))](_0x27aece,common_1[_0x5e5588(0x21f)]['BAD_REQUEST']);}}async['delAllGptsChat'](_0x5c1053){const _0x1f3c97=_0x320751;try{const {id:_0xd19ed6}=_0x5c1053[_0x1f3c97(0x1e9)],_0x2d1ebf=await this[_0x1f3c97(0x199)][_0x1f3c97(0x1a3)]({'where':{'userId':_0xd19ed6}})['catch'](_0x55cdd1=>{const _0x511461=_0x1f3c97;common_1[_0x511461(0x196)][_0x511461(0x19d)](_0x55cdd1);throw new Error(_0x55cdd1);});if(!_0x2d1ebf||_0x2d1ebf[_0x1f3c97(0x225)]===0x0)throw new Error(_0x1f3c97(0x1fe));const _0x185b6d=_0x2d1ebf[_0x1f3c97(0x210)](_0x29b9df=>_0x29b9df[_0x1f3c97(0x202)]);await this[_0x1f3c97(0x19e)][_0x1f3c97(0x1e0)]({'ids':_0x185b6d,'userId':_0xd19ed6})[_0x1f3c97(0x1d1)](_0x550e52=>{throw new Error(_0x550e52);});const _0x54cbbe=await this[_0x1f3c97(0x199)][_0x1f3c97(0x1c2)]({'userId':_0xd19ed6,'isSticky':![]})[_0x1f3c97(0x1d1)](_0xf33ab4=>{throw new Error(_0xf33ab4);});if(!_0x54cbbe)throw new Error(_0x1f3c97(0x21e));return!![];}catch(_0x3ace09){throw new common_1[(_0x1f3c97(0x1cb))](_0x3ace09,common_1['HttpStatus'][_0x1f3c97(0x19f)]);}}async[_0x320751(0x1fa)](_0x365c9b){const _0x42b3a2=_0x320751;return await this[_0x42b3a2(0x199)]['findOne']({'where':{'id':_0x365c9b}});}async[_0x320751(0x1e2)](_0x128258){const _0x516579=_0x320751,_0x4c19bf=await this['gptsChatEntity'][_0x516579(0x1fd)]({'where':{'id':_0x128258}}),_0x2c1221=await this['gptsModelEntity'][_0x516579(0x1fd)]({'where':{'id':_0x4c19bf[_0x516579(0x1a5)]}}),_0x437aec=await this[_0x516579(0x1af)][_0x516579(0x1e1)](model_constant_1[_0x516579(0x1dd)][_0x516579(0x1ed)]);return _0x437aec[_0x516579(0x1d8)]=_0x2c1221[_0x516579(0x1d8)],_0x437aec[_0x516579(0x194)]=_0x2c1221[_0x516579(0x1a5)]||_0x2c1221[_0x516579(0x1c5)],_0x437aec;}async[_0x320751(0x227)](_0x41ae3,_0x584896){const _0x448d2a=_0x320751;await this['gptsGroupEntity'][_0x448d2a(0x1bd)]()['update'](gpts_group_entity_1[_0x448d2a(0x222)])[_0x448d2a(0x20c)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x448d2a(0x1b9)+_0x584896})['where'](_0x448d2a(0x1e8),{'id':_0x41ae3})[_0x448d2a(0x1f0)]();}async[_0x320751(0x1f9)](_0x3278aa,_0xb802d3){const _0x218fa8=_0x320751,_0x4301b4={'id':_0x3278aa};return _0xb802d3!=null&&_0xb802d3!==undefined&&(_0x4301b4[_0x218fa8(0x1f7)]=_0xb802d3),this[_0x218fa8(0x1f3)][_0x218fa8(0x1fd)]({'where':_0x4301b4});}async[_0x320751(0x22a)](_0x5587bf,_0x54b8c9,_0x344631){const _0x2bea7a=_0x320751,_0x202d74={'id':_0x54b8c9};_0x344631!=null&&_0x344631!==undefined&&(_0x202d74['status']=_0x344631);const _0xd7dbbd=await this[_0x2bea7a(0x1f3)][_0x2bea7a(0x1fd)]({'where':_0x202d74});if(_0x5587bf['user']){const _0x4ef8d2=await this[_0x2bea7a(0x20d)][_0x2bea7a(0x1fd)]({'where':{'userId':_0x5587bf[_0x2bea7a(0x1e9)]['id'],'appId':_0x54b8c9}});if(_0x4ef8d2)return{..._0xd7dbbd,'collected':!![]};}return{..._0xd7dbbd,'collected':![]};}async[_0x320751(0x192)](_0x334ea6){const _0x5911de=_0x320751;if(!_0x334ea6)throw new common_1['HttpException'](_0x5911de(0x193),common_1['HttpStatus']['BAD_REQUEST']);return await this['gptsModelEntity'][_0x5911de(0x1fd)]({'where':{'id':_0x334ea6}});}};GptsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x320751(0x232)])(userApps_entity_1[_0x320751(0x234)])),__param(0x1,(0x0,typeorm_1[_0x320751(0x232)])(gpts_group_entity_1[_0x320751(0x222)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(gpts_model_entity_1[_0x320751(0x1ce)])),__param(0x3,(0x0,typeorm_1[_0x320751(0x232)])(gpts_chat_entity_1['GptsChatEntity'])),__metadata(_0x320751(0x1ee),[typeorm_2[_0x320751(0x20b)],typeorm_2[_0x320751(0x20b)],typeorm_2[_0x320751(0x20b)],typeorm_2['Repository'],nestjs_cls_1[_0x320751(0x20a)],models_service_1['ModelsService'],chatLog_service_1[_0x320751(0x1c7)],chatGroup_service_1[_0x320751(0x201)]])],GptsService),exports[_0x320751(0x1c3)]=GptsService;function _0x1bc9(){const _0x49c7bb=['catch','2426380TMpyHC','saasId','模型组不存在！','Like','getMany','handleUpdateGroup','modelName','random','appId','get','decorate','EModelType','gpt','689394EOOXVu','removeLogsBatch','getRandomKey','getCurrentModelByChatGroupId','更新对话失败！','modelInfo','object','assign','IsNull','id\x20=\x20:id','user','userId','isSticky','chatGroupService','APP','design:paramtypes','updatedAt','execute','isPlatform','../../common/constants/model.constant','gptsModelEntity','demoData','add','getModelByType','status','getWithChat','getAppById','getGroupInfoFromId','getOwnPropertyDescriptor','handleQueryGpts','findOne','当前用户没有创建GPT对话！','sort','order','ChatGroupService','groupId','hasHistory','handleAddGpts','where','isDefined','desc','stringify','popular','ClsService','Repository','set','userAppsEntity','count','862WQHWnB','map','update','CHAT','title','5422670sYlbtc','canAudio','then','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','../models/models.service','useCount','gpts不存在,无法删除！','getExistGpts','getLastByUserAndAppIds','getUserId','清空失败！','HttpStatus','8PmRaIY','chat','GptsGroupEntity','./gpts.model.entity','message','length','config','saveGptsUseLog','getReqSaasId','affected','getAppByIdWithCollect','gptsGroupEntity','updateGptsChat','当前应用已经开启了一个对话无需新建了！','favorite','../chatGroup/chatGroup.service','非法操作、您在使用一个不存在的应用！','gptsApp','InjectRepository','defineProperty','UserAppsEntity','createdAt','6uxMzcu','3pLWINt','getAppModel','缺失必要参数！','model','handleAddGroup','Logger','collectCount','clsService','gptsChatEntity','新对话','typeorm','nestjs-cls','error','chatLogService','BAD_REQUEST','2539960JwTKxj','log','listByFrontType','find','function','modelId','error:\x20','./gpts.group.entity','__decorate','1008981UjbFqF','delGptsChat','__esModule','groupBy','DESC','customParams','modelsService','fingerprint','has','模型不存在！','save','handleRemoveGpts','includes','forEach','handleCreateChat','../../common/utils','useToken\x20+\x20','当前分类存在应用,不允许删除！','应用类型不可更改！','groupName','createQueryBuilder','lastMessage','应用分类不存在,无法删除！','logo','分类已存在！','delete','GptsService','非法操作、您在删除一个非法资源！','relModel','3898846yEYkeb','ChatLogService','canUpload','headers','Equal','HttpException','UNAUTHORIZED','metadata','GptsModelEntity','push','__param'];_0x1bc9=function(){return _0x49c7bb;};return _0x1bc9();}