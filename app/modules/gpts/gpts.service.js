'use strict';const _0x497a51=_0x6a9d;(function(_0x4429b7,_0xf27ed8){const _0x4ac2c1=_0x6a9d,_0x519d38=_0x4429b7();while(!![]){try{const _0x4e6864=-parseInt(_0x4ac2c1(0xfe))/0x1+-parseInt(_0x4ac2c1(0x13d))/0x2*(-parseInt(_0x4ac2c1(0xe8))/0x3)+parseInt(_0x4ac2c1(0x10d))/0x4+-parseInt(_0x4ac2c1(0xd9))/0x5+-parseInt(_0x4ac2c1(0x121))/0x6*(parseInt(_0x4ac2c1(0x169))/0x7)+parseInt(_0x4ac2c1(0xec))/0x8+-parseInt(_0x4ac2c1(0x10f))/0x9*(-parseInt(_0x4ac2c1(0x152))/0xa);if(_0x4e6864===_0xf27ed8)break;else _0x519d38['push'](_0x519d38['shift']());}catch(_0x59e3d7){_0x519d38['push'](_0x519d38['shift']());}}}(_0x5b1b,0xd84d7));function _0x6a9d(_0x7e7457,_0x170121){const _0x5b1bf7=_0x5b1b();return _0x6a9d=function(_0x6a9d7e,_0x20a74a){_0x6a9d7e=_0x6a9d7e-0xd3;let _0x1518ec=_0x5b1bf7[_0x6a9d7e];return _0x1518ec;},_0x6a9d(_0x7e7457,_0x170121);}function _0x5b1b(){const _0x54af8e=['where','UserAppsEntity','DESC','EModelType','object','random','status','push','__decorate','message','title','groupName','1592376ScatQh','verify','189MuKyTS','jsonwebtoken','GptsService','BAD_REQUEST','getRandomKey','./gpts.chat.entity','popular','getGroupInfoFromId','useCount\x20+\x201','./gpts.model.entity','createdAt','log','模型不存在！','find','模型组不存在！','update','ceil','metadata','2078502bgTSXt','handleQueryGpts','handleUpdateGroup','affected','useCount','更新对话失败！','favorite','GptsChatEntity','APP','length','gpts不存在,无法删除！','@nestjs/common','JWT_SECRET','canAudio','includes','GptsGroupEntity','__esModule','stringify','map','hideString','清空失败！','appId','modelsService','config','../chatLog/chatLog.service','removeLogsBatch','findOne','gptsModelEntity','30LXqUew','modelInfo','@nestjs/typeorm','ChatLogService','UNAUTHORIZED','key','./gpts.group.entity','get','handleQueryGroup','split','desc','function','应用分类不存在,无法删除！','getOwnPropertyDescriptor','findAndCount','modelName','user','handleCreateChat','Repository','HttpStatus','defineProperty','970330CSyQQo','当前分类存在应用,不允许删除！','authorization','headers','mine','chatLogService','then','非法操作、您在使用一个不存在的应用！','updateGptsChat','error:\x20','super','Injectable','gptsGroupEntity','__metadata','分类已存在！','createQueryBuilder','应用分类不存在！','ModelsService','env','delete','delAllGptsChat','handleAddGpts','InjectRepository','14QuKYZX','fingerprint','应用类型不可更改！','../../common/constants/model.constant','relModel','catch','model','handleGetGroup','userId','canUpload','7981620jpiOzJ','Like','error','handleGetChat','getExistGpts','demoData','gptsChatEntity','add','forEach','getAppById','filter','modelId','groupId','getModelByType','set','217089AJkzIb','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','userAppsEntity','__param','1331456tvtJir','IsNull','当前用户没有创建GPT对话！','Equal','gptsApp','handleAddGroup','logo','delGptsChat','assign','has','save','getLastByUserAndAppIds','删除失败！','HttpException','Logger','handleRemoveGroup','isSticky','非法操作、您在删除一个非法资源！','512531HPnFuB','order','getCurrentModelByChatGroupId'];_0x5b1b=function(){return _0x54af8e;};return _0x5b1b();}var __decorate=this&&this[_0x497a51(0x109)]||function(_0x412e87,_0x151369,_0x10c7f7,_0x19322b){const _0x16e5d1=_0x497a51;var _0x11da66=arguments[_0x16e5d1(0x12a)],_0x5b9ad4=_0x11da66<0x3?_0x151369:_0x19322b===null?_0x19322b=Object[_0x16e5d1(0x14a)](_0x151369,_0x10c7f7):_0x19322b,_0xa5739a;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x16e5d1(0x148))_0x5b9ad4=Reflect['decorate'](_0x412e87,_0x151369,_0x10c7f7,_0x19322b);else{for(var _0x344a9d=_0x412e87[_0x16e5d1(0x12a)]-0x1;_0x344a9d>=0x0;_0x344a9d--)if(_0xa5739a=_0x412e87[_0x344a9d])_0x5b9ad4=(_0x11da66<0x3?_0xa5739a(_0x5b9ad4):_0x11da66>0x3?_0xa5739a(_0x151369,_0x10c7f7,_0x5b9ad4):_0xa5739a(_0x151369,_0x10c7f7))||_0x5b9ad4;}return _0x11da66>0x3&&_0x5b9ad4&&Object[_0x16e5d1(0x151)](_0x151369,_0x10c7f7,_0x5b9ad4),_0x5b9ad4;},__metadata=this&&this[_0x497a51(0x15f)]||function(_0xab5d02,_0x5a60cb){const _0x37613d=_0x497a51;if(typeof Reflect===_0x37613d(0x105)&&typeof Reflect[_0x37613d(0x120)]===_0x37613d(0x148))return Reflect[_0x37613d(0x120)](_0xab5d02,_0x5a60cb);},__param=this&&this[_0x497a51(0xeb)]||function(_0x3211ec,_0x2b22b1){return function(_0x2fa5c5,_0xd890e4){_0x2b22b1(_0x2fa5c5,_0xd890e4,_0x3211ec);};};Object[_0x497a51(0x151)](exports,_0x497a51(0x131),{'value':!![]}),exports[_0x497a51(0x111)]=void 0x0;const common_1=require(_0x497a51(0x12c)),typeorm_1=require(_0x497a51(0x13f)),gpts_group_entity_1=require(_0x497a51(0x143)),typeorm_2=require('typeorm'),gpts_model_entity_1=require(_0x497a51(0x118)),jwt=require(_0x497a51(0x110)),gpts_chat_entity_1=require(_0x497a51(0x114)),chatLog_service_1=require(_0x497a51(0x139)),utils_1=require('../../common/utils'),models_service_1=require('../models/models.service'),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x497a51(0x16c));let GptsService=class GptsService{constructor(_0x249829,_0x2ad301,_0x2a22b8,_0x10fafe,_0x2c6e08,_0x40d169){const _0x306e45=_0x497a51;this[_0x306e45(0xea)]=_0x249829,this[_0x306e45(0x15e)]=_0x2ad301,this[_0x306e45(0x13c)]=_0x2a22b8,this[_0x306e45(0xdf)]=_0x10fafe,this[_0x306e45(0x137)]=_0x2c6e08,this[_0x306e45(0x157)]=_0x40d169;}async[_0x497a51(0xf1)](_0x1d803f){const _0xfc9acd=_0x497a51;try{const _0xcc90eb=_0x1d803f[_0xfc9acd(0x10c)],_0x3d23e7=await this['gptsGroupEntity'][_0xfc9acd(0x13b)]({'where':{'groupName':_0xcc90eb}});if(_0x3d23e7)throw new common_1['HttpException'](_0xfc9acd(0x160),common_1[_0xfc9acd(0x150)][_0xfc9acd(0x112)]);return await this[_0xfc9acd(0x15e)][_0xfc9acd(0xf6)](_0x1d803f),!![];}catch(_0x44efd7){throw new common_1[(_0xfc9acd(0xf9))](_0x44efd7[_0xfc9acd(0x10a)],common_1[_0xfc9acd(0x150)][_0xfc9acd(0x112)]);}}async[_0x497a51(0x123)](_0xbe13d1){const _0x5c3de8=_0x497a51;try{const _0x23340a=await this[_0x5c3de8(0x15e)]['findOne']({'where':{'id':_0xbe13d1['id']}});if(!_0x23340a)throw new common_1['HttpException'](_0x5c3de8(0x11d),common_1[_0x5c3de8(0x150)][_0x5c3de8(0x112)]);return await this[_0x5c3de8(0x15e)][_0x5c3de8(0x11e)]({'id':_0xbe13d1['id']},_0xbe13d1),!![];}catch(_0x3b6e85){throw new common_1[(_0x5c3de8(0xf9))](_0x3b6e85[_0x5c3de8(0x10a)],common_1[_0x5c3de8(0x150)][_0x5c3de8(0x112)]);}}async[_0x497a51(0xfb)](_0x37d79c){const _0x57c787=_0x497a51;try{const _0x4faefc=_0x37d79c['id'],_0x2f76f9=await this[_0x57c787(0x15e)][_0x57c787(0x13b)]({'where':{'id':_0x4faefc}});if(!_0x2f76f9)throw new common_1[(_0x57c787(0xf9))](_0x57c787(0x149),common_1[_0x57c787(0x150)][_0x57c787(0x112)]);const _0x5c5b73=await this[_0x57c787(0x13c)]['count']({'where':{'groupId':_0x2f76f9['id']}});if(_0x5c5b73>0x0)throw new common_1[(_0x57c787(0xf9))](_0x57c787(0x153),common_1['HttpStatus'][_0x57c787(0x112)]);else await this[_0x57c787(0x15e)][_0x57c787(0x165)]({'id':_0x4faefc});}catch(_0x1c4d1e){throw new common_1[(_0x57c787(0xf9))](_0x1c4d1e[_0x57c787(0x10a)],common_1[_0x57c787(0x150)][_0x57c787(0x112)]);}}async[_0x497a51(0x145)](_0x4e128f,_0x1e07a2){const _0x5ad08d=_0x497a51;try{let _0x5ba37c=![];if(_0x1e07a2[_0x5ad08d(0x155)][_0x5ad08d(0x154)]){const _0xe38711=_0x1e07a2[_0x5ad08d(0x155)][_0x5ad08d(0x154)][_0x5ad08d(0x146)]('\x20'),_0x52613f=jwt[_0x5ad08d(0x10e)](_0xe38711[0x1],process[_0x5ad08d(0x164)]['JWT_SECRET']);_0x5ba37c=_0x52613f['role']===_0x5ad08d(0x15c);}const {groupName:_0x447dbd,page:page=0x1,status:_0x37b43f,size:size=0x14}=_0x4e128f,_0x58582e={};return _0x447dbd&&(_0x58582e['groupName']=_0x447dbd),_0x37b43f>=0x0&&(_0x58582e[_0x5ad08d(0x107)]=_0x37b43f),await this[_0x5ad08d(0x15e)][_0x5ad08d(0x14b)]({'where':_0x58582e,'skip':(page-0x1)*size,'take':size,'order':{'weight':'DESC','id':_0x5ad08d(0x103)}})[_0x5ad08d(0x158)](([_0x77028f,_0x315afb])=>({'rows':_0x77028f[_0x5ad08d(0x133)](_0x144dd0=>{const _0x2acf50=_0x5ad08d;return{..._0x144dd0,'key':_0x5ba37c?_0x144dd0[_0x2acf50(0x142)]:(0x0,utils_1['hideString'])(_0x144dd0['key'])};}),'count':_0x315afb}))[_0x5ad08d(0xd4)](_0x16779b=>{throw new Error(_0x16779b);});}catch(_0xd783ad){console[_0x5ad08d(0x11a)](_0x5ad08d(0x15b),_0xd783ad);throw new common_1[(_0x5ad08d(0xf9))](_0xd783ad,common_1[_0x5ad08d(0x150)]['BAD_REQUEST']);}}async[_0x497a51(0xd6)](_0x2c7437,_0x57b7ce){const _0x181d3a=_0x497a51;try{const _0x151764=_0x57b7ce[_0x181d3a(0x14d)]['role'],_0x3ca85e=_0x151764===_0x181d3a(0x15c),{groupId:_0x4673d0}=_0x2c7437;return await this[_0x181d3a(0x15e)][_0x181d3a(0x13b)]({'where':{'id':Number(_0x4673d0)}})[_0x181d3a(0x158)](_0x2d3fa2=>{const _0x40c839=_0x181d3a;return{..._0x2d3fa2,'key':_0x3ca85e?_0x2d3fa2[_0x40c839(0x142)]:(0x0,utils_1[_0x40c839(0x134)])(_0x2d3fa2[_0x40c839(0x142)])};})[_0x181d3a(0xd4)](_0x127bfd=>{throw new Error(_0x127bfd);});}catch(_0x35e9e1){console['log'](_0x181d3a(0x15b),_0x35e9e1);throw new common_1[(_0x181d3a(0xf9))](_0x35e9e1,common_1[_0x181d3a(0x150)][_0x181d3a(0x112)]);}}async[_0x497a51(0x167)](_0x3d7db9,_0x1ceb9b){const _0x57851f=_0x497a51;try{const _0x20cfb0=_0x3d7db9['user']['id'],_0x3ffc1f=Object[_0x57851f(0xf4)](new gpts_model_entity_1['GptsModelEntity'](),_0x1ceb9b);_0x3ffc1f[_0x57851f(0x107)]=Number(_0x1ceb9b[_0x57851f(0x107)]);if(_0x3ffc1f['id']){const _0x3c75fd=await this[_0x57851f(0x13c)][_0x57851f(0x13b)]({'where':{'id':_0x3ffc1f['id']}});if(!_0x3c75fd)throw new common_1[(_0x57851f(0xf9))](_0x57851f(0x11b),common_1['HttpStatus'][_0x57851f(0x112)]);if(_0x3c75fd[_0x57851f(0xf0)]!==_0x3ffc1f['gptsApp'])throw new common_1[(_0x57851f(0xf9))](_0x57851f(0x16b),common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x57851f(0x13c)][_0x57851f(0x11e)]({'id':_0x3ffc1f['id']},{..._0x3ffc1f,'useCount':_0x3ffc1f[_0x57851f(0x125)]??_0x3c75fd[_0x57851f(0x125)],'collectCount':_0x3ffc1f['collectCount']??_0x3c75fd['collectCount']})[_0x57851f(0x158)](_0xcd56d4=>_0xcd56d4[_0x57851f(0x124)]>0x0)['catch'](_0x380b67=>{throw new Error(_0x380b67);});}else{const _0x4f04c4=await this[_0x57851f(0x15e)][_0x57851f(0x13b)]({'where':{'id':_0x3ffc1f[_0x57851f(0xe5)]}});if(!_0x4f04c4)throw new common_1[(_0x57851f(0xf9))](_0x57851f(0x162),common_1[_0x57851f(0x150)][_0x57851f(0x112)]);return await this['gptsModelEntity'][_0x57851f(0xf6)]({..._0x3ffc1f,'userId':_0x3d7db9[_0x57851f(0x155)][_0x57851f(0x16a)]?_0x20cfb0:null})[_0x57851f(0x158)](_0x4be164=>!!_0x4be164)[_0x57851f(0xd4)](_0x41e17b=>{throw new Error(_0x41e17b);});}}catch(_0x5887b6){throw new common_1[(_0x57851f(0xf9))](_0x5887b6,common_1[_0x57851f(0x150)][_0x57851f(0x112)]);}}async[_0x497a51(0xdd)](){const _0x15b9db=_0x497a51;return await this['gptsModelEntity']['find']()[_0x15b9db(0x158)](_0x7d6791=>_0x7d6791['map'](_0x55c810=>_0x55c810['modelName']));}async['handleAddGptsBatch'](_0xc8c483){const _0x3985bf=_0x497a51;try{const _0x159274=await this[_0x3985bf(0xdd)](),_0x39cdd8=_0xc8c483[_0x3985bf(0xe3)](_0x3c09a3=>!_0x159274[_0x3985bf(0x12f)](_0x3c09a3[_0x3985bf(0x14c)]))[_0x3985bf(0x133)](_0x4d10ff=>({'groupId':_0x4d10ff[_0x3985bf(0xe5)],'relModel':_0x4d10ff['relModel'],'logo':_0x4d10ff[_0x3985bf(0xf2)],'desc':_0x4d10ff['desc'],'modelName':_0x4d10ff['modelName'],'modelId':_0x4d10ff[_0x3985bf(0xe4)]}));return await this['gptsModelEntity'][_0x3985bf(0xf6)](_0x39cdd8)['catch'](_0x598dc4=>{throw new Error(_0x598dc4);});}catch(_0x37e463){console[_0x3985bf(0x11a)](_0x3985bf(0x15b),_0x37e463);throw new common_1[(_0x3985bf(0xf9))](_0x37e463,common_1['HttpStatus'][_0x3985bf(0x112)]);}}async[_0x497a51(0x122)](_0x3a5e64,_0x3de665){const _0x3544cb=_0x497a51;try{let _0x32eb1f;const _0x1c5694=new Set(),_0x281ed8=new Map();if(_0x3de665[_0x3544cb(0x155)][_0x3544cb(0x154)]){const _0x704fe4=_0x3de665[_0x3544cb(0x155)]['authorization'][_0x3544cb(0x146)]('\x20'),_0x39a3f6=jwt['verify'](_0x704fe4[0x1],process[_0x3544cb(0x164)][_0x3544cb(0x12d)]);_0x32eb1f=_0x39a3f6['id'];}const {modelId:_0x6482b7,modelName:_0x23693b,groupId:_0x5ed576,back:_0x130363,status:_0x35d81e,page:_0x449e60,size:_0x4d1a46}=_0x3a5e64,_0x525b09={'delFlag':![]};_0x32eb1f?_0x525b09['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x3544cb(0xef)])(_0x32eb1f),(0x0,typeorm_2[_0x3544cb(0xed)])()):_0x525b09[_0x3544cb(0xd7)]=(0x0,typeorm_2[_0x3544cb(0xed)])();!_0x130363?_0x525b09['status']=0x1:(_0x35d81e!==undefined&&(_0x525b09[_0x3544cb(0x107)]=_0x35d81e),delete _0x525b09['userId']);_0x6482b7&&(_0x525b09[_0x3544cb(0xe4)]=_0x6482b7),_0x5ed576&&(_0x525b09[_0x3544cb(0xe5)]=_0x5ed576),_0x23693b&&(_0x525b09[_0x3544cb(0x14c)]=(0x0,typeorm_2[_0x3544cb(0xda)])('%'+_0x23693b+'%'));const [_0x143a04,_0x13372d]=await this[_0x3544cb(0x13c)]['findAndCount']({'skip':(_0x449e60-0x1)*_0x4d1a46,'take':_0x4d1a46,'where':_0x525b09,'order':{'sortId':_0x3544cb(0x103)}});if(_0x143a04[_0x3544cb(0x12a)]){const _0x5b9712=[],_0x313ec4=[];_0x143a04[_0x3544cb(0xe1)](_0x10925e=>{const _0xdb410e=_0x3544cb;_0x5b9712[_0xdb410e(0x108)](_0x10925e['id']),_0x313ec4['push'](_0x10925e[_0xdb410e(0xe5)]);});if(_0x32eb1f){const _0x1cddd0=await this[_0x3544cb(0xea)][_0x3544cb(0x11c)]({'where':{'userId':_0x32eb1f,'appId':(0x0,typeorm_2['In'])(_0x5b9712)}});_0x1cddd0[_0x3544cb(0xe1)](_0x5a8c03=>_0x1c5694[_0x3544cb(0xe0)](_0x5a8c03[_0x3544cb(0x136)]));}const _0x139337=await this[_0x3544cb(0x15e)][_0x3544cb(0x11c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x313ec4)}});_0x139337[_0x3544cb(0xe1)](_0x8b146d=>_0x281ed8['set'](_0x8b146d['id'],_0x8b146d));}return{'count':_0x13372d,'rows':_0x143a04['map'](_0x413b4d=>({..._0x413b4d,'collected':_0x1c5694['has'](_0x413b4d['id']),'groupName':_0x281ed8[_0x3544cb(0x144)](_0x413b4d['groupId'])?.[_0x3544cb(0x10c)]}))};}catch(_0x537aa1){console[_0x3544cb(0x11a)]('error:\x20',_0x537aa1);throw new common_1['HttpException'](_0x537aa1,common_1[_0x3544cb(0x150)][_0x3544cb(0x112)]);}}async['listByFrontType'](_0x31866e,_0x3096f3){const _0x3c2f2a=_0x497a51;let _0x1f3f2a;if(_0x31866e[_0x3c2f2a(0x155)]['authorization']){const _0x55e63b=_0x31866e[_0x3c2f2a(0x155)][_0x3c2f2a(0x154)]['split']('\x20'),_0x52f163=jwt[_0x3c2f2a(0x10e)](_0x55e63b[0x1],process['env'][_0x3c2f2a(0x12d)]);_0x1f3f2a=_0x52f163['id'];}const _0x4757f8={'take':0x1e};if(_0x3096f3=='recommend')_0x4757f8[_0x3c2f2a(0x101)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x4757f8[_0x3c2f2a(0xff)]={'createdAt':'DESC'};else{if(_0x3096f3===_0x3c2f2a(0x115))_0x4757f8[_0x3c2f2a(0x101)]={'status':0x1,'delFlag':![]},_0x4757f8['order']={'useCount':_0x3c2f2a(0x103)};else{if(_0x3096f3===_0x3c2f2a(0x127))_0x4757f8[_0x3c2f2a(0x101)]={'status':0x1,'delFlag':![]},_0x4757f8[_0x3c2f2a(0xff)]={'collectCount':_0x3c2f2a(0x103)};else{if(_0x3096f3===_0x3c2f2a(0x156)){if(!_0x1f3f2a)throw new common_1[(_0x3c2f2a(0xf9))]('请先登录！',common_1[_0x3c2f2a(0x150)][_0x3c2f2a(0x141)]);_0x4757f8['where']={'status':0x1,'delFlag':![],'userId':_0x1f3f2a},_0x4757f8['order']={'createdAt':_0x3c2f2a(0x103)};}else _0x4757f8[_0x3c2f2a(0x101)]={'status':0x1,'delFlag':![]},_0x4757f8[_0x3c2f2a(0xff)]={'createdAt':_0x3c2f2a(0x103)};}}}const _0x8145e6=await this[_0x3c2f2a(0x13c)][_0x3c2f2a(0x11c)](_0x4757f8),_0x29874b=new Set(),_0xe6628a=new Map(),_0x1a3775=new Map(),_0xcb5dca=[],_0x5504ad=[];_0x8145e6['forEach'](_0x55afae=>{const _0x2c29d9=_0x3c2f2a;_0xcb5dca['push'](_0x55afae['id']),_0x5504ad['push'](_0x55afae[_0x2c29d9(0xe5)]);});if(_0xcb5dca[_0x3c2f2a(0x12a)]){if(_0x1f3f2a){const _0x35b112=await this[_0x3c2f2a(0xea)]['find']({'where':{'userId':_0x1f3f2a,'appId':(0x0,typeorm_2['In'])(_0xcb5dca)}});_0x35b112[_0x3c2f2a(0xe1)](_0x2ae94e=>_0x29874b[_0x3c2f2a(0xe0)](_0x2ae94e[_0x3c2f2a(0x136)]));const _0x4d4e5d=await this['chatLogService'][_0x3c2f2a(0xf7)](_0x1f3f2a,_0xcb5dca);_0x4d4e5d[_0x3c2f2a(0xe1)](_0x33d227=>_0xe6628a[_0x3c2f2a(0xe7)](_0x33d227[_0x3c2f2a(0x136)],_0x33d227[_0x3c2f2a(0x119)]));}const _0x9a8e79=await this['gptsGroupEntity'][_0x3c2f2a(0x11c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5504ad)}});_0x9a8e79[_0x3c2f2a(0xe1)](_0x5681f8=>_0x1a3775['set'](_0x5681f8['id'],_0x5681f8));}return _0x8145e6['map'](_0x915e07=>({..._0x915e07,'collected':_0x29874b[_0x3c2f2a(0xf5)](_0x915e07['id']),'lastTime':_0xe6628a[_0x3c2f2a(0x144)](_0x915e07['id'])||null,'groupName':_0x1a3775[_0x3c2f2a(0x144)](_0x915e07['groupId'])?.['groupName']}));}async['handleRemoveGpts'](_0x53f2ee){const _0x50658e=_0x497a51;try{const {id:_0x17e68d}=_0x53f2ee,_0x411d1e=await this[_0x50658e(0x13c)]['findOne']({'where':{'id':_0x17e68d}});if(!_0x411d1e)throw new common_1[(_0x50658e(0xf9))](_0x50658e(0x12b),common_1[_0x50658e(0x150)][_0x50658e(0x112)]);return await this[_0x50658e(0x13c)]['delete'](_0x17e68d)[_0x50658e(0x158)](_0x2de377=>_0x2de377['affected']>0x0)[_0x50658e(0xd4)](_0x39b809=>{throw new Error(_0x39b809);});}catch(_0x6ff9ec){console[_0x50658e(0x11a)](_0x50658e(0x15b),_0x6ff9ec);throw new common_1[(_0x50658e(0xf9))](_0x6ff9ec,common_1['HttpStatus'][_0x50658e(0x112)]);}}async[_0x497a51(0x14e)](_0x4a14b1,_0x1a461c){const _0x4b208a=_0x497a51,_0x487e61=_0x4a14b1[_0x4b208a(0x136)],_0x295fbf=_0x1a461c[_0x4b208a(0x14d)]['id'];let _0x5a5f24=null,_0x4ac5e1={'title':'新对话','userId':_0x295fbf};try{_0x5a5f24=await this[_0x4b208a(0x13c)]['findOne']({'where':{'id':_0x487e61}});if(!_0x5a5f24)throw new Error(_0x4b208a(0x159));if(_0x5a5f24[_0x4b208a(0x107)]!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');const _0x242892=await this[_0x4b208a(0xdf)]['count']({'where':{'modelId':_0x487e61,'userId':_0x295fbf,'isDelete':![]}});if(_0x242892>0x0)throw new Error('当前应用已经开启了一个对话无需新建了！');_0x4ac5e1[_0x4b208a(0xe4)]=_0x5a5f24['id'],_0x4ac5e1[_0x4b208a(0xd5)]=_0x5a5f24['modelId'],_0x4ac5e1['groupId']=_0x5a5f24[_0x4b208a(0xe5)],_0x4ac5e1[_0x4b208a(0x147)]=_0x5a5f24[_0x4b208a(0x147)]||'',_0x4ac5e1['logo']=_0x5a5f24[_0x4b208a(0xf2)]||'',_0x4ac5e1[_0x4b208a(0x10b)]=_0x5a5f24[_0x4b208a(0x14c)],_0x4ac5e1[_0x4b208a(0xde)]=_0x5a5f24[_0x4b208a(0xde)]||'';let _0xa49a15=await this[_0x4b208a(0x137)][_0x4b208a(0xe6)](model_constant_1[_0x4b208a(0x104)][_0x4b208a(0x129)]);_0xa49a15[_0x4b208a(0x13e)][_0x4b208a(0x12e)]=_0x5a5f24[_0x4b208a(0x12e)],_0xa49a15[_0x4b208a(0x13e)][_0x4b208a(0x14c)]=_0x5a5f24['modelName'],_0xa49a15[_0x4b208a(0x13e)]['canUpload']=_0x5a5f24[_0x4b208a(0xd8)];_0x5a5f24[_0x4b208a(0xf0)]?_0xa49a15[_0x4b208a(0x13e)][_0x4b208a(0xd5)]=_0x5a5f24[_0x4b208a(0xe4)]:_0xa49a15[_0x4b208a(0x13e)]['model']=_0x5a5f24[_0x4b208a(0xd3)];_0x4ac5e1['config']=JSON['stringify'](_0xa49a15);const _0x3619f5=await this[_0x4b208a(0xdf)]['save'](_0x4ac5e1);return _0x5a5f24&&(_0x5a5f24[_0x4b208a(0x125)]=_0x5a5f24['useCount']+Math[_0x4b208a(0x11f)](Math[_0x4b208a(0x106)]()*0xa),await this[_0x4b208a(0x13c)][_0x4b208a(0xf6)](_0x5a5f24)),_0x3619f5;}catch(_0x4db322){throw new common_1[(_0x4b208a(0xf9))](_0x4db322[_0x4b208a(0x10a)],common_1[_0x4b208a(0x150)][_0x4b208a(0x112)]);}}async[_0x497a51(0xdc)](_0x52f80f){const _0x395cf3=_0x497a51;try{const _0xc52e=_0x52f80f['user']['id'],_0x587fa3={'userId':_0xc52e,'isDelete':![]},_0xef2194=await this[_0x395cf3(0xdf)][_0x395cf3(0x11c)]({'where':_0x587fa3,'order':{'isSticky':_0x395cf3(0x103),'id':_0x395cf3(0x103)}}),_0x2b5ca9=new Set(),_0x365286=new Map(),_0x3d98aa=new Map(),_0x1cfe56=[],_0x4d14be=[];_0xef2194['forEach'](_0x9d4e45=>{const _0x26a32b=_0x395cf3;_0x1cfe56['push'](_0x9d4e45[_0x26a32b(0xe4)]),_0x4d14be[_0x26a32b(0x108)](_0x9d4e45['groupId']);});if(_0x1cfe56['length']){const _0x585cde=await this[_0x395cf3(0xea)][_0x395cf3(0x11c)]({'where':{'userId':_0xc52e,'appId':(0x0,typeorm_2['In'])(_0x1cfe56)}});_0x585cde[_0x395cf3(0xe1)](_0x5653ec=>_0x2b5ca9[_0x395cf3(0xe0)](_0x5653ec['appId']));const _0xbfdb76=await this[_0x395cf3(0x13c)][_0x395cf3(0x11c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1cfe56),'status':0x1,'delFlag':![]}});_0xbfdb76[_0x395cf3(0xe1)](_0x22a15c=>_0x365286['set'](_0x22a15c['id'],_0x22a15c));const _0x2b30c6=await this[_0x395cf3(0x15e)][_0x395cf3(0x11c)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4d14be)}});_0x2b30c6[_0x395cf3(0xe1)](_0x1b062d=>_0x3d98aa[_0x395cf3(0xe7)](_0x1b062d['id'],_0x1b062d));}return _0xef2194[_0x395cf3(0x133)](_0xd61e61=>{const _0x599680=_0x395cf3,_0x452d8c=_0x365286[_0x599680(0x144)](_0xd61e61[_0x599680(0xe4)]);if(_0x452d8c?.['gptsApp']){const _0x5f0068=JSON['parse'](_0xd61e61[_0x599680(0x138)]);_0x5f0068[_0x599680(0x13e)][_0x599680(0xd5)]=_0x452d8c['modelId'],_0xd61e61[_0x599680(0x138)]=JSON[_0x599680(0x132)](_0x5f0068);}return{..._0xd61e61,'modelName':_0xd61e61[_0x599680(0x10b)],'gptsApp':_0x452d8c?.[_0x599680(0xf0)],'collected':_0x2b5ca9[_0x599680(0xf5)](_0xd61e61[_0x599680(0xe4)]),'groupName':_0x3d98aa['get'](_0xd61e61['groupId'])?.[_0x599680(0x10c)]};});}catch(_0x1faef0){console[_0x395cf3(0x11a)](_0x395cf3(0x15b),_0x1faef0);throw new common_1['HttpException'](_0x1faef0,common_1[_0x395cf3(0x150)]['BAD_REQUEST']);}}async[_0x497a51(0x15a)](_0x18bf63,_0x4d924d){const _0x2401db=_0x497a51,{title:_0x443d59,isSticky:_0x1aadd8,groupId:_0x4065f5,config:_0xb1f5aa}=_0x18bf63,{id:_0x191693}=_0x4d924d[_0x2401db(0x14d)],_0x5a5fcc=await this[_0x2401db(0xdf)][_0x2401db(0x13b)]({'where':{'id':_0x4065f5,'userId':_0x191693}});if(!_0x5a5fcc)throw new common_1[(_0x2401db(0xf9))](_0x2401db(0xe9),common_1[_0x2401db(0x150)][_0x2401db(0x112)]);const _0x3b79a6={};_0x3b79a6[_0x2401db(0x10b)]=_0x443d59||_0x5a5fcc[_0x2401db(0x10b)],_0x3b79a6[_0x2401db(0x138)]=_0xb1f5aa||_0x5a5fcc[_0x2401db(0x138)],_0x3b79a6[_0x2401db(0xfc)]=_0x1aadd8??_0x5a5fcc['isSticky'];const _0x115466=await this[_0x2401db(0xdf)][_0x2401db(0x11e)]({'id':_0x4065f5},_0x3b79a6);if(_0x115466[_0x2401db(0x124)])return!![];else throw new common_1[(_0x2401db(0xf9))](_0x2401db(0x126),common_1[_0x2401db(0x150)][_0x2401db(0x112)]);}async[_0x497a51(0xf3)](_0x8d32f5,_0xe34e03){const _0x33f1ca=_0x497a51;try{const {groupId:_0x2535d8}=_0x8d32f5,{id:_0x2436c0}=_0xe34e03['user'],_0x31e949=await this[_0x33f1ca(0xdf)][_0x33f1ca(0x13b)]({'where':{'id':_0x2535d8,'userId':_0x2436c0}})['catch'](_0x415753=>{const _0x46611e=_0x33f1ca;common_1[_0x46611e(0xfa)]['error'](_0x415753);throw new Error(_0x415753);});if(!_0x31e949)throw new Error(_0x33f1ca(0xfd));await this[_0x33f1ca(0x157)][_0x33f1ca(0x13a)]({'userId':_0x2436c0,'ids':[_0x2535d8]})[_0x33f1ca(0xd4)](_0x379125=>{throw new Error(_0x379125);});const _0xc6016b=await this[_0x33f1ca(0xdf)][_0x33f1ca(0x165)]({'id':_0x2535d8})['catch'](_0x4432bd=>{throw new Error(_0x4432bd);});if(!_0xc6016b)throw new Error(_0x33f1ca(0xf8));return!![];}catch(_0x3a0e66){throw new common_1[(_0x33f1ca(0xf9))](_0x3a0e66,common_1[_0x33f1ca(0x150)][_0x33f1ca(0x112)]);}}async[_0x497a51(0x166)](_0x515eee){const _0xec48bb=_0x497a51;try{const {id:_0xbfd413}=_0x515eee[_0xec48bb(0x14d)],_0x264e71=await this[_0xec48bb(0xdf)][_0xec48bb(0x11c)]({'where':{'userId':_0xbfd413}})[_0xec48bb(0xd4)](_0x11dd2f=>{const _0x4237b2=_0xec48bb;common_1['Logger'][_0x4237b2(0xdb)](_0x11dd2f);throw new Error(_0x11dd2f);});if(!_0x264e71||_0x264e71['length']===0x0)throw new Error(_0xec48bb(0xee));const _0x423031=_0x264e71[_0xec48bb(0x133)](_0x1f83af=>_0x1f83af['groupId']);await this[_0xec48bb(0x157)]['removeLogsBatch']({'ids':_0x423031,'userId':_0xbfd413})[_0xec48bb(0xd4)](_0x18fea3=>{throw new Error(_0x18fea3);});const _0x51bdc8=await this['gptsChatEntity'][_0xec48bb(0x165)]({'userId':_0xbfd413,'isSticky':![]})[_0xec48bb(0xd4)](_0x4f6959=>{throw new Error(_0x4f6959);});if(!_0x51bdc8)throw new Error(_0xec48bb(0x135));return!![];}catch(_0x209b35){throw new common_1[(_0xec48bb(0xf9))](_0x209b35,common_1[_0xec48bb(0x150)][_0xec48bb(0x112)]);}}async[_0x497a51(0x116)](_0x5b040d){const _0x3fceed=_0x497a51;return await this['gptsChatEntity'][_0x3fceed(0x13b)]({'where':{'id':_0x5b040d}});}async[_0x497a51(0x100)](_0x517656){const _0x4483b7=_0x497a51,_0x42978d=await this[_0x4483b7(0xdf)][_0x4483b7(0x13b)]({'where':{'id':_0x517656}}),_0xb11da6=await this[_0x4483b7(0x13c)][_0x4483b7(0x13b)]({'where':{'id':_0x42978d[_0x4483b7(0xe4)]}}),_0x2127bf=await this[_0x4483b7(0x137)][_0x4483b7(0x113)](model_constant_1[_0x4483b7(0x104)][_0x4483b7(0x129)]);return _0x2127bf[_0x4483b7(0x14c)]=_0xb11da6[_0x4483b7(0x14c)],_0x2127bf[_0x4483b7(0xd5)]=_0xb11da6[_0x4483b7(0xe4)]||_0xb11da6[_0x4483b7(0xd3)],_0x2127bf;}async['saveGptsUseLog'](_0x4ef206,_0x13ccb8){const _0x33f806=_0x497a51;await this['gptsGroupEntity'][_0x33f806(0x161)]()['update'](gpts_group_entity_1[_0x33f806(0x130)])['set']({'useCount':()=>_0x33f806(0x117),'useToken':()=>'useToken\x20+\x20'+_0x13ccb8})['where']('id\x20=\x20:id',{'id':_0x4ef206})['execute']();}async[_0x497a51(0xe2)](_0x4a0b96,_0x3f8bf6){const _0x497162=_0x497a51,_0x25fe31={'id':_0x4a0b96};return _0x3f8bf6!=null&&_0x3f8bf6!==undefined&&(_0x25fe31[_0x497162(0x107)]=_0x3f8bf6),this[_0x497162(0x13c)][_0x497162(0x13b)]({'where':_0x25fe31});}};GptsService=__decorate([(0x0,common_1[_0x497a51(0x15d)])(),__param(0x0,(0x0,typeorm_1[_0x497a51(0x168)])(userApps_entity_1[_0x497a51(0x102)])),__param(0x1,(0x0,typeorm_1[_0x497a51(0x168)])(gpts_group_entity_1['GptsGroupEntity'])),__param(0x2,(0x0,typeorm_1[_0x497a51(0x168)])(gpts_model_entity_1['GptsModelEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(gpts_chat_entity_1[_0x497a51(0x128)])),__metadata('design:paramtypes',[typeorm_2[_0x497a51(0x14f)],typeorm_2[_0x497a51(0x14f)],typeorm_2[_0x497a51(0x14f)],typeorm_2['Repository'],models_service_1[_0x497a51(0x163)],chatLog_service_1[_0x497a51(0x140)]])],GptsService),exports[_0x497a51(0x111)]=GptsService;