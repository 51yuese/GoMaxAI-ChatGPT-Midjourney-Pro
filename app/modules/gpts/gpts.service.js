'use strict';const _0x28e1da=_0xbff6;function _0x4a73(){const _0x1c841a=['Repository','isDefined','gptsModelEntity','push','getMany','16YhmZai','308197muTVMK','createQueryBuilder','应用分类不存在！','@nestjs/typeorm','gptsApp','426CGRoRE','更新对话失败！','798154IbGCQf','handleQueryGpts','assign','handleAddGpts','metadata','删除失败！','findAndCount','id\x20=\x20:id','GptsChatEntity','update','collectCount','groupName','nestjs-cls','removeLogsBatch','add','../chatGroup/chatGroup.service','getRandomKey','relModel','UNAUTHORIZED','log','getWithChat','isSticky','stringify','random','gptsChatEntity','请先登录！','9525069CxwcYZ','map','getExistGpts','sort','title','filter','modelsService','gpts不存在,无法删除！','catch','where','当前应用已经开启了一个对话无需新建了！','handleQueryGroup','demoData','object','getCurrentModelByChatGroupId','3333507FqZyFk','parse','modelInfo','./gpts.group.entity','canAudio','Injectable','orderBy','findOne','getAppModel','recommend','listByFrontType','appId','count','saveGptsUseLog','modelName','customParams','getLastByUserAndAppIds','delGptsChat','分类已存在！','affected','vipFreeNum','chatLogService','getReqSaasId','model','handleUpdateGroup','updateGptsChat','GptsService','应用类型不可更改！','ChatLogService','Logger','模型组不存在！','defineProperty','canUpload','error','userAppsEntity','chat','handleGetGroup','groupId','message','lastMessage','length','then','getAppById','logo','GptsGroupEntity','当前分类存在应用,不允许删除！','updatedAt','GptsModelEntity','getUserId','ModelsService','user','../chatLog/chatLog.service','__param','useCount\x20+\x201','hasHistory','deduct','非法操作、您在使用一个不存在的应用！','2597624iWLFVv','gpt','includes','InjectRepository','getGroupInfoFromId','清空失败！','gptsGroupEntity','saasId','Equal','headers','模型不存在！','has','../app/userApps.entity','typeorm','HttpException','save','__metadata','DESC','getModelByType','status','HttpStatus','IsNull','config','EModelType','APP','handleRemoveGpts','非法操作、您在使用一个未启用的应用！','handleRemoveGroup','useCount','ChatGroupService','Like','createdAt','favorite','order','find','__decorate','userId','chatGroupService','isPlatform','function','BAD_REQUEST','modelId','userType','execute','新对话','ceil','get','应用分类不存在,无法删除！','handleAddGptsBatch','delete','desc','../models/models.service','2353565AjKyEX','CHAT','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','非法操作、您在删除一个非法资源！','set','handleCreateChat','clsService','error:\x20','forEach','2359VoSGLo'];_0x4a73=function(){return _0x1c841a;};return _0x4a73();}(function(_0x5211f7,_0x270626){const _0x53d11b=_0xbff6,_0x15ad29=_0x5211f7();while(!![]){try{const _0x1e4e59=parseInt(_0x53d11b(0x134))/0x1+parseInt(_0x53d11b(0x13b))/0x2+-parseInt(_0x53d11b(0x164))/0x3+-parseInt(_0x53d11b(0x19d))/0x4+-parseInt(_0x53d11b(0x124))/0x5+parseInt(_0x53d11b(0x139))/0x6*(parseInt(_0x53d11b(0x12d))/0x7)+-parseInt(_0x53d11b(0x133))/0x8*(-parseInt(_0x53d11b(0x155))/0x9);if(_0x1e4e59===_0x270626)break;else _0x15ad29['push'](_0x15ad29['shift']());}catch(_0x52902a){_0x15ad29['push'](_0x15ad29['shift']());}}}(_0x4a73,0x96893));var __decorate=this&&this[_0x28e1da(0x113)]||function(_0x28cd3c,_0x50b0a8,_0x1c9fc6,_0x43ffa2){const _0x7f8479=_0x28e1da;var _0x3114f0=arguments['length'],_0x4e879b=_0x3114f0<0x3?_0x50b0a8:_0x43ffa2===null?_0x43ffa2=Object['getOwnPropertyDescriptor'](_0x50b0a8,_0x1c9fc6):_0x43ffa2,_0xbc8a7;if(typeof Reflect===_0x7f8479(0x162)&&typeof Reflect['decorate']==='function')_0x4e879b=Reflect['decorate'](_0x28cd3c,_0x50b0a8,_0x1c9fc6,_0x43ffa2);else{for(var _0x403b73=_0x28cd3c[_0x7f8479(0x18c)]-0x1;_0x403b73>=0x0;_0x403b73--)if(_0xbc8a7=_0x28cd3c[_0x403b73])_0x4e879b=(_0x3114f0<0x3?_0xbc8a7(_0x4e879b):_0x3114f0>0x3?_0xbc8a7(_0x50b0a8,_0x1c9fc6,_0x4e879b):_0xbc8a7(_0x50b0a8,_0x1c9fc6))||_0x4e879b;}return _0x3114f0>0x3&&_0x4e879b&&Object[_0x7f8479(0x183)](_0x50b0a8,_0x1c9fc6,_0x4e879b),_0x4e879b;},__metadata=this&&this[_0x28e1da(0x1ad)]||function(_0x1f1f5a,_0x32bdf3){const _0x1c9f88=_0x28e1da;if(typeof Reflect===_0x1c9f88(0x162)&&typeof Reflect[_0x1c9f88(0x13f)]===_0x1c9f88(0x117))return Reflect[_0x1c9f88(0x13f)](_0x1f1f5a,_0x32bdf3);},__param=this&&this[_0x28e1da(0x198)]||function(_0x47f8f1,_0xc1996d){return function(_0x384079,_0x335fca){_0xc1996d(_0x384079,_0x335fca,_0x47f8f1);};};Object[_0x28e1da(0x183)](exports,'__esModule',{'value':!![]}),exports[_0x28e1da(0x17e)]=void 0x0;function _0xbff6(_0x4b16d8,_0x287b44){const _0x4a7306=_0x4a73();return _0xbff6=function(_0xbff68,_0x187501){_0xbff68=_0xbff68-0x10d;let _0x4db26c=_0x4a7306[_0xbff68];return _0x4db26c;},_0xbff6(_0x4b16d8,_0x287b44);}const common_1=require('@nestjs/common'),typeorm_1=require(_0x28e1da(0x137)),gpts_group_entity_1=require(_0x28e1da(0x167)),typeorm_2=require(_0x28e1da(0x1aa)),gpts_model_entity_1=require('./gpts.model.entity'),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require(_0x28e1da(0x197)),utils_1=require('../../common/utils'),models_service_1=require(_0x28e1da(0x123)),userApps_entity_1=require(_0x28e1da(0x1a9)),model_constant_1=require('../../common/constants/model.constant'),nestjs_cls_1=require(_0x28e1da(0x147)),chatGroup_service_1=require(_0x28e1da(0x14a));let GptsService=class GptsService{constructor(_0x5cf3d0,_0x36363b,_0x27109a,_0x4fe3c4,_0x537823,_0x501b99,_0x1bf4d4,_0x2db08){const _0x43ac34=_0x28e1da;this['userAppsEntity']=_0x5cf3d0,this[_0x43ac34(0x1a3)]=_0x36363b,this[_0x43ac34(0x130)]=_0x27109a,this[_0x43ac34(0x153)]=_0x4fe3c4,this['clsService']=_0x537823,this[_0x43ac34(0x15b)]=_0x501b99,this[_0x43ac34(0x179)]=_0x1bf4d4,this[_0x43ac34(0x115)]=_0x2db08;}async['handleAddGroup'](_0x1fa59e){const _0x3e1070=_0x28e1da;try{const _0xf6b561=_0x1fa59e['groupName'],_0x382f2d=(0x0,utils_1[_0x3e1070(0x17a)])(this['clsService']),_0x5af1f0=await this[_0x3e1070(0x1a3)][_0x3e1070(0x16b)]({'where':{'groupName':_0xf6b561,'saasId':_0x382f2d}});if(_0x5af1f0)throw new common_1['HttpException'](_0x3e1070(0x176),common_1['HttpStatus'][_0x3e1070(0x118)]);return await this[_0x3e1070(0x1a3)][_0x3e1070(0x1ac)]({..._0x1fa59e,'saasId':_0x382f2d}),!![];}catch(_0x46b5de){throw new common_1['HttpException'](_0x46b5de['message'],common_1['HttpStatus'][_0x3e1070(0x118)]);}}async[_0x28e1da(0x17c)](_0x5d714c){const _0xa81587=_0x28e1da;try{const _0x524fac=await this[_0xa81587(0x1a3)][_0xa81587(0x16b)]({'where':{'id':_0x5d714c['id']}});if(!_0x524fac)throw new common_1[(_0xa81587(0x1ab))](_0xa81587(0x182),common_1[_0xa81587(0x1b1)][_0xa81587(0x118)]);return await this[_0xa81587(0x1a3)][_0xa81587(0x144)]({'id':_0x5d714c['id']},_0x5d714c),!![];}catch(_0x56cc77){throw new common_1[(_0xa81587(0x1ab))](_0x56cc77[_0xa81587(0x18a)],common_1[_0xa81587(0x1b1)][_0xa81587(0x118)]);}}async[_0x28e1da(0x1b8)](_0x2b8024){const _0x58f219=_0x28e1da;try{const _0x44878f=_0x2b8024['id'],_0x368dcb=await this[_0x58f219(0x1a3)]['findOne']({'where':{'id':_0x44878f}});if(!_0x368dcb)throw new common_1[(_0x58f219(0x1ab))](_0x58f219(0x11f),common_1[_0x58f219(0x1b1)][_0x58f219(0x118)]);const _0x538742=await this[_0x58f219(0x130)]['count']({'where':{'groupId':_0x368dcb['id']}});if(_0x538742>0x0)throw new common_1[(_0x58f219(0x1ab))](_0x58f219(0x191),common_1[_0x58f219(0x1b1)][_0x58f219(0x118)]);else await this['gptsGroupEntity'][_0x58f219(0x121)]({'id':_0x44878f});}catch(_0x38659b){throw new common_1[(_0x58f219(0x1ab))](_0x38659b[_0x58f219(0x18a)],common_1[_0x58f219(0x1b1)][_0x58f219(0x118)]);}}async[_0x28e1da(0x160)](_0x107151,_0x3d3f1b){const _0x2fd971=_0x28e1da;try{const _0x21dbb9=(0x0,utils_1['getReqSaasId'])(this[_0x2fd971(0x12a)]),{page:page=0x1,size:size=0x14,status:_0x38768c,saasId:_0x115d7d,groupName:_0x584cb7}=_0x107151,_0xb7019c={};return _0x584cb7&&(_0xb7019c[_0x2fd971(0x146)]=_0x584cb7),_0x38768c>=0x0&&(_0xb7019c[_0x2fd971(0x1b0)]=_0x38768c),(0x0,utils_1[_0x2fd971(0x116)])(this[_0x2fd971(0x12a)])?(0x0,utils_1['isDefined'])(_0x115d7d)&&(_0xb7019c[_0x2fd971(0x1a4)]=_0x115d7d):_0xb7019c[_0x2fd971(0x1a4)]=_0x21dbb9,await this['gptsGroupEntity'][_0x2fd971(0x141)]({'where':_0xb7019c,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x2fd971(0x1ae),'id':_0x2fd971(0x1ae)}})[_0x2fd971(0x18d)](([_0x6303d8,_0x502e5a])=>({'rows':_0x6303d8,'count':_0x502e5a}))[_0x2fd971(0x15d)](_0x564f02=>{throw new Error(_0x564f02);});}catch(_0x4669b9){console['log'](_0x2fd971(0x12b),_0x4669b9);throw new common_1['HttpException'](_0x4669b9,common_1[_0x2fd971(0x1b1)][_0x2fd971(0x118)]);}}async[_0x28e1da(0x188)](_0x2fc9a5,_0x13a0b7){const _0x36c6b5=_0x28e1da;try{const {groupId:_0x3c73b4}=_0x2fc9a5;return await this[_0x36c6b5(0x1a3)][_0x36c6b5(0x16b)]({'where':{'id':Number(_0x3c73b4)}})['then'](_0x3b7b94=>{return _0x3b7b94;})[_0x36c6b5(0x15d)](_0x192410=>{throw new Error(_0x192410);});}catch(_0x3b2832){console[_0x36c6b5(0x14e)](_0x36c6b5(0x12b),_0x3b2832);throw new common_1[(_0x36c6b5(0x1ab))](_0x3b2832,common_1[_0x36c6b5(0x1b1)][_0x36c6b5(0x118)]);}}async[_0x28e1da(0x13e)](_0x168af3,_0x5b173b){const _0x38e776=_0x28e1da;try{const _0x2fca8e=_0x168af3[_0x38e776(0x196)]['id'],_0x51a720=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x11438d=Object[_0x38e776(0x13d)](new gpts_model_entity_1[(_0x38e776(0x193))](),_0x5b173b);_0x11438d[_0x38e776(0x1b0)]=Number(_0x5b173b[_0x38e776(0x1b0)]);if(_0x11438d['id']){const _0x59918d=await this[_0x38e776(0x130)][_0x38e776(0x16b)]({'where':{'id':_0x11438d['id']}});if(!_0x59918d)throw new common_1[(_0x38e776(0x1ab))](_0x38e776(0x1a7),common_1[_0x38e776(0x1b1)]['BAD_REQUEST']);if(_0x59918d[_0x38e776(0x138)]!==_0x11438d[_0x38e776(0x138)])throw new common_1[(_0x38e776(0x1ab))](_0x38e776(0x17f),common_1[_0x38e776(0x1b1)][_0x38e776(0x118)]);return await this[_0x38e776(0x130)][_0x38e776(0x144)]({'id':_0x11438d['id']},{..._0x11438d,'useCount':_0x11438d[_0x38e776(0x1b9)]??_0x59918d[_0x38e776(0x1b9)],'collectCount':_0x11438d[_0x38e776(0x145)]??_0x59918d[_0x38e776(0x145)]})[_0x38e776(0x18d)](_0x3ee906=>_0x3ee906['affected']>0x0)['catch'](_0x1de19b=>{throw new Error(_0x1de19b);});}else{const _0x2163a0=await this[_0x38e776(0x1a3)]['findOne']({'where':{'id':_0x11438d['groupId']}});if(!_0x2163a0)throw new common_1[(_0x38e776(0x1ab))](_0x38e776(0x136),common_1['HttpStatus'][_0x38e776(0x118)]);const _0x346d28=await this[_0x38e776(0x130)]['save']({..._0x11438d,'saasId':_0x51a720,'userId':_0x168af3[_0x38e776(0x1a6)]['fingerprint']?_0x2fca8e:null});return _0x346d28['id'];}}catch(_0x36c490){throw new common_1['HttpException'](_0x36c490,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x28e1da(0x157)](){const _0x1b1ce8=_0x28e1da;return await this[_0x1b1ce8(0x130)][_0x1b1ce8(0x112)]()[_0x1b1ce8(0x18d)](_0x5b2d8b=>_0x5b2d8b[_0x1b1ce8(0x156)](_0x29fa8d=>_0x29fa8d[_0x1b1ce8(0x172)]));}async[_0x28e1da(0x120)](_0x4352fb){const _0x103a2c=_0x28e1da;try{const _0x53c546=(0x0,utils_1[_0x103a2c(0x17a)])(this[_0x103a2c(0x12a)]),_0x1a26f7=await this[_0x103a2c(0x157)](),_0x10f4a8=_0x4352fb[_0x103a2c(0x15a)](_0x5cf57e=>!_0x1a26f7[_0x103a2c(0x19f)](_0x5cf57e['modelName']))['map'](_0x42903f=>({'groupId':_0x42903f[_0x103a2c(0x189)],'relModel':_0x42903f[_0x103a2c(0x14c)],'logo':_0x42903f[_0x103a2c(0x18f)],'desc':_0x42903f['desc'],'modelName':_0x42903f[_0x103a2c(0x172)],'modelId':_0x42903f[_0x103a2c(0x119)],'saasId':_0x53c546}));return await this[_0x103a2c(0x130)][_0x103a2c(0x1ac)](_0x10f4a8)['catch'](_0x40d43a=>{throw new Error(_0x40d43a);});}catch(_0x357de8){console[_0x103a2c(0x14e)](_0x103a2c(0x12b),_0x357de8);throw new common_1[(_0x103a2c(0x1ab))](_0x357de8,common_1[_0x103a2c(0x1b1)][_0x103a2c(0x118)]);}}async[_0x28e1da(0x13c)](_0xb3274a,_0x21e893){const _0x2ffea1=_0x28e1da;try{const _0x5b45ea=(0x0,utils_1[_0x2ffea1(0x194)])(this['clsService']),_0x1d560c=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x277d03=new Set(),_0x31f9a4=new Map(),{modelId:_0x3855ed,modelName:_0x29e393,groupId:_0x3f3bc5,back:_0x3c3a92,status:_0x1cfe91,page:page=0x1,size:size=0x14,saasId:_0x19c695}=_0xb3274a,_0x175c56={'delFlag':![]};_0x5b45ea?_0x175c56['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x2ffea1(0x1a5)])(_0x5b45ea),(0x0,typeorm_2['IsNull'])()):_0x175c56[_0x2ffea1(0x114)]=(0x0,typeorm_2[_0x2ffea1(0x1b2)])();(0x0,utils_1['isPlatform'])(this[_0x2ffea1(0x12a)])?(0x0,utils_1[_0x2ffea1(0x12f)])(_0x19c695)&&(_0x175c56[_0x2ffea1(0x1a4)]=_0x19c695):_0x175c56['saasId']=_0x1d560c;!_0x3c3a92?_0x175c56[_0x2ffea1(0x1b0)]=0x1:(_0x1cfe91!==undefined&&_0x1cfe91!==null&&(_0x175c56[_0x2ffea1(0x1b0)]=_0x1cfe91),delete _0x175c56[_0x2ffea1(0x114)]);_0x3855ed&&(_0x175c56[_0x2ffea1(0x119)]=_0x3855ed),_0x3f3bc5&&(_0x175c56['groupId']=_0x3f3bc5),_0x29e393&&(_0x175c56['modelName']=(0x0,typeorm_2[_0x2ffea1(0x10e)])('%'+_0x29e393+'%'));const [_0x1b81eb,_0x4fdbc9]=await this[_0x2ffea1(0x130)][_0x2ffea1(0x141)]({'skip':(page-0x1)*size,'take':size,'where':_0x175c56,'order':{'sortId':'DESC'}});if(_0x1b81eb[_0x2ffea1(0x18c)]){const _0x3466ca=[],_0x23f415=[];_0x1b81eb[_0x2ffea1(0x12c)](_0x4e22df=>{const _0x19f066=_0x2ffea1;_0x3466ca[_0x19f066(0x131)](_0x4e22df['id']),_0x23f415[_0x19f066(0x131)](_0x4e22df['groupId']);});if(_0x5b45ea){const _0x29f3a2=await this[_0x2ffea1(0x186)][_0x2ffea1(0x112)]({'where':{'userId':_0x5b45ea,'appId':(0x0,typeorm_2['In'])(_0x3466ca)}});_0x29f3a2[_0x2ffea1(0x12c)](_0x5a4a52=>_0x277d03['add'](_0x5a4a52[_0x2ffea1(0x16f)]));}const _0x32700d=await this[_0x2ffea1(0x1a3)][_0x2ffea1(0x112)]({'where':{'id':(0x0,typeorm_2['In'])(_0x23f415)}});_0x32700d[_0x2ffea1(0x12c)](_0x3e5095=>_0x31f9a4['set'](_0x3e5095['id'],_0x3e5095));}return{'count':_0x4fdbc9,'rows':_0x1b81eb[_0x2ffea1(0x156)](_0x40d238=>({..._0x40d238,'collected':_0x277d03[_0x2ffea1(0x1a8)](_0x40d238['id']),'groupName':_0x31f9a4['get'](_0x40d238[_0x2ffea1(0x189)])?.[_0x2ffea1(0x146)],'isVipUsed':_0x40d238[_0x2ffea1(0x11a)]?!![]:![]}))};}catch(_0x2b3b1e){console[_0x2ffea1(0x14e)](_0x2ffea1(0x12b),_0x2b3b1e);throw new common_1[(_0x2ffea1(0x1ab))](_0x2b3b1e,common_1[_0x2ffea1(0x1b1)][_0x2ffea1(0x118)]);}}async[_0x28e1da(0x16e)](_0x129d53,_0x57b5e5){const _0x5bedda=_0x28e1da,_0x164dab=(0x0,utils_1[_0x5bedda(0x194)])(this[_0x5bedda(0x12a)]),_0x2a2a3c=(0x0,utils_1[_0x5bedda(0x17a)])(this['clsService']),_0x2b5bb6={'take':0x1e};if(_0x57b5e5==_0x5bedda(0x16d))_0x2b5bb6[_0x5bedda(0x15e)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x2b5bb6['order']={'createdAt':'DESC'};else{if(_0x57b5e5==='popular')_0x2b5bb6['where']={'status':0x1,'delFlag':![]},_0x2b5bb6[_0x5bedda(0x111)]={'useCount':_0x5bedda(0x1ae)};else{if(_0x57b5e5===_0x5bedda(0x110))_0x2b5bb6[_0x5bedda(0x15e)]={'status':0x1,'delFlag':![]},_0x2b5bb6[_0x5bedda(0x111)]={'collectCount':_0x5bedda(0x1ae)};else{if(_0x57b5e5==='mine'){if(!_0x164dab)throw new common_1[(_0x5bedda(0x1ab))](_0x5bedda(0x154),common_1['HttpStatus'][_0x5bedda(0x14d)]);_0x2b5bb6[_0x5bedda(0x15e)]={'status':0x1,'delFlag':![],'userId':_0x164dab},_0x2b5bb6[_0x5bedda(0x111)]={'createdAt':_0x5bedda(0x1ae)};}else _0x2b5bb6[_0x5bedda(0x15e)]={'status':0x1,'delFlag':![]},_0x2b5bb6[_0x5bedda(0x111)]={'createdAt':'DESC'};}}}_0x2b5bb6[_0x5bedda(0x15e)]['saasId']=_0x2a2a3c;const _0x971514=await this[_0x5bedda(0x130)][_0x5bedda(0x112)](_0x2b5bb6),_0x5c04c7=new Set(),_0x4a4256=new Map(),_0x23f62a=new Map(),_0xf89c75=[],_0x363a34=[];_0x971514[_0x5bedda(0x12c)](_0x321647=>{const _0x4bba71=_0x5bedda;_0xf89c75[_0x4bba71(0x131)](_0x321647['id']),_0x363a34['push'](_0x321647['groupId']);});if(_0xf89c75[_0x5bedda(0x18c)]){if(_0x164dab){const _0x4ee44f=await this[_0x5bedda(0x186)]['find']({'where':{'userId':_0x164dab,'appId':(0x0,typeorm_2['In'])(_0xf89c75)}});_0x4ee44f[_0x5bedda(0x12c)](_0x12a251=>_0x5c04c7[_0x5bedda(0x149)](_0x12a251[_0x5bedda(0x16f)]));const _0xf5b0a8=await this[_0x5bedda(0x179)][_0x5bedda(0x174)](_0x164dab,_0xf89c75);_0xf5b0a8[_0x5bedda(0x12c)](_0x1d26b0=>_0x4a4256[_0x5bedda(0x128)](_0x1d26b0['appId'],_0x1d26b0[_0x5bedda(0x10f)]));}const _0x30ee14=await this[_0x5bedda(0x1a3)][_0x5bedda(0x112)]({'where':{'id':(0x0,typeorm_2['In'])(_0x363a34)}});_0x30ee14[_0x5bedda(0x12c)](_0x1fa982=>_0x23f62a[_0x5bedda(0x128)](_0x1fa982['id'],_0x1fa982));}return _0x971514['map'](_0x2cafaf=>({..._0x2cafaf,'isVipUsed':_0x2cafaf[_0x5bedda(0x11a)]?!![]:![],'collected':_0x5c04c7['has'](_0x2cafaf['id']),'lastTime':_0x4a4256['get'](_0x2cafaf['id'])||null,'groupName':_0x23f62a[_0x5bedda(0x11e)](_0x2cafaf[_0x5bedda(0x189)])?.[_0x5bedda(0x146)]}));}async[_0x28e1da(0x1b6)](_0x363b5f){const _0x1fdff1=_0x28e1da;try{const {id:_0x5955a6}=_0x363b5f,_0x27b0dc=await this[_0x1fdff1(0x130)][_0x1fdff1(0x16b)]({'where':{'id':_0x5955a6}});if(!_0x27b0dc)throw new common_1[(_0x1fdff1(0x1ab))](_0x1fdff1(0x15c),common_1[_0x1fdff1(0x1b1)][_0x1fdff1(0x118)]);return await this['gptsModelEntity']['delete'](_0x5955a6)['then'](_0x7ae0c3=>_0x7ae0c3['affected']>0x0)['catch'](_0x492002=>{throw new Error(_0x492002);});}catch(_0x6014c7){console[_0x1fdff1(0x14e)]('error:\x20',_0x6014c7);throw new common_1[(_0x1fdff1(0x1ab))](_0x6014c7,common_1[_0x1fdff1(0x1b1)]['BAD_REQUEST']);}}async[_0x28e1da(0x129)](_0x1ebf07,_0x17321f){const _0x44e8cd=_0x28e1da,_0x1e6117=_0x1ebf07[_0x44e8cd(0x16f)],_0x590958=_0x17321f[_0x44e8cd(0x196)]['id'],_0x51373f=(0x0,utils_1[_0x44e8cd(0x17a)])(this[_0x44e8cd(0x12a)]);let _0x2236d9=null,_0xf5db68={'title':_0x44e8cd(0x11c),'userId':_0x590958,'saasId':_0x51373f};try{_0x2236d9=await this[_0x44e8cd(0x130)][_0x44e8cd(0x16b)]({'where':{'id':_0x1e6117}});if(!_0x2236d9)throw new Error(_0x44e8cd(0x19c));if(_0x2236d9['status']!==0x1)throw new Error(_0x44e8cd(0x1b7));if(!_0x1ebf07['hasHistory']){const _0x186571=await this[_0x44e8cd(0x153)][_0x44e8cd(0x170)]({'where':{'modelId':_0x1e6117,'userId':_0x590958,'isDelete':![]}});if(_0x186571>0x0)throw new Error(_0x44e8cd(0x15f));}_0xf5db68['modelId']=_0x2236d9['id'],_0xf5db68[_0x44e8cd(0x17b)]=_0x2236d9[_0x44e8cd(0x119)],_0xf5db68[_0x44e8cd(0x189)]=_0x2236d9['groupId'],_0xf5db68[_0x44e8cd(0x122)]=_0x2236d9['desc']||'',_0xf5db68[_0x44e8cd(0x18f)]=_0x2236d9[_0x44e8cd(0x18f)]||'',_0xf5db68['title']=_0x1ebf07[_0x44e8cd(0x19a)]?_0x44e8cd(0x11c):_0x2236d9[_0x44e8cd(0x172)],_0xf5db68[_0x44e8cd(0x161)]=_0x2236d9[_0x44e8cd(0x161)]||'';let _0x25bdf5=await this[_0x44e8cd(0x15b)][_0x44e8cd(0x1af)](model_constant_1[_0x44e8cd(0x1b4)]['APP']);_0x25bdf5[_0x44e8cd(0x166)]['canAudio']=_0x2236d9[_0x44e8cd(0x168)],_0x25bdf5[_0x44e8cd(0x166)][_0x44e8cd(0x172)]=_0x2236d9['modelName'],_0x25bdf5['modelInfo'][_0x44e8cd(0x184)]=_0x2236d9['canUpload'];_0x2236d9['gptsApp']?_0x25bdf5[_0x44e8cd(0x166)][_0x44e8cd(0x17b)]=_0x2236d9[_0x44e8cd(0x119)]:_0x25bdf5[_0x44e8cd(0x166)][_0x44e8cd(0x17b)]=_0x2236d9['relModel'];_0xf5db68['config']=JSON[_0x44e8cd(0x151)](_0x25bdf5);const _0x19d3fa=await this[_0x44e8cd(0x153)][_0x44e8cd(0x1ac)](_0xf5db68);return _0x2236d9&&(_0x2236d9['useCount']=_0x2236d9['useCount']+Math[_0x44e8cd(0x11d)](Math[_0x44e8cd(0x152)]()*0xa),await this['gptsModelEntity'][_0x44e8cd(0x1ac)](_0x2236d9)),_0x19d3fa;}catch(_0x24e236){throw new common_1[(_0x44e8cd(0x1ab))](_0x24e236['message'],common_1[_0x44e8cd(0x1b1)][_0x44e8cd(0x118)]);}}async[_0x28e1da(0x14f)](_0x3b23be,_0x29e6bf,_0x2fda90){const _0x2f3571=_0x28e1da,_0x29d5e6=await this[_0x2f3571(0x115)]['query'](model_constant_1[_0x2f3571(0x1b4)][_0x2f3571(0x125)],_0x3b23be,_0x29e6bf,_0x2fda90),_0x3d9c5e=await this['handleGetChat'](_0x2fda90),_0x581d11=[];for(const _0x16a9ab of _0x29d5e6){_0x581d11[_0x2f3571(0x131)]({'id':_0x16a9ab['id'],'config':_0x16a9ab[_0x2f3571(0x1b3)],'createdAt':_0x16a9ab[_0x2f3571(0x10f)],'lastMessage':_0x16a9ab[_0x2f3571(0x18b)],'modelType':_0x2f3571(0x187),'title':_0x16a9ab[_0x2f3571(0x159)],'updatedAt':_0x16a9ab['updatedAt'],'isSticky':_0x16a9ab[_0x2f3571(0x150)],'appId':_0x16a9ab[_0x2f3571(0x16f)],'logo':'','desc':''});}for(const _0x42120b of _0x3d9c5e){_0x581d11[_0x2f3571(0x131)]({'id':_0x42120b['id'],'config':_0x42120b[_0x2f3571(0x1b3)],'createdAt':_0x42120b[_0x2f3571(0x10f)],'logo':_0x42120b['logo'],'lastMessage':_0x42120b['lastMessage'],'desc':_0x42120b['desc'],'modelId':_0x42120b[_0x2f3571(0x119)],'modelType':_0x2f3571(0x19e),'title':_0x42120b[_0x2f3571(0x172)],'updatedAt':_0x42120b[_0x2f3571(0x192)],'isSticky':_0x42120b[_0x2f3571(0x150)]});}return _0x581d11[_0x2f3571(0x158)]((_0x737efa,_0xd7c777)=>{const _0x165e8f=_0x2f3571;if(_0x737efa[_0x165e8f(0x150)]!==_0xd7c777['isSticky'])return _0xd7c777['isSticky']-_0x737efa[_0x165e8f(0x150)];return _0xd7c777[_0x165e8f(0x192)]-_0x737efa['updatedAt'];}),_0x581d11;}async['handleGetChat'](_0x4d2e55,_0x60eab4){const _0x4255eb=_0x28e1da;try{const _0x31eb6c=_0x4d2e55[_0x4255eb(0x196)]['id'],_0x41bf3a={'userId':_0x31eb6c,'isDelete':![]};_0x60eab4&&(_0x41bf3a['modelId']=_0x60eab4);let _0x122c66=[];_0x60eab4?_0x122c66=await this[_0x4255eb(0x153)]['find']({'where':_0x41bf3a,'order':{'isSticky':_0x4255eb(0x1ae),'updatedAt':_0x4255eb(0x1ae)}}):_0x122c66=await this[_0x4255eb(0x153)][_0x4255eb(0x135)]()[_0x4255eb(0x15e)](_0x41bf3a)['groupBy'](_0x4255eb(0x119))[_0x4255eb(0x16a)]({'isSticky':_0x4255eb(0x1ae),'updatedAt':_0x4255eb(0x1ae)})[_0x4255eb(0x132)]();const _0x4ac882=new Set(),_0x456a3d=new Map(),_0x4139ac=new Map(),_0x83dab2=[],_0x400d55=[];_0x122c66[_0x4255eb(0x12c)](_0x331b4a=>{const _0x4f2a77=_0x4255eb;_0x83dab2['push'](_0x331b4a[_0x4f2a77(0x119)]),_0x400d55[_0x4f2a77(0x131)](_0x331b4a['groupId']);});if(_0x83dab2['length']){const _0x41bd00=await this[_0x4255eb(0x186)][_0x4255eb(0x112)]({'where':{'userId':_0x31eb6c,'appId':(0x0,typeorm_2['In'])(_0x83dab2)}});_0x41bd00[_0x4255eb(0x12c)](_0x582815=>_0x4ac882[_0x4255eb(0x149)](_0x582815[_0x4255eb(0x16f)]));const _0x53eb6f=await this[_0x4255eb(0x130)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x83dab2),'status':0x1,'delFlag':![]}});_0x53eb6f['forEach'](_0x5ea6a3=>_0x456a3d[_0x4255eb(0x128)](_0x5ea6a3['id'],_0x5ea6a3));const _0x135b90=await this[_0x4255eb(0x1a3)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x400d55)}});_0x135b90[_0x4255eb(0x12c)](_0xa62f83=>_0x4139ac['set'](_0xa62f83['id'],_0xa62f83));}return _0x122c66[_0x4255eb(0x156)](_0x24f971=>{const _0x3e26c8=_0x4255eb,_0x3f7047=_0x456a3d[_0x3e26c8(0x11e)](_0x24f971[_0x3e26c8(0x119)]);if(_0x3f7047?.[_0x3e26c8(0x138)]){const _0x4034d4=JSON[_0x3e26c8(0x165)](_0x24f971['config']);_0x4034d4[_0x3e26c8(0x166)][_0x3e26c8(0x17b)]=_0x3f7047['modelId'],_0x24f971[_0x3e26c8(0x1b3)]=JSON[_0x3e26c8(0x151)](_0x4034d4);}return{..._0x24f971,'modelName':_0x3f7047?.[_0x3e26c8(0x172)]||_0x24f971[_0x3e26c8(0x159)],'gptsApp':_0x3f7047?.[_0x3e26c8(0x138)],'customParams':_0x3f7047?.[_0x3e26c8(0x173)],'customConfig':_0x3f7047?.[_0x3e26c8(0x1b3)],'collected':_0x4ac882['has'](_0x24f971[_0x3e26c8(0x119)]),'groupName':_0x4139ac[_0x3e26c8(0x11e)](_0x24f971[_0x3e26c8(0x189)])?.[_0x3e26c8(0x146)],'isVipUsed':_0x3f7047?.[_0x3e26c8(0x11a)]?!![]:![],'userType':_0x3f7047?.['userType']};});}catch(_0x2d100c){console[_0x4255eb(0x14e)](_0x4255eb(0x12b),_0x2d100c);throw new common_1[(_0x4255eb(0x1ab))](_0x2d100c,common_1[_0x4255eb(0x1b1)][_0x4255eb(0x118)]);}}async[_0x28e1da(0x17d)](_0x5dc8a1,_0x451bfd){const _0x1f0315=_0x28e1da,{title:_0x5a0a46,isSticky:_0x8e31a0,groupId:_0x3fa9c6,config:_0x33a9d7}=_0x5dc8a1,{id:_0x506931}=_0x451bfd[_0x1f0315(0x196)],_0x1e7f0d=await this[_0x1f0315(0x153)]['findOne']({'where':{'id':_0x3fa9c6,'userId':_0x506931}});if(!_0x1e7f0d)throw new common_1[(_0x1f0315(0x1ab))](_0x1f0315(0x126),common_1[_0x1f0315(0x1b1)][_0x1f0315(0x118)]);const _0x4c107e={};_0x4c107e['title']=_0x5a0a46||_0x1e7f0d['title'],_0x4c107e[_0x1f0315(0x1b3)]=_0x33a9d7||_0x1e7f0d[_0x1f0315(0x1b3)],_0x4c107e[_0x1f0315(0x150)]=_0x8e31a0??_0x1e7f0d[_0x1f0315(0x150)];const _0x49cce3=await this[_0x1f0315(0x153)]['update']({'id':_0x3fa9c6},_0x4c107e);if(_0x49cce3[_0x1f0315(0x177)])return!![];else throw new common_1[(_0x1f0315(0x1ab))](_0x1f0315(0x13a),common_1[_0x1f0315(0x1b1)]['BAD_REQUEST']);}async[_0x28e1da(0x175)](_0x525d1d,_0x442dde){const _0x3dfaec=_0x28e1da;try{const {groupId:_0x1f601e}=_0x525d1d,{id:_0x2dca93}=_0x442dde[_0x3dfaec(0x196)],_0xa6550a=await this[_0x3dfaec(0x153)][_0x3dfaec(0x16b)]({'where':{'id':_0x1f601e,'userId':_0x2dca93}})[_0x3dfaec(0x15d)](_0x3d557a=>{const _0x4b688c=_0x3dfaec;common_1[_0x4b688c(0x181)][_0x4b688c(0x185)](_0x3d557a);throw new Error(_0x3d557a);});if(!_0xa6550a)throw new Error(_0x3dfaec(0x127));await this[_0x3dfaec(0x179)][_0x3dfaec(0x148)]({'userId':_0x2dca93,'ids':[_0x1f601e]})[_0x3dfaec(0x15d)](_0x205fa4=>{throw new Error(_0x205fa4);});const _0x40e9b5=await this['gptsChatEntity']['delete']({'id':_0x1f601e})[_0x3dfaec(0x15d)](_0x2c84c3=>{throw new Error(_0x2c84c3);});if(!_0x40e9b5)throw new Error(_0x3dfaec(0x140));return!![];}catch(_0x562420){throw new common_1['HttpException'](_0x562420,common_1[_0x3dfaec(0x1b1)][_0x3dfaec(0x118)]);}}async['delAllGptsChat'](_0x10097a){const _0x45e9b2=_0x28e1da;try{const {id:_0x45e139}=_0x10097a[_0x45e9b2(0x196)],_0x545abb=await this[_0x45e9b2(0x153)][_0x45e9b2(0x112)]({'where':{'userId':_0x45e139}})[_0x45e9b2(0x15d)](_0x4672ca=>{const _0x1ea014=_0x45e9b2;common_1[_0x1ea014(0x181)]['error'](_0x4672ca);throw new Error(_0x4672ca);});if(!_0x545abb||_0x545abb[_0x45e9b2(0x18c)]===0x0)throw new Error('当前用户没有创建GPT对话！');const _0x85b7cf=_0x545abb[_0x45e9b2(0x156)](_0x12eb21=>_0x12eb21['groupId']);await this[_0x45e9b2(0x179)][_0x45e9b2(0x148)]({'ids':_0x85b7cf,'userId':_0x45e139})[_0x45e9b2(0x15d)](_0x2f1e01=>{throw new Error(_0x2f1e01);});const _0x5b9d6a=await this[_0x45e9b2(0x153)][_0x45e9b2(0x121)]({'userId':_0x45e139,'isSticky':![]})[_0x45e9b2(0x15d)](_0x4c5a7e=>{throw new Error(_0x4c5a7e);});if(!_0x5b9d6a)throw new Error(_0x45e9b2(0x1a2));return!![];}catch(_0x513181){throw new common_1[(_0x45e9b2(0x1ab))](_0x513181,common_1[_0x45e9b2(0x1b1)][_0x45e9b2(0x118)]);}}async[_0x28e1da(0x1a1)](_0x5782f8){const _0x106fe9=_0x28e1da;return await this[_0x106fe9(0x153)]['findOne']({'where':{'id':_0x5782f8}});}async[_0x28e1da(0x163)](_0xd2066e){const _0x518cad=_0x28e1da,_0x2d00bf=await this[_0x518cad(0x153)][_0x518cad(0x16b)]({'where':{'id':_0xd2066e}}),_0x96ca77=await this['gptsModelEntity'][_0x518cad(0x16b)]({'where':{'id':_0x2d00bf['modelId']}}),_0x44e6f5=await this['modelsService'][_0x518cad(0x14b)](model_constant_1['EModelType'][_0x518cad(0x1b5)]);return _0x44e6f5['modelName']=_0x96ca77[_0x518cad(0x172)],_0x44e6f5[_0x518cad(0x17b)]=_0x96ca77[_0x518cad(0x119)]||_0x96ca77[_0x518cad(0x14c)],_0x96ca77['deduct']!==undefined&&(_0x44e6f5[_0x518cad(0x19b)]=_0x96ca77[_0x518cad(0x19b)]),_0x96ca77[_0x518cad(0x178)]!==undefined&&(_0x44e6f5[_0x518cad(0x178)]=_0x96ca77['vipFreeNum']),_0x44e6f5;}async[_0x28e1da(0x171)](_0x545809,_0xd6c17d){const _0x5055b9=_0x28e1da;await this['gptsGroupEntity'][_0x5055b9(0x135)]()['update'](gpts_group_entity_1[_0x5055b9(0x190)])[_0x5055b9(0x128)]({'useCount':()=>_0x5055b9(0x199),'useToken':()=>'useToken\x20+\x20'+_0xd6c17d})['where'](_0x5055b9(0x142),{'id':_0x545809})[_0x5055b9(0x11b)]();}async[_0x28e1da(0x18e)](_0x543996,_0x5ceac0){const _0x5f4d3b=_0x28e1da,_0x2c3952={'id':_0x543996};return _0x5ceac0!=null&&_0x5ceac0!==undefined&&(_0x2c3952[_0x5f4d3b(0x1b0)]=_0x5ceac0),this['gptsModelEntity']['findOne']({'where':_0x2c3952});}async['getAppByIdWithCollect'](_0x3ed034,_0x1e92f9,_0x2c084f){const _0x3fcc08=_0x28e1da,_0x4800de={'id':_0x1e92f9};_0x2c084f!=null&&_0x2c084f!==undefined&&(_0x4800de[_0x3fcc08(0x1b0)]=_0x2c084f);const _0x27a190=await this['gptsModelEntity'][_0x3fcc08(0x16b)]({'where':_0x4800de});if(_0x3ed034[_0x3fcc08(0x196)]){const _0x16ea8b=await this['userAppsEntity'][_0x3fcc08(0x16b)]({'where':{'userId':_0x3ed034[_0x3fcc08(0x196)]['id'],'appId':_0x1e92f9}});if(_0x16ea8b)return{..._0x27a190,'collected':!![]};}return{..._0x27a190,'collected':![]};}async[_0x28e1da(0x16c)](_0x1e8e1b){const _0x5a1767=_0x28e1da;if(!_0x1e8e1b)throw new common_1[(_0x5a1767(0x1ab))]('缺失必要参数！',common_1['HttpStatus'][_0x5a1767(0x118)]);return await this['gptsModelEntity']['findOne']({'where':{'id':_0x1e8e1b}});}};GptsService=__decorate([(0x0,common_1[_0x28e1da(0x169)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(userApps_entity_1['UserAppsEntity'])),__param(0x1,(0x0,typeorm_1[_0x28e1da(0x1a0)])(gpts_group_entity_1[_0x28e1da(0x190)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(gpts_model_entity_1[_0x28e1da(0x193)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(gpts_chat_entity_1[_0x28e1da(0x143)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x28e1da(0x12e)],typeorm_2['Repository'],nestjs_cls_1['ClsService'],models_service_1[_0x28e1da(0x195)],chatLog_service_1[_0x28e1da(0x180)],chatGroup_service_1[_0x28e1da(0x10d)]])],GptsService),exports[_0x28e1da(0x17e)]=GptsService;