'use strict';const _0x36867f=_0x4ac1;function _0x3f20(){const _0x3b623a=['createdAt','modelId','delete','__param','modelName','当前用户没有创建GPT对话！','EModelType','useToken\x20+\x20','gptsChatEntity','当前分类存在应用,不允许删除！','HttpStatus','28iFqpuS','function','logo','defineProperty','add','model','Logger','../chatLog/chatLog.service','应用分类不存在,无法删除！','GptsChatEntity','isPlatform','updateGptsChat','assign','应用分类不存在！','groupName','find','getAppById','768865pVcXwQ','length','order','update','__metadata','handleAddGroup','HttpException','ceil','gpts不存在,无法删除！','模型组不存在！','getCurrentModelByChatGroupId','typeorm','favorite','ChatLogService','useCount','random','error:\x20','./gpts.model.entity','where','分类已存在！','title','BAD_REQUEST','saasId','gptsModelEntity','affected','getOwnPropertyDescriptor','非法操作、您在使用一个不存在的应用！','UserAppsEntity','./gpts.chat.entity','getAppByIdWithCollect','handleAddGptsBatch','getGroupInfoFromId','removeLogsBatch','新对话','Repository','user','11308041SBOHws','InjectRepository','status','isDefined','relModel','object','GptsGroupEntity','ClsService','design:paramtypes','canAudio','hasHistory','7659141YxCHPd','handleGetGroup','isSticky','fingerprint','popular','map','./gpts.group.entity','desc','DESC','forEach','appId','useCount\x20+\x201','findOne','demoData','chatLogService','handleQueryGpts','mine','decorate','log','367140HhkHQh','clsService','GptsService','delAllGptsChat','21765ZvNIdQ','collectCount','getExistGpts','groupId','metadata','nestjs-cls','模型不存在！','非法操作、您在删除一个非法资源！','__decorate','config','Equal','get','createQueryBuilder','../../common/constants/model.constant','gptsGroupEntity','更新对话失败！','catch','getReqSaasId','2669140qgHSTM','push','message','set','6210114AGWWOJ','handleRemoveGpts','userId','save','has','handleAddGpts','includes','@nestjs/typeorm','当前应用已经开启了一个对话无需新建了！','canUpload','id\x20=\x20:id','modelInfo','modelsService','parse','16mYshEo','count','userAppsEntity','stringify','then','清空失败！','findAndCount','delGptsChat','APP','headers','gptsApp','8drowvb','filter','getLastByUserAndAppIds','应用类型不可更改！','GptsModelEntity','getUserId'];_0x3f20=function(){return _0x3b623a;};return _0x3f20();}(function(_0x663168,_0x20866f){const _0x2f55a5=_0x4ac1,_0x1a79e2=_0x663168();while(!![]){try{const _0x162acb=-parseInt(_0x2f55a5(0x20e))/0x1+parseInt(_0x2f55a5(0x1bb))/0x2*(-parseInt(_0x2f55a5(0x17b))/0x3)+parseInt(_0x2f55a5(0x19f))/0x4*(parseInt(_0x2f55a5(0x1cc))/0x5)+parseInt(_0x2f55a5(0x191))/0x6+parseInt(_0x2f55a5(0x1fb))/0x7*(parseInt(_0x2f55a5(0x1aa))/0x8)+-parseInt(_0x2f55a5(0x1f0))/0x9+-parseInt(_0x2f55a5(0x18d))/0xa;if(_0x162acb===_0x20866f)break;else _0x1a79e2['push'](_0x1a79e2['shift']());}catch(_0x2270f4){_0x1a79e2['push'](_0x1a79e2['shift']());}}}(_0x3f20,0xb7a49));var __decorate=this&&this[_0x36867f(0x183)]||function(_0xbf6b89,_0x4fc65a,_0x45e6eb,_0x53a1c9){const _0x22268f=_0x36867f;var _0x28f2fc=arguments[_0x22268f(0x1cd)],_0x523080=_0x28f2fc<0x3?_0x4fc65a:_0x53a1c9===null?_0x53a1c9=Object[_0x22268f(0x1e5)](_0x4fc65a,_0x45e6eb):_0x53a1c9,_0xb6962c;if(typeof Reflect===_0x22268f(0x1f5)&&typeof Reflect[_0x22268f(0x20c)]==='function')_0x523080=Reflect[_0x22268f(0x20c)](_0xbf6b89,_0x4fc65a,_0x45e6eb,_0x53a1c9);else{for(var _0xbbd344=_0xbf6b89[_0x22268f(0x1cd)]-0x1;_0xbbd344>=0x0;_0xbbd344--)if(_0xb6962c=_0xbf6b89[_0xbbd344])_0x523080=(_0x28f2fc<0x3?_0xb6962c(_0x523080):_0x28f2fc>0x3?_0xb6962c(_0x4fc65a,_0x45e6eb,_0x523080):_0xb6962c(_0x4fc65a,_0x45e6eb))||_0x523080;}return _0x28f2fc>0x3&&_0x523080&&Object[_0x22268f(0x1be)](_0x4fc65a,_0x45e6eb,_0x523080),_0x523080;},__metadata=this&&this[_0x36867f(0x1d0)]||function(_0x2945b8,_0x115167){const _0x4563d8=_0x36867f;if(typeof Reflect===_0x4563d8(0x1f5)&&typeof Reflect[_0x4563d8(0x17f)]===_0x4563d8(0x1bc))return Reflect[_0x4563d8(0x17f)](_0x2945b8,_0x115167);},__param=this&&this[_0x36867f(0x1b3)]||function(_0x21653c,_0x4e08a5){return function(_0x3e80f8,_0x111257){_0x4e08a5(_0x3e80f8,_0x111257,_0x21653c);};};function _0x4ac1(_0x306de9,_0x37bbd2){const _0x3f20a5=_0x3f20();return _0x4ac1=function(_0x4ac17d,_0x154cef){_0x4ac17d=_0x4ac17d-0x17b;let _0x9f338d=_0x3f20a5[_0x4ac17d];return _0x9f338d;},_0x4ac1(_0x306de9,_0x37bbd2);}Object[_0x36867f(0x1be)](exports,'__esModule',{'value':!![]}),exports['GptsService']=void 0x0;const common_1=require('@nestjs/common'),typeorm_1=require(_0x36867f(0x198)),gpts_group_entity_1=require(_0x36867f(0x201)),typeorm_2=require(_0x36867f(0x1d7)),gpts_model_entity_1=require(_0x36867f(0x1dd)),gpts_chat_entity_1=require(_0x36867f(0x1e8)),chatLog_service_1=require(_0x36867f(0x1c2)),utils_1=require('../../common/utils'),models_service_1=require('../models/models.service'),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x36867f(0x188)),nestjs_cls_1=require(_0x36867f(0x180));let GptsService=class GptsService{constructor(_0xa78891,_0x10e90b,_0x212496,_0x3440e5,_0x174782,_0xe1a45d,_0x4a50c0){const _0x169a86=_0x36867f;this['userAppsEntity']=_0xa78891,this[_0x169a86(0x189)]=_0x10e90b,this[_0x169a86(0x1e3)]=_0x212496,this[_0x169a86(0x1b8)]=_0x3440e5,this['clsService']=_0x174782,this[_0x169a86(0x19d)]=_0xe1a45d,this['chatLogService']=_0x4a50c0;}async[_0x36867f(0x1d1)](_0x1e449d){const _0x17b0ed=_0x36867f;try{const _0x231da7=_0x1e449d[_0x17b0ed(0x1c9)],_0x30a256=(0x0,utils_1[_0x17b0ed(0x18c)])(this[_0x17b0ed(0x20f)]),_0x299378=await this['gptsGroupEntity'][_0x17b0ed(0x207)]({'where':{'groupName':_0x231da7,'saasId':_0x30a256}});if(_0x299378)throw new common_1[(_0x17b0ed(0x1d2))](_0x17b0ed(0x1df),common_1[_0x17b0ed(0x1ba)][_0x17b0ed(0x1e1)]);return await this['gptsGroupEntity'][_0x17b0ed(0x194)]({..._0x1e449d,'saasId':_0x30a256}),!![];}catch(_0x5498ba){throw new common_1['HttpException'](_0x5498ba[_0x17b0ed(0x18f)],common_1[_0x17b0ed(0x1ba)][_0x17b0ed(0x1e1)]);}}async['handleUpdateGroup'](_0x500442){const _0x438feb=_0x36867f;try{const _0x45b3cf=await this[_0x438feb(0x189)][_0x438feb(0x207)]({'where':{'id':_0x500442['id']}});if(!_0x45b3cf)throw new common_1['HttpException'](_0x438feb(0x1d5),common_1[_0x438feb(0x1ba)][_0x438feb(0x1e1)]);return await this[_0x438feb(0x189)]['update']({'id':_0x500442['id']},_0x500442),!![];}catch(_0x5eb1af){throw new common_1[(_0x438feb(0x1d2))](_0x5eb1af['message'],common_1['HttpStatus'][_0x438feb(0x1e1)]);}}async['handleRemoveGroup'](_0xd51391){const _0x35b471=_0x36867f;try{const _0x1f5f6a=_0xd51391['id'],_0x1a1c57=await this[_0x35b471(0x189)][_0x35b471(0x207)]({'where':{'id':_0x1f5f6a}});if(!_0x1a1c57)throw new common_1[(_0x35b471(0x1d2))](_0x35b471(0x1c3),common_1['HttpStatus'][_0x35b471(0x1e1)]);const _0x2d2388=await this[_0x35b471(0x1e3)][_0x35b471(0x1a0)]({'where':{'groupId':_0x1a1c57['id']}});if(_0x2d2388>0x0)throw new common_1[(_0x35b471(0x1d2))](_0x35b471(0x1b9),common_1[_0x35b471(0x1ba)][_0x35b471(0x1e1)]);else await this[_0x35b471(0x189)][_0x35b471(0x1b2)]({'id':_0x1f5f6a});}catch(_0x20738f){throw new common_1[(_0x35b471(0x1d2))](_0x20738f['message'],common_1[_0x35b471(0x1ba)][_0x35b471(0x1e1)]);}}async['handleQueryGroup'](_0x20a667,_0x208e7f){const _0x2652f8=_0x36867f;try{const _0x2ca7a1=(0x0,utils_1[_0x2652f8(0x18c)])(this[_0x2652f8(0x20f)]),{page:page=0x1,size:size=0x14,status:_0x54309c,saasId:_0x5264c0,groupName:_0xae9919}=_0x20a667,_0x26676d={};return _0xae9919&&(_0x26676d['groupName']=_0xae9919),_0x54309c>=0x0&&(_0x26676d[_0x2652f8(0x1f2)]=_0x54309c),(0x0,utils_1[_0x2652f8(0x1c5)])(this[_0x2652f8(0x20f)])?(0x0,utils_1[_0x2652f8(0x1f3)])(_0x5264c0)&&(_0x26676d[_0x2652f8(0x1e2)]=_0x5264c0):_0x26676d[_0x2652f8(0x1e2)]=_0x2ca7a1,await this[_0x2652f8(0x189)][_0x2652f8(0x1a5)]({'where':_0x26676d,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x2652f8(0x203),'id':_0x2652f8(0x203)}})['then'](([_0x64b806,_0x2840dc])=>({'rows':_0x64b806,'count':_0x2840dc}))['catch'](_0x543f9a=>{throw new Error(_0x543f9a);});}catch(_0x6c75d7){console['log']('error:\x20',_0x6c75d7);throw new common_1[(_0x2652f8(0x1d2))](_0x6c75d7,common_1[_0x2652f8(0x1ba)][_0x2652f8(0x1e1)]);}}async[_0x36867f(0x1fc)](_0x22b48f,_0x1b7d05){const _0x300c7b=_0x36867f;try{const {groupId:_0x1c40f1}=_0x22b48f;return await this[_0x300c7b(0x189)]['findOne']({'where':{'id':Number(_0x1c40f1)}})[_0x300c7b(0x1a3)](_0x4191df=>{return _0x4191df;})[_0x300c7b(0x18b)](_0xc734b4=>{throw new Error(_0xc734b4);});}catch(_0x53f31f){console['log'](_0x300c7b(0x1dc),_0x53f31f);throw new common_1[(_0x300c7b(0x1d2))](_0x53f31f,common_1['HttpStatus'][_0x300c7b(0x1e1)]);}}async[_0x36867f(0x196)](_0xece619,_0x4cf66a){const _0x128cda=_0x36867f;try{const _0x1f24c0=_0xece619['user']['id'],_0xec9528=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x3f5b46=Object[_0x128cda(0x1c7)](new gpts_model_entity_1['GptsModelEntity'](),_0x4cf66a);_0x3f5b46['status']=Number(_0x4cf66a['status']);if(_0x3f5b46['id']){const _0x104034=await this[_0x128cda(0x1e3)][_0x128cda(0x207)]({'where':{'id':_0x3f5b46['id']}});if(!_0x104034)throw new common_1[(_0x128cda(0x1d2))](_0x128cda(0x181),common_1['HttpStatus'][_0x128cda(0x1e1)]);if(_0x104034['gptsApp']!==_0x3f5b46[_0x128cda(0x1a9)])throw new common_1[(_0x128cda(0x1d2))](_0x128cda(0x1ad),common_1[_0x128cda(0x1ba)][_0x128cda(0x1e1)]);return await this[_0x128cda(0x1e3)][_0x128cda(0x1cf)]({'id':_0x3f5b46['id']},{..._0x3f5b46,'useCount':_0x3f5b46[_0x128cda(0x1da)]??_0x104034[_0x128cda(0x1da)],'collectCount':_0x3f5b46[_0x128cda(0x17c)]??_0x104034[_0x128cda(0x17c)]})['then'](_0x4886ed=>_0x4886ed[_0x128cda(0x1e4)]>0x0)['catch'](_0xfbe850=>{throw new Error(_0xfbe850);});}else{const _0x365b4b=await this[_0x128cda(0x189)][_0x128cda(0x207)]({'where':{'id':_0x3f5b46[_0x128cda(0x17e)]}});if(!_0x365b4b)throw new common_1[(_0x128cda(0x1d2))](_0x128cda(0x1c8),common_1[_0x128cda(0x1ba)][_0x128cda(0x1e1)]);const _0x5f525e=await this[_0x128cda(0x1e3)][_0x128cda(0x194)]({..._0x3f5b46,'saasId':_0xec9528,'userId':_0xece619[_0x128cda(0x1a8)][_0x128cda(0x1fe)]?_0x1f24c0:null});return _0x5f525e['id'];}}catch(_0x4aafe4){throw new common_1[(_0x128cda(0x1d2))](_0x4aafe4,common_1[_0x128cda(0x1ba)][_0x128cda(0x1e1)]);}}async[_0x36867f(0x17d)](){const _0x384f92=_0x36867f;return await this[_0x384f92(0x1e3)]['find']()[_0x384f92(0x1a3)](_0x146fca=>_0x146fca[_0x384f92(0x200)](_0x863f2c=>_0x863f2c[_0x384f92(0x1b4)]));}async[_0x36867f(0x1ea)](_0xf4474f){const _0x222fb8=_0x36867f;try{const _0x2363ed=(0x0,utils_1[_0x222fb8(0x18c)])(this['clsService']),_0x527212=await this[_0x222fb8(0x17d)](),_0x56d2b9=_0xf4474f[_0x222fb8(0x1ab)](_0x54b0e9=>!_0x527212[_0x222fb8(0x197)](_0x54b0e9['modelName']))[_0x222fb8(0x200)](_0x15beb9=>({'groupId':_0x15beb9['groupId'],'relModel':_0x15beb9[_0x222fb8(0x1f4)],'logo':_0x15beb9[_0x222fb8(0x1bd)],'desc':_0x15beb9[_0x222fb8(0x202)],'modelName':_0x15beb9[_0x222fb8(0x1b4)],'modelId':_0x15beb9[_0x222fb8(0x1b1)],'saasId':_0x2363ed}));return await this[_0x222fb8(0x1e3)][_0x222fb8(0x194)](_0x56d2b9)['catch'](_0x39c2a8=>{throw new Error(_0x39c2a8);});}catch(_0x40a2f9){console['log'](_0x222fb8(0x1dc),_0x40a2f9);throw new common_1[(_0x222fb8(0x1d2))](_0x40a2f9,common_1[_0x222fb8(0x1ba)][_0x222fb8(0x1e1)]);}}async[_0x36867f(0x20a)](_0x20f03d,_0x429937){const _0x28f239=_0x36867f;try{const _0x342501=(0x0,utils_1[_0x28f239(0x1af)])(this[_0x28f239(0x20f)]),_0x4e5f1e=(0x0,utils_1[_0x28f239(0x18c)])(this['clsService']),_0x11b544=new Set(),_0x53f3b6=new Map(),{modelId:_0x5918b7,modelName:_0xcc8f7c,groupId:_0x4783eb,back:_0x1fc15b,status:_0x1d7b17,page:page=0x1,size:size=0x14,saasId:_0x4ddfd2}=_0x20f03d,_0x77a8fc={'delFlag':![]};_0x342501?_0x77a8fc['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x28f239(0x185)])(_0x342501),(0x0,typeorm_2['IsNull'])()):_0x77a8fc[_0x28f239(0x193)]=(0x0,typeorm_2['IsNull'])();(0x0,utils_1[_0x28f239(0x1c5)])(this[_0x28f239(0x20f)])?(0x0,utils_1[_0x28f239(0x1f3)])(_0x4ddfd2)&&(_0x77a8fc[_0x28f239(0x1e2)]=_0x4ddfd2):_0x77a8fc[_0x28f239(0x1e2)]=_0x4e5f1e;!_0x1fc15b?_0x77a8fc[_0x28f239(0x1f2)]=0x1:(_0x1d7b17!==undefined&&_0x1d7b17!==null&&(_0x77a8fc[_0x28f239(0x1f2)]=_0x1d7b17),delete _0x77a8fc[_0x28f239(0x193)]);_0x5918b7&&(_0x77a8fc['modelId']=_0x5918b7),_0x4783eb&&(_0x77a8fc[_0x28f239(0x17e)]=_0x4783eb),_0xcc8f7c&&(_0x77a8fc[_0x28f239(0x1b4)]=(0x0,typeorm_2['Like'])('%'+_0xcc8f7c+'%'));const [_0x3b1dd1,_0x1746ab]=await this[_0x28f239(0x1e3)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x77a8fc,'order':{'sortId':_0x28f239(0x203)}});if(_0x3b1dd1['length']){const _0x1357a7=[],_0x2f40a8=[];_0x3b1dd1[_0x28f239(0x204)](_0x27aa67=>{const _0x1bae2d=_0x28f239;_0x1357a7[_0x1bae2d(0x18e)](_0x27aa67['id']),_0x2f40a8[_0x1bae2d(0x18e)](_0x27aa67[_0x1bae2d(0x17e)]);});if(_0x342501){const _0x48fbd3=await this[_0x28f239(0x1a1)][_0x28f239(0x1ca)]({'where':{'userId':_0x342501,'appId':(0x0,typeorm_2['In'])(_0x1357a7)}});_0x48fbd3[_0x28f239(0x204)](_0x3a8771=>_0x11b544[_0x28f239(0x1bf)](_0x3a8771['appId']));}const _0x25f5b1=await this[_0x28f239(0x189)][_0x28f239(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2f40a8)}});_0x25f5b1['forEach'](_0x544670=>_0x53f3b6['set'](_0x544670['id'],_0x544670));}return{'count':_0x1746ab,'rows':_0x3b1dd1[_0x28f239(0x200)](_0x353fcd=>({..._0x353fcd,'collected':_0x11b544[_0x28f239(0x195)](_0x353fcd['id']),'groupName':_0x53f3b6[_0x28f239(0x186)](_0x353fcd[_0x28f239(0x17e)])?.['groupName']}))};}catch(_0xa6b2cb){console[_0x28f239(0x20d)](_0x28f239(0x1dc),_0xa6b2cb);throw new common_1[(_0x28f239(0x1d2))](_0xa6b2cb,common_1[_0x28f239(0x1ba)][_0x28f239(0x1e1)]);}}async['listByFrontType'](_0x52797b,_0x2c4aef){const _0x518e8a=_0x36867f,_0x830d4a=(0x0,utils_1[_0x518e8a(0x1af)])(this[_0x518e8a(0x20f)]),_0x2d84bc=(0x0,utils_1['getReqSaasId'])(this[_0x518e8a(0x20f)]),_0xe33406={'take':0x1e};if(_0x2c4aef=='recommend')_0xe33406[_0x518e8a(0x1de)]={'status':0x1,'delFlag':![],'recommend':!![]},_0xe33406['order']={'createdAt':'DESC'};else{if(_0x2c4aef===_0x518e8a(0x1ff))_0xe33406[_0x518e8a(0x1de)]={'status':0x1,'delFlag':![]},_0xe33406[_0x518e8a(0x1ce)]={'useCount':'DESC'};else{if(_0x2c4aef===_0x518e8a(0x1d8))_0xe33406['where']={'status':0x1,'delFlag':![]},_0xe33406[_0x518e8a(0x1ce)]={'collectCount':_0x518e8a(0x203)};else{if(_0x2c4aef===_0x518e8a(0x20b)){if(!_0x830d4a)throw new common_1[(_0x518e8a(0x1d2))]('请先登录！',common_1[_0x518e8a(0x1ba)]['UNAUTHORIZED']);_0xe33406[_0x518e8a(0x1de)]={'status':0x1,'delFlag':![],'userId':_0x830d4a},_0xe33406[_0x518e8a(0x1ce)]={'createdAt':_0x518e8a(0x203)};}else _0xe33406['where']={'status':0x1,'delFlag':![]},_0xe33406[_0x518e8a(0x1ce)]={'createdAt':_0x518e8a(0x203)};}}}_0xe33406['where'][_0x518e8a(0x1e2)]=_0x2d84bc;const _0x5f08b0=await this[_0x518e8a(0x1e3)][_0x518e8a(0x1ca)](_0xe33406),_0x2ff690=new Set(),_0x483051=new Map(),_0x14654=new Map(),_0x2dd201=[],_0x4f9839=[];_0x5f08b0[_0x518e8a(0x204)](_0x58eafc=>{const _0x4c1460=_0x518e8a;_0x2dd201[_0x4c1460(0x18e)](_0x58eafc['id']),_0x4f9839[_0x4c1460(0x18e)](_0x58eafc[_0x4c1460(0x17e)]);});if(_0x2dd201[_0x518e8a(0x1cd)]){if(_0x830d4a){const _0x5f0224=await this['userAppsEntity']['find']({'where':{'userId':_0x830d4a,'appId':(0x0,typeorm_2['In'])(_0x2dd201)}});_0x5f0224[_0x518e8a(0x204)](_0x2b1879=>_0x2ff690[_0x518e8a(0x1bf)](_0x2b1879[_0x518e8a(0x205)]));const _0x2ff2b6=await this['chatLogService'][_0x518e8a(0x1ac)](_0x830d4a,_0x2dd201);_0x2ff2b6[_0x518e8a(0x204)](_0x4582e3=>_0x483051['set'](_0x4582e3[_0x518e8a(0x205)],_0x4582e3[_0x518e8a(0x1b0)]));}const _0x1bb8f9=await this[_0x518e8a(0x189)][_0x518e8a(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4f9839)}});_0x1bb8f9['forEach'](_0x4200f6=>_0x14654[_0x518e8a(0x190)](_0x4200f6['id'],_0x4200f6));}return _0x5f08b0['map'](_0x5aa91c=>({..._0x5aa91c,'collected':_0x2ff690['has'](_0x5aa91c['id']),'lastTime':_0x483051[_0x518e8a(0x186)](_0x5aa91c['id'])||null,'groupName':_0x14654[_0x518e8a(0x186)](_0x5aa91c[_0x518e8a(0x17e)])?.[_0x518e8a(0x1c9)]}));}async[_0x36867f(0x192)](_0x28a3b7){const _0x7b51f7=_0x36867f;try{const {id:_0x306239}=_0x28a3b7,_0x2ab341=await this[_0x7b51f7(0x1e3)][_0x7b51f7(0x207)]({'where':{'id':_0x306239}});if(!_0x2ab341)throw new common_1[(_0x7b51f7(0x1d2))](_0x7b51f7(0x1d4),common_1['HttpStatus'][_0x7b51f7(0x1e1)]);return await this[_0x7b51f7(0x1e3)]['delete'](_0x306239)['then'](_0x532440=>_0x532440[_0x7b51f7(0x1e4)]>0x0)[_0x7b51f7(0x18b)](_0x2a68b9=>{throw new Error(_0x2a68b9);});}catch(_0x2a5e75){console[_0x7b51f7(0x20d)](_0x7b51f7(0x1dc),_0x2a5e75);throw new common_1['HttpException'](_0x2a5e75,common_1[_0x7b51f7(0x1ba)][_0x7b51f7(0x1e1)]);}}async['handleCreateChat'](_0x4c8d06,_0x1ef1d7){const _0x1d89c0=_0x36867f,_0xf99c7=_0x4c8d06[_0x1d89c0(0x205)],_0x13cb61=_0x1ef1d7[_0x1d89c0(0x1ef)]['id'],_0x122876=(0x0,utils_1[_0x1d89c0(0x18c)])(this[_0x1d89c0(0x20f)]);let _0x4f0060=null,_0x2ae702={'title':_0x1d89c0(0x1ed),'userId':_0x13cb61,'saasId':_0x122876};try{_0x4f0060=await this[_0x1d89c0(0x1e3)][_0x1d89c0(0x207)]({'where':{'id':_0xf99c7}});if(!_0x4f0060)throw new Error(_0x1d89c0(0x1e6));if(_0x4f0060['status']!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');if(!_0x4c8d06[_0x1d89c0(0x1fa)]){const _0x5583b8=await this[_0x1d89c0(0x1b8)][_0x1d89c0(0x1a0)]({'where':{'modelId':_0xf99c7,'userId':_0x13cb61,'isDelete':![]}});if(_0x5583b8>0x0)throw new Error(_0x1d89c0(0x199));}_0x2ae702[_0x1d89c0(0x1b1)]=_0x4f0060['id'],_0x2ae702[_0x1d89c0(0x1c0)]=_0x4f0060[_0x1d89c0(0x1b1)],_0x2ae702['groupId']=_0x4f0060[_0x1d89c0(0x17e)],_0x2ae702[_0x1d89c0(0x202)]=_0x4f0060[_0x1d89c0(0x202)]||'',_0x2ae702[_0x1d89c0(0x1bd)]=_0x4f0060[_0x1d89c0(0x1bd)]||'',_0x2ae702[_0x1d89c0(0x1e0)]=_0x4c8d06[_0x1d89c0(0x1fa)]?_0x1d89c0(0x1ed):_0x4f0060[_0x1d89c0(0x1b4)],_0x2ae702[_0x1d89c0(0x208)]=_0x4f0060['demoData']||'';let _0x3d00fa=await this['modelsService']['getModelByType'](model_constant_1[_0x1d89c0(0x1b6)][_0x1d89c0(0x1a7)]);_0x3d00fa[_0x1d89c0(0x19c)]['canAudio']=_0x4f0060[_0x1d89c0(0x1f9)],_0x3d00fa['modelInfo']['modelName']=_0x4f0060[_0x1d89c0(0x1b4)],_0x3d00fa['modelInfo'][_0x1d89c0(0x19a)]=_0x4f0060['canUpload'];_0x4f0060[_0x1d89c0(0x1a9)]?_0x3d00fa[_0x1d89c0(0x19c)][_0x1d89c0(0x1c0)]=_0x4f0060[_0x1d89c0(0x1b1)]:_0x3d00fa['modelInfo'][_0x1d89c0(0x1c0)]=_0x4f0060[_0x1d89c0(0x1f4)];_0x2ae702[_0x1d89c0(0x184)]=JSON[_0x1d89c0(0x1a2)](_0x3d00fa);const _0x211e73=await this[_0x1d89c0(0x1b8)][_0x1d89c0(0x194)](_0x2ae702);return _0x4f0060&&(_0x4f0060[_0x1d89c0(0x1da)]=_0x4f0060[_0x1d89c0(0x1da)]+Math[_0x1d89c0(0x1d3)](Math[_0x1d89c0(0x1db)]()*0xa),await this[_0x1d89c0(0x1e3)][_0x1d89c0(0x194)](_0x4f0060)),_0x211e73;}catch(_0xfa6dc1){throw new common_1['HttpException'](_0xfa6dc1[_0x1d89c0(0x18f)],common_1[_0x1d89c0(0x1ba)][_0x1d89c0(0x1e1)]);}}async['handleGetChat'](_0x3ce512,_0x424419){const _0x60032=_0x36867f;try{const _0x15a13d=_0x3ce512[_0x60032(0x1ef)]['id'],_0x149dc1={'userId':_0x15a13d,'isDelete':![]};_0x424419&&(_0x149dc1[_0x60032(0x1b1)]=_0x424419);const _0xfff56d=await this[_0x60032(0x1b8)][_0x60032(0x1ca)]({'where':_0x149dc1,'order':{'isSticky':_0x60032(0x203),'id':_0x60032(0x203)}}),_0x4569ac=new Set(),_0x28811c=new Map(),_0x5925bf=new Map(),_0xfd5cf1=[],_0x2808fa=[];_0xfff56d[_0x60032(0x204)](_0x524a99=>{const _0xb12e69=_0x60032;_0xfd5cf1['push'](_0x524a99[_0xb12e69(0x1b1)]),_0x2808fa[_0xb12e69(0x18e)](_0x524a99[_0xb12e69(0x17e)]);});if(_0xfd5cf1[_0x60032(0x1cd)]){const _0x4aaa87=await this[_0x60032(0x1a1)][_0x60032(0x1ca)]({'where':{'userId':_0x15a13d,'appId':(0x0,typeorm_2['In'])(_0xfd5cf1)}});_0x4aaa87['forEach'](_0x5f56f8=>_0x4569ac[_0x60032(0x1bf)](_0x5f56f8['appId']));const _0x5292ef=await this[_0x60032(0x1e3)][_0x60032(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0xfd5cf1),'status':0x1,'delFlag':![]}});_0x5292ef[_0x60032(0x204)](_0x200a9c=>_0x28811c[_0x60032(0x190)](_0x200a9c['id'],_0x200a9c));const _0x566a73=await this[_0x60032(0x189)][_0x60032(0x1ca)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2808fa)}});_0x566a73['forEach'](_0xe0e3ea=>_0x5925bf[_0x60032(0x190)](_0xe0e3ea['id'],_0xe0e3ea));}return _0xfff56d['map'](_0x174e7a=>{const _0x23e366=_0x60032,_0x43e01c=_0x28811c[_0x23e366(0x186)](_0x174e7a[_0x23e366(0x1b1)]);if(_0x43e01c?.[_0x23e366(0x1a9)]){const _0x4a03ca=JSON[_0x23e366(0x19e)](_0x174e7a[_0x23e366(0x184)]);_0x4a03ca[_0x23e366(0x19c)][_0x23e366(0x1c0)]=_0x43e01c[_0x23e366(0x1b1)],_0x174e7a[_0x23e366(0x184)]=JSON['stringify'](_0x4a03ca);}return{..._0x174e7a,'modelName':_0x174e7a[_0x23e366(0x1e0)],'gptsApp':_0x43e01c?.[_0x23e366(0x1a9)],'collected':_0x4569ac['has'](_0x174e7a[_0x23e366(0x1b1)]),'groupName':_0x5925bf[_0x23e366(0x186)](_0x174e7a[_0x23e366(0x17e)])?.[_0x23e366(0x1c9)]};});}catch(_0x1651bc){console[_0x60032(0x20d)](_0x60032(0x1dc),_0x1651bc);throw new common_1[(_0x60032(0x1d2))](_0x1651bc,common_1[_0x60032(0x1ba)][_0x60032(0x1e1)]);}}async[_0x36867f(0x1c6)](_0x3d8bbd,_0x5e5a5a){const _0x8f9504=_0x36867f,{title:_0x4d1432,isSticky:_0x1f1678,groupId:_0x412c2,config:_0x4abaf5}=_0x3d8bbd,{id:_0x399f2c}=_0x5e5a5a[_0x8f9504(0x1ef)],_0x325fda=await this['gptsChatEntity'][_0x8f9504(0x207)]({'where':{'id':_0x412c2,'userId':_0x399f2c}});if(!_0x325fda)throw new common_1[(_0x8f9504(0x1d2))]('GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x8f9504(0x1ba)][_0x8f9504(0x1e1)]);const _0x67bd1c={};_0x67bd1c['title']=_0x4d1432||_0x325fda[_0x8f9504(0x1e0)],_0x67bd1c['config']=_0x4abaf5||_0x325fda[_0x8f9504(0x184)],_0x67bd1c[_0x8f9504(0x1fd)]=_0x1f1678??_0x325fda[_0x8f9504(0x1fd)];const _0x29d153=await this[_0x8f9504(0x1b8)][_0x8f9504(0x1cf)]({'id':_0x412c2},_0x67bd1c);if(_0x29d153[_0x8f9504(0x1e4)])return!![];else throw new common_1[(_0x8f9504(0x1d2))](_0x8f9504(0x18a),common_1[_0x8f9504(0x1ba)][_0x8f9504(0x1e1)]);}async[_0x36867f(0x1a6)](_0x4e684e,_0xdd227f){const _0x37fe6f=_0x36867f;try{const {groupId:_0x14cb1f}=_0x4e684e,{id:_0xb6c283}=_0xdd227f[_0x37fe6f(0x1ef)],_0x4d6137=await this[_0x37fe6f(0x1b8)][_0x37fe6f(0x207)]({'where':{'id':_0x14cb1f,'userId':_0xb6c283}})[_0x37fe6f(0x18b)](_0x2e0d45=>{const _0x2cb05a=_0x37fe6f;common_1[_0x2cb05a(0x1c1)]['error'](_0x2e0d45);throw new Error(_0x2e0d45);});if(!_0x4d6137)throw new Error(_0x37fe6f(0x182));await this['chatLogService'][_0x37fe6f(0x1ec)]({'userId':_0xb6c283,'ids':[_0x14cb1f]})[_0x37fe6f(0x18b)](_0xd6d44=>{throw new Error(_0xd6d44);});const _0x5670a4=await this['gptsChatEntity'][_0x37fe6f(0x1b2)]({'id':_0x14cb1f})[_0x37fe6f(0x18b)](_0x433b81=>{throw new Error(_0x433b81);});if(!_0x5670a4)throw new Error('删除失败！');return!![];}catch(_0x39934f){throw new common_1['HttpException'](_0x39934f,common_1[_0x37fe6f(0x1ba)][_0x37fe6f(0x1e1)]);}}async[_0x36867f(0x211)](_0xc860fe){const _0x478891=_0x36867f;try{const {id:_0x5a4ed8}=_0xc860fe[_0x478891(0x1ef)],_0xf7667f=await this['gptsChatEntity'][_0x478891(0x1ca)]({'where':{'userId':_0x5a4ed8}})[_0x478891(0x18b)](_0x2fe6a9=>{const _0x23aa74=_0x478891;common_1[_0x23aa74(0x1c1)]['error'](_0x2fe6a9);throw new Error(_0x2fe6a9);});if(!_0xf7667f||_0xf7667f[_0x478891(0x1cd)]===0x0)throw new Error(_0x478891(0x1b5));const _0x14f5f3=_0xf7667f[_0x478891(0x200)](_0x173431=>_0x173431[_0x478891(0x17e)]);await this[_0x478891(0x209)]['removeLogsBatch']({'ids':_0x14f5f3,'userId':_0x5a4ed8})[_0x478891(0x18b)](_0x1ba971=>{throw new Error(_0x1ba971);});const _0x28befc=await this[_0x478891(0x1b8)]['delete']({'userId':_0x5a4ed8,'isSticky':![]})[_0x478891(0x18b)](_0x29f2b7=>{throw new Error(_0x29f2b7);});if(!_0x28befc)throw new Error(_0x478891(0x1a4));return!![];}catch(_0x147ad0){throw new common_1[(_0x478891(0x1d2))](_0x147ad0,common_1[_0x478891(0x1ba)][_0x478891(0x1e1)]);}}async[_0x36867f(0x1eb)](_0x39ff03){const _0x42ba15=_0x36867f;return await this[_0x42ba15(0x1b8)]['findOne']({'where':{'id':_0x39ff03}});}async[_0x36867f(0x1d6)](_0xc154f3){const _0x43ae12=_0x36867f,_0x49a680=await this['gptsChatEntity'][_0x43ae12(0x207)]({'where':{'id':_0xc154f3}}),_0x411cf2=await this[_0x43ae12(0x1e3)][_0x43ae12(0x207)]({'where':{'id':_0x49a680[_0x43ae12(0x1b1)]}}),_0x3eb21e=await this[_0x43ae12(0x19d)]['getRandomKey'](model_constant_1[_0x43ae12(0x1b6)][_0x43ae12(0x1a7)]);return _0x3eb21e['modelName']=_0x411cf2[_0x43ae12(0x1b4)],_0x3eb21e[_0x43ae12(0x1c0)]=_0x411cf2['modelId']||_0x411cf2[_0x43ae12(0x1f4)],_0x3eb21e;}async['saveGptsUseLog'](_0x2cbb80,_0x3be3f2){const _0x427407=_0x36867f;await this[_0x427407(0x189)][_0x427407(0x187)]()[_0x427407(0x1cf)](gpts_group_entity_1[_0x427407(0x1f6)])[_0x427407(0x190)]({'useCount':()=>_0x427407(0x206),'useToken':()=>_0x427407(0x1b7)+_0x3be3f2})[_0x427407(0x1de)](_0x427407(0x19b),{'id':_0x2cbb80})['execute']();}async[_0x36867f(0x1cb)](_0x7fb25b,_0x647881){const _0x54790e=_0x36867f,_0x55569b={'id':_0x7fb25b};return _0x647881!=null&&_0x647881!==undefined&&(_0x55569b['status']=_0x647881),this[_0x54790e(0x1e3)][_0x54790e(0x207)]({'where':_0x55569b});}async[_0x36867f(0x1e9)](_0x17b2bc,_0x19de24,_0x20ad1c){const _0x275f94=_0x36867f,_0x16d1d1={'id':_0x19de24};_0x20ad1c!=null&&_0x20ad1c!==undefined&&(_0x16d1d1[_0x275f94(0x1f2)]=_0x20ad1c);const _0x58e518=await this[_0x275f94(0x1e3)][_0x275f94(0x207)]({'where':_0x16d1d1});if(_0x17b2bc[_0x275f94(0x1ef)]){const _0x18f5cf=await this[_0x275f94(0x1a1)][_0x275f94(0x207)]({'where':{'userId':_0x17b2bc[_0x275f94(0x1ef)]['id'],'appId':_0x19de24}});if(_0x18f5cf)return{..._0x58e518,'collected':!![]};}return{..._0x58e518,'collected':![]};}};GptsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(userApps_entity_1[_0x36867f(0x1e7)])),__param(0x1,(0x0,typeorm_1[_0x36867f(0x1f1)])(gpts_group_entity_1[_0x36867f(0x1f6)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(gpts_model_entity_1[_0x36867f(0x1ae)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(gpts_chat_entity_1[_0x36867f(0x1c4)])),__metadata(_0x36867f(0x1f8),[typeorm_2[_0x36867f(0x1ee)],typeorm_2[_0x36867f(0x1ee)],typeorm_2[_0x36867f(0x1ee)],typeorm_2[_0x36867f(0x1ee)],nestjs_cls_1[_0x36867f(0x1f7)],models_service_1['ModelsService'],chatLog_service_1[_0x36867f(0x1d9)]])],GptsService),exports[_0x36867f(0x210)]=GptsService;