'use strict';const _0x9b5a92=_0x14be;function _0x5de1(){const _0x226f74=['Equal','应用分类不存在！','gptsChatEntity','当前分类存在应用,不允许删除！','getUserId','removeLogsBatch','isPlatform','headers','add','GptsModelEntity','IsNull','1475830taSzMX','__decorate','GptsGroupEntity','createQueryBuilder','save','user','HttpStatus','请先登录！','清空失败！','handleCreateChat','gptsGroupEntity','33TTYsJV','parse','getGroupInfoFromId','模型组不存在！','message','groupName','config','ModelsService','catch','handleUpdateGroup','metadata','modelName','groupId','gptsApp','fingerprint','error','push','id\x20=\x20:id','88GrymGo','__esModule','decorate','canAudio','hasHistory','appId','nestjs-cls','status','1355670rLaxdU','defineProperty','__metadata','./gpts.model.entity','ClsService','length','relModel','modelsService','has','HttpException','modelId','当前应用已经开启了一个对话无需新建了！','function','findOne','handleAddGroup','isDefined','userAppsEntity','165732dlAGAy','ceil','recommend','error:\x20','clsService','175805UQfKrI','handleGetGroup','getAppById','应用分类不存在,无法删除！','getRandomKey','12pbIbqc','order','delGptsChat','count','./gpts.group.entity','log','应用类型不可更改！','./gpts.chat.entity','../models/models.service','APP','isSticky','createdAt','Logger','更新对话失败！','21wSfDRP','typeorm','assign','object','gptsModelEntity','find','非法操作、您在删除一个非法资源！','handleRemoveGpts','collectCount','1181376aOhiDm','model','includes','非法操作、您在使用一个未启用的应用！','map','affected','45454wuwpzO','findAndCount','getModelByType','分类已存在！','saasId','favorite','mine','handleGetChat','demoData','Injectable','canUpload','@nestjs/typeorm','chatLogService','EModelType','当前用户没有创建GPT对话！','forEach','638775yvVPvK','模型不存在！','set','execute','random','Repository','modelInfo','../../common/utils','handleRemoveGroup','saveGptsUseLog','logo','UserAppsEntity','@nestjs/common','title','删除失败！','GptsService','getExistGpts','DESC','update','getAppByIdWithCollect','getReqSaasId','gpts不存在,无法删除！','../../common/constants/model.constant','BAD_REQUEST','新对话','handleQueryGpts','useCount','delete','get','where','handleAddGptsBatch','desc','InjectRepository','updateGptsChat','ChatLogService','GptsChatEntity','6gOtmwW','then','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','getLastByUserAndAppIds','userId','filter','popular'];_0x5de1=function(){return _0x226f74;};return _0x5de1();}(function(_0x5e412a,_0x502b69){const _0xa0c5d=_0x14be,_0x5a4311=_0x5e412a();while(!![]){try{const _0x23db0d=parseInt(_0xa0c5d(0x1c7))/0x1*(parseInt(_0xa0c5d(0x1d6))/0x2)+parseInt(_0xa0c5d(0x1af))/0x3*(-parseInt(_0xa0c5d(0x1b9))/0x4)+parseInt(_0xa0c5d(0x21c))/0x5*(-parseInt(_0xa0c5d(0x20a))/0x6)+-parseInt(_0xa0c5d(0x1b4))/0x7*(parseInt(_0xa0c5d(0x239))/0x8)+parseInt(_0xa0c5d(0x1e6))/0x9+parseInt(_0xa0c5d(0x241))/0xa*(parseInt(_0xa0c5d(0x227))/0xb)+parseInt(_0xa0c5d(0x1d0))/0xc;if(_0x23db0d===_0x502b69)break;else _0x5a4311['push'](_0x5a4311['shift']());}catch(_0x340e25){_0x5a4311['push'](_0x5a4311['shift']());}}}(_0x5de1,0x4d344));var __decorate=this&&this[_0x9b5a92(0x21d)]||function(_0x330058,_0xc76fca,_0xe8c120,_0xc2559a){const _0x99ffec=_0x9b5a92;var _0x3d39ff=arguments['length'],_0x3b8e79=_0x3d39ff<0x3?_0xc76fca:_0xc2559a===null?_0xc2559a=Object['getOwnPropertyDescriptor'](_0xc76fca,_0xe8c120):_0xc2559a,_0x45b0c2;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x99ffec(0x24d))_0x3b8e79=Reflect[_0x99ffec(0x23b)](_0x330058,_0xc76fca,_0xe8c120,_0xc2559a);else{for(var _0x281a35=_0x330058[_0x99ffec(0x246)]-0x1;_0x281a35>=0x0;_0x281a35--)if(_0x45b0c2=_0x330058[_0x281a35])_0x3b8e79=(_0x3d39ff<0x3?_0x45b0c2(_0x3b8e79):_0x3d39ff>0x3?_0x45b0c2(_0xc76fca,_0xe8c120,_0x3b8e79):_0x45b0c2(_0xc76fca,_0xe8c120))||_0x3b8e79;}return _0x3d39ff>0x3&&_0x3b8e79&&Object[_0x99ffec(0x242)](_0xc76fca,_0xe8c120,_0x3b8e79),_0x3b8e79;},__metadata=this&&this[_0x9b5a92(0x243)]||function(_0x7abbd9,_0x37ca02){const _0x365d3e=_0x9b5a92;if(typeof Reflect===_0x365d3e(0x1ca)&&typeof Reflect[_0x365d3e(0x231)]===_0x365d3e(0x24d))return Reflect[_0x365d3e(0x231)](_0x7abbd9,_0x37ca02);},__param=this&&this['__param']||function(_0x231671,_0x1a260b){return function(_0x4d36b0,_0x4b7b22){_0x1a260b(_0x4d36b0,_0x4b7b22,_0x231671);};};Object[_0x9b5a92(0x242)](exports,_0x9b5a92(0x23a),{'value':!![]}),exports[_0x9b5a92(0x1f5)]=void 0x0;const common_1=require(_0x9b5a92(0x1f2)),typeorm_1=require(_0x9b5a92(0x1e1)),gpts_group_entity_1=require(_0x9b5a92(0x1bd)),typeorm_2=require(_0x9b5a92(0x1c8)),gpts_model_entity_1=require(_0x9b5a92(0x244)),gpts_chat_entity_1=require(_0x9b5a92(0x1c0)),chatLog_service_1=require('../chatLog/chatLog.service'),utils_1=require(_0x9b5a92(0x1ed)),models_service_1=require(_0x9b5a92(0x1c1)),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x9b5a92(0x1fc)),nestjs_cls_1=require(_0x9b5a92(0x23f));let GptsService=class GptsService{constructor(_0x2e19a5,_0x5acc05,_0x2ef8c1,_0x4da963,_0x2b8372,_0x272500,_0xd8747c){const _0x29b586=_0x9b5a92;this[_0x29b586(0x1ae)]=_0x2e19a5,this['gptsGroupEntity']=_0x5acc05,this[_0x29b586(0x1cb)]=_0x2ef8c1,this[_0x29b586(0x213)]=_0x4da963,this[_0x29b586(0x1b3)]=_0x2b8372,this[_0x29b586(0x248)]=_0x272500,this[_0x29b586(0x1e2)]=_0xd8747c;}async[_0x9b5a92(0x24f)](_0x307d31){const _0x26f3a=_0x9b5a92;try{const _0x2b282b=_0x307d31[_0x26f3a(0x22c)],_0x3e876d=(0x0,utils_1[_0x26f3a(0x1fa)])(this[_0x26f3a(0x1b3)]),_0x2a0242=await this[_0x26f3a(0x226)][_0x26f3a(0x24e)]({'where':{'groupName':_0x2b282b,'saasId':_0x3e876d}});if(_0x2a0242)throw new common_1[(_0x26f3a(0x24a))](_0x26f3a(0x1d9),common_1[_0x26f3a(0x222)]['BAD_REQUEST']);return await this[_0x26f3a(0x226)][_0x26f3a(0x220)]({..._0x307d31,'saasId':_0x3e876d}),!![];}catch(_0x2cb1b6){throw new common_1[(_0x26f3a(0x24a))](_0x2cb1b6[_0x26f3a(0x22b)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x9b5a92(0x230)](_0x661698){const _0x20e5dd=_0x9b5a92;try{const _0x2582a2=await this[_0x20e5dd(0x226)][_0x20e5dd(0x24e)]({'where':{'id':_0x661698['id']}});if(!_0x2582a2)throw new common_1['HttpException'](_0x20e5dd(0x22a),common_1['HttpStatus'][_0x20e5dd(0x1fd)]);return await this['gptsGroupEntity']['update']({'id':_0x661698['id']},_0x661698),!![];}catch(_0x410bb8){throw new common_1['HttpException'](_0x410bb8[_0x20e5dd(0x22b)],common_1[_0x20e5dd(0x222)][_0x20e5dd(0x1fd)]);}}async[_0x9b5a92(0x1ee)](_0x2efa07){const _0x5b05eb=_0x9b5a92;try{const _0x452bd8=_0x2efa07['id'],_0x34cad1=await this['gptsGroupEntity'][_0x5b05eb(0x24e)]({'where':{'id':_0x452bd8}});if(!_0x34cad1)throw new common_1['HttpException'](_0x5b05eb(0x1b7),common_1['HttpStatus'][_0x5b05eb(0x1fd)]);const _0x424523=await this[_0x5b05eb(0x1cb)][_0x5b05eb(0x1bc)]({'where':{'groupId':_0x34cad1['id']}});if(_0x424523>0x0)throw new common_1[(_0x5b05eb(0x24a))](_0x5b05eb(0x214),common_1['HttpStatus'][_0x5b05eb(0x1fd)]);else await this[_0x5b05eb(0x226)][_0x5b05eb(0x201)]({'id':_0x452bd8});}catch(_0x518d01){throw new common_1[(_0x5b05eb(0x24a))](_0x518d01[_0x5b05eb(0x22b)],common_1['HttpStatus'][_0x5b05eb(0x1fd)]);}}async['handleQueryGroup'](_0x141318,_0x443e2d){const _0x574e41=_0x9b5a92;try{const _0x401310=(0x0,utils_1[_0x574e41(0x1fa)])(this[_0x574e41(0x1b3)]),{page:page=0x1,size:size=0x14,status:_0x2b0465,saasId:_0x6bf87c,groupName:_0x373918}=_0x141318,_0x517a0e={};return _0x373918&&(_0x517a0e['groupName']=_0x373918),_0x2b0465>=0x0&&(_0x517a0e['status']=_0x2b0465),(0x0,utils_1[_0x574e41(0x217)])(this[_0x574e41(0x1b3)])?(0x0,utils_1['isDefined'])(_0x6bf87c)&&(_0x517a0e['saasId']=_0x6bf87c):_0x517a0e[_0x574e41(0x1da)]=_0x401310,await this[_0x574e41(0x226)]['findAndCount']({'where':_0x517a0e,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x574e41(0x1f7),'id':_0x574e41(0x1f7)}})[_0x574e41(0x20b)](([_0x3d0c32,_0x51660f])=>({'rows':_0x3d0c32,'count':_0x51660f}))['catch'](_0x3390af=>{throw new Error(_0x3390af);});}catch(_0x522d88){console[_0x574e41(0x1be)](_0x574e41(0x1b2),_0x522d88);throw new common_1['HttpException'](_0x522d88,common_1[_0x574e41(0x222)]['BAD_REQUEST']);}}async[_0x9b5a92(0x1b5)](_0x2e7547,_0x11a6ca){const _0x4df06a=_0x9b5a92;try{const {groupId:_0x120628}=_0x2e7547;return await this[_0x4df06a(0x226)][_0x4df06a(0x24e)]({'where':{'id':Number(_0x120628)}})[_0x4df06a(0x20b)](_0x3b4844=>{return _0x3b4844;})['catch'](_0x343777=>{throw new Error(_0x343777);});}catch(_0x30fca0){console['log'](_0x4df06a(0x1b2),_0x30fca0);throw new common_1[(_0x4df06a(0x24a))](_0x30fca0,common_1['HttpStatus']['BAD_REQUEST']);}}async['handleAddGpts'](_0x7b52a8,_0x4ac732){const _0x1cc69f=_0x9b5a92;try{const _0x3a82e9=_0x7b52a8[_0x1cc69f(0x221)]['id'],_0x197566=(0x0,utils_1[_0x1cc69f(0x1fa)])(this[_0x1cc69f(0x1b3)]),_0x3f84b6=Object[_0x1cc69f(0x1c9)](new gpts_model_entity_1[(_0x1cc69f(0x21a))](),_0x4ac732);_0x3f84b6['status']=Number(_0x4ac732['status']);if(_0x3f84b6['id']){const _0x27e614=await this[_0x1cc69f(0x1cb)][_0x1cc69f(0x24e)]({'where':{'id':_0x3f84b6['id']}});if(!_0x27e614)throw new common_1[(_0x1cc69f(0x24a))](_0x1cc69f(0x1e7),common_1[_0x1cc69f(0x222)][_0x1cc69f(0x1fd)]);if(_0x27e614[_0x1cc69f(0x234)]!==_0x3f84b6[_0x1cc69f(0x234)])throw new common_1[(_0x1cc69f(0x24a))](_0x1cc69f(0x1bf),common_1['HttpStatus'][_0x1cc69f(0x1fd)]);return await this[_0x1cc69f(0x1cb)][_0x1cc69f(0x1f8)]({'id':_0x3f84b6['id']},{..._0x3f84b6,'useCount':_0x3f84b6[_0x1cc69f(0x200)]??_0x27e614[_0x1cc69f(0x200)],'collectCount':_0x3f84b6['collectCount']??_0x27e614[_0x1cc69f(0x1cf)]})[_0x1cc69f(0x20b)](_0x46061a=>_0x46061a[_0x1cc69f(0x1d5)]>0x0)[_0x1cc69f(0x22f)](_0x45b7bf=>{throw new Error(_0x45b7bf);});}else{const _0x5b3160=await this['gptsGroupEntity'][_0x1cc69f(0x24e)]({'where':{'id':_0x3f84b6[_0x1cc69f(0x233)]}});if(!_0x5b3160)throw new common_1['HttpException'](_0x1cc69f(0x212),common_1[_0x1cc69f(0x222)][_0x1cc69f(0x1fd)]);const _0x297904=await this['gptsModelEntity'][_0x1cc69f(0x220)]({..._0x3f84b6,'saasId':_0x197566,'userId':_0x7b52a8[_0x1cc69f(0x218)][_0x1cc69f(0x235)]?_0x3a82e9:null});return _0x297904['id'];}}catch(_0x45d975){throw new common_1[(_0x1cc69f(0x24a))](_0x45d975,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x9b5a92(0x1f6)](){const _0x43a439=_0x9b5a92;return await this[_0x43a439(0x1cb)][_0x43a439(0x1cc)]()['then'](_0x16ed53=>_0x16ed53[_0x43a439(0x1d4)](_0x100fad=>_0x100fad[_0x43a439(0x232)]));}async[_0x9b5a92(0x204)](_0x443c27){const _0x44e88c=_0x9b5a92;try{const _0x1fb720=(0x0,utils_1['getReqSaasId'])(this[_0x44e88c(0x1b3)]),_0x3f411d=await this['getExistGpts'](),_0x3acd04=_0x443c27[_0x44e88c(0x20f)](_0x3f2b85=>!_0x3f411d[_0x44e88c(0x1d2)](_0x3f2b85[_0x44e88c(0x232)]))[_0x44e88c(0x1d4)](_0x551662=>({'groupId':_0x551662[_0x44e88c(0x233)],'relModel':_0x551662['relModel'],'logo':_0x551662[_0x44e88c(0x1f0)],'desc':_0x551662[_0x44e88c(0x205)],'modelName':_0x551662[_0x44e88c(0x232)],'modelId':_0x551662['modelId'],'saasId':_0x1fb720}));return await this[_0x44e88c(0x1cb)][_0x44e88c(0x220)](_0x3acd04)[_0x44e88c(0x22f)](_0x4ae969=>{throw new Error(_0x4ae969);});}catch(_0x145012){console[_0x44e88c(0x1be)](_0x44e88c(0x1b2),_0x145012);throw new common_1[(_0x44e88c(0x24a))](_0x145012,common_1[_0x44e88c(0x222)][_0x44e88c(0x1fd)]);}}async[_0x9b5a92(0x1ff)](_0x3f94f4,_0xc20869){const _0x260e7b=_0x9b5a92;try{const _0x492e8d=(0x0,utils_1[_0x260e7b(0x215)])(this[_0x260e7b(0x1b3)]),_0x567dd9=(0x0,utils_1[_0x260e7b(0x1fa)])(this[_0x260e7b(0x1b3)]),_0x59b0b6=new Set(),_0x1da214=new Map(),{modelId:_0x7bc15c,modelName:_0x28297b,groupId:_0x467c0d,back:_0x370f60,status:_0x1993b5,page:page=0x1,size:size=0x14,saasId:_0x476717}=_0x3f94f4,_0x426ab9={'delFlag':![]};_0x492e8d?_0x426ab9[_0x260e7b(0x20e)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x260e7b(0x211)])(_0x492e8d),(0x0,typeorm_2[_0x260e7b(0x21b)])()):_0x426ab9[_0x260e7b(0x20e)]=(0x0,typeorm_2[_0x260e7b(0x21b)])();(0x0,utils_1[_0x260e7b(0x217)])(this['clsService'])?(0x0,utils_1[_0x260e7b(0x1ad)])(_0x476717)&&(_0x426ab9['saasId']=_0x476717):_0x426ab9[_0x260e7b(0x1da)]=_0x567dd9;!_0x370f60?_0x426ab9[_0x260e7b(0x240)]=0x1:(_0x1993b5!==undefined&&_0x1993b5!==null&&(_0x426ab9[_0x260e7b(0x240)]=_0x1993b5),delete _0x426ab9[_0x260e7b(0x20e)]);_0x7bc15c&&(_0x426ab9[_0x260e7b(0x24b)]=_0x7bc15c),_0x467c0d&&(_0x426ab9['groupId']=_0x467c0d),_0x28297b&&(_0x426ab9['modelName']=(0x0,typeorm_2['Like'])('%'+_0x28297b+'%'));const [_0x16d502,_0x1de8c5]=await this['gptsModelEntity'][_0x260e7b(0x1d7)]({'skip':(page-0x1)*size,'take':size,'where':_0x426ab9,'order':{'sortId':_0x260e7b(0x1f7)}});if(_0x16d502[_0x260e7b(0x246)]){const _0x66480c=[],_0x107951=[];_0x16d502[_0x260e7b(0x1e5)](_0x55dc1c=>{const _0x353870=_0x260e7b;_0x66480c[_0x353870(0x237)](_0x55dc1c['id']),_0x107951[_0x353870(0x237)](_0x55dc1c['groupId']);});if(_0x492e8d){const _0x41f240=await this[_0x260e7b(0x1ae)][_0x260e7b(0x1cc)]({'where':{'userId':_0x492e8d,'appId':(0x0,typeorm_2['In'])(_0x66480c)}});_0x41f240['forEach'](_0x4ccada=>_0x59b0b6[_0x260e7b(0x219)](_0x4ccada['appId']));}const _0x2c2f5c=await this[_0x260e7b(0x226)][_0x260e7b(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x107951)}});_0x2c2f5c[_0x260e7b(0x1e5)](_0xc71161=>_0x1da214['set'](_0xc71161['id'],_0xc71161));}return{'count':_0x1de8c5,'rows':_0x16d502[_0x260e7b(0x1d4)](_0x2fe2ae=>({..._0x2fe2ae,'collected':_0x59b0b6['has'](_0x2fe2ae['id']),'groupName':_0x1da214[_0x260e7b(0x202)](_0x2fe2ae[_0x260e7b(0x233)])?.['groupName']}))};}catch(_0x54714f){console[_0x260e7b(0x1be)](_0x260e7b(0x1b2),_0x54714f);throw new common_1[(_0x260e7b(0x24a))](_0x54714f,common_1['HttpStatus'][_0x260e7b(0x1fd)]);}}async['listByFrontType'](_0x32200b,_0x2019ff){const _0x2aee8c=_0x9b5a92,_0x414eb5=(0x0,utils_1[_0x2aee8c(0x215)])(this[_0x2aee8c(0x1b3)]),_0x2a2531=(0x0,utils_1[_0x2aee8c(0x1fa)])(this['clsService']),_0xc87dbc={'take':0x1e};if(_0x2019ff==_0x2aee8c(0x1b1))_0xc87dbc[_0x2aee8c(0x203)]={'status':0x1,'delFlag':![],'recommend':!![]},_0xc87dbc[_0x2aee8c(0x1ba)]={'createdAt':_0x2aee8c(0x1f7)};else{if(_0x2019ff===_0x2aee8c(0x210))_0xc87dbc['where']={'status':0x1,'delFlag':![]},_0xc87dbc[_0x2aee8c(0x1ba)]={'useCount':_0x2aee8c(0x1f7)};else{if(_0x2019ff===_0x2aee8c(0x1db))_0xc87dbc[_0x2aee8c(0x203)]={'status':0x1,'delFlag':![]},_0xc87dbc[_0x2aee8c(0x1ba)]={'collectCount':_0x2aee8c(0x1f7)};else{if(_0x2019ff===_0x2aee8c(0x1dc)){if(!_0x414eb5)throw new common_1[(_0x2aee8c(0x24a))](_0x2aee8c(0x223),common_1[_0x2aee8c(0x222)]['UNAUTHORIZED']);_0xc87dbc['where']={'status':0x1,'delFlag':![],'userId':_0x414eb5},_0xc87dbc['order']={'createdAt':_0x2aee8c(0x1f7)};}else _0xc87dbc[_0x2aee8c(0x203)]={'status':0x1,'delFlag':![]},_0xc87dbc['order']={'createdAt':_0x2aee8c(0x1f7)};}}}_0xc87dbc[_0x2aee8c(0x203)][_0x2aee8c(0x1da)]=_0x2a2531;const _0x4d8a16=await this[_0x2aee8c(0x1cb)][_0x2aee8c(0x1cc)](_0xc87dbc),_0x2550cd=new Set(),_0x5f05f0=new Map(),_0x5ed1cb=new Map(),_0x20543c=[],_0x6d535c=[];_0x4d8a16[_0x2aee8c(0x1e5)](_0x2bfd02=>{const _0x77bcba=_0x2aee8c;_0x20543c[_0x77bcba(0x237)](_0x2bfd02['id']),_0x6d535c[_0x77bcba(0x237)](_0x2bfd02[_0x77bcba(0x233)]);});if(_0x20543c[_0x2aee8c(0x246)]){if(_0x414eb5){const _0x3b0c04=await this[_0x2aee8c(0x1ae)][_0x2aee8c(0x1cc)]({'where':{'userId':_0x414eb5,'appId':(0x0,typeorm_2['In'])(_0x20543c)}});_0x3b0c04['forEach'](_0x25e678=>_0x2550cd[_0x2aee8c(0x219)](_0x25e678[_0x2aee8c(0x23e)]));const _0x576074=await this['chatLogService'][_0x2aee8c(0x20d)](_0x414eb5,_0x20543c);_0x576074[_0x2aee8c(0x1e5)](_0x1b23f7=>_0x5f05f0['set'](_0x1b23f7[_0x2aee8c(0x23e)],_0x1b23f7[_0x2aee8c(0x1c4)]));}const _0x3f9a94=await this[_0x2aee8c(0x226)][_0x2aee8c(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x6d535c)}});_0x3f9a94[_0x2aee8c(0x1e5)](_0x1448b6=>_0x5ed1cb['set'](_0x1448b6['id'],_0x1448b6));}return _0x4d8a16[_0x2aee8c(0x1d4)](_0x401bcf=>({..._0x401bcf,'collected':_0x2550cd[_0x2aee8c(0x249)](_0x401bcf['id']),'lastTime':_0x5f05f0[_0x2aee8c(0x202)](_0x401bcf['id'])||null,'groupName':_0x5ed1cb[_0x2aee8c(0x202)](_0x401bcf[_0x2aee8c(0x233)])?.['groupName']}));}async[_0x9b5a92(0x1ce)](_0x4fa9a9){const _0x4f8b69=_0x9b5a92;try{const {id:_0x45ead5}=_0x4fa9a9,_0x1f7a47=await this[_0x4f8b69(0x1cb)][_0x4f8b69(0x24e)]({'where':{'id':_0x45ead5}});if(!_0x1f7a47)throw new common_1[(_0x4f8b69(0x24a))](_0x4f8b69(0x1fb),common_1[_0x4f8b69(0x222)][_0x4f8b69(0x1fd)]);return await this['gptsModelEntity'][_0x4f8b69(0x201)](_0x45ead5)['then'](_0x2a7152=>_0x2a7152[_0x4f8b69(0x1d5)]>0x0)[_0x4f8b69(0x22f)](_0x13d6cc=>{throw new Error(_0x13d6cc);});}catch(_0x20e56e){console[_0x4f8b69(0x1be)](_0x4f8b69(0x1b2),_0x20e56e);throw new common_1[(_0x4f8b69(0x24a))](_0x20e56e,common_1[_0x4f8b69(0x222)][_0x4f8b69(0x1fd)]);}}async[_0x9b5a92(0x225)](_0x1ae448,_0x4331a3){const _0x51b855=_0x9b5a92,_0x3ca9ad=_0x1ae448[_0x51b855(0x23e)],_0x52ec2b=_0x4331a3[_0x51b855(0x221)]['id'],_0x4fff5d=(0x0,utils_1[_0x51b855(0x1fa)])(this['clsService']);let _0x15ad1d=null,_0x14695b={'title':_0x51b855(0x1fe),'userId':_0x52ec2b,'saasId':_0x4fff5d};try{_0x15ad1d=await this[_0x51b855(0x1cb)][_0x51b855(0x24e)]({'where':{'id':_0x3ca9ad}});if(!_0x15ad1d)throw new Error('非法操作、您在使用一个不存在的应用！');if(_0x15ad1d[_0x51b855(0x240)]!==0x1)throw new Error(_0x51b855(0x1d3));if(!_0x1ae448[_0x51b855(0x23d)]){const _0x9ae50b=await this[_0x51b855(0x213)][_0x51b855(0x1bc)]({'where':{'modelId':_0x3ca9ad,'userId':_0x52ec2b,'isDelete':![]}});if(_0x9ae50b>0x0)throw new Error(_0x51b855(0x24c));}_0x14695b[_0x51b855(0x24b)]=_0x15ad1d['id'],_0x14695b['model']=_0x15ad1d[_0x51b855(0x24b)],_0x14695b[_0x51b855(0x233)]=_0x15ad1d[_0x51b855(0x233)],_0x14695b[_0x51b855(0x205)]=_0x15ad1d[_0x51b855(0x205)]||'',_0x14695b[_0x51b855(0x1f0)]=_0x15ad1d[_0x51b855(0x1f0)]||'',_0x14695b[_0x51b855(0x1f3)]=_0x1ae448['hasHistory']?'新对话':_0x15ad1d[_0x51b855(0x232)],_0x14695b[_0x51b855(0x1de)]=_0x15ad1d[_0x51b855(0x1de)]||'';let _0x587a35=await this[_0x51b855(0x248)][_0x51b855(0x1d8)](model_constant_1[_0x51b855(0x1e3)][_0x51b855(0x1c2)]);_0x587a35['modelInfo'][_0x51b855(0x23c)]=_0x15ad1d[_0x51b855(0x23c)],_0x587a35[_0x51b855(0x1ec)][_0x51b855(0x232)]=_0x15ad1d['modelName'],_0x587a35[_0x51b855(0x1ec)]['canUpload']=_0x15ad1d[_0x51b855(0x1e0)];_0x15ad1d[_0x51b855(0x234)]?_0x587a35[_0x51b855(0x1ec)][_0x51b855(0x1d1)]=_0x15ad1d['modelId']:_0x587a35[_0x51b855(0x1ec)][_0x51b855(0x1d1)]=_0x15ad1d[_0x51b855(0x247)];_0x14695b['config']=JSON['stringify'](_0x587a35);const _0x421f02=await this[_0x51b855(0x213)][_0x51b855(0x220)](_0x14695b);return _0x15ad1d&&(_0x15ad1d[_0x51b855(0x200)]=_0x15ad1d[_0x51b855(0x200)]+Math[_0x51b855(0x1b0)](Math[_0x51b855(0x1ea)]()*0xa),await this[_0x51b855(0x1cb)][_0x51b855(0x220)](_0x15ad1d)),_0x421f02;}catch(_0xc6cf7e){throw new common_1[(_0x51b855(0x24a))](_0xc6cf7e[_0x51b855(0x22b)],common_1[_0x51b855(0x222)][_0x51b855(0x1fd)]);}}async[_0x9b5a92(0x1dd)](_0x586506,_0x4a328b){const _0x5da699=_0x9b5a92;try{const _0x8029f7=_0x586506['user']['id'],_0x1be09d={'userId':_0x8029f7,'isDelete':![]};_0x4a328b&&(_0x1be09d[_0x5da699(0x24b)]=_0x4a328b);const _0x5206a4=await this[_0x5da699(0x213)][_0x5da699(0x1cc)]({'where':_0x1be09d,'order':{'isSticky':_0x5da699(0x1f7),'id':_0x5da699(0x1f7)}}),_0x2fac8b=new Set(),_0x2a8c69=new Map(),_0xa41a07=new Map(),_0x16f0f7=[],_0x4631e7=[];_0x5206a4[_0x5da699(0x1e5)](_0x30f88b=>{const _0x1df070=_0x5da699;_0x16f0f7['push'](_0x30f88b[_0x1df070(0x24b)]),_0x4631e7[_0x1df070(0x237)](_0x30f88b['groupId']);});if(_0x16f0f7[_0x5da699(0x246)]){const _0x369847=await this['userAppsEntity'][_0x5da699(0x1cc)]({'where':{'userId':_0x8029f7,'appId':(0x0,typeorm_2['In'])(_0x16f0f7)}});_0x369847[_0x5da699(0x1e5)](_0x1d5472=>_0x2fac8b['add'](_0x1d5472[_0x5da699(0x23e)]));const _0x28d84e=await this[_0x5da699(0x1cb)][_0x5da699(0x1cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x16f0f7),'status':0x1,'delFlag':![]}});_0x28d84e['forEach'](_0x49549b=>_0x2a8c69[_0x5da699(0x1e8)](_0x49549b['id'],_0x49549b));const _0x4118b9=await this[_0x5da699(0x226)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x4631e7)}});_0x4118b9[_0x5da699(0x1e5)](_0x497741=>_0xa41a07[_0x5da699(0x1e8)](_0x497741['id'],_0x497741));}return _0x5206a4[_0x5da699(0x1d4)](_0x1a76bf=>{const _0x12a92e=_0x5da699,_0x5cbbe9=_0x2a8c69[_0x12a92e(0x202)](_0x1a76bf[_0x12a92e(0x24b)]);if(_0x5cbbe9?.[_0x12a92e(0x234)]){const _0x307f89=JSON[_0x12a92e(0x228)](_0x1a76bf['config']);_0x307f89[_0x12a92e(0x1ec)][_0x12a92e(0x1d1)]=_0x5cbbe9[_0x12a92e(0x24b)],_0x1a76bf['config']=JSON['stringify'](_0x307f89);}return{..._0x1a76bf,'modelName':_0x1a76bf['title'],'gptsApp':_0x5cbbe9?.[_0x12a92e(0x234)],'collected':_0x2fac8b[_0x12a92e(0x249)](_0x1a76bf[_0x12a92e(0x24b)]),'groupName':_0xa41a07[_0x12a92e(0x202)](_0x1a76bf[_0x12a92e(0x233)])?.['groupName']};});}catch(_0x5b3515){console[_0x5da699(0x1be)](_0x5da699(0x1b2),_0x5b3515);throw new common_1[(_0x5da699(0x24a))](_0x5b3515,common_1['HttpStatus'][_0x5da699(0x1fd)]);}}async[_0x9b5a92(0x207)](_0x43f383,_0x337ad0){const _0x516444=_0x9b5a92,{title:_0x369297,isSticky:_0x497bf9,groupId:_0x41c239,config:_0x378815}=_0x43f383,{id:_0x27e915}=_0x337ad0['user'],_0x5ea626=await this[_0x516444(0x213)]['findOne']({'where':{'id':_0x41c239,'userId':_0x27e915}});if(!_0x5ea626)throw new common_1[(_0x516444(0x24a))](_0x516444(0x20c),common_1[_0x516444(0x222)][_0x516444(0x1fd)]);const _0x251e67={};_0x251e67[_0x516444(0x1f3)]=_0x369297||_0x5ea626[_0x516444(0x1f3)],_0x251e67[_0x516444(0x22d)]=_0x378815||_0x5ea626[_0x516444(0x22d)],_0x251e67[_0x516444(0x1c3)]=_0x497bf9??_0x5ea626[_0x516444(0x1c3)];const _0x2f1b04=await this['gptsChatEntity'][_0x516444(0x1f8)]({'id':_0x41c239},_0x251e67);if(_0x2f1b04[_0x516444(0x1d5)])return!![];else throw new common_1['HttpException'](_0x516444(0x1c6),common_1[_0x516444(0x222)]['BAD_REQUEST']);}async[_0x9b5a92(0x1bb)](_0x4a93b7,_0x7cc063){const _0x28e232=_0x9b5a92;try{const {groupId:_0x16374a}=_0x4a93b7,{id:_0x53b469}=_0x7cc063['user'],_0x1e2f02=await this['gptsChatEntity'][_0x28e232(0x24e)]({'where':{'id':_0x16374a,'userId':_0x53b469}})['catch'](_0x452345=>{const _0xa7c8e9=_0x28e232;common_1[_0xa7c8e9(0x1c5)][_0xa7c8e9(0x236)](_0x452345);throw new Error(_0x452345);});if(!_0x1e2f02)throw new Error(_0x28e232(0x1cd));await this[_0x28e232(0x1e2)][_0x28e232(0x216)]({'userId':_0x53b469,'ids':[_0x16374a]})[_0x28e232(0x22f)](_0x3e32dc=>{throw new Error(_0x3e32dc);});const _0x9d08b9=await this[_0x28e232(0x213)][_0x28e232(0x201)]({'id':_0x16374a})[_0x28e232(0x22f)](_0xd943bb=>{throw new Error(_0xd943bb);});if(!_0x9d08b9)throw new Error(_0x28e232(0x1f4));return!![];}catch(_0x569a0b){throw new common_1[(_0x28e232(0x24a))](_0x569a0b,common_1[_0x28e232(0x222)][_0x28e232(0x1fd)]);}}async['delAllGptsChat'](_0x34558d){const _0x395be0=_0x9b5a92;try{const {id:_0x48bbeb}=_0x34558d[_0x395be0(0x221)],_0xfee75e=await this[_0x395be0(0x213)][_0x395be0(0x1cc)]({'where':{'userId':_0x48bbeb}})[_0x395be0(0x22f)](_0xb6704d=>{const _0x50502f=_0x395be0;common_1[_0x50502f(0x1c5)][_0x50502f(0x236)](_0xb6704d);throw new Error(_0xb6704d);});if(!_0xfee75e||_0xfee75e[_0x395be0(0x246)]===0x0)throw new Error(_0x395be0(0x1e4));const _0x1c1313=_0xfee75e[_0x395be0(0x1d4)](_0x5ebb17=>_0x5ebb17[_0x395be0(0x233)]);await this[_0x395be0(0x1e2)][_0x395be0(0x216)]({'ids':_0x1c1313,'userId':_0x48bbeb})[_0x395be0(0x22f)](_0x205209=>{throw new Error(_0x205209);});const _0x5d694c=await this[_0x395be0(0x213)][_0x395be0(0x201)]({'userId':_0x48bbeb,'isSticky':![]})[_0x395be0(0x22f)](_0xf45d51=>{throw new Error(_0xf45d51);});if(!_0x5d694c)throw new Error(_0x395be0(0x224));return!![];}catch(_0x23092f){throw new common_1[(_0x395be0(0x24a))](_0x23092f,common_1[_0x395be0(0x222)][_0x395be0(0x1fd)]);}}async[_0x9b5a92(0x229)](_0x144b24){const _0x343687=_0x9b5a92;return await this['gptsChatEntity'][_0x343687(0x24e)]({'where':{'id':_0x144b24}});}async['getCurrentModelByChatGroupId'](_0xfbe1b2){const _0x20dd9a=_0x9b5a92,_0x32e8e2=await this['gptsChatEntity']['findOne']({'where':{'id':_0xfbe1b2}}),_0x57602f=await this['gptsModelEntity'][_0x20dd9a(0x24e)]({'where':{'id':_0x32e8e2['modelId']}}),_0x48b606=await this[_0x20dd9a(0x248)][_0x20dd9a(0x1b8)](model_constant_1['EModelType'][_0x20dd9a(0x1c2)]);return _0x48b606['modelName']=_0x57602f['modelName'],_0x48b606[_0x20dd9a(0x1d1)]=_0x57602f[_0x20dd9a(0x24b)]||_0x57602f['relModel'],_0x48b606;}async[_0x9b5a92(0x1ef)](_0xe9d11c,_0xc9e33c){const _0x1ab20b=_0x9b5a92;await this[_0x1ab20b(0x226)][_0x1ab20b(0x21f)]()[_0x1ab20b(0x1f8)](gpts_group_entity_1['GptsGroupEntity'])[_0x1ab20b(0x1e8)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0xc9e33c})['where'](_0x1ab20b(0x238),{'id':_0xe9d11c})[_0x1ab20b(0x1e9)]();}async[_0x9b5a92(0x1b6)](_0x1d8331,_0x681565){const _0x53a4d3=_0x9b5a92,_0x52af84={'id':_0x1d8331};return _0x681565!=null&&_0x681565!==undefined&&(_0x52af84['status']=_0x681565),this[_0x53a4d3(0x1cb)]['findOne']({'where':_0x52af84});}async[_0x9b5a92(0x1f9)](_0x21211d,_0x4b9537,_0x50a782){const _0x48e602=_0x9b5a92,_0x100c99={'id':_0x4b9537};_0x50a782!=null&&_0x50a782!==undefined&&(_0x100c99[_0x48e602(0x240)]=_0x50a782);const _0x4fca4f=await this[_0x48e602(0x1cb)][_0x48e602(0x24e)]({'where':_0x100c99});if(_0x21211d[_0x48e602(0x221)]){const _0x332eb9=await this[_0x48e602(0x1ae)][_0x48e602(0x24e)]({'where':{'userId':_0x21211d['user']['id'],'appId':_0x4b9537}});if(_0x332eb9)return{..._0x4fca4f,'collected':!![]};}return{..._0x4fca4f,'collected':![]};}};function _0x14be(_0x39c75b,_0x23f9c1){const _0x5de1eb=_0x5de1();return _0x14be=function(_0x14be25,_0x58bc43){_0x14be25=_0x14be25-0x1ad;let _0x127098=_0x5de1eb[_0x14be25];return _0x127098;},_0x14be(_0x39c75b,_0x23f9c1);}GptsService=__decorate([(0x0,common_1[_0x9b5a92(0x1df)])(),__param(0x0,(0x0,typeorm_1[_0x9b5a92(0x206)])(userApps_entity_1[_0x9b5a92(0x1f1)])),__param(0x1,(0x0,typeorm_1[_0x9b5a92(0x206)])(gpts_group_entity_1[_0x9b5a92(0x21e)])),__param(0x2,(0x0,typeorm_1[_0x9b5a92(0x206)])(gpts_model_entity_1[_0x9b5a92(0x21a)])),__param(0x3,(0x0,typeorm_1[_0x9b5a92(0x206)])(gpts_chat_entity_1[_0x9b5a92(0x209)])),__metadata('design:paramtypes',[typeorm_2[_0x9b5a92(0x1eb)],typeorm_2['Repository'],typeorm_2[_0x9b5a92(0x1eb)],typeorm_2[_0x9b5a92(0x1eb)],nestjs_cls_1[_0x9b5a92(0x245)],models_service_1[_0x9b5a92(0x22e)],chatLog_service_1[_0x9b5a92(0x208)]])],GptsService),exports[_0x9b5a92(0x1f5)]=GptsService;