'use strict';function _0x1789(){const _0xb241dc=['error','useCount\x20+\x201','popular','modelsService','getOwnPropertyDescriptor','has','gptsApp','then','../models/models.service','gptsModelEntity','../../common/constants/model.constant','InjectRepository','handleRemoveGpts','./gpts.model.entity','favorite','getGroupInfoFromId','应用分类不存在,无法删除！','add','./gpts.group.entity','canAudio','chatLogService','2493AshRlI','188916VmNDoD','handleQueryGpts','405143DPoAqz','10390GumbvW','10rZJXPb','非法操作、您在删除一个非法资源！','find','handleGetGroup','getAppById','id\x20=\x20:id','modelName','非法操作、您在使用一个不存在的应用！','12598311OcVaKv','count','includes','length','log','__metadata','useToken\x20+\x20','findAndCount','39193fLPqyI','message','headers','desc','execute','modelInfo','userId','EModelType','getModelByType','findOne','Repository','@nestjs/common','isDefined','模型不存在！','user','当前用户没有创建GPT对话！','getUserId','GptsModelEntity','isPlatform','collectCount','set','catch','status','Logger','BAD_REQUEST','map','saasId','forEach','1229457MioeiY','清空失败！','请先登录！','ceil','ChatLogService','GptsGroupEntity','../../common/utils','error:\x20','非法操作、您在使用一个未启用的应用！','useCount','模型组不存在！','getExistGpts','function','getLastByUserAndAppIds','createQueryBuilder','modelId','ClsService','HttpException','handleAddGptsBatch','getReqSaasId','affected','GptsService','recommend','typeorm','新对话','../app/userApps.entity','handleUpdateGroup','__esModule','defineProperty','push','config','canUpload','Injectable','Like','demoData','488PrWRKL','where','当前应用已经开启了一个对话无需新建了！','title','gptsChatEntity','nestjs-cls','save','handleAddGroup','object','__decorate','userAppsEntity','order','model','parse','filter','handleRemoveGroup','relModel','getCurrentModelByChatGroupId','get','stringify','UserAppsEntity','DESC','handleAddGpts','handleGetChat','2zCIzAG','decorate','HttpStatus','appId','clsService','groupId','当前分类存在应用,不允许删除！','mine','ModelsService','delete','fingerprint','gptsGroupEntity','删除失败！','630672xAnPST','metadata','__param','saveGptsUseLog','removeLogsBatch','APP','logo','random','handleQueryGroup','update','isSticky'];_0x1789=function(){return _0xb241dc;};return _0x1789();}const _0x2562f7=_0x2dad;(function(_0x1257bf,_0x208249){const _0xfa4bd6=_0x2dad,_0x38330a=_0x1257bf();while(!![]){try{const _0x1bf121=-parseInt(_0xfa4bd6(0xd7))/0x1*(-parseInt(_0xfa4bd6(0xa7))/0x2)+-parseInt(_0xfa4bd6(0x105))/0x3+-parseInt(_0xfa4bd6(0xb4))/0x4+parseInt(_0xfa4bd6(0xd9))/0x5*(-parseInt(_0xfa4bd6(0xd5))/0x6)+-parseInt(_0xfa4bd6(0xe9))/0x7*(parseInt(_0xfa4bd6(0x128))/0x8)+parseInt(_0xfa4bd6(0xd4))/0x9*(-parseInt(_0xfa4bd6(0xd8))/0xa)+parseInt(_0xfa4bd6(0xe1))/0xb;if(_0x1bf121===_0x208249)break;else _0x38330a['push'](_0x38330a['shift']());}catch(_0x15864a){_0x38330a['push'](_0x38330a['shift']());}}}(_0x1789,0x46f53));function _0x2dad(_0x14a45d,_0x1b9b12){const _0x17891d=_0x1789();return _0x2dad=function(_0x2dad82,_0x126d5a){_0x2dad82=_0x2dad82-0x9a;let _0x4ed53e=_0x17891d[_0x2dad82];return _0x4ed53e;},_0x2dad(_0x14a45d,_0x1b9b12);}var __decorate=this&&this[_0x2562f7(0x131)]||function(_0x1b71f3,_0x47afab,_0x4329c3,_0x1f49e8){const _0x44ee79=_0x2562f7;var _0x3c7666=arguments[_0x44ee79(0xe4)],_0x3b9061=_0x3c7666<0x3?_0x47afab:_0x1f49e8===null?_0x1f49e8=Object[_0x44ee79(0xc3)](_0x47afab,_0x4329c3):_0x1f49e8,_0x4153b1;if(typeof Reflect==='object'&&typeof Reflect[_0x44ee79(0xa8)]===_0x44ee79(0x111))_0x3b9061=Reflect[_0x44ee79(0xa8)](_0x1b71f3,_0x47afab,_0x4329c3,_0x1f49e8);else{for(var _0x22f59f=_0x1b71f3['length']-0x1;_0x22f59f>=0x0;_0x22f59f--)if(_0x4153b1=_0x1b71f3[_0x22f59f])_0x3b9061=(_0x3c7666<0x3?_0x4153b1(_0x3b9061):_0x3c7666>0x3?_0x4153b1(_0x47afab,_0x4329c3,_0x3b9061):_0x4153b1(_0x47afab,_0x4329c3))||_0x3b9061;}return _0x3c7666>0x3&&_0x3b9061&&Object['defineProperty'](_0x47afab,_0x4329c3,_0x3b9061),_0x3b9061;},__metadata=this&&this[_0x2562f7(0xe6)]||function(_0x5a01c3,_0x2f753c){const _0x3cee0e=_0x2562f7;if(typeof Reflect===_0x3cee0e(0x130)&&typeof Reflect[_0x3cee0e(0xb5)]===_0x3cee0e(0x111))return Reflect['metadata'](_0x5a01c3,_0x2f753c);},__param=this&&this[_0x2562f7(0xb6)]||function(_0x45c050,_0x4bd182){return function(_0x3085d3,_0x2d4430){_0x4bd182(_0x3085d3,_0x2d4430,_0x45c050);};};Object[_0x2562f7(0x121)](exports,_0x2562f7(0x120),{'value':!![]}),exports[_0x2562f7(0x11a)]=void 0x0;const common_1=require(_0x2562f7(0xf4)),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x2562f7(0xd1)),typeorm_2=require(_0x2562f7(0x11c)),gpts_model_entity_1=require(_0x2562f7(0xcc)),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require('../chatLog/chatLog.service'),utils_1=require(_0x2562f7(0x10b)),models_service_1=require(_0x2562f7(0xc7)),userApps_entity_1=require(_0x2562f7(0x11e)),model_constant_1=require(_0x2562f7(0xc9)),nestjs_cls_1=require(_0x2562f7(0x12d));let GptsService=class GptsService{constructor(_0x476428,_0xe6ca48,_0x4e51b9,_0x483d8b,_0xa4df22,_0x278cfe,_0x1d8ad8){const _0x52fb26=_0x2562f7;this[_0x52fb26(0x132)]=_0x476428,this['gptsGroupEntity']=_0xe6ca48,this[_0x52fb26(0xc8)]=_0x4e51b9,this[_0x52fb26(0x12c)]=_0x483d8b,this['clsService']=_0xa4df22,this[_0x52fb26(0xc2)]=_0x278cfe,this['chatLogService']=_0x1d8ad8;}async[_0x2562f7(0x12f)](_0x390495){const _0x1b38c2=_0x2562f7;try{const _0x1e8189=_0x390495['groupName'],_0x5e2508=(0x0,utils_1[_0x1b38c2(0x118)])(this[_0x1b38c2(0xab)]),_0x8c0451=await this[_0x1b38c2(0xb2)]['findOne']({'where':{'groupName':_0x1e8189,'saasId':_0x5e2508}});if(_0x8c0451)throw new common_1[(_0x1b38c2(0x116))]('分类已存在！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x1b38c2(0xb2)][_0x1b38c2(0x12e)]({..._0x390495,'saasId':_0x5e2508}),!![];}catch(_0x307e52){throw new common_1[(_0x1b38c2(0x116))](_0x307e52[_0x1b38c2(0xea)],common_1[_0x1b38c2(0xa9)][_0x1b38c2(0x101)]);}}async[_0x2562f7(0x11f)](_0x1c6185){const _0x4412e8=_0x2562f7;try{const _0x2fdf42=await this['gptsGroupEntity'][_0x4412e8(0xf2)]({'where':{'id':_0x1c6185['id']}});if(!_0x2fdf42)throw new common_1[(_0x4412e8(0x116))](_0x4412e8(0x10f),common_1[_0x4412e8(0xa9)][_0x4412e8(0x101)]);return await this[_0x4412e8(0xb2)][_0x4412e8(0xbd)]({'id':_0x1c6185['id']},_0x1c6185),!![];}catch(_0x5373d3){throw new common_1[(_0x4412e8(0x116))](_0x5373d3[_0x4412e8(0xea)],common_1[_0x4412e8(0xa9)][_0x4412e8(0x101)]);}}async[_0x2562f7(0x9e)](_0x1c4df7){const _0x8a4fdb=_0x2562f7;try{const _0x58a0ab=_0x1c4df7['id'],_0x4d3913=await this[_0x8a4fdb(0xb2)][_0x8a4fdb(0xf2)]({'where':{'id':_0x58a0ab}});if(!_0x4d3913)throw new common_1[(_0x8a4fdb(0x116))](_0x8a4fdb(0xcf),common_1['HttpStatus']['BAD_REQUEST']);const _0x5897de=await this['gptsModelEntity'][_0x8a4fdb(0xe2)]({'where':{'groupId':_0x4d3913['id']}});if(_0x5897de>0x0)throw new common_1[(_0x8a4fdb(0x116))](_0x8a4fdb(0xad),common_1[_0x8a4fdb(0xa9)]['BAD_REQUEST']);else await this[_0x8a4fdb(0xb2)][_0x8a4fdb(0xb0)]({'id':_0x58a0ab});}catch(_0x30d6a3){throw new common_1[(_0x8a4fdb(0x116))](_0x30d6a3['message'],common_1[_0x8a4fdb(0xa9)]['BAD_REQUEST']);}}async[_0x2562f7(0xbc)](_0x3dd47f,_0x2edf9f){const _0x2ff98d=_0x2562f7;try{const _0x4416c0=(0x0,utils_1[_0x2ff98d(0x118)])(this[_0x2ff98d(0xab)]),{page:page=0x1,size:size=0x14,status:_0x3c1f39,saasId:_0xf8e0a8,groupName:_0x514076}=_0x3dd47f,_0x2e3587={};return _0x514076&&(_0x2e3587['groupName']=_0x514076),_0x3c1f39>=0x0&&(_0x2e3587[_0x2ff98d(0xff)]=_0x3c1f39),(0x0,utils_1[_0x2ff98d(0xfb)])(this[_0x2ff98d(0xab)])?(0x0,utils_1[_0x2ff98d(0xf5)])(_0xf8e0a8)&&(_0x2e3587[_0x2ff98d(0x103)]=_0xf8e0a8):_0x2e3587[_0x2ff98d(0x103)]=_0x4416c0,await this[_0x2ff98d(0xb2)][_0x2ff98d(0xe8)]({'where':_0x2e3587,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x2ff98d(0xa4),'id':_0x2ff98d(0xa4)}})[_0x2ff98d(0xc6)](([_0x3f9f6f,_0x273e2b])=>({'rows':_0x3f9f6f,'count':_0x273e2b}))[_0x2ff98d(0xfe)](_0x392263=>{throw new Error(_0x392263);});}catch(_0xadb2a8){console['log']('error:\x20',_0xadb2a8);throw new common_1[(_0x2ff98d(0x116))](_0xadb2a8,common_1[_0x2ff98d(0xa9)][_0x2ff98d(0x101)]);}}async[_0x2562f7(0xdc)](_0x1e6ccd,_0x522019){const _0x2c5640=_0x2562f7;try{const {groupId:_0x5bd5a9}=_0x1e6ccd;return await this[_0x2c5640(0xb2)][_0x2c5640(0xf2)]({'where':{'id':Number(_0x5bd5a9)}})['then'](_0x5721d5=>{return _0x5721d5;})[_0x2c5640(0xfe)](_0x44e52f=>{throw new Error(_0x44e52f);});}catch(_0x5f380f){console[_0x2c5640(0xe5)](_0x2c5640(0x10c),_0x5f380f);throw new common_1[(_0x2c5640(0x116))](_0x5f380f,common_1['HttpStatus'][_0x2c5640(0x101)]);}}async[_0x2562f7(0xa5)](_0x5dd67d,_0x3e6807){const _0x4277f3=_0x2562f7;try{const _0x380b60=_0x5dd67d[_0x4277f3(0xf7)]['id'],_0x63db25=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x1c58b7=Object['assign'](new gpts_model_entity_1['GptsModelEntity'](),_0x3e6807);_0x1c58b7[_0x4277f3(0xff)]=Number(_0x3e6807[_0x4277f3(0xff)]);if(_0x1c58b7['id']){const _0x3fff1c=await this[_0x4277f3(0xc8)][_0x4277f3(0xf2)]({'where':{'id':_0x1c58b7['id']}});if(!_0x3fff1c)throw new common_1[(_0x4277f3(0x116))](_0x4277f3(0xf6),common_1['HttpStatus'][_0x4277f3(0x101)]);if(_0x3fff1c[_0x4277f3(0xc5)]!==_0x1c58b7[_0x4277f3(0xc5)])throw new common_1[(_0x4277f3(0x116))]('应用类型不可更改！',common_1[_0x4277f3(0xa9)][_0x4277f3(0x101)]);return await this[_0x4277f3(0xc8)][_0x4277f3(0xbd)]({'id':_0x1c58b7['id']},{..._0x1c58b7,'useCount':_0x1c58b7[_0x4277f3(0x10e)]??_0x3fff1c[_0x4277f3(0x10e)],'collectCount':_0x1c58b7[_0x4277f3(0xfc)]??_0x3fff1c[_0x4277f3(0xfc)]})[_0x4277f3(0xc6)](_0x2a80e8=>_0x2a80e8[_0x4277f3(0x119)]>0x0)['catch'](_0x2ab99d=>{throw new Error(_0x2ab99d);});}else{const _0x4b789c=await this[_0x4277f3(0xb2)][_0x4277f3(0xf2)]({'where':{'id':_0x1c58b7[_0x4277f3(0xac)]}});if(!_0x4b789c)throw new common_1['HttpException']('应用分类不存在！',common_1['HttpStatus'][_0x4277f3(0x101)]);return await this[_0x4277f3(0xc8)]['save']({..._0x1c58b7,'saasId':_0x63db25,'userId':_0x5dd67d[_0x4277f3(0xeb)][_0x4277f3(0xb1)]?_0x380b60:null})[_0x4277f3(0xc6)](_0x44d36d=>!!_0x44d36d)[_0x4277f3(0xfe)](_0x3d97a2=>{throw new Error(_0x3d97a2);});}}catch(_0x172687){throw new common_1[(_0x4277f3(0x116))](_0x172687,common_1[_0x4277f3(0xa9)][_0x4277f3(0x101)]);}}async[_0x2562f7(0x110)](){const _0xc754ea=_0x2562f7;return await this[_0xc754ea(0xc8)][_0xc754ea(0xdb)]()[_0xc754ea(0xc6)](_0x3f98d2=>_0x3f98d2[_0xc754ea(0x102)](_0x123006=>_0x123006[_0xc754ea(0xdf)]));}async[_0x2562f7(0x117)](_0x333e3e){const _0x255f9f=_0x2562f7;try{const _0x4888ce=(0x0,utils_1['getReqSaasId'])(this[_0x255f9f(0xab)]),_0x41dfa7=await this[_0x255f9f(0x110)](),_0x15c41e=_0x333e3e[_0x255f9f(0x9d)](_0x2a2b85=>!_0x41dfa7[_0x255f9f(0xe3)](_0x2a2b85[_0x255f9f(0xdf)]))[_0x255f9f(0x102)](_0x2d7777=>({'groupId':_0x2d7777['groupId'],'relModel':_0x2d7777[_0x255f9f(0x9f)],'logo':_0x2d7777[_0x255f9f(0xba)],'desc':_0x2d7777[_0x255f9f(0xec)],'modelName':_0x2d7777[_0x255f9f(0xdf)],'modelId':_0x2d7777[_0x255f9f(0x114)],'saasId':_0x4888ce}));return await this[_0x255f9f(0xc8)]['save'](_0x15c41e)[_0x255f9f(0xfe)](_0x47429c=>{throw new Error(_0x47429c);});}catch(_0x359636){console[_0x255f9f(0xe5)](_0x255f9f(0x10c),_0x359636);throw new common_1[(_0x255f9f(0x116))](_0x359636,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x2562f7(0xd6)](_0x5d7a85,_0x1fe96b){const _0x15c95e=_0x2562f7;try{const _0x548c50=(0x0,utils_1['getUserId'])(this[_0x15c95e(0xab)]),_0xfd7bbf=(0x0,utils_1[_0x15c95e(0x118)])(this[_0x15c95e(0xab)]),_0x56fa47=new Set(),_0x29f2af=new Map(),{modelId:_0x39e86a,modelName:_0x2c1791,groupId:_0x501160,back:_0x5a8e82,status:_0x31f1e1,page:page=0x1,size:size=0x14,saasId:_0x21fe91}=_0x5d7a85,_0x26a368={'delFlag':![]};_0x548c50?_0x26a368[_0x15c95e(0xef)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2['Equal'])(_0x548c50),(0x0,typeorm_2['IsNull'])()):_0x26a368['userId']=(0x0,typeorm_2['IsNull'])();(0x0,utils_1[_0x15c95e(0xfb)])(this['clsService'])?(0x0,utils_1['isDefined'])(_0x21fe91)&&(_0x26a368[_0x15c95e(0x103)]=_0x21fe91):_0x26a368['saasId']=_0xfd7bbf;!_0x5a8e82?_0x26a368[_0x15c95e(0xff)]=0x1:(_0x31f1e1!==undefined&&_0x31f1e1!==null&&(_0x26a368[_0x15c95e(0xff)]=_0x31f1e1),delete _0x26a368[_0x15c95e(0xef)]);_0x39e86a&&(_0x26a368[_0x15c95e(0x114)]=_0x39e86a),_0x501160&&(_0x26a368[_0x15c95e(0xac)]=_0x501160),_0x2c1791&&(_0x26a368['modelName']=(0x0,typeorm_2[_0x15c95e(0x126)])('%'+_0x2c1791+'%'));const [_0x3f02e3,_0x37aad9]=await this[_0x15c95e(0xc8)][_0x15c95e(0xe8)]({'skip':(page-0x1)*size,'take':size,'where':_0x26a368,'order':{'sortId':_0x15c95e(0xa4)}});if(_0x3f02e3[_0x15c95e(0xe4)]){const _0x419dc9=[],_0x349e46=[];_0x3f02e3['forEach'](_0x97e7f3=>{const _0x25b277=_0x15c95e;_0x419dc9['push'](_0x97e7f3['id']),_0x349e46[_0x25b277(0x122)](_0x97e7f3[_0x25b277(0xac)]);});if(_0x548c50){const _0x29a8ac=await this[_0x15c95e(0x132)][_0x15c95e(0xdb)]({'where':{'userId':_0x548c50,'appId':(0x0,typeorm_2['In'])(_0x419dc9)}});_0x29a8ac[_0x15c95e(0x104)](_0x4405be=>_0x56fa47[_0x15c95e(0xd0)](_0x4405be['appId']));}const _0x54757a=await this[_0x15c95e(0xb2)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x349e46)}});_0x54757a['forEach'](_0x293077=>_0x29f2af[_0x15c95e(0xfd)](_0x293077['id'],_0x293077));}return{'count':_0x37aad9,'rows':_0x3f02e3['map'](_0x4ee008=>({..._0x4ee008,'collected':_0x56fa47['has'](_0x4ee008['id']),'groupName':_0x29f2af['get'](_0x4ee008[_0x15c95e(0xac)])?.['groupName']}))};}catch(_0x3a3687){console[_0x15c95e(0xe5)](_0x15c95e(0x10c),_0x3a3687);throw new common_1[(_0x15c95e(0x116))](_0x3a3687,common_1[_0x15c95e(0xa9)][_0x15c95e(0x101)]);}}async['listByFrontType'](_0x4996f7,_0x2f3656){const _0x202138=_0x2562f7,_0x1f21bc=(0x0,utils_1[_0x202138(0xf9)])(this['clsService']),_0x2f1bb5=(0x0,utils_1[_0x202138(0x118)])(this['clsService']),_0x4e9f9f={'take':0x1e};if(_0x2f3656==_0x202138(0x11b))_0x4e9f9f[_0x202138(0x129)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x4e9f9f[_0x202138(0x9a)]={'createdAt':'DESC'};else{if(_0x2f3656===_0x202138(0xc1))_0x4e9f9f[_0x202138(0x129)]={'status':0x1,'delFlag':![]},_0x4e9f9f[_0x202138(0x9a)]={'useCount':'DESC'};else{if(_0x2f3656===_0x202138(0xcd))_0x4e9f9f[_0x202138(0x129)]={'status':0x1,'delFlag':![]},_0x4e9f9f[_0x202138(0x9a)]={'collectCount':_0x202138(0xa4)};else{if(_0x2f3656===_0x202138(0xae)){if(!_0x1f21bc)throw new common_1[(_0x202138(0x116))](_0x202138(0x107),common_1[_0x202138(0xa9)]['UNAUTHORIZED']);_0x4e9f9f['where']={'status':0x1,'delFlag':![],'userId':_0x1f21bc},_0x4e9f9f[_0x202138(0x9a)]={'createdAt':_0x202138(0xa4)};}else _0x4e9f9f[_0x202138(0x129)]={'status':0x1,'delFlag':![]},_0x4e9f9f[_0x202138(0x9a)]={'createdAt':_0x202138(0xa4)};}}}_0x4e9f9f[_0x202138(0x129)][_0x202138(0x103)]=_0x2f1bb5;const _0x133abe=await this[_0x202138(0xc8)]['find'](_0x4e9f9f),_0x3fd5ca=new Set(),_0xfe9256=new Map(),_0x33619b=new Map(),_0x33c790=[],_0x458345=[];_0x133abe[_0x202138(0x104)](_0x3a88d7=>{const _0x1ce309=_0x202138;_0x33c790['push'](_0x3a88d7['id']),_0x458345[_0x1ce309(0x122)](_0x3a88d7[_0x1ce309(0xac)]);});if(_0x33c790['length']){if(_0x1f21bc){const _0x1f57d4=await this[_0x202138(0x132)][_0x202138(0xdb)]({'where':{'userId':_0x1f21bc,'appId':(0x0,typeorm_2['In'])(_0x33c790)}});_0x1f57d4['forEach'](_0x30b953=>_0x3fd5ca[_0x202138(0xd0)](_0x30b953[_0x202138(0xaa)]));const _0x4a829d=await this[_0x202138(0xd3)][_0x202138(0x112)](_0x1f21bc,_0x33c790);_0x4a829d[_0x202138(0x104)](_0x2e86e8=>_0xfe9256['set'](_0x2e86e8['appId'],_0x2e86e8['createdAt']));}const _0x2abe68=await this[_0x202138(0xb2)][_0x202138(0xdb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x458345)}});_0x2abe68[_0x202138(0x104)](_0x247851=>_0x33619b[_0x202138(0xfd)](_0x247851['id'],_0x247851));}return _0x133abe[_0x202138(0x102)](_0x31ad8d=>({..._0x31ad8d,'collected':_0x3fd5ca['has'](_0x31ad8d['id']),'lastTime':_0xfe9256[_0x202138(0xa1)](_0x31ad8d['id'])||null,'groupName':_0x33619b[_0x202138(0xa1)](_0x31ad8d[_0x202138(0xac)])?.['groupName']}));}async[_0x2562f7(0xcb)](_0x5e6da2){const _0x52a203=_0x2562f7;try{const {id:_0x1ee089}=_0x5e6da2,_0x234f0e=await this[_0x52a203(0xc8)]['findOne']({'where':{'id':_0x1ee089}});if(!_0x234f0e)throw new common_1['HttpException']('gpts不存在,无法删除！',common_1[_0x52a203(0xa9)][_0x52a203(0x101)]);return await this[_0x52a203(0xc8)]['delete'](_0x1ee089)[_0x52a203(0xc6)](_0x17be58=>_0x17be58[_0x52a203(0x119)]>0x0)[_0x52a203(0xfe)](_0x29fcd3=>{throw new Error(_0x29fcd3);});}catch(_0x331100){console[_0x52a203(0xe5)](_0x52a203(0x10c),_0x331100);throw new common_1['HttpException'](_0x331100,common_1[_0x52a203(0xa9)][_0x52a203(0x101)]);}}async['handleCreateChat'](_0x402f14,_0x2a4d12){const _0x3b4633=_0x2562f7,_0x47fa2c=_0x402f14[_0x3b4633(0xaa)],_0x30cba3=_0x2a4d12[_0x3b4633(0xf7)]['id'],_0xc02e49=(0x0,utils_1[_0x3b4633(0x118)])(this[_0x3b4633(0xab)]);let _0x5e0103=null,_0x265d51={'title':_0x3b4633(0x11d),'userId':_0x30cba3,'saasId':_0xc02e49};try{_0x5e0103=await this['gptsModelEntity'][_0x3b4633(0xf2)]({'where':{'id':_0x47fa2c}});if(!_0x5e0103)throw new Error(_0x3b4633(0xe0));if(_0x5e0103[_0x3b4633(0xff)]!==0x1)throw new Error(_0x3b4633(0x10d));const _0x286246=await this['gptsChatEntity']['count']({'where':{'modelId':_0x47fa2c,'userId':_0x30cba3,'isDelete':![]}});if(_0x286246>0x0)throw new Error(_0x3b4633(0x12a));_0x265d51[_0x3b4633(0x114)]=_0x5e0103['id'],_0x265d51[_0x3b4633(0x9b)]=_0x5e0103['modelId'],_0x265d51[_0x3b4633(0xac)]=_0x5e0103['groupId'],_0x265d51[_0x3b4633(0xec)]=_0x5e0103[_0x3b4633(0xec)]||'',_0x265d51[_0x3b4633(0xba)]=_0x5e0103[_0x3b4633(0xba)]||'',_0x265d51[_0x3b4633(0x12b)]=_0x5e0103[_0x3b4633(0xdf)],_0x265d51[_0x3b4633(0x127)]=_0x5e0103['demoData']||'';let _0x3a7e7f=await this['modelsService'][_0x3b4633(0xf1)](model_constant_1[_0x3b4633(0xf0)]['APP']);_0x3a7e7f[_0x3b4633(0xee)][_0x3b4633(0xd2)]=_0x5e0103[_0x3b4633(0xd2)],_0x3a7e7f[_0x3b4633(0xee)][_0x3b4633(0xdf)]=_0x5e0103['modelName'],_0x3a7e7f[_0x3b4633(0xee)]['canUpload']=_0x5e0103[_0x3b4633(0x124)];_0x5e0103[_0x3b4633(0xc5)]?_0x3a7e7f['modelInfo'][_0x3b4633(0x9b)]=_0x5e0103[_0x3b4633(0x114)]:_0x3a7e7f[_0x3b4633(0xee)][_0x3b4633(0x9b)]=_0x5e0103['relModel'];_0x265d51[_0x3b4633(0x123)]=JSON['stringify'](_0x3a7e7f);const _0x4577f0=await this[_0x3b4633(0x12c)][_0x3b4633(0x12e)](_0x265d51);return _0x5e0103&&(_0x5e0103[_0x3b4633(0x10e)]=_0x5e0103['useCount']+Math[_0x3b4633(0x108)](Math[_0x3b4633(0xbb)]()*0xa),await this[_0x3b4633(0xc8)][_0x3b4633(0x12e)](_0x5e0103)),_0x4577f0;}catch(_0x2f45a7){throw new common_1[(_0x3b4633(0x116))](_0x2f45a7['message'],common_1[_0x3b4633(0xa9)]['BAD_REQUEST']);}}async[_0x2562f7(0xa6)](_0x4cd709){const _0x4356ff=_0x2562f7;try{const _0x596a08=_0x4cd709[_0x4356ff(0xf7)]['id'],_0x12d33b={'userId':_0x596a08,'isDelete':![]},_0x1ad209=await this['gptsChatEntity'][_0x4356ff(0xdb)]({'where':_0x12d33b,'order':{'isSticky':_0x4356ff(0xa4),'id':_0x4356ff(0xa4)}}),_0x278dd0=new Set(),_0x39ed95=new Map(),_0x26f872=new Map(),_0x35f9f6=[],_0x2b0c73=[];_0x1ad209[_0x4356ff(0x104)](_0x3617a1=>{const _0x5d30e2=_0x4356ff;_0x35f9f6['push'](_0x3617a1[_0x5d30e2(0x114)]),_0x2b0c73['push'](_0x3617a1['groupId']);});if(_0x35f9f6['length']){const _0x1a7a15=await this[_0x4356ff(0x132)][_0x4356ff(0xdb)]({'where':{'userId':_0x596a08,'appId':(0x0,typeorm_2['In'])(_0x35f9f6)}});_0x1a7a15[_0x4356ff(0x104)](_0x5d6a8c=>_0x278dd0[_0x4356ff(0xd0)](_0x5d6a8c['appId']));const _0x332fd9=await this[_0x4356ff(0xc8)][_0x4356ff(0xdb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x35f9f6),'status':0x1,'delFlag':![]}});_0x332fd9['forEach'](_0x204ed1=>_0x39ed95['set'](_0x204ed1['id'],_0x204ed1));const _0x3dd3a9=await this['gptsGroupEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2b0c73)}});_0x3dd3a9[_0x4356ff(0x104)](_0x285e68=>_0x26f872[_0x4356ff(0xfd)](_0x285e68['id'],_0x285e68));}return _0x1ad209['map'](_0x3d3d18=>{const _0x247afa=_0x4356ff,_0x4f0366=_0x39ed95[_0x247afa(0xa1)](_0x3d3d18[_0x247afa(0x114)]);if(_0x4f0366?.[_0x247afa(0xc5)]){const _0x2121b3=JSON[_0x247afa(0x9c)](_0x3d3d18[_0x247afa(0x123)]);_0x2121b3[_0x247afa(0xee)][_0x247afa(0x9b)]=_0x4f0366[_0x247afa(0x114)],_0x3d3d18['config']=JSON[_0x247afa(0xa2)](_0x2121b3);}return{..._0x3d3d18,'modelName':_0x3d3d18[_0x247afa(0x12b)],'gptsApp':_0x4f0366?.[_0x247afa(0xc5)],'collected':_0x278dd0[_0x247afa(0xc4)](_0x3d3d18[_0x247afa(0x114)]),'groupName':_0x26f872[_0x247afa(0xa1)](_0x3d3d18[_0x247afa(0xac)])?.['groupName']};});}catch(_0x2f69f4){console[_0x4356ff(0xe5)]('error:\x20',_0x2f69f4);throw new common_1[(_0x4356ff(0x116))](_0x2f69f4,common_1['HttpStatus'][_0x4356ff(0x101)]);}}async['updateGptsChat'](_0x15de08,_0x165d45){const _0x145499=_0x2562f7,{title:_0x1d9bb0,isSticky:_0x141f1b,groupId:_0x59c63b,config:_0x13b594}=_0x15de08,{id:_0x595f97}=_0x165d45[_0x145499(0xf7)],_0x48d538=await this[_0x145499(0x12c)][_0x145499(0xf2)]({'where':{'id':_0x59c63b,'userId':_0x595f97}});if(!_0x48d538)throw new common_1[(_0x145499(0x116))]('GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1['HttpStatus'][_0x145499(0x101)]);const _0x5e334f={};_0x5e334f[_0x145499(0x12b)]=_0x1d9bb0||_0x48d538[_0x145499(0x12b)],_0x5e334f[_0x145499(0x123)]=_0x13b594||_0x48d538[_0x145499(0x123)],_0x5e334f[_0x145499(0xbe)]=_0x141f1b??_0x48d538[_0x145499(0xbe)];const _0xffb3c8=await this['gptsChatEntity'][_0x145499(0xbd)]({'id':_0x59c63b},_0x5e334f);if(_0xffb3c8[_0x145499(0x119)])return!![];else throw new common_1[(_0x145499(0x116))]('更新对话失败！',common_1[_0x145499(0xa9)][_0x145499(0x101)]);}async['delGptsChat'](_0x5e9206,_0x4e2bd1){const _0x20b912=_0x2562f7;try{const {groupId:_0x2df5ef}=_0x5e9206,{id:_0x3374d0}=_0x4e2bd1[_0x20b912(0xf7)],_0x3e9c6d=await this[_0x20b912(0x12c)][_0x20b912(0xf2)]({'where':{'id':_0x2df5ef,'userId':_0x3374d0}})[_0x20b912(0xfe)](_0x15c87a=>{const _0x5d2018=_0x20b912;common_1[_0x5d2018(0x100)][_0x5d2018(0xbf)](_0x15c87a);throw new Error(_0x15c87a);});if(!_0x3e9c6d)throw new Error(_0x20b912(0xda));await this['chatLogService'][_0x20b912(0xb8)]({'userId':_0x3374d0,'ids':[_0x2df5ef]})[_0x20b912(0xfe)](_0x4b865a=>{throw new Error(_0x4b865a);});const _0x13a469=await this['gptsChatEntity']['delete']({'id':_0x2df5ef})['catch'](_0x5188a8=>{throw new Error(_0x5188a8);});if(!_0x13a469)throw new Error(_0x20b912(0xb3));return!![];}catch(_0xc73d7e){throw new common_1[(_0x20b912(0x116))](_0xc73d7e,common_1[_0x20b912(0xa9)][_0x20b912(0x101)]);}}async['delAllGptsChat'](_0x469f6d){const _0x5eebd0=_0x2562f7;try{const {id:_0x892e6c}=_0x469f6d[_0x5eebd0(0xf7)],_0x1143f0=await this[_0x5eebd0(0x12c)]['find']({'where':{'userId':_0x892e6c}})['catch'](_0x1dfaab=>{const _0x64b82e=_0x5eebd0;common_1[_0x64b82e(0x100)][_0x64b82e(0xbf)](_0x1dfaab);throw new Error(_0x1dfaab);});if(!_0x1143f0||_0x1143f0[_0x5eebd0(0xe4)]===0x0)throw new Error(_0x5eebd0(0xf8));const _0x1c9345=_0x1143f0[_0x5eebd0(0x102)](_0x1db09a=>_0x1db09a['groupId']);await this[_0x5eebd0(0xd3)]['removeLogsBatch']({'ids':_0x1c9345,'userId':_0x892e6c})[_0x5eebd0(0xfe)](_0x3b28f6=>{throw new Error(_0x3b28f6);});const _0x30f9e7=await this[_0x5eebd0(0x12c)][_0x5eebd0(0xb0)]({'userId':_0x892e6c,'isSticky':![]})['catch'](_0x34999b=>{throw new Error(_0x34999b);});if(!_0x30f9e7)throw new Error(_0x5eebd0(0x106));return!![];}catch(_0x2a6e35){throw new common_1[(_0x5eebd0(0x116))](_0x2a6e35,common_1[_0x5eebd0(0xa9)][_0x5eebd0(0x101)]);}}async[_0x2562f7(0xce)](_0x2d5885){const _0x1cfa47=_0x2562f7;return await this[_0x1cfa47(0x12c)][_0x1cfa47(0xf2)]({'where':{'id':_0x2d5885}});}async[_0x2562f7(0xa0)](_0x5c9aa5){const _0xc62eb8=_0x2562f7,_0x86ec2a=await this[_0xc62eb8(0x12c)]['findOne']({'where':{'id':_0x5c9aa5}}),_0x3df8fe=await this[_0xc62eb8(0xc8)]['findOne']({'where':{'id':_0x86ec2a[_0xc62eb8(0x114)]}}),_0x3a7855=await this[_0xc62eb8(0xc2)]['getRandomKey'](model_constant_1['EModelType'][_0xc62eb8(0xb9)]);return _0x3a7855[_0xc62eb8(0xdf)]=_0x3df8fe[_0xc62eb8(0xdf)],_0x3a7855[_0xc62eb8(0x9b)]=_0x3df8fe['modelId']||_0x3df8fe[_0xc62eb8(0x9f)],_0x3a7855;}async[_0x2562f7(0xb7)](_0x2cc633,_0x1253f6){const _0xb4dc70=_0x2562f7;await this[_0xb4dc70(0xb2)][_0xb4dc70(0x113)]()[_0xb4dc70(0xbd)](gpts_group_entity_1[_0xb4dc70(0x10a)])[_0xb4dc70(0xfd)]({'useCount':()=>_0xb4dc70(0xc0),'useToken':()=>_0xb4dc70(0xe7)+_0x1253f6})[_0xb4dc70(0x129)](_0xb4dc70(0xde),{'id':_0x2cc633})[_0xb4dc70(0xed)]();}async[_0x2562f7(0xdd)](_0x35944d,_0x384819){const _0x11c4e9=_0x2562f7,_0x115a0f={'id':_0x35944d};return _0x384819!=null&&_0x384819!==undefined&&(_0x115a0f[_0x11c4e9(0xff)]=_0x384819),this[_0x11c4e9(0xc8)][_0x11c4e9(0xf2)]({'where':_0x115a0f});}};GptsService=__decorate([(0x0,common_1[_0x2562f7(0x125)])(),__param(0x0,(0x0,typeorm_1[_0x2562f7(0xca)])(userApps_entity_1[_0x2562f7(0xa3)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(gpts_group_entity_1[_0x2562f7(0x10a)])),__param(0x2,(0x0,typeorm_1[_0x2562f7(0xca)])(gpts_model_entity_1[_0x2562f7(0xfa)])),__param(0x3,(0x0,typeorm_1[_0x2562f7(0xca)])(gpts_chat_entity_1['GptsChatEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x2562f7(0xf3)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],nestjs_cls_1[_0x2562f7(0x115)],models_service_1[_0x2562f7(0xaf)],chatLog_service_1[_0x2562f7(0x109)]])],GptsService),exports[_0x2562f7(0x11a)]=GptsService;