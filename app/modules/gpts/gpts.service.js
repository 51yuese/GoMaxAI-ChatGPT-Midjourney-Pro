'use strict';const _0x4e82b0=_0xf8fd;(function(_0xa17d18,_0x173405){const _0x2e0325=_0xf8fd,_0x37baa8=_0xa17d18();while(!![]){try{const _0x5ea88d=parseInt(_0x2e0325(0x128))/0x1+parseInt(_0x2e0325(0x12c))/0x2*(-parseInt(_0x2e0325(0x15a))/0x3)+parseInt(_0x2e0325(0x13b))/0x4+-parseInt(_0x2e0325(0x18e))/0x5*(parseInt(_0x2e0325(0x179))/0x6)+-parseInt(_0x2e0325(0x13d))/0x7*(parseInt(_0x2e0325(0x16b))/0x8)+parseInt(_0x2e0325(0x183))/0x9+-parseInt(_0x2e0325(0x14f))/0xa;if(_0x5ea88d===_0x173405)break;else _0x37baa8['push'](_0x37baa8['shift']());}catch(_0x1d4548){_0x37baa8['push'](_0x37baa8['shift']());}}}(_0x59ea,0x9a06a));var __decorate=this&&this[_0x4e82b0(0x17f)]||function(_0x35db3e,_0x513165,_0x2239d8,_0x58b38b){const _0x45c2d2=_0x4e82b0;var _0x502bea=arguments[_0x45c2d2(0x151)],_0x34500c=_0x502bea<0x3?_0x513165:_0x58b38b===null?_0x58b38b=Object[_0x45c2d2(0x176)](_0x513165,_0x2239d8):_0x58b38b,_0x5e13dd;if(typeof Reflect===_0x45c2d2(0x12e)&&typeof Reflect['decorate']===_0x45c2d2(0x14e))_0x34500c=Reflect[_0x45c2d2(0x13f)](_0x35db3e,_0x513165,_0x2239d8,_0x58b38b);else{for(var _0x3aa4c1=_0x35db3e[_0x45c2d2(0x151)]-0x1;_0x3aa4c1>=0x0;_0x3aa4c1--)if(_0x5e13dd=_0x35db3e[_0x3aa4c1])_0x34500c=(_0x502bea<0x3?_0x5e13dd(_0x34500c):_0x502bea>0x3?_0x5e13dd(_0x513165,_0x2239d8,_0x34500c):_0x5e13dd(_0x513165,_0x2239d8))||_0x34500c;}return _0x502bea>0x3&&_0x34500c&&Object[_0x45c2d2(0x139)](_0x513165,_0x2239d8,_0x34500c),_0x34500c;},__metadata=this&&this[_0x4e82b0(0x17a)]||function(_0xe6c419,_0x9132e9){const _0x2089b3=_0x4e82b0;if(typeof Reflect===_0x2089b3(0x12e)&&typeof Reflect[_0x2089b3(0x171)]===_0x2089b3(0x14e))return Reflect['metadata'](_0xe6c419,_0x9132e9);},__param=this&&this['__param']||function(_0x11f522,_0x1c9b95){return function(_0x785da2,_0x2fcad4){_0x1c9b95(_0x785da2,_0x2fcad4,_0x11f522);};};Object['defineProperty'](exports,_0x4e82b0(0x1b3),{'value':!![]}),exports[_0x4e82b0(0x196)]=void 0x0;const common_1=require(_0x4e82b0(0x174)),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x4e82b0(0x18b)),typeorm_2=require(_0x4e82b0(0x1a0)),gpts_model_entity_1=require(_0x4e82b0(0x156)),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require(_0x4e82b0(0x13c)),utils_1=require('../../common/utils'),models_service_1=require('../models/models.service'),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x4e82b0(0x1b5)),nestjs_cls_1=require(_0x4e82b0(0x155));let GptsService=class GptsService{constructor(_0x156252,_0x3024e8,_0x1f6bef,_0x312ae3,_0x42011a,_0x1cd560,_0x136230){const _0x30a5fe=_0x4e82b0;this[_0x30a5fe(0x18a)]=_0x156252,this[_0x30a5fe(0x1a1)]=_0x3024e8,this[_0x30a5fe(0x134)]=_0x1f6bef,this[_0x30a5fe(0x1b1)]=_0x312ae3,this[_0x30a5fe(0x140)]=_0x42011a,this['modelsService']=_0x1cd560,this[_0x30a5fe(0x147)]=_0x136230;}async['handleAddGroup'](_0x419584){const _0x4b4384=_0x4e82b0;try{const _0xacb81b=_0x419584['groupName'],_0x40a6ac=(0x0,utils_1[_0x4b4384(0x189)])(this['clsService']),_0x3525bf=await this['gptsGroupEntity']['findOne']({'where':{'groupName':_0xacb81b,'saasId':_0x40a6ac}});if(_0x3525bf)throw new common_1[(_0x4b4384(0x136))](_0x4b4384(0x141),common_1['HttpStatus'][_0x4b4384(0x149)]);return await this['gptsGroupEntity'][_0x4b4384(0x152)]({..._0x419584,'saasId':_0x40a6ac}),!![];}catch(_0x28f56f){throw new common_1[(_0x4b4384(0x136))](_0x28f56f[_0x4b4384(0x15d)],common_1[_0x4b4384(0x1bb)]['BAD_REQUEST']);}}async[_0x4e82b0(0x187)](_0x436cc4){const _0x59fc8e=_0x4e82b0;try{const _0x2526f8=await this['gptsGroupEntity'][_0x59fc8e(0x166)]({'where':{'id':_0x436cc4['id']}});if(!_0x2526f8)throw new common_1[(_0x59fc8e(0x136))]('模型组不存在！',common_1[_0x59fc8e(0x1bb)]['BAD_REQUEST']);return await this[_0x59fc8e(0x1a1)]['update']({'id':_0x436cc4['id']},_0x436cc4),!![];}catch(_0x1da9b1){throw new common_1[(_0x59fc8e(0x136))](_0x1da9b1[_0x59fc8e(0x15d)],common_1[_0x59fc8e(0x1bb)]['BAD_REQUEST']);}}async['handleRemoveGroup'](_0x67e008){const _0x3d0e7c=_0x4e82b0;try{const _0x101e87=_0x67e008['id'],_0x1c8221=await this[_0x3d0e7c(0x1a1)][_0x3d0e7c(0x166)]({'where':{'id':_0x101e87}});if(!_0x1c8221)throw new common_1[(_0x3d0e7c(0x136))]('应用分类不存在,无法删除！',common_1[_0x3d0e7c(0x1bb)][_0x3d0e7c(0x149)]);const _0x7bf99d=await this['gptsModelEntity'][_0x3d0e7c(0x14c)]({'where':{'groupId':_0x1c8221['id']}});if(_0x7bf99d>0x0)throw new common_1[(_0x3d0e7c(0x136))](_0x3d0e7c(0x1a6),common_1[_0x3d0e7c(0x1bb)][_0x3d0e7c(0x149)]);else await this['gptsGroupEntity'][_0x3d0e7c(0x182)]({'id':_0x101e87});}catch(_0x37fd6d){throw new common_1[(_0x3d0e7c(0x136))](_0x37fd6d[_0x3d0e7c(0x15d)],common_1['HttpStatus'][_0x3d0e7c(0x149)]);}}async[_0x4e82b0(0x1b2)](_0x364333,_0x179ab8){const _0x350f9c=_0x4e82b0;try{const _0x24a7c5=(0x0,utils_1['getReqSaasId'])(this[_0x350f9c(0x140)]),{page:page=0x1,size:size=0x14,status:_0x219ce7,saasId:_0x7d4b77,groupName:_0x4a7260}=_0x364333,_0x254813={};return _0x4a7260&&(_0x254813['groupName']=_0x4a7260),_0x219ce7>=0x0&&(_0x254813[_0x350f9c(0x175)]=_0x219ce7),(0x0,utils_1['isPlatform'])(this[_0x350f9c(0x140)])?(0x0,utils_1[_0x350f9c(0x19f)])(_0x7d4b77)&&(_0x254813[_0x350f9c(0x19c)]=_0x7d4b77):_0x254813['saasId']=_0x24a7c5,await this[_0x350f9c(0x1a1)][_0x350f9c(0x14b)]({'where':_0x254813,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x350f9c(0x129),'id':_0x350f9c(0x129)}})['then'](([_0x461dd8,_0x5a7de4])=>({'rows':_0x461dd8,'count':_0x5a7de4}))[_0x350f9c(0x1b7)](_0x3be928=>{throw new Error(_0x3be928);});}catch(_0x402ea1){console[_0x350f9c(0x127)](_0x350f9c(0x163),_0x402ea1);throw new common_1['HttpException'](_0x402ea1,common_1[_0x350f9c(0x1bb)]['BAD_REQUEST']);}}async['handleGetGroup'](_0x3f6c95,_0x553cb4){const _0x5cc9cb=_0x4e82b0;try{const {groupId:_0x5eb06b}=_0x3f6c95;return await this['gptsGroupEntity'][_0x5cc9cb(0x166)]({'where':{'id':Number(_0x5eb06b)}})[_0x5cc9cb(0x180)](_0x5b275a=>{return _0x5b275a;})[_0x5cc9cb(0x1b7)](_0x4e008a=>{throw new Error(_0x4e008a);});}catch(_0x3ee6f6){console[_0x5cc9cb(0x127)](_0x5cc9cb(0x163),_0x3ee6f6);throw new common_1[(_0x5cc9cb(0x136))](_0x3ee6f6,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x4e82b0(0x154)](_0x50025b,_0x47be4f){const _0x362863=_0x4e82b0;try{const _0x5a2f4f=_0x50025b['user']['id'],_0x84102c=(0x0,utils_1[_0x362863(0x189)])(this[_0x362863(0x140)]),_0x599856=Object[_0x362863(0x1bc)](new gpts_model_entity_1[(_0x362863(0x16d))](),_0x47be4f);_0x599856[_0x362863(0x175)]=Number(_0x47be4f[_0x362863(0x175)]);if(_0x599856['id']){const _0x4da33e=await this[_0x362863(0x134)][_0x362863(0x166)]({'where':{'id':_0x599856['id']}});if(!_0x4da33e)throw new common_1[(_0x362863(0x136))](_0x362863(0x138),common_1[_0x362863(0x1bb)][_0x362863(0x149)]);if(_0x4da33e['gptsApp']!==_0x599856['gptsApp'])throw new common_1['HttpException'](_0x362863(0x1ac),common_1['HttpStatus']['BAD_REQUEST']);return await this['gptsModelEntity']['update']({'id':_0x599856['id']},{..._0x599856,'useCount':_0x599856['useCount']??_0x4da33e['useCount'],'collectCount':_0x599856[_0x362863(0x144)]??_0x4da33e[_0x362863(0x144)]})[_0x362863(0x180)](_0x35ab5c=>_0x35ab5c[_0x362863(0x1ae)]>0x0)['catch'](_0x217eb2=>{throw new Error(_0x217eb2);});}else{const _0x2e2214=await this[_0x362863(0x1a1)][_0x362863(0x166)]({'where':{'id':_0x599856[_0x362863(0x19d)]}});if(!_0x2e2214)throw new common_1['HttpException']('应用分类不存在！',common_1['HttpStatus'][_0x362863(0x149)]);const _0x5eff85=await this['gptsModelEntity'][_0x362863(0x152)]({..._0x599856,'saasId':_0x84102c,'userId':_0x50025b[_0x362863(0x153)][_0x362863(0x18f)]?_0x5a2f4f:null});return _0x5eff85['id'];}}catch(_0x282738){throw new common_1['HttpException'](_0x282738,common_1[_0x362863(0x1bb)][_0x362863(0x149)]);}}async[_0x4e82b0(0x1b9)](){const _0xd12022=_0x4e82b0;return await this[_0xd12022(0x134)][_0xd12022(0x1b8)]()[_0xd12022(0x180)](_0x425dd1=>_0x425dd1[_0xd12022(0x1a7)](_0x443ed9=>_0x443ed9[_0xd12022(0x168)]));}async[_0x4e82b0(0x169)](_0x144e01){const _0x7e6955=_0x4e82b0;try{const _0x2a6841=(0x0,utils_1['getReqSaasId'])(this[_0x7e6955(0x140)]),_0x1d51d3=await this['getExistGpts'](),_0x126251=_0x144e01[_0x7e6955(0x16f)](_0x3f737d=>!_0x1d51d3['includes'](_0x3f737d['modelName']))[_0x7e6955(0x1a7)](_0x39efc3=>({'groupId':_0x39efc3[_0x7e6955(0x19d)],'relModel':_0x39efc3[_0x7e6955(0x19a)],'logo':_0x39efc3[_0x7e6955(0x14a)],'desc':_0x39efc3[_0x7e6955(0x160)],'modelName':_0x39efc3['modelName'],'modelId':_0x39efc3['modelId'],'saasId':_0x2a6841}));return await this[_0x7e6955(0x134)][_0x7e6955(0x152)](_0x126251)[_0x7e6955(0x1b7)](_0x20f11a=>{throw new Error(_0x20f11a);});}catch(_0x2b1924){console[_0x7e6955(0x127)](_0x7e6955(0x163),_0x2b1924);throw new common_1[(_0x7e6955(0x136))](_0x2b1924,common_1[_0x7e6955(0x1bb)][_0x7e6955(0x149)]);}}async[_0x4e82b0(0x137)](_0x50d93a,_0x2dc397){const _0x45080c=_0x4e82b0;try{const _0x5294bf=(0x0,utils_1[_0x45080c(0x17d)])(this[_0x45080c(0x140)]),_0x498562=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x2e65d2=new Set(),_0x42fed6=new Map(),{modelId:_0xb09677,modelName:_0x40dffc,groupId:_0x3dbfb8,back:_0x286227,status:_0x445fe3,page:page=0x1,size:size=0x14,saasId:_0x23152c}=_0x50d93a,_0x17ce16={'delFlag':![]};_0x5294bf?_0x17ce16[_0x45080c(0x13e)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x45080c(0x17b)])(_0x5294bf),(0x0,typeorm_2[_0x45080c(0x135)])()):_0x17ce16['userId']=(0x0,typeorm_2[_0x45080c(0x135)])();(0x0,utils_1[_0x45080c(0x142)])(this[_0x45080c(0x140)])?(0x0,utils_1[_0x45080c(0x19f)])(_0x23152c)&&(_0x17ce16[_0x45080c(0x19c)]=_0x23152c):_0x17ce16[_0x45080c(0x19c)]=_0x498562;!_0x286227?_0x17ce16[_0x45080c(0x175)]=0x1:(_0x445fe3!==undefined&&_0x445fe3!==null&&(_0x17ce16[_0x45080c(0x175)]=_0x445fe3),delete _0x17ce16[_0x45080c(0x13e)]);_0xb09677&&(_0x17ce16[_0x45080c(0x12d)]=_0xb09677),_0x3dbfb8&&(_0x17ce16[_0x45080c(0x19d)]=_0x3dbfb8),_0x40dffc&&(_0x17ce16[_0x45080c(0x168)]=(0x0,typeorm_2['Like'])('%'+_0x40dffc+'%'));const [_0x304c3c,_0xd25fea]=await this[_0x45080c(0x134)][_0x45080c(0x14b)]({'skip':(page-0x1)*size,'take':size,'where':_0x17ce16,'order':{'sortId':_0x45080c(0x129)}});if(_0x304c3c[_0x45080c(0x151)]){const _0x45bdb1=[],_0x3607da=[];_0x304c3c[_0x45080c(0x13a)](_0x421ace=>{const _0x4dc6af=_0x45080c;_0x45bdb1['push'](_0x421ace['id']),_0x3607da[_0x4dc6af(0x1a8)](_0x421ace['groupId']);});if(_0x5294bf){const _0x5a2118=await this[_0x45080c(0x18a)][_0x45080c(0x1b8)]({'where':{'userId':_0x5294bf,'appId':(0x0,typeorm_2['In'])(_0x45bdb1)}});_0x5a2118[_0x45080c(0x13a)](_0x28a0b9=>_0x2e65d2[_0x45080c(0x1ad)](_0x28a0b9[_0x45080c(0x181)]));}const _0x2cd954=await this['gptsGroupEntity'][_0x45080c(0x1b8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3607da)}});_0x2cd954[_0x45080c(0x13a)](_0x222e40=>_0x42fed6['set'](_0x222e40['id'],_0x222e40));}return{'count':_0xd25fea,'rows':_0x304c3c[_0x45080c(0x1a7)](_0x3d57e4=>({..._0x3d57e4,'collected':_0x2e65d2[_0x45080c(0x15c)](_0x3d57e4['id']),'groupName':_0x42fed6[_0x45080c(0x16c)](_0x3d57e4[_0x45080c(0x19d)])?.[_0x45080c(0x1aa)]}))};}catch(_0x101677){console['log'](_0x45080c(0x163),_0x101677);throw new common_1['HttpException'](_0x101677,common_1[_0x45080c(0x1bb)][_0x45080c(0x149)]);}}async[_0x4e82b0(0x1af)](_0x186627,_0x1240bd){const _0x37141b=_0x4e82b0,_0x16eb51=(0x0,utils_1['getUserId'])(this[_0x37141b(0x140)]),_0x324304=(0x0,utils_1[_0x37141b(0x189)])(this[_0x37141b(0x140)]),_0x3a5ae2={'take':0x1e};if(_0x1240bd==_0x37141b(0x191))_0x3a5ae2[_0x37141b(0x16e)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x3a5ae2['order']={'createdAt':_0x37141b(0x129)};else{if(_0x1240bd===_0x37141b(0x1ab))_0x3a5ae2[_0x37141b(0x16e)]={'status':0x1,'delFlag':![]},_0x3a5ae2[_0x37141b(0x194)]={'useCount':_0x37141b(0x129)};else{if(_0x1240bd==='favorite')_0x3a5ae2[_0x37141b(0x16e)]={'status':0x1,'delFlag':![]},_0x3a5ae2[_0x37141b(0x194)]={'collectCount':_0x37141b(0x129)};else{if(_0x1240bd===_0x37141b(0x132)){if(!_0x16eb51)throw new common_1[(_0x37141b(0x136))](_0x37141b(0x18d),common_1[_0x37141b(0x1bb)]['UNAUTHORIZED']);_0x3a5ae2[_0x37141b(0x16e)]={'status':0x1,'delFlag':![],'userId':_0x16eb51},_0x3a5ae2[_0x37141b(0x194)]={'createdAt':_0x37141b(0x129)};}else _0x3a5ae2[_0x37141b(0x16e)]={'status':0x1,'delFlag':![]},_0x3a5ae2[_0x37141b(0x194)]={'createdAt':_0x37141b(0x129)};}}}_0x3a5ae2[_0x37141b(0x16e)][_0x37141b(0x19c)]=_0x324304;const _0x286414=await this[_0x37141b(0x134)][_0x37141b(0x1b8)](_0x3a5ae2),_0x5268ba=new Set(),_0x49fecf=new Map(),_0x1b6663=new Map(),_0x544efc=[],_0x20928b=[];_0x286414['forEach'](_0x1910df=>{const _0x2c354e=_0x37141b;_0x544efc[_0x2c354e(0x1a8)](_0x1910df['id']),_0x20928b[_0x2c354e(0x1a8)](_0x1910df['groupId']);});if(_0x544efc['length']){if(_0x16eb51){const _0x10ad9a=await this[_0x37141b(0x18a)][_0x37141b(0x1b8)]({'where':{'userId':_0x16eb51,'appId':(0x0,typeorm_2['In'])(_0x544efc)}});_0x10ad9a[_0x37141b(0x13a)](_0x5871cd=>_0x5268ba[_0x37141b(0x1ad)](_0x5871cd[_0x37141b(0x181)]));const _0x854e3=await this[_0x37141b(0x147)][_0x37141b(0x192)](_0x16eb51,_0x544efc);_0x854e3[_0x37141b(0x13a)](_0x36087e=>_0x49fecf['set'](_0x36087e[_0x37141b(0x181)],_0x36087e[_0x37141b(0x15f)]));}const _0x2716a2=await this[_0x37141b(0x1a1)][_0x37141b(0x1b8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x20928b)}});_0x2716a2[_0x37141b(0x13a)](_0x192d67=>_0x1b6663[_0x37141b(0x18c)](_0x192d67['id'],_0x192d67));}return _0x286414[_0x37141b(0x1a7)](_0x1f138f=>({..._0x1f138f,'collected':_0x5268ba['has'](_0x1f138f['id']),'lastTime':_0x49fecf[_0x37141b(0x16c)](_0x1f138f['id'])||null,'groupName':_0x1b6663[_0x37141b(0x16c)](_0x1f138f['groupId'])?.[_0x37141b(0x1aa)]}));}async[_0x4e82b0(0x162)](_0x9bcb42){const _0x157dfe=_0x4e82b0;try{const {id:_0x4e1a3d}=_0x9bcb42,_0x23d2f4=await this[_0x157dfe(0x134)][_0x157dfe(0x166)]({'where':{'id':_0x4e1a3d}});if(!_0x23d2f4)throw new common_1[(_0x157dfe(0x136))]('gpts不存在,无法删除！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x157dfe(0x134)][_0x157dfe(0x182)](_0x4e1a3d)[_0x157dfe(0x180)](_0x39213d=>_0x39213d[_0x157dfe(0x1ae)]>0x0)[_0x157dfe(0x1b7)](_0x2bfd2b=>{throw new Error(_0x2bfd2b);});}catch(_0x1fb311){console[_0x157dfe(0x127)](_0x157dfe(0x163),_0x1fb311);throw new common_1[(_0x157dfe(0x136))](_0x1fb311,common_1[_0x157dfe(0x1bb)][_0x157dfe(0x149)]);}}async['handleCreateChat'](_0x561f94,_0x1733d6){const _0x39b053=_0x4e82b0,_0xffe74d=_0x561f94[_0x39b053(0x181)],_0x46d814=_0x1733d6[_0x39b053(0x17c)]['id'],_0x283d2d=(0x0,utils_1['getReqSaasId'])(this[_0x39b053(0x140)]);let _0x2399a5=null,_0x50a4fc={'title':'新对话','userId':_0x46d814,'saasId':_0x283d2d};try{_0x2399a5=await this[_0x39b053(0x134)][_0x39b053(0x166)]({'where':{'id':_0xffe74d}});if(!_0x2399a5)throw new Error(_0x39b053(0x1a2));if(_0x2399a5['status']!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');const _0x49cd30=await this[_0x39b053(0x1b1)][_0x39b053(0x14c)]({'where':{'modelId':_0xffe74d,'userId':_0x46d814,'isDelete':![]}});if(_0x49cd30>0x0)throw new Error('当前应用已经开启了一个对话无需新建了！');_0x50a4fc[_0x39b053(0x12d)]=_0x2399a5['id'],_0x50a4fc['model']=_0x2399a5['modelId'],_0x50a4fc[_0x39b053(0x19d)]=_0x2399a5['groupId'],_0x50a4fc[_0x39b053(0x160)]=_0x2399a5[_0x39b053(0x160)]||'',_0x50a4fc[_0x39b053(0x14a)]=_0x2399a5[_0x39b053(0x14a)]||'',_0x50a4fc['title']=_0x2399a5[_0x39b053(0x168)],_0x50a4fc[_0x39b053(0x159)]=_0x2399a5['demoData']||'';let _0x28c89b=await this['modelsService'][_0x39b053(0x1a3)](model_constant_1[_0x39b053(0x197)][_0x39b053(0x130)]);_0x28c89b[_0x39b053(0x150)][_0x39b053(0x19b)]=_0x2399a5[_0x39b053(0x19b)],_0x28c89b['modelInfo'][_0x39b053(0x168)]=_0x2399a5['modelName'],_0x28c89b[_0x39b053(0x150)]['canUpload']=_0x2399a5[_0x39b053(0x199)];_0x2399a5[_0x39b053(0x198)]?_0x28c89b[_0x39b053(0x150)][_0x39b053(0x170)]=_0x2399a5[_0x39b053(0x12d)]:_0x28c89b['modelInfo'][_0x39b053(0x170)]=_0x2399a5[_0x39b053(0x19a)];_0x50a4fc[_0x39b053(0x15e)]=JSON[_0x39b053(0x1ba)](_0x28c89b);const _0x2f51fe=await this['gptsChatEntity'][_0x39b053(0x152)](_0x50a4fc);return _0x2399a5&&(_0x2399a5[_0x39b053(0x145)]=_0x2399a5['useCount']+Math[_0x39b053(0x190)](Math[_0x39b053(0x19e)]()*0xa),await this[_0x39b053(0x134)][_0x39b053(0x152)](_0x2399a5)),_0x2f51fe;}catch(_0x2b660d){throw new common_1[(_0x39b053(0x136))](_0x2b660d['message'],common_1[_0x39b053(0x1bb)][_0x39b053(0x149)]);}}async['handleGetChat'](_0x3aa786){const _0x3a77e6=_0x4e82b0;try{const _0x2438b9=_0x3aa786[_0x3a77e6(0x17c)]['id'],_0x3dd8a0={'userId':_0x2438b9,'isDelete':![]},_0x5c8472=await this[_0x3a77e6(0x1b1)]['find']({'where':_0x3dd8a0,'order':{'isSticky':_0x3a77e6(0x129),'id':'DESC'}}),_0x3d1257=new Set(),_0x21deb7=new Map(),_0x4ef781=new Map(),_0x93f3f0=[],_0x9664f1=[];_0x5c8472['forEach'](_0x1d3651=>{const _0x12ff43=_0x3a77e6;_0x93f3f0[_0x12ff43(0x1a8)](_0x1d3651[_0x12ff43(0x12d)]),_0x9664f1['push'](_0x1d3651[_0x12ff43(0x19d)]);});if(_0x93f3f0[_0x3a77e6(0x151)]){const _0x232408=await this[_0x3a77e6(0x18a)][_0x3a77e6(0x1b8)]({'where':{'userId':_0x2438b9,'appId':(0x0,typeorm_2['In'])(_0x93f3f0)}});_0x232408[_0x3a77e6(0x13a)](_0x4fba63=>_0x3d1257[_0x3a77e6(0x1ad)](_0x4fba63[_0x3a77e6(0x181)]));const _0x1a7d77=await this[_0x3a77e6(0x134)][_0x3a77e6(0x1b8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x93f3f0),'status':0x1,'delFlag':![]}});_0x1a7d77['forEach'](_0x48cbb0=>_0x21deb7[_0x3a77e6(0x18c)](_0x48cbb0['id'],_0x48cbb0));const _0x2f0440=await this['gptsGroupEntity'][_0x3a77e6(0x1b8)]({'where':{'id':(0x0,typeorm_2['In'])(_0x9664f1)}});_0x2f0440[_0x3a77e6(0x13a)](_0x518125=>_0x4ef781['set'](_0x518125['id'],_0x518125));}return _0x5c8472[_0x3a77e6(0x1a7)](_0x2efe21=>{const _0x52982d=_0x3a77e6,_0x391c45=_0x21deb7[_0x52982d(0x16c)](_0x2efe21[_0x52982d(0x12d)]);if(_0x391c45?.[_0x52982d(0x198)]){const _0x3fe02b=JSON[_0x52982d(0x185)](_0x2efe21[_0x52982d(0x15e)]);_0x3fe02b[_0x52982d(0x150)][_0x52982d(0x170)]=_0x391c45['modelId'],_0x2efe21[_0x52982d(0x15e)]=JSON[_0x52982d(0x1ba)](_0x3fe02b);}return{..._0x2efe21,'modelName':_0x2efe21[_0x52982d(0x15b)],'gptsApp':_0x391c45?.['gptsApp'],'collected':_0x3d1257[_0x52982d(0x15c)](_0x2efe21[_0x52982d(0x12d)]),'groupName':_0x4ef781[_0x52982d(0x16c)](_0x2efe21[_0x52982d(0x19d)])?.[_0x52982d(0x1aa)]};});}catch(_0x311fd0){console['log']('error:\x20',_0x311fd0);throw new common_1[(_0x3a77e6(0x136))](_0x311fd0,common_1[_0x3a77e6(0x1bb)]['BAD_REQUEST']);}}async[_0x4e82b0(0x1a5)](_0x300f01,_0x40de7b){const _0x52a20d=_0x4e82b0,{title:_0x30f168,isSticky:_0x32a73a,groupId:_0x17c189,config:_0x171750}=_0x300f01,{id:_0x1d2017}=_0x40de7b['user'],_0xb831a=await this['gptsChatEntity'][_0x52a20d(0x166)]({'where':{'id':_0x17c189,'userId':_0x1d2017}});if(!_0xb831a)throw new common_1[(_0x52a20d(0x136))](_0x52a20d(0x186),common_1[_0x52a20d(0x1bb)]['BAD_REQUEST']);const _0x21157b={};_0x21157b['title']=_0x30f168||_0xb831a[_0x52a20d(0x15b)],_0x21157b[_0x52a20d(0x15e)]=_0x171750||_0xb831a['config'],_0x21157b[_0x52a20d(0x1b6)]=_0x32a73a??_0xb831a[_0x52a20d(0x1b6)];const _0x62d7a1=await this[_0x52a20d(0x1b1)][_0x52a20d(0x195)]({'id':_0x17c189},_0x21157b);if(_0x62d7a1[_0x52a20d(0x1ae)])return!![];else throw new common_1[(_0x52a20d(0x136))](_0x52a20d(0x184),common_1['HttpStatus'][_0x52a20d(0x149)]);}async[_0x4e82b0(0x1b4)](_0x69bd28,_0x11c88b){const _0x597fa0=_0x4e82b0;try{const {groupId:_0x216199}=_0x69bd28,{id:_0x28e7a8}=_0x11c88b[_0x597fa0(0x17c)],_0x4f97e6=await this[_0x597fa0(0x1b1)][_0x597fa0(0x166)]({'where':{'id':_0x216199,'userId':_0x28e7a8}})[_0x597fa0(0x1b7)](_0x400aca=>{const _0xd8c100=_0x597fa0;common_1[_0xd8c100(0x1a9)][_0xd8c100(0x143)](_0x400aca);throw new Error(_0x400aca);});if(!_0x4f97e6)throw new Error(_0x597fa0(0x188));await this[_0x597fa0(0x147)]['removeLogsBatch']({'userId':_0x28e7a8,'ids':[_0x216199]})[_0x597fa0(0x1b7)](_0x22a7cc=>{throw new Error(_0x22a7cc);});const _0x35875e=await this['gptsChatEntity']['delete']({'id':_0x216199})[_0x597fa0(0x1b7)](_0x423c75=>{throw new Error(_0x423c75);});if(!_0x35875e)throw new Error(_0x597fa0(0x12b));return!![];}catch(_0x10e7fc){throw new common_1[(_0x597fa0(0x136))](_0x10e7fc,common_1[_0x597fa0(0x1bb)][_0x597fa0(0x149)]);}}async[_0x4e82b0(0x133)](_0x433a22){const _0x1ffff6=_0x4e82b0;try{const {id:_0x5df042}=_0x433a22['user'],_0x54c8a1=await this[_0x1ffff6(0x1b1)][_0x1ffff6(0x1b8)]({'where':{'userId':_0x5df042}})['catch'](_0x30971e=>{const _0x5f13d7=_0x1ffff6;common_1[_0x5f13d7(0x1a9)][_0x5f13d7(0x143)](_0x30971e);throw new Error(_0x30971e);});if(!_0x54c8a1||_0x54c8a1[_0x1ffff6(0x151)]===0x0)throw new Error(_0x1ffff6(0x148));const _0x173d66=_0x54c8a1['map'](_0x329e8f=>_0x329e8f[_0x1ffff6(0x19d)]);await this['chatLogService'][_0x1ffff6(0x167)]({'ids':_0x173d66,'userId':_0x5df042})[_0x1ffff6(0x1b7)](_0x7307fe=>{throw new Error(_0x7307fe);});const _0x1a1b73=await this[_0x1ffff6(0x1b1)]['delete']({'userId':_0x5df042,'isSticky':![]})[_0x1ffff6(0x1b7)](_0x376f70=>{throw new Error(_0x376f70);});if(!_0x1a1b73)throw new Error('清空失败！');return!![];}catch(_0x58a8ab){throw new common_1[(_0x1ffff6(0x136))](_0x58a8ab,common_1[_0x1ffff6(0x1bb)][_0x1ffff6(0x149)]);}}async[_0x4e82b0(0x178)](_0x5dad03){const _0x1d649d=_0x4e82b0;return await this[_0x1d649d(0x1b1)][_0x1d649d(0x166)]({'where':{'id':_0x5dad03}});}async['getCurrentModelByChatGroupId'](_0x31e60c){const _0x34af3d=_0x4e82b0,_0x172103=await this[_0x34af3d(0x1b1)][_0x34af3d(0x166)]({'where':{'id':_0x31e60c}}),_0x5f45fd=await this[_0x34af3d(0x134)][_0x34af3d(0x166)]({'where':{'id':_0x172103[_0x34af3d(0x12d)]}}),_0x1eeb83=await this[_0x34af3d(0x1a4)][_0x34af3d(0x173)](model_constant_1[_0x34af3d(0x197)]['APP']);return _0x1eeb83[_0x34af3d(0x168)]=_0x5f45fd[_0x34af3d(0x168)],_0x1eeb83[_0x34af3d(0x170)]=_0x5f45fd[_0x34af3d(0x12d)]||_0x5f45fd[_0x34af3d(0x19a)],_0x1eeb83;}async[_0x4e82b0(0x14d)](_0x2be9af,_0x5b9cfc){const _0x53755a=_0x4e82b0;await this[_0x53755a(0x1a1)][_0x53755a(0x164)]()[_0x53755a(0x195)](gpts_group_entity_1[_0x53755a(0x165)])[_0x53755a(0x18c)]({'useCount':()=>_0x53755a(0x193),'useToken':()=>_0x53755a(0x17e)+_0x5b9cfc})['where'](_0x53755a(0x16a),{'id':_0x2be9af})[_0x53755a(0x172)]();}async[_0x4e82b0(0x177)](_0x3f1af4,_0x17b957){const _0x570d9a=_0x4e82b0,_0x28a2bf={'id':_0x3f1af4};return _0x17b957!=null&&_0x17b957!==undefined&&(_0x28a2bf[_0x570d9a(0x175)]=_0x17b957),this['gptsModelEntity'][_0x570d9a(0x166)]({'where':_0x28a2bf});}};GptsService=__decorate([(0x0,common_1[_0x4e82b0(0x161)])(),__param(0x0,(0x0,typeorm_1[_0x4e82b0(0x146)])(userApps_entity_1[_0x4e82b0(0x1b0)])),__param(0x1,(0x0,typeorm_1[_0x4e82b0(0x146)])(gpts_group_entity_1[_0x4e82b0(0x165)])),__param(0x2,(0x0,typeorm_1[_0x4e82b0(0x146)])(gpts_model_entity_1['GptsModelEntity'])),__param(0x3,(0x0,typeorm_1[_0x4e82b0(0x146)])(gpts_chat_entity_1[_0x4e82b0(0x12f)])),__metadata('design:paramtypes',[typeorm_2[_0x4e82b0(0x12a)],typeorm_2[_0x4e82b0(0x12a)],typeorm_2[_0x4e82b0(0x12a)],typeorm_2[_0x4e82b0(0x12a)],nestjs_cls_1[_0x4e82b0(0x158)],models_service_1[_0x4e82b0(0x157)],chatLog_service_1[_0x4e82b0(0x131)]])],GptsService),exports[_0x4e82b0(0x196)]=GptsService;function _0xf8fd(_0x54dbcf,_0x58815c){const _0x59ea96=_0x59ea();return _0xf8fd=function(_0xf8fd3c,_0x38bca8){_0xf8fd3c=_0xf8fd3c-0x127;let _0xeec27d=_0x59ea96[_0xf8fd3c];return _0xeec27d;},_0xf8fd(_0x54dbcf,_0x58815c);}function _0x59ea(){const _0x4885a5=['isSticky','catch','find','getExistGpts','stringify','HttpStatus','assign','log','693380Cdaavk','DESC','Repository','删除失败！','1004222FfFAZO','modelId','object','GptsChatEntity','APP','ChatLogService','mine','delAllGptsChat','gptsModelEntity','IsNull','HttpException','handleQueryGpts','模型不存在！','defineProperty','forEach','4862176nvJXwf','../chatLog/chatLog.service','10388lBIhrB','userId','decorate','clsService','分类已存在！','isPlatform','error','collectCount','useCount','InjectRepository','chatLogService','当前用户没有创建GPT对话！','BAD_REQUEST','logo','findAndCount','count','saveGptsUseLog','function','1544460EHFSCk','modelInfo','length','save','headers','handleAddGpts','nestjs-cls','./gpts.model.entity','ModelsService','ClsService','demoData','3rruESm','title','has','message','config','createdAt','desc','Injectable','handleRemoveGpts','error:\x20','createQueryBuilder','GptsGroupEntity','findOne','removeLogsBatch','modelName','handleAddGptsBatch','id\x20=\x20:id','3064ePdPjl','get','GptsModelEntity','where','filter','model','metadata','execute','getRandomKey','@nestjs/common','status','getOwnPropertyDescriptor','getAppById','getGroupInfoFromId','42miQqNc','__metadata','Equal','user','getUserId','useToken\x20+\x20','__decorate','then','appId','delete','5819850FsiLaT','更新对话失败！','parse','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','handleUpdateGroup','非法操作、您在删除一个非法资源！','getReqSaasId','userAppsEntity','./gpts.group.entity','set','请先登录！','499825iHXwuY','fingerprint','ceil','recommend','getLastByUserAndAppIds','useCount\x20+\x201','order','update','GptsService','EModelType','gptsApp','canUpload','relModel','canAudio','saasId','groupId','random','isDefined','typeorm','gptsGroupEntity','非法操作、您在使用一个不存在的应用！','getModelByType','modelsService','updateGptsChat','当前分类存在应用,不允许删除！','map','push','Logger','groupName','popular','应用类型不可更改！','add','affected','listByFrontType','UserAppsEntity','gptsChatEntity','handleQueryGroup','__esModule','delGptsChat','../../common/constants/model.constant'];_0x59ea=function(){return _0x4885a5;};return _0x59ea();}