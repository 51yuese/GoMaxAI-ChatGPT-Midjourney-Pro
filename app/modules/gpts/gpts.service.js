'use strict';function _0x5b4c(){const _0x1bdc9e=['handleCreateChat','UserAppsEntity','当前分类存在应用,不允许删除！','id\x20=\x20:id','更新对话失败！','findAndCount','stringify','GptsModelEntity','catch','__param','filter','delete','DESC','modelsService','@nestjs/common','../chatLog/chatLog.service','非法操作、您在使用一个不存在的应用！','random','collectCount','getRandomKey','demoData','order','message','handleAddGpts','GptsService','删除失败！','./gpts.model.entity','16105GOAhDS','function','orderBy','3310013MrWiZe','execute','createdAt','应用分类不存在,无法删除！','parse','useCount','304WJdPGO','useCount\x20+\x201','isDefined','forEach','title','./gpts.group.entity','popular','请先登录！','handleUpdateGroup','ceil','../models/models.service','3794680OscBnB','decorate','config','where','APP','2336RZXCJw','has','ClsService','8620XdTOra','logo','relModel','isPlatform','updateGptsChat','listByFrontType','metadata','getLastByUserAndAppIds','delAllGptsChat','ModelsService','find','groupBy','__decorate','groupId','model','../app/userApps.entity','desc','assign','update','set','模型不存在！','hasHistory','map','groupName','nestjs-cls','1222092TAZdbC','gpts不存在,无法删除！','userAppsEntity','save','getAppByIdWithCollect','HttpStatus','customParams','findOne','模型组不存在！','Repository','removeLogsBatch','object','user','../../common/utils','IsNull','status','当前用户没有创建GPT对话！','GptsChatEntity','defineProperty','log','getModelByType','../../common/constants/model.constant','affected','9rzPGdA','gptsChatEntity','29458PypgAq','GptsGroupEntity','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','InjectRepository','add','getOwnPropertyDescriptor','gptsApp','handleGetChat','canAudio','非法操作、您在删除一个非法资源！','gptsGroupEntity','chatLogService','modelId','clsService','then','Logger','useToken\x20+\x20','saasId','分类已存在！','__metadata','createQueryBuilder','userId','gptsModelEntity','error:\x20','modelInfo','getExistGpts','当前应用已经开启了一个对话无需新建了！','appId','新对话','8904468ozkbvf','getReqSaasId','handleQueryGroup','getGroupInfoFromId','get','headers','canUpload','isSticky','getAppById','error','handleAddGptsBatch','recommend','push','BAD_REQUEST','count','1028FFVSRb','EModelType','HttpException','length','typeorm','modelName','应用类型不可更改！'];_0x5b4c=function(){return _0x1bdc9e;};return _0x5b4c();}const _0x38da2c=_0x53c1;(function(_0x58c3bf,_0x5c448e){const _0x216a6c=_0x53c1,_0x1dc65c=_0x58c3bf();while(!![]){try{const _0x52fb7c=parseInt(_0x216a6c(0x200))/0x1*(parseInt(_0x216a6c(0x1f0))/0x2)+-parseInt(_0x216a6c(0x21c))/0x3+parseInt(_0x216a6c(0x261))/0x4*(-parseInt(_0x216a6c(0x283))/0x5)+-parseInt(_0x216a6c(0x252))/0x6+parseInt(_0x216a6c(0x286))/0x7+parseInt(_0x216a6c(0x1fb))/0x8*(parseInt(_0x216a6c(0x233))/0x9)+-parseInt(_0x216a6c(0x203))/0xa*(-parseInt(_0x216a6c(0x235))/0xb);if(_0x52fb7c===_0x5c448e)break;else _0x1dc65c['push'](_0x1dc65c['shift']());}catch(_0x5353fe){_0x1dc65c['push'](_0x1dc65c['shift']());}}}(_0x5b4c,0xd9a47));function _0x53c1(_0x476de5,_0x474d17){const _0x5b4c1a=_0x5b4c();return _0x53c1=function(_0x53c16f,_0x3928bb){_0x53c16f=_0x53c16f-0x1f0;let _0x20805f=_0x5b4c1a[_0x53c16f];return _0x20805f;},_0x53c1(_0x476de5,_0x474d17);}var __decorate=this&&this[_0x38da2c(0x20f)]||function(_0x17a028,_0x11fbd2,_0x49126c,_0x1778f3){const _0x2b7d1e=_0x38da2c;var _0x5e77ce=arguments[_0x2b7d1e(0x264)],_0x170762=_0x5e77ce<0x3?_0x11fbd2:_0x1778f3===null?_0x1778f3=Object[_0x2b7d1e(0x23a)](_0x11fbd2,_0x49126c):_0x1778f3,_0x5ddf78;if(typeof Reflect===_0x2b7d1e(0x227)&&typeof Reflect[_0x2b7d1e(0x1fc)]===_0x2b7d1e(0x284))_0x170762=Reflect[_0x2b7d1e(0x1fc)](_0x17a028,_0x11fbd2,_0x49126c,_0x1778f3);else{for(var _0x243a57=_0x17a028[_0x2b7d1e(0x264)]-0x1;_0x243a57>=0x0;_0x243a57--)if(_0x5ddf78=_0x17a028[_0x243a57])_0x170762=(_0x5e77ce<0x3?_0x5ddf78(_0x170762):_0x5e77ce>0x3?_0x5ddf78(_0x11fbd2,_0x49126c,_0x170762):_0x5ddf78(_0x11fbd2,_0x49126c))||_0x170762;}return _0x5e77ce>0x3&&_0x170762&&Object[_0x2b7d1e(0x22e)](_0x11fbd2,_0x49126c,_0x170762),_0x170762;},__metadata=this&&this[_0x38da2c(0x248)]||function(_0x171b0a,_0x117dc6){const _0x1723c8=_0x38da2c;if(typeof Reflect===_0x1723c8(0x227)&&typeof Reflect[_0x1723c8(0x209)]==='function')return Reflect[_0x1723c8(0x209)](_0x171b0a,_0x117dc6);},__param=this&&this[_0x38da2c(0x271)]||function(_0x8506c4,_0x5b7bf1){return function(_0x22780b,_0x324726){_0x5b7bf1(_0x22780b,_0x324726,_0x8506c4);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x38da2c(0x280)]=void 0x0;const common_1=require(_0x38da2c(0x276)),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x38da2c(0x1f5)),typeorm_2=require(_0x38da2c(0x265)),gpts_model_entity_1=require(_0x38da2c(0x282)),gpts_chat_entity_1=require('./gpts.chat.entity'),chatLog_service_1=require(_0x38da2c(0x277)),utils_1=require(_0x38da2c(0x229)),models_service_1=require(_0x38da2c(0x1fa)),userApps_entity_1=require(_0x38da2c(0x212)),model_constant_1=require(_0x38da2c(0x231)),nestjs_cls_1=require(_0x38da2c(0x21b));let GptsService=class GptsService{constructor(_0x4db85b,_0x5997bc,_0x2dc988,_0x287d6b,_0x417516,_0x47fc69,_0x4875c9){const _0x56970b=_0x38da2c;this[_0x56970b(0x21e)]=_0x4db85b,this['gptsGroupEntity']=_0x5997bc,this[_0x56970b(0x24b)]=_0x2dc988,this[_0x56970b(0x234)]=_0x287d6b,this[_0x56970b(0x242)]=_0x417516,this[_0x56970b(0x275)]=_0x47fc69,this[_0x56970b(0x240)]=_0x4875c9;}async['handleAddGroup'](_0x5f37c8){const _0xa66695=_0x38da2c;try{const _0xf33324=_0x5f37c8[_0xa66695(0x21a)],_0x589241=(0x0,utils_1[_0xa66695(0x253)])(this['clsService']),_0x33b199=await this['gptsGroupEntity'][_0xa66695(0x223)]({'where':{'groupName':_0xf33324,'saasId':_0x589241}});if(_0x33b199)throw new common_1[(_0xa66695(0x263))](_0xa66695(0x247),common_1[_0xa66695(0x221)][_0xa66695(0x25f)]);return await this[_0xa66695(0x23f)][_0xa66695(0x21f)]({..._0x5f37c8,'saasId':_0x589241}),!![];}catch(_0x14e580){throw new common_1[(_0xa66695(0x263))](_0x14e580['message'],common_1[_0xa66695(0x221)][_0xa66695(0x25f)]);}}async[_0x38da2c(0x1f8)](_0x581dda){const _0x1d8c2d=_0x38da2c;try{const _0x493f56=await this[_0x1d8c2d(0x23f)][_0x1d8c2d(0x223)]({'where':{'id':_0x581dda['id']}});if(!_0x493f56)throw new common_1[(_0x1d8c2d(0x263))](_0x1d8c2d(0x224),common_1[_0x1d8c2d(0x221)][_0x1d8c2d(0x25f)]);return await this['gptsGroupEntity'][_0x1d8c2d(0x215)]({'id':_0x581dda['id']},_0x581dda),!![];}catch(_0x3af70c){throw new common_1[(_0x1d8c2d(0x263))](_0x3af70c['message'],common_1[_0x1d8c2d(0x221)][_0x1d8c2d(0x25f)]);}}async['handleRemoveGroup'](_0x6bff6b){const _0xb39fae=_0x38da2c;try{const _0x1520b6=_0x6bff6b['id'],_0x5228a5=await this['gptsGroupEntity']['findOne']({'where':{'id':_0x1520b6}});if(!_0x5228a5)throw new common_1['HttpException'](_0xb39fae(0x289),common_1[_0xb39fae(0x221)][_0xb39fae(0x25f)]);const _0x2ae460=await this[_0xb39fae(0x24b)]['count']({'where':{'groupId':_0x5228a5['id']}});if(_0x2ae460>0x0)throw new common_1['HttpException'](_0xb39fae(0x26a),common_1['HttpStatus'][_0xb39fae(0x25f)]);else await this[_0xb39fae(0x23f)][_0xb39fae(0x273)]({'id':_0x1520b6});}catch(_0x24e569){throw new common_1[(_0xb39fae(0x263))](_0x24e569[_0xb39fae(0x27e)],common_1[_0xb39fae(0x221)]['BAD_REQUEST']);}}async[_0x38da2c(0x254)](_0x1595fe,_0x2f8bfe){const _0x5dd253=_0x38da2c;try{const _0x3ab955=(0x0,utils_1['getReqSaasId'])(this['clsService']),{page:page=0x1,size:size=0x14,status:_0x8b8689,saasId:_0x5a2890,groupName:_0x43fcf5}=_0x1595fe,_0x168927={};return _0x43fcf5&&(_0x168927[_0x5dd253(0x21a)]=_0x43fcf5),_0x8b8689>=0x0&&(_0x168927['status']=_0x8b8689),(0x0,utils_1[_0x5dd253(0x206)])(this['clsService'])?(0x0,utils_1[_0x5dd253(0x1f2)])(_0x5a2890)&&(_0x168927[_0x5dd253(0x246)]=_0x5a2890):_0x168927['saasId']=_0x3ab955,await this[_0x5dd253(0x23f)][_0x5dd253(0x26d)]({'where':_0x168927,'skip':(page-0x1)*size,'take':size,'order':{'weight':'DESC','id':_0x5dd253(0x274)}})[_0x5dd253(0x243)](([_0x2ba9d9,_0xf02435])=>({'rows':_0x2ba9d9,'count':_0xf02435}))[_0x5dd253(0x270)](_0x51eb97=>{throw new Error(_0x51eb97);});}catch(_0x2b3eb5){console['log'](_0x5dd253(0x24c),_0x2b3eb5);throw new common_1[(_0x5dd253(0x263))](_0x2b3eb5,common_1[_0x5dd253(0x221)][_0x5dd253(0x25f)]);}}async['handleGetGroup'](_0x1fd7e8,_0x3b836e){const _0x41ca4f=_0x38da2c;try{const {groupId:_0x21cdd5}=_0x1fd7e8;return await this[_0x41ca4f(0x23f)][_0x41ca4f(0x223)]({'where':{'id':Number(_0x21cdd5)}})[_0x41ca4f(0x243)](_0xd4d69f=>{return _0xd4d69f;})[_0x41ca4f(0x270)](_0x6cbc0e=>{throw new Error(_0x6cbc0e);});}catch(_0x487ef8){console[_0x41ca4f(0x22f)](_0x41ca4f(0x24c),_0x487ef8);throw new common_1[(_0x41ca4f(0x263))](_0x487ef8,common_1[_0x41ca4f(0x221)][_0x41ca4f(0x25f)]);}}async[_0x38da2c(0x27f)](_0x2bc203,_0x2ed2e1){const _0x18560c=_0x38da2c;try{const _0xa98022=_0x2bc203[_0x18560c(0x228)]['id'],_0x330546=(0x0,utils_1['getReqSaasId'])(this[_0x18560c(0x242)]),_0x41c8dd=Object[_0x18560c(0x214)](new gpts_model_entity_1[(_0x18560c(0x26f))](),_0x2ed2e1);_0x41c8dd[_0x18560c(0x22b)]=Number(_0x2ed2e1[_0x18560c(0x22b)]);if(_0x41c8dd['id']){const _0x71d85f=await this[_0x18560c(0x24b)][_0x18560c(0x223)]({'where':{'id':_0x41c8dd['id']}});if(!_0x71d85f)throw new common_1['HttpException'](_0x18560c(0x217),common_1[_0x18560c(0x221)]['BAD_REQUEST']);if(_0x71d85f[_0x18560c(0x23b)]!==_0x41c8dd[_0x18560c(0x23b)])throw new common_1['HttpException'](_0x18560c(0x267),common_1[_0x18560c(0x221)][_0x18560c(0x25f)]);return await this[_0x18560c(0x24b)][_0x18560c(0x215)]({'id':_0x41c8dd['id']},{..._0x41c8dd,'useCount':_0x41c8dd[_0x18560c(0x28b)]??_0x71d85f['useCount'],'collectCount':_0x41c8dd[_0x18560c(0x27a)]??_0x71d85f[_0x18560c(0x27a)]})[_0x18560c(0x243)](_0x5aee7e=>_0x5aee7e[_0x18560c(0x232)]>0x0)['catch'](_0x439bf3=>{throw new Error(_0x439bf3);});}else{const _0x16d115=await this[_0x18560c(0x23f)][_0x18560c(0x223)]({'where':{'id':_0x41c8dd[_0x18560c(0x210)]}});if(!_0x16d115)throw new common_1['HttpException']('应用分类不存在！',common_1[_0x18560c(0x221)]['BAD_REQUEST']);const _0x1cabbd=await this['gptsModelEntity'][_0x18560c(0x21f)]({..._0x41c8dd,'saasId':_0x330546,'userId':_0x2bc203[_0x18560c(0x257)]['fingerprint']?_0xa98022:null});return _0x1cabbd['id'];}}catch(_0x3c584a){throw new common_1[(_0x18560c(0x263))](_0x3c584a,common_1['HttpStatus'][_0x18560c(0x25f)]);}}async[_0x38da2c(0x24e)](){const _0xfd7d5c=_0x38da2c;return await this[_0xfd7d5c(0x24b)][_0xfd7d5c(0x20d)]()[_0xfd7d5c(0x243)](_0x59a82a=>_0x59a82a['map'](_0x3b0966=>_0x3b0966['modelName']));}async[_0x38da2c(0x25c)](_0x29af86){const _0x591190=_0x38da2c;try{const _0x1cdfc8=(0x0,utils_1[_0x591190(0x253)])(this[_0x591190(0x242)]),_0xa2ece5=await this[_0x591190(0x24e)](),_0x516f9d=_0x29af86[_0x591190(0x272)](_0x4a5c9d=>!_0xa2ece5['includes'](_0x4a5c9d['modelName']))[_0x591190(0x219)](_0x1ab3cd=>({'groupId':_0x1ab3cd[_0x591190(0x210)],'relModel':_0x1ab3cd[_0x591190(0x205)],'logo':_0x1ab3cd[_0x591190(0x204)],'desc':_0x1ab3cd['desc'],'modelName':_0x1ab3cd[_0x591190(0x266)],'modelId':_0x1ab3cd[_0x591190(0x241)],'saasId':_0x1cdfc8}));return await this['gptsModelEntity'][_0x591190(0x21f)](_0x516f9d)[_0x591190(0x270)](_0x404019=>{throw new Error(_0x404019);});}catch(_0x4d6316){console['log'](_0x591190(0x24c),_0x4d6316);throw new common_1[(_0x591190(0x263))](_0x4d6316,common_1[_0x591190(0x221)][_0x591190(0x25f)]);}}async['handleQueryGpts'](_0x550a1f,_0x47b5fe){const _0x41325a=_0x38da2c;try{const _0x99fceb=(0x0,utils_1['getUserId'])(this[_0x41325a(0x242)]),_0x157ffe=(0x0,utils_1['getReqSaasId'])(this[_0x41325a(0x242)]),_0x4bc92c=new Set(),_0x33173c=new Map(),{modelId:_0x4174e2,modelName:_0x14977e,groupId:_0x570d8c,back:_0x5ae55d,status:_0x4c9ee2,page:page=0x1,size:size=0x14,saasId:_0xc9cf5a}=_0x550a1f,_0x5b57c5={'delFlag':![]};_0x99fceb?_0x5b57c5[_0x41325a(0x24a)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2['Equal'])(_0x99fceb),(0x0,typeorm_2[_0x41325a(0x22a)])()):_0x5b57c5[_0x41325a(0x24a)]=(0x0,typeorm_2[_0x41325a(0x22a)])();(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1[_0x41325a(0x1f2)])(_0xc9cf5a)&&(_0x5b57c5[_0x41325a(0x246)]=_0xc9cf5a):_0x5b57c5[_0x41325a(0x246)]=_0x157ffe;!_0x5ae55d?_0x5b57c5[_0x41325a(0x22b)]=0x1:(_0x4c9ee2!==undefined&&_0x4c9ee2!==null&&(_0x5b57c5[_0x41325a(0x22b)]=_0x4c9ee2),delete _0x5b57c5[_0x41325a(0x24a)]);_0x4174e2&&(_0x5b57c5[_0x41325a(0x241)]=_0x4174e2),_0x570d8c&&(_0x5b57c5[_0x41325a(0x210)]=_0x570d8c),_0x14977e&&(_0x5b57c5[_0x41325a(0x266)]=(0x0,typeorm_2['Like'])('%'+_0x14977e+'%'));const [_0x401017,_0x1f85fe]=await this['gptsModelEntity'][_0x41325a(0x26d)]({'skip':(page-0x1)*size,'take':size,'where':_0x5b57c5,'order':{'sortId':_0x41325a(0x274)}});if(_0x401017['length']){const _0x88ea9f=[],_0x1ea40c=[];_0x401017[_0x41325a(0x1f3)](_0x1419df=>{const _0x1c18fa=_0x41325a;_0x88ea9f[_0x1c18fa(0x25e)](_0x1419df['id']),_0x1ea40c['push'](_0x1419df[_0x1c18fa(0x210)]);});if(_0x99fceb){const _0x7df7e5=await this[_0x41325a(0x21e)][_0x41325a(0x20d)]({'where':{'userId':_0x99fceb,'appId':(0x0,typeorm_2['In'])(_0x88ea9f)}});_0x7df7e5['forEach'](_0xc5be85=>_0x4bc92c['add'](_0xc5be85[_0x41325a(0x250)]));}const _0x11e680=await this[_0x41325a(0x23f)][_0x41325a(0x20d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1ea40c)}});_0x11e680[_0x41325a(0x1f3)](_0xa28a57=>_0x33173c[_0x41325a(0x216)](_0xa28a57['id'],_0xa28a57));}return{'count':_0x1f85fe,'rows':_0x401017[_0x41325a(0x219)](_0x3e863a=>({..._0x3e863a,'collected':_0x4bc92c[_0x41325a(0x201)](_0x3e863a['id']),'groupName':_0x33173c[_0x41325a(0x256)](_0x3e863a[_0x41325a(0x210)])?.['groupName']}))};}catch(_0x114699){console[_0x41325a(0x22f)]('error:\x20',_0x114699);throw new common_1['HttpException'](_0x114699,common_1[_0x41325a(0x221)]['BAD_REQUEST']);}}async[_0x38da2c(0x208)](_0x1779ab,_0xe9a47f){const _0x4e81c8=_0x38da2c,_0x21a1e0=(0x0,utils_1['getUserId'])(this['clsService']),_0x54ba54=(0x0,utils_1[_0x4e81c8(0x253)])(this[_0x4e81c8(0x242)]),_0x19369b={'take':0x1e};if(_0xe9a47f==_0x4e81c8(0x25d))_0x19369b[_0x4e81c8(0x1fe)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x19369b[_0x4e81c8(0x27d)]={'createdAt':'DESC'};else{if(_0xe9a47f===_0x4e81c8(0x1f6))_0x19369b['where']={'status':0x1,'delFlag':![]},_0x19369b[_0x4e81c8(0x27d)]={'useCount':_0x4e81c8(0x274)};else{if(_0xe9a47f==='favorite')_0x19369b[_0x4e81c8(0x1fe)]={'status':0x1,'delFlag':![]},_0x19369b[_0x4e81c8(0x27d)]={'collectCount':_0x4e81c8(0x274)};else{if(_0xe9a47f==='mine'){if(!_0x21a1e0)throw new common_1[(_0x4e81c8(0x263))](_0x4e81c8(0x1f7),common_1[_0x4e81c8(0x221)]['UNAUTHORIZED']);_0x19369b[_0x4e81c8(0x1fe)]={'status':0x1,'delFlag':![],'userId':_0x21a1e0},_0x19369b[_0x4e81c8(0x27d)]={'createdAt':'DESC'};}else _0x19369b['where']={'status':0x1,'delFlag':![]},_0x19369b['order']={'createdAt':_0x4e81c8(0x274)};}}}_0x19369b[_0x4e81c8(0x1fe)][_0x4e81c8(0x246)]=_0x54ba54;const _0x59f7c6=await this[_0x4e81c8(0x24b)][_0x4e81c8(0x20d)](_0x19369b),_0x322735=new Set(),_0x20c163=new Map(),_0x111d57=new Map(),_0x3c4ed5=[],_0x4c13fe=[];_0x59f7c6[_0x4e81c8(0x1f3)](_0x4360d5=>{const _0x233643=_0x4e81c8;_0x3c4ed5[_0x233643(0x25e)](_0x4360d5['id']),_0x4c13fe[_0x233643(0x25e)](_0x4360d5[_0x233643(0x210)]);});if(_0x3c4ed5['length']){if(_0x21a1e0){const _0x3e3d26=await this[_0x4e81c8(0x21e)][_0x4e81c8(0x20d)]({'where':{'userId':_0x21a1e0,'appId':(0x0,typeorm_2['In'])(_0x3c4ed5)}});_0x3e3d26[_0x4e81c8(0x1f3)](_0x4ddc97=>_0x322735[_0x4e81c8(0x239)](_0x4ddc97[_0x4e81c8(0x250)]));const _0x3bd3f7=await this['chatLogService'][_0x4e81c8(0x20a)](_0x21a1e0,_0x3c4ed5);_0x3bd3f7[_0x4e81c8(0x1f3)](_0x488017=>_0x20c163[_0x4e81c8(0x216)](_0x488017[_0x4e81c8(0x250)],_0x488017[_0x4e81c8(0x288)]));}const _0x4568b9=await this[_0x4e81c8(0x23f)][_0x4e81c8(0x20d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4c13fe)}});_0x4568b9[_0x4e81c8(0x1f3)](_0x4184a8=>_0x111d57['set'](_0x4184a8['id'],_0x4184a8));}return _0x59f7c6[_0x4e81c8(0x219)](_0x380a14=>({..._0x380a14,'collected':_0x322735[_0x4e81c8(0x201)](_0x380a14['id']),'lastTime':_0x20c163['get'](_0x380a14['id'])||null,'groupName':_0x111d57[_0x4e81c8(0x256)](_0x380a14[_0x4e81c8(0x210)])?.[_0x4e81c8(0x21a)]}));}async['handleRemoveGpts'](_0x37c45c){const _0x74c8ce=_0x38da2c;try{const {id:_0x2684e7}=_0x37c45c,_0x30e59e=await this['gptsModelEntity'][_0x74c8ce(0x223)]({'where':{'id':_0x2684e7}});if(!_0x30e59e)throw new common_1[(_0x74c8ce(0x263))](_0x74c8ce(0x21d),common_1[_0x74c8ce(0x221)][_0x74c8ce(0x25f)]);return await this['gptsModelEntity']['delete'](_0x2684e7)['then'](_0x3ff54c=>_0x3ff54c[_0x74c8ce(0x232)]>0x0)[_0x74c8ce(0x270)](_0x556a8e=>{throw new Error(_0x556a8e);});}catch(_0x1859ea){console['log'](_0x74c8ce(0x24c),_0x1859ea);throw new common_1[(_0x74c8ce(0x263))](_0x1859ea,common_1[_0x74c8ce(0x221)]['BAD_REQUEST']);}}async[_0x38da2c(0x268)](_0x52a172,_0x1762ad){const _0x1b570f=_0x38da2c,_0x46eac6=_0x52a172[_0x1b570f(0x250)],_0x18dcb9=_0x1762ad[_0x1b570f(0x228)]['id'],_0x460e05=(0x0,utils_1[_0x1b570f(0x253)])(this[_0x1b570f(0x242)]);let _0x2089c2=null,_0x1e74a0={'title':_0x1b570f(0x251),'userId':_0x18dcb9,'saasId':_0x460e05};try{_0x2089c2=await this[_0x1b570f(0x24b)]['findOne']({'where':{'id':_0x46eac6}});if(!_0x2089c2)throw new Error(_0x1b570f(0x278));if(_0x2089c2['status']!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');if(!_0x52a172[_0x1b570f(0x218)]){const _0x2b74b0=await this[_0x1b570f(0x234)][_0x1b570f(0x260)]({'where':{'modelId':_0x46eac6,'userId':_0x18dcb9,'isDelete':![]}});if(_0x2b74b0>0x0)throw new Error(_0x1b570f(0x24f));}_0x1e74a0[_0x1b570f(0x241)]=_0x2089c2['id'],_0x1e74a0[_0x1b570f(0x211)]=_0x2089c2[_0x1b570f(0x241)],_0x1e74a0[_0x1b570f(0x210)]=_0x2089c2[_0x1b570f(0x210)],_0x1e74a0['desc']=_0x2089c2[_0x1b570f(0x213)]||'',_0x1e74a0[_0x1b570f(0x204)]=_0x2089c2[_0x1b570f(0x204)]||'',_0x1e74a0[_0x1b570f(0x1f4)]=_0x52a172['hasHistory']?_0x1b570f(0x251):_0x2089c2['modelName'],_0x1e74a0[_0x1b570f(0x27c)]=_0x2089c2[_0x1b570f(0x27c)]||'';let _0x3526f1=await this['modelsService'][_0x1b570f(0x230)](model_constant_1[_0x1b570f(0x262)][_0x1b570f(0x1ff)]);_0x3526f1[_0x1b570f(0x24d)][_0x1b570f(0x23d)]=_0x2089c2[_0x1b570f(0x23d)],_0x3526f1[_0x1b570f(0x24d)][_0x1b570f(0x266)]=_0x2089c2[_0x1b570f(0x266)],_0x3526f1['modelInfo'][_0x1b570f(0x258)]=_0x2089c2['canUpload'];_0x2089c2['gptsApp']?_0x3526f1['modelInfo'][_0x1b570f(0x211)]=_0x2089c2[_0x1b570f(0x241)]:_0x3526f1['modelInfo']['model']=_0x2089c2[_0x1b570f(0x205)];_0x1e74a0[_0x1b570f(0x1fd)]=JSON['stringify'](_0x3526f1);const _0x186e2e=await this[_0x1b570f(0x234)][_0x1b570f(0x21f)](_0x1e74a0);return _0x2089c2&&(_0x2089c2[_0x1b570f(0x28b)]=_0x2089c2[_0x1b570f(0x28b)]+Math[_0x1b570f(0x1f9)](Math[_0x1b570f(0x279)]()*0xa),await this[_0x1b570f(0x24b)]['save'](_0x2089c2)),_0x186e2e;}catch(_0x3e0df7){throw new common_1[(_0x1b570f(0x263))](_0x3e0df7[_0x1b570f(0x27e)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x38da2c(0x23c)](_0x50d63d,_0xb8f22a){const _0x1d1f1b=_0x38da2c;try{const _0x1c72fd=_0x50d63d[_0x1d1f1b(0x228)]['id'],_0x370922={'userId':_0x1c72fd,'isDelete':![]};_0xb8f22a&&(_0x370922[_0x1d1f1b(0x241)]=_0xb8f22a);let _0x4f3b9a=[];_0xb8f22a?_0x4f3b9a=await this[_0x1d1f1b(0x234)]['find']({'where':_0x370922,'order':{'isSticky':_0x1d1f1b(0x274),'updatedAt':_0x1d1f1b(0x274)}}):_0x4f3b9a=await this[_0x1d1f1b(0x234)][_0x1d1f1b(0x249)]()[_0x1d1f1b(0x1fe)](_0x370922)[_0x1d1f1b(0x20e)]('modelId')[_0x1d1f1b(0x285)]({'isSticky':_0x1d1f1b(0x274),'updatedAt':_0x1d1f1b(0x274)})['getMany']();const _0x4ab681=new Set(),_0x253815=new Map(),_0xcd6ece=new Map(),_0x181dfc=[],_0x4dda75=[];_0x4f3b9a['forEach'](_0x4037a2=>{const _0x407750=_0x1d1f1b;_0x181dfc[_0x407750(0x25e)](_0x4037a2[_0x407750(0x241)]),_0x4dda75[_0x407750(0x25e)](_0x4037a2['groupId']);});if(_0x181dfc['length']){const _0x4f630c=await this[_0x1d1f1b(0x21e)][_0x1d1f1b(0x20d)]({'where':{'userId':_0x1c72fd,'appId':(0x0,typeorm_2['In'])(_0x181dfc)}});_0x4f630c['forEach'](_0x140f58=>_0x4ab681[_0x1d1f1b(0x239)](_0x140f58[_0x1d1f1b(0x250)]));const _0x5ea5b0=await this['gptsModelEntity'][_0x1d1f1b(0x20d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x181dfc),'status':0x1,'delFlag':![]}});_0x5ea5b0[_0x1d1f1b(0x1f3)](_0x559a08=>_0x253815[_0x1d1f1b(0x216)](_0x559a08['id'],_0x559a08));const _0x562b48=await this[_0x1d1f1b(0x23f)][_0x1d1f1b(0x20d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4dda75)}});_0x562b48[_0x1d1f1b(0x1f3)](_0x55f31a=>_0xcd6ece['set'](_0x55f31a['id'],_0x55f31a));}return _0x4f3b9a[_0x1d1f1b(0x219)](_0x537bcb=>{const _0x53e000=_0x1d1f1b,_0x1b21e9=_0x253815[_0x53e000(0x256)](_0x537bcb['modelId']);if(_0x1b21e9?.['gptsApp']){const _0xa31501=JSON[_0x53e000(0x28a)](_0x537bcb[_0x53e000(0x1fd)]);_0xa31501[_0x53e000(0x24d)][_0x53e000(0x211)]=_0x1b21e9['modelId'],_0x537bcb[_0x53e000(0x1fd)]=JSON[_0x53e000(0x26e)](_0xa31501);}return{..._0x537bcb,'modelName':_0x1b21e9?.[_0x53e000(0x266)]||_0x537bcb[_0x53e000(0x1f4)],'gptsApp':_0x1b21e9?.['gptsApp'],'customParams':_0x1b21e9?.[_0x53e000(0x222)],'customConfig':_0x1b21e9?.[_0x53e000(0x1fd)],'collected':_0x4ab681[_0x53e000(0x201)](_0x537bcb[_0x53e000(0x241)]),'groupName':_0xcd6ece[_0x53e000(0x256)](_0x537bcb['groupId'])?.[_0x53e000(0x21a)]};});}catch(_0x1b744a){console[_0x1d1f1b(0x22f)](_0x1d1f1b(0x24c),_0x1b744a);throw new common_1[(_0x1d1f1b(0x263))](_0x1b744a,common_1[_0x1d1f1b(0x221)][_0x1d1f1b(0x25f)]);}}async[_0x38da2c(0x207)](_0x2151e6,_0x29da74){const _0x422070=_0x38da2c,{title:_0x458d3c,isSticky:_0x508726,groupId:_0x2e427c,config:_0x303c24}=_0x2151e6,{id:_0x267965}=_0x29da74[_0x422070(0x228)],_0x4ee9b4=await this[_0x422070(0x234)][_0x422070(0x223)]({'where':{'id':_0x2e427c,'userId':_0x267965}});if(!_0x4ee9b4)throw new common_1[(_0x422070(0x263))](_0x422070(0x237),common_1['HttpStatus']['BAD_REQUEST']);const _0x2e9294={};_0x2e9294[_0x422070(0x1f4)]=_0x458d3c||_0x4ee9b4['title'],_0x2e9294[_0x422070(0x1fd)]=_0x303c24||_0x4ee9b4[_0x422070(0x1fd)],_0x2e9294[_0x422070(0x259)]=_0x508726??_0x4ee9b4[_0x422070(0x259)];const _0x2fd6a4=await this[_0x422070(0x234)][_0x422070(0x215)]({'id':_0x2e427c},_0x2e9294);if(_0x2fd6a4[_0x422070(0x232)])return!![];else throw new common_1[(_0x422070(0x263))](_0x422070(0x26c),common_1['HttpStatus'][_0x422070(0x25f)]);}async['delGptsChat'](_0x466f3e,_0x7088ff){const _0x15458f=_0x38da2c;try{const {groupId:_0x51a184}=_0x466f3e,{id:_0x1727af}=_0x7088ff[_0x15458f(0x228)],_0x304c3c=await this[_0x15458f(0x234)][_0x15458f(0x223)]({'where':{'id':_0x51a184,'userId':_0x1727af}})[_0x15458f(0x270)](_0x118fed=>{const _0x4c872d=_0x15458f;common_1[_0x4c872d(0x244)][_0x4c872d(0x25b)](_0x118fed);throw new Error(_0x118fed);});if(!_0x304c3c)throw new Error(_0x15458f(0x23e));await this[_0x15458f(0x240)][_0x15458f(0x226)]({'userId':_0x1727af,'ids':[_0x51a184]})['catch'](_0x3453e9=>{throw new Error(_0x3453e9);});const _0x4bbdc9=await this['gptsChatEntity'][_0x15458f(0x273)]({'id':_0x51a184})[_0x15458f(0x270)](_0x3b7f63=>{throw new Error(_0x3b7f63);});if(!_0x4bbdc9)throw new Error(_0x15458f(0x281));return!![];}catch(_0x2e22bd){throw new common_1['HttpException'](_0x2e22bd,common_1[_0x15458f(0x221)]['BAD_REQUEST']);}}async[_0x38da2c(0x20b)](_0x199c1f){const _0x2ebfa9=_0x38da2c;try{const {id:_0x3cbe17}=_0x199c1f[_0x2ebfa9(0x228)],_0x63e3b2=await this[_0x2ebfa9(0x234)][_0x2ebfa9(0x20d)]({'where':{'userId':_0x3cbe17}})[_0x2ebfa9(0x270)](_0x4b5914=>{const _0x7ca685=_0x2ebfa9;common_1[_0x7ca685(0x244)][_0x7ca685(0x25b)](_0x4b5914);throw new Error(_0x4b5914);});if(!_0x63e3b2||_0x63e3b2[_0x2ebfa9(0x264)]===0x0)throw new Error(_0x2ebfa9(0x22c));const _0x3d07e8=_0x63e3b2[_0x2ebfa9(0x219)](_0x4f1436=>_0x4f1436[_0x2ebfa9(0x210)]);await this['chatLogService']['removeLogsBatch']({'ids':_0x3d07e8,'userId':_0x3cbe17})[_0x2ebfa9(0x270)](_0x3abe23=>{throw new Error(_0x3abe23);});const _0x41037f=await this[_0x2ebfa9(0x234)][_0x2ebfa9(0x273)]({'userId':_0x3cbe17,'isSticky':![]})[_0x2ebfa9(0x270)](_0x29d3d1=>{throw new Error(_0x29d3d1);});if(!_0x41037f)throw new Error('清空失败！');return!![];}catch(_0x4ef580){throw new common_1[(_0x2ebfa9(0x263))](_0x4ef580,common_1['HttpStatus'][_0x2ebfa9(0x25f)]);}}async[_0x38da2c(0x255)](_0x56e785){const _0x3e9866=_0x38da2c;return await this[_0x3e9866(0x234)]['findOne']({'where':{'id':_0x56e785}});}async['getCurrentModelByChatGroupId'](_0x5b0a35){const _0x26badf=_0x38da2c,_0x3b178f=await this[_0x26badf(0x234)][_0x26badf(0x223)]({'where':{'id':_0x5b0a35}}),_0xf96055=await this[_0x26badf(0x24b)][_0x26badf(0x223)]({'where':{'id':_0x3b178f[_0x26badf(0x241)]}}),_0x1d3072=await this[_0x26badf(0x275)][_0x26badf(0x27b)](model_constant_1['EModelType'][_0x26badf(0x1ff)]);return _0x1d3072['modelName']=_0xf96055[_0x26badf(0x266)],_0x1d3072[_0x26badf(0x211)]=_0xf96055['modelId']||_0xf96055[_0x26badf(0x205)],_0x1d3072;}async['saveGptsUseLog'](_0x4c0d05,_0x46c1eb){const _0x242ad2=_0x38da2c;await this['gptsGroupEntity'][_0x242ad2(0x249)]()[_0x242ad2(0x215)](gpts_group_entity_1[_0x242ad2(0x236)])[_0x242ad2(0x216)]({'useCount':()=>_0x242ad2(0x1f1),'useToken':()=>_0x242ad2(0x245)+_0x46c1eb})[_0x242ad2(0x1fe)](_0x242ad2(0x26b),{'id':_0x4c0d05})[_0x242ad2(0x287)]();}async[_0x38da2c(0x25a)](_0x3b10e7,_0x2a545d){const _0xafca4f=_0x38da2c,_0x3c9d0b={'id':_0x3b10e7};return _0x2a545d!=null&&_0x2a545d!==undefined&&(_0x3c9d0b[_0xafca4f(0x22b)]=_0x2a545d),this[_0xafca4f(0x24b)][_0xafca4f(0x223)]({'where':_0x3c9d0b});}async[_0x38da2c(0x220)](_0x514b1f,_0x692878,_0x1cbb97){const _0x26b778=_0x38da2c,_0x88f319={'id':_0x692878};_0x1cbb97!=null&&_0x1cbb97!==undefined&&(_0x88f319[_0x26b778(0x22b)]=_0x1cbb97);const _0x4b49fc=await this['gptsModelEntity'][_0x26b778(0x223)]({'where':_0x88f319});if(_0x514b1f['user']){const _0x3f4495=await this[_0x26b778(0x21e)][_0x26b778(0x223)]({'where':{'userId':_0x514b1f['user']['id'],'appId':_0x692878}});if(_0x3f4495)return{..._0x4b49fc,'collected':!![]};}return{..._0x4b49fc,'collected':![]};}};GptsService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x38da2c(0x238)])(userApps_entity_1[_0x38da2c(0x269)])),__param(0x1,(0x0,typeorm_1[_0x38da2c(0x238)])(gpts_group_entity_1[_0x38da2c(0x236)])),__param(0x2,(0x0,typeorm_1[_0x38da2c(0x238)])(gpts_model_entity_1[_0x38da2c(0x26f)])),__param(0x3,(0x0,typeorm_1[_0x38da2c(0x238)])(gpts_chat_entity_1[_0x38da2c(0x22d)])),__metadata('design:paramtypes',[typeorm_2[_0x38da2c(0x225)],typeorm_2[_0x38da2c(0x225)],typeorm_2[_0x38da2c(0x225)],typeorm_2[_0x38da2c(0x225)],nestjs_cls_1[_0x38da2c(0x202)],models_service_1[_0x38da2c(0x20c)],chatLog_service_1['ChatLogService']])],GptsService),exports[_0x38da2c(0x280)]=GptsService;