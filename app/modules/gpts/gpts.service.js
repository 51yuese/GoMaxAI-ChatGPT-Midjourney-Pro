'use strict';function _0x5250(){const _0x2a9235=['2231WbBZpK','query','error:\x20','findAndCount','BAD_REQUEST','title','findOne','handleCreateChat','user','status','GptsService','ChatLogService','updatedAt','canAudio','customParams','metadata','模型组不存在！','UNAUTHORIZED','应用类型不可更改！','length','groupBy','saveGptsUseLog','getReqSaasId','fingerprint','2607111yUqVXr','count','random','非法操作、您在使用一个未启用的应用！','HttpException','popular','get','then','GptsGroupEntity','__metadata','handleQueryGpts','../chatLog/chatLog.service','handleQueryGroup','clsService','decorate','getAppById','Repository','handleGetChat','gptsModelEntity','getModelByType','getGroupInfoFromId','modelName','save','2931188GgLTnV','message','1865583XLQJEC','../../common/constants/model.constant','error','GptsModelEntity','@nestjs/typeorm','recommend','getExistGpts','删除失败！','typeorm','parse','11cBxTYK','userType','stringify','modelsService','useCount','orderBy','function','createdAt','../models/models.service','getOwnPropertyDescriptor','Injectable','vipFreeNum','groupId','应用分类不存在,无法删除！','includes','gpt','log','getUserId','getMany','Like','isSticky','has','collectCount','saasId','logo','headers','model','mine','新对话','应用分类不存在！','__esModule','EModelType','10VMTath','deduct','appId','Logger','ModelsService','当前应用已经开启了一个对话无需新建了！','DESC','favorite','userId','updateGptsChat','removeLogsBatch','当前分类存在应用,不允许删除！','hasHistory','非法操作、您在使用一个不存在的应用！','catch','1240356cJnhuU','1216418yJawcu','586EXpALb','非法操作、您在删除一个非法资源！','canUpload','32gxoCHB','sort','order','getAppModel','filter','set','userAppsEntity','design:paramtypes','HttpStatus','forEach','relModel','gptsGroupEntity','demoData','where','gptsApp','id\x20=\x20:id','useToken\x20+\x20','handleRemoveGroup','add','handleAddGroup','gptsChatEntity','UserAppsEntity','11352410uVLDRd','getWithChat','请先登录！','当前用户没有创建GPT对话！','chatLogService','find','@nestjs/common','更新对话失败！','config','GptsChatEntity','getAppByIdWithCollect','object','update','modelInfo','InjectRepository','APP','lastMessage','modelId','map','getLastByUserAndAppIds','delete','handleRemoveGpts','IsNull','./gpts.chat.entity','push','desc','handleGetGroup','createQueryBuilder','__param','groupName','分类已存在！','chatGroupService'];_0x5250=function(){return _0x2a9235;};return _0x5250();}function _0x4a5f(_0x4ed03d,_0xbd8ae2){const _0x52502d=_0x5250();return _0x4a5f=function(_0x4a5ff2,_0x3c1b2e){_0x4a5ff2=_0x4a5ff2-0x75;let _0x1a3ec4=_0x52502d[_0x4a5ff2];return _0x1a3ec4;},_0x4a5f(_0x4ed03d,_0xbd8ae2);}const _0x1d464b=_0x4a5f;(function(_0x45774c,_0x5121c0){const _0x2cfdcf=_0x4a5f,_0x30bfdc=_0x45774c();while(!![]){try{const _0x5c8bf9=parseInt(_0x2cfdcf(0x93))/0x1*(parseInt(_0x2cfdcf(0xff))/0x2)+-parseInt(_0x2cfdcf(0xab))/0x3+parseInt(_0x2cfdcf(0xc2))/0x4+parseInt(_0x2cfdcf(0xee))/0x5*(parseInt(_0x2cfdcf(0xfd))/0x6)+-parseInt(_0x2cfdcf(0xfe))/0x7+-parseInt(_0x2cfdcf(0x102))/0x8*(-parseInt(_0x2cfdcf(0xc4))/0x9)+-parseInt(_0x2cfdcf(0x118))/0xa*(parseInt(_0x2cfdcf(0xce))/0xb);if(_0x5c8bf9===_0x5121c0)break;else _0x30bfdc['push'](_0x30bfdc['shift']());}catch(_0x28ac71){_0x30bfdc['push'](_0x30bfdc['shift']());}}}(_0x5250,0x6e1d4));var __decorate=this&&this['__decorate']||function(_0x482abc,_0xe49247,_0xaab1c9,_0x487497){const _0xb7d8f3=_0x4a5f;var _0x1b0c1d=arguments['length'],_0x32d900=_0x1b0c1d<0x3?_0xe49247:_0x487497===null?_0x487497=Object[_0xb7d8f3(0xd7)](_0xe49247,_0xaab1c9):_0x487497,_0x5351c2;if(typeof Reflect==='object'&&typeof Reflect[_0xb7d8f3(0xb9)]===_0xb7d8f3(0xd4))_0x32d900=Reflect[_0xb7d8f3(0xb9)](_0x482abc,_0xe49247,_0xaab1c9,_0x487497);else{for(var _0x4a0db6=_0x482abc[_0xb7d8f3(0xa6)]-0x1;_0x4a0db6>=0x0;_0x4a0db6--)if(_0x5351c2=_0x482abc[_0x4a0db6])_0x32d900=(_0x1b0c1d<0x3?_0x5351c2(_0x32d900):_0x1b0c1d>0x3?_0x5351c2(_0xe49247,_0xaab1c9,_0x32d900):_0x5351c2(_0xe49247,_0xaab1c9))||_0x32d900;}return _0x1b0c1d>0x3&&_0x32d900&&Object['defineProperty'](_0xe49247,_0xaab1c9,_0x32d900),_0x32d900;},__metadata=this&&this[_0x1d464b(0xb4)]||function(_0x37149c,_0x4748ab){const _0x314a83=_0x1d464b;if(typeof Reflect===_0x314a83(0x7e)&&typeof Reflect[_0x314a83(0xa2)]===_0x314a83(0xd4))return Reflect[_0x314a83(0xa2)](_0x37149c,_0x4748ab);},__param=this&&this[_0x1d464b(0x8f)]||function(_0x2a5411,_0x1f5b32){return function(_0x23b7c,_0x557674){_0x1f5b32(_0x23b7c,_0x557674,_0x2a5411);};};Object['defineProperty'](exports,_0x1d464b(0xec),{'value':!![]}),exports[_0x1d464b(0x9d)]=void 0x0;const common_1=require(_0x1d464b(0x79)),typeorm_1=require(_0x1d464b(0xc8)),gpts_group_entity_1=require('./gpts.group.entity'),typeorm_2=require(_0x1d464b(0xcc)),gpts_model_entity_1=require('./gpts.model.entity'),gpts_chat_entity_1=require(_0x1d464b(0x8a)),chatLog_service_1=require(_0x1d464b(0xb6)),utils_1=require('../../common/utils'),models_service_1=require(_0x1d464b(0xd6)),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x1d464b(0xc5)),nestjs_cls_1=require('nestjs-cls'),chatGroup_service_1=require('../chatGroup/chatGroup.service');let GptsService=class GptsService{constructor(_0x21061f,_0x3473ca,_0x120f38,_0x43a9f8,_0x2ea000,_0x485f74,_0x56540d,_0x422de0){const _0x50cc24=_0x1d464b;this[_0x50cc24(0x108)]=_0x21061f,this['gptsGroupEntity']=_0x3473ca,this[_0x50cc24(0xbd)]=_0x120f38,this[_0x50cc24(0x116)]=_0x43a9f8,this[_0x50cc24(0xb8)]=_0x2ea000,this[_0x50cc24(0xd1)]=_0x485f74,this['chatLogService']=_0x56540d,this[_0x50cc24(0x92)]=_0x422de0;}async[_0x1d464b(0x115)](_0x4137b9){const _0x1e356f=_0x1d464b;try{const _0x3f72f4=_0x4137b9[_0x1e356f(0x90)],_0x198ec6=(0x0,utils_1[_0x1e356f(0xa9)])(this[_0x1e356f(0xb8)]),_0x1f1e78=await this[_0x1e356f(0x10d)]['findOne']({'where':{'groupName':_0x3f72f4,'saasId':_0x198ec6}});if(_0x1f1e78)throw new common_1['HttpException'](_0x1e356f(0x91),common_1[_0x1e356f(0x10a)][_0x1e356f(0x97)]);return await this[_0x1e356f(0x10d)][_0x1e356f(0xc1)]({..._0x4137b9,'saasId':_0x198ec6}),!![];}catch(_0x2401fe){throw new common_1[(_0x1e356f(0xaf))](_0x2401fe[_0x1e356f(0xc3)],common_1[_0x1e356f(0x10a)]['BAD_REQUEST']);}}async['handleUpdateGroup'](_0xe15212){const _0x334dec=_0x1d464b;try{const _0x5b9f95=await this[_0x334dec(0x10d)][_0x334dec(0x99)]({'where':{'id':_0xe15212['id']}});if(!_0x5b9f95)throw new common_1['HttpException'](_0x334dec(0xa3),common_1[_0x334dec(0x10a)][_0x334dec(0x97)]);return await this[_0x334dec(0x10d)][_0x334dec(0x7f)]({'id':_0xe15212['id']},_0xe15212),!![];}catch(_0x2c858b){throw new common_1['HttpException'](_0x2c858b['message'],common_1[_0x334dec(0x10a)]['BAD_REQUEST']);}}async[_0x1d464b(0x113)](_0x1f46d5){const _0x4f7903=_0x1d464b;try{const _0x505c6c=_0x1f46d5['id'],_0x3f5079=await this[_0x4f7903(0x10d)][_0x4f7903(0x99)]({'where':{'id':_0x505c6c}});if(!_0x3f5079)throw new common_1[(_0x4f7903(0xaf))](_0x4f7903(0xdb),common_1[_0x4f7903(0x10a)][_0x4f7903(0x97)]);const _0x46d703=await this[_0x4f7903(0xbd)]['count']({'where':{'groupId':_0x3f5079['id']}});if(_0x46d703>0x0)throw new common_1[(_0x4f7903(0xaf))](_0x4f7903(0xf9),common_1['HttpStatus']['BAD_REQUEST']);else await this[_0x4f7903(0x10d)][_0x4f7903(0x87)]({'id':_0x505c6c});}catch(_0x307855){throw new common_1[(_0x4f7903(0xaf))](_0x307855[_0x4f7903(0xc3)],common_1[_0x4f7903(0x10a)][_0x4f7903(0x97)]);}}async[_0x1d464b(0xb7)](_0x4c2653,_0x22f299){const _0xa78be=_0x1d464b;try{const _0x5dbc4f=(0x0,utils_1[_0xa78be(0xa9)])(this[_0xa78be(0xb8)]),{page:page=0x1,size:size=0x14,status:_0x5ee9fd,saasId:_0x4665db,groupName:_0x450123}=_0x4c2653,_0x5f1255={};return _0x450123&&(_0x5f1255['groupName']=_0x450123),_0x5ee9fd>=0x0&&(_0x5f1255[_0xa78be(0x9c)]=_0x5ee9fd),(0x0,utils_1['isPlatform'])(this[_0xa78be(0xb8)])?(0x0,utils_1['isDefined'])(_0x4665db)&&(_0x5f1255[_0xa78be(0xe5)]=_0x4665db):_0x5f1255[_0xa78be(0xe5)]=_0x5dbc4f,await this['gptsGroupEntity'][_0xa78be(0x96)]({'where':_0x5f1255,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0xa78be(0xf4),'id':_0xa78be(0xf4)}})[_0xa78be(0xb2)](([_0x29380b,_0x122b12])=>({'rows':_0x29380b,'count':_0x122b12}))[_0xa78be(0xfc)](_0x5a55fe=>{throw new Error(_0x5a55fe);});}catch(_0x2a2360){console[_0xa78be(0xde)](_0xa78be(0x95),_0x2a2360);throw new common_1[(_0xa78be(0xaf))](_0x2a2360,common_1[_0xa78be(0x10a)][_0xa78be(0x97)]);}}async[_0x1d464b(0x8d)](_0x4cc4e7,_0xbd8587){const _0x774f0d=_0x1d464b;try{const {groupId:_0x374c66}=_0x4cc4e7;return await this[_0x774f0d(0x10d)]['findOne']({'where':{'id':Number(_0x374c66)}})[_0x774f0d(0xb2)](_0x259889=>{return _0x259889;})[_0x774f0d(0xfc)](_0x1b137e=>{throw new Error(_0x1b137e);});}catch(_0x185e20){console[_0x774f0d(0xde)]('error:\x20',_0x185e20);throw new common_1[(_0x774f0d(0xaf))](_0x185e20,common_1[_0x774f0d(0x10a)]['BAD_REQUEST']);}}async['handleAddGpts'](_0x5ad38d,_0x18376d){const _0x3f1703=_0x1d464b;try{const _0xf60bd0=_0x5ad38d[_0x3f1703(0x9b)]['id'],_0x45f851=(0x0,utils_1[_0x3f1703(0xa9)])(this[_0x3f1703(0xb8)]),_0x3e92dd=Object['assign'](new gpts_model_entity_1[(_0x3f1703(0xc7))](),_0x18376d);_0x3e92dd[_0x3f1703(0x9c)]=Number(_0x18376d[_0x3f1703(0x9c)]);if(_0x3e92dd['id']){const _0x15cbb0=await this[_0x3f1703(0xbd)][_0x3f1703(0x99)]({'where':{'id':_0x3e92dd['id']}});if(!_0x15cbb0)throw new common_1[(_0x3f1703(0xaf))]('模型不存在！',common_1[_0x3f1703(0x10a)][_0x3f1703(0x97)]);if(_0x15cbb0['gptsApp']!==_0x3e92dd[_0x3f1703(0x110)])throw new common_1[(_0x3f1703(0xaf))](_0x3f1703(0xa5),common_1[_0x3f1703(0x10a)][_0x3f1703(0x97)]);return await this[_0x3f1703(0xbd)][_0x3f1703(0x7f)]({'id':_0x3e92dd['id']},{..._0x3e92dd,'useCount':_0x3e92dd[_0x3f1703(0xd2)]??_0x15cbb0['useCount'],'collectCount':_0x3e92dd[_0x3f1703(0xe4)]??_0x15cbb0[_0x3f1703(0xe4)]})[_0x3f1703(0xb2)](_0x1c6fda=>_0x1c6fda['affected']>0x0)['catch'](_0x303d38=>{throw new Error(_0x303d38);});}else{const _0xd18fa6=await this[_0x3f1703(0x10d)]['findOne']({'where':{'id':_0x3e92dd['groupId']}});if(!_0xd18fa6)throw new common_1[(_0x3f1703(0xaf))](_0x3f1703(0xeb),common_1['HttpStatus'][_0x3f1703(0x97)]);const _0x26531e=await this[_0x3f1703(0xbd)]['save']({..._0x3e92dd,'saasId':_0x45f851,'userId':_0x5ad38d[_0x3f1703(0xe7)][_0x3f1703(0xaa)]?_0xf60bd0:null});return _0x26531e['id'];}}catch(_0x1e28ad){throw new common_1['HttpException'](_0x1e28ad,common_1['HttpStatus'][_0x3f1703(0x97)]);}}async[_0x1d464b(0xca)](){const _0x3da053=_0x1d464b;return await this['gptsModelEntity']['find']()['then'](_0x1d9681=>_0x1d9681['map'](_0x51d0f2=>_0x51d0f2[_0x3da053(0xc0)]));}async['handleAddGptsBatch'](_0x57c194){const _0xbd90c=_0x1d464b;try{const _0x5cd913=(0x0,utils_1[_0xbd90c(0xa9)])(this[_0xbd90c(0xb8)]),_0x1d06d0=await this[_0xbd90c(0xca)](),_0x2b0f2f=_0x57c194[_0xbd90c(0x106)](_0x53dc13=>!_0x1d06d0[_0xbd90c(0xdc)](_0x53dc13[_0xbd90c(0xc0)]))[_0xbd90c(0x85)](_0x5bd8d8=>({'groupId':_0x5bd8d8['groupId'],'relModel':_0x5bd8d8[_0xbd90c(0x10c)],'logo':_0x5bd8d8[_0xbd90c(0xe6)],'desc':_0x5bd8d8[_0xbd90c(0x8c)],'modelName':_0x5bd8d8[_0xbd90c(0xc0)],'modelId':_0x5bd8d8[_0xbd90c(0x84)],'saasId':_0x5cd913}));return await this[_0xbd90c(0xbd)]['save'](_0x2b0f2f)[_0xbd90c(0xfc)](_0xbae4e6=>{throw new Error(_0xbae4e6);});}catch(_0x67067e){console[_0xbd90c(0xde)](_0xbd90c(0x95),_0x67067e);throw new common_1[(_0xbd90c(0xaf))](_0x67067e,common_1[_0xbd90c(0x10a)][_0xbd90c(0x97)]);}}async[_0x1d464b(0xb5)](_0x208aae,_0xb3c4ed){const _0x5d98dd=_0x1d464b;try{const _0x1bd5aa=(0x0,utils_1[_0x5d98dd(0xdf)])(this[_0x5d98dd(0xb8)]),_0x1a9ff9=(0x0,utils_1['getReqSaasId'])(this[_0x5d98dd(0xb8)]),_0x3ae993=new Set(),_0x4658d7=new Map(),{modelId:_0xccf348,modelName:_0x1da960,groupId:_0x1547fc,back:_0x445036,status:_0x4ec20a,page:page=0x1,size:size=0x14,saasId:_0x59b138}=_0x208aae,_0x153c19={'delFlag':![]};_0x1bd5aa?_0x153c19['userId']=(0x0,typeorm_2['Or'])((0x0,typeorm_2['Equal'])(_0x1bd5aa),(0x0,typeorm_2[_0x5d98dd(0x89)])()):_0x153c19['userId']=(0x0,typeorm_2[_0x5d98dd(0x89)])();(0x0,utils_1['isPlatform'])(this[_0x5d98dd(0xb8)])?(0x0,utils_1['isDefined'])(_0x59b138)&&(_0x153c19[_0x5d98dd(0xe5)]=_0x59b138):_0x153c19['saasId']=_0x1a9ff9;!_0x445036?_0x153c19['status']=0x1:(_0x4ec20a!==undefined&&_0x4ec20a!==null&&(_0x153c19['status']=_0x4ec20a),delete _0x153c19[_0x5d98dd(0xf6)]);_0xccf348&&(_0x153c19['modelId']=_0xccf348),_0x1547fc&&(_0x153c19[_0x5d98dd(0xda)]=_0x1547fc),_0x1da960&&(_0x153c19['modelName']=(0x0,typeorm_2[_0x5d98dd(0xe1)])('%'+_0x1da960+'%'));const [_0x71f5cb,_0x2077e9]=await this[_0x5d98dd(0xbd)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x153c19,'order':{'sortId':_0x5d98dd(0xf4)}});if(_0x71f5cb[_0x5d98dd(0xa6)]){const _0x172301=[],_0x42abbc=[];_0x71f5cb['forEach'](_0x14953f=>{const _0x1921a4=_0x5d98dd;_0x172301['push'](_0x14953f['id']),_0x42abbc[_0x1921a4(0x8b)](_0x14953f[_0x1921a4(0xda)]);});if(_0x1bd5aa){const _0x2f51c8=await this[_0x5d98dd(0x108)][_0x5d98dd(0x78)]({'where':{'userId':_0x1bd5aa,'appId':(0x0,typeorm_2['In'])(_0x172301)}});_0x2f51c8[_0x5d98dd(0x10b)](_0x44b760=>_0x3ae993[_0x5d98dd(0x114)](_0x44b760[_0x5d98dd(0xf0)]));}const _0x3f7c5b=await this[_0x5d98dd(0x10d)][_0x5d98dd(0x78)]({'where':{'id':(0x0,typeorm_2['In'])(_0x42abbc)}});_0x3f7c5b['forEach'](_0x275b89=>_0x4658d7['set'](_0x275b89['id'],_0x275b89));}return{'count':_0x2077e9,'rows':_0x71f5cb[_0x5d98dd(0x85)](_0x4ff7ed=>({..._0x4ff7ed,'collected':_0x3ae993['has'](_0x4ff7ed['id']),'groupName':_0x4658d7[_0x5d98dd(0xb1)](_0x4ff7ed['groupId'])?.['groupName'],'isVipUsed':_0x4ff7ed['userType']?!![]:![]}))};}catch(_0x1791ee){console[_0x5d98dd(0xde)](_0x5d98dd(0x95),_0x1791ee);throw new common_1[(_0x5d98dd(0xaf))](_0x1791ee,common_1['HttpStatus'][_0x5d98dd(0x97)]);}}async['listByFrontType'](_0x5c0f0d,_0x3d695b){const _0x18d922=_0x1d464b,_0x59233d=(0x0,utils_1[_0x18d922(0xdf)])(this[_0x18d922(0xb8)]),_0x1de67a=(0x0,utils_1[_0x18d922(0xa9)])(this[_0x18d922(0xb8)]),_0x231e62={'take':0x1e};if(_0x3d695b==_0x18d922(0xc9))_0x231e62[_0x18d922(0x10f)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x231e62[_0x18d922(0x104)]={'createdAt':_0x18d922(0xf4)};else{if(_0x3d695b===_0x18d922(0xb0))_0x231e62[_0x18d922(0x10f)]={'status':0x1,'delFlag':![]},_0x231e62[_0x18d922(0x104)]={'useCount':_0x18d922(0xf4)};else{if(_0x3d695b===_0x18d922(0xf5))_0x231e62[_0x18d922(0x10f)]={'status':0x1,'delFlag':![]},_0x231e62[_0x18d922(0x104)]={'collectCount':_0x18d922(0xf4)};else{if(_0x3d695b===_0x18d922(0xe9)){if(!_0x59233d)throw new common_1['HttpException'](_0x18d922(0x75),common_1[_0x18d922(0x10a)][_0x18d922(0xa4)]);_0x231e62[_0x18d922(0x10f)]={'status':0x1,'delFlag':![],'userId':_0x59233d},_0x231e62[_0x18d922(0x104)]={'createdAt':'DESC'};}else _0x231e62['where']={'status':0x1,'delFlag':![]},_0x231e62['order']={'createdAt':_0x18d922(0xf4)};}}}_0x231e62['where']['saasId']=_0x1de67a;const _0x3aba7a=await this['gptsModelEntity'][_0x18d922(0x78)](_0x231e62),_0x429f8b=new Set(),_0x58095f=new Map(),_0x1a010e=new Map(),_0x236b07=[],_0x4e14da=[];_0x3aba7a[_0x18d922(0x10b)](_0x49c068=>{const _0x4b5392=_0x18d922;_0x236b07['push'](_0x49c068['id']),_0x4e14da[_0x4b5392(0x8b)](_0x49c068[_0x4b5392(0xda)]);});if(_0x236b07[_0x18d922(0xa6)]){if(_0x59233d){const _0x2b10fa=await this[_0x18d922(0x108)]['find']({'where':{'userId':_0x59233d,'appId':(0x0,typeorm_2['In'])(_0x236b07)}});_0x2b10fa['forEach'](_0x1eeb23=>_0x429f8b[_0x18d922(0x114)](_0x1eeb23[_0x18d922(0xf0)]));const _0xb390a5=await this['chatLogService'][_0x18d922(0x86)](_0x59233d,_0x236b07);_0xb390a5['forEach'](_0xfa0ee6=>_0x58095f['set'](_0xfa0ee6['appId'],_0xfa0ee6[_0x18d922(0xd5)]));}const _0x5460c9=await this[_0x18d922(0x10d)][_0x18d922(0x78)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4e14da)}});_0x5460c9[_0x18d922(0x10b)](_0x2e6abe=>_0x1a010e[_0x18d922(0x107)](_0x2e6abe['id'],_0x2e6abe));}return _0x3aba7a[_0x18d922(0x85)](_0x216f0e=>({..._0x216f0e,'isVipUsed':_0x216f0e[_0x18d922(0xcf)]?!![]:![],'collected':_0x429f8b[_0x18d922(0xe3)](_0x216f0e['id']),'lastTime':_0x58095f[_0x18d922(0xb1)](_0x216f0e['id'])||null,'groupName':_0x1a010e[_0x18d922(0xb1)](_0x216f0e[_0x18d922(0xda)])?.[_0x18d922(0x90)]}));}async[_0x1d464b(0x88)](_0x1a4066){const _0x4902d7=_0x1d464b;try{const {id:_0x27cb7b}=_0x1a4066,_0x139131=await this[_0x4902d7(0xbd)][_0x4902d7(0x99)]({'where':{'id':_0x27cb7b}});if(!_0x139131)throw new common_1[(_0x4902d7(0xaf))]('gpts不存在,无法删除！',common_1['HttpStatus']['BAD_REQUEST']);return await this[_0x4902d7(0xbd)]['delete'](_0x27cb7b)[_0x4902d7(0xb2)](_0x3bc1c0=>_0x3bc1c0['affected']>0x0)[_0x4902d7(0xfc)](_0x3306e4=>{throw new Error(_0x3306e4);});}catch(_0x484479){console[_0x4902d7(0xde)](_0x4902d7(0x95),_0x484479);throw new common_1[(_0x4902d7(0xaf))](_0x484479,common_1['HttpStatus'][_0x4902d7(0x97)]);}}async[_0x1d464b(0x9a)](_0x5a431c,_0x236f5a){const _0x4d1d6b=_0x1d464b,_0x313d96=_0x5a431c['appId'],_0x5701df=_0x236f5a[_0x4d1d6b(0x9b)]['id'],_0x6971c6=(0x0,utils_1['getReqSaasId'])(this['clsService']);let _0x54e6b8=null,_0x1c4f03={'title':_0x4d1d6b(0xea),'userId':_0x5701df,'saasId':_0x6971c6};try{_0x54e6b8=await this[_0x4d1d6b(0xbd)][_0x4d1d6b(0x99)]({'where':{'id':_0x313d96}});if(!_0x54e6b8)throw new Error(_0x4d1d6b(0xfb));if(_0x54e6b8[_0x4d1d6b(0x9c)]!==0x1)throw new Error(_0x4d1d6b(0xae));if(!_0x5a431c[_0x4d1d6b(0xfa)]){const _0x1cc9ca=await this[_0x4d1d6b(0x116)][_0x4d1d6b(0xac)]({'where':{'modelId':_0x313d96,'userId':_0x5701df,'isDelete':![]}});if(_0x1cc9ca>0x0)throw new Error(_0x4d1d6b(0xf3));}_0x1c4f03[_0x4d1d6b(0x84)]=_0x54e6b8['id'],_0x1c4f03[_0x4d1d6b(0xe8)]=_0x54e6b8[_0x4d1d6b(0x84)],_0x1c4f03[_0x4d1d6b(0xda)]=_0x54e6b8['groupId'],_0x1c4f03['desc']=_0x54e6b8['desc']||'',_0x1c4f03['logo']=_0x54e6b8[_0x4d1d6b(0xe6)]||'',_0x1c4f03[_0x4d1d6b(0x98)]=_0x5a431c['hasHistory']?_0x4d1d6b(0xea):_0x54e6b8[_0x4d1d6b(0xc0)],_0x1c4f03[_0x4d1d6b(0x10e)]=_0x54e6b8['demoData']||'';let _0x52404f=await this[_0x4d1d6b(0xd1)][_0x4d1d6b(0xbe)](model_constant_1[_0x4d1d6b(0xed)][_0x4d1d6b(0x82)]);_0x52404f[_0x4d1d6b(0x80)][_0x4d1d6b(0xa0)]=_0x54e6b8['canAudio'],_0x52404f['modelInfo']['modelName']=_0x54e6b8['modelName'],_0x52404f['modelInfo']['canUpload']=_0x54e6b8[_0x4d1d6b(0x101)];_0x54e6b8[_0x4d1d6b(0x110)]?_0x52404f['modelInfo'][_0x4d1d6b(0xe8)]=_0x54e6b8['modelId']:_0x52404f[_0x4d1d6b(0x80)][_0x4d1d6b(0xe8)]=_0x54e6b8[_0x4d1d6b(0x10c)];_0x1c4f03[_0x4d1d6b(0x7b)]=JSON[_0x4d1d6b(0xd0)](_0x52404f);const _0x420956=await this['gptsChatEntity'][_0x4d1d6b(0xc1)](_0x1c4f03);return _0x54e6b8&&(_0x54e6b8['useCount']=_0x54e6b8[_0x4d1d6b(0xd2)]+Math['ceil'](Math[_0x4d1d6b(0xad)]()*0xa),await this[_0x4d1d6b(0xbd)]['save'](_0x54e6b8)),_0x420956;}catch(_0x49f145){throw new common_1[(_0x4d1d6b(0xaf))](_0x49f145[_0x4d1d6b(0xc3)],common_1[_0x4d1d6b(0x10a)][_0x4d1d6b(0x97)]);}}async[_0x1d464b(0x119)](_0x442b8e,_0x1b44fb,_0x13d91f){const _0x53da32=_0x1d464b,_0x18eb6f=await this[_0x53da32(0x92)][_0x53da32(0x94)](model_constant_1[_0x53da32(0xed)]['CHAT'],_0x442b8e,_0x1b44fb,_0x13d91f),_0x2731ec=await this['handleGetChat'](_0x13d91f),_0x463f34=[];for(const _0x6ebf94 of _0x18eb6f){_0x463f34['push']({'id':_0x6ebf94['id'],'config':_0x6ebf94[_0x53da32(0x7b)],'createdAt':_0x6ebf94[_0x53da32(0xd5)],'lastMessage':_0x6ebf94[_0x53da32(0x83)],'modelType':'chat','title':_0x6ebf94[_0x53da32(0x98)],'updatedAt':_0x6ebf94[_0x53da32(0x9f)],'isSticky':_0x6ebf94[_0x53da32(0xe2)],'appId':_0x6ebf94[_0x53da32(0xf0)],'logo':'','desc':''});}for(const _0x53f933 of _0x2731ec){_0x463f34[_0x53da32(0x8b)]({'id':_0x53f933['id'],'config':_0x53f933['config'],'createdAt':_0x53f933[_0x53da32(0xd5)],'logo':_0x53f933[_0x53da32(0xe6)],'lastMessage':_0x53f933[_0x53da32(0x83)],'desc':_0x53f933['desc'],'modelId':_0x53f933[_0x53da32(0x84)],'modelType':_0x53da32(0xdd),'title':_0x53f933[_0x53da32(0xc0)],'updatedAt':_0x53f933[_0x53da32(0x9f)],'isSticky':_0x53f933['isSticky']});}return _0x463f34[_0x53da32(0x103)]((_0x26fd45,_0x4ed9ff)=>{const _0x3c784c=_0x53da32;if(_0x26fd45[_0x3c784c(0xe2)]!==_0x4ed9ff[_0x3c784c(0xe2)])return _0x4ed9ff[_0x3c784c(0xe2)]-_0x26fd45['isSticky'];return _0x4ed9ff[_0x3c784c(0x9f)]-_0x26fd45['updatedAt'];}),_0x463f34;}async[_0x1d464b(0xbc)](_0x2ef766,_0x491d6d){const _0x4270cd=_0x1d464b;try{const _0xac3479=_0x2ef766['user']['id'],_0x55faf7={'userId':_0xac3479,'isDelete':![]};_0x491d6d&&(_0x55faf7[_0x4270cd(0x84)]=_0x491d6d);let _0x4d44f4=[];_0x491d6d?_0x4d44f4=await this[_0x4270cd(0x116)]['find']({'where':_0x55faf7,'order':{'isSticky':_0x4270cd(0xf4),'updatedAt':_0x4270cd(0xf4)}}):_0x4d44f4=await this[_0x4270cd(0x116)][_0x4270cd(0x8e)]()[_0x4270cd(0x10f)](_0x55faf7)[_0x4270cd(0xa7)](_0x4270cd(0x84))[_0x4270cd(0xd3)]({'isSticky':_0x4270cd(0xf4),'updatedAt':_0x4270cd(0xf4)})[_0x4270cd(0xe0)]();const _0x1c15af=new Set(),_0x1d78f5=new Map(),_0x4e2ab0=new Map(),_0x5ce862=[],_0x4f09c8=[];_0x4d44f4['forEach'](_0xc4ab2a=>{const _0x537e1f=_0x4270cd;_0x5ce862[_0x537e1f(0x8b)](_0xc4ab2a[_0x537e1f(0x84)]),_0x4f09c8['push'](_0xc4ab2a[_0x537e1f(0xda)]);});if(_0x5ce862['length']){const _0x355ee6=await this[_0x4270cd(0x108)][_0x4270cd(0x78)]({'where':{'userId':_0xac3479,'appId':(0x0,typeorm_2['In'])(_0x5ce862)}});_0x355ee6['forEach'](_0xe7601=>_0x1c15af[_0x4270cd(0x114)](_0xe7601[_0x4270cd(0xf0)]));const _0x5dfb68=await this[_0x4270cd(0xbd)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5ce862),'status':0x1,'delFlag':![]}});_0x5dfb68[_0x4270cd(0x10b)](_0x4bcaeb=>_0x1d78f5['set'](_0x4bcaeb['id'],_0x4bcaeb));const _0x2cec9f=await this[_0x4270cd(0x10d)][_0x4270cd(0x78)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4f09c8)}});_0x2cec9f[_0x4270cd(0x10b)](_0x42dddf=>_0x4e2ab0[_0x4270cd(0x107)](_0x42dddf['id'],_0x42dddf));}return _0x4d44f4[_0x4270cd(0x85)](_0x4b4f69=>{const _0x54278=_0x4270cd,_0x2d6a19=_0x1d78f5[_0x54278(0xb1)](_0x4b4f69['modelId']);if(_0x2d6a19?.[_0x54278(0x110)]){const _0x5ab65c=JSON[_0x54278(0xcd)](_0x4b4f69[_0x54278(0x7b)]);_0x5ab65c[_0x54278(0x80)]['model']=_0x2d6a19[_0x54278(0x84)],_0x4b4f69['config']=JSON[_0x54278(0xd0)](_0x5ab65c);}return{..._0x4b4f69,'modelName':_0x2d6a19?.['modelName']||_0x4b4f69[_0x54278(0x98)],'gptsApp':_0x2d6a19?.['gptsApp'],'customParams':_0x2d6a19?.[_0x54278(0xa1)],'customConfig':_0x2d6a19?.[_0x54278(0x7b)],'collected':_0x1c15af['has'](_0x4b4f69[_0x54278(0x84)]),'groupName':_0x4e2ab0['get'](_0x4b4f69['groupId'])?.[_0x54278(0x90)],'isVipUsed':_0x2d6a19?.[_0x54278(0xcf)]?!![]:![],'userType':_0x2d6a19?.[_0x54278(0xcf)]};});}catch(_0x420af2){console[_0x4270cd(0xde)](_0x4270cd(0x95),_0x420af2);throw new common_1[(_0x4270cd(0xaf))](_0x420af2,common_1[_0x4270cd(0x10a)][_0x4270cd(0x97)]);}}async[_0x1d464b(0xf7)](_0x70926a,_0x23af39){const _0x422506=_0x1d464b,{title:_0x1d5d64,isSticky:_0x2b5e87,groupId:_0x1170c7,config:_0x5dee34}=_0x70926a,{id:_0x5051f7}=_0x23af39[_0x422506(0x9b)],_0x834c21=await this[_0x422506(0x116)][_0x422506(0x99)]({'where':{'id':_0x1170c7,'userId':_0x5051f7}});if(!_0x834c21)throw new common_1[(_0x422506(0xaf))]('GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1['HttpStatus']['BAD_REQUEST']);const _0x1c0a60={};_0x1c0a60[_0x422506(0x98)]=_0x1d5d64||_0x834c21[_0x422506(0x98)],_0x1c0a60[_0x422506(0x7b)]=_0x5dee34||_0x834c21[_0x422506(0x7b)],_0x1c0a60[_0x422506(0xe2)]=_0x2b5e87??_0x834c21['isSticky'];const _0x3c0b0b=await this[_0x422506(0x116)][_0x422506(0x7f)]({'id':_0x1170c7},_0x1c0a60);if(_0x3c0b0b['affected'])return!![];else throw new common_1[(_0x422506(0xaf))](_0x422506(0x7a),common_1['HttpStatus'][_0x422506(0x97)]);}async['delGptsChat'](_0x45a9b4,_0x1598d2){const _0x57e186=_0x1d464b;try{const {groupId:_0x43a431}=_0x45a9b4,{id:_0x3689c2}=_0x1598d2[_0x57e186(0x9b)],_0xa6980=await this['gptsChatEntity'][_0x57e186(0x99)]({'where':{'id':_0x43a431,'userId':_0x3689c2}})['catch'](_0x22c43b=>{const _0x4e35b2=_0x57e186;common_1[_0x4e35b2(0xf1)][_0x4e35b2(0xc6)](_0x22c43b);throw new Error(_0x22c43b);});if(!_0xa6980)throw new Error(_0x57e186(0x100));await this['chatLogService'][_0x57e186(0xf8)]({'userId':_0x3689c2,'ids':[_0x43a431]})[_0x57e186(0xfc)](_0x123a5a=>{throw new Error(_0x123a5a);});const _0x3cd527=await this[_0x57e186(0x116)]['delete']({'id':_0x43a431})['catch'](_0x1035fb=>{throw new Error(_0x1035fb);});if(!_0x3cd527)throw new Error(_0x57e186(0xcb));return!![];}catch(_0x56ddcc){throw new common_1['HttpException'](_0x56ddcc,common_1['HttpStatus'][_0x57e186(0x97)]);}}async['delAllGptsChat'](_0x53ab13){const _0x272383=_0x1d464b;try{const {id:_0x1f23fa}=_0x53ab13[_0x272383(0x9b)],_0x259421=await this[_0x272383(0x116)]['find']({'where':{'userId':_0x1f23fa}})[_0x272383(0xfc)](_0x582545=>{const _0x30767f=_0x272383;common_1['Logger'][_0x30767f(0xc6)](_0x582545);throw new Error(_0x582545);});if(!_0x259421||_0x259421[_0x272383(0xa6)]===0x0)throw new Error(_0x272383(0x76));const _0x1f1ee4=_0x259421['map'](_0x2a2f80=>_0x2a2f80[_0x272383(0xda)]);await this[_0x272383(0x77)][_0x272383(0xf8)]({'ids':_0x1f1ee4,'userId':_0x1f23fa})[_0x272383(0xfc)](_0x514443=>{throw new Error(_0x514443);});const _0x54bfe1=await this[_0x272383(0x116)][_0x272383(0x87)]({'userId':_0x1f23fa,'isSticky':![]})[_0x272383(0xfc)](_0x1857fc=>{throw new Error(_0x1857fc);});if(!_0x54bfe1)throw new Error('清空失败！');return!![];}catch(_0x1b14b9){throw new common_1[(_0x272383(0xaf))](_0x1b14b9,common_1[_0x272383(0x10a)][_0x272383(0x97)]);}}async[_0x1d464b(0xbf)](_0x357758){const _0x257c65=_0x1d464b;return await this[_0x257c65(0x116)][_0x257c65(0x99)]({'where':{'id':_0x357758}});}async['getCurrentModelByChatGroupId'](_0x261a53){const _0x2086ba=_0x1d464b,_0x90b70=await this[_0x2086ba(0x116)][_0x2086ba(0x99)]({'where':{'id':_0x261a53}}),_0x3bf04b=await this['gptsModelEntity'][_0x2086ba(0x99)]({'where':{'id':_0x90b70[_0x2086ba(0x84)]}}),_0x52431=await this[_0x2086ba(0xd1)]['getRandomKey'](model_constant_1[_0x2086ba(0xed)][_0x2086ba(0x82)]);return _0x52431[_0x2086ba(0xc0)]=_0x3bf04b[_0x2086ba(0xc0)],_0x52431['model']=_0x3bf04b[_0x2086ba(0x84)]||_0x3bf04b['relModel'],_0x3bf04b[_0x2086ba(0xef)]!==undefined&&(_0x52431[_0x2086ba(0xef)]=_0x3bf04b[_0x2086ba(0xef)]),_0x3bf04b['vipFreeNum']!==undefined&&(_0x52431[_0x2086ba(0xd9)]=_0x3bf04b[_0x2086ba(0xd9)]),_0x52431;}async[_0x1d464b(0xa8)](_0x8058b,_0x1fa43a){const _0x45db45=_0x1d464b;await this[_0x45db45(0x10d)][_0x45db45(0x8e)]()['update'](gpts_group_entity_1[_0x45db45(0xb3)])[_0x45db45(0x107)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x45db45(0x112)+_0x1fa43a})['where'](_0x45db45(0x111),{'id':_0x8058b})['execute']();}async[_0x1d464b(0xba)](_0x45f909,_0x233c66){const _0x121768=_0x1d464b,_0x3328b5={'id':_0x45f909};return _0x233c66!=null&&_0x233c66!==undefined&&(_0x3328b5['status']=_0x233c66),this['gptsModelEntity'][_0x121768(0x99)]({'where':_0x3328b5});}async[_0x1d464b(0x7d)](_0x4229ca,_0x43b9cb,_0x17e9f7){const _0x41765b=_0x1d464b,_0x5a3397={'id':_0x43b9cb};_0x17e9f7!=null&&_0x17e9f7!==undefined&&(_0x5a3397['status']=_0x17e9f7);const _0x10988f=await this[_0x41765b(0xbd)][_0x41765b(0x99)]({'where':_0x5a3397});if(_0x4229ca[_0x41765b(0x9b)]){const _0x478844=await this[_0x41765b(0x108)][_0x41765b(0x99)]({'where':{'userId':_0x4229ca['user']['id'],'appId':_0x43b9cb}});if(_0x478844)return{..._0x10988f,'collected':!![]};}return{..._0x10988f,'collected':![]};}async[_0x1d464b(0x105)](_0x579d53){const _0x3bbff4=_0x1d464b;if(!_0x579d53)throw new common_1[(_0x3bbff4(0xaf))]('缺失必要参数！',common_1[_0x3bbff4(0x10a)][_0x3bbff4(0x97)]);return await this[_0x3bbff4(0xbd)][_0x3bbff4(0x99)]({'where':{'id':_0x579d53}});}};GptsService=__decorate([(0x0,common_1[_0x1d464b(0xd8)])(),__param(0x0,(0x0,typeorm_1[_0x1d464b(0x81)])(userApps_entity_1[_0x1d464b(0x117)])),__param(0x1,(0x0,typeorm_1[_0x1d464b(0x81)])(gpts_group_entity_1[_0x1d464b(0xb3)])),__param(0x2,(0x0,typeorm_1[_0x1d464b(0x81)])(gpts_model_entity_1[_0x1d464b(0xc7)])),__param(0x3,(0x0,typeorm_1[_0x1d464b(0x81)])(gpts_chat_entity_1[_0x1d464b(0x7c)])),__metadata(_0x1d464b(0x109),[typeorm_2[_0x1d464b(0xbb)],typeorm_2[_0x1d464b(0xbb)],typeorm_2[_0x1d464b(0xbb)],typeorm_2['Repository'],nestjs_cls_1['ClsService'],models_service_1[_0x1d464b(0xf2)],chatLog_service_1[_0x1d464b(0x9e)],chatGroup_service_1['ChatGroupService']])],GptsService),exports[_0x1d464b(0x9d)]=GptsService;