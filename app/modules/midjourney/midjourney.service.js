'use strict';const _0x45cc23=_0x227e;(function(_0x5cf82e,_0x388e06){const _0x41551d=_0x227e,_0x4f4d0c=_0x5cf82e();while(!![]){try{const _0x39c41c=-parseInt(_0x41551d(0x27c))/0x1*(-parseInt(_0x41551d(0x19a))/0x2)+-parseInt(_0x41551d(0x1bf))/0x3*(-parseInt(_0x41551d(0x1ec))/0x4)+-parseInt(_0x41551d(0x22b))/0x5+-parseInt(_0x41551d(0x277))/0x6*(-parseInt(_0x41551d(0x2ce))/0x7)+parseInt(_0x41551d(0x293))/0x8*(-parseInt(_0x41551d(0x21c))/0x9)+-parseInt(_0x41551d(0x1f3))/0xa*(parseInt(_0x41551d(0x2bc))/0xb)+parseInt(_0x41551d(0x234))/0xc;if(_0x39c41c===_0x388e06)break;else _0x4f4d0c['push'](_0x4f4d0c['shift']());}catch(_0x31b639){_0x4f4d0c['push'](_0x4f4d0c['shift']());}}}(_0x6b80,0xc40e8));var __decorate=this&&this[_0x45cc23(0x17f)]||function(_0x535ce7,_0x456ff8,_0x280757,_0x5d691a){const _0x309162=_0x45cc23;var _0x451cc7=arguments[_0x309162(0x1cd)],_0x19abc9=_0x451cc7<0x3?_0x456ff8:_0x5d691a===null?_0x5d691a=Object[_0x309162(0x265)](_0x456ff8,_0x280757):_0x5d691a,_0x360002;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x19abc9=Reflect[_0x309162(0x205)](_0x535ce7,_0x456ff8,_0x280757,_0x5d691a);else{for(var _0x52eef7=_0x535ce7[_0x309162(0x1cd)]-0x1;_0x52eef7>=0x0;_0x52eef7--)if(_0x360002=_0x535ce7[_0x52eef7])_0x19abc9=(_0x451cc7<0x3?_0x360002(_0x19abc9):_0x451cc7>0x3?_0x360002(_0x456ff8,_0x280757,_0x19abc9):_0x360002(_0x456ff8,_0x280757))||_0x19abc9;}return _0x451cc7>0x3&&_0x19abc9&&Object[_0x309162(0x166)](_0x456ff8,_0x280757,_0x19abc9),_0x19abc9;},__metadata=this&&this['__metadata']||function(_0x5e537e,_0x14b136){const _0x2803ce=_0x45cc23;if(typeof Reflect===_0x2803ce(0x2b1)&&typeof Reflect[_0x2803ce(0x1af)]===_0x2803ce(0x2ad))return Reflect[_0x2803ce(0x1af)](_0x5e537e,_0x14b136);},__param=this&&this['__param']||function(_0x3f7226,_0x20a0e7){return function(_0x48025d,_0x4ba5c3){_0x20a0e7(_0x48025d,_0x4ba5c3,_0x3f7226);};};function _0x227e(_0x263bc4,_0x3ccf5f){const _0x6b8015=_0x6b80();return _0x227e=function(_0x227e67,_0x3a292c){_0x227e67=_0x227e67-0x150;let _0x1bbfb0=_0x6b8015[_0x227e67];return _0x1bbfb0;},_0x227e(_0x263bc4,_0x3ccf5f);}Object[_0x45cc23(0x166)](exports,_0x45cc23(0x244),{'value':!![]}),exports['MidjourneyService']=void 0x0;const user_entity_1=require(_0x45cc23(0x1f9)),common_1=require(_0x45cc23(0x212)),typeorm_1=require(_0x45cc23(0x231)),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require('typeorm'),axios_1=require(_0x45cc23(0x2d0)),globalConfig_service_1=require(_0x45cc23(0x198)),midjourney_constant_1=require(_0x45cc23(0x20e)),file_service_1=require(_0x45cc23(0x18d)),badwords_service_1=require(_0x45cc23(0x1a8)),utils_1=require('../../common/utils'),mjPrompts_entity_1=require('./mjPrompts.entity'),mjParam_entity_1=require(_0x45cc23(0x1d8)),mjIncantationClassify_entity_1=require(_0x45cc23(0x2e3)),mjInspireClassify_entity_1=require(_0x45cc23(0x1e6)),mjIncantation_entity_1=require(_0x45cc23(0x167)),createRandomId_1=require('../../common/utils/createRandomId'),fanyi_service_1=require(_0x45cc23(0x1c2)),mjSuggestWord_entity_1=require(_0x45cc23(0x201)),user_service_1=require('../user/user.service'),redisCache_service_1=require('../redisCache/redisCache.service'),mjpAccount_service_1=require('../api/mjpAccount.service'),mjpTask_service_1=require('../api/mjpTask.service'),addDrawQueue_dto_1=require(_0x45cc23(0x2a6)),MjConfig_1=require(_0x45cc23(0x286)),redisKey_constant_1=require(_0x45cc23(0x2d4)),aiLog_service_1=require(_0x45cc23(0x294)),jwt=require(_0x45cc23(0x282)),model_constant_1=require(_0x45cc23(0x21b));let MidjourneyService=class MidjourneyService{constructor(_0x2e8ea8,_0x277148,_0x1833a7,_0x4e2a6d,_0xe43ec9,_0x2c1758,_0x2f9ed5,_0x5688ad,_0x5aea83,_0x4e9683,_0x5555f0,_0x47decf,_0xc0d7f4,_0x342e46,_0x151c59,_0x511d4f,_0x52e3e8,_0x2f042e){const _0x4f829b=_0x45cc23;this['midjourneyEntity']=_0x2e8ea8,this['userEntity']=_0x277148,this[_0x4f829b(0x2b4)]=_0x1833a7,this[_0x4f829b(0x228)]=_0x4e2a6d,this['mjIncantationClassifyEntity']=_0xe43ec9,this[_0x4f829b(0x20a)]=_0x2c1758,this[_0x4f829b(0x18c)]=_0x2f9ed5,this[_0x4f829b(0x284)]=_0x5688ad,this[_0x4f829b(0x1ab)]=_0x5aea83,this[_0x4f829b(0x1d1)]=_0x4e9683,this['badwordsService']=_0x5555f0,this[_0x4f829b(0x1c9)]=_0x47decf,this[_0x4f829b(0x2a7)]=_0xc0d7f4,this[_0x4f829b(0x200)]=_0x342e46,this[_0x4f829b(0x292)]=_0x151c59,this[_0x4f829b(0x208)]=_0x511d4f,this[_0x4f829b(0x151)]=_0x52e3e8,this['connection']=_0x2f042e;}async[_0x45cc23(0x191)](){const _0x3a6bac=_0x45cc23;await this[_0x3a6bac(0x272)](),await this['initHasAccount']();}async[_0x45cc23(0x1d5)](){const _0x4aa1e8=_0x45cc23,_0x52451e=await this[_0x4aa1e8(0x228)][_0x4aa1e8(0x2a3)]({'where':{'enable':0x1},'order':{'weight':_0x4aa1e8(0x298)}});_0x52451e===0x0&&common_1[_0x4aa1e8(0x19c)]['error'](_0x4aa1e8(0x2c9));}async[_0x45cc23(0x272)](){const _0x3b80ad=_0x45cc23,_0x3d656c=await this['mjInspireClassifyEntity'][_0x3b80ad(0x2a3)]();if(_0x3d656c===0x0){const _0x463ae0=[{'name':'绘画制作','value':0x1},{'name':_0x3b80ad(0x1c1),'value':0x2},{'name':'头像制作','value':0x3},{'name':_0x3b80ad(0x1ba),'value':0x4},{'name':'动漫漫画','value':0x5},{'name':_0x3b80ad(0x1fe),'value':0x6},{'name':'艺术设计','value':0x7},{'name':_0x3b80ad(0x17d),'value':0x8},{'name':_0x3b80ad(0x1e5),'value':0x9},{'name':_0x3b80ad(0x159),'value':0xa}]['map'](_0xb46075=>{return{'name':_0xb46075['name'],'value':_0xb46075['value']+'','inner':0x1};});await this[_0x3b80ad(0x20a)]['save'](_0x463ae0)[_0x3b80ad(0x168)](()=>{const _0x45f6cb=_0x3b80ad;common_1[_0x45f6cb(0x19c)][_0x45f6cb(0x275)](_0x45f6cb(0x1a0));}),common_1[_0x3b80ad(0x19c)]['log'](_0x3b80ad(0x299));}common_1[_0x3b80ad(0x19c)][_0x3b80ad(0x2c4)](_0x3b80ad(0x160));}async['concurrentLimit'](_0x26c323){const _0x32b4e1=_0x45cc23;let _0x4bda69=await this[_0x32b4e1(0x1ab)][_0x32b4e1(0x1c8)]([_0x32b4e1(0x1ea)]);_0x4bda69=Number(_0x4bda69||0x0);if(_0x4bda69===0x0)return!![];const _0x450441=await this[_0x32b4e1(0x266)][_0x32b4e1(0x2a3)]({'where':{'userId':_0x26c323,'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x450441<_0x4bda69)return!![];else throw new Error(_0x32b4e1(0x214));}async['addDrawQueue'](_0x406f5){const _0x5456c4=_0x45cc23,_0x15d4d8=new addDrawQueue_dto_1[(_0x5456c4(0x28c))](_0x406f5);await this[_0x5456c4(0x1f6)][_0x5456c4(0x22e)](_0x15d4d8[_0x5456c4(0x16d)],_0x15d4d8[_0x5456c4(0x206)]);const _0x4ba2f3=await this[_0x5456c4(0x266)][_0x5456c4(0x2d3)](_0x15d4d8);return _0x4ba2f3;}async[_0x45cc23(0x276)](_0x4eb089,_0x17b307){const _0x4450c8=_0x45cc23;let _0x9785aa,{botType:_0x16ab85,prompt:_0x36c243,extend:_0xf14029,action:_0x4f6729,mode:_0x14d19f,translate:_0x35920c,base64Array:_0x3db0a6,mats:mats=[],iw:_0x5dd4ea,roles:roles=[],cw:_0x8a9738,styles:styles=[],sw:_0x320efe}=_0x17b307;await this[_0x4450c8(0x2a7)][_0x4450c8(0x192)](_0x4eb089[_0x4450c8(0x15f)]['id'],_0x14d19f,'Imagine');const _0x5af323=_0x36c243,_0x1a44f8=await this[_0x4450c8(0x1f0)](_0x14d19f);_0x36c243&&await this[_0x4450c8(0x1f6)][_0x4450c8(0x22e)](_0x36c243,_0x4eb089[_0x4450c8(0x15f)]['id']),_0x36c243=_0x35920c===0x1&&(0x0,utils_1[_0x4450c8(0x16c)])(_0x36c243)?await this[_0x4450c8(0x1c9)]['convertToEnglish'](_0x36c243):_0x36c243;let _0x5793b5=_0x36c243;mats[_0x4450c8(0x1cd)]&&(_0x5793b5=mats[_0x4450c8(0x1a3)]('\x20')+'\x20'+_0x5793b5);_0x5dd4ea&&(_0x5793b5=_0x5793b5+'\x20--iw\x20'+_0x5dd4ea);styles[_0x4450c8(0x1cd)]&&(_0x5793b5=_0x5793b5+'\x20--sref\x20'+styles[_0x4450c8(0x1a3)]('\x20'));roles[_0x4450c8(0x1cd)]&&(_0x5793b5=_0x5793b5+_0x4450c8(0x179)+roles[_0x4450c8(0x1a3)]('\x20'));_0x8a9738&&(_0x5793b5=_0x5793b5+_0x4450c8(0x2d9)+_0x8a9738);_0x320efe&&(_0x5793b5=_0x5793b5+'\x20--sw\x20'+_0x320efe);_0xf14029&&(_0x5793b5=_0x5793b5+'\x20'+_0xf14029);const _0x37696a=await this['mjpTaskService'][_0x4450c8(0x276)]({'data':{'mode':this[_0x4450c8(0x165)](_0x14d19f),'prompt':_0x5793b5,'botType':_0x16ab85||'MID_JOURNEY','base64Array':_0x3db0a6,'accountFilter':{'instanceId':_0x1a44f8[_0x4450c8(0x24b)]}}});if(_0x37696a[_0x4450c8(0x16b)]===0x17)throw new Error(_0x4450c8(0x188));if(_0x37696a[_0x4450c8(0x16b)]===0x18)throw new Error(_0x4450c8(0x1c0));if(_0x37696a['code']!==0x1&&_0x37696a[_0x4450c8(0x16b)]!==0x16)throw new Error(_0x37696a[_0x4450c8(0x245)]);return _0x9785aa=await this[_0x4450c8(0x236)][_0x4450c8(0x173)](async()=>{const _0x3cbe8a=_0x4450c8,_0x19f6d3={'mode':_0x14d19f,'prompt':_0x36c243,'action':_0x4f6729,'translate':_0x35920c,'fullPrompt':_0x5793b5,'originPrompt':_0x5af323,'extraParam':_0xf14029,'userId':_0x4eb089['user']['id'],'mjpId':_0x1a44f8[_0x3cbe8a(0x24b)],'mjpTaskId':_0x37696a[_0x3cbe8a(0x1ce)],'botType':_0x16ab85||_0x3cbe8a(0x1dd)},_0x17e549=await this[_0x3cbe8a(0x2e2)](_0x19f6d3);if(!_0x17e549)throw new Error(_0x3cbe8a(0x238));return await this['userService']['deductBalance4MJ'](_0x4eb089[_0x3cbe8a(0x15f)]['id'],_0x14d19f,_0x3cbe8a(0x220),_0x17e549['id']),_0x17e549;}),_0x9785aa;}async[_0x45cc23(0x269)](_0x5efa02,_0x2ab1d5){const _0x54eff1=_0x45cc23;let _0x446d1c;const {action:_0x4ac1ba,taskId:_0x2e913f,customId:_0x25a89d,prompt:_0x9b6dc8,mask:_0x573635}=_0x2ab1d5;await this[_0x54eff1(0x19e)](_0x2e913f,_0x25a89d);const _0x1bdc72=await this['midjourneyEntity']['findOne']({'where':{'id':_0x2e913f}});if(!_0x1bdc72)throw new Error('无绘图记录');await this[_0x54eff1(0x2a7)][_0x54eff1(0x192)](_0x5efa02[_0x54eff1(0x15f)]['id'],_0x1bdc72[_0x54eff1(0x271)],_0x25a89d);const _0x136e6d=await this[_0x54eff1(0x208)][_0x54eff1(0x196)]({'data':{'customId':_0x25a89d,'taskId':_0x1bdc72[_0x54eff1(0x270)],'accountFilter':{'instanceId':_0x1bdc72[_0x54eff1(0x24b)]},'mode':this[_0x54eff1(0x165)](_0x1bdc72[_0x54eff1(0x271)])}});if(_0x136e6d[_0x54eff1(0x16b)]===0x17)throw new Error(_0x54eff1(0x188));else{if(_0x136e6d[_0x54eff1(0x16b)]===0x18)throw new Error('prompt包含敏感词');else{if(_0x136e6d[_0x54eff1(0x16b)]===0x15)setTimeout(()=>this[_0x54eff1(0x2a2)](_0x136e6d['result']));else{if(_0x136e6d['code']!==0x1&&_0x136e6d['code']!==0x16)throw new Error(_0x136e6d['description']);}}}return _0x446d1c=await this[_0x54eff1(0x236)][_0x54eff1(0x173)](async()=>{const _0x1b2613=_0x54eff1,_0x5f3089={'action':_0x4ac1ba,'customId':_0x25a89d,'userId':_0x5efa02['user']['id'],'mjpTaskId':_0x136e6d[_0x1b2613(0x1ce)],'originTaskId':String(_0x2e913f),'mode':_0x1bdc72[_0x1b2613(0x271)],'mjpId':_0x1bdc72[_0x1b2613(0x24b)],'prompt':_0x1bdc72[_0x1b2613(0x22f)],'botType':_0x1bdc72[_0x1b2613(0x1c4)],'extraParam':_0x1bdc72[_0x1b2613(0x1a6)],'fullPrompt':_0x1bdc72[_0x1b2613(0x16d)],'originPrompt':_0x1bdc72[_0x1b2613(0x256)]},_0x135c71=await this[_0x1b2613(0x2e2)](_0x5f3089);if(!_0x135c71)throw new Error(_0x1b2613(0x1ca));const _0x591d51=_0x1bdc72[_0x1b2613(0x25b)];return _0x1bdc72[_0x1b2613(0x25b)][_0x1b2613(0x1e2)](_0xde422=>{const _0x13fe5f=_0x1b2613;_0xde422[_0x13fe5f(0x2b9)]===_0x2ab1d5[_0x13fe5f(0x2b9)]&&(_0xde422['operated']=!![]);}),await this['midjourneyEntity']['save'](_0x1bdc72),await this[_0x1b2613(0x2a7)][_0x1b2613(0x202)](_0x5efa02[_0x1b2613(0x15f)]['id'],_0x1bdc72[_0x1b2613(0x271)],_0x25a89d,_0x135c71['id']),_0x135c71;}),_0x446d1c;}async[_0x45cc23(0x23c)](_0xff2c37,_0x32c657){const _0x5424fb=_0x45cc23;let _0x22dbea,{action:_0x5873ed,taskId:_0xe739d8,customId:_0x5c7eda,prompt:_0xece9da,mask:_0xdfb036}=_0x32c657;const _0x439e3b=await this[_0x5424fb(0x266)][_0x5424fb(0x155)]({'where':{'id':_0xe739d8}});if(!_0x439e3b)throw new Error(_0x5424fb(0x152));const _0x2cbaaf=_0xece9da;_0xece9da&&await this[_0x5424fb(0x1f6)][_0x5424fb(0x22e)](_0xece9da,_0xff2c37[_0x5424fb(0x15f)]['id']),_0xece9da=(0x0,utils_1[_0x5424fb(0x16c)])(_0xece9da)?await this[_0x5424fb(0x1c9)][_0x5424fb(0x27e)](_0xece9da):_0xece9da;const _0x32ff89=await this[_0x5424fb(0x208)][_0x5424fb(0x1ad)]({'data':{'prompt':_0xece9da,'maskBase64':_0xdfb036,'taskId':_0x439e3b[_0x5424fb(0x270)]}});if(_0x32ff89[_0x5424fb(0x16b)]!==0x1&&_0x32ff89[_0x5424fb(0x16b)]!==0x16)throw new Error(_0x32ff89[_0x5424fb(0x245)]);_0x22dbea=await this['midjourneyEntity'][_0x5424fb(0x2d3)]({'id':_0xe739d8,'prompt':_0xece9da,'status':0x1,'originPrompt':_0x2cbaaf,'messageFlags':0x1});for(let _0x29aa6d in _0x22dbea){_0x22dbea[_0x29aa6d]&&(_0x439e3b[_0x29aa6d]=_0x22dbea[_0x29aa6d]);}return _0x439e3b;}async[_0x45cc23(0x24c)](_0x4bd166,_0x4f8525){const _0x170eed=_0x45cc23;let _0xe81968,_0x5c5b5d;try{let {type:_0x226fd3,params:_0xac535f}=_0x4bd166;await this[_0x170eed(0x2a7)][_0x170eed(0x254)](_0x4f8525[_0x170eed(0x15f)]),await this[_0x170eed(0x262)](_0x4f8525[_0x170eed(0x15f)]['id']);if(_0x226fd3===midjourney_constant_1[_0x170eed(0x253)][_0x170eed(0x230)])_0x5c5b5d=await this[_0x170eed(0x276)](_0x4f8525,_0xac535f),_0xe81968=_0x5c5b5d[_0x170eed(0x270)];else{if(_0x226fd3===midjourney_constant_1[_0x170eed(0x253)][_0x170eed(0x161)])_0xac535f=_0xac535f,_0xac535f[_0x170eed(0x2b9)]?(_0x5c5b5d=await this[_0x170eed(0x269)](_0x4f8525,_0xac535f),_0xac535f['prompt']&&(_0xac535f['taskId']=_0x5c5b5d['id'],_0x5c5b5d=await this[_0x170eed(0x23c)](_0x4f8525,_0xac535f))):_0x5c5b5d=await this[_0x170eed(0x23c)](_0x4f8525,_0xac535f),_0xe81968=_0x5c5b5d[_0x170eed(0x270)];else return new common_1[(_0x170eed(0x281))](_0x170eed(0x2d5),common_1[_0x170eed(0x156)][_0x170eed(0x1cb)]);}return _0x5c5b5d;}catch(_0x2ddb6f){if(_0x2ddb6f instanceof common_1[_0x170eed(0x281)])throw _0x2ddb6f;else{_0xe81968&&await this[_0x170eed(0x208)][_0x170eed(0x1b1)]({},_0xe81968);throw new common_1['HttpException'](_0x2ddb6f['message'],common_1[_0x170eed(0x156)][_0x170eed(0x1cb)]);}}}async['handleImagesUploadTask'](_0x526ce9,_0x590cc0){const _0x290e19=_0x45cc23;let _0x2d405e,_0x3250e6;try{const {type:_0x40456c,botType:_0x16471f,files:_0x103a1e,mode:_0x1d8b4f,action:_0x533e49,size:_0x5c4e47,base64Array:base64Array=[]}=_0x526ce9;await this[_0x290e19(0x2a7)][_0x290e19(0x254)](_0x590cc0[_0x290e19(0x15f)]),await this['concurrentLimit'](_0x590cc0['user']['id']);let _0x381d98='';if(Number(_0x40456c)===midjourney_constant_1[_0x290e19(0x253)][_0x290e19(0x1d9)])_0x381d98='Blend';else Number(_0x40456c)===midjourney_constant_1[_0x290e19(0x253)]['IMAGE_TO_TEXT']&&(_0x381d98=_0x290e19(0x1b3));await this[_0x290e19(0x2a7)][_0x290e19(0x192)](_0x590cc0[_0x290e19(0x15f)]['id'],_0x1d8b4f,_0x381d98);const _0x11453a=await this[_0x290e19(0x1f0)](_0x1d8b4f);if(!base64Array[_0x290e19(0x1cd)])for(let _0x43aace=0x0;_0x43aace<_0x103a1e[_0x290e19(0x1cd)];_0x43aace++){base64Array[_0x290e19(0x203)]('data:image/png;base64,'+_0x103a1e[_0x43aace][_0x290e19(0x29b)][_0x290e19(0x26f)](_0x290e19(0x24a)));}if(Number(_0x40456c)===midjourney_constant_1[_0x290e19(0x253)][_0x290e19(0x1d9)]){if(base64Array[_0x290e19(0x1cd)]<0x2)throw new Error(_0x290e19(0x2cd));const _0x3478cd=await this[_0x290e19(0x208)][_0x290e19(0x1d4)]({'data':{'mode':this['convertMode4Transfer'](_0x1d8b4f),'dimensions':_0x5c4e47,'botType':_0x290e19(0x1dd),'base64Array':base64Array,'accountFilter':{'instanceId':_0x11453a[_0x290e19(0x24b)]}}});if(_0x3478cd[_0x290e19(0x16b)]===0x17)throw new Error('队列已满，请稍后尝试');if(_0x3478cd[_0x290e19(0x16b)]!==0x1&&_0x3478cd[_0x290e19(0x16b)]!==0x16)throw new Error(_0x3478cd['description']);_0x2d405e=_0x3478cd['result'],_0x3250e6=await this[_0x290e19(0x236)][_0x290e19(0x173)](async()=>{const _0xb50aa0=_0x290e19,_0x13526e={'mode':_0x1d8b4f,'action':_0x533e49,'imgUrl':'','userId':_0x590cc0[_0xb50aa0(0x15f)]['id'],'jobId':(0x0,utils_1[_0xb50aa0(0x17e)])(),'botType':_0x16471f||_0xb50aa0(0x1dd),'extraParam':JSON[_0xb50aa0(0x1f8)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x3478cd[_0xb50aa0(0x1ce)]},_0x2a88e8=await this[_0xb50aa0(0x2e2)](_0x13526e);if(!_0x2a88e8)throw new Error(_0xb50aa0(0x1bd));return await this[_0xb50aa0(0x2a7)]['deductBalance4MJ'](_0x590cc0[_0xb50aa0(0x15f)]['id'],_0x1d8b4f,_0x381d98,_0x2a88e8['id']),_0x2a88e8;});}else{if(Number(_0x40456c)===midjourney_constant_1[_0x290e19(0x253)]['IMAGE_TO_TEXT']){const _0x1c750d=await this[_0x290e19(0x208)][_0x290e19(0x176)]({'data':{'mode':this[_0x290e19(0x165)](_0x1d8b4f),'botType':'MID_JOURNEY','base64':base64Array[0x0],'accountFilter':{'instanceId':_0x11453a[_0x290e19(0x24b)]}}});if(_0x1c750d[_0x290e19(0x16b)]===0x17)throw new Error('队列已满，请稍后尝试');if(_0x1c750d['code']!==0x1&&_0x1c750d[_0x290e19(0x16b)]!==0x16)throw new Error(_0x1c750d[_0x290e19(0x245)]);_0x2d405e=_0x1c750d['result'],_0x3250e6=await this[_0x290e19(0x236)]['transaction'](async()=>{const _0x446556=_0x290e19,_0x3095d8={'mode':_0x1d8b4f,'action':_0x533e49,'imgUrl':'','userId':_0x590cc0[_0x446556(0x15f)]['id'],'jobId':(0x0,utils_1[_0x446556(0x17e)])(),'botType':_0x16471f||_0x446556(0x1dd),'extraParam':JSON[_0x446556(0x1f8)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x1c750d[_0x446556(0x1ce)]},_0x50614d=await this['addDrawQueue'](_0x3095d8);if(!_0x50614d)throw new Error(_0x446556(0x25e));return await this[_0x446556(0x2a7)][_0x446556(0x202)](_0x590cc0[_0x446556(0x15f)]['id'],_0x1d8b4f,_0x381d98,_0x50614d['id']),_0x50614d;})[_0x290e19(0x168)](async _0x3d9c40=>{const _0x311ec2=_0x290e19;await this[_0x311ec2(0x208)]['cancel']({},_0x1c750d[_0x311ec2(0x1ce)]);throw _0x3d9c40;});}else return new common_1[(_0x290e19(0x281))](_0x290e19(0x2d5),common_1[_0x290e19(0x156)][_0x290e19(0x1cb)]);}return _0x3250e6;}catch(_0x182dd8){if(_0x182dd8 instanceof common_1[_0x290e19(0x281)])throw _0x182dd8;else{_0x2d405e&&await this[_0x290e19(0x208)][_0x290e19(0x1b1)]({},_0x2d405e);throw new common_1['HttpException'](_0x182dd8[_0x290e19(0x172)],common_1[_0x290e19(0x156)][_0x290e19(0x1cb)]);}}}async['insightFace'](_0x1cf7bd,_0x38315f){const _0x207cd=_0x45cc23;let _0x3bd8e8;try{const {params:_0x5ce8ff}=_0x1cf7bd,{mode:_0x9f7eb0,botType:_0x5e0b3a,action:_0x397d89,extend:_0x30cef7,sourceBase64:_0xc88da8,targetBase64:_0x44558e}=_0x5ce8ff;await this['userService'][_0x207cd(0x254)](_0x38315f[_0x207cd(0x15f)]),await this['concurrentLimit'](_0x38315f[_0x207cd(0x15f)]['id']),await this[_0x207cd(0x2a7)][_0x207cd(0x192)](_0x38315f['user']['id'],_0x9f7eb0,_0x207cd(0x2c6));const _0x5ba859=await this[_0x207cd(0x1f0)](_0x9f7eb0),_0x4ff771=await this['mjpTaskService'][_0x207cd(0x1f5)]({'data':{'sourceBase64':_0xc88da8,'targetBase64':_0x44558e,'state':_0x30cef7,'mode':this['convertMode4Transfer'](_0x9f7eb0),'accountFilter':{'instanceId':_0x5ba859['mjpId']}}});if(_0x4ff771['code']===0x17)throw new Error(_0x207cd(0x188));if(_0x4ff771[_0x207cd(0x16b)]===0x18)throw new Error(_0x207cd(0x1c0));if(_0x4ff771[_0x207cd(0x16b)]!==0x1&&_0x4ff771[_0x207cd(0x16b)]!==0x16)throw new Error(_0x4ff771[_0x207cd(0x245)]);return _0x3bd8e8=await this[_0x207cd(0x236)][_0x207cd(0x173)](async()=>{const _0xa2f0c8=_0x207cd,_0xd3719={'mode':_0x9f7eb0,'action':_0x397d89,'prompt':null,'extraParam':_0x30cef7,'originPrompt':null,'userId':_0x38315f[_0xa2f0c8(0x15f)]['id'],'mjpId':_0x5ba859[_0xa2f0c8(0x24b)],'mjpTaskId':_0x4ff771['result'],'botType':_0x5e0b3a||_0xa2f0c8(0x1dd)},_0x36abfa=new addDrawQueue_dto_1[(_0xa2f0c8(0x28c))](_0xd3719),_0x3b82ab=await this[_0xa2f0c8(0x266)][_0xa2f0c8(0x2d3)](_0x36abfa);if(!_0x3b82ab)throw new Error(_0xa2f0c8(0x238));return await this[_0xa2f0c8(0x2a7)][_0xa2f0c8(0x202)](_0x38315f[_0xa2f0c8(0x15f)]['id'],_0x9f7eb0,_0xa2f0c8(0x2c6),_0x3b82ab['id']),_0x3b82ab;}),_0x3bd8e8;}catch(_0xca5dde){if(_0xca5dde instanceof common_1[_0x207cd(0x281)])throw _0xca5dde;else throw new common_1[(_0x207cd(0x281))](_0xca5dde[_0x207cd(0x172)],common_1[_0x207cd(0x156)][_0x207cd(0x1cb)]);}}async[_0x45cc23(0x26d)](_0x22f739,_0xfc5f04){const _0x12ad2d=_0x45cc23,_0x1a02a2={'userId':_0xfc5f04['user']['id'],'jobId':(0x0,utils_1[_0x12ad2d(0x17e)])(),'mode':0x1,'translate':0x0,'prompt':'','progress':0x64,'durationSpent':0x0,'status':0x3,'fullPrompt':_0x22f739['prompt'],'originPrompt':_0x22f739[_0x12ad2d(0x22f)],'fileInfo':_0x22f739[_0x12ad2d(0x27b)],'botType':_0x22f739['botType'],'imageUrl':_0x22f739['imageUrl'],'buttons':[]},_0x3414d4=await this['midjourneyEntity'][_0x12ad2d(0x2d3)](_0x1a02a2);return _0x3414d4;}async['imageSeed'](_0x3afbd4){const _0x6183fb=_0x45cc23;try{const _0x5c5b0c=await this[_0x6183fb(0x266)][_0x6183fb(0x155)]({'where':{'jobId':_0x3afbd4}});if(!_0x5c5b0c)throw new Error(_0x6183fb(0x2ac));const _0x159a5a=await this[_0x6183fb(0x208)][_0x6183fb(0x22d)]({},_0x5c5b0c[_0x6183fb(0x270)]);if(_0x159a5a[_0x6183fb(0x16b)]!==0x1)throw new Error(_0x159a5a[_0x6183fb(0x245)]);return _0x159a5a['result'];}catch(_0x6ac39f){throw new common_1[(_0x6183fb(0x281))](_0x6ac39f[_0x6183fb(0x172)],common_1[_0x6183fb(0x156)][_0x6183fb(0x1cb)]);}}async[_0x45cc23(0x26c)](){const _0x48e6f3=_0x45cc23;return await this[_0x48e6f3(0x228)][_0x48e6f3(0x2a3)]({'where':{'enable':0x1,'mode':(0x0,typeorm_2['In'])([midjourney_constant_1[_0x48e6f3(0x187)][_0x48e6f3(0x190)],midjourney_constant_1['DrawSpeed'][_0x48e6f3(0x2c5)],midjourney_constant_1[_0x48e6f3(0x187)][_0x48e6f3(0x1ac)]])}})[_0x48e6f3(0x19b)](_0x51036d=>_0x51036d>0x0)[_0x48e6f3(0x168)](_0x4b052f=>{const _0x1be2f5=_0x48e6f3;return common_1[_0x1be2f5(0x19c)][_0x1be2f5(0x275)](_0x4b052f),![];});}async[_0x45cc23(0x1ef)](_0x4ed584=midjourney_constant_1['DrawSpeed'][_0x45cc23(0x190)]){const _0x5d4810=_0x45cc23,_0x1e93ce=await this[_0x5d4810(0x228)][_0x5d4810(0x164)]({'where':{'enable':0x1,'mode':_0x4ed584},'order':{'weight':'DESC'}});if(!_0x1e93ce[_0x5d4810(0x1cd)])return Promise[_0x5d4810(0x150)](_0x5d4810(0x153)+(_0x4ed584===midjourney_constant_1[_0x5d4810(0x187)][_0x5d4810(0x190)]?'快速':_0x4ed584===midjourney_constant_1[_0x5d4810(0x187)][_0x5d4810(0x2c5)]?'休闲':_0x5d4810(0x1ac))+_0x5d4810(0x290));return(0x0,utils_1[_0x5d4810(0x23b)])(_0x1e93ce);}async[_0x45cc23(0x1f0)](_0x1ba608){const _0x2f5300=_0x45cc23;if(MjConfig_1[_0x2f5300(0x194)][_0x2f5300(0x181)]!=='mjProxy')return new mjParam_entity_1[(_0x2f5300(0x18e))]();const _0xefa43=await this['mjParamEntity'][_0x2f5300(0x164)]({'where':{'enable':0x1,'mode':_0x1ba608,'fastRemainTime':(0x0,typeorm_2[_0x2f5300(0x25d)])((0x0,typeorm_2[_0x2f5300(0x1d0)])())},'order':{'weight':_0x2f5300(0x298)}});if(!_0xefa43[_0x2f5300(0x1cd)])throw new Error(_0x2f5300(0x227));const [_0x29bb0b]=await this['connection']['query'](_0x2f5300(0x1cf));if(!_0x29bb0b)return _0xefa43[0x0];else{const _0x155b1a=_0xefa43[_0x2f5300(0x164)](_0x1a5a18=>_0x1a5a18[_0x2f5300(0x24b)]===_0x29bb0b[_0x2f5300(0x24b)]);if(!_0x155b1a)throw new Error(_0x2f5300(0x227));return _0x155b1a;}}async[_0x45cc23(0x26e)](_0x4e366c){const _0x5dd7b0=_0x45cc23,{proxyUrl:_0x47b972}=_0x4e366c,_0x3aa0a7=await this['globalConfigService']['getConfigs']([_0x5dd7b0(0x2bf)]);return _0x47b972||_0x3aa0a7||_0x5dd7b0(0x29a);}async[_0x45cc23(0x2b6)](_0x937b20){const _0x8b9354=_0x45cc23;try{const {guildId:_0x46c763,account:_0x5781b4,authorization:_0xa3cedb,mode:_0x3a4d7c,timeout:_0x2c517f,channelId:_0x260788,remark:_0x7586fc,mjBotChannelId:_0x12bf5f,nijiBotChannelId:_0x251e94}=_0x937b20;var _0x7555ad=await this[_0x8b9354(0x292)][_0x8b9354(0x163)]({'data':{'channelId':_0x260788,'coreSize':0x3,'guildId':_0x46c763,'mjBotChannelId':_0x12bf5f||'','nijiBotChannelId':_0x251e94||'','queueSize':0xa,'remark':_0x7586fc,'remixAutoSubmit':![],'timeoutMinutes':_0x2c517f,'userAgent':_0x8b9354(0x2e1),'userToken':_0xa3cedb}});if(_0x7555ad[_0x8b9354(0x16b)]!==0x1)throw new Error(_0x7555ad[_0x8b9354(0x245)]);const _0x5e8836=await this[_0x8b9354(0x228)]['save']({'account':_0x5781b4,'authorization':_0xa3cedb,'mode':_0x3a4d7c,'timeout':_0x2c517f,'channelId':_0x260788,'guildId':_0x46c763,'remark':_0x7586fc,'mjpId':_0x7555ad['result'],'mjBotChannelId':_0x12bf5f||'','nijiBotChannelId':_0x251e94||''});return await this[_0x8b9354(0x207)](_0x7555ad[_0x8b9354(0x1ce)]),!!_0x5e8836;}catch(_0x4751b3){common_1[_0x8b9354(0x19c)]['error'](_0x4751b3);throw new common_1[(_0x8b9354(0x281))](_0x4751b3['message'],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x45cc23(0x16e)](_0x1c6509){const _0x4b9567=_0x45cc23,{id:_0x433e62,account:_0x56674d,authorization:_0x246cb2,mode:_0x406a8c,guildId:_0x4490cd,remark:_0x4f6f39,channelId:_0x5905e7,timeout:_0x2d94d3,enable:_0x468548,mjBotChannelId:_0xb8ae01,nijiBotChannelId:_0x485df8}=_0x1c6509;try{const _0x25b122=await this[_0x4b9567(0x228)][_0x4b9567(0x2d7)]({'id':Number(_0x433e62)});var _0x1ff5e0=await this[_0x4b9567(0x292)][_0x4b9567(0x280)]({'data':{'channelId':_0x5905e7,'coreSize':0x3,'guildId':_0x4490cd,'mjBotChannelId':_0xb8ae01||'','nijiBotChannelId':_0x485df8||'','queueSize':0xa,'remark':_0x4f6f39,'remixAutoSubmit':![],'timeoutMinutes':_0x2d94d3,'userAgent':_0x4b9567(0x2e1),'userToken':_0x246cb2,'enable':Boolean(_0x468548)}},_0x25b122[_0x4b9567(0x24b)]);if(_0x1ff5e0[_0x4b9567(0x16b)]!==0x1)throw new Error(_0x1ff5e0[_0x4b9567(0x245)]);return await this['mjParamEntity'][_0x4b9567(0x185)](_0x433e62,{'account':_0x56674d,'authorization':_0x246cb2,'mode':_0x406a8c,'guildId':_0x4490cd,'remark':_0x4f6f39,'channelId':_0x5905e7,'timeout':_0x2d94d3,'mjBotChannelId':_0xb8ae01||'','nijiBotChannelId':_0x485df8||''});}catch(_0x43db59){common_1[_0x4b9567(0x19c)][_0x4b9567(0x275)](_0x43db59);throw new common_1['HttpException'](_0x43db59[_0x4b9567(0x172)],common_1['HttpStatus'][_0x4b9567(0x1cb)]);}}async[_0x45cc23(0x219)](_0x4028f2,_0x5d760a){const _0x16a50e=_0x45cc23;_0x4028f2['mjVersion']=_0x5d760a['version'];if(_0x5d760a[_0x16a50e(0x271)]===_0x16a50e(0x184))_0x4028f2[_0x16a50e(0x271)]=midjourney_constant_1[_0x16a50e(0x187)][_0x16a50e(0x190)];else{if(_0x5d760a[_0x16a50e(0x271)]==='RELAX')_0x4028f2[_0x16a50e(0x271)]=midjourney_constant_1['DrawSpeed'][_0x16a50e(0x2c5)];else _0x5d760a[_0x16a50e(0x271)]===_0x16a50e(0x2af)&&(_0x4028f2[_0x16a50e(0x271)]=midjourney_constant_1[_0x16a50e(0x187)]['turbo']);}_0x4028f2['fastRemainTime']=_0x5d760a['fastTimeRemaining'],_0x4028f2['totalTime']=_0x5d760a[_0x16a50e(0x2b8)],_0x4028f2[_0x16a50e(0x22a)]=_0x5d760a['lifetimeUsage'],_0x4028f2[_0x16a50e(0x28a)]=_0x5d760a[_0x16a50e(0x28a)],_0x4028f2[_0x16a50e(0x15e)]=Number(_0x5d760a[_0x16a50e(0x15e)]);if(_0x5d760a[_0x16a50e(0x1ff)]===_0x16a50e(0x2ba))_0x4028f2[_0x16a50e(0x180)]=0x1;else{if(_0x5d760a['subscribePlan']===_0x16a50e(0x279))_0x4028f2['orderPlan']=0x2;else{if(_0x5d760a['subscribePlan']===_0x16a50e(0x158))_0x4028f2[_0x16a50e(0x180)]=0x3;else _0x5d760a[_0x16a50e(0x1ff)]===_0x16a50e(0x2c3)&&(_0x4028f2[_0x16a50e(0x180)]=0x4);}}_0x4028f2[_0x16a50e(0x23e)]=_0x5d760a[_0x16a50e(0x23e)],_0x4028f2[_0x16a50e(0x243)]=_0x5d760a[_0x16a50e(0x242)],_0x4028f2[_0x16a50e(0x283)]=JSON[_0x16a50e(0x1f8)](_0x5d760a[_0x16a50e(0x25b)]),_0x4028f2[_0x16a50e(0x17c)]=JSON['stringify'](_0x5d760a[_0x16a50e(0x258)]),await this[_0x16a50e(0x228)][_0x16a50e(0x2d3)](_0x4028f2);}async[_0x45cc23(0x207)](_0x1e86f4){const _0x2f361c=_0x45cc23;try{if(MjConfig_1[_0x2f361c(0x194)][_0x2f361c(0x181)]!==_0x2f361c(0x1a4))return;const _0x4b2974=await this[_0x2f361c(0x292)][_0x2f361c(0x2d2)]({},_0x1e86f4);if(!_0x4b2974)return;const _0x481b64=await this['mjParamEntity']['findOne']({'where':{'mjpId':_0x1e86f4}});await this[_0x2f361c(0x219)](_0x481b64,_0x4b2974);}catch(_0x4b83e8){common_1[_0x2f361c(0x19c)][_0x2f361c(0x275)](_0x2f361c(0x1c6),_0x4b83e8);}}async[_0x45cc23(0x2c2)](){const _0x43a137=_0x45cc23,_0x292776=await this[_0x43a137(0x228)]['find']();if(!_0x292776['length'])return;for(let _0x8310db=0x0;_0x8310db<_0x292776[_0x43a137(0x1cd)];_0x8310db++){this[_0x43a137(0x207)](_0x292776[_0x8310db][_0x43a137(0x24b)]);}}async[_0x45cc23(0x16f)]({id:_0x3eeff0}){const _0x38aedd=_0x45cc23;try{const _0x241cd7=await this['mjParamEntity'][_0x38aedd(0x2d7)]({'id':Number(_0x3eeff0)}),_0x1b46a6=await this[_0x38aedd(0x292)][_0x38aedd(0x1cc)]({},_0x241cd7[_0x38aedd(0x24b)]);if(_0x1b46a6[_0x38aedd(0x16b)]!==0x1)throw new Error(_0x1b46a6[_0x38aedd(0x245)]);await this[_0x38aedd(0x219)](_0x241cd7,_0x1b46a6['result']);}catch(_0x4ea7fe){throw new common_1[(_0x38aedd(0x281))](_0x4ea7fe[_0x38aedd(0x172)],common_1[_0x38aedd(0x156)][_0x38aedd(0x1cb)]);}}async[_0x45cc23(0x204)](_0x56891c){const _0x559d31=_0x45cc23;try{const _0x382ec7=await this[_0x559d31(0x228)][_0x559d31(0x2d7)]({'id':Number(_0x56891c['id'])}),_0x5f1ac0=await this['mjpAccountService']['changeVersion']({'data':_0x56891c},_0x382ec7['mjpId']);if(_0x5f1ac0[_0x559d31(0x16b)]!==0x1)throw new Error(_0x5f1ac0[_0x559d31(0x245)]);return _0x382ec7['mjVersion']=_0x56891c['version'],await this[_0x559d31(0x228)][_0x559d31(0x2d3)](_0x382ec7),!![];}catch(_0x4b6941){throw new common_1['HttpException'](_0x4b6941[_0x559d31(0x172)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x45cc23(0x196)](_0x4c7dff){const _0x20cc42=_0x45cc23;try{const _0x38607e=await this['mjParamEntity'][_0x20cc42(0x2d7)]({'id':Number(_0x4c7dff['id'])}),_0x16edd0=await this[_0x20cc42(0x292)]['action']({'data':_0x4c7dff},_0x38607e[_0x20cc42(0x24b)]);if(_0x16edd0['code']!==0x1)throw new Error(_0x16edd0['description']);return!![];}catch(_0x2231fd){throw new common_1[(_0x20cc42(0x281))](_0x2231fd[_0x20cc42(0x172)],common_1[_0x20cc42(0x156)]['BAD_REQUEST']);}}async[_0x45cc23(0x1e8)](_0x51696f){const _0x4ba36f=_0x45cc23,{id:_0x39b70e}=_0x51696f;try{const _0x44df98=await this[_0x4ba36f(0x228)]['findOne']({'where':{'id':Number(_0x39b70e)}});if(!_0x44df98)throw new Error(_0x4ba36f(0x21f));common_1[_0x4ba36f(0x19c)]['error'](_0x4ba36f(0x251),_0x44df98[_0x4ba36f(0x24b)]);const _0x1a8aa8=await this[_0x4ba36f(0x292)]['delete']({},_0x44df98[_0x4ba36f(0x24b)]);if(_0x1a8aa8[_0x4ba36f(0x16b)]!==0x1)throw new Error(_0x1a8aa8[_0x4ba36f(0x245)]);const _0x1e88b4=await this[_0x4ba36f(0x228)][_0x4ba36f(0x240)]({'id':_0x39b70e});return _0x1e88b4[_0x4ba36f(0x226)];}catch(_0x5cbc3f){throw new common_1['HttpException'](_0x5cbc3f[_0x4ba36f(0x172)],common_1[_0x4ba36f(0x156)]['BAD_REQUEST']);}}async[_0x45cc23(0x1e0)](_0x34d39c){const _0x354791=_0x45cc23,{id:_0x163a9e,enable:_0x44015b}=_0x34d39c;return await this[_0x354791(0x228)][_0x354791(0x185)](_0x163a9e,{'enable':_0x44015b})[_0x354791(0x19b)](_0x30c0e5=>_0x30c0e5['affected']>0x0);}async[_0x45cc23(0x211)](_0x420c4d,_0x24313e){const _0x39b9ac=_0x45cc23,_0x1037f2=_0x24313e['user'][_0x39b9ac(0x1db)],_0x13bbfd=_0x1037f2===_0x39b9ac(0x2a0),{id:_0x37aaca}=_0x420c4d;let _0x474b63=null;try{const _0x28f053=await this[_0x39b9ac(0x228)]['findOne']({'where':{'id':_0x37aaca}});return _0x13bbfd&&(_0x474b63=await this[_0x39b9ac(0x292)][_0x39b9ac(0x2d2)]({},_0x28f053[_0x39b9ac(0x24b)])),{..._0x28f053,'mjpAccountInfo':_0x474b63,'authorization':_0x13bbfd?_0x28f053[_0x39b9ac(0x291)]:(0x0,utils_1[_0x39b9ac(0x17b)])(_0x28f053['authorization']),'guildId':_0x13bbfd?_0x28f053[_0x39b9ac(0x1b2)]:(0x0,utils_1[_0x39b9ac(0x17b)])(_0x28f053[_0x39b9ac(0x1b2)]),'channelId':_0x13bbfd?_0x28f053[_0x39b9ac(0x221)]:(0x0,utils_1[_0x39b9ac(0x17b)])(_0x28f053[_0x39b9ac(0x221)])};}catch(_0x3c8dbd){throw new common_1[(_0x39b9ac(0x281))](_0x3c8dbd,common_1[_0x39b9ac(0x156)][_0x39b9ac(0x1cb)]);}}async[_0x45cc23(0x1fb)](_0x347939,_0x3e8d8d){const _0x4acc56=_0x45cc23,_0x127970=_0x3e8d8d['user'][_0x4acc56(0x1db)],{page:page=0x1,size:size=0x14,account:_0x8baa37,channelId:_0x4e20f9,enable:_0x28e42b}=_0x347939;if(!page||!size)throw new common_1[(_0x4acc56(0x281))](_0x4acc56(0x1d3),common_1[_0x4acc56(0x156)][_0x4acc56(0x1cb)]);const _0x550e42={};_0x8baa37&&Object[_0x4acc56(0x1de)](_0x550e42,{'account':(0x0,typeorm_2[_0x4acc56(0x274)])('%'+_0x8baa37+'%')}),_0x4e20f9&&Object[_0x4acc56(0x1de)](_0x550e42,{'channelId':(0x0,typeorm_2[_0x4acc56(0x274)])('%'+_0x4e20f9+'%')}),_0x28e42b>0x0&&Object['assign'](_0x550e42,{'enable':_0x28e42b});const [_0x18e54e,_0x459373]=await this[_0x4acc56(0x228)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x550e42,'take':size,'order':{'createdAt':_0x4acc56(0x298)},'cache':!![],'select':['id',_0x4acc56(0x1b2),_0x4acc56(0x221),'authorization',_0x4acc56(0x199),'weight',_0x4acc56(0x1c3),_0x4acc56(0x252),_0x4acc56(0x180),_0x4acc56(0x23e),_0x4acc56(0x2a5),_0x4acc56(0x271)]});return{'rows':_0x127970===_0x4acc56(0x2a0)?_0x18e54e:_0x18e54e[_0x4acc56(0x229)](_0x3e0c3c=>({..._0x3e0c3c,'authorization':(0x0,utils_1[_0x4acc56(0x17b)])(_0x3e0c3c[_0x4acc56(0x291)]),'guildId':(0x0,utils_1[_0x4acc56(0x17b)])(_0x3e0c3c['guildId']),'channelId':(0x0,utils_1['hideString'])(_0x3e0c3c[_0x4acc56(0x221)])}))||[],'count':_0x459373||0x0};}async[_0x45cc23(0x2cf)](_0x3c61ac){const _0x4e8a49=_0x45cc23,{authorization:_0x14ceca,channel_id:_0x13a51d}=_0x3c61ac,_0x4c0c3f=_0x4e8a49(0x232)+_0x13a51d+_0x4e8a49(0x26a),_0x124ce3={'Content-Type':'application/json','authorization':_0x14ceca};try{return await axios_1[_0x4e8a49(0x194)][_0x4e8a49(0x162)](_0x4c0c3f,{'files':_0x3c61ac[_0x4e8a49(0x28e)]},{'headers':_0x124ce3});}catch(_0x3a1a23){console[_0x4e8a49(0x2c4)](_0x4e8a49(0x1a5),_0x3a1a23);throw new common_1[(_0x4e8a49(0x281))](_0x4e8a49(0x213),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x45cc23(0x183)](_0x3a9726){const _0x469cf9=_0x45cc23,{buffer:_0x4ceccb,channel_id:_0x3aa260,authorization:_0x4ceaad,filename:_0x30c7de,needImage:needImage=![]}=_0x3a9726,_0x42fc2e=_0x4ceccb[_0x469cf9(0x1cd)],_0xc8ceff=(0x0,createRandomId_1[_0x469cf9(0x2be)])(),_0x15e753=await this[_0x469cf9(0x2cf)]({'authorization':_0x4ceaad,'channel_id':_0x3aa260,'files':[{'filename':_0x30c7de,'file_size':_0x42fc2e,'id':_0xc8ceff}]});if(_0x15e753['status']!=0xc8)return Promise[_0x469cf9(0x150)](_0x469cf9(0x213));const _0x1cef9a=_0x15e753['data'];if(_0x1cef9a[_0x469cf9(0x1e4)]?.['length']!=0x1)return Promise[_0x469cf9(0x150)](_0x469cf9(0x216));const _0x65294b=await axios_1[_0x469cf9(0x194)][_0x469cf9(0x2a8)](_0x1cef9a[_0x469cf9(0x1e4)][0x0][_0x469cf9(0x2df)],_0x4ceccb,{'headers':{'Content-Type':_0x469cf9(0x224)}})['catch'](_0x477e53=>{const _0x59d360=_0x469cf9;return Promise[_0x59d360(0x150)]('上传文件失败...'+_0x477e53);});if(_0x65294b&&_0x65294b[_0x469cf9(0x23a)]!=0xc8&&_0x65294b['status']!=0xc9)throw new common_1['HttpException'](_0x469cf9(0x27d),common_1[_0x469cf9(0x156)][_0x469cf9(0x1cb)]);const _0x36d799=_0x1cef9a[_0x469cf9(0x1e4)][0x0][_0x469cf9(0x29c)],_0x49b2ef=_0x36d799[_0x469cf9(0x2bd)]('/'),_0x568039=_0x49b2ef['length']>0x1?_0x49b2ef[0x1]:_0x49b2ef[0x0];if(needImage){const _0x332aa5=_0x469cf9(0x232)+_0x3aa260+_0x469cf9(0x2ae),_0x11df04=await(0x0,axios_1[_0x469cf9(0x194)])({'url':''+_0x332aa5,'method':'post','headers':{'Authorization':''+_0x4ceaad,'Content-Type':_0x469cf9(0x263)},'data':{'content':_0x568039,'channel_id':_0x3aa260,'type':0x0,'sticker_ids':[],'attachments':[{'id':0x0,'filename':_0x568039,'uploaded_filename':_0x36d799}]}});if(_0x11df04[_0x469cf9(0x23a)]!==0xc8)throw new common_1[(_0x469cf9(0x281))](_0x469cf9(0x1b7),common_1[_0x469cf9(0x156)][_0x469cf9(0x1cb)]);const _0x1e76de=await _0x11df04['data'];if(_0x1e76de[_0x469cf9(0x1e4)]?.['length']!=0x1)throw new common_1['HttpException']('上传文件失败...,\x20\x20upload\x20message\x20fail',common_1[_0x469cf9(0x156)]['BAD_REQUEST']);return{'attachments':[{'id':_0xc8ceff,'filename':_0x568039,'uploaded_filename':_0x36d799}],'image':_0x1e76de[_0x469cf9(0x1e4)][0x0]};}else return{'attachments':[{'id':_0xc8ceff,'filename':_0x568039,'uploaded_filename':_0x36d799}],'image':{'url':''}};}async[_0x45cc23(0x2dc)](_0x19d11e=midjourney_constant_1['DrawSpeed'][_0x45cc23(0x190)]){const _0x11899c=_0x45cc23;try{const _0x2232c3=await this['getRandomKey'](_0x19d11e)[_0x11899c(0x168)](_0x2a4520=>{throw _0x2a4520;}),_0x2489bf=await this[_0x11899c(0x1ab)][_0x11899c(0x1c8)]([_0x11899c(0x1a4),_0x11899c(0x1d7),_0x11899c(0x2aa)]);return{'guild_id':_0x2232c3[_0x11899c(0x1b2)],'channel_id':_0x2232c3[_0x11899c(0x221)],'authorization':_0x2232c3['authorization'],'mjProxy':_0x2489bf[_0x11899c(0x1a4)],'mjProxyUrl':_0x2489bf[_0x11899c(0x1d7)],'mjSocketProxyUrl':_0x2489bf['mjSocketProxyUrl']};}catch(_0x4d1b62){return Promise[_0x11899c(0x150)](_0x4d1b62);}}async[_0x45cc23(0x169)](_0x45e3d5,_0x54a99e){const _0x1a4c38=_0x45cc23;try{const _0x307200=_0x45e3d5[_0x1a4c38(0x15f)]['id'],{page:page=0x1,size:size=0x14,status:_0x30fd72,favorite:_0x275162}=_0x54a99e,_0x27db44={};_0x307200&&Object[_0x1a4c38(0x1de)](_0x27db44,{'userId':_0x307200});Number(_0x275162)===0x1?Object[_0x1a4c38(0x1de)](_0x27db44,{'favorite':Number(_0x275162)}):_0x30fd72>0x0&&Object[_0x1a4c38(0x1de)](_0x27db44,{'status':_0x30fd72});const [_0xee0301,_0x1dca7f]=await this[_0x1a4c38(0x266)][_0x1a4c38(0x1ed)]({'where':_0x27db44,'order':{'id':_0x1a4c38(0x298)},'take':size,'skip':(page-0x1)*size});return{'rows':(0x0,utils_1[_0x1a4c38(0x1b5)])(_0xee0301),'count':_0x1dca7f};}catch(_0x3d0f98){console[_0x1a4c38(0x2c4)](_0x3d0f98);throw new common_1[(_0x1a4c38(0x281))]('获取我得绘制列表失败',common_1[_0x1a4c38(0x156)][_0x1a4c38(0x1cb)]);}}async[_0x45cc23(0x19e)](_0x825a63,_0x32aa49){const _0x1cf443=_0x45cc23,_0x40d122=await this['midjourneyEntity'][_0x1cf443(0x2a3)]({'where':{'originTaskId':String(_0x825a63),'customId':_0x32aa49}});if(_0x40d122>0x0)throw new common_1[(_0x1cf443(0x281))](_0x1cf443(0x2cc),common_1[_0x1cf443(0x156)][_0x1cf443(0x1cb)]);return![];}async[_0x45cc23(0x2d8)](_0x51abd6,_0x351d5d){const _0x41678a=_0x45cc23;try{const _0xd78764=await this[_0x41678a(0x266)]['findOne']({'where':{'id':_0x51abd6,'userId':_0x351d5d[_0x41678a(0x15f)]['id']}});if(!_0xd78764)throw new Error(_0x41678a(0x25c));if(_0xd78764['status']===midjourney_constant_1[_0x41678a(0x28b)][_0x41678a(0x267)])throw new Error('绘制中的图片任务、禁止删除！');await this[_0x41678a(0x208)][_0x41678a(0x1b1)](null,_0xd78764['mjpTaskId']);const _0x1f64bc=await this['midjourneyEntity']['delete']({'id':_0x51abd6});if(_0x1f64bc[_0x41678a(0x226)]>0x0)return _0x41678a(0x17a);else throw new Error(_0x41678a(0x222));}catch(_0x28e235){throw new common_1['HttpException'](_0x28e235[_0x41678a(0x172)],common_1[_0x41678a(0x156)][_0x41678a(0x1cb)]);}}async['checkLimit'](_0x4b480c,_0x5a57b0){const _0xe5d20e=_0x45cc23,{id:_0x471c27}=_0x4b480c[_0xe5d20e(0x15f)],_0x4b21ab=await this[_0xe5d20e(0x266)]['count']({'where':{'userId':_0x471c27,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x212363=await this['getMjDefaultParams'](_0x5a57b0)['catch'](_0x5f14fd=>{const _0x83a163=_0xe5d20e;return Promise[_0x83a163(0x150)](_0x5f14fd);});if(!_0x212363)throw new common_1[(_0xe5d20e(0x281))](_0xe5d20e(0x223),common_1[_0xe5d20e(0x156)]['BAD_REQUEST']);const _0x2f6c81=await this['globalConfigService'][_0xe5d20e(0x1c8)]([_0xe5d20e(0x1ea)]),_0x4eca72=_0x2f6c81?Number(_0x2f6c81):0xa;if(_0x4b21ab>=_0x4eca72)throw new common_1[(_0xe5d20e(0x281))](_0xe5d20e(0x174)+_0x4eca72+_0xe5d20e(0x233),common_1[_0xe5d20e(0x156)][_0xe5d20e(0x1cb)]);}async[_0x45cc23(0x2cb)](_0x15033e){const _0x4c626c=_0x45cc23,{page:page=0x1,size:size=0x14,rec:_0x5cacf0,squareType:_0x2bf25e,userId:_0x167cac,status:_0xb5d66,favorite:favorite=0x0,keyword:_0x5d40da}=_0x15033e,_0x4bd5e8={};_0x167cac&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'userId':_0x167cac}),favorite&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'favorite':favorite}),_0x5cacf0&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'rec':_0x5cacf0}),_0x5d40da&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'prompt':(0x0,typeorm_2[_0x4c626c(0x274)])('%'+_0x5d40da+'%')}),_0xb5d66>0x0&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'status':_0xb5d66}),_0x2bf25e!==''&&Object[_0x4c626c(0x1de)](_0x4bd5e8,{'squareType':_0x2bf25e});const [_0x34b14e,_0x194b2c]=await this[_0x4c626c(0x266)][_0x4c626c(0x1ed)]({'where':_0x4bd5e8,'take':size,'order':{'id':'DESC'},'skip':(page-0x1)*size,'select':[_0x4c626c(0x27b),_0x4c626c(0x1ae),'action',_0x4c626c(0x271),_0x4c626c(0x22f),_0x4c626c(0x256),_0x4c626c(0x1a9),_0x4c626c(0x1c7),_0x4c626c(0x2a5),'id',_0x4c626c(0x1be),_0x4c626c(0x15a),_0x4c626c(0x1ae),_0x4c626c(0x16d),_0x4c626c(0x16a),_0x4c626c(0x2b5)]});return _0x34b14e['forEach'](_0x3bd4e9=>{const _0x582766=_0x4c626c;_0x3bd4e9[_0x582766(0x27b)]=_0x3bd4e9[_0x582766(0x27b)]?JSON[_0x582766(0x20f)](_0x3bd4e9[_0x582766(0x27b)]):{};}),{'rows':_0x34b14e,'count':_0x194b2c};}async[_0x45cc23(0x1f2)](_0xd3e6b9,_0x41106d){const _0x32903f=_0x45cc23;try{let _0xb2e660,_0xd61bdc,_0x60fdb9,_0x3b5297;const {jobId:_0x920b8e,detail:_0x117ed6}=_0x41106d;if(_0xd3e6b9[_0x32903f(0x154)][_0x32903f(0x291)]){const _0x5170cc=_0xd3e6b9['headers']['authorization'][_0x32903f(0x2bd)]('\x20'),_0x9b3c39=jwt[_0x32903f(0x175)](_0x5170cc[0x1],process[_0x32903f(0x1e9)][_0x32903f(0x27a)]);_0xd61bdc=_0x9b3c39['id'];}const _0x1aea2c=await this[_0x32903f(0x266)][_0x32903f(0x155)]({'where':{'jobId':_0x920b8e}});return _0x117ed6&&(this[_0x32903f(0x151)][_0x32903f(0x246)](model_constant_1[_0x32903f(0x15b)][_0x32903f(0x2c1)],_0x1aea2c['id']),_0xb2e660=await this[_0x32903f(0x2c8)][_0x32903f(0x155)]({'where':{'id':_0x1aea2c[_0x32903f(0x206)]}}),_0x60fdb9=await this[_0x32903f(0x151)][_0x32903f(0x2a4)](model_constant_1[_0x32903f(0x15b)][_0x32903f(0x2c1)],_0x1aea2c['id']),_0xd61bdc&&(_0x3b5297=await this[_0x32903f(0x151)][_0x32903f(0x235)](model_constant_1['EModelType'][_0x32903f(0x2c1)],_0x1aea2c['id']))),{..._0x1aea2c,'avatar':_0xb2e660?_0xb2e660['avatar']:null,'username':_0xb2e660?_0xb2e660[_0x32903f(0x24f)]:null,'nickname':_0xb2e660?_0xb2e660[_0x32903f(0x1a7)]:null,'visitNum':_0x60fdb9?_0x60fdb9[_0x32903f(0x21d)]:0x0,'agreeNum':_0x60fdb9?_0x60fdb9[_0x32903f(0x1bc)]:0x0,'agree':_0x3b5297?_0x3b5297[_0x32903f(0x196)]:null};}catch(_0x2fd6ce){throw new common_1['HttpException'](_0x2fd6ce[_0x32903f(0x172)],common_1['HttpStatus'][_0x32903f(0x1cb)]);}}async[_0x45cc23(0x287)](_0x55108d,_0x16ad1d){const _0x4f8a7d=_0x45cc23;try{if(!_0x16ad1d[_0x4f8a7d(0x193)]||!_0x16ad1d[_0x4f8a7d(0x193)][_0x4f8a7d(0x1cd)])return[];const _0x4c1001=_0x16ad1d[_0x4f8a7d(0x193)]['split'](','),_0x1657ad=await this[_0x4f8a7d(0x266)][_0x4f8a7d(0x164)]({'where':{'jobId':(0x0,typeorm_2['In'])(_0x4c1001)}});return _0x1657ad;}catch(_0x53f280){throw new common_1[(_0x4f8a7d(0x281))](_0x53f280['message'],common_1[_0x4f8a7d(0x156)][_0x4f8a7d(0x1cb)]);}}async[_0x45cc23(0x29d)](_0x40254d,_0x4ccb91){const _0x54f9bb=_0x45cc23;try{const {page:page=0x1,size:size=0xa,rec:_0x2d693c,userId:_0x39a838,status:_0x44e373}=_0x4ccb91,_0x169e71={};_0x2d693c!==null&&_0x2d693c!==undefined&&(_0x169e71[_0x54f9bb(0x16a)]=_0x2d693c);_0x39a838&&(_0x169e71['userId']=_0x39a838);_0x44e373&&(_0x169e71[_0x54f9bb(0x23a)]=_0x44e373);const [_0x1d2dd3,_0x29ce31]=await this[_0x54f9bb(0x266)]['findAndCount']({'where':_0x169e71,'order':{'id':_0x54f9bb(0x298)},'take':size,'skip':(page-0x1)*size}),_0x2d8bc8=_0x1d2dd3[_0x54f9bb(0x229)](_0x4d4749=>_0x4d4749[_0x54f9bb(0x206)])[_0x54f9bb(0x19d)](_0x9f1881=>_0x9f1881<0x186a0),_0x79dbe1=await this[_0x54f9bb(0x2c8)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2d8bc8)},'select':['id',_0x54f9bb(0x24f),_0x54f9bb(0x247),_0x54f9bb(0x1eb),_0x54f9bb(0x289),_0x54f9bb(0x1a7)]});return _0x1d2dd3[_0x54f9bb(0x1e2)](_0x2b6335=>{const _0x579e07=_0x54f9bb,_0x340dc3=_0x79dbe1[_0x579e07(0x164)](_0x337a10=>_0x337a10['id']===_0x2b6335[_0x579e07(0x206)]);_0x40254d[_0x579e07(0x15f)][_0x579e07(0x1db)]!=='super'&&(_0x340dc3[_0x579e07(0x1eb)]=(0x0,utils_1['hideString'])(_0x340dc3[_0x579e07(0x1eb)]),_0x340dc3[_0x579e07(0x289)]=(0x0,utils_1[_0x579e07(0x17b)])(_0x340dc3['phone'])),_0x2b6335['userInfo']=_0x340dc3,_0x2b6335[_0x579e07(0x27f)]=![];}),{'rows':_0x1d2dd3,'count':_0x29ce31};}catch(_0x838b19){throw new common_1[(_0x54f9bb(0x281))](_0x54f9bb(0x2c0),common_1['HttpStatus']['BAD_REQUEST']);}}async['recDraw'](_0x388525){const _0x1fadcb=_0x45cc23,{id:_0x195af3,squareType:_0x3cb505}=_0x388525,_0x3d0ffc=await this[_0x1fadcb(0x266)]['findOne']({'where':{'id':_0x195af3,'status':midjourney_constant_1[_0x1fadcb(0x28b)][_0x1fadcb(0x170)]}});if(!_0x3d0ffc)throw new common_1[(_0x1fadcb(0x281))](_0x1fadcb(0x2a9),common_1[_0x1fadcb(0x156)][_0x1fadcb(0x1cb)]);const _0x131cc8=await this[_0x1fadcb(0x266)]['update']({'id':_0x195af3},{'rec':0x1,'squareType':_0x3cb505})[_0x1fadcb(0x168)](_0x2725f6=>{const _0x434d59=_0x1fadcb;throw new common_1[(_0x434d59(0x281))](_0x2725f6,common_1[_0x434d59(0x156)][_0x434d59(0x1cb)]);});if(_0x131cc8[_0x1fadcb(0x226)]<=0x0)throw new common_1[(_0x1fadcb(0x281))](_0x1fadcb(0x28d),common_1[_0x1fadcb(0x156)]['BAD_REQUEST']);return await this[_0x1fadcb(0x200)][_0x1fadcb(0x197)]({'key':_0x1fadcb(0x25f)}),!![];}async[_0x45cc23(0x218)](_0x4137aa){const _0x1d04aa=_0x45cc23,{id:_0x3ea410,favorite:_0x536046}=_0x4137aa,_0x558b89=await this[_0x1d04aa(0x266)]['findOne']({'where':{'id':_0x3ea410}})['catch'](_0x3a9fc4=>{const _0x4eeaf2=_0x1d04aa;common_1[_0x4eeaf2(0x19c)][_0x4eeaf2(0x275)](_0x3a9fc4);});if(!_0x558b89)throw new common_1[(_0x1d04aa(0x281))](_0x1d04aa(0x2a9),common_1[_0x1d04aa(0x156)][_0x1d04aa(0x1cb)]);const _0x489913=await this[_0x1d04aa(0x266)][_0x1d04aa(0x185)]({'id':_0x3ea410},{'favorite':_0x536046});if(_0x489913[_0x1d04aa(0x226)]<=0x0)throw new common_1['HttpException'](_0x1d04aa(0x28d),common_1[_0x1d04aa(0x156)][_0x1d04aa(0x1cb)]);return!![];}async['cleanQueue'](){const _0x58cc2c=_0x45cc23;try{await this['midjourneyEntity'][_0x58cc2c(0x185)]({'status':0x2},{'status':0x4});}catch(_0x47de29){console[_0x58cc2c(0x2c4)](_0x58cc2c(0x1b8),_0x47de29);}}async[_0x45cc23(0x1e1)](_0x5bc245,_0x502f8e){const _0x39aa0f=_0x45cc23,{id:_0x205554}=_0x502f8e;if(!_0x205554)throw new common_1['HttpException']('非法操作！',common_1[_0x39aa0f(0x156)][_0x39aa0f(0x1cb)]);const _0x5a996=await this[_0x39aa0f(0x266)]['delete']({'id':_0x205554});if(_0x5a996['affected']<=0x0)throw new common_1[(_0x39aa0f(0x281))](_0x39aa0f(0x1b0),common_1['HttpStatus'][_0x39aa0f(0x1cb)]);return!![];}async[_0x45cc23(0x1fc)](_0x1109db,_0xeb2f59){const _0x62ba1a=_0x45cc23;try{const {prompt:_0x5875e8,status:_0x6c33c1,isCarryParams:_0x1dd471,imageUrl:_0x2eaa11,title:_0xf900f7,order:_0x281eca,id:_0x2c5171,aspect:_0x253460}=_0xeb2f59;return _0x2c5171?await this[_0x62ba1a(0x2b4)]['update']({'id':_0x2c5171},{'title':_0xf900f7,'prompt':_0x5875e8,'imageUrl':_0x2eaa11,'status':_0x6c33c1,'isCarryParams':_0x1dd471,'order':_0x281eca,'aspect':_0x253460})[_0x62ba1a(0x19b)](_0x47b9f0=>!!_0x47b9f0):await this[_0x62ba1a(0x2b4)][_0x62ba1a(0x2d3)]({'prompt':_0x5875e8,'status':_0x6c33c1,'imageUrl':_0x2eaa11,'isCarryParams':_0x1dd471,'title':_0xf900f7,'order':_0x281eca,'aspect':_0x253460})[_0x62ba1a(0x19b)](_0x33d2a8=>!!_0x33d2a8);}catch(_0x4f1d6d){console[_0x62ba1a(0x2c4)](_0x62ba1a(0x1b4),_0x4f1d6d);}}async[_0x45cc23(0x186)](_0xc08c1f,_0x384dd6){const _0x37b95c=_0x45cc23,{id:_0x1bb773}=_0x384dd6;if(!_0x1bb773)throw new common_1[(_0x37b95c(0x281))]('非法操作！',common_1[_0x37b95c(0x156)][_0x37b95c(0x1cb)]);return await this['mjPromptsEntity'][_0x37b95c(0x240)]({'id':_0x1bb773});}async[_0x45cc23(0x1fd)](){const _0x947c72=_0x45cc23;return await this[_0x947c72(0x2b4)][_0x947c72(0x164)]({'order':{'order':_0x947c72(0x298)}})[_0x947c72(0x19b)](_0x695cbd=>_0x695cbd||[])[_0x947c72(0x168)](_0x351539=>{const _0x596101=_0x947c72;common_1[_0x596101(0x19c)][_0x596101(0x275)](_0x351539);});}async[_0x45cc23(0x22c)](_0x38d313){const _0xb40318=_0x45cc23;try{const {page:_0x534ccd,size:_0x33edb0,keyword:_0x4352b1}=_0x38d313,[_0x382104,_0x1039f6]=await this['mjPromptsEntity'][_0xb40318(0x1ed)]({'where':[{'status':!![],'title':(0x0,typeorm_2[_0xb40318(0x274)])('%'+_0x4352b1+'%')},{'status':!![],'prompt':(0x0,typeorm_2[_0xb40318(0x274)])('%'+_0x4352b1+'%')}],'take':_0x33edb0,'skip':(_0x534ccd-0x1)*_0x33edb0,'order':{'order':'DESC'}});return{'rows':_0x382104,'count':_0x1039f6};}catch(_0x59e205){throw new common_1['HttpException'](_0x59e205[_0xb40318(0x172)],common_1[_0xb40318(0x156)]['BAD_REQUEST']);}}async[_0x45cc23(0x259)](_0x283e31){const {mode:_0x4da94e}=_0x283e31;}async[_0x45cc23(0x2dd)](_0x5f0784){const _0x54334a=_0x45cc23;try{const {name:_0x34f98b,value:_0xfd84ba}=_0x5f0784,_0x3da063=await this[_0x54334a(0x20a)][_0x54334a(0x2d7)]({'name':_0x34f98b});if(_0x3da063)throw new common_1[(_0x54334a(0x281))](_0x54334a(0x264),common_1['HttpStatus']['BAD_REQUEST']);return await this['mjInspireClassifyEntity']['save']({'name':_0x34f98b,'value':_0xfd84ba})[_0x54334a(0x19b)](_0x1b88ab=>!!_0x1b88ab)[_0x54334a(0x168)](_0x3a77fe=>{const _0x3d6d39=_0x54334a;console[_0x3d6d39(0x2c4)](_0x3a77fe);throw new common_1[(_0x3d6d39(0x281))](_0x3a77fe,common_1[_0x3d6d39(0x156)][_0x3d6d39(0x1cb)]);});}catch(_0x2e15d8){return![];}}async[_0x45cc23(0x260)](_0x38a741){const _0x2f6a0f=_0x45cc23,{id:_0x2e66e4,name:_0xaa12d1,value:_0x44cd32}=_0x38a741;return await this['mjInspireClassifyEntity'][_0x2f6a0f(0x185)](_0x2e66e4,{'name':_0xaa12d1,'value':_0x44cd32})[_0x2f6a0f(0x19b)](_0xa1e959=>!!_0xa1e959);}async[_0x45cc23(0x18a)](_0x4d758c){const _0x3b14e3=_0x45cc23,{id:_0x5df9d4}=_0x4d758c;return await this['mjInspireClassifyEntity']['delete']({'id':_0x5df9d4})[_0x3b14e3(0x168)](_0x137e85=>{const _0x56a68d=_0x3b14e3;throw new common_1[(_0x56a68d(0x281))](_0x137e85,common_1['HttpStatus'][_0x56a68d(0x1cb)]);});}async[_0x45cc23(0x1c5)](_0x19ed3a){const _0x4112ed=_0x45cc23,{size:_0x1414a9,page:_0x3a172b}=_0x19ed3a,_0x3b933d=await this[_0x4112ed(0x20a)][_0x4112ed(0x1ed)]({'order':{'createdAt':_0x4112ed(0x298)},'take':_0x1414a9,'skip':(_0x3a172b-0x1)*_0x1414a9})[_0x4112ed(0x168)](_0x3e0cda=>{const _0x53d27e=_0x4112ed;throw new common_1[(_0x53d27e(0x281))](_0x3e0cda,common_1[_0x53d27e(0x156)][_0x53d27e(0x1cb)]);});if(!_0x3b933d)throw new common_1[(_0x4112ed(0x281))]('查询灵感分类失败',common_1[_0x4112ed(0x156)][_0x4112ed(0x1cb)]);const [_0x59aba5,_0x4bff4d]=_0x3b933d;return{'rows':_0x59aba5,'count':_0x4bff4d};}async[_0x45cc23(0x297)](_0x32094f){const _0x2929e8=_0x45cc23,{id:_0xaa684e}=_0x32094f;return await this[_0x2929e8(0x20a)]['findOne']({'where':{'id':_0xaa684e}});}async['addMjIncantationClassify'](_0x43e3ba){const _0x1fec41=_0x45cc23;try{const {classifyName:_0x370908,level:_0xaffe21,type:_0x16ba24,pid:pid=0x0}=_0x43e3ba;return await this['mjIncantationClassifyEntity']['save']({'classifyName':_0x370908,'level':_0xaffe21,'type':_0x16ba24,'pid':pid})[_0x1fec41(0x19b)](_0x1577a9=>!!_0x1577a9)[_0x1fec41(0x168)](_0x5e5f32=>{const _0x379cf1=_0x1fec41;console[_0x379cf1(0x2c4)](_0x5e5f32);throw new common_1['HttpException'](_0x5e5f32,common_1[_0x379cf1(0x156)]['BAD_REQUEST']);});}catch(_0x15f0a3){return![];}}async[_0x45cc23(0x1e7)](_0x5a02b2){const _0x30c30f=_0x45cc23,{id:_0x44630d,classifyName:_0x3e4d43,level:_0x428d61,type:_0x1268ff,pid:_0x13ea00}=_0x5a02b2;return this[_0x30c30f(0x236)]['transaction'](async()=>{const _0x31999c=_0x30c30f,_0x115621=await this['mjIncantationClassifyEntity'][_0x31999c(0x155)]({'where':{'id':_0x44630d}});_0x115621[_0x31999c(0x248)]!==_0x1268ff&&await this[_0x31999c(0x288)]['update']({'pid':_0x44630d},{'type':_0x1268ff}),await this[_0x31999c(0x288)][_0x31999c(0x185)](_0x44630d,{'classifyName':_0x3e4d43,'level':_0x428d61,'type':_0x1268ff,'pid':_0x13ea00});}),!![];}async[_0x45cc23(0x1d6)](_0x5c16f9){const _0x56fe50=_0x45cc23,{id:_0xa5fa80}=_0x5c16f9;return await this[_0x56fe50(0x288)][_0x56fe50(0x240)]({'id':_0xa5fa80})[_0x56fe50(0x19b)](_0x316c41=>_0x316c41[_0x56fe50(0x226)]>0x0);}async[_0x45cc23(0x157)](_0x32a262){const _0x623781=_0x45cc23,{id:_0x195632}=_0x32a262;return await this[_0x623781(0x288)]['findOne']({'where':{'id':_0x195632}});}async['queryTopMjIncantationClassify'](){const _0x4ab6a1=_0x45cc23;return this['mjIncantationClassifyEntity'][_0x4ab6a1(0x164)]({'where':{'level':0x1}});}async['queryMjIncantationClassify'](_0x4319c3){const _0x249166=_0x45cc23,{size:_0x330a29,page:_0xf3c98e,type:_0x5416b7,keyword:_0x28f941,level:_0x49ce2e}=_0x4319c3;let _0x2ddb4d={};_0x49ce2e>0x0&&(_0x2ddb4d[_0x249166(0x19f)]=_0x49ce2e);_0x5416b7&&(_0x2ddb4d[_0x249166(0x248)]=_0x5416b7);_0x28f941&&(_0x2ddb4d[_0x249166(0x1d2)]=(0x0,typeorm_2['Like'])('%'+_0x28f941+'%'));const _0x33e542=await this[_0x249166(0x288)][_0x249166(0x1ed)]({'order':{'createdAt':_0x249166(0x298)},'where':_0x2ddb4d,'take':_0x330a29,'skip':(_0xf3c98e-0x1)*_0x330a29})['catch'](_0x1a652a=>{const _0x40e2a2=_0x249166;console[_0x40e2a2(0x2c4)](_0x1a652a);});if(!_0x33e542)throw new common_1['HttpException'](_0x249166(0x26b),common_1[_0x249166(0x156)][_0x249166(0x1cb)]);const [_0xccf176,_0x125d66]=_0x33e542;return{'rows':_0xccf176,'count':_0x125d66};}async[_0x45cc23(0x23d)](_0x23f719){const _0x29a4d1=_0x45cc23,{level:_0x24394f,type:_0x323a16}=_0x23f719,_0x533f2e={};_0x24394f===0x0?_0x533f2e['level']=(0x0,typeorm_2[_0x29a4d1(0x2e4)])(_0x24394f):_0x533f2e[_0x29a4d1(0x19f)]=_0x24394f;_0x323a16&&(_0x533f2e[_0x29a4d1(0x248)]=_0x323a16);const _0x51235d=await this[_0x29a4d1(0x288)]['findBy'](_0x533f2e)[_0x29a4d1(0x168)](_0x5d9617=>{const _0x59f55f=_0x29a4d1;console[_0x59f55f(0x2c4)](_0x5d9617);});if(!_0x51235d)throw new common_1['HttpException'](_0x29a4d1(0x26b),common_1['HttpStatus'][_0x29a4d1(0x1cb)]);if(_0x24394f===0x0)return{'level1':_0x51235d[_0x29a4d1(0x19d)](_0x29e99f=>_0x29e99f[_0x29a4d1(0x19f)]===0x1),'level2':_0x51235d[_0x29a4d1(0x19d)](_0x557de1=>_0x557de1['level']===0x2)};return _0x51235d;}async['addMjIncantation'](_0x26b757){const _0x4c7576=_0x45cc23;try{const {incantationEn:_0xc1faac,incantationCn:_0x2f2f66,img:_0x3fd9b7,pid:_0x48ab39}=_0x26b757;return await this[_0x4c7576(0x284)][_0x4c7576(0x2d3)]({'incantationEn':_0xc1faac,'incantationCn':_0x2f2f66,'img':_0x3fd9b7,'pid':_0x48ab39})['then'](_0xbf987b=>!!_0xbf987b)[_0x4c7576(0x168)](_0x2a0667=>{throw _0x2a0667;});}catch(_0x199780){return console[_0x4c7576(0x2c4)](_0x199780),![];}}async[_0x45cc23(0x2ca)](_0xc308e3){const {id:_0x20d992,incantationEn:_0x525b31,incantationCn:_0x432575,img:_0x245546,pid:_0x25754f}=_0xc308e3;return await this['mjIncantationEntity']['update'](_0x20d992,{'incantationCn':_0x432575,'incantationEn':_0x525b31,'img':_0x245546,'pid':_0x25754f});}async[_0x45cc23(0x2b3)](_0x470489){const _0x21fa8b=_0x45cc23,{id:_0x4a8ae4}=_0x470489;return await this[_0x21fa8b(0x284)][_0x21fa8b(0x240)]({'id':_0x4a8ae4})[_0x21fa8b(0x19b)](_0x5351f3=>_0x5351f3[_0x21fa8b(0x226)]>0x0);}async['getMjIncantation'](_0x1d0b75){const _0x3987fa=_0x45cc23,{id:_0x5631c1}=_0x1d0b75;return await this['mjIncantationEntity'][_0x3987fa(0x155)]({'where':{'id':_0x5631c1}});}async[_0x45cc23(0x1fa)](_0x4efd3c){const _0x2e0c62=_0x45cc23,{size:_0xebf437,page:_0x378f34,keyword:_0x1041e1,pid:_0x3df338}=_0x4efd3c;let _0x2274b1={};_0x3df338>0x0&&(_0x2274b1[_0x2e0c62(0x15d)]=_0x3df338);_0x1041e1&&(_0x2274b1[_0x2e0c62(0x2d6)]=(0x0,typeorm_2['Like'])('%'+_0x1041e1+'%'));const _0x273951=await this['mjIncantationEntity'][_0x2e0c62(0x1ed)]({'order':{'createdAt':_0x2e0c62(0x298)},'where':_0x2274b1,'take':_0xebf437,'skip':(_0x378f34-0x1)*_0xebf437})['catch'](_0x2e85d1=>{const _0x4a1b20=_0x2e0c62;console[_0x4a1b20(0x2c4)](_0x2e85d1);});if(!_0x273951)throw new common_1[(_0x2e0c62(0x281))](_0x2e0c62(0x20b),common_1['HttpStatus'][_0x2e0c62(0x1cb)]);const [_0x10b5ce,_0x5da365]=_0x273951;return{'rows':_0x10b5ce,'count':_0x5da365};}async[_0x45cc23(0x20c)](_0x4dc3aa){const _0x3a2117=_0x45cc23,{id:_0x1ac055}=_0x4dc3aa,_0x1c120f=await this[_0x3a2117(0x288)][_0x3a2117(0x155)]({'where':{'level':0x1,'id':_0x1ac055}})[_0x3a2117(0x168)](_0x2dad61=>{const _0x1f6232=_0x3a2117;common_1[_0x1f6232(0x19c)][_0x1f6232(0x275)](_0x2dad61);});if(!_0x1c120f)throw new common_1[(_0x3a2117(0x281))](_0x3a2117(0x2da),common_1[_0x3a2117(0x156)]['BAD_REQUEST']);const _0x29df0e=await this[_0x3a2117(0x288)][_0x3a2117(0x164)]({'where':{'level':0x2,'pid':_0x1c120f['id']}})[_0x3a2117(0x168)](_0x598fbe=>{const _0x1fcb4a=_0x3a2117;common_1[_0x1fcb4a(0x19c)]['error'](_0x598fbe);});if(!_0x29df0e||_0x29df0e['length']===0x0)return{'rows':[]};const _0x2439a5=_0x29df0e[_0x3a2117(0x229)](_0x2d4612=>_0x2d4612['id']),_0x4d3bf1=await this[_0x3a2117(0x284)][_0x3a2117(0x164)]({'where':{'pid':(0x0,typeorm_2['In'])(_0x2439a5)}})[_0x3a2117(0x168)](_0x25e41f=>{const _0x2d3d56=_0x3a2117;common_1[_0x2d3d56(0x19c)][_0x2d3d56(0x275)](_0x25e41f);});if(!_0x4d3bf1)throw new common_1['HttpException'](_0x3a2117(0x20b),common_1[_0x3a2117(0x156)][_0x3a2117(0x1cb)]);const _0x1e86e4=_0x29df0e[_0x3a2117(0x229)](_0x50fb36=>{const _0x2509a3=_0x3a2117;return{'children':_0x4d3bf1[_0x2509a3(0x19d)](_0x626355=>_0x626355['pid']===_0x50fb36['id'])||[],..._0x50fb36};});return{'rows':_0x1e86e4};}async['queryMjIncantationAll'](){const _0x1a6d4b=_0x45cc23,_0x6b9346=await this[_0x1a6d4b(0x284)][_0x1a6d4b(0x164)]({'order':{'createdAt':_0x1a6d4b(0x298)}})[_0x1a6d4b(0x168)](_0x33dab3=>{const _0x4185f0=_0x1a6d4b;console[_0x4185f0(0x2c4)](_0x33dab3);});if(!_0x6b9346)throw new common_1[(_0x1a6d4b(0x281))](_0x1a6d4b(0x20b),common_1[_0x1a6d4b(0x156)]['BAD_REQUEST']);return _0x6b9346;}async[_0x45cc23(0x237)](_0x108a36){const _0x1efacd=_0x45cc23,{id:_0x3bc47b,suggestCn:_0x2f0d3e,suggestEn:_0xc805b4,order:_0x33b0bd,image:_0xa8de98}=_0x108a36,_0x2ba0d0=await this['mjSuggestWordEntity'][_0x1efacd(0x155)]({'where':{'suggestCn':_0x2f0d3e}});if(_0x3bc47b){if(_0x2ba0d0&&_0x2ba0d0['id']!==_0x3bc47b)throw new common_1[(_0x1efacd(0x281))]('推荐关键词已存在，不可重复添加',common_1[_0x1efacd(0x156)][_0x1efacd(0x1cb)]);}else{if(_0x2ba0d0)throw new common_1[(_0x1efacd(0x281))](_0x1efacd(0x21e),common_1['HttpStatus'][_0x1efacd(0x1cb)]);}const _0xae3b1d=await this['mjSuggestWordEntity'][_0x1efacd(0x2d3)]({'id':_0x3bc47b,'suggestCn':_0x2f0d3e,'suggestEn':_0xc805b4,'order':_0x33b0bd||0x64,'image':_0xa8de98||''})[_0x1efacd(0x19b)](_0xa70580=>!!_0xa70580['id'])[_0x1efacd(0x168)](_0x3c9a8=>{const _0x225d88=_0x1efacd;console[_0x225d88(0x2c4)](_0x3c9a8);});if(!_0xae3b1d)throw new common_1['HttpException'](_0x1efacd(0x268),common_1['HttpStatus']['BAD_REQUEST']);return _0xae3b1d;}async[_0x45cc23(0x2b0)](_0x254489){const _0x5ee1f2=_0x45cc23,{id:_0x327e3b}=_0x254489,_0x4a372f=await this[_0x5ee1f2(0x18c)]['exist']({'where':{'id':_0x327e3b}});if(!_0x4a372f)throw new common_1[(_0x5ee1f2(0x281))](_0x5ee1f2(0x2c7),common_1[_0x5ee1f2(0x156)][_0x5ee1f2(0x1cb)]);const _0x35dcde=await this[_0x5ee1f2(0x18c)]['delete'](_0x327e3b)[_0x5ee1f2(0x19b)](_0xc624a7=>_0xc624a7['affected']>0x0)['catch'](_0x4a45d9=>{const _0x1f53b3=_0x5ee1f2;console[_0x1f53b3(0x2c4)](_0x4a45d9);});if(!_0x35dcde)throw new common_1['HttpException'](_0x5ee1f2(0x261),common_1['HttpStatus']['BAD_REQUEST']);return _0x35dcde;}async[_0x45cc23(0x2d1)](_0x415102){const _0x3826ce=_0x45cc23;let _0xf7cd6={};const {page:_0x129f8a,size:_0x3a3db0}=_0x415102,_0x2999ae=await this['mjSuggestWordEntity'][_0x3826ce(0x1ed)]({'where':_0xf7cd6,'take':_0x3a3db0,'skip':(_0x129f8a-0x1)*_0x3a3db0,'order':{'order':'DESC'}})['then'](([_0x173df7,_0x32f491])=>({'rows':_0x173df7,'count':_0x32f491}))[_0x3826ce(0x168)](_0x20689e=>{const _0x4dedd7=_0x3826ce;console[_0x4dedd7(0x2c4)](_0x20689e);});if(!_0x2999ae)throw new common_1['HttpException'](_0x3826ce(0x225),common_1[_0x3826ce(0x156)]['BAD_REQUEST']);return _0x2999ae;}['convertMode4Transfer'](_0x4e5333){const _0x59a071=_0x45cc23;if(!_0x4e5333)return _0x59a071(0x190);if(_0x4e5333===midjourney_constant_1[_0x59a071(0x187)][_0x59a071(0x190)])return _0x59a071(0x190);if(_0x4e5333===midjourney_constant_1[_0x59a071(0x187)][_0x59a071(0x2c5)])return _0x59a071(0x2c5);if(_0x4e5333===midjourney_constant_1[_0x59a071(0x187)][_0x59a071(0x1ac)])return'turbo';return _0x59a071(0x190);}async[_0x45cc23(0x2a2)](_0x35408d){const _0x379b3c=_0x45cc23,_0x42e9c8=await this[_0x379b3c(0x208)][_0x379b3c(0x20d)]({'data':{'ids':[_0x35408d]}});common_1['Logger'][_0x379b3c(0x2c4)]('Modal\x20状态\x20手动同步任务信息'),this[_0x379b3c(0x1f7)](_0x42e9c8[0x0]);}async[_0x45cc23(0x1a2)](_0x874dd6){const _0x30aa7c=_0x45cc23,_0x5cf6de=await this[_0x30aa7c(0x2a7)]['getUserById'](_0x874dd6[_0x30aa7c(0x15f)]['id']),_0x1895d9={'fast':0x0,'relax':0x0,'trubo':0x0};let _0x31090e=redisKey_constant_1[_0x30aa7c(0x1a1)]+'-'+_0x5cf6de['id']+'-';if(_0x5cf6de[_0x30aa7c(0x250)]||_0x5cf6de['lifetimeVip']){const [_0x4630a3,_0x3d7a8c,_0x347e04]=await Promise[_0x30aa7c(0x1bb)]([this[_0x30aa7c(0x200)][_0x30aa7c(0x1f4)]({'key':_0x31090e+_0x30aa7c(0x29f)}),this[_0x30aa7c(0x200)][_0x30aa7c(0x1f4)]({'key':_0x31090e+_0x30aa7c(0x2bb)}),this['redisCacheService']['get']({'key':_0x31090e+_0x30aa7c(0x189)})]);_0x1895d9[_0x30aa7c(0x190)]=Number(_0x4630a3||0x0),_0x1895d9['relax']=Number(_0x3d7a8c||0x0),_0x1895d9[_0x30aa7c(0x177)]=Number(_0x347e04||0x0);}return _0x1895d9;}async[_0x45cc23(0x1f7)](_0x5b38a5){const _0x11a3e5=_0x45cc23;common_1[_0x11a3e5(0x19c)]['log'](_0x5b38a5,'MJ\x20通知内容：');try{let _0xd3b7b4=[];const _0x3ae028=midjourney_constant_1['MjpStateMap'][_0x11a3e5(0x1f4)](_0x5b38a5[_0x11a3e5(0x23a)]),_0x28a163=_0x5b38a5[_0x11a3e5(0x1b6)]?parseFloat(_0x5b38a5[_0x11a3e5(0x1b6)]):null;let _0x3f0c3d=await this[_0x11a3e5(0x266)][_0x11a3e5(0x155)]({'where':{'mjpTaskId':_0x5b38a5['id']}});if(_0x5b38a5[_0x11a3e5(0x23a)]==='MODAL'&&_0x3f0c3d[_0x11a3e5(0x249)]){common_1[_0x11a3e5(0x19c)][_0x11a3e5(0x2c4)](_0x11a3e5(0x255),_0x11a3e5(0x1df));return;}_0x5b38a5[_0x11a3e5(0x25b)]&&(_0xd3b7b4=_0x5b38a5[_0x11a3e5(0x25b)][_0x11a3e5(0x19d)](_0x4fc842=>_0x4fc842[_0x11a3e5(0x296)]!==_0x11a3e5(0x1b9)&&_0x4fc842[_0x11a3e5(0x296)]!==_0x11a3e5(0x24e)&&_0x4fc842[_0x11a3e5(0x1da)]!=='❤️'));MjConfig_1[_0x11a3e5(0x194)][_0x11a3e5(0x28f)]&&_0x5b38a5['imageUrl']&&(_0x5b38a5['imageUrl']=_0x5b38a5['imageUrl'][_0x11a3e5(0x1e3)](_0x11a3e5(0x2a1),MjConfig_1[_0x11a3e5(0x194)]['mjProxyImgUrl']));const _0x5a730b={'id':_0x3f0c3d['id'],'status':_0x3ae028,'progress':_0x28a163,'buttons':_0xd3b7b4,'durationSpent':null,'imageUrl':_0x5b38a5[_0x11a3e5(0x15a)],'failReason':_0x5b38a5['failReason']};return _0x5b38a5[_0x11a3e5(0x196)]===_0x11a3e5(0x2db)&&(_0x5a730b[_0x11a3e5(0x22f)]=_0x5b38a5[_0x11a3e5(0x22f)]||_0x5a730b[_0x11a3e5(0x22f)]||''),_0x5b38a5[_0x11a3e5(0x196)]===_0x11a3e5(0x2ab)&&(_0x5a730b[_0x11a3e5(0x16d)]=_0x5b38a5[_0x11a3e5(0x1aa)]?.['finalPrompt']),_0x5b38a5[_0x11a3e5(0x21a)]&&_0x5b38a5[_0x11a3e5(0x2b2)]&&(_0x5a730b[_0x11a3e5(0x257)]=(_0x5b38a5[_0x11a3e5(0x21a)]-_0x5b38a5[_0x11a3e5(0x2b2)])/0x3e8),_0x3f0c3d=await this[_0x11a3e5(0x266)][_0x11a3e5(0x2d3)](_0x5a730b),_0x5b38a5['status']==='SUCCESS'&&_0x5b38a5['imageUrl']&&this[_0x11a3e5(0x1d1)][_0x11a3e5(0x23f)](_0x3f0c3d['id'],_0x3f0c3d[_0x11a3e5(0x15a)]),null;}catch(_0x52fc37){common_1[_0x11a3e5(0x19c)][_0x11a3e5(0x275)](_0x11a3e5(0x24d),_0x52fc37);}}async[_0x45cc23(0x1ee)](){const _0x267420=_0x45cc23;try{const _0x3be42c=await this[_0x267420(0x266)][_0x267420(0x164)]({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x3be42c[_0x267420(0x1cd)])for(let _0x58b633=0x0;_0x58b633<_0x3be42c[_0x267420(0x1cd)];_0x58b633++){const _0x37cc60=redisKey_constant_1['MJ_TASK_UPDATE']+_0x3be42c[_0x58b633][_0x267420(0x270)],_0x585127=await this[_0x267420(0x200)][_0x267420(0x1f4)]({'key':_0x37cc60});if(_0x585127)continue;else this[_0x267420(0x200)][_0x267420(0x2e0)]({'key':_0x37cc60,'val':_0x267420(0x171)}),this['mjpTaskService'][_0x267420(0x20d)]({'data':{'ids':[_0x3be42c[_0x58b633][_0x267420(0x270)]]}})['then'](async _0x3f1bbf=>{const _0x2c92d9=_0x267420,_0x1548f2=_0x3f1bbf[0x0],_0x517229=_0x3be42c[_0x58b633],_0x4e3892=midjourney_constant_1[_0x2c92d9(0x1dc)][_0x2c92d9(0x1f4)](_0x1548f2[_0x2c92d9(0x23a)]),_0x30654c=_0x1548f2[_0x2c92d9(0x1b6)]?parseFloat(_0x1548f2[_0x2c92d9(0x1b6)]):null;if(_0x517229[_0x2c92d9(0x1b6)]===_0x30654c&&_0x517229[_0x2c92d9(0x23a)]===_0x4e3892){}else{const _0x5eb1c7=_0x1548f2[_0x2c92d9(0x25b)][_0x2c92d9(0x19d)](_0x3f53ab=>_0x3f53ab[_0x2c92d9(0x296)]!==_0x2c92d9(0x1b9)&&_0x3f53ab[_0x2c92d9(0x296)]!==_0x2c92d9(0x24e)&&_0x3f53ab[_0x2c92d9(0x1da)]!=='❤️'),_0x5df529={'id':_0x517229['id'],'mjpTaskId':_0x1548f2['id'],'status':_0x4e3892,'progress':_0x30654c,'buttons':_0x5eb1c7,'durationSpent':null,'imageUrl':_0x1548f2['imageUrl'],'failReason':_0x1548f2['failReason']};MjConfig_1['default']['mjProxyImgUrl']&&_0x5df529[_0x2c92d9(0x15a)]&&(_0x5df529[_0x2c92d9(0x15a)]=_0x5df529['imageUrl']['replace'](_0x2c92d9(0x2a1),MjConfig_1['default'][_0x2c92d9(0x28f)])),(_0x1548f2['action']=_0x2c92d9(0x2db))&&(_0x5df529[_0x2c92d9(0x22f)]=_0x1548f2[_0x2c92d9(0x22f)]||_0x5df529[_0x2c92d9(0x22f)]||''),_0x1548f2[_0x2c92d9(0x21a)]&&_0x1548f2[_0x2c92d9(0x2b2)]&&(_0x5df529['durationSpent']=(_0x1548f2[_0x2c92d9(0x21a)]-_0x1548f2[_0x2c92d9(0x2b2)])/0x3e8),await this['midjourneyEntity'][_0x2c92d9(0x2d3)](_0x5df529);}})['catch'](_0x6d022c=>{const _0x2ff297=_0x267420;common_1['Logger']['error'](_0x2ff297(0x2e5),_0x6d022c);})[_0x267420(0x210)](()=>{const _0xda1511=_0x267420;this[_0xda1511(0x200)][_0xda1511(0x197)]({'key':_0x37cc60});});}}catch(_0x4c675a){}}async[_0x45cc23(0x15c)](){const _0x3225dd=_0x45cc23;if(MjConfig_1['default'][_0x3225dd(0x18b)])return;try{const _0x2c1f2b=await this[_0x3225dd(0x266)][_0x3225dd(0x164)]({'where':[{'status':0x3,'imageUrl':(0x0,typeorm_2[_0x3225dd(0x274)])(_0x3225dd(0x217))},{'status':0x3,'imageUrl':(0x0,typeorm_2['Like'])(MjConfig_1[_0x3225dd(0x194)][_0x3225dd(0x28f)]+'%')}]});if(_0x2c1f2b['length'])for(let _0x20685b=0x0;_0x20685b<_0x2c1f2b[_0x3225dd(0x1cd)];_0x20685b++){let {id:_0xefbb57,imageUrl:_0x2b6ee8}=_0x2c1f2b[_0x20685b];this[_0x3225dd(0x1d1)][_0x3225dd(0x23f)](_0xefbb57,_0x2b6ee8);}}catch(_0xb650be){common_1['Logger'][_0x3225dd(0x275)](_0xb650be);}}};function _0x6b80(){const _0x5ccccc=['AiLogService','Like','error','imagine','614982NVgfVu','Repository','STANDARD','JWT_SECRET','fileInfo','218857havDji','上传文件失败...,\x20\x20upload\x20fail','convertToEnglish','isGroup','updateReconnect','HttpException','jsonwebtoken','setting','mjIncantationEntity','FanyiService','../../config/MjConfig','getDetailByIds','mjIncantationClassifyEntity','phone','relaxedUsage','MidjourneyStatusEnum','AddDrawQueueDto','操作失败！','files','mjProxyImgUrl','模式账号，请前往后台配置！','authorization','mjpAccountService','3494224aNFkkL','../aiLog/aiLog.service','Connection','label','getMjInspireClassify','DESC','初始化灵感广场分类成功','https://api.openai.com','buffer','upload_filename','getAdminDrawList','MjpAccountService','fast_vip_free','super','https://cdn.discordapp.com','syncTaskInfo','count','getByRelateId','createdAt','./dto/addDrawQueue.dto','userService','put','当前图片不存在！','mjSocketProxyUrl','BLEND','任务不存在！','function','/messages','TURBO','removeSuggestWords','object','startTime','removeMjIncantation','mjPromptsEntity','isSaveImg','addMjAccount','MjPromptsEntity','fastTimeRemaining','customId','BASIC','relax_vip_free','3463933RWTfmg','split','createRandomId','openaiBaseUrl','查询失败！','DRAW','syncMjpAccountAutomatic','MEGA','log','relax','FaceSwap','推荐关键词不存在','userEntity','要使用MJ绘画功能，至少需要配置一个MJ账号,并且启用该账号','modifyMjIncantation','getList','当前图片已经执行过相同指令！','图混图任务至少需要两张图片','7Aybkku','setAttachment','axios','querySuggestWords','fetch','save','../../common/constants/redisKey.constant','任务类型错误','incantationCn','findOneBy','deleteDraw','\x20--cw\x20','未查询到咒语一级分类','DESCRIBE','getMjDefaultParams','addMjInspireClassify','RedisCacheService','upload_url','set','Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','addDrawQueue','./mjIncantationClassify.entity','MoreThan','mjTaskUpdateJob:\x20','reject','aiLogService','无绘图记录','未指定','headers','findOne','HttpStatus','getMjIncantationClassify','PRO','精选分享','imageUrl','EModelType','syncMjImg','pid','remix','user','不需要灵感广场分类','IMAGE_ACTION','post','create','find','convertMode4Transfer','defineProperty','./mjIncantation.entity','catch','getDrawList','rec','code','isChinese','fullPrompt','modifyMjAccount','syncMjpAccountManual','DRAWED','lock','message','transaction','当前管理员限制单用户同时最多能执行','verify','describe','trubo','MjInspireClassifyEntity','\x20--cref\x20','删除成功！','hideString','info','商拍摄影','createRandomUid','__decorate','orderPlan','mjModel','UserService','uploadImage','FAST','update','delPrompt','DrawSpeed','队列已满，请稍后尝试','turbo_vip_free','removeMjInspireClassify','mjNotSaveImg','mjSuggestWordEntity','../file/file.service','MjParamEntity','MidjourneyService','fast','onModuleInit','validateBalance4MJ','jobIds','default','Injectable','action','del','../globalConfig/globalConfig.service','account','4qxJWCW','then','Logger','filter','checkIsActionDone','level','初始化灵感广场分类失败','VIP_FREE','vipFreeUsed','join','mjProxy','提交图片:\x20','extraParam','nickname','../badwords/badwords.service','squareType','properties','globalConfigService','turbo','modal','extend','metadata','删除记录失败！','cancel','guildId','Describe','error:\x20','formatCreateOrUpdateDate','progress','上传文件失败...,\x20upload\x20message\x20fail','TODO->error:\x20','Custom\x20Zoom','美女形象','all','agreeNum','创建图混图任务失败','jobId','3szEkxQ','prompt包含敏感词','摄影拍照','../fanyi/fanyi.service','enable','botType','queryMjInspireClassify','自动同步账号信息失败：','favorite','getConfigs','fanyiService','提交动作失败','BAD_REQUEST','syncInfo','length','result','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20*\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20AS\x20count,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20mjpId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20midjourney\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20action\x20IN\x20(\x201,\x202,\x203,\x2022\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20DATE\x20(\x20createdAt\x20)\x20=\x20CURDATE()\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20mjpId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20t\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.mjpId\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count\x20ASC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','IsNull','fileService','classifyName','分页参数错误','blend','initHasAccount','removeMjIncantationClassify','mjProxyUrl','./mjParam.entity','IMAGE_MIX_IMAGE','emoji','role','MjpStateMap','MID_JOURNEY','assign','Mj\x20Modal\x20通知','setMjAccountEnable','delLog','forEach','replace','attachments','形象设计','./mjInspireClassify.entity','modifyMjIncantationClassify','removeMjAccount','env','mjLimitCount','email','4779604WrHVXi','findAndCount','syncMjpTask','getRandomKey','distributeAccount','InjectRepository','getOneDraw','50EQouvV','get','swap','badwordsService','notify','stringify','./../user/user.entity','queryMjIncantation','queryMjAccountList','setPrompt','queryAllPrompt','壁纸绘画','subscribePlan','redisCacheService','./mjSuggestWord.entity','deductBalance4MJ','push','changeVersion','decorate','userId','syncMjpAccount','mjpTaskService','MidjourneyEntity','mjInspireClassifyEntity','查询咒语失败','queryMjIncantationByClassify','listByCondition','../../common/constants/midjourney.constant','parse','finally','getMjAccount','@nestjs/common','上传文件失败...','任务已达最大并发数，请等待其他任务完成后再提交新任务！','MjpTaskService','上传文件失败...,\x20\x20no\x20attachment','https://cdn.discordapp.com%','setImageFavorite','copyAccountInfo','finishTime','../../common/constants/model.constant','18VTsBkE','visitNum','推荐关键词已存在，不可重复添加','账号不存在','Imagine','channelId','删除失败！','无可用MJ账号，请后台添加或启用MJ账号','image/png','查询推荐关键词失败','affected','没有满足条件的MJ账号，请联系管理员！','mjParamEntity','map','lifetimeUsage','4287380JlZSWc','promptsPage','imageSeed','checkBadWords','prompt','TEXT_TO_IMAGE','@nestjs/typeorm','https://discord.com/api/v9/channels/','个任务','28481796KIKDuI','getAgreeByRelateId','connection','saveSuggestWords','添加绘图任务失败','MjIncantationEntity','status','getRandomItemFromArray','modalTask','queryMjIncantationClassifyAllByLevel','renewDate','transferImg','delete','MjSuggestWordEntity','timeoutMinutes','timeout','__esModule','description','increaseVisit','avatar','type','messageFlags','base64','mjpId','handleAddDrawTask','Mj任务通知异常:\x20','Imagine\x20all','username','vipExpire','mjpId:\x20','fastRemainTime','MidJourneyDrawEnum','checkUserStatus','Modal已处理，无需更新','originPrompt','durationSpent','versionSelector','handleGetIsRemix','UserEntity','buttons','绘制的任务不存在！','Not','创建图生文任务失败','squire-images','modifyMjInspireClassify','删除推荐关键词失败','concurrentLimit','application/json','名称不能重复','getOwnPropertyDescriptor','midjourneyEntity','DRAWING','保存推荐关键词','actionTask','/attachments','查询咒语分类失败','hasAccount','addRefer','getModelProxyUrl','toString','mjpTaskId','mode','initInspireData'];_0x6b80=function(){return _0x5ccccc;};return _0x6b80();}MidjourneyService=__decorate([(0x0,common_1[_0x45cc23(0x195)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x45cc23(0x209)])),__param(0x1,(0x0,typeorm_1[_0x45cc23(0x1f1)])(user_entity_1[_0x45cc23(0x25a)])),__param(0x2,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjPrompts_entity_1[_0x45cc23(0x2b7)])),__param(0x3,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjParam_entity_1['MjParamEntity'])),__param(0x4,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjIncantationClassify_entity_1['MjIncantationClassifyEntity'])),__param(0x5,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjInspireClassify_entity_1[_0x45cc23(0x178)])),__param(0x6,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjSuggestWord_entity_1[_0x45cc23(0x241)])),__param(0x7,(0x0,typeorm_1[_0x45cc23(0x1f1)])(mjIncantation_entity_1[_0x45cc23(0x239)])),__metadata('design:paramtypes',[typeorm_2[_0x45cc23(0x278)],typeorm_2['Repository'],typeorm_2[_0x45cc23(0x278)],typeorm_2[_0x45cc23(0x278)],typeorm_2['Repository'],typeorm_2[_0x45cc23(0x278)],typeorm_2[_0x45cc23(0x278)],typeorm_2[_0x45cc23(0x278)],globalConfig_service_1['GlobalConfigService'],file_service_1['FileService'],badwords_service_1['BadwordsService'],fanyi_service_1[_0x45cc23(0x285)],user_service_1[_0x45cc23(0x182)],redisCache_service_1[_0x45cc23(0x2de)],mjpAccount_service_1[_0x45cc23(0x29e)],mjpTask_service_1[_0x45cc23(0x215)],aiLog_service_1[_0x45cc23(0x273)],typeorm_2[_0x45cc23(0x295)]])],MidjourneyService),exports[_0x45cc23(0x18f)]=MidjourneyService;