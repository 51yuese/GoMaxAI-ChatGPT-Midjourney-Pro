'use strict';const _0x4c31a7=_0x4696;(function(_0x5bac57,_0x2230c4){const _0x5c4afa=_0x4696,_0x1748e5=_0x5bac57();while(!![]){try{const _0x7bdaea=-parseInt(_0x5c4afa(0x368))/0x1+parseInt(_0x5c4afa(0x341))/0x2+parseInt(_0x5c4afa(0x31a))/0x3+parseInt(_0x5c4afa(0x1ea))/0x4+parseInt(_0x5c4afa(0x1cb))/0x5*(parseInt(_0x5c4afa(0x34e))/0x6)+parseInt(_0x5c4afa(0x28b))/0x7+parseInt(_0x5c4afa(0x32b))/0x8*(-parseInt(_0x5c4afa(0x22f))/0x9);if(_0x7bdaea===_0x2230c4)break;else _0x1748e5['push'](_0x1748e5['shift']());}catch(_0x21ea64){_0x1748e5['push'](_0x1748e5['shift']());}}}(_0x2358,0x2e2fd));function _0x2358(){const _0x4e2ff7=['applicationFieldsName','values','mjpTaskService','modelVersion','join','initHasAccount','startsWith','1000035JxpXWa','mjPromptsEntity','商拍摄影','syncMjTask','globalConfigService','page','collect','rows','queryMjIncantationAll','userInfo','key','durationSpent','timeout','promptsPage','insightFace','MjpTaskService','UserCollectType','./mjSuggestWord.entity','development','parseExtendArgs','info','updatedAt','dictService','get','trim','effectMainBodyName','transferImg','indexOf','onModuleInit','originPrompt','find','767928alipvq','getReqSaasId','forEach','VIP_FREE','------------------allDrawTaskListError--------------','imageSeed','relateId','modalTask','触站::模型信息同步完成','\x20--iw\x20','application_fields','add','任务类型错误','isSuper','./dto/DrawTaskPage.dto','finalPrompt','https://cdn.discordapp.com','relax_vip_free','modelsService','listByCondition','Imagine\x20all','dataType','MjConfig','MidjourneyEntity','guildId','头像制作','parse','DrawSpeed','Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','workflowTaskDetail','checkUserStatus','copyAccountInfo','assign','../../common/constants/midjourney.constant','size','workflowUsedPage','mergeCollectDataForUserId','type','thumb','classifyName','DESC','当前图片不存在！','queryAllPrompt','removeMjAccount','ENV','turbo_vip_free','mjTaskUpdateJob:\x20','prompt包含敏感词','relaxedUsage','查询咒语分类失败','syncModels','queryMjIncantationClassifyAllByLevel','log','触站::模型信息同步失败','mjTimeoutMs','DRAWED','style','exist','lifetimeVip','jobIds','finally','finishTime','@nestjs/common','affected','paintingSign','删除推荐关键词失败','CzStateMap','摄影拍照','modelSave','27nYnGHs','cos','(squareType\x20=\x20','\x20--sw\x20','./mjModel.entity','updateReconnect','changeVersion','responseResult','filter','name','turbo','FileService','mask','swap','addMjIncantationClassify','Modal已处理，无需更新','refundBalance4MJ','mode','modifyMjInspireClassify','remix','convertMode4Transfer','mergeCollectCountData','removeMjIncantationClassify','MID_JOURNEY','分页参数错误','vipExpire','Mj任务通知异常:\x20','checkIsActionDone','fast','MjIncantationEntity','\x20GROUP\x20BY\x20workflowId\x20)\x20t\x20ON\x20t.workflowId\x20=\x20m.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.workflowId\x20IS\x20NOT\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.createdAt\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','?x-oss-process=image/resize,w_400','getUserId','customId','concat','length','syncWfTask','state','count','transaction','description','imageUrl','addMjIncantation','versionId','\x20and\x20','mjSuggestWordEntity','工作流（小工具）不存在','files','deleteDraw','fanyiService','disabled','setMjAccountEnable','dictValue','绘画制作','getAgreeMap','recommend','replace','workflowModelDetail','orderPlan','getMjIncantationClassify','UserService','FaceSwap','prompt','../api/czTask.service','error:\x20','dictType','ids','FanyiService','./mjPrompts.entity','handleImagesUploadTask','Like','--sw','model','WORKFLOW','workflowModelPage','clsService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(m.id)\x20AS\x20count\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20models\x20m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20(\x20SELECT\x20workflowId,\x20count(workflowId)\x20AS\x20used,\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20FROM\x20midjourney\x20WHERE\x20workflowId\x20IS\x20NOT\x20NULL\x20AND\x20userId\x20=\x20','初始化灵感广场分类成功','versionSelector','syncMjpAccount','dictName','queryMjInspireClassify','Connection','workflowModelUpdate','list4workflow','aiLogService','美女形象','datas','nickname','isChinese','hideString','../dict/dict.service','1962492CjLYkQ','./dto/addDrawQueue.dto','userId','当前图片已经执行过相同指令！','set','startTime','mjModel','includes','删除成功！','HttpException','../redisCache/redisCache.service','emoji','defineProperty','AiLogService','buffer','cover','save','Logger','collectPage','id不能为空！','EModelType','mjInspireClassifyEntity','update','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20','wfTaskUpdateJob:\x20','DRAW','code','IMAGE_TO_TEXT','createdAt','SD任务通知内容：','images','小工具已禁用！','use','messageFlags','pageCount','applicationFields','图混图任务至少需要两张图片','addDrawQueue','useCount','初始化灵感广场分类失败','catch','形象设计','favoriteListByTypeAndIds','queryMjIncantation','queryMjIncantationByClassify','MoreThan','incantationCn','syncTask','channelId','创建图生文任务失败','删除记录失败！','drawTaskList','deductBalance4MJ','查询咒语失败','trubo','workflowId','Modal\x20状态\x20手动同步任务信息','email','aiInpaint','MjIncantationClassifyEntity','触站::运用领域、风格画风、作用主体、作用类别字典同步完成','fullPrompt','自动同步账号信息失败：','Repository','queryMjIncantationClassify','createRandomUid','value','addMjAccount','MJ_TASK_UPDATE','avatar','SUCCESS','--cref','workflowSave','../../common/constants/model.constant','all','getModelById','getMjIncantation','userService','MidJourneyDrawEnum','describe','timeoutMinutes','drawSquareAllPage','fastTimeRemaining','添加绘图任务失败','badwordsService','convertToEnglish','relax','../globalConfig/globalConfig.service','effectCategoryName','then','任务不存在！','../../common/utils','maskBase64','mjVersion','setPrompt','enable','parseMjStatus','查询灵感分类失败','\x20--sref\x20','mjNotSaveImg','fileService','IsNull','validateBalance4MJ','触站工作流任务通知异常:\x20','__decorate','saveSuggestWords','ali','workflowForm','getUserListByIds','midjourneyEntity','rec','Imagine','agree','recDraw','../api/mjpTask.service','mjProxy','lock','mjpAccountService','https://img2.huashi6.com/','object','STANDARD','progress','MjSuggestWordEntity','(fullPrompt\x20like\x20\x27%','sdTaskSubmit','workflowFavorite','ASC','authorization','findOne','fileInfo','精选分享','get4workflow','favoritePage','推荐关键词已存在，不可重复添加','动漫漫画','任务已达最大并发数，请等待其他任务完成后再提交新任务！','队列已满，请稍后尝试','drawSquarePage','EFavorite','mjIncantationEntity','split','findAndCount','query','106848QtBaya','del','remark','MidjourneyService','result','\x20--cref\x20','action','推荐关键词不存在','非法操作！','effect_main_body','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20uf.relateType\x20=\x20\x27','创建图混图任务失败','workflowDicts','setImageFavorite','getOneDraw','effect_category','isManage','1045984GioQGI','delLog','BAD_REQUEST','list4dictTypes','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.cover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.modelName\x20AS\x20name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.model\x20AS\x20workflowId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.key\x20AS\x20versionId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.deduct,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.vip_free_num\x20AS\x20vipFreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.displaySort,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.description,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.useCount,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.remark\x20AS\x20tutorial\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_favorite\x20uf\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20models\x20m\x20ON\x20m.id\x20=\x20uf.relateId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.userId\x20=\x20\x27','getExtByRelateWithModel',';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getAgreeByRelateId','botType','tutorial','syncSdTask','RedisCacheService','metadata','addMjInspireClassify','inputs','提交动作失败','renewDate','getMjAccount','env','subscribePlan','触站::运用领域、风格画风、作用主体、作用类别字典同步失败','user','216632rUXVra','MEGA','getModelByIds','壁纸绘画','string','mergeCollectData','../../common/constants/collectType.constant','无绘图记录','version','phone','modelType','level','promptEn','6FJwWhm','vipFreeNum','DESCRIBE','mergeModelsByName','deductBalance4SD','checkBadWords','url','displaySort','effectMainBody','Custom\x20Zoom','__esModule','../aiLog/aiLog.service','./mjParam.entity','getConfigByKeys','getUserById','MjpAccountService','不需要灵感广场分类','taskId','AddDrawQueueDto','mjProxyImgUrl','connection','https://cdn.discordapp.com%','has','from','queryMjAccountList','../file/file.service','234852ZyUFdB','weight','MjInspireClassifyEntity','workflowDel','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(m.id)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_favorite\x20uf\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20models\x20m\x20ON\x20m.id\x20=\x20uf.relateId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.userId\x20=\x20\x27','operated','mjParamEntity','mjpId','getByRelateId','now','syncModelsByTag','syncMjpAccountAutomatic','modelName','getExtByRelate','syncMjpAccountManual','DictService','sdTaskUpdateJob:\x20','data:image/png;base64,','isRefund','账号不存在','buttons','TURBO','HttpStatus','IMAGE_MIX_IMAGE','delete','squareType','modifyMjAccount','allDrawTaskList','BadwordsService','saasId','modifyMjIncantation','findOneBy','blend','mjpTaskId','要使用MJ绘画功能，至少需要配置一个MJ账号,并且启用该账号','getAgreeMapWithModel','error','redisCacheService','---------------MJ\x20DRAW\x20Success---------------','function','\x20OFFSET\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','modelPage','delPrompt','failReason','message','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20updatedAt\x20DESC\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','notifySD','../../common/constants/redisKey.constant','pid','toString','mjModelEntity','lifetimeUsage','syncInfo','imagine','getUserInfoFromHeader','?imageMogr2/thumbnail/400x','绘制的任务不存在！','config','concurrentLimit','syncMjImg','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.cover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.modelName\x20AS\x20name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.model\x20AS\x20workflowId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.key\x20AS\x20versionId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.deduct,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.vip_free_num\x20AS\x20vipFreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.displaySort,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.description,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.useCount,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.remark\x20AS\x20tutorial,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.used\x20AS\x20used\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20models\x20m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20(\x20SELECT\x20workflowId,\x20count(workflowId)\x20AS\x20used,\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20FROM\x20midjourney\x20WHERE\x20workflowId\x20IS\x20NOT\x20NULL\x20AND\x20userId\x20=\x20','addRefer','agreeNum','removeMjInspireClassify','deduct','tencent','actionTask','properties','map','LessThan','sdTaskInpaint','stringify','SELECT\x20*\x20FROM\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20id,userId,squareType,botType\x20as\x20model,fullPrompt,imageUrl,fileInfo,requestParams,responseResult,updatedAt\x20FROM\x20midjourney\x20\x20where\x20rec=1\x20and\x20botType=\x27MID_JOURNEY\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20UNION\x20ALL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20id,userId,squareType,model,prompt\x20as\x20fullPrompt,answer\x20as\x20imageUrl,fileInfo,requestParams,responseResult,updatedAt\x20from\x20chatlog\x20where\x20rec=1\x20and\x20\x20modelType=\x27draw\x27\x20and\x20isDelete=0\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20AS\x20combined_data\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','push','distributeAccount','notifyWF','EBotType','visitNum','MidjourneyStatusEnum','effectCategory','czTaskService','cancel','removeMjIncantation','instanceId','mjIncantationClassifyEntity','BLEND','workflowDetail','vipFreeUsed','mergeThumb','status','InjectRepository','aiTaskDetail','isPlatform','触站工作流任务通知内容：','fastRemainTime','keyword','number','modal','MjParamEntity','notify','fetch','findBy','isDefined','modifyMjIncantationClassify','aiDraw','GlobalConfigService','getDetailByIds','label','../badwords/badwords.service','名称不能重复'];_0x2358=function(){return _0x4e2ff7;};return _0x2358();}var __decorate=this&&this[_0x4c31a7(0x2f3)]||function(_0xa02043,_0x14eba8,_0x96f524,_0x503dc9){const _0x6dd47b=_0x4c31a7;var _0x2d95ce=arguments[_0x6dd47b(0x252)],_0x5e4122=_0x2d95ce<0x3?_0x14eba8:_0x503dc9===null?_0x503dc9=Object['getOwnPropertyDescriptor'](_0x14eba8,_0x96f524):_0x503dc9,_0x35b56b;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x6dd47b(0x17c))_0x5e4122=Reflect['decorate'](_0xa02043,_0x14eba8,_0x96f524,_0x503dc9);else{for(var _0x3dc6fb=_0xa02043[_0x6dd47b(0x252)]-0x1;_0x3dc6fb>=0x0;_0x3dc6fb--)if(_0x35b56b=_0xa02043[_0x3dc6fb])_0x5e4122=(_0x2d95ce<0x3?_0x35b56b(_0x5e4122):_0x2d95ce>0x3?_0x35b56b(_0x14eba8,_0x96f524,_0x5e4122):_0x35b56b(_0x14eba8,_0x96f524))||_0x5e4122;}return _0x2d95ce>0x3&&_0x5e4122&&Object['defineProperty'](_0x14eba8,_0x96f524,_0x5e4122),_0x5e4122;},__metadata=this&&this['__metadata']||function(_0xe8f8d,_0x16b7dc){const _0x3b004e=_0x4c31a7;if(typeof Reflect===_0x3b004e(0x302)&&typeof Reflect[_0x3b004e(0x337)]===_0x3b004e(0x17c))return Reflect[_0x3b004e(0x337)](_0xe8f8d,_0x16b7dc);},__param=this&&this['__param']||function(_0x3de01d,_0x206d83){return function(_0x1acdc7,_0x588ae2){_0x206d83(_0x1acdc7,_0x588ae2,_0x3de01d);};};Object[_0x4c31a7(0x297)](exports,_0x4c31a7(0x358),{'value':!![]}),exports[_0x4c31a7(0x31d)]=void 0x0;const common_1=require(_0x4c31a7(0x228)),typeorm_1=require('@nestjs/typeorm'),midjourney_entity_1=require('./midjourney.entity'),typeorm_2=require('typeorm'),globalConfig_service_1=require(_0x4c31a7(0x2e2)),midjourney_constant_1=require(_0x4c31a7(0x20b)),file_service_1=require(_0x4c31a7(0x367)),badwords_service_1=require(_0x4c31a7(0x1c2)),utils_1=require(_0x4c31a7(0x2e6)),mjPrompts_entity_1=require(_0x4c31a7(0x273)),mjParam_entity_1=require(_0x4c31a7(0x35a)),mjIncantationClassify_entity_1=require('./mjIncantationClassify.entity'),mjInspireClassify_entity_1=require('./mjInspireClassify.entity'),mjIncantation_entity_1=require('./mjIncantation.entity'),fanyi_service_1=require('../fanyi/fanyi.service'),mjSuggestWord_entity_1=require(_0x4c31a7(0x1dc)),user_service_1=require('../user/user.service'),redisCache_service_1=require(_0x4c31a7(0x295)),mjpAccount_service_1=require('../api/mjpAccount.service'),mjpTask_service_1=require(_0x4c31a7(0x2fd)),addDrawQueue_dto_1=require(_0x4c31a7(0x28c)),store_1=require('../../common/store'),redisKey_constant_1=require(_0x4c31a7(0x185)),aiLog_service_1=require(_0x4c31a7(0x359)),model_constant_1=require(_0x4c31a7(0x2d4)),nestjs_cls_1=require('nestjs-cls'),czTask_service_1=require(_0x4c31a7(0x26e)),models_service_1=require('../models/models.service'),DrawTaskPage_dto_1=require(_0x4c31a7(0x1f8)),user_constant_1=require('../../common/constants/user.constant'),dict_service_1=require(_0x4c31a7(0x28a)),mjModel_entity_1=require(_0x4c31a7(0x233)),collectType_constant_1=require(_0x4c31a7(0x347));let MidjourneyService=class MidjourneyService{constructor(_0x5d34ee,_0x455804,_0x164258,_0x36da18,_0x1cca02,_0x5e33dc,_0x1cdb5f,_0x1a5785,_0x3d031d,_0x1b5d86,_0x689eea,_0x3968d3,_0x12bfbf,_0x38b587,_0x24d401,_0x32974c,_0xcd85d2,_0x5d76a3,_0x2c7197,_0x40a451,_0x13d355,_0xc8f3b6){const _0x158b75=_0x4c31a7;this[_0x158b75(0x188)]=_0x5d34ee,this[_0x158b75(0x36e)]=_0x455804,this[_0x158b75(0x1cc)]=_0x164258,this[_0x158b75(0x2f8)]=_0x36da18,this[_0x158b75(0x25c)]=_0x1cca02,this[_0x158b75(0x316)]=_0x5e33dc,this['mjInspireClassifyEntity']=_0x1cdb5f,this[_0x158b75(0x1aa)]=_0x1a5785,this[_0x158b75(0x27a)]=_0x3d031d,this[_0x158b75(0x1e1)]=_0x1b5d86,this[_0x158b75(0x2d8)]=_0x689eea,this['fileService']=_0x3968d3,this[_0x158b75(0x260)]=_0x12bfbf,this['aiLogService']=_0x38b587,this[_0x158b75(0x1fc)]=_0x24d401,this['czTaskService']=_0x32974c,this[_0x158b75(0x1c6)]=_0xcd85d2,this[_0x158b75(0x2df)]=_0x5d76a3,this[_0x158b75(0x17a)]=_0x2c7197,this['mjpAccountService']=_0x40a451,this[_0x158b75(0x1cf)]=_0x13d355,this['connection']=_0xc8f3b6;}async[_0x4c31a7(0x1e7)](){await this['initInspireData'](),await this['initHasAccount']();}async[_0x4c31a7(0x1c9)](){const _0x5c88ca=_0x4c31a7,_0x1d5772=await this['mjParamEntity'][_0x5c88ca(0x255)]({'where':{'enable':0x1},'order':{'weight':'DESC'}});_0x1d5772===0x0&&common_1[_0x5c88ca(0x29c)][_0x5c88ca(0x179)](_0x5c88ca(0x177));}async['initInspireData'](){const _0x11b690=_0x4c31a7,_0x21840e=await this[_0x11b690(0x2a0)][_0x11b690(0x255)]();if(_0x21840e===0x0){const _0x2b9e64=[{'name':_0x11b690(0x264),'value':0x1},{'name':_0x11b690(0x22d),'value':0x2},{'name':_0x11b690(0x203),'value':0x3},{'name':_0x11b690(0x285),'value':0x4},{'name':_0x11b690(0x311),'value':0x5},{'name':_0x11b690(0x344),'value':0x6},{'name':'艺术设计','value':0x7},{'name':_0x11b690(0x1cd),'value':0x8},{'name':_0x11b690(0x2b4),'value':0x9},{'name':_0x11b690(0x30d),'value':0xa}][_0x11b690(0x19a)](_0x23afd0=>{const _0x278daa=_0x11b690;return{'name':_0x23afd0[_0x278daa(0x238)],'value':_0x23afd0[_0x278daa(0x2cd)]+'','inner':0x1};});await this[_0x11b690(0x2a0)][_0x11b690(0x29b)](_0x2b9e64)[_0x11b690(0x2b3)](()=>{const _0x5dcb65=_0x11b690;common_1[_0x5dcb65(0x29c)]['error'](_0x5dcb65(0x2b2));}),common_1[_0x11b690(0x29c)][_0x11b690(0x21e)](_0x11b690(0x27c));}common_1['Logger'][_0x11b690(0x21e)](_0x11b690(0x35e));}async[_0x4c31a7(0x2ce)](_0x30bf2b){const _0x2724e6=_0x4c31a7;try{const {guildId:_0xf6c0aa,account:_0x3f659c,authorization:_0x517440,mode:_0x3cae6c,timeout:_0x5a3588,channelId:_0x539a6e,remark:_0x4497e3,mjBotChannelId:_0x34ef51,nijiBotChannelId:_0x4b5783}=_0x30bf2b;var _0x17629f=await this[_0x2724e6(0x300)]['create']({'data':{'channelId':_0x539a6e,'coreSize':0x3,'guildId':_0xf6c0aa,'mjBotChannelId':_0x34ef51||'','nijiBotChannelId':_0x4b5783||'','queueSize':0xa,'remark':_0x4497e3,'remixAutoSubmit':![],'timeoutMinutes':_0x5a3588,'userAgent':_0x2724e6(0x206),'userToken':_0x517440}});if(_0x17629f['code']!==0x1)throw new Error(_0x17629f['description']);const _0x5e5f43=await this[_0x2724e6(0x36e)][_0x2724e6(0x29b)]({'account':_0x3f659c,'authorization':_0x517440,'mode':_0x3cae6c,'timeout':_0x5a3588,'channelId':_0x539a6e,'guildId':_0xf6c0aa,'remark':_0x4497e3,'mjpId':_0x17629f[_0x2724e6(0x31e)],'mjBotChannelId':_0x34ef51||'','nijiBotChannelId':_0x4b5783||''});return await this[_0x2724e6(0x27e)](_0x17629f[_0x2724e6(0x31e)]),!!_0x5e5f43;}catch(_0x32e25e){common_1['Logger'][_0x2724e6(0x179)](_0x32e25e);throw new common_1[(_0x2724e6(0x294))](_0x32e25e['message'],common_1[_0x2724e6(0x16b)][_0x2724e6(0x32d)]);}}async[_0x4c31a7(0x16f)](_0x32857f){const _0x1414d2=_0x4c31a7,{id:_0x241563,account:_0x5cfa83,authorization:_0x422dfa,mode:_0x3c98af,guildId:_0x3f967c,remark:_0xc4e484,channelId:_0xb73bce,timeout:_0x4ef1eb,enable:_0x19aa91,mjBotChannelId:_0xd166f9,nijiBotChannelId:_0x554bee}=_0x32857f;try{const _0xd8bbab=await this['mjParamEntity'][_0x1414d2(0x174)]({'id':Number(_0x241563)});var _0x332870=await this[_0x1414d2(0x300)][_0x1414d2(0x234)]({'data':{'channelId':_0xb73bce,'coreSize':0x3,'guildId':_0x3f967c,'mjBotChannelId':_0xd166f9||'','nijiBotChannelId':_0x554bee||'','queueSize':0xa,'remark':_0xc4e484,'remixAutoSubmit':![],'timeoutMinutes':_0x4ef1eb,'userAgent':_0x1414d2(0x206),'userToken':_0x422dfa,'enable':Boolean(_0x19aa91)}},_0xd8bbab[_0x1414d2(0x36f)]);if(_0x332870['code']!==0x1)throw new Error(_0x332870[_0x1414d2(0x257)]);return await this[_0x1414d2(0x36e)][_0x1414d2(0x2a1)](_0x241563,{'account':_0x5cfa83,'authorization':_0x422dfa,'mode':_0x3c98af,'guildId':_0x3f967c,'remark':_0xc4e484,'channelId':_0xb73bce,'timeout':_0x4ef1eb,'mjBotChannelId':_0xd166f9||'','nijiBotChannelId':_0x554bee||''});}catch(_0xec3e47){common_1[_0x1414d2(0x29c)]['error'](_0xec3e47);throw new common_1['HttpException'](_0xec3e47[_0x1414d2(0x182)],common_1[_0x1414d2(0x16b)][_0x1414d2(0x32d)]);}}async[_0x4c31a7(0x209)](_0x525cea,_0x40c3b9){const _0x42d561=_0x4c31a7;_0x525cea[_0x42d561(0x2e8)]=_0x40c3b9[_0x42d561(0x349)];if(_0x40c3b9[_0x42d561(0x240)]==='FAST')_0x525cea[_0x42d561(0x240)]=midjourney_constant_1['DrawSpeed']['fast'];else{if(_0x40c3b9[_0x42d561(0x240)]==='RELAX')_0x525cea[_0x42d561(0x240)]=midjourney_constant_1['DrawSpeed']['relax'];else _0x40c3b9[_0x42d561(0x240)]===_0x42d561(0x16a)&&(_0x525cea[_0x42d561(0x240)]=midjourney_constant_1[_0x42d561(0x205)][_0x42d561(0x239)]);}_0x525cea[_0x42d561(0x1b4)]=_0x40c3b9[_0x42d561(0x2dd)],_0x525cea['totalTime']=_0x40c3b9[_0x42d561(0x2dd)],_0x525cea[_0x42d561(0x189)]=_0x40c3b9['lifetimeUsage'],_0x525cea[_0x42d561(0x21a)]=_0x40c3b9[_0x42d561(0x21a)],_0x525cea[_0x42d561(0x242)]=Number(_0x40c3b9[_0x42d561(0x242)]);if(_0x40c3b9[_0x42d561(0x33e)]==='BASIC')_0x525cea['orderPlan']=0x1;else{if(_0x40c3b9[_0x42d561(0x33e)]===_0x42d561(0x303))_0x525cea[_0x42d561(0x269)]=0x2;else{if(_0x40c3b9['subscribePlan']==='PRO')_0x525cea[_0x42d561(0x269)]=0x3;else _0x40c3b9[_0x42d561(0x33e)]===_0x42d561(0x342)&&(_0x525cea['orderPlan']=0x4);}}_0x525cea[_0x42d561(0x33b)]=_0x40c3b9[_0x42d561(0x33b)],_0x525cea[_0x42d561(0x1d7)]=_0x40c3b9[_0x42d561(0x2db)],_0x525cea['setting']=JSON[_0x42d561(0x19d)](_0x40c3b9[_0x42d561(0x169)]),_0x525cea[_0x42d561(0x1df)]=JSON[_0x42d561(0x19d)](_0x40c3b9[_0x42d561(0x27d)]),await this[_0x42d561(0x36e)][_0x42d561(0x29b)](_0x525cea);}async['syncMjpAccount'](_0x1bc4bd){const _0x334221=_0x4c31a7;try{if(store_1[_0x334221(0x200)][_0x334221(0x291)]!==_0x334221(0x2fe))return;const _0x2797ed=await this['mjpAccountService'][_0x334221(0x1ba)]({},_0x1bc4bd);if(!_0x2797ed)return;const _0x3eb2d0=await this[_0x334221(0x36e)][_0x334221(0x30b)]({'where':{'mjpId':_0x1bc4bd}});await this[_0x334221(0x209)](_0x3eb2d0,_0x2797ed);}catch(_0x38c636){common_1['Logger'][_0x334221(0x179)](_0x334221(0x2c9),_0x38c636);}}async[_0x4c31a7(0x373)](){const _0x44de04=_0x4c31a7,_0x37eccc=await this['mjParamEntity'][_0x44de04(0x1e9)]();if(!_0x37eccc[_0x44de04(0x252)])return;for(let _0x5b4b5c=0x0;_0x5b4b5c<_0x37eccc['length'];_0x5b4b5c++){this[_0x44de04(0x27e)](_0x37eccc[_0x5b4b5c][_0x44de04(0x36f)]);}}async[_0x4c31a7(0x163)]({id:_0x108c27}){const _0x303e48=_0x4c31a7;try{const _0x160034=await this[_0x303e48(0x36e)][_0x303e48(0x174)]({'id':Number(_0x108c27)}),_0x4553ec=await this[_0x303e48(0x300)][_0x303e48(0x18a)]({},_0x160034[_0x303e48(0x36f)]);if(_0x4553ec[_0x303e48(0x2a5)]!==0x1)throw new Error(_0x4553ec[_0x303e48(0x257)]);await this[_0x303e48(0x209)](_0x160034,_0x4553ec[_0x303e48(0x31e)]);}catch(_0x172804){throw new common_1[(_0x303e48(0x294))](_0x172804[_0x303e48(0x182)],common_1[_0x303e48(0x16b)][_0x303e48(0x32d)]);}}async['changeVersion'](_0x54f002){const _0x11b515=_0x4c31a7;try{const _0x4b2f5b=await this['mjParamEntity']['findOneBy']({'id':Number(_0x54f002['id'])}),_0x492c17=await this[_0x11b515(0x300)][_0x11b515(0x235)]({'data':_0x54f002},_0x4b2f5b['mjpId']);if(_0x492c17[_0x11b515(0x2a5)]!==0x1)throw new Error(_0x492c17[_0x11b515(0x257)]);return _0x4b2f5b[_0x11b515(0x2e8)]=_0x54f002[_0x11b515(0x349)],await this[_0x11b515(0x36e)][_0x11b515(0x29b)](_0x4b2f5b),!![];}catch(_0x55a5f8){throw new common_1[(_0x11b515(0x294))](_0x55a5f8[_0x11b515(0x182)],common_1['HttpStatus'][_0x11b515(0x32d)]);}}async[_0x4c31a7(0x320)](_0x5e5f90){const _0x28a51f=_0x4c31a7;try{const _0x22cf7b=await this[_0x28a51f(0x36e)][_0x28a51f(0x174)]({'id':Number(_0x5e5f90['id'])}),_0x1f7796=await this[_0x28a51f(0x300)][_0x28a51f(0x320)]({'data':_0x5e5f90},_0x22cf7b[_0x28a51f(0x36f)]);if(_0x1f7796[_0x28a51f(0x2a5)]!==0x1)throw new Error(_0x1f7796['description']);return!![];}catch(_0x9d206){throw new common_1[(_0x28a51f(0x294))](_0x9d206[_0x28a51f(0x182)],common_1[_0x28a51f(0x16b)][_0x28a51f(0x32d)]);}}async[_0x4c31a7(0x215)](_0x12d287){const _0x267144=_0x4c31a7,{id:_0x210875}=_0x12d287;try{const _0x280d85=await this[_0x267144(0x36e)][_0x267144(0x30b)]({'where':{'id':Number(_0x210875)}});if(!_0x280d85)throw new Error(_0x267144(0x168));common_1[_0x267144(0x29c)][_0x267144(0x179)]('mjpId:\x20',_0x280d85[_0x267144(0x36f)]);const _0x5193ea=await this[_0x267144(0x300)]['delete']({},_0x280d85['mjpId']);if(_0x5193ea[_0x267144(0x2a5)]!==0x1)throw new Error(_0x5193ea[_0x267144(0x257)]);const _0x4dbfa1=await this['mjParamEntity'][_0x267144(0x16d)]({'id':_0x210875});return _0x4dbfa1['affected'];}catch(_0x338e84){throw new common_1[(_0x267144(0x294))](_0x338e84[_0x267144(0x182)],common_1['HttpStatus'][_0x267144(0x32d)]);}}async[_0x4c31a7(0x262)](_0x4202c9){const _0x8d56a=_0x4c31a7,{id:_0x5d3a19,enable:_0x1b217b}=_0x4202c9;return await this[_0x8d56a(0x36e)][_0x8d56a(0x2a1)](_0x5d3a19,{'enable':_0x1b217b})[_0x8d56a(0x2e4)](_0x12298e=>_0x12298e[_0x8d56a(0x229)]>0x0);}async[_0x4c31a7(0x33c)](_0x21a1c3,_0x1028b1){const _0x404c43=_0x4c31a7,_0x439165=(0x0,utils_1['isSuper'])(this['clsService']),{id:_0x3a6b0c}=_0x21a1c3;let _0x4f1245=null;try{const _0x30b090=await this[_0x404c43(0x36e)][_0x404c43(0x30b)]({'where':{'id':_0x3a6b0c}});return _0x439165&&(_0x4f1245=await this[_0x404c43(0x300)]['fetch']({},_0x30b090[_0x404c43(0x36f)])),{..._0x30b090,'mjpAccountInfo':_0x4f1245,'authorization':_0x439165?_0x30b090[_0x404c43(0x30a)]:(0x0,utils_1[_0x404c43(0x289)])(_0x30b090[_0x404c43(0x30a)]),'guildId':_0x439165?_0x30b090[_0x404c43(0x202)]:(0x0,utils_1['hideString'])(_0x30b090[_0x404c43(0x202)]),'channelId':_0x439165?_0x30b090[_0x404c43(0x2bb)]:(0x0,utils_1['hideString'])(_0x30b090['channelId'])};}catch(_0x528f43){throw new common_1['HttpException'](_0x528f43,common_1['HttpStatus'][_0x404c43(0x32d)]);}}async[_0x4c31a7(0x366)](_0x515bad,_0xae518c){const _0x2461b2=_0x4c31a7,{page:page=0x1,size:size=0x14,account:_0x2700e7,channelId:_0x4632d4,enable:_0x244f86}=_0x515bad;if(!page||!size)throw new common_1[(_0x2461b2(0x294))](_0x2461b2(0x247),common_1[_0x2461b2(0x16b)][_0x2461b2(0x32d)]);const _0x327143={};_0x2700e7&&Object[_0x2461b2(0x20a)](_0x327143,{'account':(0x0,typeorm_2['Like'])('%'+_0x2700e7+'%')}),_0x4632d4&&Object[_0x2461b2(0x20a)](_0x327143,{'channelId':(0x0,typeorm_2[_0x2461b2(0x275)])('%'+_0x4632d4+'%')}),_0x244f86>0x0&&Object[_0x2461b2(0x20a)](_0x327143,{'enable':_0x244f86});const [_0x10c037,_0x10b8c6]=await this[_0x2461b2(0x36e)]['findAndCount']({'skip':(page-0x1)*size,'where':_0x327143,'take':size,'order':{'createdAt':_0x2461b2(0x212)},'cache':!![],'select':['id',_0x2461b2(0x202),_0x2461b2(0x2bb),_0x2461b2(0x30a),'account',_0x2461b2(0x369),_0x2461b2(0x2ea),_0x2461b2(0x1b4),'orderPlan',_0x2461b2(0x33b),_0x2461b2(0x2a7),'mode']});return(0x0,utils_1[_0x2461b2(0x1f7)])(this[_0x2461b2(0x27a)])?{'rows':_0x10c037||[],'count':_0x10b8c6||0x0}:{'rows':_0x10c037['map'](_0x5df50d=>({..._0x5df50d,'authorization':(0x0,utils_1[_0x2461b2(0x289)])(_0x5df50d[_0x2461b2(0x30a)]),'guildId':(0x0,utils_1[_0x2461b2(0x289)])(_0x5df50d['guildId']),'channelId':(0x0,utils_1[_0x2461b2(0x289)])(_0x5df50d[_0x2461b2(0x2bb)])}))||[],'count':_0x10b8c6||0x0};}async[_0x4c31a7(0x2be)](_0x521480,_0x1aa72e,_0x4637f7){const _0x29b7bf=_0x4c31a7;try{const _0x507a02=(0x0,utils_1[_0x29b7bf(0x1eb)])(this[_0x29b7bf(0x27a)]),{page:page=0x1,size:size=0x14,botType:_0x4f18de,action:_0x3c56b4,keyword:_0x7e6680,userId:_0x3f60d4,rec:_0x5de1ea,status:_0x484a1d,squareType:_0x215830,workflowId:_0x45aeb7,saasId:_0x43328b}=_0x521480,_0x36bb4d={};_0x4f18de&&_0x4f18de['length']&&(_0x36bb4d[_0x29b7bf(0x333)]=(0x0,typeorm_2['In'])(_0x4f18de));_0x3c56b4&&(_0x36bb4d[_0x29b7bf(0x320)]=_0x3c56b4);_0x7e6680&&(_0x36bb4d['originPrompt']=(0x0,typeorm_2[_0x29b7bf(0x275)])('%'+_0x7e6680+'%'));_0x4637f7&&_0x3f60d4&&(_0x36bb4d[_0x29b7bf(0x28d)]=_0x3f60d4);_0x1aa72e&&_0x1aa72e['user']?.['id']&&(_0x36bb4d[_0x29b7bf(0x28d)]=_0x1aa72e[_0x29b7bf(0x340)]['id']);_0x215830&&(_0x36bb4d[_0x29b7bf(0x16e)]=_0x215830);_0x45aeb7&&(_0x36bb4d[_0x29b7bf(0x2c2)]=_0x45aeb7);_0x5de1ea!==null&&_0x5de1ea!==undefined&&(_0x36bb4d[_0x29b7bf(0x2f9)]=_0x5de1ea);_0x5de1ea!==null&&_0x484a1d!==undefined&&(_0x36bb4d[_0x29b7bf(0x1af)]=_0x484a1d);(0x0,utils_1[_0x29b7bf(0x1b2)])(this['clsService'])?(0x0,utils_1[_0x29b7bf(0x1bc)])(_0x43328b)&&(_0x36bb4d[_0x29b7bf(0x172)]=_0x43328b):_0x36bb4d[_0x29b7bf(0x172)]=_0x507a02;const [_0x5d3c40,_0x25eb33]=await this[_0x29b7bf(0x2f8)][_0x29b7bf(0x318)]({'where':_0x36bb4d,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':'DESC'}}),_0x41d85d=new Map(),_0x75963=_0x5d3c40[_0x29b7bf(0x19a)](_0x597c13=>_0x597c13[_0x29b7bf(0x2c2)])[_0x29b7bf(0x237)](_0x1624ce=>Boolean(_0x1624ce));if(_0x75963[_0x29b7bf(0x252)]){const _0x4bb5bd=await this['modelsService'][_0x29b7bf(0x343)](_0x75963);_0x4bb5bd[_0x29b7bf(0x1ec)](_0x1a319e=>_0x41d85d[_0x29b7bf(0x28f)](_0x1a319e['id'],_0x1a319e));}const _0x4283c5=_0x5d3c40[_0x29b7bf(0x19a)](_0x5b5d5f=>{const _0x1bc72e=_0x29b7bf;return{..._0x5b5d5f,'workflowName':_0x41d85d['get'](_0x5b5d5f['workflowId'])?.[_0x1bc72e(0x374)]||''};});if(_0x4637f7){const _0x4e6be8=_0x4283c5['map'](_0x5707e4=>_0x5707e4[_0x29b7bf(0x28d)]),_0x8b74f7=await this[_0x29b7bf(0x2d8)][_0x29b7bf(0x2f7)](_0x4e6be8);_0x4283c5['forEach'](_0x3bdb37=>{const _0x1163dd=_0x29b7bf,_0x47f9b4=_0x8b74f7['find'](_0x37028b=>_0x37028b['id']===_0x3bdb37[_0x1163dd(0x28d)]);!(0x0,utils_1[_0x1163dd(0x1f7)])(this['clsService'])&&(_0x47f9b4[_0x1163dd(0x2c4)]=(0x0,utils_1[_0x1163dd(0x289)])(_0x47f9b4[_0x1163dd(0x2c4)]),_0x47f9b4[_0x1163dd(0x34a)]=(0x0,utils_1['hideString'])(_0x47f9b4[_0x1163dd(0x34a)])),_0x3bdb37['userInfo']=_0x47f9b4;});}else{const _0x44bf2d=_0x4283c5[_0x29b7bf(0x19a)](_0x140ff9=>_0x140ff9['userId']),_0x135c04=await this[_0x29b7bf(0x2d8)]['getUserListByIds'](_0x44bf2d);_0x4283c5[_0x29b7bf(0x1ec)](_0xb2704c=>{const _0x80e42d=_0x29b7bf,_0xac30e4=_0x135c04[_0x80e42d(0x1e9)](_0x25c693=>_0x25c693['id']===_0xb2704c[_0x80e42d(0x28d)]);if(_0xac30e4){const _0x59814d={'nickname':_0xac30e4?.[_0x80e42d(0x287)],'avatar':_0xac30e4?.[_0x80e42d(0x2d0)]};_0xb2704c[_0x80e42d(0x1d4)]=_0x59814d;}});}const _0x13cb65=_0x1aa72e?this[_0x29b7bf(0x2d8)][_0x29b7bf(0x18c)](_0x1aa72e):null,_0x307489=_0x13cb65?.['id'],_0x36cee7=_0x5d3c40['map'](_0x4560d0=>_0x4560d0['id']),_0x273edf=await this[_0x29b7bf(0x284)][_0x29b7bf(0x265)](_0x307489,_0x36cee7,model_constant_1[_0x29b7bf(0x29f)][_0x29b7bf(0x2a4)]),_0x17af72=new Map(),_0xf5756f=_0x5d3c40[_0x29b7bf(0x19a)](_0x37c818=>_0x37c818['userId'])[_0x29b7bf(0x237)](_0x37da1c=>_0x37da1c);if(_0xf5756f[_0x29b7bf(0x252)]){const _0x2ee07e=(await this[_0x29b7bf(0x2d8)][_0x29b7bf(0x2f7)](_0xf5756f))['map'](_0x31e88d=>{const _0x5288e8=_0x29b7bf;return{'id':_0x31e88d['id'],'nickname':_0x31e88d[_0x5288e8(0x287)],'avatar':_0x31e88d[_0x5288e8(0x2d0)]};});_0x2ee07e[_0x29b7bf(0x1ec)](_0x407237=>_0x17af72[_0x29b7bf(0x28f)](_0x407237['id'],_0x407237));}const _0x155006=await this['aiLogService'][_0x29b7bf(0x162)](_0x36cee7,model_constant_1[_0x29b7bf(0x29f)]['DRAW']);_0x4283c5['forEach'](_0x20c000=>{const _0x20426e=_0x29b7bf,_0x134bb=_0x155006['get'](_0x20c000['id']);_0x20c000[_0x20426e(0x2fb)]=_0x273edf[_0x20426e(0x1e2)](_0x20c000['id'])||null,_0x20c000[_0x20426e(0x1d4)]=_0x17af72[_0x20426e(0x1e2)](_0x20c000[_0x20426e(0x28d)]),_0x20c000[_0x20426e(0x194)]=_0x134bb?.[_0x20426e(0x194)]||0x0;});let _0x229e53=await this[_0x29b7bf(0x2d8)][_0x29b7bf(0x20e)](_0x5d3c40,_0x307489,collectType_constant_1[_0x29b7bf(0x1db)]['MJ']);return _0x229e53=await this['userService'][_0x29b7bf(0x244)](_0x5d3c40,collectType_constant_1[_0x29b7bf(0x1db)]['MJ']),this['mergeThumb'](_0x229e53),{'rows':_0x229e53,'count':_0x25eb33};}catch(_0x55f509){throw new common_1[(_0x29b7bf(0x294))](_0x55f509['message'],common_1[_0x29b7bf(0x16b)][_0x29b7bf(0x32d)]);}}async[_0x4c31a7(0x170)](_0x307ff1,_0x550f3d){const _0x1f9537=_0x4c31a7;try{const {page:page=0x1,size:size=0x14,squareType:_0x33c324,keyword:_0x8e0d21}=_0x307ff1;let _0x41f915=[];_0x8e0d21&&_0x41f915['push'](_0x1f9537(0x306)+_0x8e0d21+'%\x27)');_0x33c324&&_0x41f915['push'](_0x1f9537(0x231)+_0x33c324);const _0x200927=_0x41f915[_0x1f9537(0x252)]?_0x41f915['join'](_0x1f9537(0x25b)):'',_0x35cf0d=await this[_0x1f9537(0x362)]['query'](_0x1f9537(0x19e)+_0x200927+_0x1f9537(0x183)+size+_0x1f9537(0x17d)+(page-0x1)*size+_0x1f9537(0x331)),_0x398859=_0x35cf0d[_0x1f9537(0x19a)](_0x101591=>_0x101591['userId']),_0x15835a=await this[_0x1f9537(0x2d8)][_0x1f9537(0x2f7)](_0x398859),_0xf4365=_0x550f3d?this[_0x1f9537(0x2d8)]['getUserInfoFromHeader'](_0x550f3d):null,_0x20f63a=_0xf4365?.['id'],_0xca7780=_0x35cf0d[_0x1f9537(0x19a)](_0x57151a=>_0x57151a['id']),_0x4ddd76=await this[_0x1f9537(0x284)][_0x1f9537(0x178)](_0x20f63a,_0xca7780,model_constant_1[_0x1f9537(0x29f)][_0x1f9537(0x2a4)]),_0x22c079=await this[_0x1f9537(0x284)][_0x1f9537(0x330)](_0xca7780,model_constant_1[_0x1f9537(0x29f)][_0x1f9537(0x2a4)]);_0x35cf0d[_0x1f9537(0x1ec)](_0x47e2cd=>{const _0x309c5f=_0x1f9537,_0x3a0bf4=_0x15835a['find'](_0x18cf1f=>_0x18cf1f['id']===_0x47e2cd[_0x309c5f(0x28d)]);if(_0x3a0bf4){const _0x2e9a10={'nickname':_0x3a0bf4?.[_0x309c5f(0x287)],'avatar':_0x3a0bf4?.['avatar']};_0x47e2cd[_0x309c5f(0x1d4)]=_0x2e9a10;}const _0x1c1f69=_0x22c079['get'](_0x47e2cd['id']+_0x47e2cd[_0x309c5f(0x277)]);_0x47e2cd[_0x309c5f(0x2fb)]=_0x4ddd76[_0x309c5f(0x1e2)](_0x47e2cd['id']+_0x47e2cd['model'])||null,_0x47e2cd['agreeNum']=_0x1c1f69?.[_0x309c5f(0x194)]||0x0;});let _0xa9a8ee=await this[_0x1f9537(0x2d8)][_0x1f9537(0x20e)](_0x35cf0d,_0x20f63a,collectType_constant_1[_0x1f9537(0x1db)]['MJ']);return _0xa9a8ee=await this[_0x1f9537(0x2d8)][_0x1f9537(0x244)](_0x35cf0d,collectType_constant_1[_0x1f9537(0x1db)]['MJ']),this[_0x1f9537(0x1ae)](_0xa9a8ee),_0xa9a8ee;}catch(_0x31f2d0){console[_0x1f9537(0x21e)](_0x1f9537(0x1ee),_0x31f2d0);throw new common_1[(_0x1f9537(0x294))](_0x31f2d0['message'],common_1[_0x1f9537(0x16b)]['BAD_REQUEST']);}}async[_0x4c31a7(0x190)](_0x16673c){const _0x6569f4=_0x4c31a7,_0x49ec62=await this[_0x6569f4(0x1cf)][_0x6569f4(0x35b)](['mjLimitCount']),_0x1190d0=Number(_0x49ec62||0x0);if(_0x1190d0===0x0)return!![];const _0x1d128f=await this[_0x6569f4(0x2f8)][_0x6569f4(0x255)]({'where':{'userId':_0x16673c,'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x1d128f<_0x1190d0)return!![];else throw new Error(_0x6569f4(0x312));}async[_0x4c31a7(0x1a0)](_0x2ad09c){const _0x339cc2=_0x4c31a7;if(store_1['MjConfig']['mjModel']!==_0x339cc2(0x2fe))return null;return null;}async[_0x4c31a7(0x24a)](_0x3b5bb9,_0x3eb3d8){const _0x4e037f=_0x4c31a7,_0x13a0d4=await this[_0x4e037f(0x2f8)][_0x4e037f(0x255)]({'where':{'originTaskId':String(_0x3b5bb9),'customId':_0x3eb3d8}});if(_0x13a0d4>0x0)throw new common_1['HttpException'](_0x4e037f(0x28e),common_1[_0x4e037f(0x16b)]['BAD_REQUEST']);return![];}async[_0x4c31a7(0x2b0)](_0x11759b){const _0xf08397=_0x4c31a7,_0x101b83=new addDrawQueue_dto_1[(_0xf08397(0x360))](_0x11759b);await this[_0xf08397(0x2df)][_0xf08397(0x353)](_0x101b83['fullPrompt'],_0x101b83['userId']);const _0x288bb0=(0x0,utils_1[_0xf08397(0x1eb)])(this['clsService']);_0x101b83[_0xf08397(0x172)]=_0x288bb0;const _0x65ce26=await this[_0xf08397(0x2f8)][_0xf08397(0x29b)](_0x101b83);return _0x65ce26;}[_0x4c31a7(0x1de)](_0x5f300d){const _0xb15842=_0x4c31a7,_0x45be24=_0x5f300d[_0xb15842(0x1e3)](),_0x5ac564=_0x45be24[_0xb15842(0x317)]('\x20'),_0x4e4cd7={};for(let _0x5e2e48=0x0;_0x5e2e48<_0x5ac564[_0xb15842(0x252)];_0x5e2e48++){_0x5ac564[_0x5e2e48][_0xb15842(0x1ca)]('--')&&(_0x5e2e48+0x1<_0x5ac564[_0xb15842(0x252)]&&!_0x5ac564[_0x5e2e48+0x1][_0xb15842(0x1ca)]('--')?(_0x4e4cd7[_0x5ac564[_0x5e2e48]]=_0x5ac564[_0x5e2e48+0x1],_0x5e2e48++):_0x4e4cd7[_0x5ac564[_0x5e2e48]]=_0x5ac564[_0x5e2e48]);}return _0x4e4cd7;}async[_0x4c31a7(0x18b)](_0x2e0aec,_0x17c3f1){const _0x489ad=_0x4c31a7;let _0x2ea583,{botType:_0x10bf0a,prompt:_0x1c7b45,extend:_0xf92f55,action:_0x5d968a,mode:_0x85b7fa,translate:_0x175156,base64Array:_0x54c569,mats:mats=[],iw:_0x27cdcc,roles:roles=[],cw:_0x569012,styles:styles=[],sw:_0x186478}=_0x17c3f1;_0x85b7fa=await this[_0x489ad(0x2d8)][_0x489ad(0x2f1)](_0x2e0aec[_0x489ad(0x340)]['id'],_0x85b7fa,'Imagine');const _0x4f7464=_0x1c7b45,_0x16b885=await this[_0x489ad(0x1a0)](_0x85b7fa);_0x1c7b45&&await this[_0x489ad(0x2df)][_0x489ad(0x353)](_0x1c7b45,_0x2e0aec[_0x489ad(0x340)]['id']),_0x1c7b45=_0x175156===0x1&&(0x0,utils_1[_0x489ad(0x288)])(_0x1c7b45)?await this[_0x489ad(0x260)][_0x489ad(0x2e0)](_0x1c7b45):_0x1c7b45;let _0x280d8c=_0x1c7b45;mats[_0x489ad(0x252)]&&(_0x280d8c=mats[_0x489ad(0x1c8)]('\x20')+'\x20'+_0x280d8c);_0x27cdcc&&_0x1c7b45['indexOf']('--iw')==-0x1&&(_0x280d8c=_0x280d8c+_0x489ad(0x1f3)+_0x27cdcc);styles[_0x489ad(0x252)]&&_0x1c7b45[_0x489ad(0x1e6)]('--sref')==-0x1&&(_0x280d8c=_0x280d8c+_0x489ad(0x2ed)+styles['join']('\x20'));roles[_0x489ad(0x252)]&&_0x1c7b45[_0x489ad(0x1e6)](_0x489ad(0x2d2))==-0x1&&(_0x280d8c=_0x280d8c+_0x489ad(0x31f)+roles['join']('\x20'));_0x569012&&_0x1c7b45[_0x489ad(0x1e6)]('--cw')==-0x1&&(_0x280d8c=_0x280d8c+'\x20--cw\x20'+_0x569012);_0x186478&&_0x1c7b45[_0x489ad(0x1e6)](_0x489ad(0x276))==-0x1&&(_0x280d8c=_0x280d8c+_0x489ad(0x232)+_0x186478);if(_0xf92f55){const _0x4cfd20=this[_0x489ad(0x1de)](_0xf92f55);Object['keys'](_0x4cfd20)[_0x489ad(0x1ec)](_0x412c4c=>{const _0x123590=_0x489ad;_0x1c7b45[_0x123590(0x1e6)](_0x412c4c)==-0x1&&(_0x412c4c!=_0x4cfd20[_0x412c4c]?_0x280d8c+='\x20'+_0x412c4c+'\x20'+_0x4cfd20[_0x412c4c]:_0x280d8c+='\x20'+_0x412c4c);});}const _0x102e11=await this['mjpTaskService'][_0x489ad(0x18b)]({'data':{'mode':this[_0x489ad(0x243)](_0x85b7fa),'prompt':_0x280d8c,'botType':_0x10bf0a||_0x489ad(0x246),'base64Array':_0x54c569,'accountFilter':_0x16b885}});if(_0x102e11[_0x489ad(0x2a5)]===0x17)throw new Error(_0x489ad(0x313));if(_0x102e11['code']===0x18)throw new Error('prompt包含敏感词');if(_0x102e11['code']!==0x1&&_0x102e11['code']!==0x16)throw new Error(_0x102e11[_0x489ad(0x257)]);return _0x2ea583=await this[_0x489ad(0x362)][_0x489ad(0x256)](async()=>{const _0x2a0eae=_0x489ad,_0x94e35f={'mode':_0x85b7fa,'prompt':_0x1c7b45,'action':_0x5d968a,'translate':_0x175156,'fullPrompt':_0x280d8c,'originPrompt':_0x4f7464,'extraParam':_0xf92f55,'userId':_0x2e0aec[_0x2a0eae(0x340)]['id'],'mjpId':_0x16b885?.['instanceId'],'mjpTaskId':_0x102e11['result'],'botType':_0x10bf0a||_0x2a0eae(0x246),'requestParams':_0x17c3f1},_0x3582e6=await this[_0x2a0eae(0x2b0)](_0x94e35f);if(!_0x3582e6)throw new Error(_0x2a0eae(0x2de));return await this[_0x2a0eae(0x2d8)][_0x2a0eae(0x2bf)](_0x2e0aec['user']['id'],_0x85b7fa,'Imagine',_0x3582e6['id']),_0x3582e6;}),_0x2ea583;}async['actionTask'](_0x2770c2,_0x23d835){const _0xe30027=_0x4c31a7;let _0x5bec8d;const {action:_0x26e244,taskId:_0x1a16a7,customId:_0x1f437a,prompt:_0x31611d,mask:_0x3e38e5,enableRemix:_0x19782e}=_0x23d835,_0x15105f=await this[_0xe30027(0x2f8)][_0xe30027(0x30b)]({'where':{'id':_0x1a16a7}});if(!_0x15105f)throw new Error('无绘图记录');let _0x319937=await this[_0xe30027(0x2d8)][_0xe30027(0x2f1)](_0x2770c2[_0xe30027(0x340)]['id'],_0x15105f['mode'],_0x1f437a);const _0x81eca2=await this[_0xe30027(0x1c6)]['action']({'data':{'customId':_0x1f437a,'taskId':_0x15105f[_0xe30027(0x176)],'accountFilter':{'instanceId':_0x15105f[_0xe30027(0x36f)]},'mode':this[_0xe30027(0x243)](_0x319937),'enableRemix':_0x19782e===undefined?!![]:_0x19782e}});if(_0x81eca2[_0xe30027(0x2a5)]===0x17)throw new Error('队列已满，请稍后尝试');else{if(_0x81eca2['code']===0x18)throw new Error(_0xe30027(0x219));else{if(_0x81eca2[_0xe30027(0x2a5)]===0x15)setTimeout(()=>this['syncTaskInfo'](_0x81eca2['result']));else{if(_0x81eca2[_0xe30027(0x2a5)]!==0x1&&_0x81eca2[_0xe30027(0x2a5)]!==0x16)throw new Error(_0x81eca2[_0xe30027(0x257)]);}}}return _0x5bec8d=await this[_0xe30027(0x362)][_0xe30027(0x256)](async()=>{const _0x4da236=_0xe30027,_0x54109c={'action':_0x26e244,'customId':_0x1f437a,'userId':_0x2770c2[_0x4da236(0x340)]['id'],'mjpTaskId':_0x81eca2['result'],'originTaskId':String(_0x1a16a7),'mode':_0x319937,'mjpId':_0x15105f['mjpId'],'prompt':_0x15105f[_0x4da236(0x26d)],'botType':_0x15105f[_0x4da236(0x333)],'extraParam':_0x15105f['extraParam'],'fullPrompt':_0x15105f[_0x4da236(0x2c8)],'originPrompt':_0x15105f[_0x4da236(0x1e8)]},_0x29cf8c=await this[_0x4da236(0x2b0)](_0x54109c);if(!_0x29cf8c)throw new Error(_0x4da236(0x33a));const _0x22465e=_0x15105f[_0x4da236(0x169)];return _0x15105f[_0x4da236(0x169)][_0x4da236(0x1ec)](_0x22a2ae=>{const _0x4c0f58=_0x4da236;_0x22a2ae[_0x4c0f58(0x250)]===_0x23d835[_0x4c0f58(0x250)]&&(_0x22a2ae[_0x4c0f58(0x36d)]=!![]);}),await this[_0x4da236(0x2f8)][_0x4da236(0x29b)](_0x15105f),await this[_0x4da236(0x2d8)][_0x4da236(0x2bf)](_0x2770c2[_0x4da236(0x340)]['id'],_0x319937,_0x1f437a,_0x29cf8c['id']),_0x29cf8c;}),_0x5bec8d;}async[_0x4c31a7(0x1f1)](_0x109905,_0x58f48c){const _0xf5beb4=_0x4c31a7;let _0xf22c92,{action:_0x322382,taskId:_0x218ece,customId:_0x53ff70,prompt:_0x275664,mask:_0x5e4d1e}=_0x58f48c;const _0x195c91=await this[_0xf5beb4(0x2f8)][_0xf5beb4(0x30b)]({'where':{'id':_0x218ece}});if(!_0x195c91)throw new Error(_0xf5beb4(0x348));const _0x7ed0df=_0x275664;_0x275664&&await this['badwordsService'][_0xf5beb4(0x353)](_0x275664,_0x109905[_0xf5beb4(0x340)]['id']),_0x275664=(0x0,utils_1[_0xf5beb4(0x288)])(_0x275664)?await this[_0xf5beb4(0x260)][_0xf5beb4(0x2e0)](_0x275664):_0x275664;const _0xbdb256={'taskId':_0x195c91['mjpTaskId']};_0x275664&&(_0xbdb256[_0xf5beb4(0x26d)]=_0x275664);_0x5e4d1e&&(_0xbdb256[_0xf5beb4(0x2e7)]=_0x5e4d1e);const _0x1ffcd0=await this[_0xf5beb4(0x1c6)][_0xf5beb4(0x1b7)]({'data':_0xbdb256});if(_0x1ffcd0[_0xf5beb4(0x2a5)]!==0x1&&_0x1ffcd0[_0xf5beb4(0x2a5)]!==0x16)throw new Error(_0x1ffcd0[_0xf5beb4(0x257)]);_0xf22c92=await this[_0xf5beb4(0x2f8)][_0xf5beb4(0x29b)]({'id':_0x218ece,'prompt':_0x275664,'status':0x1,'originPrompt':_0x7ed0df,'messageFlags':0x1,'requestParams':_0x58f48c});for(let _0x2f4db0 in _0xf22c92){_0xf22c92[_0x2f4db0]&&(_0x195c91[_0x2f4db0]=_0xf22c92[_0x2f4db0]);}return _0x195c91;}async['handleAddDrawTask'](_0x2edc4b,_0x3ecd5b){const _0x138e40=_0x4c31a7;let _0x548a12,_0xc0ce97;try{let {type:_0x2b8864,params:_0x1f1cfd}=_0x2edc4b;await this[_0x138e40(0x2d8)][_0x138e40(0x208)](_0x3ecd5b[_0x138e40(0x340)]),await this[_0x138e40(0x190)](_0x3ecd5b[_0x138e40(0x340)]['id']);if(_0x2b8864===midjourney_constant_1[_0x138e40(0x2d9)]['TEXT_TO_IMAGE'])_0xc0ce97=await this[_0x138e40(0x18b)](_0x3ecd5b,_0x1f1cfd),_0x548a12=_0xc0ce97[_0x138e40(0x176)];else{if(_0x2b8864===midjourney_constant_1['MidJourneyDrawEnum']['IMAGE_ACTION'])_0x1f1cfd=_0x1f1cfd,_0x1f1cfd[_0x138e40(0x250)]?(_0xc0ce97=await this[_0x138e40(0x198)](_0x3ecd5b,_0x1f1cfd),_0x1f1cfd[_0x138e40(0x26d)]&&(_0x1f1cfd['taskId']=_0xc0ce97['id'],_0xc0ce97=await this[_0x138e40(0x1f1)](_0x3ecd5b,_0x1f1cfd))):_0xc0ce97=await this[_0x138e40(0x1f1)](_0x3ecd5b,_0x1f1cfd),_0x548a12=_0xc0ce97[_0x138e40(0x176)];else return new common_1[(_0x138e40(0x294))]('任务类型错误',common_1[_0x138e40(0x16b)]['BAD_REQUEST']);}return _0xc0ce97;}catch(_0x2101b4){if(_0x2101b4 instanceof common_1[_0x138e40(0x294)])throw _0x2101b4;else{_0x548a12&&await this[_0x138e40(0x1c6)]['cancel']({},_0x548a12);throw new common_1[(_0x138e40(0x294))](_0x2101b4[_0x138e40(0x182)],common_1[_0x138e40(0x16b)][_0x138e40(0x32d)]);}}}async[_0x4c31a7(0x274)](_0x35877b,_0x3b04e5){const _0x3632d6=_0x4c31a7;let _0x2344f7,_0x356b11;try{let {type:_0x2476b4,botType:_0x2beb92,files:_0x25ad2a,mode:_0x4b5efc,action:_0x17d9db,size:_0x467b6c,base64Array:base64Array=[]}=_0x35877b;await this[_0x3632d6(0x2d8)][_0x3632d6(0x208)](_0x3b04e5[_0x3632d6(0x340)]),await this[_0x3632d6(0x190)](_0x3b04e5['user']['id']);let _0x3bf64f='';if(Number(_0x2476b4)===midjourney_constant_1['MidJourneyDrawEnum']['IMAGE_MIX_IMAGE'])_0x3bf64f='Blend';else Number(_0x2476b4)===midjourney_constant_1[_0x3632d6(0x2d9)][_0x3632d6(0x2a6)]&&(_0x3bf64f='Describe');_0x4b5efc=await this[_0x3632d6(0x2d8)][_0x3632d6(0x2f1)](_0x3b04e5[_0x3632d6(0x340)]['id'],_0x4b5efc,_0x3bf64f);const _0xa0b8f1=await this[_0x3632d6(0x1a0)](_0x4b5efc);if(!base64Array[_0x3632d6(0x252)])for(let _0x505344=0x0;_0x505344<_0x25ad2a[_0x3632d6(0x252)];_0x505344++){base64Array[_0x3632d6(0x19f)](_0x3632d6(0x166)+_0x25ad2a[_0x505344][_0x3632d6(0x299)][_0x3632d6(0x187)]('base64'));}if(Number(_0x2476b4)===midjourney_constant_1[_0x3632d6(0x2d9)][_0x3632d6(0x16c)]){if(base64Array[_0x3632d6(0x252)]<0x2)throw new Error(_0x3632d6(0x2af));const _0x400847=await this['mjpTaskService'][_0x3632d6(0x175)]({'data':{'mode':this[_0x3632d6(0x243)](_0x4b5efc),'dimensions':_0x467b6c,'botType':_0x3632d6(0x246),'base64Array':base64Array,'accountFilter':_0xa0b8f1}});if(_0x400847[_0x3632d6(0x2a5)]===0x17)throw new Error(_0x3632d6(0x313));if(_0x400847[_0x3632d6(0x2a5)]!==0x1&&_0x400847[_0x3632d6(0x2a5)]!==0x16)throw new Error(_0x400847[_0x3632d6(0x257)]);_0x2344f7=_0x400847[_0x3632d6(0x31e)],_0x356b11=await this['connection'][_0x3632d6(0x256)](async()=>{const _0x1e9708=_0x3632d6,_0x29eb21={'mode':_0x4b5efc,'action':_0x17d9db,'userId':_0x3b04e5['user']['id'],'jobId':(0x0,utils_1[_0x1e9708(0x2cc)])(),'botType':_0x2beb92||_0x1e9708(0x246),'originPrompt':'','mjpTaskId':_0x400847[_0x1e9708(0x31e)]},_0x1bce52=await this['addDrawQueue'](_0x29eb21);if(!_0x1bce52)throw new Error(_0x1e9708(0x325));return await this[_0x1e9708(0x2d8)][_0x1e9708(0x2bf)](_0x3b04e5[_0x1e9708(0x340)]['id'],_0x4b5efc,_0x3bf64f,_0x1bce52['id']),_0x1bce52;});}else{if(Number(_0x2476b4)===midjourney_constant_1[_0x3632d6(0x2d9)]['IMAGE_TO_TEXT']){const _0x44e4bc=await this['mjpTaskService'][_0x3632d6(0x2da)]({'data':{'mode':this[_0x3632d6(0x243)](_0x4b5efc),'botType':_0x3632d6(0x246),'base64':base64Array[0x0],'accountFilter':_0xa0b8f1}});if(_0x44e4bc['code']===0x17)throw new Error(_0x3632d6(0x313));if(_0x44e4bc[_0x3632d6(0x2a5)]!==0x1&&_0x44e4bc[_0x3632d6(0x2a5)]!==0x16)throw new Error(_0x44e4bc[_0x3632d6(0x257)]);_0x2344f7=_0x44e4bc[_0x3632d6(0x31e)],_0x356b11=await this[_0x3632d6(0x362)][_0x3632d6(0x256)](async()=>{const _0x744b16=_0x3632d6,_0x230836={'mode':_0x4b5efc,'action':_0x17d9db,'userId':_0x3b04e5[_0x744b16(0x340)]['id'],'jobId':(0x0,utils_1[_0x744b16(0x2cc)])(),'botType':_0x2beb92||_0x744b16(0x246),'extraParam':JSON[_0x744b16(0x19d)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x44e4bc['result']},_0x9ddd8b=await this[_0x744b16(0x2b0)](_0x230836);if(!_0x9ddd8b)throw new Error(_0x744b16(0x2bc));return await this[_0x744b16(0x2d8)]['deductBalance4MJ'](_0x3b04e5[_0x744b16(0x340)]['id'],_0x4b5efc,_0x3bf64f,_0x9ddd8b['id']),_0x9ddd8b;})[_0x3632d6(0x2b3)](async _0x2366a4=>{const _0x428aa0=_0x3632d6;await this['mjpTaskService'][_0x428aa0(0x1a7)]({},_0x44e4bc[_0x428aa0(0x31e)]);throw _0x2366a4;});}else return new common_1[(_0x3632d6(0x294))](_0x3632d6(0x1f6),common_1[_0x3632d6(0x16b)][_0x3632d6(0x32d)]);}return _0x356b11;}catch(_0x29bb0e){if(_0x29bb0e instanceof common_1['HttpException'])throw _0x29bb0e;else{_0x2344f7&&await this[_0x3632d6(0x1c6)]['cancel']({},_0x2344f7);throw new common_1[(_0x3632d6(0x294))](_0x29bb0e[_0x3632d6(0x182)],common_1[_0x3632d6(0x16b)]['BAD_REQUEST']);}}}async[_0x4c31a7(0x1d9)](_0x50038c,_0x51d216){const _0x770847=_0x4c31a7;let _0x586308;try{const {params:_0x2c10fa}=_0x50038c;let {mode:_0x35594c,botType:_0x296df9,action:_0x30ac3f,extend:_0x39c8b1,sourceBase64:_0x330964,targetBase64:_0x54e7f6}=_0x2c10fa;await this['userService'][_0x770847(0x208)](_0x51d216[_0x770847(0x340)]),await this[_0x770847(0x190)](_0x51d216[_0x770847(0x340)]['id']),_0x35594c=await this[_0x770847(0x2d8)][_0x770847(0x2f1)](_0x51d216[_0x770847(0x340)]['id'],_0x35594c,_0x770847(0x26c));const _0xd598e9=await this[_0x770847(0x1a0)](_0x35594c),_0x3184a7=await this[_0x770847(0x1c6)][_0x770847(0x23c)]({'data':{'sourceBase64':_0x330964,'targetBase64':_0x54e7f6,'state':_0x39c8b1,'mode':this[_0x770847(0x243)](_0x35594c),'accountFilter':_0xd598e9}});if(_0x3184a7[_0x770847(0x2a5)]===0x17)throw new Error(_0x770847(0x313));if(_0x3184a7[_0x770847(0x2a5)]===0x18)throw new Error(_0x770847(0x219));if(_0x3184a7[_0x770847(0x2a5)]!==0x1&&_0x3184a7['code']!==0x16)throw new Error(_0x3184a7[_0x770847(0x257)]);return _0x586308=await this[_0x770847(0x362)][_0x770847(0x256)](async()=>{const _0x12279b=_0x770847,_0x55cad2={'mode':_0x35594c,'action':_0x30ac3f,'prompt':null,'extraParam':_0x39c8b1,'originPrompt':null,'userId':_0x51d216['user']['id'],'mjpId':_0xd598e9?.[_0x12279b(0x1a9)],'mjpTaskId':_0x3184a7[_0x12279b(0x31e)],'botType':_0x296df9||'MID_JOURNEY'},_0x238b78=new addDrawQueue_dto_1[(_0x12279b(0x360))](_0x55cad2),_0x431b32=(0x0,utils_1[_0x12279b(0x1eb)])(this[_0x12279b(0x27a)]);_0x238b78[_0x12279b(0x172)]=_0x431b32;const _0x37183a=await this[_0x12279b(0x2f8)][_0x12279b(0x29b)](_0x238b78);if(!_0x37183a)throw new Error(_0x12279b(0x2de));return await this[_0x12279b(0x2d8)][_0x12279b(0x2bf)](_0x51d216[_0x12279b(0x340)]['id'],_0x35594c,'FaceSwap',_0x37183a['id']),_0x37183a;}),_0x586308;}catch(_0x597c0e){if(_0x597c0e instanceof common_1['HttpException'])throw _0x597c0e;else throw new common_1['HttpException'](_0x597c0e['message'],common_1[_0x770847(0x16b)]['BAD_REQUEST']);}}async[_0x4c31a7(0x193)](_0x24b8d8,_0x431a28){const _0x1ee5eb=_0x4c31a7,_0x17d5ae=(0x0,utils_1[_0x1ee5eb(0x1eb)])(this[_0x1ee5eb(0x27a)]),_0x38e7c7={'userId':_0x431a28[_0x1ee5eb(0x340)]['id'],'jobId':(0x0,utils_1[_0x1ee5eb(0x2cc)])(),'mode':0x1,'translate':0x0,'prompt':'','progress':0x64,'durationSpent':0x0,'status':0x3,'fullPrompt':_0x24b8d8[_0x1ee5eb(0x26d)],'originPrompt':_0x24b8d8[_0x1ee5eb(0x26d)],'fileInfo':_0x24b8d8[_0x1ee5eb(0x30c)],'botType':_0x24b8d8[_0x1ee5eb(0x333)],'imageUrl':_0x24b8d8[_0x1ee5eb(0x258)],'buttons':[],'saasId':_0x17d5ae},_0x2d61c0=await this[_0x1ee5eb(0x2f8)][_0x1ee5eb(0x29b)](_0x38e7c7);return _0x2d61c0;}async[_0x4c31a7(0x1ef)](_0x2d691b){const _0x380dd7=_0x4c31a7;try{const _0x272fc7=await this['midjourneyEntity']['findOne']({'where':{'jobId':_0x2d691b}});if(!_0x272fc7)throw new Error(_0x380dd7(0x2e5));const _0x20baef=await this['mjpTaskService'][_0x380dd7(0x1ef)]({},_0x272fc7[_0x380dd7(0x176)]);if(_0x20baef['code']!==0x1)throw new Error(_0x20baef[_0x380dd7(0x257)]);return _0x20baef[_0x380dd7(0x31e)];}catch(_0x3b8f4b){throw new common_1[(_0x380dd7(0x294))](_0x3b8f4b['message'],common_1['HttpStatus'][_0x380dd7(0x32d)]);}}async[_0x4c31a7(0x328)](_0x282c14,_0x30d9c6){const _0x5ac4e5=_0x4c31a7;try{let _0x30b91c,_0xc92d0a,_0x1a05e2,_0x4eb39f;const {jobId:_0xb3f803,detail:_0x13ad41}=_0x30d9c6,_0x30ff84=(0x0,utils_1[_0x5ac4e5(0x24f)])(this[_0x5ac4e5(0x27a)]),_0x1024a9=await this['midjourneyEntity'][_0x5ac4e5(0x30b)]({'where':{'jobId':_0xb3f803}});if(_0x1024a9[_0x5ac4e5(0x2c2)]){const _0x1f4ff5=await this[_0x5ac4e5(0x1fc)][_0x5ac4e5(0x2d6)](_0x1024a9[_0x5ac4e5(0x2c2)]);_0x4eb39f=_0x1f4ff5[_0x5ac4e5(0x374)];}return _0x13ad41&&(this[_0x5ac4e5(0x284)]['increaseVisit'](model_constant_1[_0x5ac4e5(0x29f)][_0x5ac4e5(0x2a4)],_0x1024a9['id']),_0x30b91c=await this[_0x5ac4e5(0x2d8)][_0x5ac4e5(0x35c)](_0x1024a9[_0x5ac4e5(0x28d)]),_0xc92d0a=await this[_0x5ac4e5(0x284)][_0x5ac4e5(0x370)](model_constant_1[_0x5ac4e5(0x29f)][_0x5ac4e5(0x2a4)],_0x1024a9['id']),_0x30ff84&&(_0x1a05e2=await this[_0x5ac4e5(0x284)][_0x5ac4e5(0x332)](model_constant_1[_0x5ac4e5(0x29f)]['DRAW'],_0x1024a9['id']))),{..._0x1024a9,'workflowName':_0x4eb39f,'avatar':_0x30b91c?_0x30b91c[_0x5ac4e5(0x2d0)]:null,'username':_0x30b91c?_0x30b91c['username']:null,'nickname':_0x30b91c?_0x30b91c[_0x5ac4e5(0x287)]:null,'visitNum':_0xc92d0a?_0xc92d0a[_0x5ac4e5(0x1a3)]:0x0,'agreeNum':_0xc92d0a?_0xc92d0a[_0x5ac4e5(0x194)]:0x0,'agree':_0x1a05e2?_0x1a05e2[_0x5ac4e5(0x320)]:null};}catch(_0x198e0d){throw new common_1[(_0x5ac4e5(0x294))](_0x198e0d[_0x5ac4e5(0x182)],common_1[_0x5ac4e5(0x16b)][_0x5ac4e5(0x32d)]);}}async[_0x4c31a7(0x1c0)](_0x1de81c){const _0x3584ed=_0x4c31a7;try{if(!_0x1de81c[_0x3584ed(0x225)]||!_0x1de81c[_0x3584ed(0x225)][_0x3584ed(0x252)])return[];const _0x100df7=_0x1de81c[_0x3584ed(0x225)][_0x3584ed(0x317)](','),_0x135e80=await this[_0x3584ed(0x2f8)]['find']({'where':{'jobId':(0x0,typeorm_2['In'])(_0x100df7)}}),_0x13e429=new Map(),_0x3e9a95=new Map(),_0x5b01db=_0x135e80[_0x3584ed(0x19a)](_0x3df7b0=>_0x3df7b0[_0x3584ed(0x2c2)])[_0x3584ed(0x237)](_0x4a2fb9=>Boolean(_0x4a2fb9)),_0xb1ab59=_0x135e80[_0x3584ed(0x19a)](_0x5ccb55=>_0x5ccb55['userId'])[_0x3584ed(0x237)](_0x222627=>_0x222627);if(_0x5b01db[_0x3584ed(0x252)]){const _0x4db492=await this[_0x3584ed(0x1fc)][_0x3584ed(0x343)](_0x5b01db);_0x4db492[_0x3584ed(0x1ec)](_0xacef49=>_0x13e429[_0x3584ed(0x28f)](_0xacef49['id'],_0xacef49));}if(_0xb1ab59[_0x3584ed(0x252)]){const _0x367f63=(await this[_0x3584ed(0x2d8)][_0x3584ed(0x2f7)](_0xb1ab59))[_0x3584ed(0x19a)](_0x4e2450=>{const _0x4d18d5=_0x3584ed;return{'id':_0x4e2450['id'],'nickname':_0x4e2450['nickname'],'avatar':_0x4e2450[_0x4d18d5(0x2d0)]};});_0x367f63[_0x3584ed(0x1ec)](_0x403df9=>_0x3e9a95[_0x3584ed(0x28f)](_0x403df9['id'],_0x403df9));}return this[_0x3584ed(0x1ae)](_0x135e80),_0x135e80['map'](_0x4ae408=>{const _0x32368d=_0x3584ed;return{..._0x4ae408,'userInfo':_0x3e9a95['get'](_0x4ae408['userId']),'workflowName':_0x13e429[_0x32368d(0x1e2)](_0x4ae408['workflowId'])?.[_0x32368d(0x374)]||''};});}catch(_0x273244){throw new common_1[(_0x3584ed(0x294))](_0x273244[_0x3584ed(0x182)],common_1[_0x3584ed(0x16b)][_0x3584ed(0x32d)]);}}async[_0x4c31a7(0x2fc)](_0x3dcab8){const _0x2dfc46=_0x4c31a7,{id:_0x50d179,squareType:_0x174270,rec:_0x4016e7}=_0x3dcab8,_0x2bd366=await this[_0x2dfc46(0x2f8)][_0x2dfc46(0x30b)]({'where':{'id':_0x50d179,'status':midjourney_constant_1['MidjourneyStatusEnum'][_0x2dfc46(0x221)]}});if(!_0x2bd366)throw new common_1[(_0x2dfc46(0x294))](_0x2dfc46(0x213),common_1[_0x2dfc46(0x16b)]['BAD_REQUEST']);const _0x58a11b=await this[_0x2dfc46(0x2f8)][_0x2dfc46(0x2a1)]({'id':_0x50d179},{'rec':_0x4016e7,'squareType':_0x174270})['catch'](_0x4a8f08=>{const _0x1d7d41=_0x2dfc46;throw new common_1[(_0x1d7d41(0x294))](_0x4a8f08,common_1[_0x1d7d41(0x16b)][_0x1d7d41(0x32d)]);});if(_0x58a11b[_0x2dfc46(0x229)]<=0x0)throw new common_1[(_0x2dfc46(0x294))]('操作失败！',common_1[_0x2dfc46(0x16b)][_0x2dfc46(0x32d)]);return await this[_0x2dfc46(0x17a)][_0x2dfc46(0x31b)]({'key':'squire-images'}),!![];}async[_0x4c31a7(0x2f6)](_0x5390aa,_0x1c7e7a){const _0x1b42b7=_0x4c31a7;return this[_0x1b42b7(0x1a6)][_0x1b42b7(0x1ac)]({'data':{'workflowId':_0x5390aa,'versionId':_0x1c7e7a}});}async['workflowPage'](_0x230ec9,_0x2fe8b6){const _0x261d0a=_0x4c31a7;try{const _0x1d67aa={'page':_0x2fe8b6[_0x261d0a(0x1d0)],'size':_0x2fe8b6['size'],'recommend':_0x2fe8b6[_0x261d0a(0x266)],'modelName':_0x2fe8b6[_0x261d0a(0x1b5)],'modelType':model_constant_1[_0x261d0a(0x29f)][_0x261d0a(0x278)]};(0x0,utils_1[_0x261d0a(0x32a)])(this[_0x261d0a(0x27a)])?_0x2fe8b6[_0x261d0a(0x1af)]!==undefined&&(_0x1d67aa[_0x261d0a(0x1af)]=Boolean(_0x2fe8b6[_0x261d0a(0x1af)])):_0x1d67aa[_0x261d0a(0x1af)]=!![];const _0xebbe41=await this[_0x261d0a(0x1fc)]['queryModels'](_0x230ec9,_0x1d67aa);let _0x4567f5=[];if(_0xebbe41[_0x261d0a(0x1d2)]['length']){const _0x1783c8=new Set(),_0x223887=(0x0,utils_1[_0x261d0a(0x24f)])(this[_0x261d0a(0x27a)]),_0xd0c9fa=_0xebbe41[_0x261d0a(0x1d2)][_0x261d0a(0x19a)](_0x14ac3f=>_0x14ac3f['id']);if(_0xd0c9fa[_0x261d0a(0x252)]&&_0x223887){const _0x5ba5a0=await this[_0x261d0a(0x2d8)]['favoriteListByTypeAndIds'](_0x223887,user_constant_1[_0x261d0a(0x315)][_0x261d0a(0x278)],_0xd0c9fa);_0x5ba5a0[_0x261d0a(0x1ec)](_0x1d8add=>_0x1783c8[_0x261d0a(0x1f5)](Number(_0x1d8add['relateId'])));}_0x4567f5=_0xebbe41[_0x261d0a(0x1d2)][_0x261d0a(0x19a)](_0x9b0715=>{const _0xdaaf61=_0x261d0a,_0x40e20e={'id':_0x9b0715['id'],'cover':_0x9b0715[_0xdaaf61(0x29a)],'name':_0x9b0715['modelName'],'workflowId':_0x9b0715[_0xdaaf61(0x277)],'config':_0x9b0715[_0xdaaf61(0x18f)],'recommend':_0x9b0715[_0xdaaf61(0x266)],'versionId':Number(_0x9b0715['key']),'deduct':_0x9b0715['deduct'],'vipFreeNum':_0x9b0715[_0xdaaf61(0x34f)],'displaySort':_0x9b0715[_0xdaaf61(0x355)],'description':_0x9b0715[_0xdaaf61(0x257)],'status':_0x9b0715[_0xdaaf61(0x1af)],'createdAt':_0x9b0715[_0xdaaf61(0x2a7)],'updatedAt':_0x9b0715['updatedAt'],'useCount':_0x9b0715['useCount'],'tutorial':_0x9b0715[_0xdaaf61(0x31c)],'freeUsed':_0x9b0715[_0xdaaf61(0x2ab)],'favorite':_0x1783c8[_0xdaaf61(0x364)](_0x9b0715['id'])};return _0x40e20e;});}return{'count':_0xebbe41[_0x261d0a(0x255)],'rows':_0x4567f5};}catch(_0x2c34e4){throw new common_1['HttpException'](_0x2c34e4[_0x261d0a(0x182)],common_1[_0x261d0a(0x16b)]['BAD_REQUEST']);}}async[_0x4c31a7(0x1ac)](_0x2f0617,_0x52b4d7){const _0x2fb5cf=_0x4c31a7;try{let _0x2375f1;const _0x1705c7=(0x0,utils_1[_0x2fb5cf(0x24f)])(this['clsService']),_0x5d795c=new Set(),_0x12e2ec=await this[_0x2fb5cf(0x1fc)][_0x2fb5cf(0x2d6)](_0x52b4d7);if(!_0x12e2ec)throw new common_1[(_0x2fb5cf(0x294))](_0x2fb5cf(0x25d),common_1[_0x2fb5cf(0x16b)][_0x2fb5cf(0x32d)]);if(_0x1705c7){const _0x297774=await this[_0x2fb5cf(0x2d8)][_0x2fb5cf(0x35c)](_0x1705c7);if(_0x297774[_0x2fb5cf(0x248)]||_0x297774[_0x2fb5cf(0x224)]){const _0x4bb7da=redisKey_constant_1[_0x2fb5cf(0x1ed)]+'-'+_0x1705c7+'-'+_0x12e2ec['id'];_0x2375f1=await await this[_0x2fb5cf(0x17a)][_0x2fb5cf(0x1e2)]({'key':_0x4bb7da});}const _0x1df37b=await this[_0x2fb5cf(0x2d8)][_0x2fb5cf(0x2b5)](_0x1705c7,user_constant_1['EFavorite'][_0x2fb5cf(0x278)],[_0x12e2ec['id']]);_0x1df37b[_0x2fb5cf(0x1ec)](_0x5a0d81=>_0x5d795c[_0x2fb5cf(0x1f5)](Number(_0x5a0d81[_0x2fb5cf(0x1f0)])));}const _0x29099f={'id':_0x12e2ec['id'],'cover':_0x12e2ec['cover'],'name':_0x12e2ec[_0x2fb5cf(0x374)],'workflowId':_0x12e2ec[_0x2fb5cf(0x277)],'config':_0x12e2ec[_0x2fb5cf(0x18f)],'versionId':Number(_0x12e2ec['key']),'deduct':_0x12e2ec[_0x2fb5cf(0x196)],'vipFreeNum':_0x12e2ec[_0x2fb5cf(0x34f)],'displaySort':_0x12e2ec[_0x2fb5cf(0x355)],'description':_0x12e2ec[_0x2fb5cf(0x257)],'status':_0x12e2ec['status'],'createdAt':_0x12e2ec[_0x2fb5cf(0x2a7)],'updatedAt':_0x12e2ec[_0x2fb5cf(0x1e0)],'useCount':_0x12e2ec[_0x2fb5cf(0x2b1)],'tutorial':_0x12e2ec[_0x2fb5cf(0x31c)],'freeUsed':Number(_0x2375f1),'favorite':_0x5d795c['has'](_0x12e2ec['id'])};return _0x29099f;}catch(_0x47d491){throw new common_1[(_0x2fb5cf(0x294))](_0x47d491['message'],common_1[_0x2fb5cf(0x16b)][_0x2fb5cf(0x32d)]);}}async[_0x4c31a7(0x2d3)](_0x2b5c4c){const _0x5b8d06=_0x4c31a7;try{const _0x1e4fb4={'id':_0x2b5c4c['id'],'keyType':0x5,'modelType':model_constant_1[_0x5b8d06(0x29f)][_0x5b8d06(0x278)],'cover':_0x2b5c4c[_0x5b8d06(0x29a)],'modelName':_0x2b5c4c['name'],'model':_0x2b5c4c[_0x5b8d06(0x2c2)],'key':'','config':_0x2b5c4c[_0x5b8d06(0x18f)],'deduct':_0x2b5c4c[_0x5b8d06(0x196)],'vipFreeNum':_0x2b5c4c[_0x5b8d06(0x34f)],'displaySort':_0x2b5c4c[_0x5b8d06(0x355)],'description':_0x2b5c4c[_0x5b8d06(0x257)],'status':_0x2b5c4c['status'],'remark':_0x2b5c4c[_0x5b8d06(0x334)],'recommend':_0x2b5c4c[_0x5b8d06(0x266)]};return _0x2b5c4c[_0x5b8d06(0x25a)]&&(_0x1e4fb4[_0x5b8d06(0x1d5)]=String(_0x2b5c4c[_0x5b8d06(0x25a)])),await this['modelsService'][_0x5b8d06(0x22e)](_0x1e4fb4),!![];}catch(_0x2f2eed){throw new common_1[(_0x5b8d06(0x294))](_0x2f2eed[_0x5b8d06(0x182)],common_1[_0x5b8d06(0x16b)][_0x5b8d06(0x32d)]);}}async[_0x4c31a7(0x36b)](_0x4c702b){const _0x4e70e9=_0x4c31a7;return this[_0x4e70e9(0x1fc)]['modelDel'](_0x4c702b[_0x4e70e9(0x271)]);}async[_0x4c31a7(0x326)](){const _0x536d4a=_0x4c31a7,_0x10605b=await this[_0x536d4a(0x1e1)][_0x536d4a(0x283)](_0x536d4a(0x222)),_0x1ca804=await this[_0x536d4a(0x1e1)][_0x536d4a(0x283)](_0x536d4a(0x329)),_0x3dfda3=await this['dictService'][_0x536d4a(0x283)]('effect_main_body'),_0x5b724f=await this[_0x536d4a(0x1e1)][_0x536d4a(0x283)](_0x536d4a(0x1f4));return{'style':_0x10605b,'effect_category':_0x1ca804,'effect_main_body':_0x3dfda3,'application_fields':_0x5b724f};}async[_0x4c31a7(0x279)](_0x59103d){const _0x5a28f7=_0x4c31a7;try{const {page:page=0x1,size:size=0x14,keyword:_0x5ca82d,type:_0xd758a5,version:_0x38cf03,style:_0x29a25e,effectCategory:_0x32cfe4,effectMainBody:_0x23f78d,applicationFields:_0x1df706,disabled:_0x96e32a}=_0x59103d,_0x229061={};_0x5ca82d&&(_0x229061['name']=(0x0,typeorm_2[_0x5a28f7(0x275)])('%'+_0x5ca82d+'%'));_0xd758a5&&(_0x229061[_0x5a28f7(0x20f)]=_0xd758a5);_0x38cf03&&(_0x229061['version']=_0x38cf03);_0x29a25e&&(_0x229061[_0x5a28f7(0x222)]=_0x29a25e);_0x32cfe4&&(_0x229061[_0x5a28f7(0x1a5)]=_0x32cfe4);_0x23f78d&&(_0x229061[_0x5a28f7(0x356)]=_0x23f78d);_0x1df706&&(_0x229061[_0x5a28f7(0x2ae)]=_0x1df706);(0x0,utils_1[_0x5a28f7(0x32a)])(this[_0x5a28f7(0x27a)])?(0x0,utils_1['isDefined'])(_0x96e32a)&&(_0x229061['disabled']=_0x96e32a):_0x229061[_0x5a28f7(0x261)]=0x0;const [_0x4b4ffb,_0x56fc0b]=await this[_0x5a28f7(0x188)][_0x5a28f7(0x318)]({'where':_0x229061,'take':size,'skip':(page-0x1)*size,'order':{'id':_0x5a28f7(0x309)}});return{'rows':_0x4b4ffb,'count':_0x56fc0b};}catch(_0xf3d160){throw new common_1[(_0x5a28f7(0x294))](_0xf3d160['message'],common_1[_0x5a28f7(0x16b)][_0x5a28f7(0x32d)]);}}async[_0x4c31a7(0x282)](_0x53ea64){const _0x2dad50=_0x4c31a7;try{const {id:_0x3fd0bf,name:_0x5df99d,cover:_0x3d6fdc,description:_0x4b9571,disabled:_0x267952}=_0x53ea64,_0x5996a7={};return _0x5df99d&&(_0x5996a7[_0x2dad50(0x238)]=_0x5df99d),_0x3d6fdc&&(_0x5996a7[_0x2dad50(0x29a)]=_0x3d6fdc),_0x4b9571&&(_0x5996a7[_0x2dad50(0x257)]=_0x4b9571),_0x267952&&(_0x5996a7['disabled']=_0x267952),await this[_0x2dad50(0x188)][_0x2dad50(0x2a1)]({'id':_0x3fd0bf},_0x5996a7),!![];}catch(_0x3a8e33){throw new common_1[(_0x2dad50(0x294))](_0x3a8e33[_0x2dad50(0x182)],common_1[_0x2dad50(0x16b)][_0x2dad50(0x32d)]);}}async[_0x4c31a7(0x268)](_0x31a439){const _0x13b70e=_0x4c31a7,_0x23fe91=_0x31a439[_0x13b70e(0x317)](',');if(!_0x31a439['length'])throw new common_1['HttpException'](_0x13b70e(0x29e),common_1[_0x13b70e(0x16b)][_0x13b70e(0x32d)]);return this['mjModelEntity'][_0x13b70e(0x1e9)]({'where':{'id':(0x0,typeorm_2['In'])(_0x23fe91),'disabled':0x0}});}async['workflowTaskSubmit'](_0x5415f1,_0x4af419){const _0x33552e=_0x4c31a7;try{const _0xef745e=await this[_0x33552e(0x1fc)][_0x33552e(0x2d6)](_0x4af419[_0x33552e(0x2c2)]);if(!_0xef745e['status'])throw new Error(_0x33552e(0x2aa));let _0xc63bd1;const _0x516396=(0x0,utils_1[_0x33552e(0x1eb)])(this[_0x33552e(0x27a)]);return await this[_0x33552e(0x362)][_0x33552e(0x256)](async()=>{const _0x454b5f=_0x33552e;_0xc63bd1=await this[_0x454b5f(0x2b0)]({'originPrompt':'','saasId':_0x516396,'userId':_0x5415f1[_0x454b5f(0x340)]['id'],'mode':midjourney_constant_1[_0x454b5f(0x205)]['fast'],'botType':DrawTaskPage_dto_1['EBotType'][_0x454b5f(0x278)],'workflowId':_0x4af419[_0x454b5f(0x2c2)],'fullPrompt':JSON[_0x454b5f(0x19d)](_0x4af419[_0x454b5f(0x339)])}),await this[_0x454b5f(0x2d8)]['deductBalance4WorkFlow'](_0x5415f1[_0x454b5f(0x340)]['id'],_0xef745e,_0xc63bd1['id']);const _0x313611=await this[_0x454b5f(0x1a6)]['workflowRun']({'data':{'workflowId':Number(_0xef745e[_0x454b5f(0x277)]),'versionId':Number(_0xef745e[_0x454b5f(0x1d5)]),'presetId':_0x4af419['presetId'],'inputs':_0x4af419[_0x454b5f(0x339)]}});_0xc63bd1[_0x454b5f(0x176)]=_0x313611['taskId'],await this['midjourneyEntity'][_0x454b5f(0x2a1)]({'id':_0xc63bd1['id']},{'mjpTaskId':_0x313611[_0x454b5f(0x35f)]});}),_0xc63bd1;}catch(_0x5e420a){throw new common_1[(_0x33552e(0x294))](_0x5e420a[_0x33552e(0x182)],common_1['HttpStatus'][_0x33552e(0x32d)]);}}async[_0x4c31a7(0x20d)](_0x366313,_0x55c209){const _0x8ee680=_0x4c31a7,{page:page=0x1,size:size=0x14}=_0x55c209,[_0x4b73a0]=await this['connection']['query'](_0x8ee680(0x27b)+_0x366313['user']['id']+'\x20GROUP\x20BY\x20workflowId\x20)\x20t\x20ON\x20t.workflowId\x20=\x20m.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.workflowId\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20'),_0x1c9753=await this[_0x8ee680(0x362)][_0x8ee680(0x319)](_0x8ee680(0x192)+_0x366313['user']['id']+_0x8ee680(0x24d)+size+_0x8ee680(0x17d)+(page-0x1)*size+_0x8ee680(0x17e));return{'rows':_0x1c9753,'count':Number(_0x4b73a0?.[_0x8ee680(0x255)]||0x0)};}async[_0x4c31a7(0x308)](_0x14eeec,_0x134bdb){const _0x10de49=_0x4c31a7,_0xc71025=_0x14eeec[_0x10de49(0x340)]['id'],{page:page=0x1,size:size=0x14}=_0x134bdb,[_0x2c4400]=await this[_0x10de49(0x362)][_0x10de49(0x319)](_0x10de49(0x36c)+_0x14eeec[_0x10de49(0x340)]['id']+_0x10de49(0x324)+user_constant_1[_0x10de49(0x315)][_0x10de49(0x278)]+_0x10de49(0x2a2)),_0x174736=await this[_0x10de49(0x362)]['query'](_0x10de49(0x32f)+_0x14eeec['user']['id']+_0x10de49(0x324)+user_constant_1[_0x10de49(0x315)]['WORKFLOW']+'\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.createdAt\x20DESC\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20');if(_0x14eeec[_0x10de49(0x340)]['id']){const _0x294063=await this[_0x10de49(0x2d8)][_0x10de49(0x35c)](_0xc71025);if(_0x294063[_0x10de49(0x248)]||_0x294063[_0x10de49(0x224)])for(let _0x293a4f=0x0;_0x293a4f<_0x174736['length'];_0x293a4f++){const _0x2d980e=_0x174736[_0x293a4f],_0x5a7d8c=redisKey_constant_1[_0x10de49(0x1ed)]+'-'+_0xc71025+'-'+_0x2d980e['id'],_0x49fda8=await await this[_0x10de49(0x17a)]['get']({'key':_0x5a7d8c});_0x2d980e['freeUsed']=Number(_0x49fda8||0x0);}}return{'rows':_0x174736,'count':_0x2c4400?.[_0x10de49(0x255)]||0x0};}async[_0x4c31a7(0x307)](_0x420db4,_0x5d2c49){const _0x323fb2=_0x4c31a7;try{let _0x71785d;const _0x5088c6=(0x0,utils_1[_0x323fb2(0x1eb)])(this['clsService']);return await this[_0x323fb2(0x362)][_0x323fb2(0x256)](async()=>{const _0x2af63a=_0x323fb2;_0x71785d=await this[_0x2af63a(0x2b0)]({'saasId':_0x5088c6,'userId':_0x420db4['user']['id'],'mode':midjourney_constant_1[_0x2af63a(0x205)][_0x2af63a(0x24b)],'botType':DrawTaskPage_dto_1['EBotType']['SD'],'originPrompt':_0x5d2c49[_0x2af63a(0x26d)],'fullPrompt':JSON[_0x2af63a(0x19d)](_0x5d2c49)}),await this[_0x2af63a(0x2d8)][_0x2af63a(0x352)](_0x420db4[_0x2af63a(0x340)]['id'],_0x71785d['id']);const _0x4b809b=await this[_0x2af63a(0x1a6)][_0x2af63a(0x1be)]({'data':_0x5d2c49});_0x71785d[_0x2af63a(0x176)]=_0x4b809b['paintingSign'],await this['midjourneyEntity'][_0x2af63a(0x2a1)]({'id':_0x71785d['id']},{'mjpTaskId':_0x4b809b[_0x2af63a(0x22a)]});}),_0x71785d;}catch(_0x538ee5){throw new common_1[(_0x323fb2(0x294))](_0x538ee5[_0x323fb2(0x182)],common_1['HttpStatus'][_0x323fb2(0x32d)]);}}async[_0x4c31a7(0x19c)](_0x4258e3,_0x1d14fe){const _0xc0d9cd=_0x4c31a7;try{const _0xdb9076=await this['midjourneyEntity'][_0xc0d9cd(0x30b)]({'where':{'id':Number(_0x1d14fe[_0xc0d9cd(0x35f)])}});if(!_0xdb9076)throw new Error('原始任务不存在！');let _0x59f4bc;const _0x20d4ef=(0x0,utils_1['getReqSaasId'])(this[_0xc0d9cd(0x27a)]);return await this[_0xc0d9cd(0x362)][_0xc0d9cd(0x256)](async()=>{const _0x3dd316=_0xc0d9cd;_0x59f4bc=await this[_0x3dd316(0x2b0)]({'saasId':_0x20d4ef,'userId':_0x4258e3['user']['id'],'mode':midjourney_constant_1[_0x3dd316(0x205)]['fast'],'botType':DrawTaskPage_dto_1[_0x3dd316(0x1a2)]['SD'],'originPrompt':_0x1d14fe[_0x3dd316(0x26d)],'originTaskId':_0x1d14fe[_0x3dd316(0x35f)],'fullPrompt':JSON[_0x3dd316(0x19d)](_0x1d14fe)}),await this['userService'][_0x3dd316(0x352)](_0x4258e3[_0x3dd316(0x340)]['id'],_0x59f4bc['id']);const _0x45f199=await this[_0x3dd316(0x1a6)][_0x3dd316(0x2c5)]({'data':{'mask':_0x1d14fe[_0x3dd316(0x23b)],'prompt':_0x1d14fe[_0x3dd316(0x26d)],'taskId':_0xdb9076[_0x3dd316(0x176)],'denoisingStrength':_0x1d14fe['denoisingStrength']}});_0x59f4bc[_0x3dd316(0x176)]=_0x45f199['paintingSign'],await this[_0x3dd316(0x2f8)][_0x3dd316(0x2a1)]({'id':_0x59f4bc['id']},{'mjpTaskId':_0x45f199[_0x3dd316(0x22a)]});}),_0x59f4bc;}catch(_0x5eaaed){throw new common_1[(_0xc0d9cd(0x294))](_0x5eaaed[_0xc0d9cd(0x182)],common_1[_0xc0d9cd(0x16b)][_0xc0d9cd(0x32d)]);}}async[_0x4c31a7(0x327)](_0x3022a5,_0xb0913c){const _0x1f4c23=_0x4c31a7,{id:_0x5dd8cf,favorite:_0x490695}=_0x3022a5;if(_0x490695==0x1)return await this['userService'][_0x1f4c23(0x1d1)](_0xb0913c[_0x1f4c23(0x340)]['id'],_0x5dd8cf,collectType_constant_1[_0x1f4c23(0x1db)]['MJ']),!![];return await this[_0x1f4c23(0x2d8)]['uncollect'](_0xb0913c[_0x1f4c23(0x340)]['id'],_0x5dd8cf,collectType_constant_1['UserCollectType']['MJ']),!![];}async[_0x4c31a7(0x30f)](_0x21537a,_0x235cce){const _0x21c0db=_0x4c31a7,{page:page=0x1,size:size=0x14}=_0x21537a,{rows:_0x12cc84,count:_0xbcec35}=await this[_0x21c0db(0x2d8)][_0x21c0db(0x29d)](page,size,_0x235cce[_0x21c0db(0x340)]['id'],collectType_constant_1['UserCollectType']['MJ']),_0x1c1af8=await this[_0x21c0db(0x2f8)]['find']({'where':{'userId':_0x235cce[_0x21c0db(0x340)]['id'],'id':(0x0,typeorm_2['In'])(_0x12cc84[_0x21c0db(0x19a)](_0x2c64b8=>_0x2c64b8['relId']))}});let _0x3dd635=await this[_0x21c0db(0x2d8)][_0x21c0db(0x346)](_0x1c1af8,_0x235cce,collectType_constant_1['UserCollectType']['MJ']);return _0x3dd635=await this['userService']['mergeCollectCountData'](_0x1c1af8,collectType_constant_1[_0x21c0db(0x1db)]['MJ']),{'rows':_0x3dd635,'count':_0xbcec35};}async[_0x4c31a7(0x25f)](_0x17adb3,_0x2a1b20){const _0x326a07=_0x4c31a7;try{const _0x5c2d3b=await this['midjourneyEntity'][_0x326a07(0x30b)]({'where':{'id':_0x17adb3,'userId':_0x2a1b20[_0x326a07(0x340)]['id']}});if(!_0x5c2d3b)throw new Error(_0x326a07(0x18e));if(_0x5c2d3b[_0x326a07(0x1af)]===midjourney_constant_1[_0x326a07(0x1a4)]['DRAWING'])throw new Error('绘制中的图片任务、禁止删除！');await this[_0x326a07(0x1c6)][_0x326a07(0x1a7)](null,_0x5c2d3b['mjpTaskId']);const _0x1c263d=await this[_0x326a07(0x2f8)]['delete']({'id':_0x17adb3});if(_0x1c263d['affected']>0x0)return _0x326a07(0x293);else throw new Error('删除失败！');}catch(_0x2a1bfd){throw new common_1[(_0x326a07(0x294))](_0x2a1bfd[_0x326a07(0x182)],common_1['HttpStatus'][_0x326a07(0x32d)]);}}async[_0x4c31a7(0x32c)](_0x5c8cb1,_0x14f5c7){const _0x475944=_0x4c31a7,{id:_0x9621de}=_0x14f5c7;if(!_0x9621de)throw new common_1[(_0x475944(0x294))](_0x475944(0x322),common_1[_0x475944(0x16b)][_0x475944(0x32d)]);const _0x2ea067=await this[_0x475944(0x2f8)][_0x475944(0x16d)]({'id':_0x9621de});if(_0x2ea067[_0x475944(0x229)]<=0x0)throw new common_1[(_0x475944(0x294))](_0x475944(0x2bd),common_1[_0x475944(0x16b)][_0x475944(0x32d)]);return!![];}async[_0x4c31a7(0x2e9)](_0x1dc726,_0x1058fb){const _0x59ddaf=_0x4c31a7;try{const {prompt:_0x78dc44,status:_0x113285,isCarryParams:_0x2abaab,imageUrl:_0x28eeac,title:_0x470f6a,order:_0x86eb97,id:_0x14e2b8,aspect:_0x5c7f30,type:_0x357977}=_0x1058fb;if(_0x14e2b8)return await this[_0x59ddaf(0x1cc)][_0x59ddaf(0x2a1)]({'id':_0x14e2b8},{'title':_0x470f6a,'prompt':_0x78dc44,'imageUrl':_0x28eeac,'status':_0x113285,'isCarryParams':_0x2abaab,'order':_0x86eb97,'aspect':_0x5c7f30,'type':_0x357977})['then'](_0x4b4383=>!!_0x4b4383);else{const _0x4b9a45=(0x0,utils_1[_0x59ddaf(0x1eb)])(this['clsService']);return await this[_0x59ddaf(0x1cc)][_0x59ddaf(0x29b)]({'prompt':_0x78dc44,'status':_0x113285,'imageUrl':_0x28eeac,'isCarryParams':_0x2abaab,'title':_0x470f6a,'order':_0x86eb97,'aspect':_0x5c7f30,'type':_0x357977,'saasId':_0x4b9a45})[_0x59ddaf(0x2e4)](_0x1ccce8=>!!_0x1ccce8);}}catch(_0x1fe298){console['log'](_0x59ddaf(0x26f),_0x1fe298);}}async[_0x4c31a7(0x180)](_0x2225c8,_0x59afba){const _0x3ca3d9=_0x4c31a7,{id:_0x268088}=_0x59afba;if(!_0x268088)throw new common_1[(_0x3ca3d9(0x294))](_0x3ca3d9(0x322),common_1[_0x3ca3d9(0x16b)]['BAD_REQUEST']);return await this[_0x3ca3d9(0x1cc)][_0x3ca3d9(0x16d)]({'id':_0x268088});}async[_0x4c31a7(0x214)](_0xb6005c=0x0){const _0x181add=_0x4c31a7,_0xf27eec=(0x0,utils_1[_0x181add(0x1eb)])(this[_0x181add(0x27a)]);return await this[_0x181add(0x1cc)][_0x181add(0x1e9)]({'where':{'saasId':_0xf27eec,'type':_0xb6005c||0x0},'order':{'order':'DESC'}})[_0x181add(0x2e4)](_0x4077f7=>_0x4077f7||[])['catch'](_0x50a464=>{const _0x414134=_0x181add;common_1[_0x414134(0x29c)]['error'](_0x50a464);});}async[_0x4c31a7(0x1d8)](_0x458d1b){const _0x29c1dc=_0x4c31a7;try{const {page:_0x41055c,size:_0xe36266,keyword:_0x117348,saasId:_0x56d587,type:_0x5bb0e0}=_0x458d1b,_0x1898ce=(0x0,utils_1[_0x29c1dc(0x1eb)])(this[_0x29c1dc(0x27a)]),_0xb2ddb1={'status':!![],'type':_0x5bb0e0||0x0};(0x0,utils_1['isPlatform'])(this[_0x29c1dc(0x27a)])?(0x0,utils_1[_0x29c1dc(0x1bc)])(_0x56d587)&&(_0xb2ddb1[_0x29c1dc(0x172)]=_0x56d587):_0xb2ddb1[_0x29c1dc(0x172)]=_0x1898ce;const [_0x1d885a,_0x136adf]=await this[_0x29c1dc(0x1cc)][_0x29c1dc(0x318)]({'where':[{..._0xb2ddb1,'title':(0x0,typeorm_2[_0x29c1dc(0x275)])('%'+_0x117348+'%')},{..._0xb2ddb1,'prompt':(0x0,typeorm_2['Like'])('%'+_0x117348+'%')}],'take':_0xe36266,'skip':(_0x41055c-0x1)*_0xe36266,'order':{'order':_0x29c1dc(0x212)}});return{'rows':_0x1d885a,'count':_0x136adf};}catch(_0x6329cb){throw new common_1[(_0x29c1dc(0x294))](_0x6329cb[_0x29c1dc(0x182)],common_1[_0x29c1dc(0x16b)][_0x29c1dc(0x32d)]);}}async[_0x4c31a7(0x338)](_0xc21135){const _0x4ff38b=_0x4c31a7;try{const {name:_0xf4ab6d,value:_0x237e4e,dataType:_0x4d5b5a}=_0xc21135,_0x4721ec=(0x0,utils_1[_0x4ff38b(0x1eb)])(this[_0x4ff38b(0x27a)]),_0x3fc22b=await this[_0x4ff38b(0x2a0)][_0x4ff38b(0x174)]({'name':_0xf4ab6d,'saasId':_0x4721ec});if(_0x3fc22b)throw new common_1[(_0x4ff38b(0x294))](_0x4ff38b(0x1c3),common_1[_0x4ff38b(0x16b)][_0x4ff38b(0x32d)]);return await this[_0x4ff38b(0x2a0)][_0x4ff38b(0x29b)]({'name':_0xf4ab6d,'value':_0x237e4e,'dataType':_0x4d5b5a,'saasId':_0x4721ec})['then'](_0x275d03=>!!_0x275d03)['catch'](_0x5f4bf6=>{const _0x32e463=_0x4ff38b;console[_0x32e463(0x21e)](_0x5f4bf6);throw new common_1['HttpException'](_0x5f4bf6,common_1['HttpStatus'][_0x32e463(0x32d)]);});}catch(_0x44205e){return![];}}async[_0x4c31a7(0x241)](_0x41b26f){const _0x890b39=_0x4c31a7,{id:_0x4a6a26,name:_0x4ca953,value:_0x4eac7c}=_0x41b26f;return await this[_0x890b39(0x2a0)][_0x890b39(0x2a1)](_0x4a6a26,{'name':_0x4ca953,'value':_0x4eac7c})[_0x890b39(0x2e4)](_0x57d1cc=>!!_0x57d1cc);}async[_0x4c31a7(0x195)](_0x27caea){const _0x5213b7=_0x4c31a7,{id:_0xa01e51}=_0x27caea;return await this[_0x5213b7(0x2a0)]['delete']({'id':_0xa01e51})[_0x5213b7(0x2b3)](_0x4ed650=>{const _0x1ed33b=_0x5213b7;throw new common_1[(_0x1ed33b(0x294))](_0x4ed650,common_1[_0x1ed33b(0x16b)][_0x1ed33b(0x32d)]);});}async[_0x4c31a7(0x280)](_0x11b717){const _0x316d7b=_0x4c31a7,{size:_0x1775d3,page:_0xea623,saasId:_0x2d2928}=_0x11b717,_0x5cc2c=(0x0,utils_1[_0x316d7b(0x1eb)])(this['clsService']),_0x5af0fe={};_0x11b717['dataType']==0x1?_0x5af0fe['dataType']=0x1:_0x5af0fe[_0x316d7b(0x1ff)]=0x0;(0x0,utils_1['isPlatform'])(this[_0x316d7b(0x27a)])?(0x0,utils_1[_0x316d7b(0x1bc)])(_0x2d2928)&&(_0x5af0fe[_0x316d7b(0x172)]=_0x2d2928):_0x5af0fe[_0x316d7b(0x172)]=_0x5cc2c;const _0x10b0c1=await this['mjInspireClassifyEntity'][_0x316d7b(0x318)]({'where':_0x5af0fe,'order':{'createdAt':'DESC'},'take':_0x1775d3,'skip':(_0xea623-0x1)*_0x1775d3})['catch'](_0x673ec0=>{const _0x27a4d0=_0x316d7b;throw new common_1[(_0x27a4d0(0x294))](_0x673ec0,common_1[_0x27a4d0(0x16b)]['BAD_REQUEST']);});if(!_0x10b0c1)throw new common_1[(_0x316d7b(0x294))](_0x316d7b(0x2ec),common_1['HttpStatus'][_0x316d7b(0x32d)]);const [_0x7b3770,_0x440a7c]=_0x10b0c1;return{'rows':_0x7b3770,'count':_0x440a7c};}async['getMjInspireClassify'](_0x15b552){const _0x1b5878=_0x4c31a7,{id:_0x35a2dd}=_0x15b552;return await this[_0x1b5878(0x2a0)][_0x1b5878(0x30b)]({'where':{'id':_0x35a2dd}});}async[_0x4c31a7(0x23d)](_0x462f3c){const _0x51ffe6=_0x4c31a7;try{const _0x1f1a81=(0x0,utils_1[_0x51ffe6(0x1eb)])(this[_0x51ffe6(0x27a)]),{classifyName:_0x3fca20,level:_0x265f2f,type:_0x29ff73,pid:pid=0x0,dataType:_0x3e150a}=_0x462f3c;return await this[_0x51ffe6(0x1aa)][_0x51ffe6(0x29b)]({'classifyName':_0x3fca20,'level':_0x265f2f,'type':_0x29ff73,'pid':pid,'dataType':_0x3e150a,'saasId':_0x1f1a81})[_0x51ffe6(0x2e4)](_0x47c5a3=>!!_0x47c5a3)[_0x51ffe6(0x2b3)](_0x424957=>{const _0x159ae5=_0x51ffe6;console[_0x159ae5(0x21e)](_0x424957);throw new common_1['HttpException'](_0x424957,common_1[_0x159ae5(0x16b)]['BAD_REQUEST']);});}catch(_0x36c432){return![];}}async[_0x4c31a7(0x1bd)](_0x537f5f){const _0x5e9008=_0x4c31a7,{id:_0x3b8d4e,classifyName:_0xe4df0,level:_0x44e060,type:_0xa84d2,pid:_0x567ae8}=_0x537f5f;return this[_0x5e9008(0x362)][_0x5e9008(0x256)](async()=>{const _0x2beb80=_0x5e9008,_0x1daa7c=await this[_0x2beb80(0x1aa)][_0x2beb80(0x30b)]({'where':{'id':_0x3b8d4e}});_0x1daa7c[_0x2beb80(0x20f)]!==_0xa84d2&&await this[_0x2beb80(0x1aa)][_0x2beb80(0x2a1)]({'pid':_0x3b8d4e},{'type':_0xa84d2}),await this['mjIncantationClassifyEntity'][_0x2beb80(0x2a1)](_0x3b8d4e,{'classifyName':_0xe4df0,'level':_0x44e060,'type':_0xa84d2,'pid':_0x567ae8});}),!![];}async[_0x4c31a7(0x245)](_0xd60ec0){const _0x2c7117=_0x4c31a7,{id:_0x5e0486}=_0xd60ec0;return await this[_0x2c7117(0x1aa)][_0x2c7117(0x16d)]({'id':_0x5e0486})[_0x2c7117(0x2e4)](_0x2b9b1a=>_0x2b9b1a[_0x2c7117(0x229)]>0x0);}async[_0x4c31a7(0x26a)](_0x34452e){const _0xd1ee8f=_0x4c31a7,{id:_0x3d683f}=_0x34452e;return await this[_0xd1ee8f(0x1aa)][_0xd1ee8f(0x30b)]({'where':{'id':_0x3d683f}});}async['queryTopMjIncantationClassify'](_0x3db568=0x0){const _0x2d05b7=_0x4c31a7,_0x4f801e=(0x0,utils_1[_0x2d05b7(0x1eb)])(this[_0x2d05b7(0x27a)]);return this[_0x2d05b7(0x1aa)][_0x2d05b7(0x1e9)]({'where':{'level':0x1,'saasId':_0x4f801e,'dataType':_0x3db568==0x1?0x1:0x0}});}async[_0x4c31a7(0x2cb)](_0xb1bc1c){const _0x171e6c=_0x4c31a7,{size:_0x4b0f5d,page:_0x3d6e46,type:_0x40fe36,keyword:_0x31333e,level:_0x46d864,saasId:_0x40ced1}=_0xb1bc1c,_0x3283d3=(0x0,utils_1[_0x171e6c(0x1eb)])(this[_0x171e6c(0x27a)]);let _0x3119ae={};_0xb1bc1c[_0x171e6c(0x1ff)]==0x1?_0x3119ae[_0x171e6c(0x1ff)]=0x1:_0x3119ae[_0x171e6c(0x1ff)]=0x0;_0x46d864>0x0&&(_0x3119ae['level']=_0x46d864);_0x40fe36&&(_0x3119ae[_0x171e6c(0x20f)]=_0x40fe36);_0x31333e&&(_0x3119ae[_0x171e6c(0x211)]=(0x0,typeorm_2[_0x171e6c(0x275)])('%'+_0x31333e+'%'));(0x0,utils_1[_0x171e6c(0x1b2)])(this[_0x171e6c(0x27a)])?(0x0,utils_1[_0x171e6c(0x1bc)])(_0x40ced1)&&(_0x3119ae[_0x171e6c(0x172)]=_0x40ced1):_0x3119ae[_0x171e6c(0x172)]=_0x3283d3;const _0x5aae14=await this[_0x171e6c(0x1aa)][_0x171e6c(0x318)]({'order':{'createdAt':_0x171e6c(0x212)},'where':_0x3119ae,'take':_0x4b0f5d,'skip':(_0x3d6e46-0x1)*_0x4b0f5d})[_0x171e6c(0x2b3)](_0x4020e6=>{console['log'](_0x4020e6);});if(!_0x5aae14)throw new common_1['HttpException'](_0x171e6c(0x21b),common_1[_0x171e6c(0x16b)][_0x171e6c(0x32d)]);const [_0x5ac00b,_0x46e569]=_0x5aae14;return{'rows':_0x5ac00b,'count':_0x46e569};}async[_0x4c31a7(0x21d)](_0x2fbdde){const _0x1b95c0=_0x4c31a7,{level:_0x2f5c6a,type:_0x92b493,saasId:_0x2ebf7e}=_0x2fbdde,_0x419047=(0x0,utils_1[_0x1b95c0(0x1eb)])(this[_0x1b95c0(0x27a)]),_0x426b55={};_0x2f5c6a===0x0?_0x426b55['level']=(0x0,typeorm_2[_0x1b95c0(0x2b8)])(_0x2f5c6a):_0x426b55[_0x1b95c0(0x34c)]=_0x2f5c6a;_0x92b493&&(_0x426b55['type']=_0x92b493);_0x2fbdde[_0x1b95c0(0x1ff)]==0x1?_0x426b55[_0x1b95c0(0x1ff)]=0x1:_0x426b55[_0x1b95c0(0x1ff)]=0x0;(0x0,utils_1[_0x1b95c0(0x1b2)])(this[_0x1b95c0(0x27a)])?(0x0,utils_1[_0x1b95c0(0x1bc)])(_0x2ebf7e)&&(_0x426b55[_0x1b95c0(0x172)]=_0x2ebf7e):_0x426b55[_0x1b95c0(0x172)]=_0x419047;const _0x181e41=await this[_0x1b95c0(0x1aa)][_0x1b95c0(0x1bb)](_0x426b55)[_0x1b95c0(0x2b3)](_0x46e32e=>{const _0x544ee0=_0x1b95c0;console[_0x544ee0(0x21e)](_0x46e32e);});if(!_0x181e41)throw new common_1[(_0x1b95c0(0x294))]('查询咒语分类失败',common_1[_0x1b95c0(0x16b)][_0x1b95c0(0x32d)]);if(_0x2f5c6a===0x0)return{'level1':_0x181e41['filter'](_0x1e0e6d=>_0x1e0e6d[_0x1b95c0(0x34c)]===0x1),'level2':_0x181e41['filter'](_0x47f804=>_0x47f804[_0x1b95c0(0x34c)]===0x2)};return _0x181e41;}async[_0x4c31a7(0x259)](_0x14432e){const _0xc1dd5a=_0x4c31a7;try{const _0x1fdea7=(0x0,utils_1[_0xc1dd5a(0x1eb)])(this[_0xc1dd5a(0x27a)]),{incantationEn:_0x32b19,incantationCn:_0x569f35,img:_0x3a7c58,pid:_0x52a6e6,dataType:_0x38475c}=_0x14432e;return await this[_0xc1dd5a(0x316)]['save']({'incantationEn':_0x32b19,'incantationCn':_0x569f35,'img':_0x3a7c58,'pid':_0x52a6e6,'dataType':_0x38475c,'saasId':_0x1fdea7})[_0xc1dd5a(0x2e4)](_0x1a2557=>!!_0x1a2557)[_0xc1dd5a(0x2b3)](_0x41d422=>{throw _0x41d422;});}catch(_0x5bb98c){return console[_0xc1dd5a(0x21e)](_0x5bb98c),![];}}async[_0x4c31a7(0x173)](_0x41434d){const _0x35d12c=_0x4c31a7,{id:_0x5895e5,incantationEn:_0x14ca29,incantationCn:_0x5af697,img:_0x3c1beb,pid:_0x5c5280}=_0x41434d;return await this[_0x35d12c(0x316)][_0x35d12c(0x2a1)](_0x5895e5,{'incantationCn':_0x5af697,'incantationEn':_0x14ca29,'img':_0x3c1beb,'pid':_0x5c5280});}async[_0x4c31a7(0x1a8)](_0x448554){const _0x45da56=_0x4c31a7,{id:_0x92e1bb}=_0x448554;return await this[_0x45da56(0x316)][_0x45da56(0x16d)]({'id':_0x92e1bb})[_0x45da56(0x2e4)](_0x190398=>_0x190398[_0x45da56(0x229)]>0x0);}async[_0x4c31a7(0x2d7)](_0x7e8dd7){const _0x3542a9=_0x4c31a7,{id:_0x55dbe8}=_0x7e8dd7;return await this[_0x3542a9(0x316)][_0x3542a9(0x30b)]({'where':{'id':_0x55dbe8}});}async[_0x4c31a7(0x2b6)](_0xbe2fb9){const _0xf894b6=_0x4c31a7,_0xc9ed62=(0x0,utils_1[_0xf894b6(0x1eb)])(this['clsService']),{size:_0x49dfd6,page:_0x60226d,keyword:_0x4111ac,pid:_0x53bd00,saasId:_0x2588a1}=_0xbe2fb9;let _0x544d46={};_0xbe2fb9['dataType']==0x1?_0x544d46[_0xf894b6(0x1ff)]=0x1:_0x544d46[_0xf894b6(0x1ff)]=0x0;_0x53bd00>0x0&&(_0x544d46[_0xf894b6(0x186)]=_0x53bd00);_0x4111ac&&(_0x544d46[_0xf894b6(0x2b9)]=(0x0,typeorm_2['Like'])('%'+_0x4111ac+'%'));(0x0,utils_1[_0xf894b6(0x1b2)])(this['clsService'])?(0x0,utils_1[_0xf894b6(0x1bc)])(_0x2588a1)&&(_0x544d46[_0xf894b6(0x172)]=_0x2588a1):_0x544d46['saasId']=_0xc9ed62;const _0x5d60e9=await this['mjIncantationEntity'][_0xf894b6(0x318)]({'order':{'createdAt':_0xf894b6(0x212)},'where':_0x544d46,'take':_0x49dfd6,'skip':(_0x60226d-0x1)*_0x49dfd6})[_0xf894b6(0x2b3)](_0x160dfa=>{const _0xfba0e4=_0xf894b6;console[_0xfba0e4(0x21e)](_0x160dfa);});if(!_0x5d60e9)throw new common_1['HttpException'](_0xf894b6(0x2c0),common_1[_0xf894b6(0x16b)][_0xf894b6(0x32d)]);const [_0x140706,_0x358665]=_0x5d60e9;return{'rows':_0x140706,'count':_0x358665};}async[_0x4c31a7(0x2b7)](_0x555568){const _0x5be4b6=_0x4c31a7,{id:_0x35ef46}=_0x555568,_0x3a7112=await this['mjIncantationClassifyEntity'][_0x5be4b6(0x30b)]({'where':{'level':0x1,'id':_0x35ef46}})[_0x5be4b6(0x2b3)](_0x4e2a82=>{const _0x1c4f52=_0x5be4b6;common_1[_0x1c4f52(0x29c)][_0x1c4f52(0x179)](_0x4e2a82);});if(!_0x3a7112)throw new common_1['HttpException']('未查询到咒语一级分类',common_1[_0x5be4b6(0x16b)]['BAD_REQUEST']);const _0x27f10a=await this[_0x5be4b6(0x1aa)][_0x5be4b6(0x1e9)]({'where':{'level':0x2,'pid':_0x3a7112['id']}})[_0x5be4b6(0x2b3)](_0x4728e0=>{const _0x1bc230=_0x5be4b6;common_1[_0x1bc230(0x29c)][_0x1bc230(0x179)](_0x4728e0);});if(!_0x27f10a||_0x27f10a[_0x5be4b6(0x252)]===0x0)return{'rows':[]};const _0x850391=_0x27f10a[_0x5be4b6(0x19a)](_0x521d31=>_0x521d31['id']),_0x1f01ad=await this['mjIncantationEntity'][_0x5be4b6(0x1e9)]({'where':{'pid':(0x0,typeorm_2['In'])(_0x850391)}})[_0x5be4b6(0x2b3)](_0xfe417=>{const _0x58638b=_0x5be4b6;common_1[_0x58638b(0x29c)]['error'](_0xfe417);});if(!_0x1f01ad)throw new common_1['HttpException'](_0x5be4b6(0x2c0),common_1['HttpStatus'][_0x5be4b6(0x32d)]);const _0x10b77c=_0x27f10a['map'](_0x1ec36a=>{return{'children':_0x1f01ad['filter'](_0x24e030=>_0x24e030['pid']===_0x1ec36a['id'])||[],..._0x1ec36a};});return{'rows':_0x10b77c};}async[_0x4c31a7(0x1d3)](){const _0x1a9ffb=_0x4c31a7,_0x434788=(0x0,utils_1[_0x1a9ffb(0x1eb)])(this[_0x1a9ffb(0x27a)]),_0x4f03f7=await this[_0x1a9ffb(0x316)][_0x1a9ffb(0x1e9)]({'where':{'saasId':_0x434788},'order':{'createdAt':_0x1a9ffb(0x212)}})[_0x1a9ffb(0x2b3)](_0x1f775b=>{const _0x36fd97=_0x1a9ffb;console[_0x36fd97(0x21e)](_0x1f775b);});if(!_0x4f03f7)throw new common_1['HttpException'](_0x1a9ffb(0x2c0),common_1[_0x1a9ffb(0x16b)]['BAD_REQUEST']);return _0x4f03f7;}async[_0x4c31a7(0x2f4)](_0x8dd52b){const _0x5a6163=_0x4c31a7,_0x2369e7=(0x0,utils_1[_0x5a6163(0x1eb)])(this['clsService']),{id:_0x373118,suggestCn:_0x44c592,suggestEn:_0x116d43,order:_0x5c42ec,image:_0x445d20}=_0x8dd52b,_0x1e6adb=await this[_0x5a6163(0x25c)]['findOne']({'where':{'suggestCn':_0x44c592,'saasId':_0x2369e7}});if(_0x373118){if(_0x1e6adb&&_0x1e6adb['id']!==_0x373118)throw new common_1[(_0x5a6163(0x294))]('推荐关键词已存在，不可重复添加',common_1[_0x5a6163(0x16b)]['BAD_REQUEST']);}else{if(_0x1e6adb)throw new common_1[(_0x5a6163(0x294))](_0x5a6163(0x310),common_1[_0x5a6163(0x16b)][_0x5a6163(0x32d)]);}const _0x25803f=await this[_0x5a6163(0x25c)][_0x5a6163(0x29b)]({'id':_0x373118,'suggestCn':_0x44c592,'suggestEn':_0x116d43,'order':_0x5c42ec||0x64,'image':_0x445d20||'','saasId':_0x2369e7})[_0x5a6163(0x2e4)](_0x4088d1=>!!_0x4088d1['id'])['catch'](_0x3d3d5c=>{const _0x7abe85=_0x5a6163;console[_0x7abe85(0x21e)](_0x3d3d5c);});if(!_0x25803f)throw new common_1[(_0x5a6163(0x294))]('保存推荐关键词',common_1[_0x5a6163(0x16b)][_0x5a6163(0x32d)]);return _0x25803f;}async['removeSuggestWords'](_0x3ef7e1){const _0x8d9624=_0x4c31a7,{id:_0x1b1ede}=_0x3ef7e1,_0x5dcd61=await this[_0x8d9624(0x25c)][_0x8d9624(0x223)]({'where':{'id':_0x1b1ede}});if(!_0x5dcd61)throw new common_1[(_0x8d9624(0x294))](_0x8d9624(0x321),common_1[_0x8d9624(0x16b)][_0x8d9624(0x32d)]);const _0x3d0405=await this[_0x8d9624(0x25c)][_0x8d9624(0x16d)](_0x1b1ede)['then'](_0x32da2=>_0x32da2[_0x8d9624(0x229)]>0x0)['catch'](_0x51d23a=>{const _0x5eb3bc=_0x8d9624;console[_0x5eb3bc(0x21e)](_0x51d23a);});if(!_0x3d0405)throw new common_1[(_0x8d9624(0x294))](_0x8d9624(0x22b),common_1['HttpStatus'][_0x8d9624(0x32d)]);return _0x3d0405;}async['querySuggestWords'](_0x588e05){const _0x417fd8=_0x4c31a7;let _0x9bb86={};const {page:_0x214cf6,size:_0x4eec94,saasId:_0x5593dc}=_0x588e05,_0x18891d=(0x0,utils_1[_0x417fd8(0x1eb)])(this[_0x417fd8(0x27a)]);(0x0,utils_1[_0x417fd8(0x1b2)])(this[_0x417fd8(0x27a)])?(0x0,utils_1[_0x417fd8(0x1bc)])(_0x5593dc)&&(_0x9bb86[_0x417fd8(0x172)]=_0x5593dc):_0x9bb86['saasId']=_0x18891d;const _0x42b0e4=await this[_0x417fd8(0x25c)]['findAndCount']({'where':_0x9bb86,'take':_0x4eec94,'skip':(_0x214cf6-0x1)*_0x4eec94,'order':{'order':_0x417fd8(0x212)}})['then'](([_0x39f137,_0x6c6e0b])=>({'rows':_0x39f137,'count':_0x6c6e0b}))['catch'](_0x57deac=>{const _0x78af3b=_0x417fd8;console[_0x78af3b(0x21e)](_0x57deac);});if(!_0x42b0e4)throw new common_1['HttpException']('查询推荐关键词失败',common_1[_0x417fd8(0x16b)][_0x417fd8(0x32d)]);return _0x42b0e4;}async[_0x4c31a7(0x314)](_0x58e54a,_0x568833){const _0x73dc03=_0x4c31a7,_0x3c39a5=await this[_0x73dc03(0x2be)]({'rec':_0x58e54a[_0x73dc03(0x2f9)],'page':_0x58e54a['page'],'size':_0x58e54a[_0x73dc03(0x20c)],'status':_0x58e54a[_0x73dc03(0x1af)],'keyword':_0x58e54a['keyword'],'squareType':_0x58e54a[_0x73dc03(0x16e)]},_0x568833);return _0x3c39a5['rows'][_0x73dc03(0x1ec)](_0x389267=>{const _0x3181f8=_0x73dc03;_0x389267[_0x3181f8(0x30c)]=_0x389267[_0x3181f8(0x30c)]?JSON[_0x3181f8(0x204)](_0x389267['fileInfo']):{};}),this[_0x73dc03(0x1ae)](_0x3c39a5[_0x73dc03(0x1d2)]),_0x3c39a5;}async[_0x4c31a7(0x2dc)](_0x549bc4,_0x11afcd){const _0x499c61=_0x4c31a7,_0x5b92d1=await this[_0x499c61(0x170)]({'rec':_0x549bc4[_0x499c61(0x2f9)],'page':_0x549bc4[_0x499c61(0x1d0)],'size':_0x549bc4[_0x499c61(0x20c)],'status':_0x549bc4[_0x499c61(0x1af)],'keyword':_0x549bc4[_0x499c61(0x1b5)],'squareType':_0x549bc4[_0x499c61(0x16e)]},_0x11afcd);return _0x5b92d1[_0x499c61(0x1d2)][_0x499c61(0x1ec)](_0x9fa54a=>{const _0x209a33=_0x499c61;_0x9fa54a[_0x209a33(0x30c)]=_0x9fa54a[_0x209a33(0x30c)]?JSON[_0x209a33(0x204)](_0x9fa54a[_0x209a33(0x30c)]):{};}),this['mergeThumb'](_0x5b92d1['rows']),this['modelsService'][_0x499c61(0x351)](_0x5b92d1[_0x499c61(0x1d2)],model_constant_1['EModelType'][_0x499c61(0x2a4)]),_0x5b92d1;}[_0x4c31a7(0x1ae)](_0x30083e){_0x30083e['forEach'](_0x574017=>{const _0x683fa5=_0x4696;_0x574017[_0x683fa5(0x236)]&&_0x574017['responseResult'][_0x683fa5(0x252)]&&_0x574017[_0x683fa5(0x236)][_0x683fa5(0x1ec)]((_0x7da457,_0x2b8585)=>{const _0x303a27=_0x683fa5,_0x465d68=_0x7da457[_0x303a27(0x354)][_0x303a27(0x292)](_0x303a27(0x230))?_0x303a27(0x197):_0x303a27(0x2f5),_0x2bb95c=_0x465d68===_0x303a27(0x197)?_0x303a27(0x18d):_0x303a27(0x24e);_0x574017[_0x303a27(0x236)][_0x2b8585][_0x303a27(0x210)]=_0x7da457[_0x303a27(0x354)]+_0x2bb95c;});});}[_0x4c31a7(0x243)](_0xeb827){const _0x5e2070=_0x4c31a7;if(!_0xeb827)return'fast';if(_0xeb827===midjourney_constant_1[_0x5e2070(0x205)][_0x5e2070(0x24b)])return _0x5e2070(0x24b);if(_0xeb827===midjourney_constant_1[_0x5e2070(0x205)][_0x5e2070(0x2e1)])return _0x5e2070(0x2e1);if(_0xeb827===midjourney_constant_1[_0x5e2070(0x205)][_0x5e2070(0x239)])return _0x5e2070(0x239);return _0x5e2070(0x24b);}async['syncWorkFlowDict'](){const _0x195637=_0x4c31a7;if(process[_0x195637(0x33d)][_0x195637(0x216)]===_0x195637(0x1dd))return;try{const _0x4270f2=await this[_0x195637(0x1a6)][_0x195637(0x326)]({});for(let _0x49c236 in _0x4270f2){let _0x2b854d=_0x49c236;for(let _0x2ef21b=0x0;_0x2ef21b<_0x4270f2[_0x49c236][_0x195637(0x252)];_0x2ef21b++){const _0x9d4b7=_0x4270f2[_0x49c236][_0x2ef21b];let _0x185262=await this[_0x195637(0x1e1)][_0x195637(0x30e)](_0x2b854d,String(_0x9d4b7['id']));_0x185262?(_0x185262['dictType']=_0x2b854d,_0x185262[_0x195637(0x27f)]=_0x9d4b7['name'],_0x185262[_0x195637(0x263)]=String(_0x9d4b7['id'])):_0x185262={'dictType':_0x2b854d,'dictName':_0x9d4b7[_0x195637(0x238)],'dictValue':String(_0x9d4b7['id'])},await this[_0x195637(0x1e1)]['save4workflow'](_0x185262);}}common_1[_0x195637(0x29c)][_0x195637(0x21e)](_0x195637(0x2c7));}catch(_0x32c354){common_1[_0x195637(0x29c)][_0x195637(0x179)](_0x32c354,_0x195637(0x33f));}}async[_0x4c31a7(0x372)](_0x51ed6e){const _0x57d741=_0x4c31a7;let _0x4c5230=[];try{const _0x2b60ea=await this['czTaskService']['modelPage']({'data':{'size':0x32,'index':0x1,'tagIds':[_0x51ed6e]}});_0x4c5230=_0x4c5230['concat'](_0x2b60ea['datas']);for(let _0x466ecc=0x2;_0x466ecc<=_0x2b60ea[_0x57d741(0x2ad)];_0x466ecc++){const _0x6d0140=await this[_0x57d741(0x1a6)][_0x57d741(0x17f)]({'data':{'index':_0x466ecc,'size':0x32,'tagIds':[_0x51ed6e]}});_0x4c5230=_0x4c5230[_0x57d741(0x251)](_0x6d0140[_0x57d741(0x286)]);}return _0x4c5230;}catch(_0x1e5681){return common_1['Logger'][_0x57d741(0x179)](_0x1e5681,_0x57d741(0x21f)),[];}}async[_0x4c31a7(0x21c)](){const _0x50d13a=_0x4c31a7;if(process[_0x50d13a(0x33d)]['ENV']==='development')return;try{const _0x137797=await this['dictService'][_0x50d13a(0x32e)]([_0x50d13a(0x222),_0x50d13a(0x329),_0x50d13a(0x323),_0x50d13a(0x1f4)]),_0x34998f=new Map(),_0xdff78b=await this[_0x50d13a(0x188)][_0x50d13a(0x1e9)]();_0xdff78b[_0x50d13a(0x1ec)](_0x2b2d5c=>_0x34998f[_0x50d13a(0x28f)](_0x2b2d5c['id'],_0x2b2d5c));for(let _0xfd272b=0x0;_0xfd272b<_0x137797[_0x50d13a(0x252)];_0xfd272b++){const _0x359957=_0x137797[_0xfd272b][_0x50d13a(0x27f)],_0x183770=Number(_0x137797[_0xfd272b][_0x50d13a(0x263)]),_0xcfbdce=await this[_0x50d13a(0x372)](_0x183770);_0xcfbdce[_0x50d13a(0x1ec)](_0x44ebc9=>{const _0x335e99=_0x50d13a,_0x53bc14=String(_0x44ebc9['id']);!_0x34998f[_0x335e99(0x364)](_0x53bc14)&&_0x34998f[_0x335e99(0x28f)](_0x53bc14,{'id':_0x53bc14,'type':_0x44ebc9[_0x335e99(0x34b)],'name':_0x44ebc9['name'],'cover':_0x335e99(0x301)+_0x44ebc9['coverImageUrl'],'version':_0x44ebc9[_0x335e99(0x1c7)],'description':'','triggerWords':_0x44ebc9['triggerWords']});const _0x213033=_0x34998f['get'](_0x53bc14);_0x137797[_0xfd272b][_0x335e99(0x270)]===_0x335e99(0x222)&&(_0x213033[_0x335e99(0x222)]=_0x183770,_0x213033['styleName']=_0x359957),_0x137797[_0xfd272b][_0x335e99(0x270)]===_0x335e99(0x329)&&(_0x213033[_0x335e99(0x1a5)]=_0x183770,_0x213033[_0x335e99(0x2e3)]=_0x359957),_0x137797[_0xfd272b][_0x335e99(0x270)]===_0x335e99(0x323)&&(_0x213033[_0x335e99(0x356)]=_0x183770,_0x213033[_0x335e99(0x1e4)]=_0x359957),_0x137797[_0xfd272b][_0x335e99(0x270)]==='application_fields'&&(_0x213033[_0x335e99(0x2ae)]=_0x183770,_0x213033[_0x335e99(0x1c4)]=_0x359957);});}await this['mjModelEntity'][_0x50d13a(0x29b)](Array[_0x50d13a(0x365)](_0x34998f[_0x50d13a(0x1c5)]())),common_1[_0x50d13a(0x29c)][_0x50d13a(0x21e)](_0x50d13a(0x1f2));}catch(_0x62f89b){common_1[_0x50d13a(0x29c)][_0x50d13a(0x179)](_0x62f89b,'触站::模型信息同步失败');}}async['syncTaskInfo'](_0x46411b){const _0x5adc3b=_0x4c31a7,_0x5ec253=await this[_0x5adc3b(0x1c6)][_0x5adc3b(0x1fd)]({'data':{'ids':[_0x46411b]}});common_1[_0x5adc3b(0x29c)][_0x5adc3b(0x21e)](_0x5adc3b(0x2c3)),this[_0x5adc3b(0x1b9)](_0x5ec253[0x0]);}async[_0x4c31a7(0x1ad)](_0x2e59ca){const _0xa44e86=_0x4c31a7,_0x2ac35e=await this[_0xa44e86(0x2d8)][_0xa44e86(0x35c)](_0x2e59ca['user']['id']),_0x4531e1={'fast':0x0,'relax':0x0,'trubo':0x0};let _0x56133e=redisKey_constant_1[_0xa44e86(0x1ed)]+'-'+_0x2ac35e['id']+'-';if(_0x2ac35e['vipExpire']||_0x2ac35e[_0xa44e86(0x224)]){const [_0x38cdec,_0x305512,_0x548b26]=await Promise[_0xa44e86(0x2d5)]([this[_0xa44e86(0x17a)][_0xa44e86(0x1e2)]({'key':_0x56133e+'fast_vip_free'}),this[_0xa44e86(0x17a)][_0xa44e86(0x1e2)]({'key':_0x56133e+_0xa44e86(0x1fb)}),this[_0xa44e86(0x17a)][_0xa44e86(0x1e2)]({'key':_0x56133e+_0xa44e86(0x217)})]);_0x4531e1['fast']=Number(_0x38cdec||0x0),_0x4531e1[_0xa44e86(0x2e1)]=Number(_0x305512||0x0),_0x4531e1[_0xa44e86(0x2c1)]=Number(_0x548b26||0x0);}return _0x4531e1;}[_0x4c31a7(0x2eb)](_0x59e18a){const _0x2b32c9=_0x4c31a7;if(typeof _0x59e18a===_0x2b32c9(0x345))return midjourney_constant_1['MjpStateMap']['get'](_0x59e18a);if(typeof _0x59e18a===_0x2b32c9(0x1b6))return midjourney_constant_1['MjpStateIndexMap'][_0x2b32c9(0x1e2)](_0x59e18a);}async[_0x4c31a7(0x1b9)](_0x3e6ae3){const _0x2a223a=_0x4c31a7;common_1['Logger']['log'](_0x3e6ae3,'MJ\x20通知内容：');try{let _0x16302d=[];const _0x4df9c2=this[_0x2a223a(0x2eb)](_0x3e6ae3['status']),_0x1af3d1=_0x3e6ae3[_0x2a223a(0x304)]?parseFloat(_0x3e6ae3[_0x2a223a(0x304)]):null;let _0x3f74bf=await this[_0x2a223a(0x2f8)][_0x2a223a(0x30b)]({'where':{'mjpTaskId':_0x3e6ae3['id']}});if(_0x3e6ae3[_0x2a223a(0x1af)]==='MODAL'&&_0x3f74bf[_0x2a223a(0x2ac)]){common_1['Logger'][_0x2a223a(0x21e)](_0x2a223a(0x23e),'Mj\x20Modal\x20通知');return;}_0x3e6ae3[_0x2a223a(0x169)]&&(_0x16302d=_0x3e6ae3[_0x2a223a(0x169)][_0x2a223a(0x237)](_0x3b6fd1=>_0x3b6fd1[_0x2a223a(0x1c1)]!==_0x2a223a(0x1fe)&&_0x3b6fd1[_0x2a223a(0x296)]!=='❤️'));store_1['MjConfig'][_0x2a223a(0x361)]&&_0x3e6ae3[_0x2a223a(0x258)]&&(_0x3e6ae3[_0x2a223a(0x258)]=_0x3e6ae3[_0x2a223a(0x258)][_0x2a223a(0x267)]('https://cdn.discordapp.com',store_1[_0x2a223a(0x200)]['mjProxyImgUrl']));const _0xb01151={'id':_0x3f74bf['id'],'status':_0x4df9c2,'progress':_0x1af3d1,'buttons':_0x16302d,'durationSpent':null,'imageUrl':_0x3e6ae3[_0x2a223a(0x258)],'failReason':_0x3e6ae3['failReason']};return(_0x3e6ae3['action']===_0x2a223a(0x350)||_0x3e6ae3['action']===0x4)&&(_0xb01151['prompt']=_0x3e6ae3[_0x2a223a(0x1f9)]||_0x3e6ae3[_0x2a223a(0x199)]?.[_0x2a223a(0x1f9)]||_0x3e6ae3[_0x2a223a(0x34d)],_0xb01151['fullPrompt']=_0x3e6ae3[_0x2a223a(0x1f9)]||_0x3e6ae3[_0x2a223a(0x199)]?.[_0x2a223a(0x1f9)]||_0x3e6ae3[_0x2a223a(0x34d)]),_0x3e6ae3[_0x2a223a(0x320)]===_0x2a223a(0x1ab)&&(_0xb01151[_0x2a223a(0x26d)]=_0x3e6ae3['promptEn'],_0xb01151[_0x2a223a(0x2c8)]=_0x3e6ae3['promptEn']),_0x3e6ae3[_0x2a223a(0x227)]&&_0x3e6ae3[_0x2a223a(0x290)]&&(_0xb01151[_0x2a223a(0x1d6)]=(_0x3e6ae3['finishTime']-_0x3e6ae3[_0x2a223a(0x290)])/0x3e8),_0x3e6ae3[_0x2a223a(0x1af)]===_0x2a223a(0x2d1)&&_0x3e6ae3[_0x2a223a(0x258)]?(console[_0x2a223a(0x21e)](_0x2a223a(0x17b),_0x3e6ae3[_0x2a223a(0x258)]),_0xb01151['progress']=99.99,_0xb01151[_0x2a223a(0x1af)]=0x2,_0x3f74bf=await this[_0x2a223a(0x2f8)][_0x2a223a(0x29b)](_0xb01151),this[_0x2a223a(0x2ef)][_0x2a223a(0x1e5)](_0x3f74bf['id'],_0x3e6ae3[_0x2a223a(0x258)],_0x3e6ae3['imageUrls'])):_0x3f74bf=await this[_0x2a223a(0x2f8)][_0x2a223a(0x29b)](_0xb01151),null;}catch(_0x30f72d){common_1[_0x2a223a(0x29c)][_0x2a223a(0x179)](_0x2a223a(0x249),_0x30f72d);}}async[_0x4c31a7(0x1a1)](_0x176f25){const _0x275237=_0x4c31a7;common_1[_0x275237(0x29c)][_0x275237(0x21e)](_0x176f25,_0x275237(0x1b3));try{const _0x28dbf4=midjourney_constant_1['CzStateMap'][_0x275237(0x1e2)](_0x176f25[_0x275237(0x254)]),_0x54379a=Number(_0x176f25[_0x275237(0x304)])*0x64;let _0x39aebc=await this[_0x275237(0x2f8)][_0x275237(0x30b)]({'where':{'mjpTaskId':_0x176f25[_0x275237(0x35f)]}});const _0x4d12fb={'id':_0x39aebc['id'],'status':_0x28dbf4,'progress':_0x54379a,'imageUrl':_0x176f25[_0x275237(0x25e)]?.['map'](_0x46261e=>_0x46261e[_0x275237(0x354)])['join']('↢↣')};return _0x39aebc=await this[_0x275237(0x2f8)][_0x275237(0x29b)](_0x4d12fb),_0x39aebc[_0x275237(0x1af)]===0x3&&_0x39aebc[_0x275237(0x258)]&&this[_0x275237(0x2ef)]['transferImg'](_0x39aebc['id'],_0x39aebc['imageUrl']),null;}catch(_0x5b00a6){common_1['Logger'][_0x275237(0x179)](_0x275237(0x2f2),_0x5b00a6);}}async[_0x4c31a7(0x184)](_0x352591){const _0x4547c1=_0x4c31a7;common_1[_0x4547c1(0x29c)][_0x4547c1(0x21e)](_0x352591,_0x4547c1(0x2a8));try{const _0x412f64=midjourney_constant_1[_0x4547c1(0x22c)][_0x4547c1(0x1e2)](_0x352591[_0x4547c1(0x254)]),_0x5788d9=Number(_0x352591[_0x4547c1(0x304)])*0x64;let _0x8b9bbf=await this[_0x4547c1(0x2f8)][_0x4547c1(0x30b)]({'where':{'mjpTaskId':_0x352591[_0x4547c1(0x35f)]}});const _0x19ea48={'id':_0x8b9bbf['id'],'status':_0x412f64,'progress':_0x5788d9,'imageUrl':_0x352591[_0x4547c1(0x2a9)]?.[_0x4547c1(0x19a)](_0x4c0484=>_0x4c0484[_0x4547c1(0x258)])[_0x4547c1(0x1c8)]('↢↣')};return _0x8b9bbf=await this[_0x4547c1(0x2f8)][_0x4547c1(0x29b)](_0x19ea48),_0x8b9bbf[_0x4547c1(0x1af)]===0x3&&_0x8b9bbf[_0x4547c1(0x258)]&&this['fileService'][_0x4547c1(0x1e5)](_0x8b9bbf['id'],_0x8b9bbf[_0x4547c1(0x258)]),null;}catch(_0x46e82a){common_1['Logger'][_0x4547c1(0x179)](_0x4547c1(0x2f2),_0x46e82a);}}async[_0x4c31a7(0x2ba)](){const _0x2ad3dc=_0x4c31a7;this['syncMjTask'](),this[_0x2ad3dc(0x253)](),this[_0x2ad3dc(0x335)]();}async[_0x4c31a7(0x1ce)](){const _0x221ef1=_0x4c31a7;try{const _0x5afa80=await this[_0x221ef1(0x2f8)][_0x221ef1(0x1e9)]({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6]),'botType':(0x0,typeorm_2['In'])([DrawTaskPage_dto_1[_0x221ef1(0x1a2)][_0x221ef1(0x246)],DrawTaskPage_dto_1[_0x221ef1(0x1a2)]['NIJI_JOURNEY']])}});if(_0x5afa80[_0x221ef1(0x252)])for(let _0x39283b=0x0;_0x39283b<_0x5afa80[_0x221ef1(0x252)];_0x39283b++){const _0x3b8853=redisKey_constant_1[_0x221ef1(0x2cf)]+_0x5afa80[_0x39283b][_0x221ef1(0x176)],_0x7be7c=await this[_0x221ef1(0x17a)][_0x221ef1(0x1e2)]({'key':_0x3b8853});if(_0x7be7c)continue;else this[_0x221ef1(0x17a)][_0x221ef1(0x28f)]({'key':_0x3b8853,'val':'lock'}),this['mjpTaskService'][_0x221ef1(0x1fd)]({'data':{'ids':[_0x5afa80[_0x39283b][_0x221ef1(0x176)]]}})[_0x221ef1(0x2e4)](async _0xfc047a=>{const _0x55307b=_0x221ef1;if(_0xfc047a&&_0xfc047a['length']){const _0x13e489=_0xfc047a[0x0],_0x24ff3e=_0x5afa80[_0x39283b],_0x544116=this['parseMjStatus'](_0x13e489['status']),_0x2361de=_0x13e489[_0x55307b(0x304)]?parseFloat(_0x13e489[_0x55307b(0x304)]):null;if(_0x24ff3e[_0x55307b(0x304)]===_0x2361de&&_0x24ff3e[_0x55307b(0x1af)]===_0x544116){}else{const _0x372112=_0x13e489[_0x55307b(0x169)][_0x55307b(0x237)](_0x1b5798=>_0x1b5798[_0x55307b(0x1c1)]!==_0x55307b(0x357)&&_0x1b5798[_0x55307b(0x1c1)]!==_0x55307b(0x1fe)&&_0x1b5798[_0x55307b(0x296)]!=='❤️'),_0x2f0b2c={'id':_0x24ff3e['id'],'mjpTaskId':_0x13e489['id'],'status':_0x544116,'progress':_0x2361de,'buttons':_0x372112,'durationSpent':null,'imageUrl':_0x13e489[_0x55307b(0x258)],'failReason':_0x13e489['failReason']};store_1[_0x55307b(0x200)][_0x55307b(0x361)]&&_0x2f0b2c[_0x55307b(0x258)]&&(_0x2f0b2c['imageUrl']=_0x2f0b2c[_0x55307b(0x258)][_0x55307b(0x267)](_0x55307b(0x1fa),store_1[_0x55307b(0x200)][_0x55307b(0x361)])),(_0x13e489[_0x55307b(0x320)]===_0x55307b(0x350)||_0x13e489[_0x55307b(0x320)]===0x4)&&(_0x2f0b2c[_0x55307b(0x26d)]=_0x13e489[_0x55307b(0x1f9)]||_0x13e489[_0x55307b(0x199)]?.[_0x55307b(0x1f9)],_0x2f0b2c[_0x55307b(0x2c8)]=_0x13e489['finalPrompt']||_0x13e489[_0x55307b(0x199)]?.['finalPrompt']),_0x13e489[_0x55307b(0x227)]&&_0x13e489['startTime']&&(_0x2f0b2c[_0x55307b(0x1d6)]=(_0x13e489[_0x55307b(0x227)]-_0x13e489['startTime'])/0x3e8),await this[_0x55307b(0x2f8)][_0x55307b(0x29b)](_0x2f0b2c);}}})[_0x221ef1(0x2b3)](_0x409289=>{const _0x333285=_0x221ef1;common_1[_0x333285(0x29c)][_0x333285(0x179)](_0x333285(0x218),_0x409289);})[_0x221ef1(0x226)](()=>{const _0x4f5473=_0x221ef1;this[_0x4f5473(0x17a)][_0x4f5473(0x31b)]({'key':_0x3b8853});});}}catch(_0x42bd55){}}async[_0x4c31a7(0x253)](){const _0xd98b23=_0x4c31a7;try{const _0x4d65d2=await this[_0xd98b23(0x2f8)][_0xd98b23(0x1e9)]({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2]),'mjpTaskId':(0x0,typeorm_2['Not'])((0x0,typeorm_2[_0xd98b23(0x2f0)])()),'botType':DrawTaskPage_dto_1[_0xd98b23(0x1a2)][_0xd98b23(0x278)]}});if(_0x4d65d2[_0xd98b23(0x252)])for(let _0x21f2f4=0x0;_0x21f2f4<_0x4d65d2[_0xd98b23(0x252)];_0x21f2f4++){const _0x302b87=redisKey_constant_1[_0xd98b23(0x2cf)]+_0x4d65d2[_0x21f2f4][_0xd98b23(0x176)],_0x25c4e6=await this[_0xd98b23(0x17a)][_0xd98b23(0x1e2)]({'key':_0x302b87});if(_0x25c4e6)continue;else{this[_0xd98b23(0x17a)]['set']({'key':_0x302b87,'val':_0xd98b23(0x2ff)});try{const _0x38a057=await this[_0xd98b23(0x1a6)][_0xd98b23(0x207)]({'data':{'taskId':_0x4d65d2[_0x21f2f4][_0xd98b23(0x176)]}});this[_0xd98b23(0x1a1)](_0x38a057);}catch(_0x2254bd){common_1[_0xd98b23(0x29c)][_0xd98b23(0x179)](_0xd98b23(0x2a3),_0x2254bd);}finally{this['redisCacheService']['del']({'key':_0x302b87});}}}}catch(_0x3a0acc){}}async['syncSdTask'](){const _0x3f5187=_0x4c31a7;try{const _0x26e17e=await this[_0x3f5187(0x2f8)]['find']({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2]),'botType':DrawTaskPage_dto_1['EBotType']['SD']}});if(_0x26e17e[_0x3f5187(0x252)])for(let _0x5d3944=0x0;_0x5d3944<_0x26e17e[_0x3f5187(0x252)];_0x5d3944++){const _0x2c4695=redisKey_constant_1['MJ_TASK_UPDATE']+_0x26e17e[_0x5d3944][_0x3f5187(0x176)],_0x4edaa=await this[_0x3f5187(0x17a)][_0x3f5187(0x1e2)]({'key':_0x2c4695});if(_0x4edaa)continue;else{this[_0x3f5187(0x17a)][_0x3f5187(0x28f)]({'key':_0x2c4695,'val':_0x3f5187(0x2ff)});try{const _0x2b0c8c=await this['czTaskService'][_0x3f5187(0x1b1)]({'data':{'taskId':_0x26e17e[_0x5d3944][_0x3f5187(0x176)]}});this['notifySD'](_0x2b0c8c);}catch(_0x350d7f){common_1['Logger'][_0x3f5187(0x179)](_0x3f5187(0x165),_0x350d7f);}finally{this['redisCacheService'][_0x3f5187(0x31b)]({'key':_0x2c4695});}}}}catch(_0x160fa7){}}async[_0x4c31a7(0x191)](){const _0x378a60=_0x4c31a7;if(store_1['MjConfig'][_0x378a60(0x2ee)])return;try{const _0x892b02=[{'status':0x3,'imageUrl':(0x0,typeorm_2['Like'])(_0x378a60(0x363))}];store_1['MjConfig']['mjProxyImgUrl']&&_0x892b02['push']({'status':0x3,'imageUrl':(0x0,typeorm_2[_0x378a60(0x275)])(store_1[_0x378a60(0x200)][_0x378a60(0x361)]+'%')});const _0x85e37b=await this[_0x378a60(0x2f8)][_0x378a60(0x1e9)]({'where':_0x892b02});if(_0x85e37b[_0x378a60(0x252)])for(let _0x10d691=0x0;_0x10d691<_0x85e37b['length'];_0x10d691++){let {id:_0x10c7e9,imageUrl:_0x3e8a79}=_0x85e37b[_0x10d691];this[_0x378a60(0x2ef)][_0x378a60(0x1e5)](_0x10c7e9,_0x3e8a79);}}catch(_0x4f743b){common_1['Logger'][_0x378a60(0x179)](_0x4f743b);}}async['batchTaskResult'](){const _0x223a08=_0x4c31a7;try{const _0x5c20c5=store_1['MjConfig'][_0x223a08(0x220)]||0x5,_0x496d6f=[{'status':(0x0,typeorm_2['In'])([0x2,0x4]),'isRefund':0x0,'updatedAt':(0x0,typeorm_2[_0x223a08(0x19b)])(new Date(Date[_0x223a08(0x371)]()-_0x5c20c5*0x3c*0x3e8))}],_0x42af0f=await this[_0x223a08(0x2f8)][_0x223a08(0x1e9)]({'where':_0x496d6f});_0x42af0f[_0x223a08(0x1ec)](_0x18fcb5=>{const _0x907429=_0x223a08;_0x18fcb5[_0x907429(0x1af)]=0x4,_0x18fcb5['failReason']=_0x18fcb5[_0x907429(0x181)]||_0x907429(0x1d7),_0x18fcb5[_0x907429(0x167)]=0x1,this[_0x907429(0x2f8)]['save'](_0x18fcb5),this[_0x907429(0x2d8)][_0x907429(0x23f)](_0x18fcb5[_0x907429(0x28d)],_0x18fcb5[_0x907429(0x240)],_0x18fcb5[_0x907429(0x250)]||_0x907429(0x2fa),_0x18fcb5['id']);});}catch(_0x3f2235){common_1['Logger'][_0x223a08(0x179)](_0x3f2235);}}};function _0x4696(_0x1832dc,_0x3aa62a){const _0x2358eb=_0x2358();return _0x4696=function(_0x469608,_0x51ba64){_0x469608=_0x469608-0x162;let _0xf253fc=_0x2358eb[_0x469608];return _0xf253fc;},_0x4696(_0x1832dc,_0x3aa62a);}MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(mjModel_entity_1['MjModelEntity'])),__param(0x1,(0x0,typeorm_1[_0x4c31a7(0x1b0)])(mjParam_entity_1[_0x4c31a7(0x1b8)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(mjPrompts_entity_1['MjPromptsEntity'])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x4c31a7(0x201)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(mjSuggestWord_entity_1[_0x4c31a7(0x305)])),__param(0x5,(0x0,typeorm_1[_0x4c31a7(0x1b0)])(mjIncantation_entity_1[_0x4c31a7(0x24c)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(mjInspireClassify_entity_1[_0x4c31a7(0x36a)])),__param(0x7,(0x0,typeorm_1[_0x4c31a7(0x1b0)])(mjIncantationClassify_entity_1[_0x4c31a7(0x2c6)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x4c31a7(0x2ca)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x4c31a7(0x2ca)],typeorm_2[_0x4c31a7(0x2ca)],typeorm_2[_0x4c31a7(0x2ca)],typeorm_2[_0x4c31a7(0x2ca)],nestjs_cls_1['ClsService'],dict_service_1[_0x4c31a7(0x164)],user_service_1[_0x4c31a7(0x26b)],file_service_1[_0x4c31a7(0x23a)],fanyi_service_1[_0x4c31a7(0x272)],aiLog_service_1[_0x4c31a7(0x298)],models_service_1['ModelsService'],czTask_service_1['CZTaskService'],mjpTask_service_1[_0x4c31a7(0x1da)],badwords_service_1[_0x4c31a7(0x171)],redisCache_service_1[_0x4c31a7(0x336)],mjpAccount_service_1[_0x4c31a7(0x35d)],globalConfig_service_1[_0x4c31a7(0x1bf)],typeorm_2[_0x4c31a7(0x281)]])],MidjourneyService),exports['MidjourneyService']=MidjourneyService;