'use strict';const _0x18ccf3=_0x1513;(function(_0x4a10a9,_0x3c867e){const _0xe7a5ef=_0x1513,_0x881027=_0x4a10a9();while(!![]){try{const _0x534dce=parseInt(_0xe7a5ef(0x1e7))/0x1+parseInt(_0xe7a5ef(0x16a))/0x2+parseInt(_0xe7a5ef(0x12c))/0x3+parseInt(_0xe7a5ef(0x280))/0x4*(parseInt(_0xe7a5ef(0x1c4))/0x5)+parseInt(_0xe7a5ef(0x186))/0x6*(-parseInt(_0xe7a5ef(0x15e))/0x7)+-parseInt(_0xe7a5ef(0x1cd))/0x8*(parseInt(_0xe7a5ef(0x1bc))/0x9)+-parseInt(_0xe7a5ef(0x1b8))/0xa;if(_0x534dce===_0x3c867e)break;else _0x881027['push'](_0x881027['shift']());}catch(_0x13d8fd){_0x881027['push'](_0x881027['shift']());}}}(_0x16a9,0x8f355));var __decorate=this&&this[_0x18ccf3(0x2d1)]||function(_0x113aeb,_0x2f131a,_0x107a77,_0x1533c9){const _0x4115c2=_0x18ccf3;var _0x10660a=arguments['length'],_0x1226fc=_0x10660a<0x3?_0x2f131a:_0x1533c9===null?_0x1533c9=Object[_0x4115c2(0x29e)](_0x2f131a,_0x107a77):_0x1533c9,_0x3f3117;if(typeof Reflect===_0x4115c2(0x1a5)&&typeof Reflect[_0x4115c2(0x261)]===_0x4115c2(0x209))_0x1226fc=Reflect[_0x4115c2(0x261)](_0x113aeb,_0x2f131a,_0x107a77,_0x1533c9);else{for(var _0x548db4=_0x113aeb[_0x4115c2(0x24a)]-0x1;_0x548db4>=0x0;_0x548db4--)if(_0x3f3117=_0x113aeb[_0x548db4])_0x1226fc=(_0x10660a<0x3?_0x3f3117(_0x1226fc):_0x10660a>0x3?_0x3f3117(_0x2f131a,_0x107a77,_0x1226fc):_0x3f3117(_0x2f131a,_0x107a77))||_0x1226fc;}return _0x10660a>0x3&&_0x1226fc&&Object[_0x4115c2(0x1e2)](_0x2f131a,_0x107a77,_0x1226fc),_0x1226fc;},__metadata=this&&this[_0x18ccf3(0x1ec)]||function(_0x396649,_0x17ce82){const _0x2e0d0c=_0x18ccf3;if(typeof Reflect===_0x2e0d0c(0x1a5)&&typeof Reflect['metadata']===_0x2e0d0c(0x209))return Reflect[_0x2e0d0c(0x192)](_0x396649,_0x17ce82);},__param=this&&this[_0x18ccf3(0x10d)]||function(_0x384257,_0xfd6bcd){return function(_0x4275af,_0x5dc656){_0xfd6bcd(_0x4275af,_0x5dc656,_0x384257);};};Object[_0x18ccf3(0x1e2)](exports,_0x18ccf3(0x229),{'value':!![]}),exports[_0x18ccf3(0x196)]=void 0x0;function _0x1513(_0xc3fcb1,_0x584153){const _0x16a917=_0x16a9();return _0x1513=function(_0x1513d5,_0x254e32){_0x1513d5=_0x1513d5-0xd4;let _0x3073aa=_0x16a917[_0x1513d5];return _0x3073aa;},_0x1513(_0xc3fcb1,_0x584153);}function _0x16a9(){const _0x50fcd8=['MidjourneyEntity','syncTaskInfo','finalPrompt','key','920BgWfOv','查询灵感分类失败','userInfo','collect','--sw','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','--cw','不需要灵感广场分类','increaseVisit','inputs','sdTaskSubmit','concurrentLimit','dataType','findOne','Connection','imageUrl','MjPromptsEntity','id不能为空！','promptEn','syncWfTask','setPrompt','defineProperty','WORKFLOW','BAD_REQUEST','workflowRun','czTaskService','1117711OmvTRM','lifetimeUsage','无绘图记录','findAndCount','favoriteListByTypeAndIds','__metadata','../../common/constants/midjourney.constant','getUserInfoFromHeader','mjpTaskService','getMjAccount','workflowDel','MEGA','username','mjInspireClassifyEntity','绘制中的图片任务、禁止删除！','version','syncMjpAccount','工作流（小工具）不存在','paintingSign','./mjModel.entity','list4workflow','avatar','trim','Describe','getUserById','美女形象','RELAX','queryTopMjIncantationClassify','push','addMjIncantation','parseExtendArgs','删除推荐关键词失败','../file/file.service','buttons','function','../api/mjpTask.service','IMAGE_TO_TEXT','\x20GROUP\x20BY\x20workflowId\x20)\x20t\x20ON\x20t.workflowId\x20=\x20m.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.workflowId\x20IS\x20NOT\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.createdAt\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','get4workflow','PRO','maskBase64','env','botType','parseMjStatus','dictValue','all','renewDate','fileService','mjTimeoutMs','customId','keyword','mjSuggestWordEntity','saasId','任务类型错误','state','Custom\x20Zoom','未查询到咒语一级分类','fileInfo','FaceSwap','../redisCache/redisCache.service','workflowDetail','VIP_FREE','stringify','推荐关键词不存在','filter','Mozilla/5.0\x20(Macintosh;\x20Intel\x20Mac\x20OS\x20X\x2010_15_7)\x20AppleWebKit/537.36\x20(KHTML,\x20like\x20Gecko)\x20Chrome/112.0.0.0\x20Safari/537.36','__esModule','startTime','RedisCacheService','email','触站::模型信息同步失败','MidjourneyStatusEnum','createdAt','guildId','../models/models.service','DESC','getExtByRelate','catch','wfTaskUpdateJob:\x20','design:paramtypes','number','FileService','action','uncollect','触站::运用领域、风格画风、作用主体、作用类别字典同步失败','effectCategoryName','getModelById','deductBalance4WorkFlow','getMjInspireClassify','findOneBy','../../common/constants/model.constant','fast','MjModelEntity','value','getModelByIds','trubo','MjSuggestWordEntity','./mjSuggestWord.entity','摄影拍照','length','toString','https://cdn.discordapp.com%','modelPage','STANDARD','mjProxyImgUrl','FanyiService','error','presetId','mjModelEntity','\x20GROUP\x20BY\x20workflowId\x20)\x20t\x20ON\x20t.workflowId\x20=\x20m.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.workflowId\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20','transferImg','getConfigByKeys','操作失败！','getUserId','CZTaskService','../api/czTask.service','绘制的任务不存在！','添加绘图任务失败','mjModel','deduct','modifyMjInspireClassify','squire-images','decorate','relateId','checkBadWords','lifetimeVip','failReason','save','connection','syncInfo','originPrompt','\x20--cref\x20','syncMjpAccountManual','prompt','taskId','model','instanceId','level','replace','vipFreeNum','relax_vip_free','查询咒语分类失败','user','jobIds','删除成功！','deleteDraw','ASC','aiLogService','MjConfig','queryMjInspireClassify','query','createRandomUid','deductBalance4SD','180544CgByBj','effectMainBody','disabled','styleName','data:image/png;base64,','workflowModelPage','--cref','freeUsed','exist','addDrawQueue','fast_vip_free','Logger','AiLogService','classifyName','has','remix','MJ\x20通知内容：','workflowUsedPage','\x20OFFSET\x20','from','mjpAccountService','isPlatform','\x20--iw\x20','remark','modelDel','finally','notify','convertToEnglish','IMAGE_MIX_IMAGE','style','getOwnPropertyDescriptor','join','mjpId','../globalConfig/globalConfig.service','非法操作！','ClsService','queryMjIncantation','log','mjpTaskId','mode','账号不存在','datas','sdTaskInpaint','MjIncantationClassifyEntity','UserCollectType','split','getDetailByIds','getAgreeMap','mjParamEntity','result','prompt包含敏感词','mjIncantationEntity','mjPromptsEntity','imagine','mergeCollectDataForUserId','turbo','copyAccountInfo','effect_main_body','badwordsService','clsService','initInspireData','channelId','触站工作流任务通知异常:\x20','HttpStatus','queryModels','orderPlan','MoreThan','removeMjAccount','TURBO','ids','agree','notifySD','blend','DrawSpeed','syncMjImg','startsWith','set','Not','config','refundBalance4MJ','壁纸绘画','__decorate','DRAWING','properties','displaySort','创建图生文任务失败','label','mjProxy','collectPage','url','queryMjIncantationByClassify','setImageFavorite','imageSeed','MID_JOURNEY','page','actionTask','MjInspireClassifyEntity','EFavorite','assign','parse','find','./mjInspireClassify.entity','handleAddDrawTask','cover','\x20--sw\x20','count','timeoutMinutes','addMjIncantationClassify','indexOf','../dict/dict.service','初始化灵感广场分类成功','查询推荐关键词失败','MidJourneyDrawEnum','syncTask','error:\x20','development','relax','affected','visitNum','weight','isSuper','nickname','checkUserStatus','aiTaskDetail','totalTime','del','description','workflowModelDetail','workflowForm','effectMainBodyName','validateBalance4MJ','addMjInspireClassify','cancel','HttpException','getByRelateId','modelsService','effect_category','isChinese','syncModelsByTag','UserService','values','forEach','../../common/utils','convertMode4Transfer','__param','@nestjs/common','useCount','syncModels','midjourneyEntity','saveSuggestWords','drawSquarePage','任务不存在！','fullPrompt','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(m.id)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_favorite\x20uf\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20models\x20m\x20ON\x20m.id\x20=\x20uf.relateId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.userId\x20=\x20\x27','名称不能重复','delLog','../badwords/badwords.service','effectCategory','\x20--cw\x20','then','EBotType','AddDrawQueueDto','BadwordsService','Modal已处理，无需更新','denoisingStrength','DictService','./dto/DrawTaskPage.dto','getUserListByIds','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(m.id)\x20AS\x20count\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20models\x20m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20(\x20SELECT\x20workflowId,\x20count(workflowId)\x20AS\x20used,\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20FROM\x20midjourney\x20WHERE\x20workflowId\x20IS\x20NOT\x20NULL\x20AND\x20userId\x20=\x20','workflowTaskDetail','files','Imagine','removeSuggestWords','./mjParam.entity','agreeNum','604752SELpHP','applicationFields','../../common/constants/redisKey.constant','enable','coverImageUrl','emoji','商拍摄影','mjNotSaveImg','TEXT_TO_IMAGE','workflowTaskSubmit','BLEND','Mj\x20Modal\x20通知','changeVersion','mask','getAgreeByRelateId','update','distributeAccount','dictService','recommend','hideString','动漫漫画','查询咒语失败','type','InjectRepository','Imagine\x20all','Repository','Blend','finishTime','size','authorization','globalConfigService','getReqSaasId','base64','modalTask','deductBalance4MJ','redisCacheService','绘画制作','querySuggestWords','rec','队列已满，请稍后尝试','updatedAt','EModelType','aiDraw','relaxedUsage','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20uf.relateType\x20=\x20\x27','workflowFavorite','phone','syncMjTask','rows','get','7125398gLXayu','要使用MJ绘画功能，至少需要配置一个MJ账号,并且启用该账号','insightFace','MjIncantationEntity','listByCondition','pid','images','DESCRIBE','userService','MODAL','--iw','queryMjIncantationClassify','824458hIgKNe','提交动作失败','initHasAccount','dictName','SD任务通知内容：','NIJI_JOURNEY','triggerWords','versionId','favoritePage','delPrompt','modelType','incantationCn','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20','name','创建图混图任务失败','userId','mjTaskUpdateJob:\x20','findBy','keys','map','mergeCollectCountData','swap','durationSpent','isManage','./midjourney.entity','vipExpire','getMjIncantation','modelName','6xzlecs','syncMjpAccountAutomatic','modelSave','delete','transaction','../../common/constants/collectType.constant','isDefined','workflowDicts','CzStateMap','图混图任务至少需要两张图片','workflowId','fetch','metadata','SUCCESS','MjpAccountService','list4dictTypes','MidjourneyService','推荐关键词已存在，不可重复添加','dictType','now','progress','add','触站工作流任务通知内容：','queryAllPrompt','squareType','IMAGE_ACTION','lock','精选分享','notifyWF','DRAWED','https://cdn.discordapp.com','object','MjpStateIndexMap','subscribePlan','application_fields','concat','syncSdTask','turbo_vip_free','艺术设计','use','workflowModelUpdate','../user/user.service','Like','code','modifyMjAccount','onModuleInit','modal','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.cover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.modelName\x20AS\x20name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.model\x20AS\x20workflowId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.key\x20AS\x20versionId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.deduct,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.vip_free_num\x20AS\x20vipFreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.displaySort,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.description,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.useCount,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.remark\x20AS\x20tutorial\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_favorite\x20uf\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20models\x20m\x20ON\x20m.id\x20=\x20uf.relateId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.userId\x20=\x20\x27','ENV','drawTaskList','7068260auWBID','当前图片不存在！','typeorm','buffer','32337ZHpZYZ','message','https://img2.huashi6.com/','fastRemainTime','../../common/constants/user.constant','fanyiService','relId','mjIncantationClassifyEntity','110WJWycg','status','DRAW','删除失败！','MJ_TASK_UPDATE'];_0x16a9=function(){return _0x50fcd8;};return _0x16a9();}const common_1=require(_0x18ccf3(0x10e)),typeorm_1=require('@nestjs/typeorm'),midjourney_entity_1=require(_0x18ccf3(0x182)),typeorm_2=require(_0x18ccf3(0x1ba)),globalConfig_service_1=require(_0x18ccf3(0x2a1)),midjourney_constant_1=require(_0x18ccf3(0x1ed)),file_service_1=require(_0x18ccf3(0x207)),badwords_service_1=require(_0x18ccf3(0x119)),utils_1=require(_0x18ccf3(0x10b)),mjPrompts_entity_1=require('./mjPrompts.entity'),mjParam_entity_1=require(_0x18ccf3(0x12a)),mjIncantationClassify_entity_1=require('./mjIncantationClassify.entity'),mjInspireClassify_entity_1=require(_0x18ccf3(0xe2)),mjIncantation_entity_1=require('./mjIncantation.entity'),fanyi_service_1=require('../fanyi/fanyi.service'),mjSuggestWord_entity_1=require(_0x18ccf3(0x248)),user_service_1=require(_0x18ccf3(0x1af)),redisCache_service_1=require(_0x18ccf3(0x222)),mjpAccount_service_1=require('../api/mjpAccount.service'),mjpTask_service_1=require(_0x18ccf3(0x20a)),addDrawQueue_dto_1=require('./dto/addDrawQueue.dto'),store_1=require('../../common/store'),redisKey_constant_1=require(_0x18ccf3(0x12e)),aiLog_service_1=require('../aiLog/aiLog.service'),model_constant_1=require(_0x18ccf3(0x241)),nestjs_cls_1=require('nestjs-cls'),czTask_service_1=require(_0x18ccf3(0x25a)),models_service_1=require(_0x18ccf3(0x231)),DrawTaskPage_dto_1=require(_0x18ccf3(0x123)),user_constant_1=require(_0x18ccf3(0x1c0)),dict_service_1=require(_0x18ccf3(0xea)),mjModel_entity_1=require(_0x18ccf3(0x1fa)),collectType_constant_1=require(_0x18ccf3(0x18b));let MidjourneyService=class MidjourneyService{constructor(_0x5cd0e9,_0x162ba7,_0x5c2eb6,_0x6c31f,_0x47484e,_0x3c5a4c,_0x483494,_0x95bb56,_0x2ce7b4,_0x133e82,_0x11692b,_0x5a1865,_0x2a8d33,_0xb61aeb,_0x2c76f7,_0x4b2f5f,_0x59ce42,_0x1f3643,_0xa03eee,_0x3e2308,_0x49e932,_0x419a3e){const _0x26b084=_0x18ccf3;this[_0x26b084(0x253)]=_0x5cd0e9,this[_0x26b084(0x2b0)]=_0x162ba7,this[_0x26b084(0x2b4)]=_0x5c2eb6,this['midjourneyEntity']=_0x6c31f,this[_0x26b084(0x21a)]=_0x47484e,this[_0x26b084(0x2b3)]=_0x3c5a4c,this['mjInspireClassifyEntity']=_0x483494,this['mjIncantationClassifyEntity']=_0x95bb56,this['clsService']=_0x2ce7b4,this[_0x26b084(0x13d)]=_0x133e82,this[_0x26b084(0x166)]=_0x11692b,this[_0x26b084(0x216)]=_0x5a1865,this[_0x26b084(0x1c1)]=_0x2a8d33,this['aiLogService']=_0xb61aeb,this[_0x26b084(0x104)]=_0x2c76f7,this['czTaskService']=_0x4b2f5f,this[_0x26b084(0x1ef)]=_0x59ce42,this['badwordsService']=_0x1f3643,this[_0x26b084(0x14f)]=_0xa03eee,this['mjpAccountService']=_0x3e2308,this[_0x26b084(0x14a)]=_0x49e932,this[_0x26b084(0x267)]=_0x419a3e;}async[_0x18ccf3(0x1b3)](){const _0x2c896e=_0x18ccf3;await this[_0x2c896e(0x2bc)](),await this[_0x2c896e(0x16c)]();}async['initHasAccount'](){const _0x3c4d9b=_0x18ccf3,_0x23ab87=await this['mjParamEntity'][_0x3c4d9b(0xe6)]({'where':{'enable':0x1},'order':{'weight':_0x3c4d9b(0x232)}});_0x23ab87===0x0&&common_1[_0x3c4d9b(0x28b)][_0x3c4d9b(0x251)](_0x3c4d9b(0x15f));}async[_0x18ccf3(0x2bc)](){const _0x10d35f=_0x18ccf3,_0x3c0564=await this[_0x10d35f(0x1f4)][_0x10d35f(0xe6)]();if(_0x3c0564===0x0){const _0x2602e9=[{'name':_0x10d35f(0x150),'value':0x1},{'name':_0x10d35f(0x249),'value':0x2},{'name':'头像制作','value':0x3},{'name':_0x10d35f(0x200),'value':0x4},{'name':_0x10d35f(0x140),'value':0x5},{'name':_0x10d35f(0x2d0),'value':0x6},{'name':_0x10d35f(0x1ac),'value':0x7},{'name':_0x10d35f(0x132),'value':0x8},{'name':'形象设计','value':0x9},{'name':_0x10d35f(0x1a1),'value':0xa}]['map'](_0x5b0479=>{const _0x50d34f=_0x10d35f;return{'name':_0x5b0479['name'],'value':_0x5b0479[_0x50d34f(0x244)]+'','inner':0x1};});await this[_0x10d35f(0x1f4)][_0x10d35f(0x266)](_0x2602e9)[_0x10d35f(0x234)](()=>{const _0x380479=_0x10d35f;common_1[_0x380479(0x28b)]['error']('初始化灵感广场分类失败');}),common_1['Logger']['log'](_0x10d35f(0xeb));}common_1[_0x10d35f(0x28b)][_0x10d35f(0x2a5)](_0x10d35f(0x1d4));}async['addMjAccount'](_0x7afbc1){const _0x5a4baf=_0x18ccf3;try{const {guildId:_0x3e78d5,account:_0x3c8474,authorization:_0x49b9a1,mode:_0xd62660,timeout:_0x45eff4,channelId:_0x2d8834,remark:_0x423b57,mjBotChannelId:_0x2b18b1,nijiBotChannelId:_0x44c55d}=_0x7afbc1;var _0x245d0a=await this[_0x5a4baf(0x294)]['create']({'data':{'channelId':_0x2d8834,'coreSize':0x3,'guildId':_0x3e78d5,'mjBotChannelId':_0x2b18b1||'','nijiBotChannelId':_0x44c55d||'','queueSize':0xa,'remark':_0x423b57,'remixAutoSubmit':![],'timeoutMinutes':_0x45eff4,'userAgent':_0x5a4baf(0x228),'userToken':_0x49b9a1}});if(_0x245d0a[_0x5a4baf(0x1b1)]!==0x1)throw new Error(_0x245d0a[_0x5a4baf(0xfb)]);const _0x1c6fc8=await this[_0x5a4baf(0x2b0)][_0x5a4baf(0x266)]({'account':_0x3c8474,'authorization':_0x49b9a1,'mode':_0xd62660,'timeout':_0x45eff4,'channelId':_0x2d8834,'guildId':_0x3e78d5,'remark':_0x423b57,'mjpId':_0x245d0a[_0x5a4baf(0x2b1)],'mjBotChannelId':_0x2b18b1||'','nijiBotChannelId':_0x44c55d||''});return await this[_0x5a4baf(0x1f7)](_0x245d0a['result']),!!_0x1c6fc8;}catch(_0x2cd8f2){common_1[_0x5a4baf(0x28b)]['error'](_0x2cd8f2);throw new common_1[(_0x5a4baf(0x102))](_0x2cd8f2[_0x5a4baf(0x1bd)],common_1[_0x5a4baf(0x2bf)][_0x5a4baf(0x1e4)]);}}async[_0x18ccf3(0x1b2)](_0x93493c){const _0x5a0355=_0x18ccf3,{id:_0x219b37,account:_0x4bd4d2,authorization:_0x193d90,mode:_0x299858,guildId:_0x525b06,remark:_0x25b1e8,channelId:_0x38043a,timeout:_0x3d0c48,enable:_0x576b31,mjBotChannelId:_0x346d11,nijiBotChannelId:_0xd06370}=_0x93493c;try{const _0x56d3bd=await this[_0x5a0355(0x2b0)][_0x5a0355(0x240)]({'id':Number(_0x219b37)});var _0x17c171=await this[_0x5a0355(0x294)]['updateReconnect']({'data':{'channelId':_0x38043a,'coreSize':0x3,'guildId':_0x525b06,'mjBotChannelId':_0x346d11||'','nijiBotChannelId':_0xd06370||'','queueSize':0xa,'remark':_0x25b1e8,'remixAutoSubmit':![],'timeoutMinutes':_0x3d0c48,'userAgent':_0x5a0355(0x228),'userToken':_0x193d90,'enable':Boolean(_0x576b31)}},_0x56d3bd[_0x5a0355(0x2a0)]);if(_0x17c171['code']!==0x1)throw new Error(_0x17c171[_0x5a0355(0xfb)]);return await this[_0x5a0355(0x2b0)][_0x5a0355(0x13b)](_0x219b37,{'account':_0x4bd4d2,'authorization':_0x193d90,'mode':_0x299858,'guildId':_0x525b06,'remark':_0x25b1e8,'channelId':_0x38043a,'timeout':_0x3d0c48,'mjBotChannelId':_0x346d11||'','nijiBotChannelId':_0xd06370||''});}catch(_0x3d5efd){common_1[_0x5a0355(0x28b)]['error'](_0x3d5efd);throw new common_1[(_0x5a0355(0x102))](_0x3d5efd[_0x5a0355(0x1bd)],common_1[_0x5a0355(0x2bf)][_0x5a0355(0x1e4)]);}}async[_0x18ccf3(0x2b8)](_0x4347da,_0x464b59){const _0x11ead8=_0x18ccf3;_0x4347da['mjVersion']=_0x464b59['version'];if(_0x464b59[_0x11ead8(0x2a7)]==='FAST')_0x4347da['mode']=midjourney_constant_1['DrawSpeed'][_0x11ead8(0x242)];else{if(_0x464b59[_0x11ead8(0x2a7)]===_0x11ead8(0x201))_0x4347da[_0x11ead8(0x2a7)]=midjourney_constant_1[_0x11ead8(0x2c9)][_0x11ead8(0xf1)];else _0x464b59['mode']===_0x11ead8(0x2c4)&&(_0x4347da[_0x11ead8(0x2a7)]=midjourney_constant_1[_0x11ead8(0x2c9)][_0x11ead8(0x2b7)]);}_0x4347da[_0x11ead8(0x1bf)]=_0x464b59['fastTimeRemaining'],_0x4347da[_0x11ead8(0xf9)]=_0x464b59['fastTimeRemaining'],_0x4347da[_0x11ead8(0x1e8)]=_0x464b59['lifetimeUsage'],_0x4347da[_0x11ead8(0x157)]=_0x464b59['relaxedUsage'],_0x4347da[_0x11ead8(0x28f)]=Number(_0x464b59[_0x11ead8(0x28f)]);if(_0x464b59['subscribePlan']==='BASIC')_0x4347da[_0x11ead8(0x2c1)]=0x1;else{if(_0x464b59['subscribePlan']===_0x11ead8(0x24e))_0x4347da[_0x11ead8(0x2c1)]=0x2;else{if(_0x464b59[_0x11ead8(0x1a7)]===_0x11ead8(0x20e))_0x4347da[_0x11ead8(0x2c1)]=0x3;else _0x464b59[_0x11ead8(0x1a7)]===_0x11ead8(0x1f2)&&(_0x4347da['orderPlan']=0x4);}}_0x4347da[_0x11ead8(0x215)]=_0x464b59[_0x11ead8(0x215)],_0x4347da['timeout']=_0x464b59[_0x11ead8(0xe7)],_0x4347da['setting']=JSON[_0x11ead8(0x225)](_0x464b59[_0x11ead8(0x208)]),_0x4347da['info']=JSON['stringify'](_0x464b59['versionSelector']),await this[_0x11ead8(0x2b0)]['save'](_0x4347da);}async['syncMjpAccount'](_0x2ef553){const _0x44a67b=_0x18ccf3;try{if(store_1[_0x44a67b(0x27b)][_0x44a67b(0x25d)]!=='mjProxy')return;const _0x52a39d=await this[_0x44a67b(0x294)][_0x44a67b(0x191)]({},_0x2ef553);if(!_0x52a39d)return;const _0x158078=await this[_0x44a67b(0x2b0)][_0x44a67b(0x1da)]({'where':{'mjpId':_0x2ef553}});await this[_0x44a67b(0x2b8)](_0x158078,_0x52a39d);}catch(_0x4abdc8){common_1[_0x44a67b(0x28b)][_0x44a67b(0x251)]('自动同步账号信息失败：',_0x4abdc8);}}async[_0x18ccf3(0x187)](){const _0x4f8623=_0x18ccf3,_0x528f8c=await this[_0x4f8623(0x2b0)][_0x4f8623(0xe1)]();if(!_0x528f8c[_0x4f8623(0x24a)])return;for(let _0x4df95e=0x0;_0x4df95e<_0x528f8c[_0x4f8623(0x24a)];_0x4df95e++){this[_0x4f8623(0x1f7)](_0x528f8c[_0x4df95e][_0x4f8623(0x2a0)]);}}async[_0x18ccf3(0x26b)]({id:_0x12bce1}){const _0x27dc63=_0x18ccf3;try{const _0xa83697=await this['mjParamEntity'][_0x27dc63(0x240)]({'id':Number(_0x12bce1)}),_0x4b2cc2=await this['mjpAccountService'][_0x27dc63(0x268)]({},_0xa83697[_0x27dc63(0x2a0)]);if(_0x4b2cc2[_0x27dc63(0x1b1)]!==0x1)throw new Error(_0x4b2cc2[_0x27dc63(0xfb)]);await this[_0x27dc63(0x2b8)](_0xa83697,_0x4b2cc2[_0x27dc63(0x2b1)]);}catch(_0x5f3f4f){throw new common_1['HttpException'](_0x5f3f4f['message'],common_1[_0x27dc63(0x2bf)][_0x27dc63(0x1e4)]);}}async[_0x18ccf3(0x138)](_0x16fc6a){const _0x63da9a=_0x18ccf3;try{const _0x3b09c2=await this[_0x63da9a(0x2b0)][_0x63da9a(0x240)]({'id':Number(_0x16fc6a['id'])}),_0xf4bb52=await this['mjpAccountService']['changeVersion']({'data':_0x16fc6a},_0x3b09c2[_0x63da9a(0x2a0)]);if(_0xf4bb52[_0x63da9a(0x1b1)]!==0x1)throw new Error(_0xf4bb52['description']);return _0x3b09c2['mjVersion']=_0x16fc6a[_0x63da9a(0x1f6)],await this[_0x63da9a(0x2b0)][_0x63da9a(0x266)](_0x3b09c2),!![];}catch(_0x5bbbf9){throw new common_1[(_0x63da9a(0x102))](_0x5bbbf9[_0x63da9a(0x1bd)],common_1[_0x63da9a(0x2bf)][_0x63da9a(0x1e4)]);}}async[_0x18ccf3(0x239)](_0x11b0cb){const _0x2ffd84=_0x18ccf3;try{const _0x4d9392=await this[_0x2ffd84(0x2b0)]['findOneBy']({'id':Number(_0x11b0cb['id'])}),_0x306ee2=await this[_0x2ffd84(0x294)][_0x2ffd84(0x239)]({'data':_0x11b0cb},_0x4d9392[_0x2ffd84(0x2a0)]);if(_0x306ee2[_0x2ffd84(0x1b1)]!==0x1)throw new Error(_0x306ee2[_0x2ffd84(0xfb)]);return!![];}catch(_0x3a58c0){throw new common_1['HttpException'](_0x3a58c0[_0x2ffd84(0x1bd)],common_1[_0x2ffd84(0x2bf)][_0x2ffd84(0x1e4)]);}}async[_0x18ccf3(0x2c3)](_0x198ee2){const _0x7de52=_0x18ccf3,{id:_0x1902f8}=_0x198ee2;try{const _0x2055e5=await this['mjParamEntity'][_0x7de52(0x1da)]({'where':{'id':Number(_0x1902f8)}});if(!_0x2055e5)throw new Error(_0x7de52(0x2a8));common_1['Logger']['error']('mjpId:\x20',_0x2055e5[_0x7de52(0x2a0)]);const _0x4c2b7c=await this['mjpAccountService']['delete']({},_0x2055e5[_0x7de52(0x2a0)]);if(_0x4c2b7c['code']!==0x1)throw new Error(_0x4c2b7c[_0x7de52(0xfb)]);const _0x25c8ed=await this['mjParamEntity']['delete']({'id':_0x1902f8});return _0x25c8ed[_0x7de52(0xf2)];}catch(_0x1c5a42){throw new common_1[(_0x7de52(0x102))](_0x1c5a42[_0x7de52(0x1bd)],common_1[_0x7de52(0x2bf)][_0x7de52(0x1e4)]);}}async['setMjAccountEnable'](_0x2ebc56){const _0x431f2b=_0x18ccf3,{id:_0x3119cc,enable:_0x40aaae}=_0x2ebc56;return await this[_0x431f2b(0x2b0)][_0x431f2b(0x13b)](_0x3119cc,{'enable':_0x40aaae})[_0x431f2b(0x11c)](_0x56186d=>_0x56186d['affected']>0x0);}async[_0x18ccf3(0x1f0)](_0x24d180,_0x11e1e3){const _0x2d55a5=_0x18ccf3,_0x1d64a5=(0x0,utils_1[_0x2d55a5(0xf5)])(this[_0x2d55a5(0x2bb)]),{id:_0x12d218}=_0x24d180;let _0x1bf80b=null;try{const _0x4e29d2=await this[_0x2d55a5(0x2b0)]['findOne']({'where':{'id':_0x12d218}});return _0x1d64a5&&(_0x1bf80b=await this[_0x2d55a5(0x294)][_0x2d55a5(0x191)]({},_0x4e29d2[_0x2d55a5(0x2a0)])),{..._0x4e29d2,'mjpAccountInfo':_0x1bf80b,'authorization':_0x1d64a5?_0x4e29d2[_0x2d55a5(0x149)]:(0x0,utils_1[_0x2d55a5(0x13f)])(_0x4e29d2[_0x2d55a5(0x149)]),'guildId':_0x1d64a5?_0x4e29d2['guildId']:(0x0,utils_1['hideString'])(_0x4e29d2[_0x2d55a5(0x230)]),'channelId':_0x1d64a5?_0x4e29d2[_0x2d55a5(0x2bd)]:(0x0,utils_1['hideString'])(_0x4e29d2[_0x2d55a5(0x2bd)])};}catch(_0x377a13){throw new common_1['HttpException'](_0x377a13,common_1[_0x2d55a5(0x2bf)][_0x2d55a5(0x1e4)]);}}async['queryMjAccountList'](_0x186ee3,_0x523daf){const _0x2d3ba4=_0x18ccf3,{page:page=0x1,size:size=0x14,account:_0x610d5d,channelId:_0x5a91db,enable:_0xed2846}=_0x186ee3;if(!page||!size)throw new common_1['HttpException']('分页参数错误',common_1['HttpStatus']['BAD_REQUEST']);const _0x4be9d4={};_0x610d5d&&Object[_0x2d3ba4(0xdf)](_0x4be9d4,{'account':(0x0,typeorm_2[_0x2d3ba4(0x1b0)])('%'+_0x610d5d+'%')}),_0x5a91db&&Object[_0x2d3ba4(0xdf)](_0x4be9d4,{'channelId':(0x0,typeorm_2[_0x2d3ba4(0x1b0)])('%'+_0x5a91db+'%')}),_0xed2846>0x0&&Object['assign'](_0x4be9d4,{'enable':_0xed2846});const [_0x1bd75b,_0x16e47c]=await this[_0x2d3ba4(0x2b0)][_0x2d3ba4(0x1ea)]({'skip':(page-0x1)*size,'where':_0x4be9d4,'take':size,'order':{'createdAt':'DESC'},'cache':!![],'select':['id',_0x2d3ba4(0x230),'channelId',_0x2d3ba4(0x149),'account',_0x2d3ba4(0xf4),_0x2d3ba4(0x12f),'fastRemainTime',_0x2d3ba4(0x2c1),_0x2d3ba4(0x215),_0x2d3ba4(0x22f),'mode']});return(0x0,utils_1[_0x2d3ba4(0xf5)])(this[_0x2d3ba4(0x2bb)])?{'rows':_0x1bd75b||[],'count':_0x16e47c||0x0}:{'rows':_0x1bd75b[_0x2d3ba4(0x17d)](_0x2979f9=>({..._0x2979f9,'authorization':(0x0,utils_1[_0x2d3ba4(0x13f)])(_0x2979f9['authorization']),'guildId':(0x0,utils_1[_0x2d3ba4(0x13f)])(_0x2979f9[_0x2d3ba4(0x230)]),'channelId':(0x0,utils_1[_0x2d3ba4(0x13f)])(_0x2979f9[_0x2d3ba4(0x2bd)])}))||[],'count':_0x16e47c||0x0};}async[_0x18ccf3(0x1b7)](_0x3c846f,_0x5ec6ff,_0xd62b11){const _0x20e5a0=_0x18ccf3;try{const _0x202c2c=(0x0,utils_1[_0x20e5a0(0x14b)])(this[_0x20e5a0(0x2bb)]),{page:page=0x1,size:size=0x14,botType:_0x44b3cd,action:_0x413436,keyword:_0x3bfb85,userId:_0x21557c,rec:_0x3ea56a,status:_0x2958ac,squareType:_0x47f759,workflowId:_0x2d43af,saasId:_0x234c0f}=_0x3c846f,_0x23c27b={};_0x44b3cd&&_0x44b3cd[_0x20e5a0(0x24a)]&&(_0x23c27b[_0x20e5a0(0x211)]=(0x0,typeorm_2['In'])(_0x44b3cd));_0x413436&&(_0x23c27b[_0x20e5a0(0x239)]=_0x413436);_0x3bfb85&&(_0x23c27b[_0x20e5a0(0x269)]=(0x0,typeorm_2[_0x20e5a0(0x1b0)])('%'+_0x3bfb85+'%'));_0xd62b11&&_0x21557c&&(_0x23c27b[_0x20e5a0(0x179)]=_0x21557c);_0x5ec6ff&&_0x5ec6ff[_0x20e5a0(0x275)]?.['id']&&(_0x23c27b[_0x20e5a0(0x179)]=_0x5ec6ff[_0x20e5a0(0x275)]['id']);_0x47f759&&(_0x23c27b[_0x20e5a0(0x19e)]=_0x47f759);_0x2d43af&&(_0x23c27b[_0x20e5a0(0x190)]=_0x2d43af);_0x3ea56a!==null&&_0x3ea56a!==undefined&&(_0x23c27b[_0x20e5a0(0x152)]=_0x3ea56a);_0x3ea56a!==null&&_0x2958ac!==undefined&&(_0x23c27b['status']=_0x2958ac);(0x0,utils_1['isPlatform'])(this[_0x20e5a0(0x2bb)])?(0x0,utils_1['isDefined'])(_0x234c0f)&&(_0x23c27b[_0x20e5a0(0x21b)]=_0x234c0f):_0x23c27b[_0x20e5a0(0x21b)]=_0x202c2c;const [_0x5c7a5e,_0x4c5cc0]=await this[_0x20e5a0(0x111)]['findAndCount']({'where':_0x23c27b,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':_0x20e5a0(0x232)}}),_0x125a54=new Map(),_0x2ac992=_0x5c7a5e[_0x20e5a0(0x17d)](_0x48af2b=>_0x48af2b['workflowId'])[_0x20e5a0(0x227)](_0x2c7009=>Boolean(_0x2c7009));if(_0x2ac992[_0x20e5a0(0x24a)]){const _0x39ca82=await this[_0x20e5a0(0x104)][_0x20e5a0(0x245)](_0x2ac992);_0x39ca82['forEach'](_0x50cc05=>_0x125a54[_0x20e5a0(0x2cc)](_0x50cc05['id'],_0x50cc05));}const _0x3346af=_0x5c7a5e[_0x20e5a0(0x17d)](_0x3cc2e8=>{const _0x39e5bd=_0x20e5a0;return{..._0x3cc2e8,'workflowName':_0x125a54[_0x39e5bd(0x15d)](_0x3cc2e8['workflowId'])?.[_0x39e5bd(0x185)]||''};});if(_0xd62b11){const _0x255e4e=_0x3346af[_0x20e5a0(0x17d)](_0x1cf504=>_0x1cf504[_0x20e5a0(0x179)]),_0x2c41e0=await this[_0x20e5a0(0x166)]['getUserListByIds'](_0x255e4e);_0x3346af[_0x20e5a0(0x10a)](_0x9d6b6c=>{const _0x5dd423=_0x20e5a0,_0x3b0e14=_0x2c41e0[_0x5dd423(0xe1)](_0x24461d=>_0x24461d['id']===_0x9d6b6c['userId']);!(0x0,utils_1[_0x5dd423(0xf5)])(this[_0x5dd423(0x2bb)])&&(_0x3b0e14[_0x5dd423(0x22c)]=(0x0,utils_1[_0x5dd423(0x13f)])(_0x3b0e14['email']),_0x3b0e14[_0x5dd423(0x15a)]=(0x0,utils_1[_0x5dd423(0x13f)])(_0x3b0e14[_0x5dd423(0x15a)])),_0x9d6b6c[_0x5dd423(0x1cf)]=_0x3b0e14;});}else{const _0x37b106=_0x3346af[_0x20e5a0(0x17d)](_0x42a625=>_0x42a625['userId']),_0x5c06b3=await this[_0x20e5a0(0x166)]['getUserListByIds'](_0x37b106);_0x3346af['forEach'](_0x1f76cd=>{const _0x56576d=_0x20e5a0,_0x2641a5=_0x5c06b3[_0x56576d(0xe1)](_0xf8d0a4=>_0xf8d0a4['id']===_0x1f76cd[_0x56576d(0x179)]);if(_0x2641a5){const _0x1dd1f1={'nickname':_0x2641a5?.[_0x56576d(0xf6)],'avatar':_0x2641a5?.[_0x56576d(0x1fc)]};_0x1f76cd[_0x56576d(0x1cf)]=_0x1dd1f1;}});}const _0x179456=_0x5ec6ff?this['userService'][_0x20e5a0(0x1ee)](_0x5ec6ff):null,_0xde1c3e=_0x179456?.['id'],_0x4b6077=_0x5c7a5e[_0x20e5a0(0x17d)](_0x1cad3d=>_0x1cad3d['id']),_0x342adb=await this['aiLogService'][_0x20e5a0(0x2af)](_0xde1c3e,_0x4b6077,model_constant_1[_0x20e5a0(0x155)]['DRAW']),_0x1519df=new Map(),_0xf23510=_0x5c7a5e[_0x20e5a0(0x17d)](_0x4a9b86=>_0x4a9b86[_0x20e5a0(0x179)])[_0x20e5a0(0x227)](_0x356de0=>_0x356de0);if(_0xf23510['length']){const _0x275d3b=(await this[_0x20e5a0(0x166)][_0x20e5a0(0x124)](_0xf23510))[_0x20e5a0(0x17d)](_0x29e7e5=>{const _0x11d00f=_0x20e5a0;return{'id':_0x29e7e5['id'],'nickname':_0x29e7e5[_0x11d00f(0xf6)],'avatar':_0x29e7e5['avatar']};});_0x275d3b[_0x20e5a0(0x10a)](_0x484752=>_0x1519df[_0x20e5a0(0x2cc)](_0x484752['id'],_0x484752));}const _0xbf8e06=await this[_0x20e5a0(0x27a)][_0x20e5a0(0x233)](_0x4b6077,model_constant_1[_0x20e5a0(0x155)][_0x20e5a0(0x1c6)]);_0x3346af[_0x20e5a0(0x10a)](_0x20761d=>{const _0x4e286a=_0x20e5a0,_0x404b65=_0xbf8e06['get'](_0x20761d['id']);_0x20761d[_0x4e286a(0x2c6)]=_0x342adb[_0x4e286a(0x15d)](_0x20761d['id'])||null,_0x20761d['userInfo']=_0x1519df[_0x4e286a(0x15d)](_0x20761d[_0x4e286a(0x179)]),_0x20761d[_0x4e286a(0x12b)]=_0x404b65?.[_0x4e286a(0x12b)]||0x0;});let _0xb009a5=await this[_0x20e5a0(0x166)][_0x20e5a0(0x2b6)](_0x5c7a5e,_0xde1c3e,collectType_constant_1[_0x20e5a0(0x2ac)]['MJ']);return _0xb009a5=await this[_0x20e5a0(0x166)][_0x20e5a0(0x17e)](_0x5c7a5e,collectType_constant_1[_0x20e5a0(0x2ac)]['MJ']),{'rows':_0xb009a5,'count':_0x4c5cc0};}catch(_0x11b9cf){throw new common_1[(_0x20e5a0(0x102))](_0x11b9cf[_0x20e5a0(0x1bd)],common_1[_0x20e5a0(0x2bf)][_0x20e5a0(0x1e4)]);}}async['concurrentLimit'](_0x54d716){const _0x1f3ea1=_0x18ccf3,_0xce9736=await this[_0x1f3ea1(0x14a)][_0x1f3ea1(0x256)](['mjLimitCount']),_0x249d37=Number(_0xce9736||0x0);if(_0x249d37===0x0)return!![];const _0x272c2f=await this[_0x1f3ea1(0x111)][_0x1f3ea1(0xe6)]({'where':{'userId':_0x54d716,'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6])}});if(_0x272c2f<_0x249d37)return!![];else throw new Error('任务已达最大并发数，请等待其他任务完成后再提交新任务！');}async[_0x18ccf3(0x13c)](_0x24255a){const _0x1e2005=_0x18ccf3;if(store_1['MjConfig']['mjModel']!==_0x1e2005(0xd4))return null;return null;}async['checkIsActionDone'](_0x3b9b8d,_0x220cb9){const _0x19894d=_0x18ccf3,_0x4a91d7=await this[_0x19894d(0x111)][_0x19894d(0xe6)]({'where':{'originTaskId':String(_0x3b9b8d),'customId':_0x220cb9}});if(_0x4a91d7>0x0)throw new common_1[(_0x19894d(0x102))]('当前图片已经执行过相同指令！',common_1[_0x19894d(0x2bf)]['BAD_REQUEST']);return![];}async[_0x18ccf3(0x289)](_0x465aca){const _0x5513d2=_0x18ccf3,_0x2ea09d=new addDrawQueue_dto_1[(_0x5513d2(0x11e))](_0x465aca);await this[_0x5513d2(0x2ba)][_0x5513d2(0x263)](_0x2ea09d[_0x5513d2(0x115)],_0x2ea09d[_0x5513d2(0x179)]);const _0x184ed8=(0x0,utils_1['getReqSaasId'])(this[_0x5513d2(0x2bb)]);_0x2ea09d['saasId']=_0x184ed8;const _0x15c860=await this[_0x5513d2(0x111)][_0x5513d2(0x266)](_0x2ea09d);return _0x15c860;}[_0x18ccf3(0x205)](_0x82741a){const _0x44c84b=_0x18ccf3,_0x14badf=_0x82741a[_0x44c84b(0x1fd)](),_0x6d7612=_0x14badf[_0x44c84b(0x2ad)]('\x20'),_0x1f10e4={};for(let _0x380a3e=0x0;_0x380a3e<_0x6d7612['length'];_0x380a3e++){_0x6d7612[_0x380a3e][_0x44c84b(0x2cb)]('--')&&(_0x380a3e+0x1<_0x6d7612[_0x44c84b(0x24a)]&&!_0x6d7612[_0x380a3e+0x1][_0x44c84b(0x2cb)]('--')?(_0x1f10e4[_0x6d7612[_0x380a3e]]=_0x6d7612[_0x380a3e+0x1],_0x380a3e++):_0x1f10e4[_0x6d7612[_0x380a3e]]=_0x6d7612[_0x380a3e]);}return _0x1f10e4;}async[_0x18ccf3(0x2b5)](_0x3a15ce,_0x56c5e5){const _0x2a3659=_0x18ccf3;let _0x4b22e8,{botType:_0x55e28c,prompt:_0x125b51,extend:_0x2ac0ac,action:_0x3f8ec1,mode:_0x145480,translate:_0xe7aee1,base64Array:_0x3506a8,mats:mats=[],iw:_0x10bcff,roles:roles=[],cw:_0x3cd5ed,styles:styles=[],sw:_0x8bc9db}=_0x56c5e5;_0x145480=await this[_0x2a3659(0x166)][_0x2a3659(0xff)](_0x3a15ce[_0x2a3659(0x275)]['id'],_0x145480,_0x2a3659(0x128));const _0x42f521=_0x125b51,_0x2a5fb7=await this[_0x2a3659(0x13c)](_0x145480);_0x125b51&&await this['badwordsService'][_0x2a3659(0x263)](_0x125b51,_0x3a15ce[_0x2a3659(0x275)]['id']),_0x125b51=_0xe7aee1===0x1&&(0x0,utils_1['isChinese'])(_0x125b51)?await this[_0x2a3659(0x1c1)][_0x2a3659(0x29b)](_0x125b51):_0x125b51;let _0x18ea70=_0x125b51;mats[_0x2a3659(0x24a)]&&(_0x18ea70=mats[_0x2a3659(0x29f)]('\x20')+'\x20'+_0x18ea70);_0x10bcff&&_0x125b51[_0x2a3659(0xe9)](_0x2a3659(0x168))==-0x1&&(_0x18ea70=_0x18ea70+_0x2a3659(0x296)+_0x10bcff);styles[_0x2a3659(0x24a)]&&_0x125b51[_0x2a3659(0xe9)]('--sref')==-0x1&&(_0x18ea70=_0x18ea70+'\x20--sref\x20'+styles[_0x2a3659(0x29f)]('\x20'));roles[_0x2a3659(0x24a)]&&_0x125b51['indexOf'](_0x2a3659(0x286))==-0x1&&(_0x18ea70=_0x18ea70+_0x2a3659(0x26a)+roles[_0x2a3659(0x29f)]('\x20'));_0x3cd5ed&&_0x125b51[_0x2a3659(0xe9)](_0x2a3659(0x1d3))==-0x1&&(_0x18ea70=_0x18ea70+_0x2a3659(0x11b)+_0x3cd5ed);_0x8bc9db&&_0x125b51[_0x2a3659(0xe9)](_0x2a3659(0x1d1))==-0x1&&(_0x18ea70=_0x18ea70+_0x2a3659(0xe5)+_0x8bc9db);if(_0x2ac0ac){const _0x4387b4=this[_0x2a3659(0x205)](_0x2ac0ac);Object[_0x2a3659(0x17c)](_0x4387b4)[_0x2a3659(0x10a)](_0x3941fa=>{const _0x80c397=_0x2a3659;_0x125b51[_0x80c397(0xe9)](_0x3941fa)==-0x1&&(_0x3941fa!=_0x4387b4[_0x3941fa]?_0x18ea70+='\x20'+_0x3941fa+'\x20'+_0x4387b4[_0x3941fa]:_0x18ea70+='\x20'+_0x3941fa);});}const _0x2b2938=await this[_0x2a3659(0x1ef)]['imagine']({'data':{'mode':this[_0x2a3659(0x10c)](_0x145480),'prompt':_0x18ea70,'botType':_0x55e28c||_0x2a3659(0xda),'base64Array':_0x3506a8,'accountFilter':_0x2a5fb7}});if(_0x2b2938['code']===0x17)throw new Error(_0x2a3659(0x153));if(_0x2b2938[_0x2a3659(0x1b1)]===0x18)throw new Error(_0x2a3659(0x2b2));if(_0x2b2938[_0x2a3659(0x1b1)]!==0x1&&_0x2b2938[_0x2a3659(0x1b1)]!==0x16)throw new Error(_0x2b2938[_0x2a3659(0xfb)]);return _0x4b22e8=await this[_0x2a3659(0x267)]['transaction'](async()=>{const _0x177c29=_0x2a3659,_0x358607={'mode':_0x145480,'prompt':_0x125b51,'action':_0x3f8ec1,'translate':_0xe7aee1,'fullPrompt':_0x18ea70,'originPrompt':_0x42f521,'extraParam':_0x2ac0ac,'userId':_0x3a15ce['user']['id'],'mjpId':_0x2a5fb7?.[_0x177c29(0x26f)],'mjpTaskId':_0x2b2938[_0x177c29(0x2b1)],'botType':_0x55e28c||'MID_JOURNEY','requestParams':_0x56c5e5},_0x56659a=await this['addDrawQueue'](_0x358607);if(!_0x56659a)throw new Error(_0x177c29(0x25c));return await this['userService'][_0x177c29(0x14e)](_0x3a15ce[_0x177c29(0x275)]['id'],_0x145480,'Imagine',_0x56659a['id']),_0x56659a;}),_0x4b22e8;}async[_0x18ccf3(0xdc)](_0x52e0bf,_0x429eb7){const _0x10260f=_0x18ccf3;let _0x2bfe47;const {action:_0xe12066,taskId:_0x186f7c,customId:_0x577ebe,prompt:_0xd76136,mask:_0x32192b,enableRemix:_0x58c401}=_0x429eb7,_0x3326a9=await this['midjourneyEntity'][_0x10260f(0x1da)]({'where':{'id':_0x186f7c}});if(!_0x3326a9)throw new Error(_0x10260f(0x1e9));let _0x51adb2=await this[_0x10260f(0x166)][_0x10260f(0xff)](_0x52e0bf[_0x10260f(0x275)]['id'],_0x3326a9['mode'],_0x577ebe);const _0x5e749b=await this[_0x10260f(0x1ef)][_0x10260f(0x239)]({'data':{'customId':_0x577ebe,'taskId':_0x3326a9[_0x10260f(0x2a6)],'accountFilter':{'instanceId':_0x3326a9[_0x10260f(0x2a0)]},'mode':this[_0x10260f(0x10c)](_0x51adb2),'enableRemix':_0x58c401===undefined?!![]:_0x58c401}});if(_0x5e749b[_0x10260f(0x1b1)]===0x17)throw new Error(_0x10260f(0x153));else{if(_0x5e749b['code']===0x18)throw new Error('prompt包含敏感词');else{if(_0x5e749b[_0x10260f(0x1b1)]===0x15)setTimeout(()=>this[_0x10260f(0x1ca)](_0x5e749b[_0x10260f(0x2b1)]));else{if(_0x5e749b[_0x10260f(0x1b1)]!==0x1&&_0x5e749b[_0x10260f(0x1b1)]!==0x16)throw new Error(_0x5e749b[_0x10260f(0xfb)]);}}}return _0x2bfe47=await this[_0x10260f(0x267)][_0x10260f(0x18a)](async()=>{const _0x3a1610=_0x10260f,_0x223e2b={'action':_0xe12066,'customId':_0x577ebe,'userId':_0x52e0bf['user']['id'],'mjpTaskId':_0x5e749b[_0x3a1610(0x2b1)],'originTaskId':String(_0x186f7c),'mode':_0x51adb2,'mjpId':_0x3326a9[_0x3a1610(0x2a0)],'prompt':_0x3326a9['prompt'],'botType':_0x3326a9[_0x3a1610(0x211)],'extraParam':_0x3326a9['extraParam'],'fullPrompt':_0x3326a9[_0x3a1610(0x115)],'originPrompt':_0x3326a9[_0x3a1610(0x269)]},_0x4b9646=await this[_0x3a1610(0x289)](_0x223e2b);if(!_0x4b9646)throw new Error(_0x3a1610(0x16b));const _0x916185=_0x3326a9[_0x3a1610(0x208)];return _0x3326a9[_0x3a1610(0x208)][_0x3a1610(0x10a)](_0x3c5aa0=>{const _0x524a8d=_0x3a1610;_0x3c5aa0['customId']===_0x429eb7[_0x524a8d(0x218)]&&(_0x3c5aa0['operated']=!![]);}),await this[_0x3a1610(0x111)][_0x3a1610(0x266)](_0x3326a9),await this[_0x3a1610(0x166)][_0x3a1610(0x14e)](_0x52e0bf[_0x3a1610(0x275)]['id'],_0x51adb2,_0x577ebe,_0x4b9646['id']),_0x4b9646;}),_0x2bfe47;}async[_0x18ccf3(0x14d)](_0x21e53d,_0x34db3a){const _0x3f75fc=_0x18ccf3;let _0x15af5b,{action:_0x1d3d0d,taskId:_0x90488f,customId:_0x18ccd1,prompt:_0x5561d0,mask:_0x555326}=_0x34db3a;const _0x27d9ae=await this[_0x3f75fc(0x111)]['findOne']({'where':{'id':_0x90488f}});if(!_0x27d9ae)throw new Error(_0x3f75fc(0x1e9));const _0x31be80=_0x5561d0;_0x5561d0&&await this[_0x3f75fc(0x2ba)]['checkBadWords'](_0x5561d0,_0x21e53d['user']['id']),_0x5561d0=(0x0,utils_1[_0x3f75fc(0x106)])(_0x5561d0)?await this[_0x3f75fc(0x1c1)]['convertToEnglish'](_0x5561d0):_0x5561d0;const _0x3fd992={'taskId':_0x27d9ae[_0x3f75fc(0x2a6)]};_0x5561d0&&(_0x3fd992['prompt']=_0x5561d0);_0x555326&&(_0x3fd992[_0x3f75fc(0x20f)]=_0x555326);const _0x4abca5=await this[_0x3f75fc(0x1ef)][_0x3f75fc(0x1b4)]({'data':_0x3fd992});if(_0x4abca5[_0x3f75fc(0x1b1)]!==0x1&&_0x4abca5[_0x3f75fc(0x1b1)]!==0x16)throw new Error(_0x4abca5[_0x3f75fc(0xfb)]);_0x15af5b=await this[_0x3f75fc(0x111)][_0x3f75fc(0x266)]({'id':_0x90488f,'prompt':_0x5561d0,'status':0x1,'originPrompt':_0x31be80,'messageFlags':0x1,'requestParams':_0x34db3a});for(let _0x3dd513 in _0x15af5b){_0x15af5b[_0x3dd513]&&(_0x27d9ae[_0x3dd513]=_0x15af5b[_0x3dd513]);}return _0x27d9ae;}async[_0x18ccf3(0xe3)](_0x1a8ef5,_0xa38711){const _0x53a978=_0x18ccf3;let _0x5a0581,_0x47f8b7;try{let {type:_0x3c961d,params:_0x192ee0}=_0x1a8ef5;await this[_0x53a978(0x166)]['checkUserStatus'](_0xa38711[_0x53a978(0x275)]),await this[_0x53a978(0x1d8)](_0xa38711['user']['id']);if(_0x3c961d===midjourney_constant_1[_0x53a978(0xed)][_0x53a978(0x134)])_0x47f8b7=await this[_0x53a978(0x2b5)](_0xa38711,_0x192ee0),_0x5a0581=_0x47f8b7['mjpTaskId'];else{if(_0x3c961d===midjourney_constant_1[_0x53a978(0xed)][_0x53a978(0x19f)])_0x192ee0=_0x192ee0,_0x192ee0[_0x53a978(0x218)]?(_0x47f8b7=await this['actionTask'](_0xa38711,_0x192ee0),_0x192ee0[_0x53a978(0x26c)]&&(_0x192ee0[_0x53a978(0x26d)]=_0x47f8b7['id'],_0x47f8b7=await this[_0x53a978(0x14d)](_0xa38711,_0x192ee0))):_0x47f8b7=await this['modalTask'](_0xa38711,_0x192ee0),_0x5a0581=_0x47f8b7[_0x53a978(0x2a6)];else return new common_1[(_0x53a978(0x102))]('任务类型错误',common_1['HttpStatus'][_0x53a978(0x1e4)]);}return _0x47f8b7;}catch(_0x1342a0){if(_0x1342a0 instanceof common_1[_0x53a978(0x102)])throw _0x1342a0;else{_0x5a0581&&await this[_0x53a978(0x1ef)]['cancel']({},_0x5a0581);throw new common_1[(_0x53a978(0x102))](_0x1342a0['message'],common_1[_0x53a978(0x2bf)][_0x53a978(0x1e4)]);}}}async['handleImagesUploadTask'](_0x176a4e,_0x3e8b8c){const _0x2d92cb=_0x18ccf3;let _0x3fc4c4,_0x204d10;try{let {type:_0xaee896,botType:_0x50e6f3,files:_0x47bd75,mode:_0x463775,action:_0x26ca61,size:_0x38d8f5,base64Array:base64Array=[]}=_0x176a4e;await this[_0x2d92cb(0x166)][_0x2d92cb(0xf7)](_0x3e8b8c[_0x2d92cb(0x275)]),await this[_0x2d92cb(0x1d8)](_0x3e8b8c[_0x2d92cb(0x275)]['id']);let _0x462ec3='';if(Number(_0xaee896)===midjourney_constant_1[_0x2d92cb(0xed)][_0x2d92cb(0x29c)])_0x462ec3=_0x2d92cb(0x146);else Number(_0xaee896)===midjourney_constant_1[_0x2d92cb(0xed)][_0x2d92cb(0x20b)]&&(_0x462ec3=_0x2d92cb(0x1fe));_0x463775=await this[_0x2d92cb(0x166)][_0x2d92cb(0xff)](_0x3e8b8c[_0x2d92cb(0x275)]['id'],_0x463775,_0x462ec3);const _0x520c40=await this[_0x2d92cb(0x13c)](_0x463775);if(!base64Array[_0x2d92cb(0x24a)])for(let _0x2ec087=0x0;_0x2ec087<_0x47bd75['length'];_0x2ec087++){base64Array[_0x2d92cb(0x203)](_0x2d92cb(0x284)+_0x47bd75[_0x2ec087][_0x2d92cb(0x1bb)][_0x2d92cb(0x24b)](_0x2d92cb(0x14c)));}if(Number(_0xaee896)===midjourney_constant_1[_0x2d92cb(0xed)][_0x2d92cb(0x29c)]){if(base64Array[_0x2d92cb(0x24a)]<0x2)throw new Error(_0x2d92cb(0x18f));const _0x4164d0=await this[_0x2d92cb(0x1ef)][_0x2d92cb(0x2c8)]({'data':{'mode':this[_0x2d92cb(0x10c)](_0x463775),'dimensions':_0x38d8f5,'botType':_0x2d92cb(0xda),'base64Array':base64Array,'accountFilter':_0x520c40}});if(_0x4164d0[_0x2d92cb(0x1b1)]===0x17)throw new Error(_0x2d92cb(0x153));if(_0x4164d0[_0x2d92cb(0x1b1)]!==0x1&&_0x4164d0['code']!==0x16)throw new Error(_0x4164d0[_0x2d92cb(0xfb)]);_0x3fc4c4=_0x4164d0[_0x2d92cb(0x2b1)],_0x204d10=await this['connection'][_0x2d92cb(0x18a)](async()=>{const _0x1756bb=_0x2d92cb,_0x2e746a={'mode':_0x463775,'action':_0x26ca61,'userId':_0x3e8b8c[_0x1756bb(0x275)]['id'],'jobId':(0x0,utils_1[_0x1756bb(0x27e)])(),'botType':_0x50e6f3||_0x1756bb(0xda),'originPrompt':'','mjpTaskId':_0x4164d0['result']},_0x1d9edc=await this['addDrawQueue'](_0x2e746a);if(!_0x1d9edc)throw new Error(_0x1756bb(0x178));return await this[_0x1756bb(0x166)][_0x1756bb(0x14e)](_0x3e8b8c[_0x1756bb(0x275)]['id'],_0x463775,_0x462ec3,_0x1d9edc['id']),_0x1d9edc;});}else{if(Number(_0xaee896)===midjourney_constant_1['MidJourneyDrawEnum']['IMAGE_TO_TEXT']){const _0x566d2e=await this[_0x2d92cb(0x1ef)]['describe']({'data':{'mode':this['convertMode4Transfer'](_0x463775),'botType':_0x2d92cb(0xda),'base64':base64Array[0x0],'accountFilter':_0x520c40}});if(_0x566d2e['code']===0x17)throw new Error('队列已满，请稍后尝试');if(_0x566d2e[_0x2d92cb(0x1b1)]!==0x1&&_0x566d2e[_0x2d92cb(0x1b1)]!==0x16)throw new Error(_0x566d2e['description']);_0x3fc4c4=_0x566d2e[_0x2d92cb(0x2b1)],_0x204d10=await this[_0x2d92cb(0x267)][_0x2d92cb(0x18a)](async()=>{const _0x3341d8=_0x2d92cb,_0x530bb2={'mode':_0x463775,'action':_0x26ca61,'userId':_0x3e8b8c['user']['id'],'jobId':(0x0,utils_1[_0x3341d8(0x27e)])(),'botType':_0x50e6f3||_0x3341d8(0xda),'extraParam':JSON[_0x3341d8(0x225)]({'attachments':[]}),'originPrompt':'','mjpTaskId':_0x566d2e['result']},_0x58dbad=await this[_0x3341d8(0x289)](_0x530bb2);if(!_0x58dbad)throw new Error(_0x3341d8(0x2d5));return await this['userService'][_0x3341d8(0x14e)](_0x3e8b8c[_0x3341d8(0x275)]['id'],_0x463775,_0x462ec3,_0x58dbad['id']),_0x58dbad;})[_0x2d92cb(0x234)](async _0x50d41f=>{const _0x466254=_0x2d92cb;await this['mjpTaskService'][_0x466254(0x101)]({},_0x566d2e[_0x466254(0x2b1)]);throw _0x50d41f;});}else return new common_1[(_0x2d92cb(0x102))](_0x2d92cb(0x21c),common_1[_0x2d92cb(0x2bf)][_0x2d92cb(0x1e4)]);}return _0x204d10;}catch(_0x320e8c){if(_0x320e8c instanceof common_1['HttpException'])throw _0x320e8c;else{_0x3fc4c4&&await this['mjpTaskService'][_0x2d92cb(0x101)]({},_0x3fc4c4);throw new common_1[(_0x2d92cb(0x102))](_0x320e8c[_0x2d92cb(0x1bd)],common_1[_0x2d92cb(0x2bf)][_0x2d92cb(0x1e4)]);}}}async[_0x18ccf3(0x160)](_0x2fe4c0,_0x388d34){const _0x10f656=_0x18ccf3;let _0xe676fc;try{const {params:_0x53195e}=_0x2fe4c0;let {mode:_0x336eb6,botType:_0x58c5fb,action:_0x35dc10,extend:_0x2afca3,sourceBase64:_0x78d70e,targetBase64:_0x4af02c}=_0x53195e;await this[_0x10f656(0x166)][_0x10f656(0xf7)](_0x388d34[_0x10f656(0x275)]),await this[_0x10f656(0x1d8)](_0x388d34[_0x10f656(0x275)]['id']),_0x336eb6=await this[_0x10f656(0x166)][_0x10f656(0xff)](_0x388d34[_0x10f656(0x275)]['id'],_0x336eb6,_0x10f656(0x221));const _0x10a2a5=await this[_0x10f656(0x13c)](_0x336eb6),_0x5d2d99=await this[_0x10f656(0x1ef)][_0x10f656(0x17f)]({'data':{'sourceBase64':_0x78d70e,'targetBase64':_0x4af02c,'state':_0x2afca3,'mode':this[_0x10f656(0x10c)](_0x336eb6),'accountFilter':_0x10a2a5}});if(_0x5d2d99[_0x10f656(0x1b1)]===0x17)throw new Error(_0x10f656(0x153));if(_0x5d2d99[_0x10f656(0x1b1)]===0x18)throw new Error(_0x10f656(0x2b2));if(_0x5d2d99[_0x10f656(0x1b1)]!==0x1&&_0x5d2d99[_0x10f656(0x1b1)]!==0x16)throw new Error(_0x5d2d99[_0x10f656(0xfb)]);return _0xe676fc=await this[_0x10f656(0x267)][_0x10f656(0x18a)](async()=>{const _0x1860b2=_0x10f656,_0x140b73={'mode':_0x336eb6,'action':_0x35dc10,'prompt':null,'extraParam':_0x2afca3,'originPrompt':null,'userId':_0x388d34[_0x1860b2(0x275)]['id'],'mjpId':_0x10a2a5?.['instanceId'],'mjpTaskId':_0x5d2d99['result'],'botType':_0x58c5fb||_0x1860b2(0xda)},_0x53d54d=new addDrawQueue_dto_1[(_0x1860b2(0x11e))](_0x140b73),_0x505047=(0x0,utils_1[_0x1860b2(0x14b)])(this[_0x1860b2(0x2bb)]);_0x53d54d[_0x1860b2(0x21b)]=_0x505047;const _0x431b20=await this[_0x1860b2(0x111)]['save'](_0x53d54d);if(!_0x431b20)throw new Error(_0x1860b2(0x25c));return await this[_0x1860b2(0x166)][_0x1860b2(0x14e)](_0x388d34['user']['id'],_0x336eb6,'FaceSwap',_0x431b20['id']),_0x431b20;}),_0xe676fc;}catch(_0x57f5be){if(_0x57f5be instanceof common_1[_0x10f656(0x102)])throw _0x57f5be;else throw new common_1[(_0x10f656(0x102))](_0x57f5be[_0x10f656(0x1bd)],common_1[_0x10f656(0x2bf)][_0x10f656(0x1e4)]);}}async['addRefer'](_0x13b6ec,_0x3c29e0){const _0x39f473=_0x18ccf3,_0x354319=(0x0,utils_1[_0x39f473(0x14b)])(this[_0x39f473(0x2bb)]),_0x239e3d={'userId':_0x3c29e0[_0x39f473(0x275)]['id'],'jobId':(0x0,utils_1['createRandomUid'])(),'mode':0x1,'translate':0x0,'prompt':'','progress':0x64,'durationSpent':0x0,'status':0x3,'fullPrompt':_0x13b6ec[_0x39f473(0x26c)],'originPrompt':_0x13b6ec[_0x39f473(0x26c)],'fileInfo':_0x13b6ec[_0x39f473(0x220)],'botType':_0x13b6ec['botType'],'imageUrl':_0x13b6ec[_0x39f473(0x1dc)],'buttons':[],'saasId':_0x354319},_0x360699=await this[_0x39f473(0x111)]['save'](_0x239e3d);return _0x360699;}async[_0x18ccf3(0xd9)](_0x390e75){const _0x65c562=_0x18ccf3;try{const _0x1f1261=await this['midjourneyEntity'][_0x65c562(0x1da)]({'where':{'jobId':_0x390e75}});if(!_0x1f1261)throw new Error(_0x65c562(0x114));const _0x1bee99=await this[_0x65c562(0x1ef)][_0x65c562(0xd9)]({},_0x1f1261[_0x65c562(0x2a6)]);if(_0x1bee99['code']!==0x1)throw new Error(_0x1bee99['description']);return _0x1bee99[_0x65c562(0x2b1)];}catch(_0x182b7d){throw new common_1[(_0x65c562(0x102))](_0x182b7d[_0x65c562(0x1bd)],common_1[_0x65c562(0x2bf)]['BAD_REQUEST']);}}async['getOneDraw'](_0x44920c,_0x498f5f){const _0xb50a8=_0x18ccf3;try{let _0x1e813c,_0x453589,_0x320939,_0x47fa7d;const {jobId:_0x338328,detail:_0x2d6722}=_0x498f5f,_0xfda72c=(0x0,utils_1[_0xb50a8(0x258)])(this[_0xb50a8(0x2bb)]),_0x431e61=await this[_0xb50a8(0x111)][_0xb50a8(0x1da)]({'where':{'jobId':_0x338328}});if(_0x431e61[_0xb50a8(0x190)]){const _0x825aff=await this[_0xb50a8(0x104)]['getModelById'](_0x431e61['workflowId']);_0x47fa7d=_0x825aff[_0xb50a8(0x185)];}return _0x2d6722&&(this[_0xb50a8(0x27a)][_0xb50a8(0x1d5)](model_constant_1[_0xb50a8(0x155)][_0xb50a8(0x1c6)],_0x431e61['id']),_0x1e813c=await this[_0xb50a8(0x166)]['getUserById'](_0x431e61['userId']),_0x453589=await this[_0xb50a8(0x27a)][_0xb50a8(0x103)](model_constant_1[_0xb50a8(0x155)][_0xb50a8(0x1c6)],_0x431e61['id']),_0xfda72c&&(_0x320939=await this['aiLogService'][_0xb50a8(0x13a)](model_constant_1[_0xb50a8(0x155)][_0xb50a8(0x1c6)],_0x431e61['id']))),{..._0x431e61,'workflowName':_0x47fa7d,'avatar':_0x1e813c?_0x1e813c[_0xb50a8(0x1fc)]:null,'username':_0x1e813c?_0x1e813c[_0xb50a8(0x1f3)]:null,'nickname':_0x1e813c?_0x1e813c[_0xb50a8(0xf6)]:null,'visitNum':_0x453589?_0x453589[_0xb50a8(0xf3)]:0x0,'agreeNum':_0x453589?_0x453589[_0xb50a8(0x12b)]:0x0,'agree':_0x320939?_0x320939[_0xb50a8(0x239)]:null};}catch(_0x1f28b7){throw new common_1['HttpException'](_0x1f28b7['message'],common_1[_0xb50a8(0x2bf)][_0xb50a8(0x1e4)]);}}async[_0x18ccf3(0x2ae)](_0x26b3bc){const _0x45228f=_0x18ccf3;try{if(!_0x26b3bc[_0x45228f(0x276)]||!_0x26b3bc['jobIds']['length'])return[];const _0x3714be=_0x26b3bc[_0x45228f(0x276)][_0x45228f(0x2ad)](','),_0x4fa713=await this[_0x45228f(0x111)][_0x45228f(0xe1)]({'where':{'jobId':(0x0,typeorm_2['In'])(_0x3714be)}}),_0x3b8a9f=new Map(),_0x3daac5=new Map(),_0xba2ac1=_0x4fa713['map'](_0x52f506=>_0x52f506[_0x45228f(0x190)])[_0x45228f(0x227)](_0x53c694=>Boolean(_0x53c694)),_0x1853d9=_0x4fa713[_0x45228f(0x17d)](_0x4f64c6=>_0x4f64c6[_0x45228f(0x179)])[_0x45228f(0x227)](_0x163da4=>_0x163da4);if(_0xba2ac1[_0x45228f(0x24a)]){const _0x500cb4=await this[_0x45228f(0x104)][_0x45228f(0x245)](_0xba2ac1);_0x500cb4['forEach'](_0x5d6f94=>_0x3b8a9f[_0x45228f(0x2cc)](_0x5d6f94['id'],_0x5d6f94));}if(_0x1853d9[_0x45228f(0x24a)]){const _0x2ecdc2=(await this['userService'][_0x45228f(0x124)](_0x1853d9))[_0x45228f(0x17d)](_0x108164=>{const _0x25133c=_0x45228f;return{'id':_0x108164['id'],'nickname':_0x108164[_0x25133c(0xf6)],'avatar':_0x108164[_0x25133c(0x1fc)]};});_0x2ecdc2[_0x45228f(0x10a)](_0x22559=>_0x3daac5['set'](_0x22559['id'],_0x22559));}return _0x4fa713[_0x45228f(0x17d)](_0x67d732=>{const _0x7a69f6=_0x45228f;return{..._0x67d732,'userInfo':_0x3daac5[_0x7a69f6(0x15d)](_0x67d732[_0x7a69f6(0x179)]),'workflowName':_0x3b8a9f[_0x7a69f6(0x15d)](_0x67d732[_0x7a69f6(0x190)])?.['modelName']||''};});}catch(_0x3205c6){throw new common_1['HttpException'](_0x3205c6[_0x45228f(0x1bd)],common_1['HttpStatus'][_0x45228f(0x1e4)]);}}async['recDraw'](_0x4c94db){const _0x5249e7=_0x18ccf3,{id:_0x7de9bf,squareType:_0x40553c,rec:_0x256970}=_0x4c94db,_0x2285b6=await this[_0x5249e7(0x111)][_0x5249e7(0x1da)]({'where':{'id':_0x7de9bf,'status':midjourney_constant_1[_0x5249e7(0x22e)][_0x5249e7(0x1a3)]}});if(!_0x2285b6)throw new common_1[(_0x5249e7(0x102))](_0x5249e7(0x1b9),common_1[_0x5249e7(0x2bf)]['BAD_REQUEST']);const _0x14a986=await this[_0x5249e7(0x111)][_0x5249e7(0x13b)]({'id':_0x7de9bf},{'rec':_0x256970,'squareType':_0x40553c})['catch'](_0x1d95dd=>{const _0x308603=_0x5249e7;throw new common_1[(_0x308603(0x102))](_0x1d95dd,common_1[_0x308603(0x2bf)][_0x308603(0x1e4)]);});if(_0x14a986[_0x5249e7(0xf2)]<=0x0)throw new common_1[(_0x5249e7(0x102))](_0x5249e7(0x257),common_1[_0x5249e7(0x2bf)][_0x5249e7(0x1e4)]);return await this[_0x5249e7(0x14f)]['del']({'key':_0x5249e7(0x260)}),!![];}async[_0x18ccf3(0xfd)](_0xf5a62f,_0x40f2fb){const _0x115b9b=_0x18ccf3;return this['czTaskService'][_0x115b9b(0x223)]({'data':{'workflowId':_0xf5a62f,'versionId':_0x40f2fb}});}async['workflowPage'](_0x56924a,_0x3d7f8f){const _0x1e6699=_0x18ccf3;try{const _0x3a426f={'page':_0x3d7f8f[_0x1e6699(0xdb)],'size':_0x3d7f8f[_0x1e6699(0x148)],'recommend':_0x3d7f8f[_0x1e6699(0x13e)],'modelName':_0x3d7f8f[_0x1e6699(0x219)],'modelType':model_constant_1[_0x1e6699(0x155)][_0x1e6699(0x1e3)]};(0x0,utils_1[_0x1e6699(0x181)])(this[_0x1e6699(0x2bb)])?_0x3d7f8f['status']!==undefined&&(_0x3a426f[_0x1e6699(0x1c5)]=Boolean(_0x3d7f8f[_0x1e6699(0x1c5)])):_0x3a426f[_0x1e6699(0x1c5)]=!![];const _0x410fac=await this[_0x1e6699(0x104)][_0x1e6699(0x2c0)](_0x56924a,_0x3a426f);let _0x448240=[];if(_0x410fac[_0x1e6699(0x15c)][_0x1e6699(0x24a)]){const _0x1f65d7=new Set(),_0x33f0d9=(0x0,utils_1['getUserId'])(this[_0x1e6699(0x2bb)]),_0x335b88=_0x410fac['rows'][_0x1e6699(0x17d)](_0x161b46=>_0x161b46['id']);if(_0x335b88[_0x1e6699(0x24a)]&&_0x33f0d9){const _0x3bd1c4=await this[_0x1e6699(0x166)][_0x1e6699(0x1eb)](_0x33f0d9,user_constant_1[_0x1e6699(0xde)][_0x1e6699(0x1e3)],_0x335b88);_0x3bd1c4[_0x1e6699(0x10a)](_0x51676d=>_0x1f65d7[_0x1e6699(0x19b)](Number(_0x51676d[_0x1e6699(0x262)])));}_0x448240=_0x410fac[_0x1e6699(0x15c)]['map'](_0x3c3965=>{const _0x149d9d=_0x1e6699,_0x34a54d={'id':_0x3c3965['id'],'cover':_0x3c3965[_0x149d9d(0xe4)],'name':_0x3c3965[_0x149d9d(0x185)],'workflowId':_0x3c3965[_0x149d9d(0x26e)],'config':_0x3c3965['config'],'recommend':_0x3c3965[_0x149d9d(0x13e)],'versionId':Number(_0x3c3965[_0x149d9d(0x1cc)]),'deduct':_0x3c3965[_0x149d9d(0x25e)],'vipFreeNum':_0x3c3965[_0x149d9d(0x272)],'displaySort':_0x3c3965[_0x149d9d(0x2d4)],'description':_0x3c3965[_0x149d9d(0xfb)],'status':_0x3c3965[_0x149d9d(0x1c5)],'createdAt':_0x3c3965['createdAt'],'updatedAt':_0x3c3965[_0x149d9d(0x154)],'useCount':_0x3c3965[_0x149d9d(0x10f)],'tutorial':_0x3c3965[_0x149d9d(0x297)],'freeUsed':_0x3c3965[_0x149d9d(0x1ad)],'favorite':_0x1f65d7[_0x149d9d(0x28e)](_0x3c3965['id'])};return _0x34a54d;});}return{'count':_0x410fac[_0x1e6699(0xe6)],'rows':_0x448240};}catch(_0x6b9ee1){throw new common_1[(_0x1e6699(0x102))](_0x6b9ee1[_0x1e6699(0x1bd)],common_1['HttpStatus'][_0x1e6699(0x1e4)]);}}async[_0x18ccf3(0x223)](_0x12cd3f,_0x3e2784){const _0x562687=_0x18ccf3;try{let _0x19619c;const _0x219d6c=(0x0,utils_1[_0x562687(0x258)])(this[_0x562687(0x2bb)]),_0x3d7192=new Set(),_0x1ccd51=await this['modelsService'][_0x562687(0x23d)](_0x3e2784);if(!_0x1ccd51)throw new common_1[(_0x562687(0x102))](_0x562687(0x1f8),common_1['HttpStatus'][_0x562687(0x1e4)]);if(_0x219d6c){const _0x352fa3=await this[_0x562687(0x166)][_0x562687(0x1ff)](_0x219d6c);if(_0x352fa3['vipExpire']||_0x352fa3[_0x562687(0x264)]){const _0x5e8adb=redisKey_constant_1[_0x562687(0x224)]+'-'+_0x219d6c+'-'+_0x1ccd51['id'];_0x19619c=await await this[_0x562687(0x14f)][_0x562687(0x15d)]({'key':_0x5e8adb});}const _0x22c5d5=await this[_0x562687(0x166)][_0x562687(0x1eb)](_0x219d6c,user_constant_1[_0x562687(0xde)][_0x562687(0x1e3)],[_0x1ccd51['id']]);_0x22c5d5[_0x562687(0x10a)](_0x4bd077=>_0x3d7192[_0x562687(0x19b)](Number(_0x4bd077[_0x562687(0x262)])));}const _0x5bfe24={'id':_0x1ccd51['id'],'cover':_0x1ccd51['cover'],'name':_0x1ccd51[_0x562687(0x185)],'workflowId':_0x1ccd51[_0x562687(0x26e)],'config':_0x1ccd51['config'],'versionId':Number(_0x1ccd51[_0x562687(0x1cc)]),'deduct':_0x1ccd51[_0x562687(0x25e)],'vipFreeNum':_0x1ccd51['vipFreeNum'],'displaySort':_0x1ccd51[_0x562687(0x2d4)],'description':_0x1ccd51[_0x562687(0xfb)],'status':_0x1ccd51[_0x562687(0x1c5)],'createdAt':_0x1ccd51[_0x562687(0x22f)],'updatedAt':_0x1ccd51[_0x562687(0x154)],'useCount':_0x1ccd51[_0x562687(0x10f)],'tutorial':_0x1ccd51['remark'],'freeUsed':Number(_0x19619c),'favorite':_0x3d7192['has'](_0x1ccd51['id'])};return _0x5bfe24;}catch(_0xdbc830){throw new common_1[(_0x562687(0x102))](_0xdbc830[_0x562687(0x1bd)],common_1[_0x562687(0x2bf)][_0x562687(0x1e4)]);}}async['workflowSave'](_0x30673d){const _0x16ec68=_0x18ccf3;try{const _0x4eb908={'id':_0x30673d['id'],'keyType':0x5,'modelType':model_constant_1['EModelType'][_0x16ec68(0x1e3)],'cover':_0x30673d[_0x16ec68(0xe4)],'modelName':_0x30673d[_0x16ec68(0x177)],'model':_0x30673d[_0x16ec68(0x190)],'key':'','config':_0x30673d[_0x16ec68(0x2ce)],'deduct':_0x30673d[_0x16ec68(0x25e)],'vipFreeNum':_0x30673d[_0x16ec68(0x272)],'displaySort':_0x30673d[_0x16ec68(0x2d4)],'description':_0x30673d['description'],'status':_0x30673d['status'],'remark':_0x30673d['tutorial'],'recommend':_0x30673d[_0x16ec68(0x13e)]};return _0x30673d[_0x16ec68(0x171)]&&(_0x4eb908[_0x16ec68(0x1cc)]=String(_0x30673d[_0x16ec68(0x171)])),await this['modelsService'][_0x16ec68(0x188)](_0x4eb908),!![];}catch(_0x670243){throw new common_1[(_0x16ec68(0x102))](_0x670243[_0x16ec68(0x1bd)],common_1[_0x16ec68(0x2bf)][_0x16ec68(0x1e4)]);}}async[_0x18ccf3(0x1f1)](_0x110711){const _0x27e40c=_0x18ccf3;return this[_0x27e40c(0x104)][_0x27e40c(0x298)](_0x110711[_0x27e40c(0x2c5)]);}async[_0x18ccf3(0x18d)](){const _0x2110dd=_0x18ccf3,_0xbfaf5e=await this[_0x2110dd(0x13d)][_0x2110dd(0x1fb)](_0x2110dd(0x29d)),_0xb6882c=await this['dictService'][_0x2110dd(0x1fb)](_0x2110dd(0x105)),_0x52d6da=await this[_0x2110dd(0x13d)]['list4workflow'](_0x2110dd(0x2b9)),_0x313ec5=await this[_0x2110dd(0x13d)][_0x2110dd(0x1fb)]('application_fields');return{'style':_0xbfaf5e,'effect_category':_0xb6882c,'effect_main_body':_0x52d6da,'application_fields':_0x313ec5};}async[_0x18ccf3(0x285)](_0x347b6d){const _0x5e9b9a=_0x18ccf3;try{const {page:page=0x1,size:size=0x14,keyword:_0x2c5304,type:_0x3d4acb,version:_0x3f3c69,style:_0x51b200,effectCategory:_0x3390df,effectMainBody:_0x4bd22f,applicationFields:_0xc4308b,disabled:_0x5219b8}=_0x347b6d,_0x44378d={};_0x2c5304&&(_0x44378d[_0x5e9b9a(0x177)]=(0x0,typeorm_2[_0x5e9b9a(0x1b0)])('%'+_0x2c5304+'%'));_0x3d4acb&&(_0x44378d['type']=_0x3d4acb);_0x3f3c69&&(_0x44378d[_0x5e9b9a(0x1f6)]=_0x3f3c69);_0x51b200&&(_0x44378d[_0x5e9b9a(0x29d)]=_0x51b200);_0x3390df&&(_0x44378d[_0x5e9b9a(0x11a)]=_0x3390df);_0x4bd22f&&(_0x44378d[_0x5e9b9a(0x281)]=_0x4bd22f);_0xc4308b&&(_0x44378d[_0x5e9b9a(0x12d)]=_0xc4308b);(0x0,utils_1[_0x5e9b9a(0x181)])(this[_0x5e9b9a(0x2bb)])?(0x0,utils_1[_0x5e9b9a(0x18c)])(_0x5219b8)&&(_0x44378d[_0x5e9b9a(0x282)]=_0x5219b8):_0x44378d['disabled']=0x0;const [_0x5797f0,_0xe66290]=await this['mjModelEntity'][_0x5e9b9a(0x1ea)]({'where':_0x44378d,'take':size,'skip':(page-0x1)*size,'order':{'id':_0x5e9b9a(0x279)}});return{'rows':_0x5797f0,'count':_0xe66290};}catch(_0xe05a46){throw new common_1['HttpException'](_0xe05a46[_0x5e9b9a(0x1bd)],common_1[_0x5e9b9a(0x2bf)][_0x5e9b9a(0x1e4)]);}}async[_0x18ccf3(0x1ae)](_0x33425c){const _0x66a045=_0x18ccf3;try{const {id:_0x5caab6,name:_0x9d9385,cover:_0x117e8d,description:_0x242df6,disabled:_0x3bead5}=_0x33425c,_0x396707={};return _0x9d9385&&(_0x396707[_0x66a045(0x177)]=_0x9d9385),_0x117e8d&&(_0x396707[_0x66a045(0xe4)]=_0x117e8d),_0x242df6&&(_0x396707['description']=_0x242df6),_0x3bead5&&(_0x396707[_0x66a045(0x282)]=_0x3bead5),await this[_0x66a045(0x253)][_0x66a045(0x13b)]({'id':_0x5caab6},_0x396707),!![];}catch(_0xa7706f){throw new common_1[(_0x66a045(0x102))](_0xa7706f[_0x66a045(0x1bd)],common_1[_0x66a045(0x2bf)][_0x66a045(0x1e4)]);}}async[_0x18ccf3(0xfc)](_0x980a57){const _0x4a41dc=_0x18ccf3,_0x15c278=_0x980a57[_0x4a41dc(0x2ad)](',');if(!_0x980a57['length'])throw new common_1[(_0x4a41dc(0x102))](_0x4a41dc(0x1de),common_1[_0x4a41dc(0x2bf)]['BAD_REQUEST']);return this[_0x4a41dc(0x253)][_0x4a41dc(0xe1)]({'where':{'id':(0x0,typeorm_2['In'])(_0x15c278),'disabled':0x0}});}async[_0x18ccf3(0x135)](_0x37396f,_0x260699){const _0x554c4b=_0x18ccf3;try{const _0x242281=await this['modelsService'][_0x554c4b(0x23d)](_0x260699['workflowId']);if(!_0x242281[_0x554c4b(0x1c5)])throw new Error('小工具已禁用！');let _0x3ece9b;const _0x42477b=(0x0,utils_1[_0x554c4b(0x14b)])(this[_0x554c4b(0x2bb)]);return await this[_0x554c4b(0x267)][_0x554c4b(0x18a)](async()=>{const _0x225060=_0x554c4b;_0x3ece9b=await this[_0x225060(0x289)]({'originPrompt':'','saasId':_0x42477b,'userId':_0x37396f[_0x225060(0x275)]['id'],'mode':midjourney_constant_1[_0x225060(0x2c9)][_0x225060(0x242)],'botType':DrawTaskPage_dto_1[_0x225060(0x11d)][_0x225060(0x1e3)],'workflowId':_0x260699[_0x225060(0x190)],'fullPrompt':JSON[_0x225060(0x225)](_0x260699[_0x225060(0x1d6)])}),await this[_0x225060(0x166)][_0x225060(0x23e)](_0x37396f[_0x225060(0x275)]['id'],_0x242281,_0x3ece9b['id']);const _0x29c4e2=await this[_0x225060(0x1e6)][_0x225060(0x1e5)]({'data':{'workflowId':Number(_0x242281['model']),'versionId':Number(_0x242281[_0x225060(0x1cc)]),'presetId':_0x260699[_0x225060(0x252)],'inputs':_0x260699[_0x225060(0x1d6)]}});_0x3ece9b[_0x225060(0x2a6)]=_0x29c4e2['taskId'],await this[_0x225060(0x111)][_0x225060(0x13b)]({'id':_0x3ece9b['id']},{'mjpTaskId':_0x29c4e2[_0x225060(0x26d)]});}),_0x3ece9b;}catch(_0x102196){throw new common_1[(_0x554c4b(0x102))](_0x102196[_0x554c4b(0x1bd)],common_1['HttpStatus'][_0x554c4b(0x1e4)]);}}async[_0x18ccf3(0x291)](_0x5595df,_0x29c244){const _0x4b0dd4=_0x18ccf3,{page:page=0x1,size:size=0x14}=_0x29c244,[_0x178904]=await this[_0x4b0dd4(0x267)][_0x4b0dd4(0x27d)](_0x4b0dd4(0x125)+_0x5595df[_0x4b0dd4(0x275)]['id']+_0x4b0dd4(0x254)),_0x457055=await this[_0x4b0dd4(0x267)][_0x4b0dd4(0x27d)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.cover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.modelName\x20AS\x20name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.model\x20AS\x20workflowId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.key\x20AS\x20versionId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.deduct,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.vip_free_num\x20AS\x20vipFreeNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.displaySort,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.description,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.useCount,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20m.remark\x20AS\x20tutorial,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20t.used\x20AS\x20used\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20models\x20m\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20(\x20SELECT\x20workflowId,\x20count(workflowId)\x20AS\x20used,\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20FROM\x20midjourney\x20WHERE\x20workflowId\x20IS\x20NOT\x20NULL\x20AND\x20userId\x20=\x20'+_0x5595df[_0x4b0dd4(0x275)]['id']+_0x4b0dd4(0x20c)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x4b0dd4(0x1d2));return{'rows':_0x457055,'count':Number(_0x178904?.[_0x4b0dd4(0xe6)]||0x0)};}async[_0x18ccf3(0x159)](_0x1cd561,_0x1d2fe7){const _0x2698af=_0x18ccf3,_0x41ad10=_0x1cd561['user']['id'],{page:page=0x1,size:size=0x14}=_0x1d2fe7,[_0x9e23c2]=await this['connection'][_0x2698af(0x27d)](_0x2698af(0x116)+_0x1cd561['user']['id']+_0x2698af(0x158)+user_constant_1[_0x2698af(0xde)]['WORKFLOW']+_0x2698af(0x176)),_0x15fca3=await this[_0x2698af(0x267)][_0x2698af(0x27d)](_0x2698af(0x1b5)+_0x1cd561['user']['id']+_0x2698af(0x158)+user_constant_1[_0x2698af(0xde)]['WORKFLOW']+'\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uf.createdAt\x20DESC\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+size+_0x2698af(0x292)+(page-0x1)*size+_0x2698af(0x1d2));if(_0x1cd561[_0x2698af(0x275)]['id']){const _0x12c9f3=await this['userService'][_0x2698af(0x1ff)](_0x41ad10);if(_0x12c9f3[_0x2698af(0x183)]||_0x12c9f3[_0x2698af(0x264)])for(let _0x52174e=0x0;_0x52174e<_0x15fca3[_0x2698af(0x24a)];_0x52174e++){const _0x23e385=_0x15fca3[_0x52174e],_0xf86204=redisKey_constant_1[_0x2698af(0x224)]+'-'+_0x41ad10+'-'+_0x23e385['id'],_0x59ed91=await await this[_0x2698af(0x14f)][_0x2698af(0x15d)]({'key':_0xf86204});_0x23e385[_0x2698af(0x287)]=Number(_0x59ed91||0x0);}}return{'rows':_0x15fca3,'count':_0x9e23c2?.[_0x2698af(0xe6)]||0x0};}async[_0x18ccf3(0x1d7)](_0x3a47b6,_0x466e54){const _0x1651c9=_0x18ccf3;try{let _0x570eba;const _0x118c50=(0x0,utils_1[_0x1651c9(0x14b)])(this['clsService']);return await this['connection'][_0x1651c9(0x18a)](async()=>{const _0x354c9a=_0x1651c9;_0x570eba=await this[_0x354c9a(0x289)]({'saasId':_0x118c50,'userId':_0x3a47b6[_0x354c9a(0x275)]['id'],'mode':midjourney_constant_1[_0x354c9a(0x2c9)][_0x354c9a(0x242)],'botType':DrawTaskPage_dto_1['EBotType']['SD'],'originPrompt':_0x466e54[_0x354c9a(0x26c)],'fullPrompt':JSON[_0x354c9a(0x225)](_0x466e54)}),await this[_0x354c9a(0x166)]['deductBalance4SD'](_0x3a47b6['user']['id'],_0x570eba['id']);const _0x5cecb3=await this[_0x354c9a(0x1e6)][_0x354c9a(0x156)]({'data':_0x466e54});_0x570eba['mjpTaskId']=_0x5cecb3[_0x354c9a(0x1f9)],await this[_0x354c9a(0x111)][_0x354c9a(0x13b)]({'id':_0x570eba['id']},{'mjpTaskId':_0x5cecb3[_0x354c9a(0x1f9)]});}),_0x570eba;}catch(_0x22e964){throw new common_1[(_0x1651c9(0x102))](_0x22e964['message'],common_1[_0x1651c9(0x2bf)][_0x1651c9(0x1e4)]);}}async[_0x18ccf3(0x2aa)](_0x2e8038,_0x4251e4){const _0x173a15=_0x18ccf3;try{const _0x1c06c7=await this[_0x173a15(0x111)][_0x173a15(0x1da)]({'where':{'id':Number(_0x4251e4[_0x173a15(0x26d)])}});if(!_0x1c06c7)throw new Error('原始任务不存在！');let _0x4b9b64;const _0x5dc221=(0x0,utils_1[_0x173a15(0x14b)])(this[_0x173a15(0x2bb)]);return await this[_0x173a15(0x267)]['transaction'](async()=>{const _0x595812=_0x173a15;_0x4b9b64=await this[_0x595812(0x289)]({'saasId':_0x5dc221,'userId':_0x2e8038['user']['id'],'mode':midjourney_constant_1['DrawSpeed'][_0x595812(0x242)],'botType':DrawTaskPage_dto_1[_0x595812(0x11d)]['SD'],'originPrompt':_0x4251e4[_0x595812(0x26c)],'originTaskId':_0x4251e4[_0x595812(0x26d)],'fullPrompt':JSON['stringify'](_0x4251e4)}),await this[_0x595812(0x166)][_0x595812(0x27f)](_0x2e8038['user']['id'],_0x4b9b64['id']);const _0x13f8b9=await this[_0x595812(0x1e6)]['aiInpaint']({'data':{'mask':_0x4251e4[_0x595812(0x139)],'prompt':_0x4251e4['prompt'],'taskId':_0x1c06c7[_0x595812(0x2a6)],'denoisingStrength':_0x4251e4[_0x595812(0x121)]}});_0x4b9b64[_0x595812(0x2a6)]=_0x13f8b9[_0x595812(0x1f9)],await this[_0x595812(0x111)]['update']({'id':_0x4b9b64['id']},{'mjpTaskId':_0x13f8b9[_0x595812(0x1f9)]});}),_0x4b9b64;}catch(_0x53b446){throw new common_1[(_0x173a15(0x102))](_0x53b446[_0x173a15(0x1bd)],common_1[_0x173a15(0x2bf)][_0x173a15(0x1e4)]);}}async[_0x18ccf3(0xd8)](_0x7136c8,_0x26b6c3){const _0x450fdb=_0x18ccf3,{id:_0x1bccc4,favorite:_0x1dbd42}=_0x7136c8;if(_0x1dbd42==0x1)return await this[_0x450fdb(0x166)][_0x450fdb(0x1d0)](_0x26b6c3[_0x450fdb(0x275)]['id'],_0x1bccc4,collectType_constant_1[_0x450fdb(0x2ac)]['MJ']),!![];return await this[_0x450fdb(0x166)][_0x450fdb(0x23a)](_0x26b6c3[_0x450fdb(0x275)]['id'],_0x1bccc4,collectType_constant_1[_0x450fdb(0x2ac)]['MJ']),!![];}async[_0x18ccf3(0x172)](_0x13424f,_0x183fd5){const _0x421a78=_0x18ccf3,{page:page=0x1,size:size=0x14}=_0x13424f,{rows:_0x18d40e,count:_0x580f79}=await this[_0x421a78(0x166)][_0x421a78(0xd5)](page,size,_0x183fd5[_0x421a78(0x275)]['id'],collectType_constant_1[_0x421a78(0x2ac)]['MJ']),_0x5e36a7=await this[_0x421a78(0x111)][_0x421a78(0xe1)]({'where':{'userId':_0x183fd5[_0x421a78(0x275)]['id'],'id':(0x0,typeorm_2['In'])(_0x18d40e[_0x421a78(0x17d)](_0x31c41f=>_0x31c41f[_0x421a78(0x1c2)]))}});let _0x3ef437=await this[_0x421a78(0x166)]['mergeCollectData'](_0x5e36a7,_0x183fd5,collectType_constant_1[_0x421a78(0x2ac)]['MJ']);return _0x3ef437=await this[_0x421a78(0x166)][_0x421a78(0x17e)](_0x5e36a7,collectType_constant_1[_0x421a78(0x2ac)]['MJ']),{'rows':_0x3ef437,'count':_0x580f79};}async[_0x18ccf3(0x278)](_0x2f548b,_0x471de2){const _0x29e474=_0x18ccf3;try{const _0x5478cf=await this[_0x29e474(0x111)][_0x29e474(0x1da)]({'where':{'id':_0x2f548b,'userId':_0x471de2[_0x29e474(0x275)]['id']}});if(!_0x5478cf)throw new Error(_0x29e474(0x25b));if(_0x5478cf[_0x29e474(0x1c5)]===midjourney_constant_1[_0x29e474(0x22e)][_0x29e474(0x2d2)])throw new Error(_0x29e474(0x1f5));await this[_0x29e474(0x1ef)][_0x29e474(0x101)](null,_0x5478cf[_0x29e474(0x2a6)]);const _0xd99b36=await this['midjourneyEntity']['delete']({'id':_0x2f548b});if(_0xd99b36[_0x29e474(0xf2)]>0x0)return _0x29e474(0x277);else throw new Error(_0x29e474(0x1c7));}catch(_0x5e24bf){throw new common_1[(_0x29e474(0x102))](_0x5e24bf['message'],common_1[_0x29e474(0x2bf)][_0x29e474(0x1e4)]);}}async[_0x18ccf3(0x118)](_0x1b5194,_0x26bbf8){const _0x551812=_0x18ccf3,{id:_0x581beb}=_0x26bbf8;if(!_0x581beb)throw new common_1['HttpException']('非法操作！',common_1[_0x551812(0x2bf)][_0x551812(0x1e4)]);const _0x2f2e38=await this['midjourneyEntity'][_0x551812(0x189)]({'id':_0x581beb});if(_0x2f2e38['affected']<=0x0)throw new common_1[(_0x551812(0x102))]('删除记录失败！',common_1[_0x551812(0x2bf)][_0x551812(0x1e4)]);return!![];}async[_0x18ccf3(0x1e1)](_0x41b6c0,_0x49fd8f){const _0x429279=_0x18ccf3;try{const {prompt:_0x3fec85,status:_0x2d75a5,isCarryParams:_0x5587a1,imageUrl:_0x20815f,title:_0x50857d,order:_0xb1dce,id:_0x187ce6,aspect:_0x505874,type:_0x1be12f}=_0x49fd8f;if(_0x187ce6)return await this['mjPromptsEntity'][_0x429279(0x13b)]({'id':_0x187ce6},{'title':_0x50857d,'prompt':_0x3fec85,'imageUrl':_0x20815f,'status':_0x2d75a5,'isCarryParams':_0x5587a1,'order':_0xb1dce,'aspect':_0x505874,'type':_0x1be12f})[_0x429279(0x11c)](_0x43d7c9=>!!_0x43d7c9);else{const _0x113694=(0x0,utils_1[_0x429279(0x14b)])(this['clsService']);return await this[_0x429279(0x2b4)][_0x429279(0x266)]({'prompt':_0x3fec85,'status':_0x2d75a5,'imageUrl':_0x20815f,'isCarryParams':_0x5587a1,'title':_0x50857d,'order':_0xb1dce,'aspect':_0x505874,'type':_0x1be12f,'saasId':_0x113694})[_0x429279(0x11c)](_0x2acea0=>!!_0x2acea0);}}catch(_0x383ba3){console['log'](_0x429279(0xef),_0x383ba3);}}async[_0x18ccf3(0x173)](_0x3e5df6,_0x2ca22a){const _0x1568d9=_0x18ccf3,{id:_0x36d5cd}=_0x2ca22a;if(!_0x36d5cd)throw new common_1[(_0x1568d9(0x102))](_0x1568d9(0x2a2),common_1['HttpStatus'][_0x1568d9(0x1e4)]);return await this[_0x1568d9(0x2b4)][_0x1568d9(0x189)]({'id':_0x36d5cd});}async[_0x18ccf3(0x19d)](_0x316a6c=0x0){const _0x161886=_0x18ccf3,_0x15e77e=(0x0,utils_1[_0x161886(0x14b)])(this['clsService']);return await this['mjPromptsEntity']['find']({'where':{'saasId':_0x15e77e,'type':_0x316a6c||0x0},'order':{'order':_0x161886(0x232)}})['then'](_0x4db3e7=>_0x4db3e7||[])['catch'](_0x553cc9=>{const _0x3e3508=_0x161886;common_1[_0x3e3508(0x28b)][_0x3e3508(0x251)](_0x553cc9);});}async['promptsPage'](_0x1d8d2a){const _0x132daf=_0x18ccf3;try{const {page:_0x2e684f,size:_0x2cef11,keyword:_0x2b0682,saasId:_0x36bab9,type:_0x3a0cfb}=_0x1d8d2a,_0x55b509=(0x0,utils_1[_0x132daf(0x14b)])(this[_0x132daf(0x2bb)]),_0x451344={'status':!![],'type':_0x3a0cfb||0x0};(0x0,utils_1[_0x132daf(0x295)])(this[_0x132daf(0x2bb)])?(0x0,utils_1['isDefined'])(_0x36bab9)&&(_0x451344['saasId']=_0x36bab9):_0x451344[_0x132daf(0x21b)]=_0x55b509;const [_0x2ddbd9,_0xf7b7fe]=await this[_0x132daf(0x2b4)]['findAndCount']({'where':[{..._0x451344,'title':(0x0,typeorm_2[_0x132daf(0x1b0)])('%'+_0x2b0682+'%')},{..._0x451344,'prompt':(0x0,typeorm_2[_0x132daf(0x1b0)])('%'+_0x2b0682+'%')}],'take':_0x2cef11,'skip':(_0x2e684f-0x1)*_0x2cef11,'order':{'order':_0x132daf(0x232)}});return{'rows':_0x2ddbd9,'count':_0xf7b7fe};}catch(_0x42ed07){throw new common_1[(_0x132daf(0x102))](_0x42ed07[_0x132daf(0x1bd)],common_1[_0x132daf(0x2bf)][_0x132daf(0x1e4)]);}}async[_0x18ccf3(0x100)](_0x3f12f1){const _0x41f022=_0x18ccf3;try{const {name:_0x1ac080,value:_0x136246,dataType:_0x165dd8}=_0x3f12f1,_0x212fd3=(0x0,utils_1[_0x41f022(0x14b)])(this[_0x41f022(0x2bb)]),_0xa89866=await this[_0x41f022(0x1f4)]['findOneBy']({'name':_0x1ac080,'saasId':_0x212fd3});if(_0xa89866)throw new common_1['HttpException'](_0x41f022(0x117),common_1[_0x41f022(0x2bf)][_0x41f022(0x1e4)]);return await this['mjInspireClassifyEntity']['save']({'name':_0x1ac080,'value':_0x136246,'dataType':_0x165dd8,'saasId':_0x212fd3})['then'](_0x3f46a2=>!!_0x3f46a2)['catch'](_0x1bf97d=>{const _0x18137f=_0x41f022;console[_0x18137f(0x2a5)](_0x1bf97d);throw new common_1[(_0x18137f(0x102))](_0x1bf97d,common_1[_0x18137f(0x2bf)][_0x18137f(0x1e4)]);});}catch(_0x54f009){return![];}}async[_0x18ccf3(0x25f)](_0x2212c7){const _0x20ee3b=_0x18ccf3,{id:_0x3f0a4b,name:_0x40041d,value:_0x11d5ed}=_0x2212c7;return await this[_0x20ee3b(0x1f4)][_0x20ee3b(0x13b)](_0x3f0a4b,{'name':_0x40041d,'value':_0x11d5ed})['then'](_0x349f3b=>!!_0x349f3b);}async['removeMjInspireClassify'](_0x4d17a7){const _0x32748c=_0x18ccf3,{id:_0x3d44e8}=_0x4d17a7;return await this[_0x32748c(0x1f4)][_0x32748c(0x189)]({'id':_0x3d44e8})[_0x32748c(0x234)](_0x4508d9=>{const _0x5dd9cb=_0x32748c;throw new common_1[(_0x5dd9cb(0x102))](_0x4508d9,common_1[_0x5dd9cb(0x2bf)][_0x5dd9cb(0x1e4)]);});}async[_0x18ccf3(0x27c)](_0x3b19a2){const _0x501f7d=_0x18ccf3,{size:_0x5c257f,page:_0xa77322,saasId:_0x39f80f}=_0x3b19a2,_0x58a462=(0x0,utils_1[_0x501f7d(0x14b)])(this[_0x501f7d(0x2bb)]),_0x1772da={};_0x3b19a2[_0x501f7d(0x1d9)]==0x1?_0x1772da['dataType']=0x1:_0x1772da[_0x501f7d(0x1d9)]=0x0;(0x0,utils_1[_0x501f7d(0x295)])(this['clsService'])?(0x0,utils_1['isDefined'])(_0x39f80f)&&(_0x1772da[_0x501f7d(0x21b)]=_0x39f80f):_0x1772da[_0x501f7d(0x21b)]=_0x58a462;const _0x334ef1=await this[_0x501f7d(0x1f4)][_0x501f7d(0x1ea)]({'where':_0x1772da,'order':{'createdAt':_0x501f7d(0x232)},'take':_0x5c257f,'skip':(_0xa77322-0x1)*_0x5c257f})['catch'](_0x3a6609=>{const _0xc9b21f=_0x501f7d;throw new common_1[(_0xc9b21f(0x102))](_0x3a6609,common_1[_0xc9b21f(0x2bf)][_0xc9b21f(0x1e4)]);});if(!_0x334ef1)throw new common_1['HttpException'](_0x501f7d(0x1ce),common_1[_0x501f7d(0x2bf)][_0x501f7d(0x1e4)]);const [_0x550db6,_0x531dc6]=_0x334ef1;return{'rows':_0x550db6,'count':_0x531dc6};}async[_0x18ccf3(0x23f)](_0x33dc40){const _0x29434b=_0x18ccf3,{id:_0x454df1}=_0x33dc40;return await this['mjInspireClassifyEntity'][_0x29434b(0x1da)]({'where':{'id':_0x454df1}});}async[_0x18ccf3(0xe8)](_0x4e3ce2){const _0x2b0152=_0x18ccf3;try{const _0x37b3e4=(0x0,utils_1[_0x2b0152(0x14b)])(this[_0x2b0152(0x2bb)]),{classifyName:_0x3a58ab,level:_0x5a29bc,type:_0x3e9c01,pid:pid=0x0,dataType:_0x5724b1}=_0x4e3ce2;return await this[_0x2b0152(0x1c3)][_0x2b0152(0x266)]({'classifyName':_0x3a58ab,'level':_0x5a29bc,'type':_0x3e9c01,'pid':pid,'dataType':_0x5724b1,'saasId':_0x37b3e4})[_0x2b0152(0x11c)](_0x247be9=>!!_0x247be9)[_0x2b0152(0x234)](_0x64de5c=>{const _0x16698e=_0x2b0152;console[_0x16698e(0x2a5)](_0x64de5c);throw new common_1['HttpException'](_0x64de5c,common_1[_0x16698e(0x2bf)][_0x16698e(0x1e4)]);});}catch(_0x20e5dc){return![];}}async['modifyMjIncantationClassify'](_0x1fce20){const {id:_0x525e5b,classifyName:_0x5b18be,level:_0xba6766,type:_0x49ae57,pid:_0x206bf6}=_0x1fce20;return this['connection']['transaction'](async()=>{const _0x1ac4a2=_0x1513,_0x620753=await this[_0x1ac4a2(0x1c3)][_0x1ac4a2(0x1da)]({'where':{'id':_0x525e5b}});_0x620753[_0x1ac4a2(0x142)]!==_0x49ae57&&await this[_0x1ac4a2(0x1c3)][_0x1ac4a2(0x13b)]({'pid':_0x525e5b},{'type':_0x49ae57}),await this[_0x1ac4a2(0x1c3)][_0x1ac4a2(0x13b)](_0x525e5b,{'classifyName':_0x5b18be,'level':_0xba6766,'type':_0x49ae57,'pid':_0x206bf6});}),!![];}async['removeMjIncantationClassify'](_0x33593d){const _0x4b938c=_0x18ccf3,{id:_0x10b5c8}=_0x33593d;return await this['mjIncantationClassifyEntity'][_0x4b938c(0x189)]({'id':_0x10b5c8})[_0x4b938c(0x11c)](_0xfc5114=>_0xfc5114['affected']>0x0);}async['getMjIncantationClassify'](_0x270a58){const _0x598786=_0x18ccf3,{id:_0x246309}=_0x270a58;return await this[_0x598786(0x1c3)]['findOne']({'where':{'id':_0x246309}});}async[_0x18ccf3(0x202)](_0x74366a=0x0){const _0x451f26=_0x18ccf3,_0x2d43d7=(0x0,utils_1['getReqSaasId'])(this['clsService']);return this[_0x451f26(0x1c3)]['find']({'where':{'level':0x1,'saasId':_0x2d43d7,'dataType':_0x74366a==0x1?0x1:0x0}});}async[_0x18ccf3(0x169)](_0x37beb0){const _0x563e38=_0x18ccf3,{size:_0x2b77c6,page:_0x88ed3,type:_0x2e3cba,keyword:_0x40ff0a,level:_0x197d9f,saasId:_0x3833c5}=_0x37beb0,_0x4aecf3=(0x0,utils_1[_0x563e38(0x14b)])(this[_0x563e38(0x2bb)]);let _0x54c0a6={};_0x37beb0[_0x563e38(0x1d9)]==0x1?_0x54c0a6['dataType']=0x1:_0x54c0a6[_0x563e38(0x1d9)]=0x0;_0x197d9f>0x0&&(_0x54c0a6[_0x563e38(0x270)]=_0x197d9f);_0x2e3cba&&(_0x54c0a6[_0x563e38(0x142)]=_0x2e3cba);_0x40ff0a&&(_0x54c0a6[_0x563e38(0x28d)]=(0x0,typeorm_2['Like'])('%'+_0x40ff0a+'%'));(0x0,utils_1[_0x563e38(0x295)])(this['clsService'])?(0x0,utils_1[_0x563e38(0x18c)])(_0x3833c5)&&(_0x54c0a6[_0x563e38(0x21b)]=_0x3833c5):_0x54c0a6['saasId']=_0x4aecf3;const _0x1bb575=await this[_0x563e38(0x1c3)][_0x563e38(0x1ea)]({'order':{'createdAt':_0x563e38(0x232)},'where':_0x54c0a6,'take':_0x2b77c6,'skip':(_0x88ed3-0x1)*_0x2b77c6})['catch'](_0x3af2d5=>{const _0x5e83e9=_0x563e38;console[_0x5e83e9(0x2a5)](_0x3af2d5);});if(!_0x1bb575)throw new common_1['HttpException'](_0x563e38(0x274),common_1[_0x563e38(0x2bf)]['BAD_REQUEST']);const [_0x3347a2,_0x580479]=_0x1bb575;return{'rows':_0x3347a2,'count':_0x580479};}async['queryMjIncantationClassifyAllByLevel'](_0x2ce665){const _0x2541a4=_0x18ccf3,{level:_0x5711d8,type:_0x2e02f0,saasId:_0x2586f8}=_0x2ce665,_0x14314f=(0x0,utils_1['getReqSaasId'])(this[_0x2541a4(0x2bb)]),_0x57477f={};_0x5711d8===0x0?_0x57477f['level']=(0x0,typeorm_2[_0x2541a4(0x2c2)])(_0x5711d8):_0x57477f[_0x2541a4(0x270)]=_0x5711d8;_0x2e02f0&&(_0x57477f[_0x2541a4(0x142)]=_0x2e02f0);_0x2ce665[_0x2541a4(0x1d9)]==0x1?_0x57477f[_0x2541a4(0x1d9)]=0x1:_0x57477f[_0x2541a4(0x1d9)]=0x0;(0x0,utils_1[_0x2541a4(0x295)])(this[_0x2541a4(0x2bb)])?(0x0,utils_1[_0x2541a4(0x18c)])(_0x2586f8)&&(_0x57477f[_0x2541a4(0x21b)]=_0x2586f8):_0x57477f[_0x2541a4(0x21b)]=_0x14314f;const _0x293d2b=await this[_0x2541a4(0x1c3)][_0x2541a4(0x17b)](_0x57477f)[_0x2541a4(0x234)](_0x5e7e64=>{const _0x30b708=_0x2541a4;console[_0x30b708(0x2a5)](_0x5e7e64);});if(!_0x293d2b)throw new common_1[(_0x2541a4(0x102))](_0x2541a4(0x274),common_1['HttpStatus']['BAD_REQUEST']);if(_0x5711d8===0x0)return{'level1':_0x293d2b[_0x2541a4(0x227)](_0x598f36=>_0x598f36['level']===0x1),'level2':_0x293d2b['filter'](_0x159f5a=>_0x159f5a['level']===0x2)};return _0x293d2b;}async[_0x18ccf3(0x204)](_0x4dac92){const _0x37814e=_0x18ccf3;try{const _0x2a544e=(0x0,utils_1[_0x37814e(0x14b)])(this['clsService']),{incantationEn:_0x56c3a6,incantationCn:_0x5895fb,img:_0x4532c9,pid:_0x515d59,dataType:_0x271833}=_0x4dac92;return await this['mjIncantationEntity']['save']({'incantationEn':_0x56c3a6,'incantationCn':_0x5895fb,'img':_0x4532c9,'pid':_0x515d59,'dataType':_0x271833,'saasId':_0x2a544e})[_0x37814e(0x11c)](_0x41aab3=>!!_0x41aab3)['catch'](_0x150f25=>{throw _0x150f25;});}catch(_0x493df3){return console[_0x37814e(0x2a5)](_0x493df3),![];}}async['modifyMjIncantation'](_0x28ac0c){const _0x306fe6=_0x18ccf3,{id:_0x1f8c35,incantationEn:_0x4d4a7a,incantationCn:_0x22cb48,img:_0x573826,pid:_0x220e50}=_0x28ac0c;return await this[_0x306fe6(0x2b3)]['update'](_0x1f8c35,{'incantationCn':_0x22cb48,'incantationEn':_0x4d4a7a,'img':_0x573826,'pid':_0x220e50});}async['removeMjIncantation'](_0x4de135){const _0x39f650=_0x18ccf3,{id:_0x3cad8d}=_0x4de135;return await this[_0x39f650(0x2b3)][_0x39f650(0x189)]({'id':_0x3cad8d})['then'](_0x253672=>_0x253672[_0x39f650(0xf2)]>0x0);}async[_0x18ccf3(0x184)](_0x1b9ae1){const _0x19b7f9=_0x18ccf3,{id:_0x1a1386}=_0x1b9ae1;return await this[_0x19b7f9(0x2b3)][_0x19b7f9(0x1da)]({'where':{'id':_0x1a1386}});}async[_0x18ccf3(0x2a4)](_0x19b33a){const _0x396c8e=_0x18ccf3,_0x94bb85=(0x0,utils_1[_0x396c8e(0x14b)])(this[_0x396c8e(0x2bb)]),{size:_0x1b9309,page:_0xb582c3,keyword:_0x42cdb8,pid:_0x1c1581,saasId:_0x192202}=_0x19b33a;let _0xc4bd0b={};_0x19b33a['dataType']==0x1?_0xc4bd0b[_0x396c8e(0x1d9)]=0x1:_0xc4bd0b[_0x396c8e(0x1d9)]=0x0;_0x1c1581>0x0&&(_0xc4bd0b['pid']=_0x1c1581);_0x42cdb8&&(_0xc4bd0b[_0x396c8e(0x175)]=(0x0,typeorm_2[_0x396c8e(0x1b0)])('%'+_0x42cdb8+'%'));(0x0,utils_1[_0x396c8e(0x295)])(this['clsService'])?(0x0,utils_1[_0x396c8e(0x18c)])(_0x192202)&&(_0xc4bd0b[_0x396c8e(0x21b)]=_0x192202):_0xc4bd0b['saasId']=_0x94bb85;const _0x4a35f0=await this['mjIncantationEntity'][_0x396c8e(0x1ea)]({'order':{'createdAt':'DESC'},'where':_0xc4bd0b,'take':_0x1b9309,'skip':(_0xb582c3-0x1)*_0x1b9309})[_0x396c8e(0x234)](_0x27ce1c=>{const _0x47d811=_0x396c8e;console[_0x47d811(0x2a5)](_0x27ce1c);});if(!_0x4a35f0)throw new common_1[(_0x396c8e(0x102))](_0x396c8e(0x141),common_1[_0x396c8e(0x2bf)][_0x396c8e(0x1e4)]);const [_0x29dbfe,_0x12bf8c]=_0x4a35f0;return{'rows':_0x29dbfe,'count':_0x12bf8c};}async[_0x18ccf3(0xd7)](_0x38169c){const _0x3cddfb=_0x18ccf3,{id:_0x2836e8}=_0x38169c,_0x1e212a=await this[_0x3cddfb(0x1c3)][_0x3cddfb(0x1da)]({'where':{'level':0x1,'id':_0x2836e8}})[_0x3cddfb(0x234)](_0x41a01f=>{const _0x179dc1=_0x3cddfb;common_1[_0x179dc1(0x28b)][_0x179dc1(0x251)](_0x41a01f);});if(!_0x1e212a)throw new common_1[(_0x3cddfb(0x102))](_0x3cddfb(0x21f),common_1[_0x3cddfb(0x2bf)]['BAD_REQUEST']);const _0x36dae7=await this[_0x3cddfb(0x1c3)][_0x3cddfb(0xe1)]({'where':{'level':0x2,'pid':_0x1e212a['id']}})[_0x3cddfb(0x234)](_0x16f326=>{const _0x2ee683=_0x3cddfb;common_1['Logger'][_0x2ee683(0x251)](_0x16f326);});if(!_0x36dae7||_0x36dae7[_0x3cddfb(0x24a)]===0x0)return{'rows':[]};const _0x7b0f4c=_0x36dae7[_0x3cddfb(0x17d)](_0x367240=>_0x367240['id']),_0x517a16=await this[_0x3cddfb(0x2b3)][_0x3cddfb(0xe1)]({'where':{'pid':(0x0,typeorm_2['In'])(_0x7b0f4c)}})[_0x3cddfb(0x234)](_0x2c4b0d=>{const _0x2beb21=_0x3cddfb;common_1[_0x2beb21(0x28b)][_0x2beb21(0x251)](_0x2c4b0d);});if(!_0x517a16)throw new common_1[(_0x3cddfb(0x102))](_0x3cddfb(0x141),common_1['HttpStatus'][_0x3cddfb(0x1e4)]);const _0x1e64a7=_0x36dae7[_0x3cddfb(0x17d)](_0x32046e=>{const _0x1126ba=_0x3cddfb;return{'children':_0x517a16['filter'](_0x211813=>_0x211813[_0x1126ba(0x163)]===_0x32046e['id'])||[],..._0x32046e};});return{'rows':_0x1e64a7};}async['queryMjIncantationAll'](){const _0x30ac76=_0x18ccf3,_0x46d1ae=(0x0,utils_1[_0x30ac76(0x14b)])(this[_0x30ac76(0x2bb)]),_0x9f1de1=await this[_0x30ac76(0x2b3)][_0x30ac76(0xe1)]({'where':{'saasId':_0x46d1ae},'order':{'createdAt':_0x30ac76(0x232)}})[_0x30ac76(0x234)](_0x18d77c=>{const _0xa68491=_0x30ac76;console[_0xa68491(0x2a5)](_0x18d77c);});if(!_0x9f1de1)throw new common_1[(_0x30ac76(0x102))](_0x30ac76(0x141),common_1['HttpStatus']['BAD_REQUEST']);return _0x9f1de1;}async[_0x18ccf3(0x112)](_0x34dbf8){const _0x12f643=_0x18ccf3,_0x3e83e3=(0x0,utils_1[_0x12f643(0x14b)])(this[_0x12f643(0x2bb)]),{id:_0x573856,suggestCn:_0x16bb80,suggestEn:_0xaff93f,order:_0x459602,image:_0x212286}=_0x34dbf8,_0x71bfc5=await this[_0x12f643(0x21a)][_0x12f643(0x1da)]({'where':{'suggestCn':_0x16bb80,'saasId':_0x3e83e3}});if(_0x573856){if(_0x71bfc5&&_0x71bfc5['id']!==_0x573856)throw new common_1[(_0x12f643(0x102))](_0x12f643(0x197),common_1[_0x12f643(0x2bf)][_0x12f643(0x1e4)]);}else{if(_0x71bfc5)throw new common_1[(_0x12f643(0x102))](_0x12f643(0x197),common_1[_0x12f643(0x2bf)][_0x12f643(0x1e4)]);}const _0x4a54d1=await this[_0x12f643(0x21a)][_0x12f643(0x266)]({'id':_0x573856,'suggestCn':_0x16bb80,'suggestEn':_0xaff93f,'order':_0x459602||0x64,'image':_0x212286||'','saasId':_0x3e83e3})[_0x12f643(0x11c)](_0x435d58=>!!_0x435d58['id'])['catch'](_0x535c19=>{const _0x3b71d2=_0x12f643;console[_0x3b71d2(0x2a5)](_0x535c19);});if(!_0x4a54d1)throw new common_1['HttpException']('保存推荐关键词',common_1[_0x12f643(0x2bf)]['BAD_REQUEST']);return _0x4a54d1;}async[_0x18ccf3(0x129)](_0x481830){const _0x143b84=_0x18ccf3,{id:_0x1b8d08}=_0x481830,_0x4a1377=await this[_0x143b84(0x21a)][_0x143b84(0x288)]({'where':{'id':_0x1b8d08}});if(!_0x4a1377)throw new common_1[(_0x143b84(0x102))](_0x143b84(0x226),common_1[_0x143b84(0x2bf)][_0x143b84(0x1e4)]);const _0x538f62=await this[_0x143b84(0x21a)][_0x143b84(0x189)](_0x1b8d08)[_0x143b84(0x11c)](_0x56354b=>_0x56354b[_0x143b84(0xf2)]>0x0)[_0x143b84(0x234)](_0x492154=>{console['log'](_0x492154);});if(!_0x538f62)throw new common_1[(_0x143b84(0x102))](_0x143b84(0x206),common_1[_0x143b84(0x2bf)][_0x143b84(0x1e4)]);return _0x538f62;}async[_0x18ccf3(0x151)](_0x1e91f9){const _0x2a0cc5=_0x18ccf3;let _0x1c1831={};const {page:_0x5a891b,size:_0x3db8fa,saasId:_0x4497b2}=_0x1e91f9,_0x5be804=(0x0,utils_1[_0x2a0cc5(0x14b)])(this['clsService']);(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1[_0x2a0cc5(0x18c)])(_0x4497b2)&&(_0x1c1831[_0x2a0cc5(0x21b)]=_0x4497b2):_0x1c1831[_0x2a0cc5(0x21b)]=_0x5be804;const _0x3fd73a=await this['mjSuggestWordEntity']['findAndCount']({'where':_0x1c1831,'take':_0x3db8fa,'skip':(_0x5a891b-0x1)*_0x3db8fa,'order':{'order':'DESC'}})['then'](([_0x5d8dae,_0x59ba08])=>({'rows':_0x5d8dae,'count':_0x59ba08}))[_0x2a0cc5(0x234)](_0x4b30bc=>{console['log'](_0x4b30bc);});if(!_0x3fd73a)throw new common_1['HttpException'](_0x2a0cc5(0xec),common_1['HttpStatus'][_0x2a0cc5(0x1e4)]);return _0x3fd73a;}async[_0x18ccf3(0x113)](_0x298e17,_0x47ce16){const _0x5761f5=_0x18ccf3,_0x351de1=await this[_0x5761f5(0x1b7)]({'rec':_0x298e17[_0x5761f5(0x152)],'page':_0x298e17[_0x5761f5(0xdb)],'size':_0x298e17[_0x5761f5(0x148)],'status':_0x298e17[_0x5761f5(0x1c5)],'keyword':_0x298e17['keyword'],'squareType':_0x298e17[_0x5761f5(0x19e)]},_0x47ce16);return _0x351de1[_0x5761f5(0x15c)][_0x5761f5(0x10a)](_0x40f8b3=>{const _0x561a5b=_0x5761f5;_0x40f8b3[_0x561a5b(0x220)]=_0x40f8b3[_0x561a5b(0x220)]?JSON[_0x561a5b(0xe0)](_0x40f8b3[_0x561a5b(0x220)]):{};}),_0x351de1;}[_0x18ccf3(0x10c)](_0x3f6439){const _0x12cd4f=_0x18ccf3;if(!_0x3f6439)return _0x12cd4f(0x242);if(_0x3f6439===midjourney_constant_1['DrawSpeed']['fast'])return _0x12cd4f(0x242);if(_0x3f6439===midjourney_constant_1[_0x12cd4f(0x2c9)][_0x12cd4f(0xf1)])return _0x12cd4f(0xf1);if(_0x3f6439===midjourney_constant_1[_0x12cd4f(0x2c9)][_0x12cd4f(0x2b7)])return _0x12cd4f(0x2b7);return _0x12cd4f(0x242);}async['syncWorkFlowDict'](){const _0x603b31=_0x18ccf3;if(process[_0x603b31(0x210)][_0x603b31(0x1b6)]===_0x603b31(0xf0))return;try{const _0xdecd6d=await this['czTaskService'][_0x603b31(0x18d)]({});for(let _0x1db8a4 in _0xdecd6d){let _0x3a15f1=_0x1db8a4;for(let _0x35e320=0x0;_0x35e320<_0xdecd6d[_0x1db8a4][_0x603b31(0x24a)];_0x35e320++){const _0x30b8f3=_0xdecd6d[_0x1db8a4][_0x35e320];let _0xd93e1d=await this[_0x603b31(0x13d)][_0x603b31(0x20d)](_0x3a15f1,String(_0x30b8f3['id']));_0xd93e1d?(_0xd93e1d[_0x603b31(0x198)]=_0x3a15f1,_0xd93e1d['dictName']=_0x30b8f3[_0x603b31(0x177)],_0xd93e1d[_0x603b31(0x213)]=String(_0x30b8f3['id'])):_0xd93e1d={'dictType':_0x3a15f1,'dictName':_0x30b8f3[_0x603b31(0x177)],'dictValue':String(_0x30b8f3['id'])},await this[_0x603b31(0x13d)]['save4workflow'](_0xd93e1d);}}common_1[_0x603b31(0x28b)]['log']('触站::运用领域、风格画风、作用主体、作用类别字典同步完成');}catch(_0x28e9b4){common_1[_0x603b31(0x28b)]['error'](_0x28e9b4,_0x603b31(0x23b));}}async[_0x18ccf3(0x107)](_0x2ba325){const _0x4c1616=_0x18ccf3;let _0x1ab126=[];try{const _0x4beadf=await this[_0x4c1616(0x1e6)][_0x4c1616(0x24d)]({'data':{'size':0x32,'index':0x1,'tagIds':[_0x2ba325]}});_0x1ab126=_0x1ab126[_0x4c1616(0x1a9)](_0x4beadf[_0x4c1616(0x2a9)]);for(let _0x9b26b2=0x2;_0x9b26b2<=_0x4beadf['pageCount'];_0x9b26b2++){const _0x3ec4ef=await this[_0x4c1616(0x1e6)][_0x4c1616(0x24d)]({'data':{'index':_0x9b26b2,'size':0x32,'tagIds':[_0x2ba325]}});_0x1ab126=_0x1ab126[_0x4c1616(0x1a9)](_0x3ec4ef[_0x4c1616(0x2a9)]);}return _0x1ab126;}catch(_0x19fb12){return common_1['Logger'][_0x4c1616(0x251)](_0x19fb12,_0x4c1616(0x22d)),[];}}async[_0x18ccf3(0x110)](){const _0x4bd6a3=_0x18ccf3;if(process[_0x4bd6a3(0x210)][_0x4bd6a3(0x1b6)]==='development')return;try{const _0x42e01e=await this[_0x4bd6a3(0x13d)][_0x4bd6a3(0x195)]([_0x4bd6a3(0x29d),_0x4bd6a3(0x105),'effect_main_body','application_fields']),_0x4236d8=new Map(),_0x372be9=await this['mjModelEntity'][_0x4bd6a3(0xe1)]();_0x372be9[_0x4bd6a3(0x10a)](_0x20fa80=>_0x4236d8[_0x4bd6a3(0x2cc)](_0x20fa80['id'],_0x20fa80));for(let _0x32712c=0x0;_0x32712c<_0x42e01e['length'];_0x32712c++){const _0x335bc7=_0x42e01e[_0x32712c][_0x4bd6a3(0x16d)],_0x15c8cb=Number(_0x42e01e[_0x32712c][_0x4bd6a3(0x213)]),_0x3e61ca=await this[_0x4bd6a3(0x107)](_0x15c8cb);_0x3e61ca[_0x4bd6a3(0x10a)](_0x2b3a75=>{const _0x20bbab=_0x4bd6a3,_0x5a917a=String(_0x2b3a75['id']);!_0x4236d8['has'](_0x5a917a)&&_0x4236d8[_0x20bbab(0x2cc)](_0x5a917a,{'id':_0x5a917a,'type':_0x2b3a75[_0x20bbab(0x174)],'name':_0x2b3a75[_0x20bbab(0x177)],'cover':_0x20bbab(0x1be)+_0x2b3a75[_0x20bbab(0x130)],'version':_0x2b3a75['modelVersion'],'description':'','triggerWords':_0x2b3a75[_0x20bbab(0x170)]});const _0x26b669=_0x4236d8[_0x20bbab(0x15d)](_0x5a917a);_0x42e01e[_0x32712c]['dictType']===_0x20bbab(0x29d)&&(_0x26b669['style']=_0x15c8cb,_0x26b669[_0x20bbab(0x283)]=_0x335bc7),_0x42e01e[_0x32712c][_0x20bbab(0x198)]===_0x20bbab(0x105)&&(_0x26b669[_0x20bbab(0x11a)]=_0x15c8cb,_0x26b669[_0x20bbab(0x23c)]=_0x335bc7),_0x42e01e[_0x32712c][_0x20bbab(0x198)]===_0x20bbab(0x2b9)&&(_0x26b669[_0x20bbab(0x281)]=_0x15c8cb,_0x26b669[_0x20bbab(0xfe)]=_0x335bc7),_0x42e01e[_0x32712c][_0x20bbab(0x198)]===_0x20bbab(0x1a8)&&(_0x26b669['applicationFields']=_0x15c8cb,_0x26b669['applicationFieldsName']=_0x335bc7);});}await this['mjModelEntity'][_0x4bd6a3(0x266)](Array[_0x4bd6a3(0x293)](_0x4236d8[_0x4bd6a3(0x109)]())),common_1[_0x4bd6a3(0x28b)][_0x4bd6a3(0x2a5)]('触站::模型信息同步完成');}catch(_0x57e478){common_1[_0x4bd6a3(0x28b)][_0x4bd6a3(0x251)](_0x57e478,_0x4bd6a3(0x22d));}}async['syncTaskInfo'](_0x9f54ba){const _0x2959d8=_0x18ccf3,_0x58d03c=await this[_0x2959d8(0x1ef)][_0x2959d8(0x162)]({'data':{'ids':[_0x9f54ba]}});common_1[_0x2959d8(0x28b)]['log']('Modal\x20状态\x20手动同步任务信息'),this[_0x2959d8(0x29a)](_0x58d03c[0x0]);}async['vipFreeUsed'](_0x585027){const _0x4a9044=_0x18ccf3,_0x5e555f=await this['userService'][_0x4a9044(0x1ff)](_0x585027[_0x4a9044(0x275)]['id']),_0x56525a={'fast':0x0,'relax':0x0,'trubo':0x0};let _0x832ed7=redisKey_constant_1[_0x4a9044(0x224)]+'-'+_0x5e555f['id']+'-';if(_0x5e555f[_0x4a9044(0x183)]||_0x5e555f[_0x4a9044(0x264)]){const [_0x3c92f6,_0xe655b6,_0x55d414]=await Promise[_0x4a9044(0x214)]([this[_0x4a9044(0x14f)][_0x4a9044(0x15d)]({'key':_0x832ed7+_0x4a9044(0x28a)}),this[_0x4a9044(0x14f)][_0x4a9044(0x15d)]({'key':_0x832ed7+_0x4a9044(0x273)}),this[_0x4a9044(0x14f)][_0x4a9044(0x15d)]({'key':_0x832ed7+_0x4a9044(0x1ab)})]);_0x56525a[_0x4a9044(0x242)]=Number(_0x3c92f6||0x0),_0x56525a[_0x4a9044(0xf1)]=Number(_0xe655b6||0x0),_0x56525a[_0x4a9044(0x246)]=Number(_0x55d414||0x0);}return _0x56525a;}[_0x18ccf3(0x212)](_0x19b3a1){const _0x516085=_0x18ccf3;if(typeof _0x19b3a1==='string')return midjourney_constant_1['MjpStateMap'][_0x516085(0x15d)](_0x19b3a1);if(typeof _0x19b3a1===_0x516085(0x237))return midjourney_constant_1[_0x516085(0x1a6)][_0x516085(0x15d)](_0x19b3a1);}async['notify'](_0x5a9889){const _0x3b9ee5=_0x18ccf3;common_1[_0x3b9ee5(0x28b)][_0x3b9ee5(0x2a5)](_0x5a9889,_0x3b9ee5(0x290));try{let _0x2b4201=[];const _0x2dc838=this['parseMjStatus'](_0x5a9889[_0x3b9ee5(0x1c5)]),_0x44f12b=_0x5a9889['progress']?parseFloat(_0x5a9889[_0x3b9ee5(0x19a)]):null;let _0x55c646=await this['midjourneyEntity'][_0x3b9ee5(0x1da)]({'where':{'mjpTaskId':_0x5a9889['id']}});if(_0x5a9889[_0x3b9ee5(0x1c5)]===_0x3b9ee5(0x167)&&_0x55c646['messageFlags']){common_1[_0x3b9ee5(0x28b)][_0x3b9ee5(0x2a5)](_0x3b9ee5(0x120),_0x3b9ee5(0x137));return;}_0x5a9889['buttons']&&(_0x2b4201=_0x5a9889[_0x3b9ee5(0x208)][_0x3b9ee5(0x227)](_0x22550e=>_0x22550e['label']!==_0x3b9ee5(0x144)&&_0x22550e[_0x3b9ee5(0x131)]!=='❤️'));store_1[_0x3b9ee5(0x27b)][_0x3b9ee5(0x24f)]&&_0x5a9889[_0x3b9ee5(0x1dc)]&&(_0x5a9889['imageUrl']=_0x5a9889[_0x3b9ee5(0x1dc)][_0x3b9ee5(0x271)](_0x3b9ee5(0x1a4),store_1['MjConfig'][_0x3b9ee5(0x24f)]));const _0xd3f4b5={'id':_0x55c646['id'],'status':_0x2dc838,'progress':_0x44f12b,'buttons':_0x2b4201,'durationSpent':null,'imageUrl':_0x5a9889[_0x3b9ee5(0x1dc)],'failReason':_0x5a9889['failReason']};return(_0x5a9889[_0x3b9ee5(0x239)]===_0x3b9ee5(0x165)||_0x5a9889[_0x3b9ee5(0x239)]===0x4)&&(_0xd3f4b5[_0x3b9ee5(0x26c)]=_0x5a9889[_0x3b9ee5(0x1cb)]||_0x5a9889['properties']?.[_0x3b9ee5(0x1cb)]||_0x5a9889[_0x3b9ee5(0x1df)],_0xd3f4b5['fullPrompt']=_0x5a9889[_0x3b9ee5(0x1cb)]||_0x5a9889[_0x3b9ee5(0x2d3)]?.[_0x3b9ee5(0x1cb)]||_0x5a9889[_0x3b9ee5(0x1df)]),_0x5a9889[_0x3b9ee5(0x239)]===_0x3b9ee5(0x136)&&(_0xd3f4b5[_0x3b9ee5(0x26c)]=_0x5a9889[_0x3b9ee5(0x1df)],_0xd3f4b5[_0x3b9ee5(0x115)]=_0x5a9889['promptEn']),_0x5a9889[_0x3b9ee5(0x147)]&&_0x5a9889['startTime']&&(_0xd3f4b5[_0x3b9ee5(0x180)]=(_0x5a9889[_0x3b9ee5(0x147)]-_0x5a9889[_0x3b9ee5(0x22a)])/0x3e8),_0x55c646=await this['midjourneyEntity'][_0x3b9ee5(0x266)](_0xd3f4b5),_0x5a9889[_0x3b9ee5(0x1c5)]===_0x3b9ee5(0x193)&&_0x55c646[_0x3b9ee5(0x1dc)]&&this[_0x3b9ee5(0x216)][_0x3b9ee5(0x255)](_0x55c646['id'],_0x55c646['imageUrl']),null;}catch(_0x4faae2){common_1[_0x3b9ee5(0x28b)][_0x3b9ee5(0x251)]('Mj任务通知异常:\x20',_0x4faae2);}}async['notifyWF'](_0x106a63){const _0x15b3bc=_0x18ccf3;common_1[_0x15b3bc(0x28b)]['log'](_0x106a63,_0x15b3bc(0x19c));try{const _0x20d9ec=midjourney_constant_1['CzStateMap'][_0x15b3bc(0x15d)](_0x106a63[_0x15b3bc(0x21d)]),_0x543747=Number(_0x106a63[_0x15b3bc(0x19a)])*0x64;let _0x5651e2=await this[_0x15b3bc(0x111)][_0x15b3bc(0x1da)]({'where':{'mjpTaskId':_0x106a63[_0x15b3bc(0x26d)]}});const _0x279f65={'id':_0x5651e2['id'],'status':_0x20d9ec,'progress':_0x543747,'imageUrl':_0x106a63[_0x15b3bc(0x127)]?.[_0x15b3bc(0x17d)](_0x3aa0d7=>_0x3aa0d7[_0x15b3bc(0xd6)])[_0x15b3bc(0x29f)]('↢↣')};return _0x5651e2=await this[_0x15b3bc(0x111)][_0x15b3bc(0x266)](_0x279f65),_0x5651e2[_0x15b3bc(0x1c5)]===0x3&&_0x5651e2['imageUrl']&&this['fileService'][_0x15b3bc(0x255)](_0x5651e2['id'],_0x5651e2['imageUrl']),null;}catch(_0x47bf4a){common_1[_0x15b3bc(0x28b)][_0x15b3bc(0x251)](_0x15b3bc(0x2be),_0x47bf4a);}}async[_0x18ccf3(0x2c7)](_0xc9d9fb){const _0x3e80a5=_0x18ccf3;common_1[_0x3e80a5(0x28b)][_0x3e80a5(0x2a5)](_0xc9d9fb,_0x3e80a5(0x16e));try{const _0x39b63d=midjourney_constant_1[_0x3e80a5(0x18e)]['get'](_0xc9d9fb[_0x3e80a5(0x21d)]),_0x6add8e=Number(_0xc9d9fb[_0x3e80a5(0x19a)])*0x64;let _0x3a9639=await this[_0x3e80a5(0x111)][_0x3e80a5(0x1da)]({'where':{'mjpTaskId':_0xc9d9fb[_0x3e80a5(0x26d)]}});const _0x3b62a3={'id':_0x3a9639['id'],'status':_0x39b63d,'progress':_0x6add8e,'imageUrl':_0xc9d9fb[_0x3e80a5(0x164)]?.[_0x3e80a5(0x17d)](_0xcbd5d3=>_0xcbd5d3[_0x3e80a5(0x1dc)])['join']('↢↣')};return _0x3a9639=await this['midjourneyEntity'][_0x3e80a5(0x266)](_0x3b62a3),_0x3a9639['status']===0x3&&_0x3a9639['imageUrl']&&this['fileService']['transferImg'](_0x3a9639['id'],_0x3a9639[_0x3e80a5(0x1dc)]),null;}catch(_0x35339e){common_1[_0x3e80a5(0x28b)][_0x3e80a5(0x251)](_0x3e80a5(0x2be),_0x35339e);}}async[_0x18ccf3(0xee)](){const _0x19061a=_0x18ccf3;this[_0x19061a(0x15b)](),this[_0x19061a(0x1e0)](),this[_0x19061a(0x1aa)]();}async['syncMjTask'](){const _0x489ba4=_0x18ccf3;try{const _0x2bf686=await this[_0x489ba4(0x111)]['find']({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2,0x6]),'botType':(0x0,typeorm_2['In'])([DrawTaskPage_dto_1[_0x489ba4(0x11d)][_0x489ba4(0xda)],DrawTaskPage_dto_1[_0x489ba4(0x11d)][_0x489ba4(0x16f)]])}});if(_0x2bf686[_0x489ba4(0x24a)])for(let _0x5ee054=0x0;_0x5ee054<_0x2bf686[_0x489ba4(0x24a)];_0x5ee054++){const _0xda16bf=redisKey_constant_1[_0x489ba4(0x1c8)]+_0x2bf686[_0x5ee054][_0x489ba4(0x2a6)],_0x3c527c=await this['redisCacheService'][_0x489ba4(0x15d)]({'key':_0xda16bf});if(_0x3c527c)continue;else this['redisCacheService'][_0x489ba4(0x2cc)]({'key':_0xda16bf,'val':_0x489ba4(0x1a0)}),this[_0x489ba4(0x1ef)]['listByCondition']({'data':{'ids':[_0x2bf686[_0x5ee054]['mjpTaskId']]}})['then'](async _0x4f1669=>{const _0x173e13=_0x489ba4;if(_0x4f1669&&_0x4f1669[_0x173e13(0x24a)]){const _0x4f12c0=_0x4f1669[0x0],_0x3f3b79=_0x2bf686[_0x5ee054],_0x54d48a=this[_0x173e13(0x212)](_0x4f12c0[_0x173e13(0x1c5)]),_0x37cb04=_0x4f12c0[_0x173e13(0x19a)]?parseFloat(_0x4f12c0[_0x173e13(0x19a)]):null;if(_0x3f3b79['progress']===_0x37cb04&&_0x3f3b79['status']===_0x54d48a){}else{const _0x58d83a=_0x4f12c0['buttons'][_0x173e13(0x227)](_0x4b4324=>_0x4b4324[_0x173e13(0x2d6)]!==_0x173e13(0x21e)&&_0x4b4324[_0x173e13(0x2d6)]!==_0x173e13(0x144)&&_0x4b4324['emoji']!=='❤️'),_0x49456d={'id':_0x3f3b79['id'],'mjpTaskId':_0x4f12c0['id'],'status':_0x54d48a,'progress':_0x37cb04,'buttons':_0x58d83a,'durationSpent':null,'imageUrl':_0x4f12c0[_0x173e13(0x1dc)],'failReason':_0x4f12c0[_0x173e13(0x265)]};store_1[_0x173e13(0x27b)][_0x173e13(0x24f)]&&_0x49456d[_0x173e13(0x1dc)]&&(_0x49456d[_0x173e13(0x1dc)]=_0x49456d['imageUrl'][_0x173e13(0x271)](_0x173e13(0x1a4),store_1[_0x173e13(0x27b)][_0x173e13(0x24f)])),(_0x4f12c0[_0x173e13(0x239)]===_0x173e13(0x165)||_0x4f12c0[_0x173e13(0x239)]===0x4)&&(_0x49456d[_0x173e13(0x26c)]=_0x4f12c0[_0x173e13(0x1cb)]||_0x4f12c0[_0x173e13(0x2d3)]?.[_0x173e13(0x1cb)],_0x49456d[_0x173e13(0x115)]=_0x4f12c0[_0x173e13(0x1cb)]||_0x4f12c0[_0x173e13(0x2d3)]?.[_0x173e13(0x1cb)]),_0x4f12c0[_0x173e13(0x147)]&&_0x4f12c0[_0x173e13(0x22a)]&&(_0x49456d['durationSpent']=(_0x4f12c0[_0x173e13(0x147)]-_0x4f12c0['startTime'])/0x3e8),await this[_0x173e13(0x111)][_0x173e13(0x266)](_0x49456d);}}})['catch'](_0x3d099e=>{const _0xfad666=_0x489ba4;common_1[_0xfad666(0x28b)][_0xfad666(0x251)](_0xfad666(0x17a),_0x3d099e);})[_0x489ba4(0x299)](()=>{const _0x2c389b=_0x489ba4;this[_0x2c389b(0x14f)][_0x2c389b(0xfa)]({'key':_0xda16bf});});}}catch(_0x3bc9dd){}}async['syncWfTask'](){const _0x39cf94=_0x18ccf3;try{const _0x40b758=await this[_0x39cf94(0x111)][_0x39cf94(0xe1)]({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2]),'mjpTaskId':(0x0,typeorm_2[_0x39cf94(0x2cd)])((0x0,typeorm_2['IsNull'])()),'botType':DrawTaskPage_dto_1[_0x39cf94(0x11d)][_0x39cf94(0x1e3)]}});if(_0x40b758[_0x39cf94(0x24a)])for(let _0x35088c=0x0;_0x35088c<_0x40b758[_0x39cf94(0x24a)];_0x35088c++){const _0x572b06=redisKey_constant_1[_0x39cf94(0x1c8)]+_0x40b758[_0x35088c][_0x39cf94(0x2a6)],_0x40ee26=await this[_0x39cf94(0x14f)]['get']({'key':_0x572b06});if(_0x40ee26)continue;else{this[_0x39cf94(0x14f)][_0x39cf94(0x2cc)]({'key':_0x572b06,'val':'lock'});try{const _0x153d66=await this['czTaskService'][_0x39cf94(0x126)]({'data':{'taskId':_0x40b758[_0x35088c][_0x39cf94(0x2a6)]}});this[_0x39cf94(0x1a2)](_0x153d66);}catch(_0x54261f){common_1['Logger'][_0x39cf94(0x251)](_0x39cf94(0x235),_0x54261f);}finally{this[_0x39cf94(0x14f)][_0x39cf94(0xfa)]({'key':_0x572b06});}}}}catch(_0x1a13e6){}}async['syncSdTask'](){const _0x5e9ec5=_0x18ccf3;try{const _0x17e35a=await this[_0x5e9ec5(0x111)]['find']({'where':{'status':(0x0,typeorm_2['In'])([0x1,0x2]),'botType':DrawTaskPage_dto_1[_0x5e9ec5(0x11d)]['SD']}});if(_0x17e35a['length'])for(let _0x2c2972=0x0;_0x2c2972<_0x17e35a['length'];_0x2c2972++){const _0x56bae5=redisKey_constant_1[_0x5e9ec5(0x1c8)]+_0x17e35a[_0x2c2972][_0x5e9ec5(0x2a6)],_0x115a9c=await this[_0x5e9ec5(0x14f)][_0x5e9ec5(0x15d)]({'key':_0x56bae5});if(_0x115a9c)continue;else{this['redisCacheService']['set']({'key':_0x56bae5,'val':'lock'});try{const _0x186476=await this[_0x5e9ec5(0x1e6)][_0x5e9ec5(0xf8)]({'data':{'taskId':_0x17e35a[_0x2c2972]['mjpTaskId']}});this[_0x5e9ec5(0x2c7)](_0x186476);}catch(_0x2f59df){common_1['Logger']['error']('sdTaskUpdateJob:\x20',_0x2f59df);}finally{this[_0x5e9ec5(0x14f)][_0x5e9ec5(0xfa)]({'key':_0x56bae5});}}}}catch(_0x1c5e3b){}}async[_0x18ccf3(0x2ca)](){const _0x50b193=_0x18ccf3;if(store_1['MjConfig'][_0x50b193(0x133)])return;try{const _0x318c88=[{'status':0x3,'imageUrl':(0x0,typeorm_2[_0x50b193(0x1b0)])(_0x50b193(0x24c))}];store_1[_0x50b193(0x27b)][_0x50b193(0x24f)]&&_0x318c88['push']({'status':0x3,'imageUrl':(0x0,typeorm_2[_0x50b193(0x1b0)])(store_1[_0x50b193(0x27b)][_0x50b193(0x24f)]+'%')});const _0x16e101=await this[_0x50b193(0x111)]['find']({'where':_0x318c88});if(_0x16e101[_0x50b193(0x24a)])for(let _0x43f2f1=0x0;_0x43f2f1<_0x16e101['length'];_0x43f2f1++){let {id:_0x179b2f,imageUrl:_0x40d114}=_0x16e101[_0x43f2f1];this[_0x50b193(0x216)][_0x50b193(0x255)](_0x179b2f,_0x40d114);}}catch(_0x20e6b1){common_1[_0x50b193(0x28b)][_0x50b193(0x251)](_0x20e6b1);}}async['batchTaskResult'](){const _0x4339e7=_0x18ccf3;try{const _0x172f17=store_1[_0x4339e7(0x27b)][_0x4339e7(0x217)]||0x5,_0x30ea9b=[{'status':(0x0,typeorm_2['In'])([0x2,0x4]),'isRefund':0x0,'updatedAt':(0x0,typeorm_2['LessThan'])(new Date(Date[_0x4339e7(0x199)]()-_0x172f17*0x3c*0x3e8))}],_0x5d9bb8=await this[_0x4339e7(0x111)][_0x4339e7(0xe1)]({'where':_0x30ea9b});_0x5d9bb8['forEach'](_0x42c1e0=>{const _0x1e9ba5=_0x4339e7;_0x42c1e0[_0x1e9ba5(0x1c5)]=0x4,_0x42c1e0[_0x1e9ba5(0x265)]=_0x42c1e0[_0x1e9ba5(0x265)]||'timeout',_0x42c1e0['isRefund']=0x1,this[_0x1e9ba5(0x111)][_0x1e9ba5(0x266)](_0x42c1e0),this[_0x1e9ba5(0x166)][_0x1e9ba5(0x2cf)](_0x42c1e0['userId'],_0x42c1e0[_0x1e9ba5(0x2a7)],_0x42c1e0[_0x1e9ba5(0x218)]||'Imagine',_0x42c1e0['id']);});}catch(_0x199730){common_1[_0x4339e7(0x28b)]['error'](_0x199730);}}};MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x18ccf3(0x143)])(mjModel_entity_1[_0x18ccf3(0x243)])),__param(0x1,(0x0,typeorm_1[_0x18ccf3(0x143)])(mjParam_entity_1['MjParamEntity'])),__param(0x2,(0x0,typeorm_1[_0x18ccf3(0x143)])(mjPrompts_entity_1[_0x18ccf3(0x1dd)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(midjourney_entity_1[_0x18ccf3(0x1c9)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(mjSuggestWord_entity_1[_0x18ccf3(0x247)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(mjIncantation_entity_1[_0x18ccf3(0x161)])),__param(0x6,(0x0,typeorm_1[_0x18ccf3(0x143)])(mjInspireClassify_entity_1[_0x18ccf3(0xdd)])),__param(0x7,(0x0,typeorm_1[_0x18ccf3(0x143)])(mjIncantationClassify_entity_1[_0x18ccf3(0x2ab)])),__metadata(_0x18ccf3(0x236),[typeorm_2[_0x18ccf3(0x145)],typeorm_2[_0x18ccf3(0x145)],typeorm_2['Repository'],typeorm_2[_0x18ccf3(0x145)],typeorm_2[_0x18ccf3(0x145)],typeorm_2[_0x18ccf3(0x145)],typeorm_2[_0x18ccf3(0x145)],typeorm_2[_0x18ccf3(0x145)],nestjs_cls_1[_0x18ccf3(0x2a3)],dict_service_1[_0x18ccf3(0x122)],user_service_1[_0x18ccf3(0x108)],file_service_1[_0x18ccf3(0x238)],fanyi_service_1[_0x18ccf3(0x250)],aiLog_service_1[_0x18ccf3(0x28c)],models_service_1['ModelsService'],czTask_service_1[_0x18ccf3(0x259)],mjpTask_service_1['MjpTaskService'],badwords_service_1[_0x18ccf3(0x11f)],redisCache_service_1[_0x18ccf3(0x22b)],mjpAccount_service_1[_0x18ccf3(0x194)],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x18ccf3(0x1db)]])],MidjourneyService),exports[_0x18ccf3(0x196)]=MidjourneyService;