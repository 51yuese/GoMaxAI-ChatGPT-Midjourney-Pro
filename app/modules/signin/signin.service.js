'use strict';const _0x686497=_0x17d1;function _0x120c(){const _0x5b846d=['changeScore4Other','getRawMany','425dEpiEN','toDate','endOf','andWhere','../../common/utils/date','4190DLrnTk','find','nestjs-cls','format','length','BAD_REQUEST','GlobalConfigService','function','error:\x20','phone','userService','__esModule','getDate','@nestjs/common','HttpStatus','getSigninLog','select','isSuper','month','1802084KAhgWr','24XatvVw','Repository','EChangeType','@nestjs/typeorm','30396hsDuud','签到奖励','startOf','\x20AND\x20u.saasId\x20=\x20','findOne','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','signInDate','setDate','7501472xjghHh','848554JrwiiA','email','394518TGxOBz','8GGrbed','createQueryBuilder','\x20AND\x20s.userId\x20=\x20','%\x27\x20)','globalConfigService','clsService','今日已签到、改天再来吧!.','getReqSaasId','../../common/constants/balance.constant','HttpException','../../common/utils','InjectRepository','signin.signInTime\x20>=\x20:firstDay','save','28726jyaRxk','SigninService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','__param','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','YYYY-MM-DD\x20HH:mm:ss','\x20AND\x20s.createdAt\x20<=\x20\x27','../user/user.service','getUserById','user','YYYY-MM-DD','\x20OFFSET\x20','forEach','./../globalConfig/globalConfig.service','__metadata','2727DyYIkT','ClsService','decorate','typeorm','design:paramtypes','object','昨天签到了、今天是连续签到！','metadata','\x20AND\x20s.createdAt\x20>=\x20\x27','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getSignatureGiftConfig','updateSignDay','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','day','getOwnPropertyDescriptor','用户不存在','count','./signIn.entity','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','isDefined','Injectable','debug','__decorate','default','signinEntity','\x0a\x20\x20\x20\x20','push','SigninEntity','signin','Connection','query','maskEmail','defineProperty','connection','SignInReward','获取签到数据失败！','昨天没签到、今天重置天数！'];_0x120c=function(){return _0x5b846d;};return _0x120c();}(function(_0x215dd7,_0x157bfc){const _0x1c8d37=_0x17d1,_0xcb3c05=_0x215dd7();while(!![]){try{const _0xf34c41=-parseInt(_0x1c8d37(0x1ab))/0x1+parseInt(_0x1c8d37(0x19d))/0x2*(-parseInt(_0x1c8d37(0x19c))/0x3)+-parseInt(_0x1c8d37(0x18c))/0x4+parseInt(_0x1c8d37(0x174))/0x5*(parseInt(_0x1c8d37(0x191))/0x6)+parseInt(_0x1c8d37(0x19a))/0x7*(parseInt(_0x1c8d37(0x18d))/0x8)+parseInt(_0x1c8d37(0x1ba))/0x9*(-parseInt(_0x1c8d37(0x179))/0xa)+parseInt(_0x1c8d37(0x199))/0xb;if(_0xf34c41===_0x157bfc)break;else _0xcb3c05['push'](_0xcb3c05['shift']());}catch(_0x49b9a0){_0xcb3c05['push'](_0xcb3c05['shift']());}}}(_0x120c,0x53fc0));var __decorate=this&&this[_0x686497(0x163)]||function(_0x83bb1,_0x139646,_0x565622,_0x3d5e55){const _0x4e1959=_0x686497;var _0x5ba664=arguments[_0x4e1959(0x17d)],_0x1c5c25=_0x5ba664<0x3?_0x139646:_0x3d5e55===null?_0x3d5e55=Object[_0x4e1959(0x15b)](_0x139646,_0x565622):_0x3d5e55,_0x27218d;if(typeof Reflect==='object'&&typeof Reflect[_0x4e1959(0x1bc)]===_0x4e1959(0x180))_0x1c5c25=Reflect[_0x4e1959(0x1bc)](_0x83bb1,_0x139646,_0x565622,_0x3d5e55);else{for(var _0x592820=_0x83bb1[_0x4e1959(0x17d)]-0x1;_0x592820>=0x0;_0x592820--)if(_0x27218d=_0x83bb1[_0x592820])_0x1c5c25=(_0x5ba664<0x3?_0x27218d(_0x1c5c25):_0x5ba664>0x3?_0x27218d(_0x139646,_0x565622,_0x1c5c25):_0x27218d(_0x139646,_0x565622))||_0x1c5c25;}return _0x5ba664>0x3&&_0x1c5c25&&Object[_0x4e1959(0x16d)](_0x139646,_0x565622,_0x1c5c25),_0x1c5c25;},__metadata=this&&this[_0x686497(0x1b9)]||function(_0x57d183,_0x5d1797){const _0x2248f2=_0x686497;if(typeof Reflect===_0x2248f2(0x152)&&typeof Reflect[_0x2248f2(0x154)]===_0x2248f2(0x180))return Reflect['metadata'](_0x57d183,_0x5d1797);},__param=this&&this[_0x686497(0x1ae)]||function(_0x2e7486,_0x53145e){return function(_0x2ab5f8,_0x2403fb){_0x53145e(_0x2ab5f8,_0x2403fb,_0x2e7486);};};Object['defineProperty'](exports,_0x686497(0x184),{'value':!![]}),exports[_0x686497(0x1ac)]=void 0x0;const globalConfig_service_1=require(_0x686497(0x1b8)),common_1=require(_0x686497(0x186)),signIn_entity_1=require(_0x686497(0x15e)),typeorm_1=require(_0x686497(0x190)),typeorm_2=require(_0x686497(0x1bd)),date_1=require(_0x686497(0x178)),balance_constant_1=require(_0x686497(0x1a5)),user_service_1=require(_0x686497(0x1b2)),utils_1=require(_0x686497(0x1a7)),nestjs_cls_1=require(_0x686497(0x17b));let SigninService=class SigninService{constructor(_0x489c35,_0x157f83,_0x5e3e10,_0x1940d2,_0x1c793d){const _0x42ce27=_0x686497;this[_0x42ce27(0x165)]=_0x489c35,this[_0x42ce27(0x1a2)]=_0x157f83,this[_0x42ce27(0x183)]=_0x5e3e10,this[_0x42ce27(0x1a1)]=_0x1940d2,this[_0x42ce27(0x16e)]=_0x1c793d;}async['sign'](_0x4bd586){const _0x56ebaa=_0x686497,_0x585e81=_0x4bd586[_0x56ebaa(0x1b4)]['id'],_0x13021d=await this[_0x56ebaa(0x183)][_0x56ebaa(0x1b3)](_0x585e81),_0x4252e4=(0x0,date_1[_0x56ebaa(0x164)])()[_0x56ebaa(0x17c)]('YYYY-MM-DD'),_0xe901be=await this['signinEntity'][_0x56ebaa(0x195)]({'where':{'userId':_0x585e81,'signInDate':_0x4252e4}});if(_0xe901be)throw new common_1[(_0x56ebaa(0x1a6))](_0x56ebaa(0x1a3),common_1['HttpStatus']['BAD_REQUEST']);const _0x46fa4f=await this[_0x56ebaa(0x165)][_0x56ebaa(0x1aa)]({'userId':_0x585e81,'signInTime':(0x0,date_1[_0x56ebaa(0x164)])()['toDate'](),'signInDate':_0x4252e4,'isSigned':!![]}),_0x162b4f=await this[_0x56ebaa(0x1a1)][_0x56ebaa(0x157)]();_0x162b4f&&await this['userService'][_0x56ebaa(0x172)](_0x13021d,balance_constant_1[_0x56ebaa(0x18f)][_0x56ebaa(0x16f)],_0x162b4f,_0x56ebaa(0x192),_0x46fa4f['id']);const _0x77afe8=(0x0,date_1['default'])()['subtract'](0x1,_0x56ebaa(0x15a))[_0x56ebaa(0x17c)](_0x56ebaa(0x1b5)),_0x19f73e=await this[_0x56ebaa(0x165)][_0x56ebaa(0x195)]({'where':{'userId':_0x585e81,'signInDate':_0x77afe8}});if(_0x19f73e){common_1['Logger'][_0x56ebaa(0x162)]('用户'+_0x585e81+_0x56ebaa(0x153),_0x56ebaa(0x1ac));const _0x125e89=await this[_0x56ebaa(0x183)]['getUserById'](_0x585e81);if(!_0x125e89)throw new common_1[(_0x56ebaa(0x1a6))](_0x56ebaa(0x15c),common_1[_0x56ebaa(0x187)][_0x56ebaa(0x17e)]);const {consecutiveDays:consecutiveDays=0x0}=_0x125e89;await this[_0x56ebaa(0x183)]['updateSignDay'](_0x585e81,consecutiveDays+0x1);}else common_1['Logger']['debug']('用户'+_0x585e81+_0x56ebaa(0x171),_0x56ebaa(0x1ac)),await this[_0x56ebaa(0x183)][_0x56ebaa(0x158)](_0x585e81,0x1);return _0x162b4f;}async[_0x686497(0x188)](_0x4c2eac){const _0x193782=_0x686497;try{const _0x448220=(0x0,date_1[_0x193782(0x164)])()[_0x193782(0x193)](_0x193782(0x18b))[_0x193782(0x17c)](_0x193782(0x1b0)),_0xc372a6=(0x0,date_1['default'])()[_0x193782(0x176)]('month')['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x36938c=this[_0x193782(0x165)][_0x193782(0x19e)](_0x193782(0x169)),_0x19b6c3=await _0x36938c[_0x193782(0x189)](_0x193782(0x159))[_0x193782(0x177)]('signin.userId\x20=\x20:userId',{'userId':_0x4c2eac[_0x193782(0x1b4)]['id']})[_0x193782(0x177)](_0x193782(0x1a9),{'firstDay':_0x448220})[_0x193782(0x177)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0xc372a6})[_0x193782(0x173)](),_0x12e8f8=(0x0,date_1[_0x193782(0x164)])(_0x448220)[_0x193782(0x175)](),_0x20d1e0=(0x0,date_1[_0x193782(0x164)])(_0xc372a6)[_0x193782(0x175)](),_0x407c0e=[],_0x3e25c8=(0x0,date_1[_0x193782(0x164)])(_0x12e8f8)[_0x193782(0x175)]();while(_0x3e25c8<=_0x20d1e0){_0x407c0e[_0x193782(0x167)]((0x0,date_1['default'])((0x0,date_1[_0x193782(0x164)])(_0x3e25c8))[_0x193782(0x17c)](_0x193782(0x1b5))),_0x3e25c8[_0x193782(0x198)](_0x3e25c8[_0x193782(0x185)]()+0x1);}const _0x3f5695=[];for(const _0x4582a6 of _0x407c0e){const _0x595370=_0x19b6c3[_0x193782(0x17a)](_0x46d9bb=>_0x46d9bb[_0x193782(0x197)]===_0x4582a6);!_0x595370?_0x3f5695['push']({'signInDate':_0x4582a6,'isSigned':![]}):(_0x595370['isSigned']=!![],_0x3f5695[_0x193782(0x167)](_0x595370));}return _0x3f5695;}catch(_0x130bc7){console['log'](_0x193782(0x181),_0x130bc7);throw new common_1[(_0x193782(0x1a6))](_0x193782(0x170),common_1[_0x193782(0x187)][_0x193782(0x17e)]);}}async['userPage'](_0x163c53,_0x1315a6,_0x373af3){const _0x24a922=_0x686497,_0x2e3869=(0x0,utils_1[_0x24a922(0x1a4)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0x54da89,endTime:_0x436a8c,saasId:_0xc171b4,keyword:_0x6d4323}=_0x1315a6,_0x109c59=_0x24a922(0x156)+(_0x373af3?_0x24a922(0x19f)+_0x373af3:'')+_0x24a922(0x196)+(_0x54da89?_0x24a922(0x155)+_0x54da89+'\x27':'')+_0x24a922(0x196)+(_0x436a8c?_0x24a922(0x1b1)+_0x436a8c+'\x27':'')+_0x24a922(0x196)+(_0x2e3869!==0x0?_0x24a922(0x194)+_0x2e3869:(0x0,utils_1[_0x24a922(0x160)])(_0xc171b4)?'\x20AND\x20u.saasId\x20=\x20'+_0xc171b4:'')+_0x24a922(0x196)+(_0x6d4323?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x6d4323+'%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%'+_0x6d4323+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x6d4323+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x6d4323+_0x24a922(0x1a0):'')+_0x24a922(0x166),_0x940029=_0x24a922(0x1af)+_0x109c59+_0x24a922(0x166),_0x3522a2=_0x24a922(0x1ad)+_0x109c59+_0x24a922(0x15f)+size+_0x24a922(0x1b6)+(page-0x1)*size+_0x24a922(0x166),_0x16ab79=await this[_0x24a922(0x16e)][_0x24a922(0x16b)](_0x940029),_0x32e162=await this[_0x24a922(0x16e)][_0x24a922(0x16b)](_0x3522a2);return!(0x0,utils_1[_0x24a922(0x18a)])(this[_0x24a922(0x1a2)])&&_0x32e162[_0x24a922(0x1b7)](_0x1b6452=>{const _0x135af4=_0x24a922;_0x1b6452[_0x135af4(0x19b)]=(0x0,utils_1[_0x135af4(0x16c)])(_0x1b6452[_0x135af4(0x19b)]),_0x1b6452[_0x135af4(0x182)]=(0x0,utils_1[_0x135af4(0x16c)])(_0x1b6452[_0x135af4(0x182)]);}),{'rows':_0x32e162,'count':Number(_0x16ab79[0x0]?.[_0x24a922(0x15d)]||0x0)};}};function _0x17d1(_0x4f513d,_0x5a5cc4){const _0x120c64=_0x120c();return _0x17d1=function(_0x17d19e,_0x16b73f){_0x17d19e=_0x17d19e-0x152;let _0x4e06b5=_0x120c64[_0x17d19e];return _0x4e06b5;},_0x17d1(_0x4f513d,_0x5a5cc4);}SigninService=__decorate([(0x0,common_1[_0x686497(0x161)])(),__param(0x0,(0x0,typeorm_1[_0x686497(0x1a8)])(signIn_entity_1[_0x686497(0x168)])),__metadata(_0x686497(0x1be),[typeorm_2[_0x686497(0x18e)],nestjs_cls_1[_0x686497(0x1bb)],user_service_1['UserService'],globalConfig_service_1[_0x686497(0x17f)],typeorm_2[_0x686497(0x16a)]])],SigninService),exports[_0x686497(0x1ac)]=SigninService;