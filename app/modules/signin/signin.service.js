'use strict';const _0x15345b=_0x4f0d;(function(_0x2a59e2,_0x13e01d){const _0x2cba40=_0x4f0d,_0x17b10f=_0x2a59e2();while(!![]){try{const _0x4843f8=parseInt(_0x2cba40(0x20e))/0x1*(parseInt(_0x2cba40(0x217))/0x2)+-parseInt(_0x2cba40(0x1ef))/0x3+parseInt(_0x2cba40(0x1db))/0x4+parseInt(_0x2cba40(0x233))/0x5+-parseInt(_0x2cba40(0x209))/0x6+-parseInt(_0x2cba40(0x21d))/0x7+-parseInt(_0x2cba40(0x222))/0x8*(-parseInt(_0x2cba40(0x1fe))/0x9);if(_0x4843f8===_0x13e01d)break;else _0x17b10f['push'](_0x17b10f['shift']());}catch(_0x57e34d){_0x17b10f['push'](_0x17b10f['shift']());}}}(_0x1d1e,0xd8991));var __decorate=this&&this[_0x15345b(0x234)]||function(_0x28a2e4,_0x386664,_0x2e583e,_0x4673a0){const _0x3703e9=_0x15345b;var _0x431c9a=arguments[_0x3703e9(0x207)],_0x584db8=_0x431c9a<0x3?_0x386664:_0x4673a0===null?_0x4673a0=Object[_0x3703e9(0x1fc)](_0x386664,_0x2e583e):_0x4673a0,_0x185c55;if(typeof Reflect===_0x3703e9(0x1ee)&&typeof Reflect[_0x3703e9(0x22e)]===_0x3703e9(0x1f5))_0x584db8=Reflect['decorate'](_0x28a2e4,_0x386664,_0x2e583e,_0x4673a0);else{for(var _0x4e948d=_0x28a2e4[_0x3703e9(0x207)]-0x1;_0x4e948d>=0x0;_0x4e948d--)if(_0x185c55=_0x28a2e4[_0x4e948d])_0x584db8=(_0x431c9a<0x3?_0x185c55(_0x584db8):_0x431c9a>0x3?_0x185c55(_0x386664,_0x2e583e,_0x584db8):_0x185c55(_0x386664,_0x2e583e))||_0x584db8;}return _0x431c9a>0x3&&_0x584db8&&Object['defineProperty'](_0x386664,_0x2e583e,_0x584db8),_0x584db8;},__metadata=this&&this[_0x15345b(0x1de)]||function(_0x571b5e,_0x1d0688){const _0x30a026=_0x15345b;if(typeof Reflect===_0x30a026(0x1ee)&&typeof Reflect[_0x30a026(0x224)]===_0x30a026(0x1f5))return Reflect[_0x30a026(0x224)](_0x571b5e,_0x1d0688);},__param=this&&this[_0x15345b(0x229)]||function(_0x50df5d,_0x24da97){return function(_0x4494fb,_0x3d8798){_0x24da97(_0x4494fb,_0x3d8798,_0x50df5d);};};function _0x4f0d(_0x12efe7,_0x466339){const _0x1d1e8c=_0x1d1e();return _0x4f0d=function(_0x4f0d5e,_0x37d3fd){_0x4f0d5e=_0x4f0d5e-0x1da;let _0x46a8cc=_0x1d1e8c[_0x4f0d5e];return _0x46a8cc;},_0x4f0d(_0x12efe7,_0x466339);}Object[_0x15345b(0x21f)](exports,'__esModule',{'value':!![]}),exports[_0x15345b(0x1e3)]=void 0x0;const globalConfig_service_1=require(_0x15345b(0x1dd)),common_1=require(_0x15345b(0x215)),signIn_entity_1=require(_0x15345b(0x21b)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),date_1=require('../../common/utils/date'),balance_constant_1=require('../../common/constants/balance.constant'),user_service_1=require(_0x15345b(0x213)),utils_1=require(_0x15345b(0x226)),nestjs_cls_1=require('nestjs-cls');let SigninService=class SigninService{constructor(_0x28062a,_0x40ee3f,_0x17a7da,_0x156ca7,_0x40e0af){const _0x3be631=_0x15345b;this[_0x3be631(0x206)]=_0x28062a,this['clsService']=_0x40ee3f,this['userService']=_0x17a7da,this[_0x3be631(0x1ff)]=_0x156ca7,this[_0x3be631(0x238)]=_0x40e0af;}async[_0x15345b(0x203)](_0x37892b){const _0x57eda5=_0x15345b,_0x1d9a9e=_0x37892b['user']['id'],_0xf240e=await this[_0x57eda5(0x1e2)][_0x57eda5(0x1e8)](_0x1d9a9e),_0x5b9e7a=(0x0,date_1[_0x57eda5(0x227)])()[_0x57eda5(0x1fb)](_0x57eda5(0x1eb)),_0x9f5655=await this['signinEntity'][_0x57eda5(0x1e5)]({'where':{'userId':_0x1d9a9e,'signInDate':_0x5b9e7a}});if(_0x9f5655)throw new common_1[(_0x57eda5(0x22b))]('今日已签到、改天再来吧!.',common_1['HttpStatus'][_0x57eda5(0x1e7)]);const _0x17e8f5=await this[_0x57eda5(0x206)][_0x57eda5(0x1e9)]({'userId':_0x1d9a9e,'signInTime':(0x0,date_1[_0x57eda5(0x227)])()[_0x57eda5(0x212)](),'signInDate':_0x5b9e7a,'isSigned':!![]}),_0xc022b5=await this['globalConfigService'][_0x57eda5(0x1e6)]();_0xc022b5&&await this[_0x57eda5(0x1e2)][_0x57eda5(0x1f8)](_0xf240e,balance_constant_1[_0x57eda5(0x1f4)][_0x57eda5(0x202)],_0xc022b5,_0x57eda5(0x21e),_0x17e8f5['id']);const _0x361545=(0x0,date_1[_0x57eda5(0x227)])()[_0x57eda5(0x1e0)](0x1,'day')[_0x57eda5(0x1fb)](_0x57eda5(0x1eb)),_0xefbb1b=await this[_0x57eda5(0x206)][_0x57eda5(0x1e5)]({'where':{'userId':_0x1d9a9e,'signInDate':_0x361545}});if(_0xefbb1b){common_1['Logger']['debug']('用户'+_0x1d9a9e+_0x57eda5(0x228),'SigninService');const _0x4ee45c=await this[_0x57eda5(0x1e2)][_0x57eda5(0x1e8)](_0x1d9a9e);if(!_0x4ee45c)throw new common_1[(_0x57eda5(0x22b))]('用户不存在',common_1[_0x57eda5(0x208)][_0x57eda5(0x1e7)]);const {consecutiveDays:consecutiveDays=0x0}=_0x4ee45c;await this[_0x57eda5(0x1e2)]['updateSignDay'](_0x1d9a9e,consecutiveDays+0x1);}else common_1[_0x57eda5(0x221)][_0x57eda5(0x21a)]('用户'+_0x1d9a9e+_0x57eda5(0x232),_0x57eda5(0x1e3)),await this[_0x57eda5(0x1e2)]['updateSignDay'](_0x1d9a9e,0x1);return _0xc022b5;}async[_0x15345b(0x21c)](_0x50ce3b){const _0x3eafb0=_0x15345b;try{const _0x2d7727=(0x0,date_1[_0x3eafb0(0x227)])()[_0x3eafb0(0x1f2)](_0x3eafb0(0x231))[_0x3eafb0(0x1fb)]('YYYY-MM-DD\x20HH:mm:ss'),_0x5bea65=(0x0,date_1[_0x3eafb0(0x227)])()[_0x3eafb0(0x1f7)](_0x3eafb0(0x231))['format'](_0x3eafb0(0x1ec)),_0x304bed=this[_0x3eafb0(0x206)][_0x3eafb0(0x211)](_0x3eafb0(0x1f0)),_0x132d7d=await _0x304bed[_0x3eafb0(0x218)](_0x3eafb0(0x22a))[_0x3eafb0(0x22d)](_0x3eafb0(0x223),{'userId':_0x50ce3b[_0x3eafb0(0x214)]['id']})['andWhere']('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x2d7727})[_0x3eafb0(0x22d)]('signin.signInTime\x20<=\x20:lastDay',{'lastDay':_0x5bea65})[_0x3eafb0(0x20b)](),_0x5d54f8=(0x0,date_1['default'])(_0x2d7727)[_0x3eafb0(0x212)](),_0x3b1994=(0x0,date_1[_0x3eafb0(0x227)])(_0x5bea65)[_0x3eafb0(0x212)](),_0x2f1f24=[],_0x407890=(0x0,date_1['default'])(_0x5d54f8)[_0x3eafb0(0x212)]();while(_0x407890<=_0x3b1994){_0x2f1f24[_0x3eafb0(0x219)]((0x0,date_1[_0x3eafb0(0x227)])((0x0,date_1[_0x3eafb0(0x227)])(_0x407890))[_0x3eafb0(0x1fb)](_0x3eafb0(0x1eb))),_0x407890['setDate'](_0x407890[_0x3eafb0(0x1df)]()+0x1);}const _0x15e1ec=[];for(const _0x22d022 of _0x2f1f24){const _0x58156d=_0x132d7d[_0x3eafb0(0x1f3)](_0x74996a=>_0x74996a[_0x3eafb0(0x1e1)]===_0x22d022);!_0x58156d?_0x15e1ec[_0x3eafb0(0x219)]({'signInDate':_0x22d022,'isSigned':![]}):(_0x58156d['isSigned']=!![],_0x15e1ec[_0x3eafb0(0x219)](_0x58156d));}return _0x15e1ec;}catch(_0x429063){console[_0x3eafb0(0x235)](_0x3eafb0(0x201),_0x429063);throw new common_1[(_0x3eafb0(0x22b))]('获取签到数据失败！',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x15345b(0x20a)](_0x260b1d,_0x2449e8,_0x3f0557){const _0x2679d5=_0x15345b,_0x3d1d0=(0x0,utils_1[_0x2679d5(0x1da)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0x406ee1,endTime:_0x2aa0be,saasId:_0x18f9e1,keyword:_0x113751}=_0x2449e8,_0x368821='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3f0557?_0x2679d5(0x210)+_0x3f0557:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x406ee1?_0x2679d5(0x22f)+_0x406ee1+'\x27':'')+_0x2679d5(0x1f1)+(_0x2aa0be?'\x20AND\x20s.createdAt\x20<=\x20\x27'+_0x2aa0be+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3d1d0!==0x0?_0x2679d5(0x1f6)+_0x3d1d0:(0x0,utils_1[_0x2679d5(0x20c)])(_0x18f9e1)?_0x2679d5(0x1f6)+_0x18f9e1:'')+_0x2679d5(0x1f1)+(_0x113751?_0x2679d5(0x20d)+_0x113751+'%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%'+_0x113751+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x113751+_0x2679d5(0x20f)+_0x113751+_0x2679d5(0x1ea):'')+_0x2679d5(0x230),_0x2c49f2='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x368821+_0x2679d5(0x230),_0x171f65=_0x2679d5(0x220)+_0x368821+_0x2679d5(0x204)+size+_0x2679d5(0x200)+(page-0x1)*size+_0x2679d5(0x230),_0x257221=await this[_0x2679d5(0x238)][_0x2679d5(0x1f9)](_0x2c49f2),_0x2c9bc0=await this[_0x2679d5(0x238)][_0x2679d5(0x1f9)](_0x171f65);return!(0x0,utils_1[_0x2679d5(0x1fd)])(this['clsService'])&&_0x2c9bc0[_0x2679d5(0x205)](_0x387ea0=>{const _0x27a799=_0x2679d5;_0x387ea0[_0x27a799(0x1e4)]=(0x0,utils_1[_0x27a799(0x225)])(_0x387ea0['email']),_0x387ea0[_0x27a799(0x1dc)]=(0x0,utils_1[_0x27a799(0x225)])(_0x387ea0[_0x27a799(0x1dc)]);}),{'rows':_0x2c9bc0,'count':Number(_0x257221[0x0]?.[_0x2679d5(0x1fa)]||0x0)};}};SigninService=__decorate([(0x0,common_1[_0x15345b(0x22c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x15345b(0x237)])),__metadata(_0x15345b(0x216),[typeorm_2[_0x15345b(0x1ed)],nestjs_cls_1['ClsService'],user_service_1[_0x15345b(0x236)],globalConfig_service_1['GlobalConfigService'],typeorm_2['Connection']])],SigninService),exports[_0x15345b(0x1e3)]=SigninService;function _0x1d1e(){const _0x1c910d=['default','昨天签到了、今天是连续签到！','__param','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','HttpException','Injectable','andWhere','decorate','\x20AND\x20s.createdAt\x20>=\x20\x27','\x0a\x20\x20\x20\x20','month','昨天没签到、今天重置天数！','941005NialCA','__decorate','log','UserService','SigninEntity','connection','getReqSaasId','4945056bazsfa','phone','./../globalConfig/globalConfig.service','__metadata','getDate','subtract','signInDate','userService','SigninService','email','findOne','getSignatureGiftConfig','BAD_REQUEST','getUserById','save','%\x27\x20)','YYYY-MM-DD','YYYY-MM-DD\x20HH:mm:ss','Repository','object','4684911WrBvXy','signin','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','startOf','find','EChangeType','function','\x20AND\x20u.saasId\x20=\x20','endOf','changeScore4Other','query','count','format','getOwnPropertyDescriptor','isSuper','4591917gSxoAj','globalConfigService','\x20OFFSET\x20','error:\x20','SignInReward','sign','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','forEach','signinEntity','length','HttpStatus','4597950bpvIPP','userPage','getRawMany','isDefined','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','1bALDJy','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','\x20AND\x20s.userId\x20=\x20','createQueryBuilder','toDate','../user/user.service','user','@nestjs/common','design:paramtypes','1478000uMrmMp','select','push','debug','./signIn.entity','getSigninLog','3352699jVQKpM','签到奖励','defineProperty','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','Logger','24MMzJyI','signin.userId\x20=\x20:userId','metadata','maskEmail','../../common/utils'];_0x1d1e=function(){return _0x1c910d;};return _0x1d1e();}