'use strict';const _0x174d96=_0x3bec;(function(_0xd4a244,_0xbeb6f3){const _0x317246=_0x3bec,_0x5e6942=_0xd4a244();while(!![]){try{const _0x27401f=-parseInt(_0x317246(0xb8))/0x1*(-parseInt(_0x317246(0xcc))/0x2)+-parseInt(_0x317246(0xf2))/0x3+-parseInt(_0x317246(0xec))/0x4*(-parseInt(_0x317246(0xa2))/0x5)+parseInt(_0x317246(0xcd))/0x6+parseInt(_0x317246(0xd7))/0x7+-parseInt(_0x317246(0xbc))/0x8+-parseInt(_0x317246(0xbd))/0x9;if(_0x27401f===_0xbeb6f3)break;else _0x5e6942['push'](_0x5e6942['shift']());}catch(_0x5c303f){_0x5e6942['push'](_0x5e6942['shift']());}}}(_0x5f45,0xd4da1));function _0x3bec(_0x1bd803,_0x2ee5c8){const _0x5f4537=_0x5f45();return _0x3bec=function(_0x3becea,_0x16b513){_0x3becea=_0x3becea-0x93;let _0x4f91c1=_0x5f4537[_0x3becea];return _0x4f91c1;},_0x3bec(_0x1bd803,_0x2ee5c8);}var __decorate=this&&this['__decorate']||function(_0x28301c,_0x4adb1e,_0x24fe3b,_0x56797d){const _0x4d70a6=_0x3bec;var _0x2d1bb9=arguments['length'],_0x5be9fc=_0x2d1bb9<0x3?_0x4adb1e:_0x56797d===null?_0x56797d=Object['getOwnPropertyDescriptor'](_0x4adb1e,_0x24fe3b):_0x56797d,_0x1c894f;if(typeof Reflect===_0x4d70a6(0xa0)&&typeof Reflect[_0x4d70a6(0xf3)]===_0x4d70a6(0xe0))_0x5be9fc=Reflect['decorate'](_0x28301c,_0x4adb1e,_0x24fe3b,_0x56797d);else{for(var _0x457c6f=_0x28301c[_0x4d70a6(0xe5)]-0x1;_0x457c6f>=0x0;_0x457c6f--)if(_0x1c894f=_0x28301c[_0x457c6f])_0x5be9fc=(_0x2d1bb9<0x3?_0x1c894f(_0x5be9fc):_0x2d1bb9>0x3?_0x1c894f(_0x4adb1e,_0x24fe3b,_0x5be9fc):_0x1c894f(_0x4adb1e,_0x24fe3b))||_0x5be9fc;}return _0x2d1bb9>0x3&&_0x5be9fc&&Object[_0x4d70a6(0xd8)](_0x4adb1e,_0x24fe3b,_0x5be9fc),_0x5be9fc;},__metadata=this&&this[_0x174d96(0xf5)]||function(_0x493146,_0x4c9d9d){const _0x3ab696=_0x174d96;if(typeof Reflect===_0x3ab696(0xa0)&&typeof Reflect['metadata']===_0x3ab696(0xe0))return Reflect[_0x3ab696(0xd6)](_0x493146,_0x4c9d9d);},__param=this&&this[_0x174d96(0xcf)]||function(_0x1c2acf,_0x58feb4){return function(_0x58f82f,_0x13b395){_0x58feb4(_0x58f82f,_0x13b395,_0x1c2acf);};};Object[_0x174d96(0xd8)](exports,'__esModule',{'value':!![]}),exports[_0x174d96(0xdd)]=void 0x0;const globalConfig_service_1=require(_0x174d96(0x9c)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x174d96(0xea)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x174d96(0xca)),date_1=require('../../common/utils/date'),balance_constant_1=require(_0x174d96(0xf0)),user_service_1=require('../user/user.service'),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x174d96(0xd9));let SigninService=class SigninService{constructor(_0x322cc5,_0x136ad8,_0x27494a,_0x54556a,_0x5342fa){const _0x4b41d3=_0x174d96;this['signinEntity']=_0x322cc5,this[_0x4b41d3(0xba)]=_0x136ad8,this[_0x4b41d3(0xb1)]=_0x27494a,this[_0x4b41d3(0xae)]=_0x54556a,this[_0x4b41d3(0x99)]=_0x5342fa;}async[_0x174d96(0xe3)](_0x1ea17f){const _0x350ace=_0x174d96,_0x4d0dd7=_0x1ea17f[_0x350ace(0xcb)]['id'],_0x8fcc55=await this[_0x350ace(0xb1)][_0x350ace(0xee)](_0x4d0dd7),_0x15fd16=(0x0,date_1[_0x350ace(0xb2)])()[_0x350ace(0xa1)]('YYYY-MM-DD'),_0x2a850c=await this[_0x350ace(0xeb)][_0x350ace(0xb0)]({'where':{'userId':_0x4d0dd7,'signInDate':_0x15fd16}});if(_0x2a850c)throw new common_1[(_0x350ace(0xef))](_0x350ace(0xd5),common_1[_0x350ace(0xc3)][_0x350ace(0xe2)]);const _0x5e3df6=await this[_0x350ace(0xeb)]['save']({'userId':_0x4d0dd7,'signInTime':(0x0,date_1[_0x350ace(0xb2)])()[_0x350ace(0xda)](),'signInDate':_0x15fd16,'isSigned':!![]}),_0x50776e=await this['globalConfigService'][_0x350ace(0xbb)]();_0x50776e&&await this['userService'][_0x350ace(0xe9)](_0x8fcc55,balance_constant_1['EChangeType']['SignInReward'],_0x50776e,_0x350ace(0xc5),_0x5e3df6['id']);const _0x3c7d6e=(0x0,date_1[_0x350ace(0xb2)])()[_0x350ace(0x9d)](0x1,'day')['format'](_0x350ace(0xbf)),_0x63fd6f=await this[_0x350ace(0xeb)][_0x350ace(0xb0)]({'where':{'userId':_0x4d0dd7,'signInDate':_0x3c7d6e}});if(_0x63fd6f){common_1[_0x350ace(0x93)][_0x350ace(0x9f)]('用户'+_0x4d0dd7+'昨天签到了、今天是连续签到！',_0x350ace(0xdd));const _0x5b2250=await this[_0x350ace(0xb1)][_0x350ace(0xee)](_0x4d0dd7);if(!_0x5b2250)throw new common_1[(_0x350ace(0xef))]('用户不存在',common_1[_0x350ace(0xc3)][_0x350ace(0xe2)]);const {consecutiveDays:consecutiveDays=0x0}=_0x5b2250;await this[_0x350ace(0xb1)]['updateSignDay'](_0x4d0dd7,consecutiveDays+0x1);}else common_1[_0x350ace(0x93)][_0x350ace(0x9f)]('用户'+_0x4d0dd7+_0x350ace(0xc6),_0x350ace(0xdd)),await this[_0x350ace(0xb1)][_0x350ace(0xd2)](_0x4d0dd7,0x1);return _0x50776e;}async[_0x174d96(0xdb)](_0x280cdd){const _0x4abdd3=_0x174d96;try{const _0x4537f0=(0x0,date_1[_0x4abdd3(0xb2)])()['startOf'](_0x4abdd3(0xac))[_0x4abdd3(0xa1)](_0x4abdd3(0xc1)),_0x3c4ace=(0x0,date_1[_0x4abdd3(0xb2)])()[_0x4abdd3(0xab)](_0x4abdd3(0xac))['format'](_0x4abdd3(0xc1)),_0x5858bd=this[_0x4abdd3(0xeb)]['createQueryBuilder'](_0x4abdd3(0xd4)),_0x3323f1=await _0x5858bd[_0x4abdd3(0xb4)](_0x4abdd3(0xc0))[_0x4abdd3(0x9b)](_0x4abdd3(0xc7),{'userId':_0x280cdd[_0x4abdd3(0xcb)]['id']})[_0x4abdd3(0x9b)](_0x4abdd3(0xdf),{'firstDay':_0x4537f0})['andWhere'](_0x4abdd3(0xb9),{'lastDay':_0x3c4ace})[_0x4abdd3(0xd1)](),_0x91cc9f=(0x0,date_1['default'])(_0x4537f0)['toDate'](),_0x353832=(0x0,date_1[_0x4abdd3(0xb2)])(_0x3c4ace)['toDate'](),_0x2bd9ee=[],_0x52425a=(0x0,date_1[_0x4abdd3(0xb2)])(_0x91cc9f)['toDate']();while(_0x52425a<=_0x353832){_0x2bd9ee[_0x4abdd3(0x9e)]((0x0,date_1[_0x4abdd3(0xb2)])((0x0,date_1[_0x4abdd3(0xb2)])(_0x52425a))['format'](_0x4abdd3(0xbf))),_0x52425a[_0x4abdd3(0xa4)](_0x52425a[_0x4abdd3(0xe4)]()+0x1);}const _0xe3daa1=[];for(const _0xdd943f of _0x2bd9ee){const _0x1cd8b7=_0x3323f1['find'](_0x12c9ce=>_0x12c9ce[_0x4abdd3(0xaf)]===_0xdd943f);!_0x1cd8b7?_0xe3daa1[_0x4abdd3(0x9e)]({'signInDate':_0xdd943f,'isSigned':![]}):(_0x1cd8b7[_0x4abdd3(0xbe)]=!![],_0xe3daa1[_0x4abdd3(0x9e)](_0x1cd8b7));}return _0xe3daa1;}catch(_0x460fa6){console[_0x4abdd3(0xa8)]('error:\x20',_0x460fa6);throw new common_1['HttpException'](_0x4abdd3(0xe6),common_1[_0x4abdd3(0xc3)][_0x4abdd3(0xe2)]);}}async[_0x174d96(0xe7)](_0x3b8cdc,_0xc7b292,_0x47bcbf){const _0x25dff2=_0x174d96,_0x5d0fc9=(0x0,utils_1[_0x25dff2(0xa9)])(this[_0x25dff2(0xba)]),{page:page=0x1,size:size=0x14,startTime:_0x20f1a1,endTime:_0x18c646,saasId:_0x22036c,keyword:_0x3cae70}=_0xc7b292,_0x2bf80c=_0x25dff2(0xc4)+(_0x47bcbf?_0x25dff2(0xe1)+_0x47bcbf:'')+_0x25dff2(0x96)+(_0x20f1a1?'\x20AND\x20s.createdAt\x20>=\x20\x27'+_0x20f1a1+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x18c646?_0x25dff2(0xd0)+_0x18c646+'\x27':'')+_0x25dff2(0x96)+(_0x5d0fc9!==0x0?'\x20AND\x20u.saasId\x20=\x20'+_0x5d0fc9:(0x0,utils_1[_0x25dff2(0xf1)])(_0x22036c)?_0x25dff2(0xb7)+_0x22036c:'')+_0x25dff2(0x96)+(_0x3cae70?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x3cae70+_0x25dff2(0x97)+_0x3cae70+_0x25dff2(0xdc)+_0x3cae70+_0x25dff2(0xa3)+_0x3cae70+_0x25dff2(0xb6):'')+_0x25dff2(0xf4),_0x308330=_0x25dff2(0xed)+_0x2bf80c+_0x25dff2(0xf4),_0x5dd06b=_0x25dff2(0xb5)+_0x2bf80c+_0x25dff2(0x98)+size+_0x25dff2(0xd3)+(page-0x1)*size+_0x25dff2(0xf4),_0x54d666=await this[_0x25dff2(0x99)][_0x25dff2(0xce)](_0x308330),_0x50b5c0=await this['connection'][_0x25dff2(0xce)](_0x5dd06b);return!(0x0,utils_1[_0x25dff2(0xa6)])(this[_0x25dff2(0xba)])&&_0x50b5c0[_0x25dff2(0x9a)](_0x20bca8=>{const _0x35cae0=_0x25dff2;_0x20bca8[_0x35cae0(0xc9)]=(0x0,utils_1[_0x35cae0(0xc2)])(_0x20bca8[_0x35cae0(0xc9)]),_0x20bca8[_0x35cae0(0xc8)]=(0x0,utils_1['maskEmail'])(_0x20bca8[_0x35cae0(0xc8)]);}),{'rows':_0x50b5c0,'count':Number(_0x54d666[0x0]?.[_0x25dff2(0x94)]||0x0)};}};function _0x5f45(){const _0x29317c=['5815789fdgmLG','defineProperty','nestjs-cls','toDate','getSigninLog','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','SigninService','Repository','signin.signInTime\x20>=\x20:firstDay','function','\x20AND\x20s.userId\x20=\x20','BAD_REQUEST','sign','getDate','length','获取签到数据失败！','userPage','SigninEntity','changeScore4Other','./signIn.entity','signinEntity','40088YhJIIf','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','getUserById','HttpException','../../common/constants/balance.constant','isDefined','4842357OKFQGs','decorate','\x0a\x20\x20\x20\x20','__metadata','Logger','count','UserService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','connection','forEach','andWhere','./../globalConfig/globalConfig.service','subtract','push','debug','object','format','775bitSgO','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','setDate','Connection','isSuper','InjectRepository','log','getReqSaasId','Injectable','endOf','month','GlobalConfigService','globalConfigService','signInDate','findOne','userService','default','design:paramtypes','select','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','%\x27\x20)','\x20AND\x20u.saasId\x20=\x20','106cxIoAH','signin.signInTime\x20<=\x20:lastDay','clsService','getSignatureGiftConfig','8581192VyjQrH','226944zglDPl','isSigned','YYYY-MM-DD','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','YYYY-MM-DD\x20HH:mm:ss','maskEmail','HttpStatus','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','签到奖励','昨天没签到、今天重置天数！','signin.userId\x20=\x20:userId','phone','email','typeorm','user','9456ghZRfF','4190520IYxOQq','query','__param','\x20AND\x20s.createdAt\x20<=\x20\x27','getRawMany','updateSignDay','\x20OFFSET\x20','signin','今日已签到、改天再来吧!.','metadata'];_0x5f45=function(){return _0x29317c;};return _0x5f45();}SigninService=__decorate([(0x0,common_1[_0x174d96(0xaa)])(),__param(0x0,(0x0,typeorm_1[_0x174d96(0xa7)])(signIn_entity_1[_0x174d96(0xe8)])),__metadata(_0x174d96(0xb3),[typeorm_2[_0x174d96(0xde)],nestjs_cls_1['ClsService'],user_service_1[_0x174d96(0x95)],globalConfig_service_1[_0x174d96(0xad)],typeorm_2[_0x174d96(0xa5)]])],SigninService),exports['SigninService']=SigninService;