'use strict';function _0x2bb5(_0x5cf3a2,_0x4814c5){const _0x1aae55=_0x1aae();return _0x2bb5=function(_0x2bb5dc,_0xe87cc1){_0x2bb5dc=_0x2bb5dc-0x137;let _0x20bcba=_0x1aae55[_0x2bb5dc];return _0x20bcba;},_0x2bb5(_0x5cf3a2,_0x4814c5);}const _0x273fac=_0x2bb5;(function(_0x55631c,_0x5d34ca){const _0x5bffbc=_0x2bb5,_0x597360=_0x55631c();while(!![]){try{const _0x367cf6=parseInt(_0x5bffbc(0x145))/0x1+parseInt(_0x5bffbc(0x13b))/0x2+-parseInt(_0x5bffbc(0x197))/0x3+-parseInt(_0x5bffbc(0x16f))/0x4*(-parseInt(_0x5bffbc(0x166))/0x5)+-parseInt(_0x5bffbc(0x19f))/0x6*(parseInt(_0x5bffbc(0x141))/0x7)+-parseInt(_0x5bffbc(0x185))/0x8*(-parseInt(_0x5bffbc(0x174))/0x9)+parseInt(_0x5bffbc(0x16b))/0xa;if(_0x367cf6===_0x5d34ca)break;else _0x597360['push'](_0x597360['shift']());}catch(_0x78e8c9){_0x597360['push'](_0x597360['shift']());}}}(_0x1aae,0x1dc5b));var __decorate=this&&this[_0x273fac(0x177)]||function(_0x3ea8a1,_0x985652,_0x24cd36,_0xeaea4c){const _0x154e90=_0x273fac;var _0x1657ce=arguments[_0x154e90(0x187)],_0x1bf44f=_0x1657ce<0x3?_0x985652:_0xeaea4c===null?_0xeaea4c=Object[_0x154e90(0x195)](_0x985652,_0x24cd36):_0xeaea4c,_0x37ef7f;if(typeof Reflect===_0x154e90(0x194)&&typeof Reflect[_0x154e90(0x170)]==='function')_0x1bf44f=Reflect['decorate'](_0x3ea8a1,_0x985652,_0x24cd36,_0xeaea4c);else{for(var _0x49827d=_0x3ea8a1['length']-0x1;_0x49827d>=0x0;_0x49827d--)if(_0x37ef7f=_0x3ea8a1[_0x49827d])_0x1bf44f=(_0x1657ce<0x3?_0x37ef7f(_0x1bf44f):_0x1657ce>0x3?_0x37ef7f(_0x985652,_0x24cd36,_0x1bf44f):_0x37ef7f(_0x985652,_0x24cd36))||_0x1bf44f;}return _0x1657ce>0x3&&_0x1bf44f&&Object[_0x154e90(0x139)](_0x985652,_0x24cd36,_0x1bf44f),_0x1bf44f;},__metadata=this&&this[_0x273fac(0x183)]||function(_0x342c22,_0xd0fa7f){const _0x2bda50=_0x273fac;if(typeof Reflect===_0x2bda50(0x194)&&typeof Reflect[_0x2bda50(0x17d)]===_0x2bda50(0x17e))return Reflect[_0x2bda50(0x17d)](_0x342c22,_0xd0fa7f);},__param=this&&this['__param']||function(_0x9eb396,_0x1cc604){return function(_0x5e90f3,_0x2a75e9){_0x1cc604(_0x5e90f3,_0x2a75e9,_0x9eb396);};};Object['defineProperty'](exports,_0x273fac(0x16c),{'value':!![]}),exports['SigninService']=void 0x0;function _0x1aae(){const _0x5f26ec=['createQueryBuilder','../../common/utils/date','getSigninLog','select','今日已签到、改天再来吧!.','userService','../user/user.service','@nestjs/common','nestjs-cls','updateSignDay','user','sign','InjectRepository','signin.signInTime\x20<=\x20:lastDay','../../common/constants/balance.constant','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','HttpStatus','isSuper','getReqSaasId','%\x27\x20)','45005fUvzvx','subtract','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','isDefined','签到奖励','1201050AwedFX','__esModule','Connection','default','4dHxdEb','decorate','昨天没签到、今天重置天数！','connection','clsService','149949saXPFG','signin','andWhere','__decorate','YYYY-MM-DD','获取签到数据失败！','debug','SignInReward','@nestjs/typeorm','metadata','function','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','forEach','userPage','\x20AND\x20u.saasId\x20=\x20','__metadata','Logger','40dnhvxr','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','length','SigninService','YYYY-MM-DD\x20HH:mm:ss','昨天签到了、今天是连续签到！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','endOf','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','\x20AND\x20s.createdAt\x20<=\x20\x27','push','\x0a\x20\x20\x20\x20','findOne','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','globalConfigService','object','getOwnPropertyDescriptor','signin.userId\x20=\x20:userId','165420OgPUYE','log','\x20AND\x20s.userId\x20=\x20','./../globalConfig/globalConfig.service','HttpException','maskEmail','getUserById','email','1354092PVmbDL','phone','getDate','defineProperty','typeorm','50516edxvGP','BAD_REQUEST','error:\x20','GlobalConfigService','find','signinEntity','7NNykUe','Repository','signin.signInTime\x20>=\x20:firstDay','query','165100GdQozv','ClsService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','isSigned','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','SigninEntity','setDate','month','format','design:paramtypes','getRawMany','Injectable','toDate'];_0x1aae=function(){return _0x5f26ec;};return _0x1aae();}const globalConfig_service_1=require(_0x273fac(0x19a)),common_1=require(_0x273fac(0x159)),signIn_entity_1=require('./signIn.entity'),typeorm_1=require(_0x273fac(0x17c)),typeorm_2=require(_0x273fac(0x13a)),date_1=require(_0x273fac(0x153)),balance_constant_1=require(_0x273fac(0x160)),user_service_1=require(_0x273fac(0x158)),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x273fac(0x15a));let SigninService=class SigninService{constructor(_0x196a29,_0x17316a,_0x1ddc6d,_0x2362f9,_0x3ab1e3){const _0x2f5cdd=_0x273fac;this['signinEntity']=_0x196a29,this[_0x2f5cdd(0x173)]=_0x17316a,this['userService']=_0x1ddc6d,this[_0x2f5cdd(0x193)]=_0x2362f9,this[_0x2f5cdd(0x172)]=_0x3ab1e3;}async[_0x273fac(0x15d)](_0x3e9aee){const _0x90ef2b=_0x273fac,_0x2c9933=_0x3e9aee[_0x90ef2b(0x15c)]['id'],_0x386356=await this['userService'][_0x90ef2b(0x19d)](_0x2c9933),_0x3d5499=(0x0,date_1[_0x90ef2b(0x16e)])()['format'](_0x90ef2b(0x178)),_0x1eb29e=await this[_0x90ef2b(0x140)]['findOne']({'where':{'userId':_0x2c9933,'signInDate':_0x3d5499}});if(_0x1eb29e)throw new common_1[(_0x90ef2b(0x19b))](_0x90ef2b(0x156),common_1[_0x90ef2b(0x162)][_0x90ef2b(0x13c)]);const _0x3b23e8=await this[_0x90ef2b(0x140)]['save']({'userId':_0x2c9933,'signInTime':(0x0,date_1[_0x90ef2b(0x16e)])()[_0x90ef2b(0x151)](),'signInDate':_0x3d5499,'isSigned':!![]}),_0x3a7cc9=await this[_0x90ef2b(0x193)]['getSignatureGiftConfig']();_0x3a7cc9&&await this['userService']['changeScore4Other'](_0x386356,balance_constant_1['EChangeType'][_0x90ef2b(0x17b)],_0x3a7cc9,_0x90ef2b(0x16a),_0x3b23e8['id']);const _0x5bc9d9=(0x0,date_1[_0x90ef2b(0x16e)])()[_0x90ef2b(0x167)](0x1,'day')[_0x90ef2b(0x14d)](_0x90ef2b(0x178)),_0x35d875=await this[_0x90ef2b(0x140)][_0x90ef2b(0x191)]({'where':{'userId':_0x2c9933,'signInDate':_0x5bc9d9}});if(_0x35d875){common_1[_0x90ef2b(0x184)][_0x90ef2b(0x17a)]('用户'+_0x2c9933+_0x90ef2b(0x18a),_0x90ef2b(0x188));const _0x6b7a7d=await this[_0x90ef2b(0x157)]['getUserById'](_0x2c9933);if(!_0x6b7a7d)throw new common_1[(_0x90ef2b(0x19b))]('用户不存在',common_1[_0x90ef2b(0x162)][_0x90ef2b(0x13c)]);const {consecutiveDays:consecutiveDays=0x0}=_0x6b7a7d;await this['userService'][_0x90ef2b(0x15b)](_0x2c9933,consecutiveDays+0x1);}else common_1[_0x90ef2b(0x184)]['debug']('用户'+_0x2c9933+_0x90ef2b(0x171),'SigninService'),await this[_0x90ef2b(0x157)][_0x90ef2b(0x15b)](_0x2c9933,0x1);return _0x3a7cc9;}async[_0x273fac(0x154)](_0xea7eb8){const _0x4d2ea2=_0x273fac;try{const _0x8968de=(0x0,date_1[_0x4d2ea2(0x16e)])()['startOf']('month')['format'](_0x4d2ea2(0x189)),_0x3dbc64=(0x0,date_1[_0x4d2ea2(0x16e)])()[_0x4d2ea2(0x18c)](_0x4d2ea2(0x14c))[_0x4d2ea2(0x14d)]('YYYY-MM-DD\x20HH:mm:ss'),_0x348972=this[_0x4d2ea2(0x140)][_0x4d2ea2(0x152)](_0x4d2ea2(0x175)),_0x16358b=await _0x348972[_0x4d2ea2(0x155)](_0x4d2ea2(0x18d))[_0x4d2ea2(0x176)](_0x4d2ea2(0x196),{'userId':_0xea7eb8[_0x4d2ea2(0x15c)]['id']})[_0x4d2ea2(0x176)](_0x4d2ea2(0x143),{'firstDay':_0x8968de})[_0x4d2ea2(0x176)](_0x4d2ea2(0x15f),{'lastDay':_0x3dbc64})[_0x4d2ea2(0x14f)](),_0x30be60=(0x0,date_1[_0x4d2ea2(0x16e)])(_0x8968de)['toDate'](),_0x371e26=(0x0,date_1[_0x4d2ea2(0x16e)])(_0x3dbc64)[_0x4d2ea2(0x151)](),_0xad478d=[],_0x5dcbcf=(0x0,date_1[_0x4d2ea2(0x16e)])(_0x30be60)[_0x4d2ea2(0x151)]();while(_0x5dcbcf<=_0x371e26){_0xad478d[_0x4d2ea2(0x18f)]((0x0,date_1['default'])((0x0,date_1[_0x4d2ea2(0x16e)])(_0x5dcbcf))['format'](_0x4d2ea2(0x178))),_0x5dcbcf[_0x4d2ea2(0x14b)](_0x5dcbcf[_0x4d2ea2(0x138)]()+0x1);}const _0x819cfb=[];for(const _0x434d3f of _0xad478d){const _0x1d74c3=_0x16358b[_0x4d2ea2(0x13f)](_0xec91f9=>_0xec91f9['signInDate']===_0x434d3f);!_0x1d74c3?_0x819cfb[_0x4d2ea2(0x18f)]({'signInDate':_0x434d3f,'isSigned':![]}):(_0x1d74c3[_0x4d2ea2(0x148)]=!![],_0x819cfb['push'](_0x1d74c3));}return _0x819cfb;}catch(_0x2e0782){console[_0x4d2ea2(0x198)](_0x4d2ea2(0x13d),_0x2e0782);throw new common_1[(_0x4d2ea2(0x19b))](_0x4d2ea2(0x179),common_1[_0x4d2ea2(0x162)][_0x4d2ea2(0x13c)]);}}async[_0x273fac(0x181)](_0x2f095,_0x3a5484,_0x39d810){const _0x389a24=_0x273fac,_0x3851f4=(0x0,utils_1[_0x389a24(0x164)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0x46a735,endTime:_0x33e8fe,saasId:_0x8e1dd5,keyword:_0x4d71e3}=_0x3a5484,_0x15c86f=_0x389a24(0x168)+(_0x39d810?_0x389a24(0x199)+_0x39d810:'')+_0x389a24(0x192)+(_0x46a735?'\x20AND\x20s.createdAt\x20>=\x20\x27'+_0x46a735+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x33e8fe?_0x389a24(0x18e)+_0x33e8fe+'\x27':'')+_0x389a24(0x192)+(_0x3851f4!==0x0?_0x389a24(0x182)+_0x3851f4:(0x0,utils_1[_0x389a24(0x169)])(_0x8e1dd5)?_0x389a24(0x182)+_0x8e1dd5:'')+_0x389a24(0x192)+(_0x4d71e3?_0x389a24(0x161)+_0x4d71e3+_0x389a24(0x149)+_0x4d71e3+_0x389a24(0x17f)+_0x4d71e3+_0x389a24(0x186)+_0x4d71e3+_0x389a24(0x165):'')+'\x0a\x20\x20\x20\x20',_0x876942=_0x389a24(0x147)+_0x15c86f+_0x389a24(0x190),_0x37eb09=_0x389a24(0x18b)+_0x15c86f+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20',_0x5daf24=await this[_0x389a24(0x172)][_0x389a24(0x144)](_0x876942),_0x3ea574=await this[_0x389a24(0x172)][_0x389a24(0x144)](_0x37eb09);return!(0x0,utils_1[_0x389a24(0x163)])(this[_0x389a24(0x173)])&&_0x3ea574[_0x389a24(0x180)](_0x4ba9a0=>{const _0x49133b=_0x389a24;_0x4ba9a0[_0x49133b(0x19e)]=(0x0,utils_1[_0x49133b(0x19c)])(_0x4ba9a0['email']),_0x4ba9a0[_0x49133b(0x137)]=(0x0,utils_1['maskEmail'])(_0x4ba9a0[_0x49133b(0x137)]);}),{'rows':_0x3ea574,'count':Number(_0x5daf24[0x0]?.['count']||0x0)};}};SigninService=__decorate([(0x0,common_1[_0x273fac(0x150)])(),__param(0x0,(0x0,typeorm_1[_0x273fac(0x15e)])(signIn_entity_1[_0x273fac(0x14a)])),__metadata(_0x273fac(0x14e),[typeorm_2[_0x273fac(0x142)],nestjs_cls_1[_0x273fac(0x146)],user_service_1['UserService'],globalConfig_service_1[_0x273fac(0x13e)],typeorm_2[_0x273fac(0x16d)]])],SigninService),exports[_0x273fac(0x188)]=SigninService;