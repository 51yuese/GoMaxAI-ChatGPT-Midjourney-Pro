'use strict';const _0x5bd90f=_0x4a62;function _0x4a62(_0x166676,_0x134e50){const _0x425f58=_0x425f();return _0x4a62=function(_0x4a6271,_0x3b3b1b){_0x4a6271=_0x4a6271-0x109;let _0x207a50=_0x425f58[_0x4a6271];return _0x207a50;},_0x4a62(_0x166676,_0x134e50);}(function(_0x2c64e6,_0x12a0b8){const _0x3b8d28=_0x4a62,_0x53fe8d=_0x2c64e6();while(!![]){try{const _0xfff520=-parseInt(_0x3b8d28(0x127))/0x1+parseInt(_0x3b8d28(0x14b))/0x2*(parseInt(_0x3b8d28(0x162))/0x3)+-parseInt(_0x3b8d28(0x10c))/0x4+parseInt(_0x3b8d28(0x14a))/0x5+-parseInt(_0x3b8d28(0x149))/0x6*(-parseInt(_0x3b8d28(0x110))/0x7)+-parseInt(_0x3b8d28(0x15d))/0x8*(parseInt(_0x3b8d28(0x152))/0x9)+parseInt(_0x3b8d28(0x157))/0xa;if(_0xfff520===_0x12a0b8)break;else _0x53fe8d['push'](_0x53fe8d['shift']());}catch(_0x3c19b4){_0x53fe8d['push'](_0x53fe8d['shift']());}}}(_0x425f,0x32910));function _0x425f(){const _0x183f2a=['340264AZyVGL','\x20AND\x20u.saasId\x20=\x20','find','\x20OFFSET\x20','14RYEHNP','ClsService','isDefined','user','select','globalConfigService','userService','clsService','userPage','phone','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','../user/user.service','HttpStatus','signInDate','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','今日已签到、改天再来吧!.','\x20AND\x20s.createdAt\x20<=\x20\x27','SignInReward','object','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','andWhere','UserService','获取签到数据失败！','218252QKVOIa','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','startOf','updateSignDay','HttpException','./../globalConfig/globalConfig.service','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','function','signin.signInTime\x20<=\x20:lastDay','save','EChangeType','day','getSigninLog','BAD_REQUEST','InjectRepository','昨天没签到、今天重置天数！','signinEntity','endOf','push','defineProperty','connection','__esModule','Repository','createQueryBuilder','sign','SigninService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','format','design:paramtypes','getUserById','decorate','month','nestjs-cls','getOwnPropertyDescriptor','318630eHjIHq','1424390PfVlxT','496554ZwenCG','\x20AND\x20s.userId\x20=\x20','typeorm','toDate','Logger','count','../../common/utils/date','63xFdYIV','../../common/utils','debug','default','setDate','1262300EegvDL','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','changeScore4Other','signin','query','__metadata','291608uJfqcQ','签到奖励','maskEmail','metadata','findOne','3ycRClZ','./signIn.entity','\x0a\x20\x20\x20\x20','length','email','getRawMany','log','YYYY-MM-DD','%\x27\x20)','YYYY-MM-DD\x20HH:mm:ss','getReqSaasId'];_0x425f=function(){return _0x183f2a;};return _0x425f();}var __decorate=this&&this['__decorate']||function(_0x5f388a,_0x341e7f,_0x98e64b,_0x5b4bc1){const _0xd67e67=_0x4a62;var _0x5511d4=arguments['length'],_0x5f05d7=_0x5511d4<0x3?_0x341e7f:_0x5b4bc1===null?_0x5b4bc1=Object[_0xd67e67(0x148)](_0x341e7f,_0x98e64b):_0x5b4bc1,_0x53cd00;if(typeof Reflect===_0xd67e67(0x122)&&typeof Reflect[_0xd67e67(0x145)]==='function')_0x5f05d7=Reflect[_0xd67e67(0x145)](_0x5f388a,_0x341e7f,_0x98e64b,_0x5b4bc1);else{for(var _0x2c0086=_0x5f388a[_0xd67e67(0x165)]-0x1;_0x2c0086>=0x0;_0x2c0086--)if(_0x53cd00=_0x5f388a[_0x2c0086])_0x5f05d7=(_0x5511d4<0x3?_0x53cd00(_0x5f05d7):_0x5511d4>0x3?_0x53cd00(_0x341e7f,_0x98e64b,_0x5f05d7):_0x53cd00(_0x341e7f,_0x98e64b))||_0x5f05d7;}return _0x5511d4>0x3&&_0x5f05d7&&Object[_0xd67e67(0x13a)](_0x341e7f,_0x98e64b,_0x5f05d7),_0x5f05d7;},__metadata=this&&this[_0x5bd90f(0x15c)]||function(_0xb49941,_0xee014b){const _0x31a786=_0x5bd90f;if(typeof Reflect===_0x31a786(0x122)&&typeof Reflect['metadata']===_0x31a786(0x12e))return Reflect[_0x31a786(0x160)](_0xb49941,_0xee014b);},__param=this&&this['__param']||function(_0x40be04,_0x44fbdf){return function(_0x4cc0cb,_0x147e0b){_0x44fbdf(_0x4cc0cb,_0x147e0b,_0x40be04);};};Object[_0x5bd90f(0x13a)](exports,_0x5bd90f(0x13c),{'value':!![]}),exports[_0x5bd90f(0x140)]=void 0x0;const globalConfig_service_1=require(_0x5bd90f(0x12c)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x5bd90f(0x163)),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5bd90f(0x14d)),date_1=require(_0x5bd90f(0x151)),balance_constant_1=require('../../common/constants/balance.constant'),user_service_1=require(_0x5bd90f(0x11b)),utils_1=require(_0x5bd90f(0x153)),nestjs_cls_1=require(_0x5bd90f(0x147));let SigninService=class SigninService{constructor(_0x400cff,_0x4b38f7,_0x35a7d2,_0x333b53,_0x510b4c){const _0x4f886c=_0x5bd90f;this[_0x4f886c(0x137)]=_0x400cff,this['clsService']=_0x4b38f7,this[_0x4f886c(0x116)]=_0x35a7d2,this[_0x4f886c(0x115)]=_0x333b53,this[_0x4f886c(0x13b)]=_0x510b4c;}async[_0x5bd90f(0x13f)](_0x19bfe7){const _0x13dfd5=_0x5bd90f,_0x2f12af=_0x19bfe7[_0x13dfd5(0x113)]['id'],_0x61cb5d=await this[_0x13dfd5(0x116)][_0x13dfd5(0x144)](_0x2f12af),_0x5726b3=(0x0,date_1['default'])()[_0x13dfd5(0x142)](_0x13dfd5(0x169)),_0x2a9766=await this[_0x13dfd5(0x137)][_0x13dfd5(0x161)]({'where':{'userId':_0x2f12af,'signInDate':_0x5726b3}});if(_0x2a9766)throw new common_1[(_0x13dfd5(0x12b))](_0x13dfd5(0x11f),common_1[_0x13dfd5(0x11c)][_0x13dfd5(0x134)]);const _0x386d13=await this[_0x13dfd5(0x137)][_0x13dfd5(0x130)]({'userId':_0x2f12af,'signInTime':(0x0,date_1[_0x13dfd5(0x155)])()[_0x13dfd5(0x14e)](),'signInDate':_0x5726b3,'isSigned':!![]}),_0x580906=await this[_0x13dfd5(0x115)]['getSignatureGiftConfig']();_0x580906&&await this[_0x13dfd5(0x116)][_0x13dfd5(0x159)](_0x61cb5d,balance_constant_1[_0x13dfd5(0x131)][_0x13dfd5(0x121)],_0x580906,_0x13dfd5(0x15e),_0x386d13['id']);const _0x15d8a5=(0x0,date_1[_0x13dfd5(0x155)])()['subtract'](0x1,_0x13dfd5(0x132))[_0x13dfd5(0x142)]('YYYY-MM-DD'),_0x22cbe7=await this['signinEntity']['findOne']({'where':{'userId':_0x2f12af,'signInDate':_0x15d8a5}});if(_0x22cbe7){common_1['Logger'][_0x13dfd5(0x154)]('用户'+_0x2f12af+'昨天签到了、今天是连续签到！','SigninService');const _0x21ee95=await this[_0x13dfd5(0x116)][_0x13dfd5(0x144)](_0x2f12af);if(!_0x21ee95)throw new common_1['HttpException']('用户不存在',common_1[_0x13dfd5(0x11c)][_0x13dfd5(0x134)]);const {consecutiveDays:consecutiveDays=0x0}=_0x21ee95;await this[_0x13dfd5(0x116)][_0x13dfd5(0x12a)](_0x2f12af,consecutiveDays+0x1);}else common_1[_0x13dfd5(0x14f)]['debug']('用户'+_0x2f12af+_0x13dfd5(0x136),_0x13dfd5(0x140)),await this[_0x13dfd5(0x116)]['updateSignDay'](_0x2f12af,0x1);return _0x580906;}async[_0x5bd90f(0x133)](_0xc29b1a){const _0x3d23fd=_0x5bd90f;try{const _0x312bcf=(0x0,date_1[_0x3d23fd(0x155)])()[_0x3d23fd(0x129)](_0x3d23fd(0x146))['format'](_0x3d23fd(0x10a)),_0xebb09d=(0x0,date_1[_0x3d23fd(0x155)])()[_0x3d23fd(0x138)](_0x3d23fd(0x146))['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x2a447a=this[_0x3d23fd(0x137)][_0x3d23fd(0x13e)](_0x3d23fd(0x15a)),_0x567b55=await _0x2a447a[_0x3d23fd(0x114)]('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')['andWhere']('signin.userId\x20=\x20:userId',{'userId':_0xc29b1a[_0x3d23fd(0x113)]['id']})['andWhere']('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x312bcf})[_0x3d23fd(0x124)](_0x3d23fd(0x12f),{'lastDay':_0xebb09d})[_0x3d23fd(0x167)](),_0x1d7324=(0x0,date_1['default'])(_0x312bcf)[_0x3d23fd(0x14e)](),_0x82d5fc=(0x0,date_1[_0x3d23fd(0x155)])(_0xebb09d)['toDate'](),_0x42efc9=[],_0x41ef57=(0x0,date_1[_0x3d23fd(0x155)])(_0x1d7324)['toDate']();while(_0x41ef57<=_0x82d5fc){_0x42efc9[_0x3d23fd(0x139)]((0x0,date_1[_0x3d23fd(0x155)])((0x0,date_1[_0x3d23fd(0x155)])(_0x41ef57))['format'](_0x3d23fd(0x169))),_0x41ef57[_0x3d23fd(0x156)](_0x41ef57['getDate']()+0x1);}const _0x3ec715=[];for(const _0x3725c7 of _0x42efc9){const _0x26a755=_0x567b55[_0x3d23fd(0x10e)](_0x46bbc1=>_0x46bbc1[_0x3d23fd(0x11d)]===_0x3725c7);!_0x26a755?_0x3ec715['push']({'signInDate':_0x3725c7,'isSigned':![]}):(_0x26a755['isSigned']=!![],_0x3ec715['push'](_0x26a755));}return _0x3ec715;}catch(_0x46d3e4){console[_0x3d23fd(0x168)]('error:\x20',_0x46d3e4);throw new common_1['HttpException'](_0x3d23fd(0x126),common_1[_0x3d23fd(0x11c)][_0x3d23fd(0x134)]);}}async[_0x5bd90f(0x118)](_0x116691,_0x260fbe,_0x1de026){const _0x2a8464=_0x5bd90f,_0x4b3cd6=(0x0,utils_1[_0x2a8464(0x10b)])(this[_0x2a8464(0x117)]),{page:page=0x1,size:size=0x14,startTime:_0x5a7c53,endTime:_0x55a53d,saasId:_0x119e9a,keyword:_0x5c2ce2}=_0x260fbe,_0x56110=_0x2a8464(0x141)+(_0x1de026?_0x2a8464(0x14c)+_0x1de026:'')+_0x2a8464(0x158)+(_0x5a7c53?'\x20AND\x20s.createdAt\x20>=\x20\x27'+_0x5a7c53+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x55a53d?_0x2a8464(0x120)+_0x55a53d+'\x27':'')+_0x2a8464(0x158)+(_0x4b3cd6!==0x0?_0x2a8464(0x10d)+_0x4b3cd6:(0x0,utils_1[_0x2a8464(0x112)])(_0x119e9a)?_0x2a8464(0x10d)+_0x119e9a:'')+_0x2a8464(0x158)+(_0x5c2ce2?_0x2a8464(0x123)+_0x5c2ce2+_0x2a8464(0x11e)+_0x5c2ce2+_0x2a8464(0x12d)+_0x5c2ce2+_0x2a8464(0x11a)+_0x5c2ce2+_0x2a8464(0x109):'')+_0x2a8464(0x164),_0x3b84dd=_0x2a8464(0x128)+_0x56110+_0x2a8464(0x164),_0x49236a='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x56110+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x2a8464(0x10f)+(page-0x1)*size+_0x2a8464(0x164),_0x5ddc11=await this['connection']['query'](_0x3b84dd),_0x2602ab=await this['connection'][_0x2a8464(0x15b)](_0x49236a);return!(0x0,utils_1['isSuper'])(this[_0x2a8464(0x117)])&&_0x2602ab['forEach'](_0x211a8a=>{const _0x2c8d14=_0x2a8464;_0x211a8a[_0x2c8d14(0x166)]=(0x0,utils_1[_0x2c8d14(0x15f)])(_0x211a8a['email']),_0x211a8a[_0x2c8d14(0x119)]=(0x0,utils_1[_0x2c8d14(0x15f)])(_0x211a8a['phone']);}),{'rows':_0x2602ab,'count':Number(_0x5ddc11[0x0]?.[_0x2a8464(0x150)]||0x0)};}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x5bd90f(0x135)])(signIn_entity_1['SigninEntity'])),__metadata(_0x5bd90f(0x143),[typeorm_2[_0x5bd90f(0x13d)],nestjs_cls_1[_0x5bd90f(0x111)],user_service_1[_0x5bd90f(0x125)],globalConfig_service_1['GlobalConfigService'],typeorm_2['Connection']])],SigninService),exports['SigninService']=SigninService;