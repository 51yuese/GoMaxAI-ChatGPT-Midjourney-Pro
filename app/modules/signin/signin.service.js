'use strict';const _0x8e7262=_0x1554;(function(_0x40e3ea,_0x2f2193){const _0x2e6612=_0x1554,_0xc3e04d=_0x40e3ea();while(!![]){try{const _0x53648b=parseInt(_0x2e6612(0xc1))/0x1+-parseInt(_0x2e6612(0xd9))/0x2*(-parseInt(_0x2e6612(0xc4))/0x3)+parseInt(_0x2e6612(0xbd))/0x4*(-parseInt(_0x2e6612(0xc0))/0x5)+parseInt(_0x2e6612(0xcc))/0x6+parseInt(_0x2e6612(0x93))/0x7+-parseInt(_0x2e6612(0xae))/0x8*(-parseInt(_0x2e6612(0xc5))/0x9)+-parseInt(_0x2e6612(0x89))/0xa;if(_0x53648b===_0x2f2193)break;else _0xc3e04d['push'](_0xc3e04d['shift']());}catch(_0x3c34dd){_0xc3e04d['push'](_0xc3e04d['shift']());}}}(_0x2823,0x642ec));var __decorate=this&&this[_0x8e7262(0x8e)]||function(_0x58401a,_0x546266,_0x2998a9,_0x2714e1){const _0x474e15=_0x8e7262;var _0x5eb8c1=arguments[_0x474e15(0x90)],_0x5efcf8=_0x5eb8c1<0x3?_0x546266:_0x2714e1===null?_0x2714e1=Object['getOwnPropertyDescriptor'](_0x546266,_0x2998a9):_0x2714e1,_0x543c77;if(typeof Reflect===_0x474e15(0x92)&&typeof Reflect[_0x474e15(0xd8)]==='function')_0x5efcf8=Reflect['decorate'](_0x58401a,_0x546266,_0x2998a9,_0x2714e1);else{for(var _0x52cc5b=_0x58401a[_0x474e15(0x90)]-0x1;_0x52cc5b>=0x0;_0x52cc5b--)if(_0x543c77=_0x58401a[_0x52cc5b])_0x5efcf8=(_0x5eb8c1<0x3?_0x543c77(_0x5efcf8):_0x5eb8c1>0x3?_0x543c77(_0x546266,_0x2998a9,_0x5efcf8):_0x543c77(_0x546266,_0x2998a9))||_0x5efcf8;}return _0x5eb8c1>0x3&&_0x5efcf8&&Object['defineProperty'](_0x546266,_0x2998a9,_0x5efcf8),_0x5efcf8;},__metadata=this&&this[_0x8e7262(0xaf)]||function(_0x50c57b,_0x40452b){const _0x2b39dc=_0x8e7262;if(typeof Reflect===_0x2b39dc(0x92)&&typeof Reflect[_0x2b39dc(0xba)]===_0x2b39dc(0xd1))return Reflect[_0x2b39dc(0xba)](_0x50c57b,_0x40452b);},__param=this&&this['__param']||function(_0x2681e2,_0x49980f){return function(_0x3d42a9,_0x15d8e3){_0x49980f(_0x3d42a9,_0x15d8e3,_0x2681e2);};};Object[_0x8e7262(0xab)](exports,_0x8e7262(0xd2),{'value':!![]}),exports[_0x8e7262(0xb9)]=void 0x0;function _0x1554(_0xa45091,_0x3c9f73){const _0x282312=_0x2823();return _0x1554=function(_0x155466,_0x575795){_0x155466=_0x155466-0x82;let _0x275a6b=_0x282312[_0x155466];return _0x275a6b;},_0x1554(_0xa45091,_0x3c9f73);}const globalConfig_service_1=require(_0x8e7262(0x83)),common_1=require('@nestjs/common'),signIn_entity_1=require(_0x8e7262(0x96)),typeorm_1=require(_0x8e7262(0xcb)),typeorm_2=require('typeorm'),date_1=require(_0x8e7262(0x97)),balance_constant_1=require(_0x8e7262(0xd3)),user_service_1=require(_0x8e7262(0x94)),utils_1=require(_0x8e7262(0x84)),nestjs_cls_1=require('nestjs-cls');let SigninService=class SigninService{constructor(_0xbbbe3f,_0x22c1cf,_0x297fbf,_0x5b9796,_0x44d8d1){const _0x3626f0=_0x8e7262;this[_0x3626f0(0x9a)]=_0xbbbe3f,this[_0x3626f0(0x95)]=_0x22c1cf,this[_0x3626f0(0xb3)]=_0x297fbf,this[_0x3626f0(0xaa)]=_0x5b9796,this['connection']=_0x44d8d1;}async['sign'](_0x354c73){const _0x412762=_0x8e7262,_0x2b98bf=_0x354c73[_0x412762(0xdf)]['id'],_0x4ea08e=await this[_0x412762(0xb3)][_0x412762(0x82)](_0x2b98bf),_0x19613f=(0x0,date_1['default'])()['format']('YYYY-MM-DD'),_0x2ad920=await this[_0x412762(0x9a)][_0x412762(0xd7)]({'where':{'userId':_0x2b98bf,'signInDate':_0x19613f}});if(_0x2ad920)throw new common_1[(_0x412762(0xa7))](_0x412762(0xd5),common_1[_0x412762(0xa2)][_0x412762(0xc6)]);const _0x685810=await this[_0x412762(0x9a)]['save']({'userId':_0x2b98bf,'signInTime':(0x0,date_1['default'])()[_0x412762(0x9e)](),'signInDate':_0x19613f,'isSigned':!![]}),_0x141869=await this[_0x412762(0xaa)][_0x412762(0x8f)]();_0x141869&&await this[_0x412762(0xb3)]['changeScore4Other'](_0x4ea08e,balance_constant_1['EChangeType'][_0x412762(0x91)],_0x141869,_0x412762(0xbc),_0x685810['id']);const _0x48baf1=(0x0,date_1['default'])()['subtract'](0x1,_0x412762(0xbe))[_0x412762(0x8b)](_0x412762(0x86)),_0x4a9c9a=await this[_0x412762(0x9a)]['findOne']({'where':{'userId':_0x2b98bf,'signInDate':_0x48baf1}});if(_0x4a9c9a){common_1[_0x412762(0xdd)][_0x412762(0xbb)]('用户'+_0x2b98bf+_0x412762(0xb6),'SigninService');const _0x48d1b1=await this[_0x412762(0xb3)][_0x412762(0x82)](_0x2b98bf);if(!_0x48d1b1)throw new common_1['HttpException'](_0x412762(0xd4),common_1['HttpStatus']['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x48d1b1;await this['userService'][_0x412762(0xa4)](_0x2b98bf,consecutiveDays+0x1);}else common_1[_0x412762(0xdd)][_0x412762(0xbb)]('用户'+_0x2b98bf+'昨天没签到、今天重置天数！',_0x412762(0xb9)),await this[_0x412762(0xb3)][_0x412762(0xa4)](_0x2b98bf,0x1);return _0x141869;}async[_0x8e7262(0xda)](_0x572510){const _0x1ccec2=_0x8e7262;try{const _0x3259b2=(0x0,date_1[_0x1ccec2(0xa9)])()['startOf'](_0x1ccec2(0x8c))['format'](_0x1ccec2(0xdc)),_0x4bf33f=(0x0,date_1[_0x1ccec2(0xa9)])()['endOf']('month')['format']('YYYY-MM-DD\x20HH:mm:ss'),_0x217041=this['signinEntity'][_0x1ccec2(0x8d)](_0x1ccec2(0xa8)),_0x203439=await _0x217041[_0x1ccec2(0x9c)]('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x1ccec2(0xdb)]('signin.userId\x20=\x20:userId',{'userId':_0x572510[_0x1ccec2(0xdf)]['id']})[_0x1ccec2(0xdb)](_0x1ccec2(0xcf),{'firstDay':_0x3259b2})['andWhere'](_0x1ccec2(0xde),{'lastDay':_0x4bf33f})[_0x1ccec2(0xb4)](),_0x5cf221=(0x0,date_1[_0x1ccec2(0xa9)])(_0x3259b2)[_0x1ccec2(0x9e)](),_0x55179f=(0x0,date_1[_0x1ccec2(0xa9)])(_0x4bf33f)[_0x1ccec2(0x9e)](),_0x301a2b=[],_0x3b9979=(0x0,date_1['default'])(_0x5cf221)[_0x1ccec2(0x9e)]();while(_0x3b9979<=_0x55179f){_0x301a2b[_0x1ccec2(0xc2)]((0x0,date_1[_0x1ccec2(0xa9)])((0x0,date_1[_0x1ccec2(0xa9)])(_0x3b9979))['format']('YYYY-MM-DD')),_0x3b9979[_0x1ccec2(0xb0)](_0x3b9979['getDate']()+0x1);}const _0xfec81=[];for(const _0x52acb5 of _0x301a2b){const _0x40f02b=_0x203439[_0x1ccec2(0xa3)](_0x3c7516=>_0x3c7516[_0x1ccec2(0x8a)]===_0x52acb5);!_0x40f02b?_0xfec81[_0x1ccec2(0xc2)]({'signInDate':_0x52acb5,'isSigned':![]}):(_0x40f02b[_0x1ccec2(0xb5)]=!![],_0xfec81[_0x1ccec2(0xc2)](_0x40f02b));}return _0xfec81;}catch(_0x4fc569){console[_0x1ccec2(0xac)](_0x1ccec2(0x9d),_0x4fc569);throw new common_1['HttpException']('获取签到数据失败！',common_1[_0x1ccec2(0xa2)][_0x1ccec2(0xc6)]);}}async[_0x8e7262(0xbf)](_0x56979d,_0x4834a4,_0x5c9c89){const _0x214c14=_0x8e7262,_0x56cb13=(0x0,utils_1['getReqSaasId'])(this[_0x214c14(0x95)]),{page:page=0x1,size:size=0x14,startTime:_0x2f28b8,endTime:_0x4c4b23,saasId:_0x2597cf,keyword:_0x4e4350}=_0x4834a4,_0x4c196f=_0x214c14(0x9f)+(_0x5c9c89?_0x214c14(0xd0)+_0x5c9c89:'')+_0x214c14(0x9b)+(_0x2f28b8?_0x214c14(0xca)+_0x2f28b8+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4c4b23?_0x214c14(0x98)+_0x4c4b23+'\x27':'')+_0x214c14(0x9b)+(_0x56cb13!==0x0?_0x214c14(0xa6)+_0x56cb13:(0x0,utils_1[_0x214c14(0x99)])(_0x2597cf)?_0x214c14(0xa6)+_0x2597cf:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4e4350?_0x214c14(0xc3)+_0x4e4350+_0x214c14(0xe1)+_0x4e4350+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x4e4350+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x4e4350+_0x214c14(0x88):'')+'\x0a\x20\x20\x20\x20',_0x31dc91='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x4c196f+_0x214c14(0x85),_0x4b7911=_0x214c14(0xc8)+_0x4c196f+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x214c14(0x85),_0x1caf3f=await this['connection'][_0x214c14(0xb2)](_0x31dc91),_0x33bd2e=await this[_0x214c14(0xa1)]['query'](_0x4b7911);return!(0x0,utils_1['isSuper'])(this['clsService'])&&_0x33bd2e[_0x214c14(0xa5)](_0x3a4550=>{const _0x4912ec=_0x214c14;_0x3a4550[_0x4912ec(0xcd)]=(0x0,utils_1['maskEmail'])(_0x3a4550[_0x4912ec(0xcd)]),_0x3a4550[_0x4912ec(0xad)]=(0x0,utils_1[_0x4912ec(0xb8)])(_0x3a4550[_0x4912ec(0xad)]);}),{'rows':_0x33bd2e,'count':Number(_0x1caf3f[0x0]?.[_0x214c14(0xd6)]||0x0)};}};SigninService=__decorate([(0x0,common_1[_0x8e7262(0xce)])(),__param(0x0,(0x0,typeorm_1[_0x8e7262(0x87)])(signIn_entity_1['SigninEntity'])),__metadata(_0x8e7262(0xc7),[typeorm_2[_0x8e7262(0xe0)],nestjs_cls_1[_0x8e7262(0xb1)],user_service_1[_0x8e7262(0xb7)],globalConfig_service_1[_0x8e7262(0xc9)],typeorm_2[_0x8e7262(0xa0)]])],SigninService),exports[_0x8e7262(0xb9)]=SigninService;function _0x2823(){const _0x1efb15=['Connection','connection','HttpStatus','find','updateSignDay','forEach','\x20AND\x20u.saasId\x20=\x20','HttpException','signin','default','globalConfigService','defineProperty','log','phone','1161056QOdOuq','__metadata','setDate','ClsService','query','userService','getRawMany','isSigned','昨天签到了、今天是连续签到！','UserService','maskEmail','SigninService','metadata','debug','签到奖励','722236drrmWe','day','userPage','5yWkMip','563160xLPsYy','push','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','933sqTgZy','9IANHhG','BAD_REQUEST','design:paramtypes','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','GlobalConfigService','\x20AND\x20s.createdAt\x20>=\x20\x27','@nestjs/typeorm','62094clVRNO','email','Injectable','signin.signInTime\x20>=\x20:firstDay','\x20AND\x20s.userId\x20=\x20','function','__esModule','../../common/constants/balance.constant','用户不存在','今日已签到、改天再来吧!.','count','findOne','decorate','2642oGBzFb','getSigninLog','andWhere','YYYY-MM-DD\x20HH:mm:ss','Logger','signin.signInTime\x20<=\x20:lastDay','user','Repository','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','getUserById','./../globalConfig/globalConfig.service','../../common/utils','\x0a\x20\x20\x20\x20','YYYY-MM-DD','InjectRepository','%\x27\x20)','12541330tnzyRT','signInDate','format','month','createQueryBuilder','__decorate','getSignatureGiftConfig','length','SignInReward','object','5008976lnLuFy','../user/user.service','clsService','./signIn.entity','../../common/utils/date','\x20AND\x20s.createdAt\x20<=\x20\x27','isDefined','signinEntity','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','select','error:\x20','toDate','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'];_0x2823=function(){return _0x1efb15;};return _0x2823();}