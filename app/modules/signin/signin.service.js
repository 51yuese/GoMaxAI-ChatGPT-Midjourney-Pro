'use strict';const _0x50ae63=_0x318b;(function(_0x4fdbb9,_0x3cbaf2){const _0x56fc8c=_0x318b,_0x4ff63d=_0x4fdbb9();while(!![]){try{const _0x24d82e=parseInt(_0x56fc8c(0x1dc))/0x1*(parseInt(_0x56fc8c(0x224))/0x2)+-parseInt(_0x56fc8c(0x1ef))/0x3*(-parseInt(_0x56fc8c(0x207))/0x4)+parseInt(_0x56fc8c(0x1ee))/0x5+parseInt(_0x56fc8c(0x231))/0x6+-parseInt(_0x56fc8c(0x205))/0x7*(-parseInt(_0x56fc8c(0x226))/0x8)+-parseInt(_0x56fc8c(0x216))/0x9+-parseInt(_0x56fc8c(0x1f9))/0xa*(parseInt(_0x56fc8c(0x1e6))/0xb);if(_0x24d82e===_0x3cbaf2)break;else _0x4ff63d['push'](_0x4ff63d['shift']());}catch(_0x2bcd68){_0x4ff63d['push'](_0x4ff63d['shift']());}}}(_0x5c62,0xb3c47));var __decorate=this&&this[_0x50ae63(0x1d9)]||function(_0x590444,_0x46f0cc,_0x38f02d,_0xdd685d){const _0x2d57ec=_0x50ae63;var _0x84bec4=arguments['length'],_0x1065e6=_0x84bec4<0x3?_0x46f0cc:_0xdd685d===null?_0xdd685d=Object['getOwnPropertyDescriptor'](_0x46f0cc,_0x38f02d):_0xdd685d,_0x4296ff;if(typeof Reflect===_0x2d57ec(0x22c)&&typeof Reflect[_0x2d57ec(0x1f0)]==='function')_0x1065e6=Reflect[_0x2d57ec(0x1f0)](_0x590444,_0x46f0cc,_0x38f02d,_0xdd685d);else{for(var _0x143545=_0x590444[_0x2d57ec(0x227)]-0x1;_0x143545>=0x0;_0x143545--)if(_0x4296ff=_0x590444[_0x143545])_0x1065e6=(_0x84bec4<0x3?_0x4296ff(_0x1065e6):_0x84bec4>0x3?_0x4296ff(_0x46f0cc,_0x38f02d,_0x1065e6):_0x4296ff(_0x46f0cc,_0x38f02d))||_0x1065e6;}return _0x84bec4>0x3&&_0x1065e6&&Object[_0x2d57ec(0x1df)](_0x46f0cc,_0x38f02d,_0x1065e6),_0x1065e6;},__metadata=this&&this[_0x50ae63(0x1f2)]||function(_0x5a59d4,_0x449d39){const _0x282241=_0x50ae63;if(typeof Reflect===_0x282241(0x22c)&&typeof Reflect[_0x282241(0x1f1)]===_0x282241(0x222))return Reflect[_0x282241(0x1f1)](_0x5a59d4,_0x449d39);},__param=this&&this[_0x50ae63(0x1f5)]||function(_0x1fd983,_0x434754){return function(_0x812945,_0x253e59){_0x434754(_0x812945,_0x253e59,_0x1fd983);};};Object[_0x50ae63(0x1df)](exports,_0x50ae63(0x20d),{'value':!![]}),exports['SigninService']=void 0x0;function _0x318b(_0x22e67,_0x4afd7d){const _0x5c62bb=_0x5c62();return _0x318b=function(_0x318b29,_0x17ec78){_0x318b29=_0x318b29-0x1d2;let _0x1fde1=_0x5c62bb[_0x318b29];return _0x1fde1;},_0x318b(_0x22e67,_0x4afd7d);}const globalConfig_service_1=require(_0x50ae63(0x1e0)),common_1=require(_0x50ae63(0x233)),signIn_entity_1=require(_0x50ae63(0x21b)),typeorm_1=require(_0x50ae63(0x1fc)),typeorm_2=require(_0x50ae63(0x1e1)),date_1=require(_0x50ae63(0x221)),balance_constant_1=require(_0x50ae63(0x237)),user_service_1=require('../user/user.service'),utils_1=require(_0x50ae63(0x1d3)),nestjs_cls_1=require(_0x50ae63(0x218));function _0x5c62(){const _0x392592=['maskEmail','__decorate','clsService','save','522pzAmeq','select','signInDate','defineProperty','./../globalConfig/globalConfig.service','typeorm','HttpException','getUserById','signinEntity','default','6380MoMNBk','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','Repository','signin.signInTime\x20<=\x20:lastDay','isSuper','signin.signInTime\x20>=\x20:firstDay','day','\x20AND\x20s.userId\x20=\x20','1249250bRwOgm','6tJZyyZ','decorate','metadata','__metadata','format','Connection','__param','month','isSigned','getReqSaasId','18410DDyfqD','push','昨天签到了、今天是连续签到！','@nestjs/typeorm','error:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','debug','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','获取签到数据失败！','globalConfigService','getSigninLog','%\x27\x20)','7194677SulNRA','toDate','311676eEOMAS','sign','user','query','find','InjectRepository','__esModule','\x20AND\x20s.createdAt\x20>=\x20\x27','forEach','updateSignDay','\x20AND\x20s.createdAt\x20<=\x20\x27','email','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','UserService','1339929elveQJ','GlobalConfigService','nestjs-cls','\x0a\x20\x20\x20\x20','BAD_REQUEST','./signIn.entity','用户不存在','changeScore4Other','userPage','design:paramtypes','YYYY-MM-DD','../../common/utils/date','function','SigninService','1902GMiWgy','andWhere','8cquESF','length','createQueryBuilder','userService','Logger','connection','object','今日已签到、改天再来吧!.','HttpStatus','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','昨天没签到、今天重置天数！','138402FNqBqp','EChangeType','@nestjs/common','\x20OFFSET\x20','signin.userId\x20=\x20:userId','endOf','../../common/constants/balance.constant','签到奖励','\x20AND\x20u.saasId\x20=\x20','YYYY-MM-DD\x20HH:mm:ss','getRawMany','../../common/utils','findOne','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','phone','isDefined'];_0x5c62=function(){return _0x392592;};return _0x5c62();}let SigninService=class SigninService{constructor(_0x56c9b4,_0x50c6c1,_0x2e9239,_0x4beda9,_0x826280){const _0x521f83=_0x50ae63;this[_0x521f83(0x1e4)]=_0x56c9b4,this[_0x521f83(0x1da)]=_0x50c6c1,this[_0x521f83(0x229)]=_0x2e9239,this[_0x521f83(0x202)]=_0x4beda9,this[_0x521f83(0x22b)]=_0x826280;}async[_0x50ae63(0x208)](_0x1b1396){const _0x27adca=_0x50ae63,_0x5718c0=_0x1b1396[_0x27adca(0x209)]['id'],_0x55c2cf=await this[_0x27adca(0x229)]['getUserById'](_0x5718c0),_0x143e28=(0x0,date_1['default'])()[_0x27adca(0x1f3)]('YYYY-MM-DD'),_0x3ef320=await this[_0x27adca(0x1e4)][_0x27adca(0x1d4)]({'where':{'userId':_0x5718c0,'signInDate':_0x143e28}});if(_0x3ef320)throw new common_1[(_0x27adca(0x1e2))](_0x27adca(0x22d),common_1['HttpStatus']['BAD_REQUEST']);const _0x39d8a4=await this[_0x27adca(0x1e4)][_0x27adca(0x1db)]({'userId':_0x5718c0,'signInTime':(0x0,date_1[_0x27adca(0x1e5)])()[_0x27adca(0x206)](),'signInDate':_0x143e28,'isSigned':!![]}),_0x50c617=await this['globalConfigService']['getSignatureGiftConfig']();_0x50c617&&await this['userService'][_0x27adca(0x21d)](_0x55c2cf,balance_constant_1[_0x27adca(0x232)]['SignInReward'],_0x50c617,_0x27adca(0x238),_0x39d8a4['id']);const _0x3f0668=(0x0,date_1[_0x27adca(0x1e5)])()['subtract'](0x1,_0x27adca(0x1ec))['format'](_0x27adca(0x220)),_0x407a44=await this[_0x27adca(0x1e4)]['findOne']({'where':{'userId':_0x5718c0,'signInDate':_0x3f0668}});if(_0x407a44){common_1[_0x27adca(0x22a)][_0x27adca(0x1ff)]('用户'+_0x5718c0+_0x27adca(0x1fb),'SigninService');const _0x18ea36=await this[_0x27adca(0x229)][_0x27adca(0x1e3)](_0x5718c0);if(!_0x18ea36)throw new common_1['HttpException'](_0x27adca(0x21c),common_1[_0x27adca(0x22e)][_0x27adca(0x21a)]);const {consecutiveDays:consecutiveDays=0x0}=_0x18ea36;await this[_0x27adca(0x229)]['updateSignDay'](_0x5718c0,consecutiveDays+0x1);}else common_1['Logger']['debug']('用户'+_0x5718c0+_0x27adca(0x230),_0x27adca(0x223)),await this[_0x27adca(0x229)][_0x27adca(0x210)](_0x5718c0,0x1);return _0x50c617;}async[_0x50ae63(0x203)](_0x5ced0e){const _0x27cedf=_0x50ae63;try{const _0x2744cb=(0x0,date_1[_0x27cedf(0x1e5)])()['startOf'](_0x27cedf(0x1f6))[_0x27cedf(0x1f3)](_0x27cedf(0x23a)),_0x464ba4=(0x0,date_1[_0x27cedf(0x1e5)])()[_0x27cedf(0x236)](_0x27cedf(0x1f6))[_0x27cedf(0x1f3)]('YYYY-MM-DD\x20HH:mm:ss'),_0x29daad=this[_0x27cedf(0x1e4)][_0x27cedf(0x228)]('signin'),_0x28bc08=await _0x29daad[_0x27cedf(0x1dd)](_0x27cedf(0x1d5))[_0x27cedf(0x225)](_0x27cedf(0x235),{'userId':_0x5ced0e[_0x27cedf(0x209)]['id']})[_0x27cedf(0x225)](_0x27cedf(0x1eb),{'firstDay':_0x2744cb})[_0x27cedf(0x225)](_0x27cedf(0x1e9),{'lastDay':_0x464ba4})[_0x27cedf(0x1d2)](),_0x296171=(0x0,date_1[_0x27cedf(0x1e5)])(_0x2744cb)[_0x27cedf(0x206)](),_0x3bdbed=(0x0,date_1[_0x27cedf(0x1e5)])(_0x464ba4)['toDate'](),_0xa9d29f=[],_0x9e2952=(0x0,date_1[_0x27cedf(0x1e5)])(_0x296171)[_0x27cedf(0x206)]();while(_0x9e2952<=_0x3bdbed){_0xa9d29f[_0x27cedf(0x1fa)]((0x0,date_1[_0x27cedf(0x1e5)])((0x0,date_1[_0x27cedf(0x1e5)])(_0x9e2952))[_0x27cedf(0x1f3)](_0x27cedf(0x220))),_0x9e2952['setDate'](_0x9e2952['getDate']()+0x1);}const _0x126e76=[];for(const _0x37f98a of _0xa9d29f){const _0x438b10=_0x28bc08[_0x27cedf(0x20b)](_0x15ce9e=>_0x15ce9e[_0x27cedf(0x1de)]===_0x37f98a);!_0x438b10?_0x126e76[_0x27cedf(0x1fa)]({'signInDate':_0x37f98a,'isSigned':![]}):(_0x438b10[_0x27cedf(0x1f7)]=!![],_0x126e76[_0x27cedf(0x1fa)](_0x438b10));}return _0x126e76;}catch(_0x5543e0){console['log'](_0x27cedf(0x1fd),_0x5543e0);throw new common_1[(_0x27cedf(0x1e2))](_0x27cedf(0x201),common_1[_0x27cedf(0x22e)][_0x27cedf(0x21a)]);}}async[_0x50ae63(0x21e)](_0x559752,_0x367f63,_0x877b7){const _0x1bce6c=_0x50ae63,_0x18e99a=(0x0,utils_1[_0x1bce6c(0x1f8)])(this[_0x1bce6c(0x1da)]),{page:page=0x1,size:size=0x14,startTime:_0x905c8b,endTime:_0x1bc276,saasId:_0x55fb05,keyword:_0x17fceb}=_0x367f63,_0x470e24=_0x1bce6c(0x213)+(_0x877b7?_0x1bce6c(0x1ed)+_0x877b7:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x905c8b?_0x1bce6c(0x20e)+_0x905c8b+'\x27':'')+_0x1bce6c(0x1fe)+(_0x1bc276?_0x1bce6c(0x211)+_0x1bc276+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x18e99a!==0x0?'\x20AND\x20u.saasId\x20=\x20'+_0x18e99a:(0x0,utils_1[_0x1bce6c(0x1d7)])(_0x55fb05)?_0x1bce6c(0x239)+_0x55fb05:'')+_0x1bce6c(0x1fe)+(_0x17fceb?_0x1bce6c(0x22f)+_0x17fceb+_0x1bce6c(0x1e7)+_0x17fceb+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x17fceb+_0x1bce6c(0x200)+_0x17fceb+_0x1bce6c(0x204):'')+_0x1bce6c(0x219),_0x148434='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x470e24+_0x1bce6c(0x219),_0x166bc6='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x470e24+_0x1bce6c(0x214)+size+_0x1bce6c(0x234)+(page-0x1)*size+_0x1bce6c(0x219),_0x5610d8=await this[_0x1bce6c(0x22b)][_0x1bce6c(0x20a)](_0x148434),_0x35746c=await this[_0x1bce6c(0x22b)]['query'](_0x166bc6);return!(0x0,utils_1[_0x1bce6c(0x1ea)])(this['clsService'])&&_0x35746c[_0x1bce6c(0x20f)](_0x53e421=>{const _0xcd0591=_0x1bce6c;_0x53e421['email']=(0x0,utils_1[_0xcd0591(0x1d8)])(_0x53e421[_0xcd0591(0x212)]),_0x53e421[_0xcd0591(0x1d6)]=(0x0,utils_1[_0xcd0591(0x1d8)])(_0x53e421[_0xcd0591(0x1d6)]);}),{'rows':_0x35746c,'count':Number(_0x5610d8[0x0]?.['count']||0x0)};}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x50ae63(0x20c)])(signIn_entity_1['SigninEntity'])),__metadata(_0x50ae63(0x21f),[typeorm_2[_0x50ae63(0x1e8)],nestjs_cls_1['ClsService'],user_service_1[_0x50ae63(0x215)],globalConfig_service_1[_0x50ae63(0x217)],typeorm_2[_0x50ae63(0x1f4)]])],SigninService),exports[_0x50ae63(0x223)]=SigninService;