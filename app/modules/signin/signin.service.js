'use strict';const _0x12b9b2=_0x23bd;(function(_0x17a5d7,_0x5760f0){const _0x2c5868=_0x23bd,_0x6e909d=_0x17a5d7();while(!![]){try{const _0x540634=parseInt(_0x2c5868(0xdc))/0x1*(parseInt(_0x2c5868(0xbd))/0x2)+-parseInt(_0x2c5868(0xb6))/0x3*(-parseInt(_0x2c5868(0x107))/0x4)+-parseInt(_0x2c5868(0xe6))/0x5*(-parseInt(_0x2c5868(0x10d))/0x6)+-parseInt(_0x2c5868(0xf2))/0x7*(-parseInt(_0x2c5868(0xed))/0x8)+parseInt(_0x2c5868(0xd4))/0x9*(parseInt(_0x2c5868(0xaa))/0xa)+-parseInt(_0x2c5868(0xf4))/0xb+-parseInt(_0x2c5868(0xd3))/0xc*(parseInt(_0x2c5868(0xe0))/0xd);if(_0x540634===_0x5760f0)break;else _0x6e909d['push'](_0x6e909d['shift']());}catch(_0xa3784){_0x6e909d['push'](_0x6e909d['shift']());}}}(_0x1a94,0x3629b));function _0x23bd(_0x24b750,_0x2a7fd1){const _0x1a9461=_0x1a94();return _0x23bd=function(_0x23bd03,_0x26bd79){_0x23bd03=_0x23bd03-0xaa;let _0x5a46b1=_0x1a9461[_0x23bd03];return _0x5a46b1;},_0x23bd(_0x24b750,_0x2a7fd1);}var __decorate=this&&this[_0x12b9b2(0xb8)]||function(_0x12fdb0,_0x84c44c,_0x39db54,_0x504cf4){const _0x41c1cf=_0x12b9b2;var _0x5cb164=arguments[_0x41c1cf(0xe9)],_0x20a608=_0x5cb164<0x3?_0x84c44c:_0x504cf4===null?_0x504cf4=Object[_0x41c1cf(0xfc)](_0x84c44c,_0x39db54):_0x504cf4,_0x5e6c73;if(typeof Reflect===_0x41c1cf(0xec)&&typeof Reflect[_0x41c1cf(0x10b)]===_0x41c1cf(0xf5))_0x20a608=Reflect[_0x41c1cf(0x10b)](_0x12fdb0,_0x84c44c,_0x39db54,_0x504cf4);else{for(var _0x3147e5=_0x12fdb0[_0x41c1cf(0xe9)]-0x1;_0x3147e5>=0x0;_0x3147e5--)if(_0x5e6c73=_0x12fdb0[_0x3147e5])_0x20a608=(_0x5cb164<0x3?_0x5e6c73(_0x20a608):_0x5cb164>0x3?_0x5e6c73(_0x84c44c,_0x39db54,_0x20a608):_0x5e6c73(_0x84c44c,_0x39db54))||_0x20a608;}return _0x5cb164>0x3&&_0x20a608&&Object[_0x41c1cf(0xcc)](_0x84c44c,_0x39db54,_0x20a608),_0x20a608;},__metadata=this&&this['__metadata']||function(_0x28172a,_0x3bbad7){const _0x4fac49=_0x12b9b2;if(typeof Reflect==='object'&&typeof Reflect[_0x4fac49(0xc8)]==='function')return Reflect['metadata'](_0x28172a,_0x3bbad7);},__param=this&&this[_0x12b9b2(0xba)]||function(_0x39964e,_0x4d3821){return function(_0x3a0a4f,_0x32b881){_0x4d3821(_0x3a0a4f,_0x32b881,_0x39964e);};};function _0x1a94(){const _0x51b8fc=['5UxxmeT','toDate','signin.signInTime\x20<=\x20:lastDay','length','debug','SignInReward','object','8hdkOdf','phone','log','startOf','userPage','2934358qpuUqY','createQueryBuilder','1717166OCAPdV','function','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','InjectRepository','query','role','getOwnPropertyDescriptor','user','save','EChangeType','今日已签到、改天再来吧!.','globalConfigService','signin.userId\x20=\x20:userId','design:paramtypes','month','default','Logger','428SNOIgv','isSigned','getRawMany','setDate','decorate','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','2354238QQpVwu','10FZjntM','super','userEntity','\x20AND\x20s.createdAt\x20<=\x20','UserEntity','__esModule','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','@nestjs/common','YYYY-MM-DD\x20HH:mm:ss','昨天签到了、今天是连续签到！','HttpStatus','email','12057ASNZpw','signin.signInTime\x20>=\x20:firstDay','__decorate','Connection','__param','\x0a\x20\x20\x20\x20','signin','506rpqQLq','error:\x20','select','andWhere','push','format','用户不存在','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','../user/user.service','../../common/utils','\x20OFFSET\x20','metadata','SigninService','maskEmail','../../common/constants/balance.constant','defineProperty','YYYY-MM-DD','签到奖励','endOf','update','findOne','BAD_REQUEST','16068syNsLp','3294441EWyDuZ','connection','subtract','昨天没签到、今天重置天数！','\x20AND\x20s.userId\x20=\x20','typeorm','HttpException','Repository','395pSBcaZ','@nestjs/typeorm','signinEntity','./signIn.entity','12909kCkYpz','./../globalConfig/globalConfig.service','forEach','获取签到数据失败！','SigninEntity','userService'];_0x1a94=function(){return _0x51b8fc;};return _0x1a94();}Object[_0x12b9b2(0xcc)](exports,_0x12b9b2(0xaf),{'value':!![]}),exports[_0x12b9b2(0xc9)]=void 0x0;const globalConfig_service_1=require(_0x12b9b2(0xe1)),common_1=require(_0x12b9b2(0xb1)),signIn_entity_1=require(_0x12b9b2(0xdf)),typeorm_1=require(_0x12b9b2(0xdd)),typeorm_2=require(_0x12b9b2(0xd9)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),balance_constant_1=require(_0x12b9b2(0xcb)),user_service_1=require(_0x12b9b2(0xc5)),utils_1=require(_0x12b9b2(0xc6));let SigninService=class SigninService{constructor(_0xf45252,_0x237ebc,_0x71c7d1,_0x42e047,_0x4dedb2){const _0x4e888d=_0x12b9b2;this[_0x4e888d(0xde)]=_0xf45252,this['userEntity']=_0x237ebc,this[_0x4e888d(0xe5)]=_0x71c7d1,this['globalConfigService']=_0x42e047,this[_0x4e888d(0xd5)]=_0x4dedb2;}async['sign'](_0x2fb890){const _0x5e6cfd=_0x12b9b2,_0x2ce835=_0x2fb890[_0x5e6cfd(0xfd)]['id'],_0x135c03=await this[_0x5e6cfd(0xe5)]['getUserById'](_0x2ce835),_0x135502=(0x0,date_1[_0x5e6cfd(0x105)])()['format'](_0x5e6cfd(0xcd)),_0x406b50=await this[_0x5e6cfd(0xde)]['findOne']({'where':{'userId':_0x2ce835,'signInDate':_0x135502}});if(_0x406b50)throw new common_1[(_0x5e6cfd(0xda))](_0x5e6cfd(0x100),common_1[_0x5e6cfd(0xb4)][_0x5e6cfd(0xd2)]);const _0x43a49f=await this[_0x5e6cfd(0xde)][_0x5e6cfd(0xfe)]({'userId':_0x2ce835,'signInTime':(0x0,date_1['default'])()[_0x5e6cfd(0xe7)](),'signInDate':_0x135502,'isSigned':!![]}),_0x5998b5=await this[_0x5e6cfd(0x101)]['getSignatureGiftConfig']();_0x5998b5&&await this[_0x5e6cfd(0xe5)]['changeScore4Other'](_0x135c03,balance_constant_1[_0x5e6cfd(0xff)][_0x5e6cfd(0xeb)],_0x5998b5,_0x5e6cfd(0xce),_0x43a49f['id']);const _0x46c736=(0x0,date_1[_0x5e6cfd(0x105)])()[_0x5e6cfd(0xd6)](0x1,'day')[_0x5e6cfd(0xc2)](_0x5e6cfd(0xcd)),_0x3b8116=await this[_0x5e6cfd(0xde)][_0x5e6cfd(0xd1)]({'where':{'userId':_0x2ce835,'signInDate':_0x46c736}});if(_0x3b8116){common_1[_0x5e6cfd(0x106)][_0x5e6cfd(0xea)]('用户'+_0x2ce835+_0x5e6cfd(0xb3),_0x5e6cfd(0xc9));const _0xdf1a32=await this[_0x5e6cfd(0xac)][_0x5e6cfd(0xd1)]({'where':{'id':_0x2ce835}});if(!_0xdf1a32)throw new common_1['HttpException'](_0x5e6cfd(0xc3),common_1[_0x5e6cfd(0xb4)][_0x5e6cfd(0xd2)]);const {consecutiveDays:consecutiveDays=0x0}=_0xdf1a32;await this[_0x5e6cfd(0xac)][_0x5e6cfd(0xd0)]({'id':_0x2ce835},{'consecutiveDays':consecutiveDays+0x1});}else common_1['Logger']['debug']('用户'+_0x2ce835+_0x5e6cfd(0xd7),'SigninService'),await this[_0x5e6cfd(0xac)][_0x5e6cfd(0xd0)]({'id':_0x2ce835},{'consecutiveDays':0x1});return'Sign\x20in\x20successful.';}async['getSigninLog'](_0x1aaa15){const _0x27b120=_0x12b9b2;try{const _0x1a6f2b=(0x0,date_1[_0x27b120(0x105)])()[_0x27b120(0xf0)](_0x27b120(0x104))[_0x27b120(0xc2)]('YYYY-MM-DD\x20HH:mm:ss'),_0x3798fb=(0x0,date_1['default'])()[_0x27b120(0xcf)](_0x27b120(0x104))['format'](_0x27b120(0xb2)),_0x3962aa=this['signinEntity'][_0x27b120(0xf3)](_0x27b120(0xbc)),_0x1713e0=await _0x3962aa[_0x27b120(0xbf)](_0x27b120(0x10c))[_0x27b120(0xc0)](_0x27b120(0x102),{'userId':_0x1aaa15[_0x27b120(0xfd)]['id']})[_0x27b120(0xc0)](_0x27b120(0xb7),{'firstDay':_0x1a6f2b})[_0x27b120(0xc0)](_0x27b120(0xe8),{'lastDay':_0x3798fb})[_0x27b120(0x109)](),_0x1f66a0=(0x0,date_1[_0x27b120(0x105)])(_0x1a6f2b)[_0x27b120(0xe7)](),_0x4d42f=(0x0,date_1[_0x27b120(0x105)])(_0x3798fb)[_0x27b120(0xe7)](),_0x392601=[],_0x2fde04=(0x0,date_1[_0x27b120(0x105)])(_0x1f66a0)[_0x27b120(0xe7)]();while(_0x2fde04<=_0x4d42f){_0x392601[_0x27b120(0xc1)]((0x0,date_1['default'])((0x0,date_1[_0x27b120(0x105)])(_0x2fde04))['format']('YYYY-MM-DD')),_0x2fde04[_0x27b120(0x10a)](_0x2fde04['getDate']()+0x1);}const _0x57574e=[];for(const _0x611a of _0x392601){const _0xf7f16e=_0x1713e0['find'](_0x137dda=>_0x137dda['signInDate']===_0x611a);!_0xf7f16e?_0x57574e['push']({'signInDate':_0x611a,'isSigned':![]}):(_0xf7f16e[_0x27b120(0x108)]=!![],_0x57574e['push'](_0xf7f16e));}return _0x57574e;}catch(_0x198407){console[_0x27b120(0xef)](_0x27b120(0xbe),_0x198407);throw new common_1['HttpException'](_0x27b120(0xe3),common_1[_0x27b120(0xb4)]['BAD_REQUEST']);}}async[_0x12b9b2(0xf1)](_0x444f13,_0x26687a,_0x5c30dc){const _0x4a9579=_0x12b9b2,{page:page=0x1,size:size=0x14,startTime:_0x4efeb4,endTime:_0xf9a8aa,keyword:_0x2f5609}=_0x26687a,_0x4ecfa9=_0x4a9579(0xb0)+(_0x5c30dc?_0x4a9579(0xd8)+_0x5c30dc:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4efeb4?'\x20AND\x20s.createdAt\x20>=\x20'+_0x4efeb4:'')+_0x4a9579(0xf8)+(_0xf9a8aa?_0x4a9579(0xad)+_0xf9a8aa:'')+_0x4a9579(0xf8)+(_0x2f5609?_0x4a9579(0xf6)+_0x2f5609+'%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%'+_0x2f5609+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x2f5609+'%\x27\x20OR\x20u.email\x20LIKE\x20\x27%'+_0x2f5609+'%\x27\x20)':'')+_0x4a9579(0xbb),_0xb00ccf=_0x4a9579(0xf7)+_0x4ecfa9+_0x4a9579(0xbb),_0x3de635='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x4ecfa9+_0x4a9579(0xc4)+size+_0x4a9579(0xc7)+(page-0x1)*size+_0x4a9579(0xbb),_0x15ae29=await this[_0x4a9579(0xd5)]['query'](_0xb00ccf),_0xe0407f=await this[_0x4a9579(0xd5)][_0x4a9579(0xfa)](_0x3de635);return _0x444f13[_0x4a9579(0xfd)][_0x4a9579(0xfb)]!==_0x4a9579(0xab)&&_0xe0407f[_0x4a9579(0xe2)](_0x1cb9d8=>{const _0xf88527=_0x4a9579;_0x1cb9d8[_0xf88527(0xb5)]=(0x0,utils_1[_0xf88527(0xca)])(_0x1cb9d8[_0xf88527(0xb5)]),_0x1cb9d8[_0xf88527(0xee)]=(0x0,utils_1['maskEmail'])(_0x1cb9d8[_0xf88527(0xee)]);}),{'rows':_0xe0407f,'count':Number(_0x15ae29[0x0]?.['count']||0x0)};}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x12b9b2(0xf9)])(signIn_entity_1[_0x12b9b2(0xe4)])),__param(0x1,(0x0,typeorm_1[_0x12b9b2(0xf9)])(user_entity_1[_0x12b9b2(0xae)])),__metadata(_0x12b9b2(0x103),[typeorm_2['Repository'],typeorm_2[_0x12b9b2(0xdb)],user_service_1['UserService'],globalConfig_service_1['GlobalConfigService'],typeorm_2[_0x12b9b2(0xb9)]])],SigninService),exports[_0x12b9b2(0xc9)]=SigninService;