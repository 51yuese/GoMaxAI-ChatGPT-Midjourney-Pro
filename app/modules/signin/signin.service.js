'use strict';const _0x464d47=_0xdb3d;(function(_0x996164,_0x47546e){const _0x5428b2=_0xdb3d,_0x1aca3f=_0x996164();while(!![]){try{const _0x1cdc02=-parseInt(_0x5428b2(0xde))/0x1+parseInt(_0x5428b2(0x10e))/0x2*(parseInt(_0x5428b2(0xcd))/0x3)+-parseInt(_0x5428b2(0x119))/0x4+parseInt(_0x5428b2(0x125))/0x5*(-parseInt(_0x5428b2(0x116))/0x6)+parseInt(_0x5428b2(0x109))/0x7*(-parseInt(_0x5428b2(0xd6))/0x8)+parseInt(_0x5428b2(0xfb))/0x9+parseInt(_0x5428b2(0xe2))/0xa;if(_0x1cdc02===_0x47546e)break;else _0x1aca3f['push'](_0x1aca3f['shift']());}catch(_0x1c1e53){_0x1aca3f['push'](_0x1aca3f['shift']());}}}(_0x3ac0,0x80fe0));var __decorate=this&&this[_0x464d47(0xe1)]||function(_0x57f9f9,_0x578514,_0xe027a4,_0x19750d){const _0x1c116b=_0x464d47;var _0x49f4ad=arguments[_0x1c116b(0xe9)],_0x4928c6=_0x49f4ad<0x3?_0x578514:_0x19750d===null?_0x19750d=Object[_0x1c116b(0x10a)](_0x578514,_0xe027a4):_0x19750d,_0x5d6bc1;if(typeof Reflect===_0x1c116b(0x11f)&&typeof Reflect[_0x1c116b(0xd5)]===_0x1c116b(0xe3))_0x4928c6=Reflect['decorate'](_0x57f9f9,_0x578514,_0xe027a4,_0x19750d);else{for(var _0x14b33a=_0x57f9f9[_0x1c116b(0xe9)]-0x1;_0x14b33a>=0x0;_0x14b33a--)if(_0x5d6bc1=_0x57f9f9[_0x14b33a])_0x4928c6=(_0x49f4ad<0x3?_0x5d6bc1(_0x4928c6):_0x49f4ad>0x3?_0x5d6bc1(_0x578514,_0xe027a4,_0x4928c6):_0x5d6bc1(_0x578514,_0xe027a4))||_0x4928c6;}return _0x49f4ad>0x3&&_0x4928c6&&Object['defineProperty'](_0x578514,_0xe027a4,_0x4928c6),_0x4928c6;},__metadata=this&&this[_0x464d47(0xff)]||function(_0x302f56,_0x15133d){const _0x47d25b=_0x464d47;if(typeof Reflect==='object'&&typeof Reflect[_0x47d25b(0xd9)]===_0x47d25b(0xe3))return Reflect['metadata'](_0x302f56,_0x15133d);},__param=this&&this['__param']||function(_0x2f4e98,_0x1ee7ea){return function(_0x4b7ca5,_0x1ffccd){_0x1ee7ea(_0x4b7ca5,_0x1ffccd,_0x2f4e98);};};Object[_0x464d47(0xd2)](exports,_0x464d47(0x128),{'value':!![]}),exports[_0x464d47(0x11b)]=void 0x0;function _0xdb3d(_0x2f1df9,_0x371e4e){const _0x3ac0f5=_0x3ac0();return _0xdb3d=function(_0xdb3d69,_0x54dac4){_0xdb3d69=_0xdb3d69-0xc4;let _0x22fbc0=_0x3ac0f5[_0xdb3d69];return _0x22fbc0;},_0xdb3d(_0x2f1df9,_0x371e4e);}const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),common_1=require(_0x464d47(0xd7)),signIn_entity_1=require(_0x464d47(0x112)),typeorm_1=require(_0x464d47(0xd1)),typeorm_2=require(_0x464d47(0x113)),date_1=require('../../common/utils/date'),balance_constant_1=require(_0x464d47(0x107)),user_service_1=require(_0x464d47(0xfa)),utils_1=require('../../common/utils'),nestjs_cls_1=require('nestjs-cls');let SigninService=class SigninService{constructor(_0x2c14cb,_0x1134a3,_0x45cba8,_0x2eb3f9,_0x48ced3){const _0x7d3ac4=_0x464d47;this['signinEntity']=_0x2c14cb,this[_0x7d3ac4(0x11d)]=_0x1134a3,this[_0x7d3ac4(0x127)]=_0x45cba8,this[_0x7d3ac4(0x11c)]=_0x2eb3f9,this[_0x7d3ac4(0x100)]=_0x48ced3;}async['sign'](_0x4b1297){const _0x5b141c=_0x464d47,_0x179d89=_0x4b1297['user']['id'],_0x2d25b2=await this[_0x5b141c(0x127)][_0x5b141c(0x105)](_0x179d89),_0x472a95=(0x0,date_1[_0x5b141c(0xe8)])()[_0x5b141c(0xe5)]('YYYY-MM-DD'),_0x481706=await this['signinEntity'][_0x5b141c(0xdc)]({'where':{'userId':_0x179d89,'signInDate':_0x472a95}});if(_0x481706)throw new common_1[(_0x5b141c(0xd0))](_0x5b141c(0x115),common_1[_0x5b141c(0x12a)][_0x5b141c(0xe4)]);const _0xafd8c1=await this[_0x5b141c(0xf1)][_0x5b141c(0x118)]({'userId':_0x179d89,'signInTime':(0x0,date_1[_0x5b141c(0xe8)])()[_0x5b141c(0xef)](),'signInDate':_0x472a95,'isSigned':!![]}),_0x1b828c=await this[_0x5b141c(0x11c)]['getSignatureGiftConfig']();_0x1b828c&&await this['userService']['changeScore4Other'](_0x2d25b2,balance_constant_1[_0x5b141c(0xc9)][_0x5b141c(0xf5)],_0x1b828c,_0x5b141c(0x120),_0xafd8c1['id']);const _0x2cf04f=(0x0,date_1[_0x5b141c(0xe8)])()[_0x5b141c(0xec)](0x1,_0x5b141c(0xc4))[_0x5b141c(0xe5)](_0x5b141c(0xc7)),_0x4c8c7e=await this[_0x5b141c(0xf1)][_0x5b141c(0xdc)]({'where':{'userId':_0x179d89,'signInDate':_0x2cf04f}});if(_0x4c8c7e){common_1['Logger'][_0x5b141c(0x10f)]('用户'+_0x179d89+_0x5b141c(0xdf),'SigninService');const _0x2a4b21=await this['userService'][_0x5b141c(0x105)](_0x179d89);if(!_0x2a4b21)throw new common_1[(_0x5b141c(0xd0))](_0x5b141c(0xd3),common_1[_0x5b141c(0x12a)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x2a4b21;await this[_0x5b141c(0x127)]['updateSignDay'](_0x179d89,consecutiveDays+0x1);}else common_1[_0x5b141c(0xca)][_0x5b141c(0x10f)]('用户'+_0x179d89+_0x5b141c(0x108),_0x5b141c(0x11b)),await this[_0x5b141c(0x127)][_0x5b141c(0xd4)](_0x179d89,0x1);return _0x1b828c;}async[_0x464d47(0xfd)](_0x5a801a){const _0x3e19c7=_0x464d47;try{const _0x22ce77=(0x0,date_1['default'])()[_0x3e19c7(0x110)](_0x3e19c7(0xe6))[_0x3e19c7(0xe5)](_0x3e19c7(0x11e)),_0x5635f5=(0x0,date_1[_0x3e19c7(0xe8)])()[_0x3e19c7(0xeb)](_0x3e19c7(0xe6))['format'](_0x3e19c7(0x11e)),_0x405b10=this[_0x3e19c7(0xf1)][_0x3e19c7(0x126)]('signin'),_0x5b4d7c=await _0x405b10[_0x3e19c7(0x124)](_0x3e19c7(0xcb))['andWhere'](_0x3e19c7(0xf9),{'userId':_0x5a801a['user']['id']})[_0x3e19c7(0xf4)](_0x3e19c7(0x121),{'firstDay':_0x22ce77})[_0x3e19c7(0xf4)](_0x3e19c7(0xf7),{'lastDay':_0x5635f5})['getRawMany'](),_0x3d078e=(0x0,date_1[_0x3e19c7(0xe8)])(_0x22ce77)[_0x3e19c7(0xef)](),_0x3c29aa=(0x0,date_1['default'])(_0x5635f5)['toDate'](),_0x5600c7=[],_0x2072a5=(0x0,date_1['default'])(_0x3d078e)['toDate']();while(_0x2072a5<=_0x3c29aa){_0x5600c7[_0x3e19c7(0x111)]((0x0,date_1['default'])((0x0,date_1[_0x3e19c7(0xe8)])(_0x2072a5))[_0x3e19c7(0xe5)](_0x3e19c7(0xc7))),_0x2072a5[_0x3e19c7(0xda)](_0x2072a5['getDate']()+0x1);}const _0x2d64be=[];for(const _0x548c94 of _0x5600c7){const _0x356e20=_0x5b4d7c[_0x3e19c7(0x129)](_0x400109=>_0x400109[_0x3e19c7(0xea)]===_0x548c94);!_0x356e20?_0x2d64be[_0x3e19c7(0x111)]({'signInDate':_0x548c94,'isSigned':![]}):(_0x356e20[_0x3e19c7(0xc8)]=!![],_0x2d64be['push'](_0x356e20));}return _0x2d64be;}catch(_0x591d28){console[_0x3e19c7(0x104)](_0x3e19c7(0x103),_0x591d28);throw new common_1[(_0x3e19c7(0xd0))]('获取签到数据失败！',common_1[_0x3e19c7(0x12a)]['BAD_REQUEST']);}}async[_0x464d47(0xee)](_0x29f12c,_0x1c2312,_0x41da9c){const _0x4767f3=_0x464d47,_0x545dbc=(0x0,utils_1[_0x4767f3(0x117)])(this[_0x4767f3(0x11d)]),{page:page=0x1,size:size=0x14,startTime:_0x4c5464,endTime:_0x4bc09c,saasId:_0x18cb20,keyword:_0x59b1ea}=_0x1c2312,_0x5bbf91='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x41da9c?_0x4767f3(0xc6)+_0x41da9c:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4c5464?_0x4767f3(0xcf)+_0x4c5464+'\x27':'')+_0x4767f3(0xd8)+(_0x4bc09c?_0x4767f3(0xf3)+_0x4bc09c+'\x27':'')+_0x4767f3(0xd8)+(_0x545dbc!==0x0?_0x4767f3(0xf2)+_0x545dbc:(0x0,utils_1[_0x4767f3(0xfc)])(_0x18cb20)?_0x4767f3(0xf2)+_0x18cb20:'')+_0x4767f3(0xd8)+(_0x59b1ea?_0x4767f3(0xe0)+_0x59b1ea+_0x4767f3(0x10b)+_0x59b1ea+_0x4767f3(0xfe)+_0x59b1ea+_0x4767f3(0x102)+_0x59b1ea+_0x4767f3(0x106):'')+_0x4767f3(0xdd),_0x127758=_0x4767f3(0xf0)+_0x5bbf91+_0x4767f3(0xdd),_0x4cd02a=_0x4767f3(0x114)+_0x5bbf91+_0x4767f3(0xf6)+size+_0x4767f3(0x122)+(page-0x1)*size+_0x4767f3(0xdd),_0x5b6877=await this['connection'][_0x4767f3(0x11a)](_0x127758),_0xdedcb8=await this['connection'][_0x4767f3(0x11a)](_0x4cd02a);return!(0x0,utils_1['isSuper'])(this['clsService'])&&_0xdedcb8[_0x4767f3(0xf8)](_0x5a0175=>{const _0x4b2ba1=_0x4767f3;_0x5a0175['email']=(0x0,utils_1['maskEmail'])(_0x5a0175[_0x4b2ba1(0xc5)]),_0x5a0175[_0x4b2ba1(0x101)]=(0x0,utils_1[_0x4b2ba1(0xcc)])(_0x5a0175[_0x4b2ba1(0x101)]);}),{'rows':_0xdedcb8,'count':Number(_0x5b6877[0x0]?.['count']||0x0)};}};function _0x3ac0(){const _0x11bb45=['%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','error:\x20','log','getUserById','%\x27\x20)','../../common/constants/balance.constant','昨天没签到、今天重置天数！','1852137ydPtkO','getOwnPropertyDescriptor','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','Injectable','GlobalConfigService','6110cmArUr','debug','startOf','push','./signIn.entity','typeorm','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','今日已签到、改天再来吧!.','54ssXJmx','getReqSaasId','save','2919856nUeqZA','query','SigninService','globalConfigService','clsService','YYYY-MM-DD\x20HH:mm:ss','object','签到奖励','signin.signInTime\x20>=\x20:firstDay','\x20OFFSET\x20','Repository','select','94145KydwKl','createQueryBuilder','userService','__esModule','find','HttpStatus','day','email','\x20AND\x20s.userId\x20=\x20','YYYY-MM-DD','isSigned','EChangeType','Logger','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','maskEmail','960JEGkSj','ClsService','\x20AND\x20s.createdAt\x20>=\x20\x27','HttpException','@nestjs/typeorm','defineProperty','用户不存在','updateSignDay','decorate','8xigpsf','@nestjs/common','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','metadata','setDate','InjectRepository','findOne','\x0a\x20\x20\x20\x20','721700aqyapH','昨天签到了、今天是连续签到！','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','__decorate','10463630FMfSqv','function','BAD_REQUEST','format','month','UserService','default','length','signInDate','endOf','subtract','Connection','userPage','toDate','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','signinEntity','\x20AND\x20u.saasId\x20=\x20','\x20AND\x20s.createdAt\x20<=\x20\x27','andWhere','SignInReward','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','signin.signInTime\x20<=\x20:lastDay','forEach','signin.userId\x20=\x20:userId','../user/user.service','3510945VsjPVZ','isDefined','getSigninLog','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','__metadata','connection','phone'];_0x3ac0=function(){return _0x11bb45;};return _0x3ac0();}SigninService=__decorate([(0x0,common_1[_0x464d47(0x10c)])(),__param(0x0,(0x0,typeorm_1[_0x464d47(0xdb)])(signIn_entity_1['SigninEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x464d47(0x123)],nestjs_cls_1[_0x464d47(0xce)],user_service_1[_0x464d47(0xe7)],globalConfig_service_1[_0x464d47(0x10d)],typeorm_2[_0x464d47(0xed)]])],SigninService),exports['SigninService']=SigninService;