'use strict';const _0x350ffa=_0x3f1a;(function(_0x396b30,_0x394d94){const _0x1481a7=_0x3f1a,_0x3004ba=_0x396b30();while(!![]){try{const _0x283ecb=-parseInt(_0x1481a7(0x296))/0x1+parseInt(_0x1481a7(0x288))/0x2+parseInt(_0x1481a7(0x23b))/0x3+-parseInt(_0x1481a7(0x29c))/0x4*(-parseInt(_0x1481a7(0x29a))/0x5)+parseInt(_0x1481a7(0x218))/0x6+parseInt(_0x1481a7(0x2a7))/0x7+-parseInt(_0x1481a7(0x24e))/0x8*(parseInt(_0x1481a7(0x211))/0x9);if(_0x283ecb===_0x394d94)break;else _0x3004ba['push'](_0x3004ba['shift']());}catch(_0x29d724){_0x3004ba['push'](_0x3004ba['shift']());}}}(_0x57a6,0x7cf52));var __decorate=this&&this[_0x350ffa(0x209)]||function(_0x750814,_0x5bb5f5,_0x636635,_0x393ebb){const _0x210a08=_0x350ffa;var _0x42e8fa=arguments['length'],_0x425054=_0x42e8fa<0x3?_0x5bb5f5:_0x393ebb===null?_0x393ebb=Object[_0x210a08(0x1f6)](_0x5bb5f5,_0x636635):_0x393ebb,_0x49f1a6;if(typeof Reflect===_0x210a08(0x1f7)&&typeof Reflect[_0x210a08(0x1e4)]==='function')_0x425054=Reflect[_0x210a08(0x1e4)](_0x750814,_0x5bb5f5,_0x636635,_0x393ebb);else{for(var _0x4ead21=_0x750814['length']-0x1;_0x4ead21>=0x0;_0x4ead21--)if(_0x49f1a6=_0x750814[_0x4ead21])_0x425054=(_0x42e8fa<0x3?_0x49f1a6(_0x425054):_0x42e8fa>0x3?_0x49f1a6(_0x5bb5f5,_0x636635,_0x425054):_0x49f1a6(_0x5bb5f5,_0x636635))||_0x425054;}return _0x42e8fa>0x3&&_0x425054&&Object['defineProperty'](_0x5bb5f5,_0x636635,_0x425054),_0x425054;},__metadata=this&&this[_0x350ffa(0x287)]||function(_0x462c90,_0x4fc75f){const _0x1e7c08=_0x350ffa;if(typeof Reflect===_0x1e7c08(0x1f7)&&typeof Reflect[_0x1e7c08(0x1da)]===_0x1e7c08(0x235))return Reflect['metadata'](_0x462c90,_0x4fc75f);},__param=this&&this[_0x350ffa(0x202)]||function(_0x5ba6d3,_0x52c2e5){return function(_0x16318c,_0x9cf54b){_0x52c2e5(_0x16318c,_0x9cf54b,_0x5ba6d3);};};Object[_0x350ffa(0x22f)](exports,'__esModule',{'value':!![]}),exports[_0x350ffa(0x1ef)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x350ffa(0x244)),common_1=require(_0x350ffa(0x204)),crypto=require('crypto'),axios_1=require(_0x350ffa(0x1f1)),order_entity_1=require(_0x350ffa(0x29b)),cramiPackage_entity_1=require(_0x350ffa(0x29d)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x350ffa(0x21f)),utils_1=require('../../common/utils'),user_service_1=require(_0x350ffa(0x214)),redisCache_service_1=require('../redisCache/redisCache.service'),redisKey_constant_1=require('../../common/constants/redisKey.constant'),date_1=require(_0x350ffa(0x262)),WxPay=require(_0x350ffa(0x201)),AlipaySdk=require(_0x350ffa(0x207));let PayService=class PayService{constructor(_0x15a607,_0x3b7f46,_0x8337d0,_0x39f899,_0x38d681,_0x2ff8ae,_0x592ec8){const _0x2f25ed=_0x350ffa;this[_0x2f25ed(0x247)]=_0x15a607,this[_0x2f25ed(0x2a1)]=_0x3b7f46,this[_0x2f25ed(0x242)]=_0x8337d0,this['globalConfigService']=_0x39f899,this['userService']=_0x38d681,this[_0x2f25ed(0x239)]=_0x2ff8ae,this[_0x2f25ed(0x20a)]=_0x592ec8;}async[_0x350ffa(0x25f)](){}async[_0x350ffa(0x269)](_0x167d81){const _0x3869e5=_0x350ffa;if(_0x167d81[_0x3869e5(0x23c)]==_0x3869e5(0x28d))return this[_0x3869e5(0x1e5)](_0x167d81);if(_0x167d81[_0x3869e5(0x27a)]==_0x3869e5(0x1e9))return this[_0x3869e5(0x245)](_0x167d81);if(typeof _0x167d81[_0x3869e5(0x219)]==_0x3869e5(0x1f7))return this['notifyWeChat'](_0x167d81);return this['notifyMpay'](_0x167d81);}async[_0x350ffa(0x246)](_0x45cf7c,_0x517855,_0x5bc6f9='wxpay'){const _0x4a0122=_0x350ffa,_0x4b7897=await this[_0x4a0122(0x2a1)]['findOne']({'where':{'userId':_0x45cf7c,'orderId':_0x517855}});if(!_0x4b7897)throw new common_1[(_0x4a0122(0x1db))](_0x4a0122(0x221),common_1[_0x4a0122(0x1e1)]['BAD_REQUEST']);const _0x2fbc48=await this[_0x4a0122(0x247)][_0x4a0122(0x297)]({'where':{'id':_0x4b7897[_0x4a0122(0x208)]}});if(!_0x2fbc48)throw new common_1['HttpException'](_0x4a0122(0x29e),common_1[_0x4a0122(0x1e1)][_0x4a0122(0x294)]);console[_0x4a0122(0x1d3)](_0x4a0122(0x1fd),_0x4b7897[_0x4a0122(0x250)]);try{if(_0x4b7897[_0x4a0122(0x250)]==_0x4a0122(0x1ff))return this[_0x4a0122(0x227)](_0x45cf7c,_0x517855,_0x5bc6f9);if(_0x4b7897['payPlatform']==_0x4a0122(0x282))return this[_0x4a0122(0x1d5)](_0x45cf7c,_0x517855,_0x5bc6f9);if(_0x4b7897[_0x4a0122(0x250)]=='epay')return this[_0x4a0122(0x293)](_0x45cf7c,_0x517855,_0x5bc6f9);if(_0x4b7897['payPlatform']==_0x4a0122(0x24c))return this['payMpay'](_0x45cf7c,_0x517855,_0x5bc6f9);if(_0x4b7897[_0x4a0122(0x250)]==_0x4a0122(0x1e9))return this[_0x4a0122(0x276)](_0x45cf7c,_0x517855,_0x5bc6f9);}catch(_0x1b56c9){console[_0x4a0122(0x1d3)](_0x4a0122(0x240),_0x1b56c9);throw new common_1[(_0x4a0122(0x1db))](_0x4a0122(0x25b),common_1['HttpStatus'][_0x4a0122(0x294)]);}}async[_0x350ffa(0x251)](_0x54a313){const _0xd4b7d0=_0x350ffa,_0x1e05e6=await this['orderEntity']['findOne']({'where':{'orderId':_0x54a313}});if(!_0x1e05e6)throw new common_1[(_0xd4b7d0(0x1db))](_0xd4b7d0(0x221),common_1[_0xd4b7d0(0x1e1)]['BAD_REQUEST']);return _0x1e05e6;}async[_0x350ffa(0x245)](_0x1f7e86){const _0x469a47=_0x350ffa,_0x25c5c0=await this['globalConfigService'][_0x469a47(0x1d7)]([_0x469a47(0x27b)]),_0x5b9043=_0x1f7e86[_0x469a47(0x23a)];delete _0x1f7e86[_0x469a47(0x23a)];if(this[_0x469a47(0x29f)](_0x1f7e86,_0x25c5c0)!=_0x5b9043)return _0x469a47(0x289);const _0x592d36=await this[_0x469a47(0x2a1)]['findOne']({'where':{'orderId':_0x1f7e86[_0x469a47(0x24f)],'status':0x0}});if(!_0x592d36)return _0x469a47(0x289);await this['userBalanceService']['addBalanceToOrder'](_0x592d36);const _0x1d2d15=await this[_0x469a47(0x2a1)][_0x469a47(0x1f5)]({'orderId':_0x1f7e86[_0x469a47(0x24f)]},{'status':0x1,'paydAt':(0x0,date_1[_0x469a47(0x225)])()[_0x469a47(0x272)]()});if(_0x1d2d15[_0x469a47(0x275)]!=0x1)return _0x469a47(0x289);return _0x469a47(0x24a);}async[_0x350ffa(0x276)](_0x5d47b3,_0x161ac1,_0x5deb4f=_0x350ffa(0x257)){const _0x244ddc=_0x350ffa,_0x1b3879=await this[_0x244ddc(0x2a1)][_0x244ddc(0x297)]({'where':{'userId':_0x5d47b3,'orderId':_0x161ac1}});if(!_0x1b3879)throw new common_1[(_0x244ddc(0x1db))](_0x244ddc(0x221),common_1[_0x244ddc(0x1e1)][_0x244ddc(0x294)]);const _0x48f801=await this[_0x244ddc(0x247)][_0x244ddc(0x297)]({'where':{'id':_0x1b3879[_0x244ddc(0x208)]}});if(!_0x48f801)throw new common_1[(_0x244ddc(0x1db))](_0x244ddc(0x29e),common_1[_0x244ddc(0x1e1)]['BAD_REQUEST']);const {payHupiAppId:_0x1feca9,payHupiSecret:_0x403a18,payHupiNotifyUrl:_0x3b6578,payHupiReturnUrl:_0x1f570c,payHupiGatewayUrl:_0x32142d}=await this['globalConfigService'][_0x244ddc(0x1d7)]([_0x244ddc(0x26c),_0x244ddc(0x27b),_0x244ddc(0x281),_0x244ddc(0x215),_0x244ddc(0x264)]),_0x4c8ae3={};_0x4c8ae3['version']=_0x244ddc(0x274),_0x4c8ae3[_0x244ddc(0x1f4)]=_0x1feca9,_0x4c8ae3[_0x244ddc(0x23d)]=(Date['now']()/0x3e8)[_0x244ddc(0x260)](0x0),_0x4c8ae3[_0x244ddc(0x256)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x4c8ae3[_0x244ddc(0x24f)]=_0x161ac1,_0x4c8ae3[_0x244ddc(0x1de)]=_0x48f801[_0x244ddc(0x258)],_0x4c8ae3['total_fee']=_0x1b3879[_0x244ddc(0x20c)],_0x4c8ae3[_0x244ddc(0x263)]=_0x3b6578,_0x4c8ae3['return_url']=_0x1f570c,_0x4c8ae3['attach']=_0x244ddc(0x1e9),_0x4c8ae3[_0x244ddc(0x23a)]=this['sign'](_0x4c8ae3,_0x403a18);const {data:{errcode:_0x58dd60,errmsg:_0x5ac696,url_qrcode:_0x4cc702,url:_0x507693}}=await axios_1[_0x244ddc(0x225)]['post'](_0x32142d||'https://api.xunhupay.com/payment/do.html',_0x4c8ae3);if(_0x58dd60!=0x0)throw new common_1['HttpException'](_0x5ac696,common_1[_0x244ddc(0x1e1)][_0x244ddc(0x294)]);return{'url_qrcode':_0x4cc702,'url':_0x507693};}async['queryHupi'](_0x53d196){const _0x4f4f93=_0x350ffa,{payHupiAppId:_0x1908aa,payHupiSecret:_0x376a5b}=await this['globalConfigService'][_0x4f4f93(0x1d7)]([_0x4f4f93(0x26c),_0x4f4f93(0x27b)]),_0x171160={};_0x171160[_0x4f4f93(0x1d2)]='1.1',_0x171160['appid']=_0x1908aa,_0x171160[_0x4f4f93(0x23d)]=(Date['now']()/0x3e8)[_0x4f4f93(0x260)](0x0),_0x171160[_0x4f4f93(0x256)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x171160['out_trade_order']=_0x53d196,_0x171160[_0x4f4f93(0x23a)]=this[_0x4f4f93(0x29f)](_0x171160,_0x376a5b);const {data:{errcode:_0x2c09ad,errmsg:_0x5ac75d,data:_0x57fa97}}=await axios_1[_0x4f4f93(0x225)]['post'](_0x4f4f93(0x27e),_0x171160);if(_0x2c09ad!=0x0)throw new common_1['HttpException'](_0x5ac75d,common_1[_0x4f4f93(0x1e1)][_0x4f4f93(0x294)]);return _0x57fa97;}async[_0x350ffa(0x1e5)](_0x502504){const _0x1944e8=_0x350ffa,_0x29650f=_0x502504[_0x1944e8(0x29f)];delete _0x502504[_0x1944e8(0x29f)],delete _0x502504[_0x1944e8(0x1f0)];const _0x2c06e0=await this['globalConfigService']['getConfigByKeys']([_0x1944e8(0x2a4)]);if(this[_0x1944e8(0x29f)](_0x502504,_0x2c06e0)!=_0x29650f)return _0x1944e8(0x289);console[_0x1944e8(0x1d3)](_0x1944e8(0x206));const _0x181d86=await this['orderEntity'][_0x1944e8(0x297)]({'where':{'orderId':_0x502504[_0x1944e8(0x243)],'status':0x0}});if(!_0x181d86)return _0x1944e8(0x289);const _0x4790a5=_0x502504['trade_status']==_0x1944e8(0x1df)?0x1:0x2,_0x540f57=await this[_0x1944e8(0x2a1)][_0x1944e8(0x1f5)]({'orderId':_0x502504[_0x1944e8(0x243)]},{'status':_0x4790a5,'paydAt':(0x0,date_1['default'])()[_0x1944e8(0x272)]()});_0x4790a5===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x181d86);if(_0x540f57[_0x1944e8(0x275)]!=0x1)return _0x1944e8(0x289);return _0x1944e8(0x24a);}async[_0x350ffa(0x293)](_0x83db9e,_0xbcc69e,_0x54dde0=_0x350ffa(0x1ff)){const _0x1cb1d0=_0x350ffa,_0x10ef52=await this[_0x1cb1d0(0x2a1)][_0x1cb1d0(0x297)]({'where':{'userId':_0x83db9e,'orderId':_0xbcc69e}});if(!_0x10ef52)throw new common_1[(_0x1cb1d0(0x1db))]('订单不存在!',common_1[_0x1cb1d0(0x1e1)][_0x1cb1d0(0x294)]);const _0x376f16=await this[_0x1cb1d0(0x247)][_0x1cb1d0(0x297)]({'where':{'id':_0x10ef52[_0x1cb1d0(0x208)]}});if(!_0x376f16)throw new common_1['HttpException'](_0x1cb1d0(0x29e),common_1[_0x1cb1d0(0x1e1)][_0x1cb1d0(0x294)]);const {payEpayPid:_0x3bf3c7,payEpaySecret:_0x5b9669,payEpayNotifyUrl:_0x2d769f,payEpayReturnUrl:_0x2bd24f,payEpayApiPayUrl:_0xe99a0e}=await this[_0x1cb1d0(0x1fa)]['getConfigByKeys']([_0x1cb1d0(0x26d),_0x1cb1d0(0x2a4),'payEpayNotifyUrl',_0x1cb1d0(0x241),_0x1cb1d0(0x285)]);let _0x1a86e8;_0x3bf3c7[_0x1cb1d0(0x1d4)]<=0x10?_0x1a86e8=Number(_0x3bf3c7):_0x1a86e8=BigInt(_0x3bf3c7);const _0x25dccc={};_0x25dccc[_0x1cb1d0(0x27d)]=_0x1a86e8,_0x25dccc[_0x1cb1d0(0x2a2)]=_0x54dde0,_0x25dccc[_0x1cb1d0(0x243)]=_0xbcc69e,_0x25dccc[_0x1cb1d0(0x258)]=_0x376f16['name'],_0x25dccc[_0x1cb1d0(0x1e3)]=_0x10ef52['total'],_0x25dccc[_0x1cb1d0(0x1e6)]=_0x1cb1d0(0x26f),_0x25dccc[_0x1cb1d0(0x205)]='pc',_0x25dccc[_0x1cb1d0(0x263)]=_0x2d769f,_0x25dccc[_0x1cb1d0(0x1f9)]=_0x2bd24f,_0x25dccc[_0x1cb1d0(0x23c)]='epay',_0x25dccc['sign']=this[_0x1cb1d0(0x29f)](_0x25dccc,_0x5b9669),_0x25dccc[_0x1cb1d0(0x1f0)]=_0x1cb1d0(0x28b);const _0x5b3a20=new URLSearchParams(_0x25dccc)[_0x1cb1d0(0x28c)](),_0x13c48b=_0xe99a0e+'?'+_0x5b3a20;if(_0xe99a0e[_0x1cb1d0(0x283)](_0x1cb1d0(0x232)))return{'url_qrcode':null,'redirectUrl':_0x13c48b,'channel':_0x54dde0,'isRedirect':!![]};else{const _0x58a640=await axios_1[_0x1cb1d0(0x225)][_0x1cb1d0(0x233)](_0xe99a0e,{'params':_0x25dccc});console[_0x1cb1d0(0x1d3)](_0x1cb1d0(0x1e7),_0x58a640['data']);const {data:{code:_0x2f985e,msg:_0x5ae85a,qrcode:_0x5797c3}}=_0x58a640;if(_0x2f985e!=0x1)throw new common_1[(_0x1cb1d0(0x1db))](_0x5ae85a,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x5797c3,'redirectUrl':null,'channel':_0x54dde0,'isRedirect':![]};}}async[_0x350ffa(0x277)](_0x2ada02){const _0x1b9d0a=_0x350ffa,{payEpayPid:_0x2b39f8,payEpaySecret:_0x26458a,payEpayApiQueryUrl:_0x28ed4f}=await this[_0x1b9d0a(0x1fa)][_0x1b9d0a(0x1d7)]([_0x1b9d0a(0x26d),_0x1b9d0a(0x2a4),_0x1b9d0a(0x1ec)]),_0x500441={};_0x500441['act']=_0x1b9d0a(0x284),_0x500441[_0x1b9d0a(0x243)]=_0x2ada02,_0x500441[_0x1b9d0a(0x27d)]=_0x2b39f8,_0x500441['key']=_0x26458a;const {data:{code:_0x3a9e3e,msg:_0x3a822e,data:_0x4cd6d5}}=await axios_1[_0x1b9d0a(0x225)][_0x1b9d0a(0x233)](_0x28ed4f,{'params':_0x500441});if(_0x3a9e3e!=0x1)throw new common_1[(_0x1b9d0a(0x1db))](_0x3a822e,common_1['HttpStatus']['BAD_REQUEST']);return _0x4cd6d5;}async[_0x350ffa(0x22d)](_0x589d7e){const _0x4f1f0d=_0x350ffa,_0x4599d0=_0x589d7e['sign'];delete _0x589d7e[_0x4f1f0d(0x29f)],delete _0x589d7e[_0x4f1f0d(0x1f0)];const _0x5a3c9d=await this[_0x4f1f0d(0x1fa)][_0x4f1f0d(0x1d7)]([_0x4f1f0d(0x22e)]);console[_0x4f1f0d(0x1d3)](_0x4f1f0d(0x212));if(this['sign'](_0x589d7e,_0x5a3c9d)!=_0x4599d0)return _0x4f1f0d(0x289);console[_0x4f1f0d(0x1d3)]('校验签名通过');const _0x77f62d=await this[_0x4f1f0d(0x2a1)][_0x4f1f0d(0x297)]({'where':{'orderId':_0x589d7e[_0x4f1f0d(0x243)],'status':0x0}});if(!_0x77f62d)return _0x4f1f0d(0x289);const _0x229eaa=_0x589d7e[_0x4f1f0d(0x1f3)]==_0x4f1f0d(0x1df)?0x1:0x2;console[_0x4f1f0d(0x1d3)](_0x4f1f0d(0x259),_0x229eaa);const _0x50589c=await this['orderEntity'][_0x4f1f0d(0x1f5)]({'orderId':_0x589d7e[_0x4f1f0d(0x243)]},{'status':_0x229eaa,'paydAt':(0x0,date_1[_0x4f1f0d(0x225)])()['toDate']()});_0x229eaa===0x1&&await this[_0x4f1f0d(0x242)][_0x4f1f0d(0x200)](_0x77f62d);if(_0x50589c[_0x4f1f0d(0x275)]!=0x1)return _0x4f1f0d(0x289);return'success';}async[_0x350ffa(0x266)](_0x2e03c1,_0x214c63,_0x18153d=_0x350ffa(0x257)){const _0x899394=_0x350ffa,_0x59d5bb=await this[_0x899394(0x2a1)]['findOne']({'where':{'userId':_0x2e03c1,'orderId':_0x214c63}});if(!_0x59d5bb)throw new common_1['HttpException'](_0x899394(0x221),common_1['HttpStatus']['BAD_REQUEST']);const _0x248f78=await this['cramiPackageEntity'][_0x899394(0x297)]({'where':{'id':_0x59d5bb[_0x899394(0x208)]}});if(!_0x248f78)throw new common_1[(_0x899394(0x1db))](_0x899394(0x29e),common_1[_0x899394(0x1e1)]['BAD_REQUEST']);const {payMpayPid:_0x636d93,payMpaySecret:_0x100c9a,payMpayNotifyUrl:_0x53adc7,payMpayReturnUrl:_0x39bfea,payMpayApiPayUrl:_0x1a36fa}=await this[_0x899394(0x1fa)][_0x899394(0x1d7)]([_0x899394(0x230),'payMpaySecret',_0x899394(0x21b),_0x899394(0x1fc),'payMpayApiPayUrl']),_0x2b88f2={};_0x2b88f2[_0x899394(0x27d)]=Number(_0x636d93),_0x2b88f2['type']=_0x18153d,_0x2b88f2['out_trade_no']=_0x214c63,_0x2b88f2[_0x899394(0x258)]=_0x248f78[_0x899394(0x258)],_0x2b88f2[_0x899394(0x1e3)]=_0x59d5bb['total'],_0x2b88f2[_0x899394(0x263)]=_0x53adc7,_0x2b88f2['return_url']=_0x39bfea,_0x2b88f2[_0x899394(0x29f)]=this[_0x899394(0x29f)](_0x2b88f2,_0x100c9a),_0x2b88f2[_0x899394(0x1f0)]=_0x899394(0x28b);const _0x51a8da=new URLSearchParams(_0x2b88f2)['toString'](),_0x505a4e=_0x1a36fa+'?'+_0x51a8da;return{'url_qrcode':null,'redirectUrl':_0x505a4e,'channel':_0x18153d,'isRedirect':!![]};}async[_0x350ffa(0x255)](_0x285e97){const _0x3a3b7c=_0x350ffa,{payMpayApiQueryUrl:_0x44773f}=await this[_0x3a3b7c(0x1fa)]['getConfigByKeys']([_0x3a3b7c(0x230),'payMpaySecret',_0x3a3b7c(0x210)]),_0x3b5e6a={};_0x3b5e6a[_0x3a3b7c(0x2a2)]=0x2,_0x3b5e6a[_0x3a3b7c(0x228)]=_0x285e97;const {data:{code:_0x58f5fb,msg:_0x5e3792,data:_0x5b8fab}}=await axios_1['default'][_0x3a3b7c(0x233)](_0x44773f,{'params':_0x3b5e6a});if(_0x58f5fb!=0x1)throw new common_1[(_0x3a3b7c(0x1db))](_0x5e3792,common_1[_0x3a3b7c(0x1e1)][_0x3a3b7c(0x294)]);return _0x5b8fab;}async[_0x350ffa(0x291)](_0x230200){const _0x21deea=_0x350ffa;console[_0x21deea(0x1d3)]('微信支付通知params:\x20',_0x230200);const {payWeChatAppId:_0x7ac5d2,payWeChatMchId:_0x25a026,payWeChatSecret:_0x3e34ab,payWeChatPublicKey:_0x4b1632,payWeChatPrivateKey:_0x5bdf63}=await this[_0x21deea(0x1fa)][_0x21deea(0x1d7)]([_0x21deea(0x1f2),_0x21deea(0x1fe),_0x21deea(0x267),_0x21deea(0x268),_0x21deea(0x21a)]),_0x3f4464=new WxPay({'appid':_0x7ac5d2,'mchid':_0x25a026,'publicKey':_0x4b1632,'privateKey':_0x5bdf63});let _0x5de902;try{if(_0x230200[_0x21deea(0x1f8)]==_0x21deea(0x254)){const {ciphertext:_0x41cfcc,associated_data:_0x37be18,nonce:_0xedce9c}=_0x230200[_0x21deea(0x219)],_0x1a11cc=_0x3f4464[_0x21deea(0x226)](_0x41cfcc,_0x37be18,_0xedce9c,_0x3e34ab),_0x593557=_0x1a11cc['out_trade_no'];_0x5de902=redisKey_constant_1[_0x21deea(0x1ed)]+_0x593557,await this[_0x21deea(0x239)][_0x21deea(0x299)]({'key':_0x5de902,'val':_0x21deea(0x203)});const _0x5aea60=await this[_0x21deea(0x2a1)][_0x21deea(0x297)]({'where':{'orderId':_0x593557,'status':0x0}});if(!_0x5aea60)return'failed';if([0x1,0x2,0x3]['includes'](_0x5aea60['status']))return _0x21deea(0x24a);const _0x3ba2d6=await this[_0x21deea(0x20a)][_0x21deea(0x1e8)](async _0x282b3b=>{const _0xbfbf0e=_0x21deea,_0x563c55=_0x1a11cc[_0xbfbf0e(0x217)]==_0xbfbf0e(0x224)?0x1:0x2,_0x3a04e1=await this['orderEntity']['update']({'orderId':_0x593557},{'status':_0x563c55,'paydAt':(0x0,date_1[_0xbfbf0e(0x225)])()[_0xbfbf0e(0x272)](),'tradeId':_0x1a11cc[_0xbfbf0e(0x280)]});return _0x563c55===0x1&&await this[_0xbfbf0e(0x242)]['addBalanceToOrder'](_0x5aea60),_0x3a04e1;});if(_0x3ba2d6[_0x21deea(0x275)]!=0x1)return _0x21deea(0x289);}return _0x21deea(0x24a);}catch(_0x1a6a7b){return console[_0x21deea(0x1d3)]('error:\x20',_0x1a6a7b),console[_0x21deea(0x1d3)](_0x21deea(0x22c),_0x1a6a7b),'failed';}finally{_0x5de902&&await this[_0x21deea(0x239)][_0x21deea(0x20d)]({'key':_0x5de902});}}async[_0x350ffa(0x227)](_0x227184,_0x41eefb,_0x23a73f){const _0x988050=_0x350ffa,_0x4f033a=await this[_0x988050(0x2a1)][_0x988050(0x297)]({'where':{'userId':_0x227184,'orderId':_0x41eefb}});if(!_0x4f033a)throw new common_1[(_0x988050(0x1db))](_0x988050(0x221),common_1['HttpStatus'][_0x988050(0x294)]);const _0x4c216a=await this[_0x988050(0x247)][_0x988050(0x297)]({'where':{'id':_0x4f033a['goodsId']}});if(!_0x4c216a)throw new common_1[(_0x988050(0x1db))]('套餐不存在!',common_1[_0x988050(0x1e1)]['BAD_REQUEST']);const _0x5b7f92={'bizContent':{'out_trade_no':_0x41eefb,'total_amount':_0x4f033a[_0x988050(0x20c)],'subject':_0x4c216a[_0x988050(0x258)]}};let _0x4e1bf9,_0x30f784,_0x56d77e,_0x32d5eb,_0x18ecda;const {payAliPublicSecret:_0xe96548,payAliWebAppId:_0x4a67c6,payAliWebSecret:_0x3aaa7c,payAliAppAppId:_0x5c5a19,payAliAppSecret:_0xe7770f,payWeChatNotifyUrl:_0x432043}=await this[_0x988050(0x1fa)][_0x988050(0x1d7)]([_0x988050(0x1fb),_0x988050(0x27f),_0x988050(0x1e0),_0x988050(0x28a),_0x988050(0x1eb),_0x988050(0x278)]);_0x23a73f===_0x988050(0x22b)&&(_0x5b7f92[_0x988050(0x25d)]=_0x988050(0x21e),_0x4e1bf9=_0x4a67c6,_0x56d77e='pageExec',_0x30f784=_0x3aaa7c,_0x32d5eb=_0x988050(0x238),_0x18ecda=_0x988050(0x265));_0x23a73f==='app'&&(_0x56d77e=_0x988050(0x271),_0x4e1bf9=_0x5c5a19,_0x30f784=_0xe7770f,_0x32d5eb=_0x988050(0x24b),_0x18ecda=_0x988050(0x279));const _0x1029cd=new AlipaySdk({'appId':_0x4e1bf9,'keyType':_0x988050(0x28e),'privateKey':_0x30f784,'alipayPublicKey':_0xe96548});_0x5b7f92[_0x988050(0x216)]=_0x432043,_0x5b7f92[_0x988050(0x21c)][_0x988050(0x20e)]=_0x18ecda;const _0x52d694=await _0x1029cd[_0x56d77e](_0x32d5eb,_0x5b7f92);return console['log'](_0x988050(0x24d),_0x52d694),_0x23a73f===_0x988050(0x22b)?{'form':_0x52d694}:{'data':_0x52d694};}async[_0x350ffa(0x213)](_0x2ff955,_0x2c206c){const _0x304497=_0x350ffa;let _0x171a7f,_0x4383e9;const {payAliPublicSecret:_0x38a3f3,payAliWebAppId:_0x1564f6,payAliWebSecret:_0x4654df,payAliAppAppId:_0x4900e4,payAliAppSecret:_0x426abd,payWeChatNotifyUrl:_0x1c146a}=await this[_0x304497(0x1fa)][_0x304497(0x1d7)](['payAliPublicSecret',_0x304497(0x27f),'payAliWebSecret',_0x304497(0x28a),_0x304497(0x1eb),_0x304497(0x278)]);_0x2c206c==='native'&&(_0x171a7f=_0x1564f6,_0x4383e9=_0x4654df);_0x2c206c===_0x304497(0x21d)&&(_0x171a7f=_0x4900e4,_0x4383e9=_0x426abd);const _0x130d04=new AlipaySdk({'appId':_0x171a7f,'keyType':'PKCS1','privateKey':_0x4383e9,'alipayPublicKey':_0x38a3f3}),_0x44f61a=await _0x130d04[_0x304497(0x25c)](_0x304497(0x26b),{'bizContent':{'out_trade_no':_0x2ff955}});return console[_0x304497(0x1d3)](_0x44f61a),_0x44f61a;}async[_0x350ffa(0x1d5)](_0x22fcc4,_0x337eff,_0x4d13cb=_0x350ffa(0x22b)){const _0x25daf6=_0x350ffa;console[_0x25daf6(0x1d3)](_0x25daf6(0x2a5),_0x4d13cb);const _0x55ea90=await this[_0x25daf6(0x2a1)][_0x25daf6(0x297)]({'where':{'userId':_0x22fcc4,'orderId':_0x337eff}});if(!_0x55ea90)throw new common_1[(_0x25daf6(0x1db))](_0x25daf6(0x221),common_1[_0x25daf6(0x1e1)]['BAD_REQUEST']);const _0x4fbd2a=await this['cramiPackageEntity'][_0x25daf6(0x297)]({'where':{'id':_0x55ea90['goodsId']}});if(!_0x4fbd2a)throw new common_1[(_0x25daf6(0x1db))](_0x25daf6(0x29e),common_1[_0x25daf6(0x1e1)]['BAD_REQUEST']);const {payWeChatAppId:_0x1cf522,payWeMiniAppId:_0x4121ad,payWeChatMchId:_0x36a678,payWeChatPublicKey:_0x28512f,payWeChatPrivateKey:_0x2c7d4f,payWeChatNotifyUrl:_0x1dc4af,payWeChatH5Name:_0x5be3b0,payWeChatH5Url:_0x27c315,WE_APP_APPID:_0x8de689,WE_APP_APPSECRET:_0x2b2e1a}=await this['globalConfigService'][_0x25daf6(0x1d7)]([_0x25daf6(0x1f2),'payWeMiniAppId','payWeChatMchId',_0x25daf6(0x268),_0x25daf6(0x21a),_0x25daf6(0x278),_0x25daf6(0x1dc),_0x25daf6(0x1d8),_0x25daf6(0x234)]),_0x3e3b63=new WxPay({'appid':_0x4d13cb===_0x25daf6(0x2a3)?_0x4121ad:_0x1cf522,'mchid':_0x36a678,'publicKey':_0x28512f,'privateKey':_0x2c7d4f}),_0x4feb23={'appid':_0x4d13cb===_0x25daf6(0x2a3)?_0x4121ad:_0x1cf522,'mchid':_0x36a678,'description':_0x4fbd2a[_0x25daf6(0x258)],'out_trade_no':_0x337eff,'notify_url':_0x1dc4af,'amount':{'total':Number(_0x55ea90[_0x25daf6(0x20c)]*0x64)},'scene_info':{'payer_client_ip':'192.168.1.100'}};console[_0x25daf6(0x1d3)](_0x25daf6(0x25a),_0x4feb23);if(_0x4d13cb=='h5'){_0x4feb23[_0x25daf6(0x1dd)]['h5_info']={'type':'Wap','app_name':_0x5be3b0,'app_url':_0x27c315};const _0x283933=await _0x3e3b63[_0x25daf6(0x290)](_0x4feb23);if(_0x283933[_0x25daf6(0x23e)]===0x193){const _0x1091b9=_0x283933?.['errRaw']?.[_0x25daf6(0x222)]?.[_0x25daf6(0x1d9)]?.[_0x25daf6(0x220)];throw new common_1[(_0x25daf6(0x1db))](_0x283933?.[_0x25daf6(0x220)]||'微信H5支付失败！',common_1[_0x25daf6(0x1e1)]['BAD_REQUEST']);}const {h5_url:_0x3cc4f8}=_0x283933;return{'url':_0x3cc4f8};}if(_0x4d13cb===_0x25daf6(0x21d)){_0x4feb23[_0x25daf6(0x1f4)]=_0x8de689;const _0x15f8ee=await _0x3e3b63[_0x25daf6(0x253)](_0x4feb23);return console['log']('App支付结果返回值:\x20',_0x15f8ee),_0x15f8ee;}if(_0x4d13cb==_0x25daf6(0x2a3)){const _0x2c02c7=await this[_0x25daf6(0x26e)][_0x25daf6(0x298)](_0x22fcc4);_0x4feb23['payer']={'openid':_0x2c02c7};const _0x570671=await _0x3e3b63[_0x25daf6(0x273)](_0x4feb23);return console[_0x25daf6(0x1d3)](_0x25daf6(0x20f),_0x570671),_0x570671;}if(_0x4d13cb==_0x25daf6(0x261)){const _0x13dd6d=await this[_0x25daf6(0x26e)]['getOpenIdByUserId'](_0x22fcc4);console[_0x25daf6(0x1d3)](_0x25daf6(0x2a0),_0x13dd6d),_0x4feb23[_0x25daf6(0x229)]={'openid':_0x13dd6d};const _0x48c0ee=await _0x3e3b63[_0x25daf6(0x273)](_0x4feb23);return console['log'](_0x25daf6(0x20f),_0x48c0ee),_0x48c0ee;}if(_0x4d13cb==_0x25daf6(0x22b)){const _0xa211aa=await _0x3e3b63['transactions_native'](_0x4feb23),{code_url:_0x2a73a5}=_0xa211aa;return!_0x2a73a5&&console[_0x25daf6(0x1d3)]('wx-native',_0xa211aa),{'url_qrcode':_0x2a73a5,'isRedirect':![]};}throw new common_1[(_0x25daf6(0x1db))](_0x25daf6(0x1ea),common_1['HttpStatus'][_0x25daf6(0x294)]);}async[_0x350ffa(0x231)](_0x59005d,_0xd383d4){const _0x47067f=_0x350ffa,{payWeChatAppId:_0xab8bac,payWeMiniAppId:_0xc0754f,payWeChatMchId:_0xd421dc,payWeChatPublicKey:_0x72a88c,payWeChatPrivateKey:_0x4e2f5b}=await this[_0x47067f(0x1fa)][_0x47067f(0x1d7)](['payWeChatAppId',_0x47067f(0x252),_0x47067f(0x1fe),_0x47067f(0x268),_0x47067f(0x21a)]),_0x1caa8c=new WxPay({'appid':_0xd383d4==='mini'?_0xc0754f:_0xab8bac,'mchid':_0xd421dc,'publicKey':_0x72a88c,'privateKey':_0x4e2f5b}),_0x35f0d0=await _0x1caa8c[_0x47067f(0x251)]({'out_trade_no':_0x59005d});return _0x35f0d0;}async['cancel'](_0x45b37f){const _0x1788c9=_0x350ffa;_0x45b37f[_0x1788c9(0x250)]===_0x1788c9(0x282)&&await this['cancelWxOrder'](_0x45b37f);}async[_0x350ffa(0x2a6)](_0x5ac27e){const _0x4bfd32=_0x350ffa,{payWeChatAppId:_0x42eea6,payWeMiniAppId:_0x5dd276,payWeChatMchId:_0x47c400,payWeChatPublicKey:_0x58a559,payWeChatPrivateKey:_0x120aa9}=await this[_0x4bfd32(0x1fa)][_0x4bfd32(0x1d7)]([_0x4bfd32(0x1f2),_0x4bfd32(0x252),_0x4bfd32(0x1fe),_0x4bfd32(0x268),_0x4bfd32(0x21a),'payWeChatNotifyUrl',_0x4bfd32(0x1dc),_0x4bfd32(0x1d8)]),_0x2bc018=new WxPay({'appid':_0x5ac27e[_0x4bfd32(0x20b)]===_0x4bfd32(0x2a3)?_0x5dd276:_0x42eea6,'mchid':_0x47c400,'publicKey':_0x58a559,'privateKey':_0x120aa9});await _0x2bc018[_0x4bfd32(0x270)](_0x5ac27e[_0x4bfd32(0x22a)]);}[_0x350ffa(0x29f)](_0x39ea35,_0x3c31a3){const _0x307edc=_0x350ffa,_0x47cde5=Object[_0x307edc(0x286)](_0x39ea35)[_0x307edc(0x1ee)]()[_0x307edc(0x292)](_0x446dfc=>_0x446dfc+'='+_0x39ea35[_0x446dfc])[_0x307edc(0x27c)]('&')+_0x3c31a3;return crypto[_0x307edc(0x237)](_0x307edc(0x248))['update'](_0x47cde5)[_0x307edc(0x1d6)](_0x307edc(0x295));}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x350ffa(0x23f)])(cramiPackage_entity_1[_0x350ffa(0x26a)])),__param(0x1,(0x0,typeorm_1[_0x350ffa(0x23f)])(order_entity_1['OrderEntity'])),__metadata(_0x350ffa(0x1e2),[typeorm_2[_0x350ffa(0x223)],typeorm_2[_0x350ffa(0x223)],userBalance_service_1[_0x350ffa(0x249)],globalConfig_service_1[_0x350ffa(0x236)],user_service_1[_0x350ffa(0x28f)],redisCache_service_1['RedisCacheService'],typeorm_2[_0x350ffa(0x25e)]])],PayService),exports[_0x350ffa(0x1ef)]=PayService;function _0x3f1a(_0x37a034,_0x2f45e7){const _0x57a63e=_0x57a6();return _0x3f1a=function(_0x3f1a9f,_0x1aee8d){_0x3f1a9f=_0x3f1a9f-0x1d2;let _0x401943=_0x57a63e[_0x3f1a9f];return _0x401943;},_0x3f1a(_0x37a034,_0x2f45e7);}function _0x57a6(){const _0x316422=['WE_APP_APPID','function','GlobalConfigService','createHash','alipay.trade.page.pay','redisCacheService','hash','469065GFGrTv','param','time','status','InjectRepository','支付请求失败:\x20','payEpayReturnUrl','userBalanceService','out_trade_no','typeorm','notifyHupi','pay','cramiPackageEntity','md5','UserBalanceService','success','alipay.trade.app.pay','mpay','alipay\x20result:\x20','3815088ingrda','trade_order_id','payPlatform','query','payWeMiniAppId','transactions_app','TRANSACTION.SUCCESS','queryMpay','nonce_str','wxpay','name','status:\x20','wechat-pay:\x20','支付请求失败!','exec','method','Connection','onModuleInit','toFixed','jsapi','../../common/utils/date','notify_url','payHupiGatewayUrl','FAST_INSTANT_TRADE_PAY','payMpay','payWeChatSecret','payWeChatPublicKey','notify','CramiPackageEntity','alipay.trade.query','payHupiAppId','payEpayPid','userService','192.168.1.100','close','sdkExec','toDate','transactions_jsapi','1.1','affected','payHupi','queryEpay','payWeChatNotifyUrl','QUICK_MSECURITY_PAY','attach','payHupiSecret','join','pid','https://api.xunhupay.com/payment/query.html','payAliWebAppId','transaction_id','payHupiNotifyUrl','wechat','includes','order','payEpayApiPayUrl','keys','__metadata','1089622gFZfIH','failed','payAliAppAppId','MD5','toString','epay','PKCS1','UserService','transactions_h5','notifyWeChat','map','payEpay','BAD_REQUEST','hex','854427ibEZxz','findOne','getMiniOpenIdByUserId','set','320lfKrZd','../order/order.entity','46076JnElEI','../crami/cramiPackage.entity','套餐不存在!','sign','用户openId:\x20','orderEntity','type','mini','payEpaySecret','payType:\x20','cancelWxOrder','3501841UuBfPQ','version','log','length','payWeChat','digest','getConfigByKeys','payWeChatH5Url','text','metadata','HttpException','payWeChatH5Name','scene_info','title','TRADE_SUCCESS','payAliWebSecret','HttpStatus','design:paramtypes','money','decorate','notifyEpay','clientip','epay\x20--->\x20res:\x20','transaction','hupi','unsupported\x20pay\x20type','payAliAppSecret','payEpayApiQueryUrl','PAY_UPDATE_ORDER','sort','PayService','sign_type','axios','payWeChatAppId','trade_status','appid','update','getOwnPropertyDescriptor','object','event_type','return_url','globalConfigService','payAliPublicSecret','payMpayReturnUrl','本次支付类型:\x20','payWeChatMchId','alipay','addBalanceToOrder','wechatpay-node-v3','__param','lock','@nestjs/common','device','校验签名通过','alipay-sdk','goodsId','__decorate','connection','channel','total','del','product_code','jsapi支付结果返回值:\x20','payMpayApiQueryUrl','18SeVpnW','校验签名','queryAliPay','../user/user.service','payHupiReturnUrl','setNotifyUrl','trade_state','2288280KjDMBx','resource','payWeChatPrivateKey','payMpayNotifyUrl','bizContent','app','POST','../globalConfig/globalConfig.service','message','订单不存在!','response','Repository','SUCCESS','default','decipher_gcm','payAli','order_no','payer','orderId','native','支付通知验证失败:\x20','notifyMpay','payMpaySecret','defineProperty','payMpayPid','queryWeChat','submit.php','get'];_0x57a6=function(){return _0x316422;};return _0x57a6();}