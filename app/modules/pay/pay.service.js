'use strict';function _0x87c4(_0x423fb4,_0xec4e90){const _0x5c8e1e=_0x5c8e();return _0x87c4=function(_0x87c478,_0x4017f){_0x87c478=_0x87c478-0x188;let _0xa6d20f=_0x5c8e1e[_0x87c478];return _0xa6d20f;},_0x87c4(_0x423fb4,_0xec4e90);}const _0x1c650a=_0x87c4;(function(_0x1c59b6,_0x2f67f1){const _0x23d730=_0x87c4,_0x342c74=_0x1c59b6();while(!![]){try{const _0x3b85a8=-parseInt(_0x23d730(0x191))/0x1*(parseInt(_0x23d730(0x1b7))/0x2)+-parseInt(_0x23d730(0x252))/0x3*(parseInt(_0x23d730(0x1f3))/0x4)+parseInt(_0x23d730(0x1e2))/0x5+-parseInt(_0x23d730(0x221))/0x6*(-parseInt(_0x23d730(0x204))/0x7)+-parseInt(_0x23d730(0x215))/0x8+parseInt(_0x23d730(0x22c))/0x9+-parseInt(_0x23d730(0x1b9))/0xa*(-parseInt(_0x23d730(0x21f))/0xb);if(_0x3b85a8===_0x2f67f1)break;else _0x342c74['push'](_0x342c74['shift']());}catch(_0x528dac){_0x342c74['push'](_0x342c74['shift']());}}}(_0x5c8e,0x27d60));var __decorate=this&&this[_0x1c650a(0x18a)]||function(_0x457550,_0x2e3659,_0x1ac1b3,_0x1cda47){const _0x1c1294=_0x1c650a;var _0x44974e=arguments[_0x1c1294(0x1a4)],_0x1ef257=_0x44974e<0x3?_0x2e3659:_0x1cda47===null?_0x1cda47=Object['getOwnPropertyDescriptor'](_0x2e3659,_0x1ac1b3):_0x1cda47,_0xf0e935;if(typeof Reflect===_0x1c1294(0x1ba)&&typeof Reflect[_0x1c1294(0x1bb)]==='function')_0x1ef257=Reflect[_0x1c1294(0x1bb)](_0x457550,_0x2e3659,_0x1ac1b3,_0x1cda47);else{for(var _0x5afe1d=_0x457550[_0x1c1294(0x1a4)]-0x1;_0x5afe1d>=0x0;_0x5afe1d--)if(_0xf0e935=_0x457550[_0x5afe1d])_0x1ef257=(_0x44974e<0x3?_0xf0e935(_0x1ef257):_0x44974e>0x3?_0xf0e935(_0x2e3659,_0x1ac1b3,_0x1ef257):_0xf0e935(_0x2e3659,_0x1ac1b3))||_0x1ef257;}return _0x44974e>0x3&&_0x1ef257&&Object[_0x1c1294(0x1de)](_0x2e3659,_0x1ac1b3,_0x1ef257),_0x1ef257;},__metadata=this&&this[_0x1c650a(0x1b2)]||function(_0x1f7acd,_0x45213d){const _0xa9978c=_0x1c650a;if(typeof Reflect===_0xa9978c(0x1ba)&&typeof Reflect[_0xa9978c(0x1f8)]==='function')return Reflect[_0xa9978c(0x1f8)](_0x1f7acd,_0x45213d);},__param=this&&this[_0x1c650a(0x1e0)]||function(_0x5b292d,_0x3bbda5){return function(_0x5b7db5,_0x1f5db7){_0x3bbda5(_0x5b7db5,_0x1f5db7,_0x5b292d);};};Object[_0x1c650a(0x1de)](exports,'__esModule',{'value':!![]}),exports[_0x1c650a(0x1df)]=void 0x0;function _0x5c8e(){const _0x34aa74=['decipher_gcm','app','out_trade_no','update','微信支付通知params:\x20','unsupported\x20pay\x20type','transactions_h5','支付通知验证失败:\x20','alipay\x20result:\x20','CramiPackageEntity','orderId','hupi','payEpayPid','payAliWebAppId','name','192.168.1.100','notify','del','微信H5支付失败！','userBalanceService','text','alipay.trade.query','defineProperty','PayService','__param','trade_state','134975MGyQgS','payAli','notifyEpay','payWeChatH5Name','set','notify_url','PAY_UPDATE_ORDER','cancelWxOrder','param','mini','design:paramtypes','HttpException','key','queryAliPay','default','sign_type','order','19104FwJxxX','queryEpay','total','InjectRepository','payMpayReturnUrl','metadata','payEpayApiQueryUrl','alipay','payAliPublicSecret','findOne','BAD_REQUEST','log','@nestjs/common','alipay.trade.page.pay','epay','payMpayPid','money','14GRaEjW','1.1','axios','query','act','userService','payWeChatMchId','product_code','failed','sort','payHupiReturnUrl','UserBalanceService','payMpayApiQueryUrl','../globalConfig/globalConfig.service','payWeChatNotifyUrl','payAliAppAppId','../order/order.entity','944544vdTDRC','method','createRandomNonceStr','Connection','map','payEpayReturnUrl','queryMpay','sign','pay','transactions_jsapi','561099JZcmnO','TRADE_SUCCESS','192306LlbZuw','payWeChatH5Url','epay\x20--->\x20res:\x20','PKCS1','addBalanceToOrder','payWeChat','toString','../userBalance/userBalance.service','crypto','校验签名','status:\x20','2210202bEuZnu','../../common/constants/redisKey.constant','keys','response','套餐不存在!','native','POST','订单不存在!','transactions_app','wxpay','TRANSACTION.SUCCESS','payMpaySecret','md5','OrderEntity','payWeChatSecret','Injectable','digest','device','globalConfigService','alipay.trade.app.pay','now','mpay','get','payHupiAppId','notifyMpay','sdkExec','success','校验签名通过','notifyWeChat','getMiniOpenIdByUserId','payWeChatPublicKey','transaction','onModuleInit','includes','payMpay','Repository','支付请求失败!','../../common/utils','96DBIXUz','bizContent','../../common/utils/date','payAliWebSecret','message','hash','__decorate','MD5','payWeChatPrivateKey','RedisCacheService','payHupiSecret','return_url','orderEntity','1vYqHzO','HttpStatus','join','nonce_str','h5_info','setNotifyUrl','payMpayApiPayUrl','queryWeChat','payWeChatAppId','trade_status','payHupiNotifyUrl','data','post','pid','cramiPackageEntity','payEpay','payEpaySecret','payPlatform','getOpenIdByUserId','length','../redisCache/redisCache.service','connection','lock','scene_info','UserService','toDate','getConfigByKeys','channel','payer','trade_order_id','goodsId','wechat','attach','__metadata','notifyHupi','toFixed','close','version','315304lvoHQR','type','50uIDgZx','object','decorate','queryHupi','event_type','status','affected','payAliAppSecret','Wap','redisCacheService','payHupi','payWeMiniAppId','支付请求失败:\x20','jsapi支付结果返回值:\x20','appid'];_0x5c8e=function(){return _0x34aa74;};return _0x5c8e();}const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),common_1=require(_0x1c650a(0x1ff)),crypto=require(_0x1c650a(0x229)),axios_1=require(_0x1c650a(0x206)),order_entity_1=require(_0x1c650a(0x214)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x1c650a(0x228)),globalConfig_service_1=require(_0x1c650a(0x211)),utils_1=require(_0x1c650a(0x251)),user_service_1=require('../user/user.service'),redisCache_service_1=require(_0x1c650a(0x1a5)),redisKey_constant_1=require(_0x1c650a(0x22d)),date_1=require(_0x1c650a(0x254)),WxPay=require('wechatpay-node-v3'),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x2367db,_0x5d8567,_0x5a1322,_0x43579d,_0x25f6ba,_0x57a397,_0x5869f5){const _0x145536=_0x1c650a;this[_0x145536(0x19f)]=_0x2367db,this[_0x145536(0x190)]=_0x5d8567,this[_0x145536(0x1db)]=_0x5a1322,this[_0x145536(0x23e)]=_0x43579d,this['userService']=_0x25f6ba,this['redisCacheService']=_0x57a397,this[_0x145536(0x1a6)]=_0x5869f5;}async[_0x1c650a(0x24c)](){}async[_0x1c650a(0x1d8)](_0x5a8903){const _0x17be25=_0x1c650a;if(_0x5a8903[_0x17be25(0x1ea)]=='epay')return this[_0x17be25(0x1e4)](_0x5a8903);if(_0x5a8903[_0x17be25(0x1b1)]=='hupi')return this[_0x17be25(0x1b3)](_0x5a8903);if(typeof _0x5a8903['resource']==_0x17be25(0x1ba))return this['notifyWeChat'](_0x5a8903);return this[_0x17be25(0x244)](_0x5a8903);}async[_0x1c650a(0x21d)](_0x12c57d,_0x2e7d22,_0x28f346=_0x1c650a(0x235)){const _0x3a35aa=_0x1c650a,_0x2faa2d=await this[_0x3a35aa(0x190)][_0x3a35aa(0x1fc)]({'where':{'userId':_0x12c57d,'orderId':_0x2e7d22}});if(!_0x2faa2d)throw new common_1[(_0x3a35aa(0x1ed))](_0x3a35aa(0x233),common_1[_0x3a35aa(0x192)][_0x3a35aa(0x1fd)]);const _0x541d69=await this['cramiPackageEntity'][_0x3a35aa(0x1fc)]({'where':{'id':_0x2faa2d[_0x3a35aa(0x1af)]}});if(!_0x541d69)throw new common_1['HttpException'](_0x3a35aa(0x230),common_1['HttpStatus']['BAD_REQUEST']);console[_0x3a35aa(0x1fe)]('本次支付类型:\x20',_0x2faa2d[_0x3a35aa(0x1a2)]);try{if(_0x2faa2d[_0x3a35aa(0x1a2)]==_0x3a35aa(0x1fa))return this[_0x3a35aa(0x1e3)](_0x12c57d,_0x2e7d22,_0x28f346);if(_0x2faa2d[_0x3a35aa(0x1a2)]==_0x3a35aa(0x1b0))return this['payWeChat'](_0x12c57d,_0x2e7d22,_0x28f346);if(_0x2faa2d[_0x3a35aa(0x1a2)]==_0x3a35aa(0x201))return this['payEpay'](_0x12c57d,_0x2e7d22,_0x28f346);if(_0x2faa2d[_0x3a35aa(0x1a2)]==_0x3a35aa(0x241))return this[_0x3a35aa(0x24e)](_0x12c57d,_0x2e7d22,_0x28f346);if(_0x2faa2d[_0x3a35aa(0x1a2)]==_0x3a35aa(0x1d3))return this[_0x3a35aa(0x1c3)](_0x12c57d,_0x2e7d22,_0x28f346);}catch(_0x4cdec1){console['log'](_0x3a35aa(0x1c5),_0x4cdec1);throw new common_1[(_0x3a35aa(0x1ed))](_0x3a35aa(0x250),common_1[_0x3a35aa(0x192)]['BAD_REQUEST']);}}async[_0x1c650a(0x207)](_0x536f4d){const _0x433caf=_0x1c650a,_0x2e6429=await this['orderEntity'][_0x433caf(0x1fc)]({'where':{'orderId':_0x536f4d}});if(!_0x2e6429)throw new common_1['HttpException']('订单不存在!',common_1[_0x433caf(0x192)][_0x433caf(0x1fd)]);return _0x2e6429;}async['notifyHupi'](_0x46e1bc){const _0xfcc94f=_0x1c650a,_0x250136=await this[_0xfcc94f(0x23e)][_0xfcc94f(0x1ab)]([_0xfcc94f(0x18e)]),_0x180c29=_0x46e1bc[_0xfcc94f(0x189)];delete _0x46e1bc[_0xfcc94f(0x189)];if(this[_0xfcc94f(0x21c)](_0x46e1bc,_0x250136)!=_0x180c29)return _0xfcc94f(0x20c);const _0x1dbad3=await this[_0xfcc94f(0x190)][_0xfcc94f(0x1fc)]({'where':{'orderId':_0x46e1bc[_0xfcc94f(0x1ae)],'status':0x0}});if(!_0x1dbad3)return _0xfcc94f(0x20c);await this[_0xfcc94f(0x1db)][_0xfcc94f(0x225)](_0x1dbad3);const _0x28004b=await this[_0xfcc94f(0x190)][_0xfcc94f(0x1cb)]({'orderId':_0x46e1bc[_0xfcc94f(0x1ae)]},{'status':0x1,'paydAt':(0x0,date_1[_0xfcc94f(0x1f0)])()[_0xfcc94f(0x1aa)]()});if(_0x28004b['affected']!=0x1)return _0xfcc94f(0x20c);return _0xfcc94f(0x246);}async[_0x1c650a(0x1c3)](_0x10b313,_0x1ac163,_0x2d74a9=_0x1c650a(0x235)){const _0x672d4b=_0x1c650a,_0x158b71=await this[_0x672d4b(0x190)][_0x672d4b(0x1fc)]({'where':{'userId':_0x10b313,'orderId':_0x1ac163}});if(!_0x158b71)throw new common_1[(_0x672d4b(0x1ed))]('订单不存在!',common_1[_0x672d4b(0x192)]['BAD_REQUEST']);const _0x3c66f4=await this[_0x672d4b(0x19f)][_0x672d4b(0x1fc)]({'where':{'id':_0x158b71[_0x672d4b(0x1af)]}});if(!_0x3c66f4)throw new common_1[(_0x672d4b(0x1ed))](_0x672d4b(0x230),common_1['HttpStatus'][_0x672d4b(0x1fd)]);const {payHupiAppId:_0x44a335,payHupiSecret:_0x199597,payHupiNotifyUrl:_0x198d18,payHupiReturnUrl:_0x2b3726,payHupiGatewayUrl:_0x4123b6}=await this[_0x672d4b(0x23e)][_0x672d4b(0x1ab)]([_0x672d4b(0x243),_0x672d4b(0x18e),_0x672d4b(0x19b),_0x672d4b(0x20e),'payHupiGatewayUrl']),_0x3b25f8={};_0x3b25f8[_0x672d4b(0x1b6)]='1.1',_0x3b25f8['appid']=_0x44a335,_0x3b25f8['time']=(Date[_0x672d4b(0x240)]()/0x3e8)['toFixed'](0x0),_0x3b25f8[_0x672d4b(0x194)]=(0x0,utils_1[_0x672d4b(0x217)])(0x20),_0x3b25f8[_0x672d4b(0x1ae)]=_0x1ac163,_0x3b25f8['title']=_0x3c66f4[_0x672d4b(0x1d6)],_0x3b25f8['total_fee']=_0x158b71[_0x672d4b(0x1f5)],_0x3b25f8['notify_url']=_0x198d18,_0x3b25f8[_0x672d4b(0x18f)]=_0x2b3726,_0x3b25f8[_0x672d4b(0x1b1)]=_0x672d4b(0x1d3),_0x3b25f8[_0x672d4b(0x189)]=this[_0x672d4b(0x21c)](_0x3b25f8,_0x199597);const {data:{errcode:_0x331ff6,errmsg:_0x24e3db,url_qrcode:_0x109a7c,url:_0x417de6}}=await axios_1[_0x672d4b(0x1f0)][_0x672d4b(0x19d)](_0x4123b6||'https://api.xunhupay.com/payment/do.html',_0x3b25f8);if(_0x331ff6!=0x0)throw new common_1[(_0x672d4b(0x1ed))](_0x24e3db,common_1['HttpStatus'][_0x672d4b(0x1fd)]);return{'url_qrcode':_0x109a7c,'url':_0x417de6};}async[_0x1c650a(0x1bc)](_0x530fc2){const _0x577501=_0x1c650a,{payHupiAppId:_0x196816,payHupiSecret:_0x3df4e6}=await this[_0x577501(0x23e)]['getConfigByKeys'](['payHupiAppId',_0x577501(0x18e)]),_0xe01d8a={};_0xe01d8a['version']=_0x577501(0x205),_0xe01d8a[_0x577501(0x1c7)]=_0x196816,_0xe01d8a['time']=(Date[_0x577501(0x240)]()/0x3e8)[_0x577501(0x1b4)](0x0),_0xe01d8a[_0x577501(0x194)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0xe01d8a['out_trade_order']=_0x530fc2,_0xe01d8a[_0x577501(0x189)]=this[_0x577501(0x21c)](_0xe01d8a,_0x3df4e6);const {data:{errcode:_0x220845,errmsg:_0x6fe635,data:_0x4b21f9}}=await axios_1[_0x577501(0x1f0)][_0x577501(0x19d)]('https://api.xunhupay.com/payment/query.html',_0xe01d8a);if(_0x220845!=0x0)throw new common_1['HttpException'](_0x6fe635,common_1[_0x577501(0x192)][_0x577501(0x1fd)]);return _0x4b21f9;}async['notifyEpay'](_0x281b06){const _0x4a5e20=_0x1c650a,_0x19a7e4=_0x281b06[_0x4a5e20(0x21c)];delete _0x281b06[_0x4a5e20(0x21c)],delete _0x281b06['sign_type'];const _0x47590f=await this[_0x4a5e20(0x23e)][_0x4a5e20(0x1ab)]([_0x4a5e20(0x1a1)]);if(this[_0x4a5e20(0x21c)](_0x281b06,_0x47590f)!=_0x19a7e4)return'failed';console[_0x4a5e20(0x1fe)]('校验签名通过');const _0x33aa3e=await this[_0x4a5e20(0x190)][_0x4a5e20(0x1fc)]({'where':{'orderId':_0x281b06[_0x4a5e20(0x1ca)],'status':0x0}});if(!_0x33aa3e)return _0x4a5e20(0x20c);const _0x46a523=_0x281b06['trade_status']==_0x4a5e20(0x220)?0x1:0x2,_0x3d0af5=await this[_0x4a5e20(0x190)][_0x4a5e20(0x1cb)]({'orderId':_0x281b06[_0x4a5e20(0x1ca)]},{'status':_0x46a523,'paydAt':(0x0,date_1[_0x4a5e20(0x1f0)])()[_0x4a5e20(0x1aa)]()});_0x46a523===0x1&&await this['userBalanceService'][_0x4a5e20(0x225)](_0x33aa3e);if(_0x3d0af5[_0x4a5e20(0x1bf)]!=0x1)return'failed';return _0x4a5e20(0x246);}async[_0x1c650a(0x1a0)](_0x409cfd,_0x1a6122,_0x147ecc=_0x1c650a(0x1fa)){const _0x27d4ad=_0x1c650a,_0x203071=await this['orderEntity'][_0x27d4ad(0x1fc)]({'where':{'userId':_0x409cfd,'orderId':_0x1a6122}});if(!_0x203071)throw new common_1[(_0x27d4ad(0x1ed))]('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x309abe=await this[_0x27d4ad(0x19f)]['findOne']({'where':{'id':_0x203071[_0x27d4ad(0x1af)]}});if(!_0x309abe)throw new common_1['HttpException']('套餐不存在!',common_1[_0x27d4ad(0x192)][_0x27d4ad(0x1fd)]);const {payEpayPid:_0x9ac76f,payEpaySecret:_0x1647db,payEpayNotifyUrl:_0x5566ca,payEpayReturnUrl:_0x568913,payEpayApiPayUrl:_0x3314bc}=await this[_0x27d4ad(0x23e)]['getConfigByKeys']([_0x27d4ad(0x1d4),_0x27d4ad(0x1a1),'payEpayNotifyUrl',_0x27d4ad(0x21a),'payEpayApiPayUrl']);let _0x21f7ab;_0x9ac76f[_0x27d4ad(0x1a4)]<=0x10?_0x21f7ab=Number(_0x9ac76f):_0x21f7ab=BigInt(_0x9ac76f);const _0x1a6a02={};_0x1a6a02[_0x27d4ad(0x19e)]=_0x21f7ab,_0x1a6a02[_0x27d4ad(0x1b8)]=_0x147ecc,_0x1a6a02[_0x27d4ad(0x1ca)]=_0x1a6122,_0x1a6a02[_0x27d4ad(0x1d6)]=_0x309abe[_0x27d4ad(0x1d6)],_0x1a6a02[_0x27d4ad(0x203)]=_0x203071[_0x27d4ad(0x1f5)],_0x1a6a02['clientip']=_0x27d4ad(0x1d7),_0x1a6a02[_0x27d4ad(0x23d)]='pc',_0x1a6a02[_0x27d4ad(0x1e7)]=_0x5566ca,_0x1a6a02[_0x27d4ad(0x18f)]=_0x568913,_0x1a6a02['param']=_0x27d4ad(0x201),_0x1a6a02[_0x27d4ad(0x21c)]=this[_0x27d4ad(0x21c)](_0x1a6a02,_0x1647db),_0x1a6a02[_0x27d4ad(0x1f1)]=_0x27d4ad(0x18b);const _0x3bba1e=new URLSearchParams(_0x1a6a02)['toString'](),_0x195d72=_0x3314bc+'?'+_0x3bba1e;if(_0x3314bc[_0x27d4ad(0x24d)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x195d72,'channel':_0x147ecc,'isRedirect':!![]};else{const _0x4add6f=await axios_1[_0x27d4ad(0x1f0)][_0x27d4ad(0x242)](_0x3314bc,{'params':_0x1a6a02});console[_0x27d4ad(0x1fe)](_0x27d4ad(0x223),_0x4add6f[_0x27d4ad(0x19c)]);const {data:{code:_0x730d8a,msg:_0x51e16e,qrcode:_0x12f1b4}}=_0x4add6f;if(_0x730d8a!=0x1)throw new common_1[(_0x27d4ad(0x1ed))](_0x51e16e,common_1[_0x27d4ad(0x192)][_0x27d4ad(0x1fd)]);return{'url_qrcode':_0x12f1b4,'redirectUrl':null,'channel':_0x147ecc,'isRedirect':![]};}}async[_0x1c650a(0x1f4)](_0x13b886){const _0x1642e3=_0x1c650a,{payEpayPid:_0x4174f9,payEpaySecret:_0x5c02ca,payEpayApiQueryUrl:_0x1c14be}=await this['globalConfigService'][_0x1642e3(0x1ab)]([_0x1642e3(0x1d4),_0x1642e3(0x1a1),_0x1642e3(0x1f9)]),_0x1876f7={};_0x1876f7[_0x1642e3(0x208)]=_0x1642e3(0x1f2),_0x1876f7[_0x1642e3(0x1ca)]=_0x13b886,_0x1876f7[_0x1642e3(0x19e)]=_0x4174f9,_0x1876f7[_0x1642e3(0x1ee)]=_0x5c02ca;const {data:{code:_0x273507,msg:_0x5d984d,data:_0x1dd907}}=await axios_1[_0x1642e3(0x1f0)][_0x1642e3(0x242)](_0x1c14be,{'params':_0x1876f7});if(_0x273507!=0x1)throw new common_1[(_0x1642e3(0x1ed))](_0x5d984d,common_1[_0x1642e3(0x192)][_0x1642e3(0x1fd)]);return _0x1dd907;}async['notifyMpay'](_0x444187){const _0x1c9f13=_0x1c650a,_0x160d33=_0x444187[_0x1c9f13(0x21c)];delete _0x444187[_0x1c9f13(0x21c)],delete _0x444187[_0x1c9f13(0x1f1)];const _0x4e0e59=await this[_0x1c9f13(0x23e)][_0x1c9f13(0x1ab)]([_0x1c9f13(0x237)]);console[_0x1c9f13(0x1fe)](_0x1c9f13(0x22a));if(this['sign'](_0x444187,_0x4e0e59)!=_0x160d33)return _0x1c9f13(0x20c);console['log'](_0x1c9f13(0x247));const _0x18db96=await this[_0x1c9f13(0x190)][_0x1c9f13(0x1fc)]({'where':{'orderId':_0x444187['out_trade_no'],'status':0x0}});if(!_0x18db96)return _0x1c9f13(0x20c);const _0x4b3bdd=_0x444187[_0x1c9f13(0x19a)]==_0x1c9f13(0x220)?0x1:0x2;console[_0x1c9f13(0x1fe)](_0x1c9f13(0x22b),_0x4b3bdd);const _0x525992=await this[_0x1c9f13(0x190)]['update']({'orderId':_0x444187['out_trade_no']},{'status':_0x4b3bdd,'paydAt':(0x0,date_1[_0x1c9f13(0x1f0)])()[_0x1c9f13(0x1aa)]()});_0x4b3bdd===0x1&&await this[_0x1c9f13(0x1db)][_0x1c9f13(0x225)](_0x18db96);if(_0x525992[_0x1c9f13(0x1bf)]!=0x1)return _0x1c9f13(0x20c);return'success';}async[_0x1c650a(0x24e)](_0x24d9cf,_0x402185,_0x1b6464=_0x1c650a(0x235)){const _0x500cc6=_0x1c650a,_0x589a10=await this[_0x500cc6(0x190)][_0x500cc6(0x1fc)]({'where':{'userId':_0x24d9cf,'orderId':_0x402185}});if(!_0x589a10)throw new common_1[(_0x500cc6(0x1ed))](_0x500cc6(0x233),common_1[_0x500cc6(0x192)][_0x500cc6(0x1fd)]);const _0x7a14ee=await this[_0x500cc6(0x19f)][_0x500cc6(0x1fc)]({'where':{'id':_0x589a10['goodsId']}});if(!_0x7a14ee)throw new common_1[(_0x500cc6(0x1ed))](_0x500cc6(0x230),common_1[_0x500cc6(0x192)]['BAD_REQUEST']);const {payMpayPid:_0x241b86,payMpaySecret:_0x354d9f,payMpayNotifyUrl:_0xe7520c,payMpayReturnUrl:_0xc57d0,payMpayApiPayUrl:_0x3b8d86}=await this[_0x500cc6(0x23e)][_0x500cc6(0x1ab)]([_0x500cc6(0x202),_0x500cc6(0x237),'payMpayNotifyUrl',_0x500cc6(0x1f7),_0x500cc6(0x197)]),_0x5883a4={};_0x5883a4[_0x500cc6(0x19e)]=Number(_0x241b86),_0x5883a4['type']=_0x1b6464,_0x5883a4[_0x500cc6(0x1ca)]=_0x402185,_0x5883a4[_0x500cc6(0x1d6)]=_0x7a14ee[_0x500cc6(0x1d6)],_0x5883a4[_0x500cc6(0x203)]=_0x589a10[_0x500cc6(0x1f5)],_0x5883a4['notify_url']=_0xe7520c,_0x5883a4['return_url']=_0xc57d0,_0x5883a4['sign']=this[_0x500cc6(0x21c)](_0x5883a4,_0x354d9f),_0x5883a4['sign_type']=_0x500cc6(0x18b);const _0x276c86=new URLSearchParams(_0x5883a4)[_0x500cc6(0x227)](),_0x5b519f=_0x3b8d86+'?'+_0x276c86;return{'url_qrcode':null,'redirectUrl':_0x5b519f,'channel':_0x1b6464,'isRedirect':!![]};}async[_0x1c650a(0x21b)](_0x1d5811){const _0x44d77d=_0x1c650a,{payMpayApiQueryUrl:_0x419f9d}=await this[_0x44d77d(0x23e)]['getConfigByKeys']([_0x44d77d(0x202),_0x44d77d(0x237),_0x44d77d(0x210)]),_0x258fab={};_0x258fab[_0x44d77d(0x1b8)]=0x2,_0x258fab['order_no']=_0x1d5811;const {data:{code:_0x502527,msg:_0x3654d5,data:_0x53cf50}}=await axios_1[_0x44d77d(0x1f0)][_0x44d77d(0x242)](_0x419f9d,{'params':_0x258fab});if(_0x502527!=0x1)throw new common_1[(_0x44d77d(0x1ed))](_0x3654d5,common_1[_0x44d77d(0x192)]['BAD_REQUEST']);return _0x53cf50;}async[_0x1c650a(0x248)](_0x4ee3c8){const _0x4a043e=_0x1c650a;console[_0x4a043e(0x1fe)](_0x4a043e(0x1cc),_0x4ee3c8);const {payWeChatAppId:_0x551b4a,payWeChatMchId:_0x2a7e79,payWeChatSecret:_0x318a55,payWeChatPublicKey:_0x31d8b6,payWeChatPrivateKey:_0x3b4ff0}=await this[_0x4a043e(0x23e)][_0x4a043e(0x1ab)]([_0x4a043e(0x199),_0x4a043e(0x20a),_0x4a043e(0x23a),_0x4a043e(0x24a),_0x4a043e(0x18c)]),_0xa8fb61=new WxPay({'appid':_0x551b4a,'mchid':_0x2a7e79,'publicKey':_0x31d8b6,'privateKey':_0x3b4ff0});let _0x59c939;try{if(_0x4ee3c8[_0x4a043e(0x1bd)]==_0x4a043e(0x236)){const {ciphertext:_0x4d2f2c,associated_data:_0x4fd9b2,nonce:_0x26ea29}=_0x4ee3c8['resource'],_0x436ceb=_0xa8fb61[_0x4a043e(0x1c8)](_0x4d2f2c,_0x4fd9b2,_0x26ea29,_0x318a55),_0x2ae665=_0x436ceb[_0x4a043e(0x1ca)];_0x59c939=redisKey_constant_1[_0x4a043e(0x1e8)]+_0x2ae665,await this[_0x4a043e(0x1c2)][_0x4a043e(0x1e6)]({'key':_0x59c939,'val':_0x4a043e(0x1a7)});const _0x48090d=await this[_0x4a043e(0x190)][_0x4a043e(0x1fc)]({'where':{'orderId':_0x2ae665,'status':0x0}});if(!_0x48090d)return _0x4a043e(0x20c);if([0x1,0x2,0x3]['includes'](_0x48090d[_0x4a043e(0x1be)]))return _0x4a043e(0x246);const _0x2fb5fc=await this[_0x4a043e(0x1a6)][_0x4a043e(0x24b)](async _0x441e02=>{const _0xbd976d=_0x4a043e,_0xdecb7c=_0x436ceb[_0xbd976d(0x1e1)]=='SUCCESS'?0x1:0x2,_0x17f68c=await this['orderEntity']['update']({'orderId':_0x2ae665},{'status':_0xdecb7c,'paydAt':(0x0,date_1[_0xbd976d(0x1f0)])()[_0xbd976d(0x1aa)](),'tradeId':_0x436ceb['transaction_id']});return _0xdecb7c===0x1&&await this[_0xbd976d(0x1db)][_0xbd976d(0x225)](_0x48090d),_0x17f68c;});if(_0x2fb5fc['affected']!=0x1)return'failed';}return _0x4a043e(0x246);}catch(_0x189d8e){return console[_0x4a043e(0x1fe)]('error:\x20',_0x189d8e),console[_0x4a043e(0x1fe)](_0x4a043e(0x1cf),_0x189d8e),_0x4a043e(0x20c);}finally{_0x59c939&&await this[_0x4a043e(0x1c2)][_0x4a043e(0x1d9)]({'key':_0x59c939});}}async[_0x1c650a(0x1e3)](_0x548abc,_0x6f0a54,_0x488ecf){const _0x13f575=_0x1c650a,_0x7d93b8=await this[_0x13f575(0x190)][_0x13f575(0x1fc)]({'where':{'userId':_0x548abc,'orderId':_0x6f0a54}});if(!_0x7d93b8)throw new common_1[(_0x13f575(0x1ed))](_0x13f575(0x233),common_1[_0x13f575(0x192)][_0x13f575(0x1fd)]);const _0xa32481=await this[_0x13f575(0x19f)][_0x13f575(0x1fc)]({'where':{'id':_0x7d93b8['goodsId']}});if(!_0xa32481)throw new common_1[(_0x13f575(0x1ed))]('套餐不存在!',common_1[_0x13f575(0x192)][_0x13f575(0x1fd)]);const _0x2c40d9={'bizContent':{'out_trade_no':_0x6f0a54,'total_amount':_0x7d93b8['total'],'subject':_0xa32481[_0x13f575(0x1d6)]}};let _0x423ca3,_0x5c20e6,_0x5de5f4,_0x2000fb,_0x3c26a2;const {payAliPublicSecret:_0x4ddca6,payAliWebAppId:_0x47b711,payAliWebSecret:_0x466497,payAliAppAppId:_0x58f2cf,payAliAppSecret:_0x13030d,payWeChatNotifyUrl:_0x179e71}=await this[_0x13f575(0x23e)]['getConfigByKeys'](['payAliPublicSecret',_0x13f575(0x1d5),_0x13f575(0x255),'payAliAppAppId',_0x13f575(0x1c0),_0x13f575(0x212)]);_0x488ecf===_0x13f575(0x231)&&(_0x2c40d9[_0x13f575(0x216)]=_0x13f575(0x232),_0x423ca3=_0x47b711,_0x5de5f4='pageExec',_0x5c20e6=_0x466497,_0x2000fb=_0x13f575(0x200),_0x3c26a2='FAST_INSTANT_TRADE_PAY');_0x488ecf===_0x13f575(0x1c9)&&(_0x5de5f4=_0x13f575(0x245),_0x423ca3=_0x58f2cf,_0x5c20e6=_0x13030d,_0x2000fb=_0x13f575(0x23f),_0x3c26a2='QUICK_MSECURITY_PAY');const _0x177509=new AlipaySdk({'appId':_0x423ca3,'keyType':_0x13f575(0x224),'privateKey':_0x5c20e6,'alipayPublicKey':_0x4ddca6});_0x2c40d9[_0x13f575(0x196)]=_0x179e71,_0x2c40d9[_0x13f575(0x253)][_0x13f575(0x20b)]=_0x3c26a2;const _0x50db7f=await _0x177509[_0x5de5f4](_0x2000fb,_0x2c40d9);return console['log'](_0x13f575(0x1d0),_0x50db7f),_0x488ecf===_0x13f575(0x231)?{'form':_0x50db7f}:{'data':_0x50db7f};}async[_0x1c650a(0x1ef)](_0x336d0f,_0x856a81){const _0x3b08a1=_0x1c650a;let _0xbc076b,_0x3c39f3;const {payAliPublicSecret:_0x5b0013,payAliWebAppId:_0x8ec67a,payAliWebSecret:_0x3c0bdc,payAliAppAppId:_0x5c22df,payAliAppSecret:_0x51e4e4,payWeChatNotifyUrl:_0xc13fcb}=await this[_0x3b08a1(0x23e)][_0x3b08a1(0x1ab)]([_0x3b08a1(0x1fb),_0x3b08a1(0x1d5),_0x3b08a1(0x255),_0x3b08a1(0x213),'payAliAppSecret','payWeChatNotifyUrl']);_0x856a81===_0x3b08a1(0x231)&&(_0xbc076b=_0x8ec67a,_0x3c39f3=_0x3c0bdc);_0x856a81===_0x3b08a1(0x1c9)&&(_0xbc076b=_0x5c22df,_0x3c39f3=_0x51e4e4);const _0x57cba9=new AlipaySdk({'appId':_0xbc076b,'keyType':_0x3b08a1(0x224),'privateKey':_0x3c39f3,'alipayPublicKey':_0x5b0013}),_0x232137=await _0x57cba9['exec'](_0x3b08a1(0x1dd),{'bizContent':{'out_trade_no':_0x336d0f}});return console['log'](_0x232137),_0x232137;}async[_0x1c650a(0x226)](_0x3289f1,_0x5eb983,_0x4ba3d6=_0x1c650a(0x231)){const _0x3597df=_0x1c650a;console[_0x3597df(0x1fe)]('payType:\x20',_0x4ba3d6);const _0x1dfe9f=await this[_0x3597df(0x190)][_0x3597df(0x1fc)]({'where':{'userId':_0x3289f1,'orderId':_0x5eb983}});if(!_0x1dfe9f)throw new common_1[(_0x3597df(0x1ed))](_0x3597df(0x233),common_1[_0x3597df(0x192)][_0x3597df(0x1fd)]);const _0x432c97=await this['cramiPackageEntity'][_0x3597df(0x1fc)]({'where':{'id':_0x1dfe9f[_0x3597df(0x1af)]}});if(!_0x432c97)throw new common_1[(_0x3597df(0x1ed))](_0x3597df(0x230),common_1[_0x3597df(0x192)][_0x3597df(0x1fd)]);const {payWeChatAppId:_0xd12530,payWeMiniAppId:_0x444b3f,payWeChatMchId:_0x140589,payWeChatPublicKey:_0x98ddf4,payWeChatPrivateKey:_0xb3857b,payWeChatNotifyUrl:_0x3e7fd6,payWeChatH5Name:_0x4b604a,payWeChatH5Url:_0x4b9a5f,WE_APP_APPID:_0x3843f4,WE_APP_APPSECRET:_0x10f433}=await this[_0x3597df(0x23e)][_0x3597df(0x1ab)]([_0x3597df(0x199),_0x3597df(0x1c4),_0x3597df(0x20a),'payWeChatPublicKey',_0x3597df(0x18c),_0x3597df(0x212),_0x3597df(0x1e5),_0x3597df(0x222),'WE_APP_APPID']),_0x4ae010=new WxPay({'appid':_0x4ba3d6===_0x3597df(0x1eb)?_0x444b3f:_0xd12530,'mchid':_0x140589,'publicKey':_0x98ddf4,'privateKey':_0xb3857b}),_0x1c6951={'appid':_0x4ba3d6===_0x3597df(0x1eb)?_0x444b3f:_0xd12530,'mchid':_0x140589,'description':_0x432c97[_0x3597df(0x1d6)],'out_trade_no':_0x5eb983,'notify_url':_0x3e7fd6,'amount':{'total':Number(_0x1dfe9f[_0x3597df(0x1f5)]*0x64)},'scene_info':{'payer_client_ip':'192.168.1.100'}};console[_0x3597df(0x1fe)]('wechat-pay:\x20',_0x1c6951);if(_0x4ba3d6=='h5'){_0x1c6951[_0x3597df(0x1a8)][_0x3597df(0x195)]={'type':_0x3597df(0x1c1),'app_name':_0x4b604a,'app_url':_0x4b9a5f};const _0x24afca=await _0x4ae010[_0x3597df(0x1ce)](_0x1c6951);if(_0x24afca['status']===0x193){const _0x5ed74f=_0x24afca?.['errRaw']?.[_0x3597df(0x22f)]?.[_0x3597df(0x1dc)]?.[_0x3597df(0x188)];throw new common_1[(_0x3597df(0x1ed))](_0x24afca?.['message']||_0x3597df(0x1da),common_1[_0x3597df(0x192)]['BAD_REQUEST']);}const {h5_url:_0x867c5f}=_0x24afca;return{'url':_0x867c5f};}if(_0x4ba3d6===_0x3597df(0x1c9)){_0x1c6951['appid']=_0x3843f4;const _0xdc2ee4=await _0x4ae010[_0x3597df(0x234)](_0x1c6951);return console[_0x3597df(0x1fe)]('App支付结果返回值:\x20',_0xdc2ee4),_0xdc2ee4;}if(_0x4ba3d6=='mini'){const _0x3cb53e=await this[_0x3597df(0x209)][_0x3597df(0x249)](_0x3289f1);_0x1c6951['payer']={'openid':_0x3cb53e};const _0x2507a2=await _0x4ae010[_0x3597df(0x21e)](_0x1c6951);return console[_0x3597df(0x1fe)](_0x3597df(0x1c6),_0x2507a2),_0x2507a2;}if(_0x4ba3d6=='jsapi'){const _0x5b4f6d=await this[_0x3597df(0x209)][_0x3597df(0x1a3)](_0x3289f1);console[_0x3597df(0x1fe)]('用户openId:\x20',_0x5b4f6d),_0x1c6951[_0x3597df(0x1ad)]={'openid':_0x5b4f6d};const _0x424c43=await _0x4ae010[_0x3597df(0x21e)](_0x1c6951);return console[_0x3597df(0x1fe)](_0x3597df(0x1c6),_0x424c43),_0x424c43;}if(_0x4ba3d6==_0x3597df(0x231)){const _0x5294f2=await _0x4ae010['transactions_native'](_0x1c6951),{code_url:_0x4bc886}=_0x5294f2;return!_0x4bc886&&console[_0x3597df(0x1fe)]('wx-native',_0x5294f2),{'url_qrcode':_0x4bc886,'isRedirect':![]};}throw new common_1[(_0x3597df(0x1ed))](_0x3597df(0x1cd),common_1[_0x3597df(0x192)][_0x3597df(0x1fd)]);}async[_0x1c650a(0x198)](_0x3d9a2,_0x2140d1){const _0x2e138e=_0x1c650a,{payWeChatAppId:_0x5a7cda,payWeMiniAppId:_0x37419e,payWeChatMchId:_0x14624a,payWeChatPublicKey:_0x8c849d,payWeChatPrivateKey:_0x3f5883}=await this['globalConfigService']['getConfigByKeys'](['payWeChatAppId',_0x2e138e(0x1c4),_0x2e138e(0x20a),_0x2e138e(0x24a),'payWeChatPrivateKey']),_0x4d29d7=new WxPay({'appid':_0x2140d1==='mini'?_0x37419e:_0x5a7cda,'mchid':_0x14624a,'publicKey':_0x8c849d,'privateKey':_0x3f5883}),_0x31672d=await _0x4d29d7[_0x2e138e(0x207)]({'out_trade_no':_0x3d9a2});return _0x31672d;}async['cancel'](_0x13de81){const _0x5a2b33=_0x1c650a;_0x13de81['payPlatform']===_0x5a2b33(0x1b0)&&await this[_0x5a2b33(0x1e9)](_0x13de81);}async['cancelWxOrder'](_0x57d92b){const _0x57c465=_0x1c650a,{payWeChatAppId:_0x2a1a82,payWeMiniAppId:_0x5b0a74,payWeChatMchId:_0x2ac6fb,payWeChatPublicKey:_0x16f41b,payWeChatPrivateKey:_0x26aae1}=await this[_0x57c465(0x23e)]['getConfigByKeys'](['payWeChatAppId',_0x57c465(0x1c4),_0x57c465(0x20a),_0x57c465(0x24a),_0x57c465(0x18c),'payWeChatNotifyUrl',_0x57c465(0x1e5),_0x57c465(0x222)]),_0x30d568=new WxPay({'appid':_0x57d92b[_0x57c465(0x1ac)]===_0x57c465(0x1eb)?_0x5b0a74:_0x2a1a82,'mchid':_0x2ac6fb,'publicKey':_0x16f41b,'privateKey':_0x26aae1});await _0x30d568[_0x57c465(0x1b5)](_0x57d92b[_0x57c465(0x1d2)]);}[_0x1c650a(0x21c)](_0x341a53,_0x157bf1){const _0x3410fe=_0x1c650a,_0x4cb3ee=Object[_0x3410fe(0x22e)](_0x341a53)[_0x3410fe(0x20d)]()[_0x3410fe(0x219)](_0x3bd957=>_0x3bd957+'='+_0x341a53[_0x3bd957])[_0x3410fe(0x193)]('&')+_0x157bf1;return crypto['createHash'](_0x3410fe(0x238))[_0x3410fe(0x1cb)](_0x4cb3ee)[_0x3410fe(0x23c)]('hex');}};PayService=__decorate([(0x0,common_1[_0x1c650a(0x23b)])(),__param(0x0,(0x0,typeorm_1[_0x1c650a(0x1f6)])(cramiPackage_entity_1[_0x1c650a(0x1d1)])),__param(0x1,(0x0,typeorm_1[_0x1c650a(0x1f6)])(order_entity_1[_0x1c650a(0x239)])),__metadata(_0x1c650a(0x1ec),[typeorm_2[_0x1c650a(0x24f)],typeorm_2[_0x1c650a(0x24f)],userBalance_service_1[_0x1c650a(0x20f)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x1c650a(0x1a9)],redisCache_service_1[_0x1c650a(0x18d)],typeorm_2[_0x1c650a(0x218)]])],PayService),exports[_0x1c650a(0x1df)]=PayService;