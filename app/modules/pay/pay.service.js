'use strict';const _0x1e05a1=_0x2f79;(function(_0xd98a0d,_0x4a2036){const _0x1e27e2=_0x2f79,_0x5913c=_0xd98a0d();while(!![]){try{const _0x3949cd=parseInt(_0x1e27e2(0x11e))/0x1+-parseInt(_0x1e27e2(0x169))/0x2*(-parseInt(_0x1e27e2(0x1a8))/0x3)+-parseInt(_0x1e27e2(0x17b))/0x4*(parseInt(_0x1e27e2(0xf1))/0x5)+-parseInt(_0x1e27e2(0x1b4))/0x6*(parseInt(_0x1e27e2(0x13e))/0x7)+-parseInt(_0x1e27e2(0x13a))/0x8*(parseInt(_0x1e27e2(0x196))/0x9)+parseInt(_0x1e27e2(0x17c))/0xa+-parseInt(_0x1e27e2(0x138))/0xb;if(_0x3949cd===_0x4a2036)break;else _0x5913c['push'](_0x5913c['shift']());}catch(_0x3262c4){_0x5913c['push'](_0x5913c['shift']());}}}(_0x5179,0x9cdb9));function _0x2f79(_0x4af07b,_0x8c4938){const _0x517997=_0x5179();return _0x2f79=function(_0x2f7928,_0x560de){_0x2f7928=_0x2f7928-0xe8;let _0x3381bc=_0x517997[_0x2f7928];return _0x3381bc;},_0x2f79(_0x4af07b,_0x8c4938);}function _0x5179(){const _0x52634f=['用户openId:\x20','userService','transaction_id','userBalanceService','MD5','status','getConfigByKeys','@nestjs/typeorm','typeorm','payWeChatSecret','trade_order_id','payWeChat','response','out_trade_no','getMiniOpenIdByUserId','order_no','get','666rtDqlw','sign','__decorate','payWeChatH5Name','payer','Connection','connection','payHupiReturnUrl','@nestjs/common','clientip','payAliWebAppId','payAliWebSecret','5035002Peofvg','product_code','alipay\x20result:\x20','transactions_app','__metadata','version','payAliAppSecret','payAliPublicSecret','onModuleInit','payWeChatPrivateKey','param','96245cMdQLr','appid','trade_status','payHupi','payEpay','../../common/utils','HttpException','hash','../order/order.entity','affected','name','submit.php','__esModule','includes','now','message','payType:\x20','wechat','payEpayNotifyUrl','goodsId','notifyMpay','function','cramiPackageEntity','toFixed','join','套餐不存在!','log','event_type','../../common/constants/redisKey.constant','payAliAppAppId','payWeChatPublicKey','pageExec','UserBalanceService','pid','errRaw','device','payEpayPid','epay','payHupiAppId','decipher_gcm','toString','app','payWeMiniAppId','total','../userBalance/userBalance.service','795415qbAoLO','failed','Injectable','crypto','h5_info','queryWeChat','alipay.trade.app.pay','wx-native','payWeChatMchId','https://api.xunhupay.com/payment/do.html','keys','jsapi','success','PayService','type','method','192.168.1.100','queryEpay','sign_type','redisCacheService','toDate','axios','payWeChatAppId','globalConfigService','createRandomNonceStr','payEpayApiPayUrl','18337zutMQA','design:paramtypes','1576hRtbHz','status:\x20','payMpayApiPayUrl','payMpay','7mdGmMu','resource','metadata','BAD_REQUEST','del','channel','sdkExec','payHupiGatewayUrl','cancel','notifyEpay','微信H5支付失败！','default','payEpayApiQueryUrl','payEpayReturnUrl','payMpayPid','pay','payPlatform','transactions_h5','PAY_UPDATE_ORDER','queryMpay','transactions_native','data','createHash','close','orderId','WE_APP_APPID','digest','payWeChatH5Url','GlobalConfigService','OrderEntity','queryHupi','defineProperty','mini','addBalanceToOrder','payAli','transaction','nonce_str','object','../redisCache/redisCache.service','jsapi支付结果返回值:\x20','setNotifyUrl','native','act','2638irDvvx','payWeChatNotifyUrl','notify_url','transactions_jsapi','cancelWxOrder','../globalConfig/globalConfig.service','wechatpay-node-v3','getOwnPropertyDescriptor','query','findOne','trade_state','HttpStatus','getOpenIdByUserId','length','time','return_url','order','payEpaySecret','4qZjYhF','6503450QORMol','Wap','key','../crami/cramiPackage.entity','支付请求失败!','支付通知验证失败:\x20','payMpayApiQueryUrl','订单不存在!','1.1','PKCS1','hupi','update','校验签名通过','orderEntity','SUCCESS','title','payMpaySecret','支付请求失败:\x20','payHupiSecret','Repository','alipay','decorate','wxpay','set','wechat-pay:\x20','TRADE_SUCCESS','10782LrRHxI'];_0x5179=function(){return _0x52634f;};return _0x5179();}var __decorate=this&&this[_0x1e05a1(0x1aa)]||function(_0x2f1a08,_0x173231,_0x14e668,_0x3aeead){const _0x456723=_0x1e05a1;var _0xc504e6=arguments[_0x456723(0x176)],_0x5961d2=_0xc504e6<0x3?_0x173231:_0x3aeead===null?_0x3aeead=Object[_0x456723(0x170)](_0x173231,_0x14e668):_0x3aeead,_0xf371b6;if(typeof Reflect===_0x456723(0x163)&&typeof Reflect[_0x456723(0x191)]===_0x456723(0x106))_0x5961d2=Reflect[_0x456723(0x191)](_0x2f1a08,_0x173231,_0x14e668,_0x3aeead);else{for(var _0x4685f5=_0x2f1a08[_0x456723(0x176)]-0x1;_0x4685f5>=0x0;_0x4685f5--)if(_0xf371b6=_0x2f1a08[_0x4685f5])_0x5961d2=(_0xc504e6<0x3?_0xf371b6(_0x5961d2):_0xc504e6>0x3?_0xf371b6(_0x173231,_0x14e668,_0x5961d2):_0xf371b6(_0x173231,_0x14e668))||_0x5961d2;}return _0xc504e6>0x3&&_0x5961d2&&Object['defineProperty'](_0x173231,_0x14e668,_0x5961d2),_0x5961d2;},__metadata=this&&this[_0x1e05a1(0xea)]||function(_0x386489,_0x20d586){const _0x11234b=_0x1e05a1;if(typeof Reflect===_0x11234b(0x163)&&typeof Reflect[_0x11234b(0x140)]===_0x11234b(0x106))return Reflect[_0x11234b(0x140)](_0x386489,_0x20d586);},__param=this&&this['__param']||function(_0x51b0fa,_0x58c68c){return function(_0x42ef4e,_0x5b4b3f){_0x58c68c(_0x42ef4e,_0x5b4b3f,_0x51b0fa);};};Object[_0x1e05a1(0x15d)](exports,_0x1e05a1(0xfd),{'value':!![]}),exports[_0x1e05a1(0x12b)]=void 0x0;const typeorm_1=require(_0x1e05a1(0x19e)),typeorm_2=require(_0x1e05a1(0x19f)),common_1=require(_0x1e05a1(0x1b0)),crypto=require(_0x1e05a1(0x121)),axios_1=require(_0x1e05a1(0x133)),order_entity_1=require(_0x1e05a1(0xf9)),cramiPackage_entity_1=require(_0x1e05a1(0x17f)),userBalance_service_1=require(_0x1e05a1(0x11d)),globalConfig_service_1=require(_0x1e05a1(0x16e)),utils_1=require(_0x1e05a1(0xf6)),user_service_1=require('../user/user.service'),redisCache_service_1=require(_0x1e05a1(0x164)),redisKey_constant_1=require(_0x1e05a1(0x10d)),date_1=require('../../common/utils/date'),WxPay=require(_0x1e05a1(0x16f)),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x50deb,_0x520450,_0x436501,_0x1ee0f8,_0x41dd81,_0x31b89e,_0x1480b2){const _0x170beb=_0x1e05a1;this['cramiPackageEntity']=_0x50deb,this['orderEntity']=_0x520450,this[_0x170beb(0x19a)]=_0x436501,this['globalConfigService']=_0x1ee0f8,this[_0x170beb(0x198)]=_0x41dd81,this[_0x170beb(0x131)]=_0x31b89e,this['connection']=_0x1480b2;}async[_0x1e05a1(0xee)](){}async['notify'](_0x335f97){const _0x26efe3=_0x1e05a1;if(_0x335f97['param']==_0x26efe3(0x116))return this[_0x26efe3(0x147)](_0x335f97);if(_0x335f97['attach']==_0x26efe3(0x186))return this['notifyHupi'](_0x335f97);if(typeof _0x335f97[_0x26efe3(0x13f)]==_0x26efe3(0x163))return this['notifyWeChat'](_0x335f97);return this['notifyMpay'](_0x335f97);}async[_0x1e05a1(0x14d)](_0x235d73,_0x59a7bd,_0x43dc3a='wxpay'){const _0x43d540=_0x1e05a1,_0x512f30=await this[_0x43d540(0x189)]['findOne']({'where':{'userId':_0x235d73,'orderId':_0x59a7bd}});if(!_0x512f30)throw new common_1['HttpException'](_0x43d540(0x183),common_1['HttpStatus']['BAD_REQUEST']);const _0x419ffc=await this[_0x43d540(0x107)]['findOne']({'where':{'id':_0x512f30['goodsId']}});if(!_0x419ffc)throw new common_1[(_0x43d540(0xf7))](_0x43d540(0x10a),common_1[_0x43d540(0x174)]['BAD_REQUEST']);console['log']('本次支付类型:\x20',_0x512f30[_0x43d540(0x14e)]);try{if(_0x512f30[_0x43d540(0x14e)]==_0x43d540(0x190))return this[_0x43d540(0x160)](_0x235d73,_0x59a7bd,_0x43dc3a);if(_0x512f30[_0x43d540(0x14e)]==_0x43d540(0x102))return this[_0x43d540(0x1a2)](_0x235d73,_0x59a7bd,_0x43dc3a);if(_0x512f30[_0x43d540(0x14e)]==_0x43d540(0x116))return this[_0x43d540(0xf5)](_0x235d73,_0x59a7bd,_0x43dc3a);if(_0x512f30[_0x43d540(0x14e)]=='mpay')return this['payMpay'](_0x235d73,_0x59a7bd,_0x43dc3a);if(_0x512f30['payPlatform']==_0x43d540(0x186))return this[_0x43d540(0xf4)](_0x235d73,_0x59a7bd,_0x43dc3a);}catch(_0x565fd0){console['log'](_0x43d540(0x18d),_0x565fd0);throw new common_1[(_0x43d540(0xf7))](_0x43d540(0x180),common_1[_0x43d540(0x174)][_0x43d540(0x141)]);}}async[_0x1e05a1(0x171)](_0x472587){const _0x2610f4=_0x1e05a1,_0xdc5cb8=await this[_0x2610f4(0x189)][_0x2610f4(0x172)]({'where':{'orderId':_0x472587}});if(!_0xdc5cb8)throw new common_1[(_0x2610f4(0xf7))](_0x2610f4(0x183),common_1[_0x2610f4(0x174)][_0x2610f4(0x141)]);return _0xdc5cb8;}async['notifyHupi'](_0x1e77ea){const _0x1ee50b=_0x1e05a1,_0x52c929=await this[_0x1ee50b(0x135)][_0x1ee50b(0x19d)]([_0x1ee50b(0x18e)]),_0x15c86c=_0x1e77ea['hash'];delete _0x1e77ea[_0x1ee50b(0xf8)];if(this['sign'](_0x1e77ea,_0x52c929)!=_0x15c86c)return'failed';const _0x42c23d=await this['orderEntity'][_0x1ee50b(0x172)]({'where':{'orderId':_0x1e77ea['trade_order_id'],'status':0x0}});if(!_0x42c23d)return _0x1ee50b(0x11f);await this[_0x1ee50b(0x19a)][_0x1ee50b(0x15f)](_0x42c23d);const _0x12783a=await this[_0x1ee50b(0x189)][_0x1ee50b(0x187)]({'orderId':_0x1e77ea[_0x1ee50b(0x1a1)]},{'status':0x1,'paydAt':(0x0,date_1[_0x1ee50b(0x149)])()['toDate']()});if(_0x12783a[_0x1ee50b(0xfa)]!=0x1)return _0x1ee50b(0x11f);return _0x1ee50b(0x12a);}async[_0x1e05a1(0xf4)](_0x2fbbed,_0x47c257,_0x2b8e2c=_0x1e05a1(0x192)){const _0x334a77=_0x1e05a1,_0x1e74d6=await this[_0x334a77(0x189)]['findOne']({'where':{'userId':_0x2fbbed,'orderId':_0x47c257}});if(!_0x1e74d6)throw new common_1['HttpException'](_0x334a77(0x183),common_1[_0x334a77(0x174)]['BAD_REQUEST']);const _0x28ce24=await this['cramiPackageEntity'][_0x334a77(0x172)]({'where':{'id':_0x1e74d6[_0x334a77(0x104)]}});if(!_0x28ce24)throw new common_1['HttpException'](_0x334a77(0x10a),common_1[_0x334a77(0x174)][_0x334a77(0x141)]);const {payHupiAppId:_0x5e93e7,payHupiSecret:_0x19a495,payHupiNotifyUrl:_0x3dff34,payHupiReturnUrl:_0xcecb66,payHupiGatewayUrl:_0x3ddd19}=await this[_0x334a77(0x135)][_0x334a77(0x19d)](['payHupiAppId',_0x334a77(0x18e),'payHupiNotifyUrl',_0x334a77(0x1af),_0x334a77(0x145)]),_0x5ef446={};_0x5ef446[_0x334a77(0xeb)]=_0x334a77(0x184),_0x5ef446[_0x334a77(0xf2)]=_0x5e93e7,_0x5ef446[_0x334a77(0x177)]=(Date[_0x334a77(0xff)]()/0x3e8)[_0x334a77(0x108)](0x0),_0x5ef446[_0x334a77(0x162)]=(0x0,utils_1[_0x334a77(0x136)])(0x20),_0x5ef446[_0x334a77(0x1a1)]=_0x47c257,_0x5ef446[_0x334a77(0x18b)]=_0x28ce24[_0x334a77(0xfb)],_0x5ef446['total_fee']=_0x1e74d6[_0x334a77(0x11c)],_0x5ef446['notify_url']=_0x3dff34,_0x5ef446[_0x334a77(0x178)]=_0xcecb66,_0x5ef446['attach']=_0x334a77(0x186),_0x5ef446['hash']=this['sign'](_0x5ef446,_0x19a495);const {data:{errcode:_0x19729e,errmsg:_0x43e586,url_qrcode:_0x461ea4,url:_0x4d09ea}}=await axios_1[_0x334a77(0x149)]['post'](_0x3ddd19||_0x334a77(0x127),_0x5ef446);if(_0x19729e!=0x0)throw new common_1[(_0x334a77(0xf7))](_0x43e586,common_1['HttpStatus'][_0x334a77(0x141)]);return{'url_qrcode':_0x461ea4,'url':_0x4d09ea};}async[_0x1e05a1(0x15c)](_0x7a2e39){const _0x154e05=_0x1e05a1,{payHupiAppId:_0x301b56,payHupiSecret:_0x412080}=await this[_0x154e05(0x135)][_0x154e05(0x19d)]([_0x154e05(0x117),_0x154e05(0x18e)]),_0x156774={};_0x156774['version']='1.1',_0x156774['appid']=_0x301b56,_0x156774['time']=(Date[_0x154e05(0xff)]()/0x3e8)[_0x154e05(0x108)](0x0),_0x156774[_0x154e05(0x162)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x156774['out_trade_order']=_0x7a2e39,_0x156774['hash']=this['sign'](_0x156774,_0x412080);const {data:{errcode:_0x15047a,errmsg:_0x32bcc6,data:_0x1c7903}}=await axios_1[_0x154e05(0x149)]['post']('https://api.xunhupay.com/payment/query.html',_0x156774);if(_0x15047a!=0x0)throw new common_1[(_0x154e05(0xf7))](_0x32bcc6,common_1[_0x154e05(0x174)][_0x154e05(0x141)]);return _0x1c7903;}async['notifyEpay'](_0x429e71){const _0x1c0eb1=_0x1e05a1,_0x2e7520=_0x429e71[_0x1c0eb1(0x1a9)];delete _0x429e71['sign'],delete _0x429e71['sign_type'];const _0x35abd2=await this['globalConfigService']['getConfigByKeys']([_0x1c0eb1(0x17a)]);if(this[_0x1c0eb1(0x1a9)](_0x429e71,_0x35abd2)!=_0x2e7520)return'failed';console['log'](_0x1c0eb1(0x188));const _0x3e4615=await this[_0x1c0eb1(0x189)][_0x1c0eb1(0x172)]({'where':{'orderId':_0x429e71['out_trade_no'],'status':0x0}});if(!_0x3e4615)return _0x1c0eb1(0x11f);const _0x31dbde=_0x429e71[_0x1c0eb1(0xf3)]==_0x1c0eb1(0x195)?0x1:0x2,_0x5034d8=await this[_0x1c0eb1(0x189)][_0x1c0eb1(0x187)]({'orderId':_0x429e71['out_trade_no']},{'status':_0x31dbde,'paydAt':(0x0,date_1[_0x1c0eb1(0x149)])()[_0x1c0eb1(0x132)]()});_0x31dbde===0x1&&await this[_0x1c0eb1(0x19a)][_0x1c0eb1(0x15f)](_0x3e4615);if(_0x5034d8[_0x1c0eb1(0xfa)]!=0x1)return _0x1c0eb1(0x11f);return _0x1c0eb1(0x12a);}async['payEpay'](_0xfd2e90,_0x46f2b6,_0x4aa930=_0x1e05a1(0x190)){const _0x2f25c8=_0x1e05a1,_0x437afa=await this[_0x2f25c8(0x189)][_0x2f25c8(0x172)]({'where':{'userId':_0xfd2e90,'orderId':_0x46f2b6}});if(!_0x437afa)throw new common_1[(_0x2f25c8(0xf7))](_0x2f25c8(0x183),common_1[_0x2f25c8(0x174)][_0x2f25c8(0x141)]);const _0x337120=await this[_0x2f25c8(0x107)][_0x2f25c8(0x172)]({'where':{'id':_0x437afa[_0x2f25c8(0x104)]}});if(!_0x337120)throw new common_1[(_0x2f25c8(0xf7))]('套餐不存在!',common_1[_0x2f25c8(0x174)]['BAD_REQUEST']);const {payEpayPid:_0x5d341a,payEpaySecret:_0x28c67e,payEpayNotifyUrl:_0x21e1e3,payEpayReturnUrl:_0x4b5c7d,payEpayApiPayUrl:_0x14730d}=await this['globalConfigService'][_0x2f25c8(0x19d)]([_0x2f25c8(0x115),_0x2f25c8(0x17a),_0x2f25c8(0x103),_0x2f25c8(0x14b),_0x2f25c8(0x137)]);let _0x15cf1e;_0x5d341a[_0x2f25c8(0x176)]<=0x10?_0x15cf1e=Number(_0x5d341a):_0x15cf1e=BigInt(_0x5d341a);const _0x3c6997={};_0x3c6997[_0x2f25c8(0x112)]=_0x15cf1e,_0x3c6997[_0x2f25c8(0x12c)]=_0x4aa930,_0x3c6997['out_trade_no']=_0x46f2b6,_0x3c6997[_0x2f25c8(0xfb)]=_0x337120['name'],_0x3c6997['money']=_0x437afa[_0x2f25c8(0x11c)],_0x3c6997[_0x2f25c8(0x1b1)]='192.168.1.100',_0x3c6997[_0x2f25c8(0x114)]='pc',_0x3c6997[_0x2f25c8(0x16b)]=_0x21e1e3,_0x3c6997[_0x2f25c8(0x178)]=_0x4b5c7d,_0x3c6997[_0x2f25c8(0xf0)]=_0x2f25c8(0x116),_0x3c6997[_0x2f25c8(0x1a9)]=this[_0x2f25c8(0x1a9)](_0x3c6997,_0x28c67e),_0x3c6997[_0x2f25c8(0x130)]=_0x2f25c8(0x19b);const _0x4a95fc=new URLSearchParams(_0x3c6997)[_0x2f25c8(0x119)](),_0x349577=_0x14730d+'?'+_0x4a95fc;if(_0x14730d[_0x2f25c8(0xfe)](_0x2f25c8(0xfc)))return{'url_qrcode':null,'redirectUrl':_0x349577,'channel':_0x4aa930,'isRedirect':!![]};else{const _0x12e877=await axios_1[_0x2f25c8(0x149)][_0x2f25c8(0x1a7)](_0x14730d,{'params':_0x3c6997});console['log']('epay\x20--->\x20res:\x20',_0x12e877[_0x2f25c8(0x153)]);const {data:{code:_0x11b3aa,msg:_0x2c58e4,qrcode:_0x8a2476}}=_0x12e877;if(_0x11b3aa!=0x1)throw new common_1[(_0x2f25c8(0xf7))](_0x2c58e4,common_1[_0x2f25c8(0x174)]['BAD_REQUEST']);return{'url_qrcode':_0x8a2476,'redirectUrl':null,'channel':_0x4aa930,'isRedirect':![]};}}async[_0x1e05a1(0x12f)](_0x4bbcd2){const _0x1353b4=_0x1e05a1,{payEpayPid:_0x21af86,payEpaySecret:_0x444f45,payEpayApiQueryUrl:_0x523ffe}=await this[_0x1353b4(0x135)][_0x1353b4(0x19d)]([_0x1353b4(0x115),_0x1353b4(0x17a),_0x1353b4(0x14a)]),_0x262263={};_0x262263[_0x1353b4(0x168)]=_0x1353b4(0x179),_0x262263[_0x1353b4(0x1a4)]=_0x4bbcd2,_0x262263[_0x1353b4(0x112)]=_0x21af86,_0x262263[_0x1353b4(0x17e)]=_0x444f45;const {data:{code:_0x7bcd22,msg:_0x24443d,data:_0x23fc35}}=await axios_1[_0x1353b4(0x149)][_0x1353b4(0x1a7)](_0x523ffe,{'params':_0x262263});if(_0x7bcd22!=0x1)throw new common_1[(_0x1353b4(0xf7))](_0x24443d,common_1[_0x1353b4(0x174)][_0x1353b4(0x141)]);return _0x23fc35;}async[_0x1e05a1(0x105)](_0x54cc8f){const _0x3b7bcf=_0x1e05a1,_0x2d43bf=_0x54cc8f[_0x3b7bcf(0x1a9)];delete _0x54cc8f[_0x3b7bcf(0x1a9)],delete _0x54cc8f[_0x3b7bcf(0x130)];const _0x55e7e8=await this[_0x3b7bcf(0x135)][_0x3b7bcf(0x19d)]([_0x3b7bcf(0x18c)]);console[_0x3b7bcf(0x10b)]('校验签名');if(this[_0x3b7bcf(0x1a9)](_0x54cc8f,_0x55e7e8)!=_0x2d43bf)return _0x3b7bcf(0x11f);console[_0x3b7bcf(0x10b)](_0x3b7bcf(0x188));const _0x47234e=await this['orderEntity'][_0x3b7bcf(0x172)]({'where':{'orderId':_0x54cc8f['out_trade_no'],'status':0x0}});if(!_0x47234e)return _0x3b7bcf(0x11f);const _0x31efcf=_0x54cc8f['trade_status']==_0x3b7bcf(0x195)?0x1:0x2;console['log'](_0x3b7bcf(0x13b),_0x31efcf);const _0x20aca2=await this[_0x3b7bcf(0x189)][_0x3b7bcf(0x187)]({'orderId':_0x54cc8f['out_trade_no']},{'status':_0x31efcf,'paydAt':(0x0,date_1[_0x3b7bcf(0x149)])()['toDate']()});_0x31efcf===0x1&&await this[_0x3b7bcf(0x19a)][_0x3b7bcf(0x15f)](_0x47234e);if(_0x20aca2[_0x3b7bcf(0xfa)]!=0x1)return _0x3b7bcf(0x11f);return _0x3b7bcf(0x12a);}async[_0x1e05a1(0x13d)](_0x29dbd3,_0x39c3dc,_0x558db8=_0x1e05a1(0x192)){const _0x209867=_0x1e05a1,_0x568653=await this['orderEntity'][_0x209867(0x172)]({'where':{'userId':_0x29dbd3,'orderId':_0x39c3dc}});if(!_0x568653)throw new common_1['HttpException']('订单不存在!',common_1[_0x209867(0x174)]['BAD_REQUEST']);const _0x50a266=await this[_0x209867(0x107)][_0x209867(0x172)]({'where':{'id':_0x568653[_0x209867(0x104)]}});if(!_0x50a266)throw new common_1[(_0x209867(0xf7))]('套餐不存在!',common_1['HttpStatus'][_0x209867(0x141)]);const {payMpayPid:_0x545e12,payMpaySecret:_0x54e13c,payMpayNotifyUrl:_0x4ab2b3,payMpayReturnUrl:_0x2f0e02,payMpayApiPayUrl:_0x1fe43b}=await this[_0x209867(0x135)][_0x209867(0x19d)]([_0x209867(0x14c),_0x209867(0x18c),'payMpayNotifyUrl','payMpayReturnUrl',_0x209867(0x13c)]),_0x3a1baa={};_0x3a1baa[_0x209867(0x112)]=Number(_0x545e12),_0x3a1baa[_0x209867(0x12c)]=_0x558db8,_0x3a1baa['out_trade_no']=_0x39c3dc,_0x3a1baa[_0x209867(0xfb)]=_0x50a266[_0x209867(0xfb)],_0x3a1baa['money']=_0x568653[_0x209867(0x11c)],_0x3a1baa[_0x209867(0x16b)]=_0x4ab2b3,_0x3a1baa['return_url']=_0x2f0e02,_0x3a1baa[_0x209867(0x1a9)]=this['sign'](_0x3a1baa,_0x54e13c),_0x3a1baa['sign_type']='MD5';const _0x6a56da=new URLSearchParams(_0x3a1baa)[_0x209867(0x119)](),_0xd043ce=_0x1fe43b+'?'+_0x6a56da;return{'url_qrcode':null,'redirectUrl':_0xd043ce,'channel':_0x558db8,'isRedirect':!![]};}async[_0x1e05a1(0x151)](_0x1a6e8d){const _0x558a1b=_0x1e05a1,{payMpayApiQueryUrl:_0x3487be}=await this['globalConfigService']['getConfigByKeys']([_0x558a1b(0x14c),_0x558a1b(0x18c),_0x558a1b(0x182)]),_0x4825b4={};_0x4825b4[_0x558a1b(0x12c)]=0x2,_0x4825b4[_0x558a1b(0x1a6)]=_0x1a6e8d;const {data:{code:_0x443f3c,msg:_0x359977,data:_0x48c67c}}=await axios_1[_0x558a1b(0x149)][_0x558a1b(0x1a7)](_0x3487be,{'params':_0x4825b4});if(_0x443f3c!=0x1)throw new common_1[(_0x558a1b(0xf7))](_0x359977,common_1['HttpStatus'][_0x558a1b(0x141)]);return _0x48c67c;}async['notifyWeChat'](_0x265469){const _0x30e89a=_0x1e05a1;console['log']('微信支付通知params:\x20',_0x265469);const {payWeChatAppId:_0x3ae8ca,payWeChatMchId:_0x1046b9,payWeChatSecret:_0x5e2174,payWeChatPublicKey:_0x442e06,payWeChatPrivateKey:_0x192988}=await this[_0x30e89a(0x135)][_0x30e89a(0x19d)](['payWeChatAppId','payWeChatMchId',_0x30e89a(0x1a0),_0x30e89a(0x10f),_0x30e89a(0xef)]),_0x55498c=new WxPay({'appid':_0x3ae8ca,'mchid':_0x1046b9,'publicKey':_0x442e06,'privateKey':_0x192988});let _0x2bc300;try{if(_0x265469[_0x30e89a(0x10c)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x45c4fb,associated_data:_0x3fa162,nonce:_0x4c5797}=_0x265469[_0x30e89a(0x13f)],_0x22627b=_0x55498c[_0x30e89a(0x118)](_0x45c4fb,_0x3fa162,_0x4c5797,_0x5e2174),_0x25fda0=_0x22627b[_0x30e89a(0x1a4)];_0x2bc300=redisKey_constant_1[_0x30e89a(0x150)]+_0x25fda0,await this[_0x30e89a(0x131)][_0x30e89a(0x193)]({'key':_0x2bc300,'val':'lock'});const _0x23be4d=await this[_0x30e89a(0x189)][_0x30e89a(0x172)]({'where':{'orderId':_0x25fda0,'status':0x0}});if(!_0x23be4d)return _0x30e89a(0x11f);if([0x1,0x2,0x3][_0x30e89a(0xfe)](_0x23be4d[_0x30e89a(0x19c)]))return _0x30e89a(0x12a);const _0x370507=await this[_0x30e89a(0x1ae)][_0x30e89a(0x161)](async _0x4dd7fb=>{const _0x252fe=_0x30e89a,_0x313066=_0x22627b[_0x252fe(0x173)]==_0x252fe(0x18a)?0x1:0x2,_0x288799=await this[_0x252fe(0x189)][_0x252fe(0x187)]({'orderId':_0x25fda0},{'status':_0x313066,'paydAt':(0x0,date_1[_0x252fe(0x149)])()[_0x252fe(0x132)](),'tradeId':_0x22627b[_0x252fe(0x199)]});return _0x313066===0x1&&await this[_0x252fe(0x19a)][_0x252fe(0x15f)](_0x23be4d),_0x288799;});if(_0x370507['affected']!=0x1)return'failed';}return _0x30e89a(0x12a);}catch(_0x1945b1){return console['log']('error:\x20',_0x1945b1),console[_0x30e89a(0x10b)](_0x30e89a(0x181),_0x1945b1),_0x30e89a(0x11f);}finally{_0x2bc300&&await this[_0x30e89a(0x131)][_0x30e89a(0x142)]({'key':_0x2bc300});}}async[_0x1e05a1(0x160)](_0x5ef5c6,_0x2b90d7,_0x5958a4){const _0x476100=_0x1e05a1,_0x124e60=await this[_0x476100(0x189)][_0x476100(0x172)]({'where':{'userId':_0x5ef5c6,'orderId':_0x2b90d7}});if(!_0x124e60)throw new common_1['HttpException'](_0x476100(0x183),common_1[_0x476100(0x174)][_0x476100(0x141)]);const _0x58e3e3=await this[_0x476100(0x107)][_0x476100(0x172)]({'where':{'id':_0x124e60[_0x476100(0x104)]}});if(!_0x58e3e3)throw new common_1[(_0x476100(0xf7))](_0x476100(0x10a),common_1[_0x476100(0x174)][_0x476100(0x141)]);const _0x56ca4b={'bizContent':{'out_trade_no':_0x2b90d7,'total_amount':_0x124e60['total'],'subject':_0x58e3e3[_0x476100(0xfb)]}};let _0x281025,_0x57d8b1,_0x2a4644,_0x20baa3,_0x494229;const {payAliPublicSecret:_0x54455a,payAliWebAppId:_0x4dc354,payAliWebSecret:_0xf05b4,payAliAppAppId:_0x4d27fc,payAliAppSecret:_0xbdc55d,payWeChatNotifyUrl:_0x16c77a}=await this[_0x476100(0x135)][_0x476100(0x19d)](['payAliPublicSecret','payAliWebAppId',_0x476100(0x1b3),_0x476100(0x10e),_0x476100(0xec),_0x476100(0x16a)]);_0x5958a4===_0x476100(0x167)&&(_0x56ca4b[_0x476100(0x12d)]='POST',_0x281025=_0x4dc354,_0x2a4644=_0x476100(0x110),_0x57d8b1=_0xf05b4,_0x20baa3='alipay.trade.page.pay',_0x494229='FAST_INSTANT_TRADE_PAY');_0x5958a4===_0x476100(0x11a)&&(_0x2a4644=_0x476100(0x144),_0x281025=_0x4d27fc,_0x57d8b1=_0xbdc55d,_0x20baa3=_0x476100(0x124),_0x494229='QUICK_MSECURITY_PAY');const _0x1e120b=new AlipaySdk({'appId':_0x281025,'keyType':_0x476100(0x185),'privateKey':_0x57d8b1,'alipayPublicKey':_0x54455a});_0x56ca4b[_0x476100(0x166)]=_0x16c77a,_0x56ca4b['bizContent'][_0x476100(0x1b5)]=_0x494229;const _0x3fdf6c=await _0x1e120b[_0x2a4644](_0x20baa3,_0x56ca4b);return console[_0x476100(0x10b)](_0x476100(0xe8),_0x3fdf6c),_0x5958a4===_0x476100(0x167)?{'form':_0x3fdf6c}:{'data':_0x3fdf6c};}async['queryAliPay'](_0x1b4852,_0x526ded){const _0x402dfc=_0x1e05a1;let _0x5590ad,_0x5c2f61;const {payAliPublicSecret:_0x18f340,payAliWebAppId:_0x3be30a,payAliWebSecret:_0x1b85c3,payAliAppAppId:_0x18b5fa,payAliAppSecret:_0x47966d,payWeChatNotifyUrl:_0x29a4c9}=await this['globalConfigService'][_0x402dfc(0x19d)]([_0x402dfc(0xed),_0x402dfc(0x1b2),_0x402dfc(0x1b3),_0x402dfc(0x10e),_0x402dfc(0xec),_0x402dfc(0x16a)]);_0x526ded==='native'&&(_0x5590ad=_0x3be30a,_0x5c2f61=_0x1b85c3);_0x526ded===_0x402dfc(0x11a)&&(_0x5590ad=_0x18b5fa,_0x5c2f61=_0x47966d);const _0x46c934=new AlipaySdk({'appId':_0x5590ad,'keyType':_0x402dfc(0x185),'privateKey':_0x5c2f61,'alipayPublicKey':_0x18f340}),_0x55f1e5=await _0x46c934['exec']('alipay.trade.query',{'bizContent':{'out_trade_no':_0x1b4852}});return console[_0x402dfc(0x10b)](_0x55f1e5),_0x55f1e5;}async['payWeChat'](_0x591798,_0x4bbb33,_0x3d421f=_0x1e05a1(0x167)){const _0x358803=_0x1e05a1;console[_0x358803(0x10b)](_0x358803(0x101),_0x3d421f);const _0x13bdee=await this[_0x358803(0x189)][_0x358803(0x172)]({'where':{'userId':_0x591798,'orderId':_0x4bbb33}});if(!_0x13bdee)throw new common_1[(_0x358803(0xf7))](_0x358803(0x183),common_1[_0x358803(0x174)][_0x358803(0x141)]);const _0x40c41b=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x13bdee[_0x358803(0x104)]}});if(!_0x40c41b)throw new common_1[(_0x358803(0xf7))](_0x358803(0x10a),common_1[_0x358803(0x174)][_0x358803(0x141)]);const {payWeChatAppId:_0x47dcce,payWeMiniAppId:_0x447ac0,payWeChatMchId:_0x41cc37,payWeChatPublicKey:_0x31c267,payWeChatPrivateKey:_0x3c68b3,payWeChatNotifyUrl:_0x505ce3,payWeChatH5Name:_0x3d0944,payWeChatH5Url:_0x49963f,WE_APP_APPID:_0x55059a,WE_APP_APPSECRET:_0x21ed33}=await this[_0x358803(0x135)][_0x358803(0x19d)](['payWeChatAppId','payWeMiniAppId',_0x358803(0x126),'payWeChatPublicKey','payWeChatPrivateKey',_0x358803(0x16a),_0x358803(0x1ab),'payWeChatH5Url',_0x358803(0x157)]),_0x3e401e=new WxPay({'appid':_0x3d421f==='mini'?_0x447ac0:_0x47dcce,'mchid':_0x41cc37,'publicKey':_0x31c267,'privateKey':_0x3c68b3}),_0xf92d5b={'appid':_0x3d421f===_0x358803(0x15e)?_0x447ac0:_0x47dcce,'mchid':_0x41cc37,'description':_0x40c41b['name'],'out_trade_no':_0x4bbb33,'notify_url':_0x505ce3,'amount':{'total':Number(_0x13bdee[_0x358803(0x11c)]*0x64)},'scene_info':{'payer_client_ip':_0x358803(0x12e)}};console[_0x358803(0x10b)](_0x358803(0x194),_0xf92d5b);if(_0x3d421f=='h5'){_0xf92d5b['scene_info'][_0x358803(0x122)]={'type':_0x358803(0x17d),'app_name':_0x3d0944,'app_url':_0x49963f};const _0x51921c=await _0x3e401e[_0x358803(0x14f)](_0xf92d5b);if(_0x51921c['status']===0x193){const _0x369b2a=_0x51921c?.[_0x358803(0x113)]?.[_0x358803(0x1a3)]?.['text']?.['message'];throw new common_1['HttpException'](_0x51921c?.[_0x358803(0x100)]||_0x358803(0x148),common_1[_0x358803(0x174)][_0x358803(0x141)]);}const {h5_url:_0x54cb58}=_0x51921c;return{'url':_0x54cb58};}if(_0x3d421f===_0x358803(0x11a)){_0xf92d5b[_0x358803(0xf2)]=_0x55059a;const _0x2e38c6=await _0x3e401e[_0x358803(0xe9)](_0xf92d5b);return console[_0x358803(0x10b)]('App支付结果返回值:\x20',_0x2e38c6),_0x2e38c6;}if(_0x3d421f==_0x358803(0x15e)){const _0x467ca8=await this[_0x358803(0x198)][_0x358803(0x1a5)](_0x591798);_0xf92d5b[_0x358803(0x1ac)]={'openid':_0x467ca8};const _0x5b5f25=await _0x3e401e[_0x358803(0x16c)](_0xf92d5b);return console[_0x358803(0x10b)](_0x358803(0x165),_0x5b5f25),_0x5b5f25;}if(_0x3d421f==_0x358803(0x129)){const _0x2de0db=await this[_0x358803(0x198)][_0x358803(0x175)](_0x591798);console[_0x358803(0x10b)](_0x358803(0x197),_0x2de0db),_0xf92d5b['payer']={'openid':_0x2de0db};const _0x44071a=await _0x3e401e[_0x358803(0x16c)](_0xf92d5b);return console[_0x358803(0x10b)]('jsapi支付结果返回值:\x20',_0x44071a),_0x44071a;}if(_0x3d421f=='native'){const _0x295311=await _0x3e401e[_0x358803(0x152)](_0xf92d5b),{code_url:_0x524ff3}=_0x295311;return!_0x524ff3&&console[_0x358803(0x10b)](_0x358803(0x125),_0x295311),{'url_qrcode':_0x524ff3,'isRedirect':![]};}throw new common_1[(_0x358803(0xf7))]('unsupported\x20pay\x20type',common_1[_0x358803(0x174)][_0x358803(0x141)]);}async[_0x1e05a1(0x123)](_0x2af1ba,_0x2e08ef){const _0x1ed7d4=_0x1e05a1,{payWeChatAppId:_0x200fdf,payWeMiniAppId:_0xa0c1a2,payWeChatMchId:_0x4d4767,payWeChatPublicKey:_0x2313fe,payWeChatPrivateKey:_0x51087b}=await this[_0x1ed7d4(0x135)][_0x1ed7d4(0x19d)](['payWeChatAppId',_0x1ed7d4(0x11b),'payWeChatMchId','payWeChatPublicKey',_0x1ed7d4(0xef)]),_0xbf42f0=new WxPay({'appid':_0x2e08ef===_0x1ed7d4(0x15e)?_0xa0c1a2:_0x200fdf,'mchid':_0x4d4767,'publicKey':_0x2313fe,'privateKey':_0x51087b}),_0x771020=await _0xbf42f0[_0x1ed7d4(0x171)]({'out_trade_no':_0x2af1ba});return _0x771020;}async[_0x1e05a1(0x146)](_0x301cd1){const _0x38078c=_0x1e05a1;_0x301cd1[_0x38078c(0x14e)]===_0x38078c(0x102)&&await this[_0x38078c(0x16d)](_0x301cd1);}async[_0x1e05a1(0x16d)](_0xdd1c8){const _0x1daee3=_0x1e05a1,{payWeChatAppId:_0x260843,payWeMiniAppId:_0x4a8f97,payWeChatMchId:_0x411a6b,payWeChatPublicKey:_0x4a4ba6,payWeChatPrivateKey:_0x6c45e0}=await this['globalConfigService'][_0x1daee3(0x19d)]([_0x1daee3(0x134),_0x1daee3(0x11b),_0x1daee3(0x126),_0x1daee3(0x10f),_0x1daee3(0xef),'payWeChatNotifyUrl',_0x1daee3(0x1ab),_0x1daee3(0x159)]),_0x17df30=new WxPay({'appid':_0xdd1c8[_0x1daee3(0x143)]===_0x1daee3(0x15e)?_0x4a8f97:_0x260843,'mchid':_0x411a6b,'publicKey':_0x4a4ba6,'privateKey':_0x6c45e0});await _0x17df30[_0x1daee3(0x155)](_0xdd1c8[_0x1daee3(0x156)]);}[_0x1e05a1(0x1a9)](_0x37e034,_0x254e27){const _0x5aa353=_0x1e05a1,_0x9f46e4=Object[_0x5aa353(0x128)](_0x37e034)['sort']()['map'](_0x14887d=>_0x14887d+'='+_0x37e034[_0x14887d])[_0x5aa353(0x109)]('&')+_0x254e27;return crypto[_0x5aa353(0x154)]('md5')[_0x5aa353(0x187)](_0x9f46e4)[_0x5aa353(0x158)]('hex');}};PayService=__decorate([(0x0,common_1[_0x1e05a1(0x120)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1e05a1(0x15b)])),__metadata(_0x1e05a1(0x139),[typeorm_2[_0x1e05a1(0x18f)],typeorm_2[_0x1e05a1(0x18f)],userBalance_service_1[_0x1e05a1(0x111)],globalConfig_service_1[_0x1e05a1(0x15a)],user_service_1['UserService'],redisCache_service_1['RedisCacheService'],typeorm_2[_0x1e05a1(0x1ad)]])],PayService),exports[_0x1e05a1(0x12b)]=PayService;