'use strict';const _0x58d5fe=_0x4df1;function _0x55ba(){const _0x57a81e=['Injectable','toString','PKCS1','wechat','affected','../crami/cramiPackage.entity','toFixed','decipher_gcm','userService','payWeChatH5Url','WE_APP_APPID','hash','47065167HYpTbD','total','订单不存在!','queryMpay','goodsId','payEpayApiPayUrl','transactions_jsapi','payType:\x20','version','payWeChatSecret','connection','payMpaySecret','map','notifyMpay','Repository','title','transaction','12HspqSt','https://api.xunhupay.com/payment/do.html','pid','MD5','mpay','微信H5支付失败！','status:\x20','../../common/utils','3127110BmyQFu','onModuleInit','includes','payWeChatH5Name','get','success','wx-native','payWeChatAppId','payer','trade_order_id','4bVPxrx','payAliWebSecret','1380358cKrkST','Connection','__decorate','2899240QVUQjC','payEpaySecret','globalConfigService','hex','payAli','app','queryEpay','findOne','order_no','套餐不存在!','failed','createHash','SUCCESS','支付请求失败!','alipay.trade.page.pay','https://api.xunhupay.com/payment/query.html','InjectRepository','addBalanceToOrder','product_code','payEpayPid','default','支付请求失败:\x20','sdkExec','scene_info','notify','del','metadata','1.1','QUICK_MSECURITY_PAY','wxpay','exec','payHupiReturnUrl','toDate','payAliWebAppId','alipay.trade.app.pay','PAY_UPDATE_ORDER','../order/order.entity','userBalanceService','error:\x20','alipay','type','../user/user.service','nonce_str','log','GlobalConfigService','createRandomNonceStr','notifyEpay','trade_status','payMpayNotifyUrl','payAliAppAppId','POST','name','../../common/constants/redisKey.constant','本次支付类型:\x20','decorate','payHupiSecret','../redisCache/redisCache.service','RedisCacheService','cancelWxOrder','getMiniOpenIdByUserId','param','payWeChatNotifyUrl','mini','payEpayReturnUrl','getConfigByKeys','defineProperty','TRANSACTION.SUCCESS','getOwnPropertyDescriptor','unsupported\x20pay\x20type','act','status','BAD_REQUEST','payPlatform','校验签名','HttpException','payAliPublicSecret','payWeChatPublicKey','message','微信支付通知params:\x20','orderEntity','payEpay','payMpay','post','out_trade_order','sort','method','payEpayApiQueryUrl','sign','payWeChat','notify_url','payHupi','transaction_id','HttpStatus','cramiPackageEntity','1486020vTfRcD','design:paramtypes','resource','trade_state','time','now','object','transactions_native','payWeChatMchId','../userBalance/userBalance.service','query','native','payWeChatPrivateKey','192.168.1.100','1859152DiBNrN','getOpenIdByUserId','text','jsapi支付结果返回值:\x20','6588540VgvCvQ','attach','用户openId:\x20','redisCacheService','notifyWeChat','setNotifyUrl','TRADE_SUCCESS','cancel','join','payHupiAppId','pay','axios','notifyHupi','appid','epay','PayService','orderId','close','alipay\x20result:\x20','keys','hupi','OrderEntity','money','sign_type','@nestjs/common','payWeMiniAppId','__param','lock','transactions_app','Wap','device','payMpayPid','function','return_url','length','../../common/utils/date','out_trade_no','update','UserService'];_0x55ba=function(){return _0x57a81e;};return _0x55ba();}(function(_0x30d92a,_0x5667e5){const _0x3405fb=_0x4df1,_0x157bf1=_0x30d92a();while(!![]){try{const _0x2f0e65=-parseInt(_0x3405fb(0x180))/0x1+-parseInt(_0x3405fb(0x17e))/0x2*(parseInt(_0x3405fb(0x1e1))/0x3)+parseInt(_0x3405fb(0x1ef))/0x4+-parseInt(_0x3405fb(0x174))/0x5*(parseInt(_0x3405fb(0x16c))/0x6)+-parseInt(_0x3405fb(0x1f3))/0x7+-parseInt(_0x3405fb(0x183))/0x8+parseInt(_0x3405fb(0x226))/0x9;if(_0x2f0e65===_0x5667e5)break;else _0x157bf1['push'](_0x157bf1['shift']());}catch(_0x357bbb){_0x157bf1['push'](_0x157bf1['shift']());}}}(_0x55ba,0xbbae8));var __decorate=this&&this[_0x58d5fe(0x182)]||function(_0x407267,_0x134b5c,_0xbf6909,_0x4e064b){const _0x13ad54=_0x58d5fe;var _0x97cbeb=arguments[_0x13ad54(0x215)],_0x1bd66f=_0x97cbeb<0x3?_0x134b5c:_0x4e064b===null?_0x4e064b=Object[_0x13ad54(0x1c6)](_0x134b5c,_0xbf6909):_0x4e064b,_0x7a2405;if(typeof Reflect===_0x13ad54(0x1e7)&&typeof Reflect[_0x13ad54(0x1b9)]===_0x13ad54(0x213))_0x1bd66f=Reflect[_0x13ad54(0x1b9)](_0x407267,_0x134b5c,_0xbf6909,_0x4e064b);else{for(var _0xb5fefe=_0x407267[_0x13ad54(0x215)]-0x1;_0xb5fefe>=0x0;_0xb5fefe--)if(_0x7a2405=_0x407267[_0xb5fefe])_0x1bd66f=(_0x97cbeb<0x3?_0x7a2405(_0x1bd66f):_0x97cbeb>0x3?_0x7a2405(_0x134b5c,_0xbf6909,_0x1bd66f):_0x7a2405(_0x134b5c,_0xbf6909))||_0x1bd66f;}return _0x97cbeb>0x3&&_0x1bd66f&&Object[_0x13ad54(0x1c4)](_0x134b5c,_0xbf6909,_0x1bd66f),_0x1bd66f;},__metadata=this&&this['__metadata']||function(_0x481a93,_0x1d133a){const _0x398da7=_0x58d5fe;if(typeof Reflect===_0x398da7(0x1e7)&&typeof Reflect[_0x398da7(0x19d)]===_0x398da7(0x213))return Reflect[_0x398da7(0x19d)](_0x481a93,_0x1d133a);},__param=this&&this[_0x58d5fe(0x20d)]||function(_0x19fc12,_0x50d85f){return function(_0xb7910,_0x30303f){_0x50d85f(_0xb7910,_0x30303f,_0x19fc12);};};Object[_0x58d5fe(0x1c4)](exports,'__esModule',{'value':!![]}),exports[_0x58d5fe(0x202)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),common_1=require(_0x58d5fe(0x20b)),crypto=require('crypto'),axios_1=require(_0x58d5fe(0x1fe)),order_entity_1=require(_0x58d5fe(0x1a7)),cramiPackage_entity_1=require(_0x58d5fe(0x21f)),userBalance_service_1=require(_0x58d5fe(0x1ea)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x58d5fe(0x173)),user_service_1=require(_0x58d5fe(0x1ac)),redisCache_service_1=require(_0x58d5fe(0x1bb)),redisKey_constant_1=require(_0x58d5fe(0x1b7)),date_1=require(_0x58d5fe(0x216)),WxPay=require('wechatpay-node-v3'),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x26642f,_0x9666f1,_0x1eedd6,_0x46b77b,_0x1810f0,_0x5f4627,_0x1dc72c){const _0x3f83dd=_0x58d5fe;this[_0x3f83dd(0x1e0)]=_0x26642f,this[_0x3f83dd(0x1d2)]=_0x9666f1,this['userBalanceService']=_0x1eedd6,this[_0x3f83dd(0x185)]=_0x46b77b,this[_0x3f83dd(0x222)]=_0x1810f0,this[_0x3f83dd(0x1f6)]=_0x5f4627,this[_0x3f83dd(0x230)]=_0x1dc72c;}async[_0x58d5fe(0x175)](){}async[_0x58d5fe(0x19b)](_0x510e29){const _0x457bab=_0x58d5fe;if(_0x510e29[_0x457bab(0x1bf)]==_0x457bab(0x201))return this[_0x457bab(0x1b1)](_0x510e29);if(_0x510e29[_0x457bab(0x1f4)]==_0x457bab(0x207))return this[_0x457bab(0x1ff)](_0x510e29);if(typeof _0x510e29[_0x457bab(0x1e3)]==_0x457bab(0x1e7))return this[_0x457bab(0x1f7)](_0x510e29);return this[_0x457bab(0x233)](_0x510e29);}async[_0x58d5fe(0x1fd)](_0x55f670,_0x13a7f6,_0x1499e1=_0x58d5fe(0x1a0)){const _0x15e923=_0x58d5fe,_0x5f793a=await this[_0x15e923(0x1d2)][_0x15e923(0x18a)]({'where':{'userId':_0x55f670,'orderId':_0x13a7f6}});if(!_0x5f793a)throw new common_1[(_0x15e923(0x1cd))](_0x15e923(0x228),common_1['HttpStatus']['BAD_REQUEST']);const _0x55f33b=await this[_0x15e923(0x1e0)][_0x15e923(0x18a)]({'where':{'id':_0x5f793a[_0x15e923(0x22a)]}});if(!_0x55f33b)throw new common_1[(_0x15e923(0x1cd))](_0x15e923(0x18c),common_1['HttpStatus'][_0x15e923(0x1ca)]);console[_0x15e923(0x1ae)](_0x15e923(0x1b8),_0x5f793a[_0x15e923(0x1cb)]);try{if(_0x5f793a[_0x15e923(0x1cb)]==_0x15e923(0x1aa))return this[_0x15e923(0x187)](_0x55f670,_0x13a7f6,_0x1499e1);if(_0x5f793a[_0x15e923(0x1cb)]==_0x15e923(0x21d))return this[_0x15e923(0x1db)](_0x55f670,_0x13a7f6,_0x1499e1);if(_0x5f793a[_0x15e923(0x1cb)]==_0x15e923(0x201))return this[_0x15e923(0x1d3)](_0x55f670,_0x13a7f6,_0x1499e1);if(_0x5f793a['payPlatform']==_0x15e923(0x170))return this[_0x15e923(0x1d4)](_0x55f670,_0x13a7f6,_0x1499e1);if(_0x5f793a['payPlatform']==_0x15e923(0x207))return this[_0x15e923(0x1dd)](_0x55f670,_0x13a7f6,_0x1499e1);}catch(_0x498b4f){console[_0x15e923(0x1ae)](_0x15e923(0x198),_0x498b4f);throw new common_1[(_0x15e923(0x1cd))](_0x15e923(0x190),common_1['HttpStatus'][_0x15e923(0x1ca)]);}}async['query'](_0x42b781){const _0x38fe04=_0x58d5fe,_0x29caff=await this[_0x38fe04(0x1d2)]['findOne']({'where':{'orderId':_0x42b781}});if(!_0x29caff)throw new common_1[(_0x38fe04(0x1cd))](_0x38fe04(0x228),common_1['HttpStatus'][_0x38fe04(0x1ca)]);return _0x29caff;}async[_0x58d5fe(0x1ff)](_0x625229){const _0x40b7cc=_0x58d5fe,_0x35b2ff=await this[_0x40b7cc(0x185)]['getConfigByKeys']([_0x40b7cc(0x1ba)]),_0x27939d=_0x625229[_0x40b7cc(0x225)];delete _0x625229[_0x40b7cc(0x225)];if(this[_0x40b7cc(0x1da)](_0x625229,_0x35b2ff)!=_0x27939d)return'failed';const _0x446db5=await this[_0x40b7cc(0x1d2)][_0x40b7cc(0x18a)]({'where':{'orderId':_0x625229[_0x40b7cc(0x17d)],'status':0x0}});if(!_0x446db5)return _0x40b7cc(0x18d);await this[_0x40b7cc(0x1a8)][_0x40b7cc(0x194)](_0x446db5);const _0x4b82da=await this[_0x40b7cc(0x1d2)][_0x40b7cc(0x218)]({'orderId':_0x625229['trade_order_id']},{'status':0x1,'paydAt':(0x0,date_1[_0x40b7cc(0x197)])()[_0x40b7cc(0x1a3)]()});if(_0x4b82da[_0x40b7cc(0x21e)]!=0x1)return _0x40b7cc(0x18d);return _0x40b7cc(0x179);}async[_0x58d5fe(0x1dd)](_0x248cc6,_0x1f0e6e,_0x595292=_0x58d5fe(0x1a0)){const _0x2eb029=_0x58d5fe,_0xe245a=await this[_0x2eb029(0x1d2)]['findOne']({'where':{'userId':_0x248cc6,'orderId':_0x1f0e6e}});if(!_0xe245a)throw new common_1[(_0x2eb029(0x1cd))]('订单不存在!',common_1[_0x2eb029(0x1df)][_0x2eb029(0x1ca)]);const _0x484270=await this[_0x2eb029(0x1e0)][_0x2eb029(0x18a)]({'where':{'id':_0xe245a[_0x2eb029(0x22a)]}});if(!_0x484270)throw new common_1[(_0x2eb029(0x1cd))](_0x2eb029(0x18c),common_1[_0x2eb029(0x1df)][_0x2eb029(0x1ca)]);const {payHupiAppId:_0x33d45c,payHupiSecret:_0x31538f,payHupiNotifyUrl:_0x1bd4cd,payHupiReturnUrl:_0x4bfd7d,payHupiGatewayUrl:_0x5525de}=await this[_0x2eb029(0x185)][_0x2eb029(0x1c3)]([_0x2eb029(0x1fc),_0x2eb029(0x1ba),'payHupiNotifyUrl',_0x2eb029(0x1a2),'payHupiGatewayUrl']),_0x568301={};_0x568301[_0x2eb029(0x22e)]='1.1',_0x568301[_0x2eb029(0x200)]=_0x33d45c,_0x568301[_0x2eb029(0x1e5)]=(Date[_0x2eb029(0x1e6)]()/0x3e8)[_0x2eb029(0x220)](0x0),_0x568301[_0x2eb029(0x1ad)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x568301[_0x2eb029(0x17d)]=_0x1f0e6e,_0x568301[_0x2eb029(0x235)]=_0x484270[_0x2eb029(0x1b6)],_0x568301['total_fee']=_0xe245a[_0x2eb029(0x227)],_0x568301[_0x2eb029(0x1dc)]=_0x1bd4cd,_0x568301['return_url']=_0x4bfd7d,_0x568301[_0x2eb029(0x1f4)]=_0x2eb029(0x207),_0x568301[_0x2eb029(0x225)]=this[_0x2eb029(0x1da)](_0x568301,_0x31538f);const {data:{errcode:_0x575d54,errmsg:_0x2d23c8,url_qrcode:_0x5be742,url:_0x1ce318}}=await axios_1[_0x2eb029(0x197)][_0x2eb029(0x1d5)](_0x5525de||_0x2eb029(0x16d),_0x568301);if(_0x575d54!=0x0)throw new common_1[(_0x2eb029(0x1cd))](_0x2d23c8,common_1['HttpStatus'][_0x2eb029(0x1ca)]);return{'url_qrcode':_0x5be742,'url':_0x1ce318};}async['queryHupi'](_0x4c9779){const _0x5a72dc=_0x58d5fe,{payHupiAppId:_0x1556d9,payHupiSecret:_0x3ebd26}=await this[_0x5a72dc(0x185)][_0x5a72dc(0x1c3)]([_0x5a72dc(0x1fc),_0x5a72dc(0x1ba)]),_0x15a738={};_0x15a738['version']=_0x5a72dc(0x19e),_0x15a738['appid']=_0x1556d9,_0x15a738[_0x5a72dc(0x1e5)]=(Date[_0x5a72dc(0x1e6)]()/0x3e8)[_0x5a72dc(0x220)](0x0),_0x15a738[_0x5a72dc(0x1ad)]=(0x0,utils_1[_0x5a72dc(0x1b0)])(0x20),_0x15a738[_0x5a72dc(0x1d6)]=_0x4c9779,_0x15a738[_0x5a72dc(0x225)]=this[_0x5a72dc(0x1da)](_0x15a738,_0x3ebd26);const {data:{errcode:_0x23803b,errmsg:_0x95d178,data:_0xe7470b}}=await axios_1[_0x5a72dc(0x197)][_0x5a72dc(0x1d5)](_0x5a72dc(0x192),_0x15a738);if(_0x23803b!=0x0)throw new common_1[(_0x5a72dc(0x1cd))](_0x95d178,common_1[_0x5a72dc(0x1df)]['BAD_REQUEST']);return _0xe7470b;}async[_0x58d5fe(0x1b1)](_0x50187a){const _0x19b78c=_0x58d5fe,_0x306608=_0x50187a[_0x19b78c(0x1da)];delete _0x50187a[_0x19b78c(0x1da)],delete _0x50187a['sign_type'];const _0x1096f7=await this[_0x19b78c(0x185)][_0x19b78c(0x1c3)](['payEpaySecret']);if(this[_0x19b78c(0x1da)](_0x50187a,_0x1096f7)!=_0x306608)return _0x19b78c(0x18d);console[_0x19b78c(0x1ae)]('校验签名通过');const _0x36f8fe=await this[_0x19b78c(0x1d2)][_0x19b78c(0x18a)]({'where':{'orderId':_0x50187a[_0x19b78c(0x217)],'status':0x0}});if(!_0x36f8fe)return _0x19b78c(0x18d);const _0x36d49c=_0x50187a[_0x19b78c(0x1b2)]==_0x19b78c(0x1f9)?0x1:0x2,_0x54fb3a=await this[_0x19b78c(0x1d2)][_0x19b78c(0x218)]({'orderId':_0x50187a[_0x19b78c(0x217)]},{'status':_0x36d49c,'paydAt':(0x0,date_1['default'])()[_0x19b78c(0x1a3)]()});_0x36d49c===0x1&&await this[_0x19b78c(0x1a8)][_0x19b78c(0x194)](_0x36f8fe);if(_0x54fb3a[_0x19b78c(0x21e)]!=0x1)return'failed';return _0x19b78c(0x179);}async[_0x58d5fe(0x1d3)](_0x165c33,_0x23ec93,_0x4a8c35=_0x58d5fe(0x1aa)){const _0x3d7806=_0x58d5fe,_0x398088=await this['orderEntity']['findOne']({'where':{'userId':_0x165c33,'orderId':_0x23ec93}});if(!_0x398088)throw new common_1[(_0x3d7806(0x1cd))]('订单不存在!',common_1[_0x3d7806(0x1df)][_0x3d7806(0x1ca)]);const _0x233cb6=await this[_0x3d7806(0x1e0)]['findOne']({'where':{'id':_0x398088['goodsId']}});if(!_0x233cb6)throw new common_1['HttpException'](_0x3d7806(0x18c),common_1[_0x3d7806(0x1df)]['BAD_REQUEST']);const {payEpayPid:_0x1f1a78,payEpaySecret:_0x37f34a,payEpayNotifyUrl:_0x2f4db0,payEpayReturnUrl:_0x258a8d,payEpayApiPayUrl:_0x5cf5fd}=await this[_0x3d7806(0x185)][_0x3d7806(0x1c3)]([_0x3d7806(0x196),'payEpaySecret','payEpayNotifyUrl',_0x3d7806(0x1c2),_0x3d7806(0x22b)]);let _0x49914e;_0x1f1a78[_0x3d7806(0x215)]<=0x10?_0x49914e=Number(_0x1f1a78):_0x49914e=BigInt(_0x1f1a78);const _0x266f88={};_0x266f88[_0x3d7806(0x16e)]=_0x49914e,_0x266f88[_0x3d7806(0x1ab)]=_0x4a8c35,_0x266f88['out_trade_no']=_0x23ec93,_0x266f88[_0x3d7806(0x1b6)]=_0x233cb6[_0x3d7806(0x1b6)],_0x266f88[_0x3d7806(0x209)]=_0x398088['total'],_0x266f88['clientip']='192.168.1.100',_0x266f88[_0x3d7806(0x211)]='pc',_0x266f88[_0x3d7806(0x1dc)]=_0x2f4db0,_0x266f88[_0x3d7806(0x214)]=_0x258a8d,_0x266f88['param']='epay',_0x266f88[_0x3d7806(0x1da)]=this[_0x3d7806(0x1da)](_0x266f88,_0x37f34a),_0x266f88[_0x3d7806(0x20a)]=_0x3d7806(0x16f);const _0x2db7a1=new URLSearchParams(_0x266f88)[_0x3d7806(0x21b)](),_0x3880c6=_0x5cf5fd+'?'+_0x2db7a1;if(_0x5cf5fd[_0x3d7806(0x176)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x3880c6,'channel':_0x4a8c35,'isRedirect':!![]};else{const _0x1ef88b=await axios_1[_0x3d7806(0x197)][_0x3d7806(0x178)](_0x5cf5fd,{'params':_0x266f88});console[_0x3d7806(0x1ae)]('epay\x20--->\x20res:\x20',_0x1ef88b['data']);const {data:{code:_0x570f84,msg:_0x2df325,qrcode:_0x179ee3}}=_0x1ef88b;if(_0x570f84!=0x1)throw new common_1[(_0x3d7806(0x1cd))](_0x2df325,common_1[_0x3d7806(0x1df)][_0x3d7806(0x1ca)]);return{'url_qrcode':_0x179ee3,'redirectUrl':null,'channel':_0x4a8c35,'isRedirect':![]};}}async[_0x58d5fe(0x189)](_0x3c8641){const _0x20a937=_0x58d5fe,{payEpayPid:_0x98eb89,payEpaySecret:_0x386865,payEpayApiQueryUrl:_0x3ed98f}=await this[_0x20a937(0x185)][_0x20a937(0x1c3)]([_0x20a937(0x196),_0x20a937(0x184),_0x20a937(0x1d9)]),_0x2dddce={};_0x2dddce[_0x20a937(0x1c8)]='order',_0x2dddce['out_trade_no']=_0x3c8641,_0x2dddce[_0x20a937(0x16e)]=_0x98eb89,_0x2dddce['key']=_0x386865;const {data:{code:_0x291c7b,msg:_0x57dd72,data:_0x2c26d8}}=await axios_1[_0x20a937(0x197)][_0x20a937(0x178)](_0x3ed98f,{'params':_0x2dddce});if(_0x291c7b!=0x1)throw new common_1[(_0x20a937(0x1cd))](_0x57dd72,common_1[_0x20a937(0x1df)]['BAD_REQUEST']);return _0x2c26d8;}async[_0x58d5fe(0x233)](_0x3dfc08){const _0x42f59f=_0x58d5fe,_0xbc13d=_0x3dfc08[_0x42f59f(0x1da)];delete _0x3dfc08[_0x42f59f(0x1da)],delete _0x3dfc08[_0x42f59f(0x20a)];const _0x47e020=await this[_0x42f59f(0x185)][_0x42f59f(0x1c3)]([_0x42f59f(0x231)]);console[_0x42f59f(0x1ae)](_0x42f59f(0x1cc));if(this['sign'](_0x3dfc08,_0x47e020)!=_0xbc13d)return _0x42f59f(0x18d);console[_0x42f59f(0x1ae)]('校验签名通过');const _0x5ee049=await this['orderEntity']['findOne']({'where':{'orderId':_0x3dfc08['out_trade_no'],'status':0x0}});if(!_0x5ee049)return _0x42f59f(0x18d);const _0x4509d5=_0x3dfc08['trade_status']==_0x42f59f(0x1f9)?0x1:0x2;console[_0x42f59f(0x1ae)](_0x42f59f(0x172),_0x4509d5);const _0x56a91a=await this[_0x42f59f(0x1d2)][_0x42f59f(0x218)]({'orderId':_0x3dfc08[_0x42f59f(0x217)]},{'status':_0x4509d5,'paydAt':(0x0,date_1[_0x42f59f(0x197)])()[_0x42f59f(0x1a3)]()});_0x4509d5===0x1&&await this['userBalanceService'][_0x42f59f(0x194)](_0x5ee049);if(_0x56a91a[_0x42f59f(0x21e)]!=0x1)return _0x42f59f(0x18d);return _0x42f59f(0x179);}async[_0x58d5fe(0x1d4)](_0x41e04c,_0x39c3c1,_0x4b02a7=_0x58d5fe(0x1a0)){const _0x4e0cf3=_0x58d5fe,_0x257c6f=await this[_0x4e0cf3(0x1d2)][_0x4e0cf3(0x18a)]({'where':{'userId':_0x41e04c,'orderId':_0x39c3c1}});if(!_0x257c6f)throw new common_1[(_0x4e0cf3(0x1cd))](_0x4e0cf3(0x228),common_1['HttpStatus']['BAD_REQUEST']);const _0x17d0ed=await this['cramiPackageEntity'][_0x4e0cf3(0x18a)]({'where':{'id':_0x257c6f['goodsId']}});if(!_0x17d0ed)throw new common_1[(_0x4e0cf3(0x1cd))](_0x4e0cf3(0x18c),common_1['HttpStatus'][_0x4e0cf3(0x1ca)]);const {payMpayPid:_0x2994ad,payMpaySecret:_0x41cd8e,payMpayNotifyUrl:_0x27301d,payMpayReturnUrl:_0x1e9a68,payMpayApiPayUrl:_0x466b3d}=await this[_0x4e0cf3(0x185)]['getConfigByKeys']([_0x4e0cf3(0x212),'payMpaySecret',_0x4e0cf3(0x1b3),'payMpayReturnUrl','payMpayApiPayUrl']),_0x35ad50={};_0x35ad50['pid']=Number(_0x2994ad),_0x35ad50[_0x4e0cf3(0x1ab)]=_0x4b02a7,_0x35ad50[_0x4e0cf3(0x217)]=_0x39c3c1,_0x35ad50[_0x4e0cf3(0x1b6)]=_0x17d0ed[_0x4e0cf3(0x1b6)],_0x35ad50[_0x4e0cf3(0x209)]=_0x257c6f[_0x4e0cf3(0x227)],_0x35ad50['notify_url']=_0x27301d,_0x35ad50['return_url']=_0x1e9a68,_0x35ad50[_0x4e0cf3(0x1da)]=this[_0x4e0cf3(0x1da)](_0x35ad50,_0x41cd8e),_0x35ad50[_0x4e0cf3(0x20a)]=_0x4e0cf3(0x16f);const _0x3d3db1=new URLSearchParams(_0x35ad50)[_0x4e0cf3(0x21b)](),_0x5300b6=_0x466b3d+'?'+_0x3d3db1;return{'url_qrcode':null,'redirectUrl':_0x5300b6,'channel':_0x4b02a7,'isRedirect':!![]};}async[_0x58d5fe(0x229)](_0x58798d){const _0x9601a4=_0x58d5fe,{payMpayApiQueryUrl:_0x3ff073}=await this[_0x9601a4(0x185)]['getConfigByKeys']([_0x9601a4(0x212),_0x9601a4(0x231),'payMpayApiQueryUrl']),_0x243751={};_0x243751[_0x9601a4(0x1ab)]=0x2,_0x243751[_0x9601a4(0x18b)]=_0x58798d;const {data:{code:_0x5ef515,msg:_0x24f56f,data:_0x207851}}=await axios_1[_0x9601a4(0x197)][_0x9601a4(0x178)](_0x3ff073,{'params':_0x243751});if(_0x5ef515!=0x1)throw new common_1['HttpException'](_0x24f56f,common_1[_0x9601a4(0x1df)][_0x9601a4(0x1ca)]);return _0x207851;}async['notifyWeChat'](_0x2b685e){const _0x1db3ee=_0x58d5fe;console[_0x1db3ee(0x1ae)](_0x1db3ee(0x1d1),_0x2b685e);const {payWeChatAppId:_0x2a275f,payWeChatMchId:_0x337a23,payWeChatSecret:_0x5bb512,payWeChatPublicKey:_0x8ed304,payWeChatPrivateKey:_0x12bf9f}=await this[_0x1db3ee(0x185)][_0x1db3ee(0x1c3)]([_0x1db3ee(0x17b),_0x1db3ee(0x1e9),_0x1db3ee(0x22f),_0x1db3ee(0x1cf),'payWeChatPrivateKey']),_0x2e77f0=new WxPay({'appid':_0x2a275f,'mchid':_0x337a23,'publicKey':_0x8ed304,'privateKey':_0x12bf9f});let _0x16f207;try{if(_0x2b685e['event_type']==_0x1db3ee(0x1c5)){const {ciphertext:_0x2cdc91,associated_data:_0xf84e8d,nonce:_0x113c88}=_0x2b685e[_0x1db3ee(0x1e3)],_0x75b0a=_0x2e77f0[_0x1db3ee(0x221)](_0x2cdc91,_0xf84e8d,_0x113c88,_0x5bb512),_0x2c6ca3=_0x75b0a[_0x1db3ee(0x217)];_0x16f207=redisKey_constant_1[_0x1db3ee(0x1a6)]+_0x2c6ca3,await this[_0x1db3ee(0x1f6)]['set']({'key':_0x16f207,'val':_0x1db3ee(0x20e)});const _0x190e00=await this[_0x1db3ee(0x1d2)][_0x1db3ee(0x18a)]({'where':{'orderId':_0x2c6ca3,'status':0x0}});if(!_0x190e00)return _0x1db3ee(0x18d);if([0x1,0x2,0x3]['includes'](_0x190e00['status']))return _0x1db3ee(0x179);const _0x990404=await this[_0x1db3ee(0x230)][_0x1db3ee(0x16b)](async _0x20e254=>{const _0x368303=_0x1db3ee,_0x31f84c=_0x75b0a[_0x368303(0x1e4)]==_0x368303(0x18f)?0x1:0x2,_0x23aeeb=await this[_0x368303(0x1d2)][_0x368303(0x218)]({'orderId':_0x2c6ca3},{'status':_0x31f84c,'paydAt':(0x0,date_1[_0x368303(0x197)])()[_0x368303(0x1a3)](),'tradeId':_0x75b0a[_0x368303(0x1de)]});return _0x31f84c===0x1&&await this['userBalanceService']['addBalanceToOrder'](_0x190e00),_0x23aeeb;});if(_0x990404['affected']!=0x1)return _0x1db3ee(0x18d);}return _0x1db3ee(0x179);}catch(_0x3171d4){return console[_0x1db3ee(0x1ae)](_0x1db3ee(0x1a9),_0x3171d4),console[_0x1db3ee(0x1ae)]('支付通知验证失败:\x20',_0x3171d4),_0x1db3ee(0x18d);}finally{_0x16f207&&await this[_0x1db3ee(0x1f6)][_0x1db3ee(0x19c)]({'key':_0x16f207});}}async[_0x58d5fe(0x187)](_0x2b815c,_0x362966,_0x548e44){const _0x27d6c4=_0x58d5fe,_0x3c1bfa=await this[_0x27d6c4(0x1d2)][_0x27d6c4(0x18a)]({'where':{'userId':_0x2b815c,'orderId':_0x362966}});if(!_0x3c1bfa)throw new common_1['HttpException'](_0x27d6c4(0x228),common_1['HttpStatus'][_0x27d6c4(0x1ca)]);const _0x2301f5=await this['cramiPackageEntity'][_0x27d6c4(0x18a)]({'where':{'id':_0x3c1bfa[_0x27d6c4(0x22a)]}});if(!_0x2301f5)throw new common_1[(_0x27d6c4(0x1cd))](_0x27d6c4(0x18c),common_1[_0x27d6c4(0x1df)]['BAD_REQUEST']);const _0x4bfa3a={'bizContent':{'out_trade_no':_0x362966,'total_amount':_0x3c1bfa['total'],'subject':_0x2301f5[_0x27d6c4(0x1b6)]}};let _0x558f6c,_0x511279,_0xcf9257,_0x490829,_0x5a58f3;const {payAliPublicSecret:_0x1ec23c,payAliWebAppId:_0xa4cf39,payAliWebSecret:_0x3c7d62,payAliAppAppId:_0x513e9d,payAliAppSecret:_0x204c39,payWeChatNotifyUrl:_0xd25829}=await this[_0x27d6c4(0x185)][_0x27d6c4(0x1c3)](['payAliPublicSecret',_0x27d6c4(0x1a4),'payAliWebSecret',_0x27d6c4(0x1b4),'payAliAppSecret',_0x27d6c4(0x1c0)]);_0x548e44==='native'&&(_0x4bfa3a[_0x27d6c4(0x1d8)]=_0x27d6c4(0x1b5),_0x558f6c=_0xa4cf39,_0xcf9257='pageExec',_0x511279=_0x3c7d62,_0x490829=_0x27d6c4(0x191),_0x5a58f3='FAST_INSTANT_TRADE_PAY');_0x548e44===_0x27d6c4(0x188)&&(_0xcf9257=_0x27d6c4(0x199),_0x558f6c=_0x513e9d,_0x511279=_0x204c39,_0x490829=_0x27d6c4(0x1a5),_0x5a58f3=_0x27d6c4(0x19f));const _0x215146=new AlipaySdk({'appId':_0x558f6c,'keyType':_0x27d6c4(0x21c),'privateKey':_0x511279,'alipayPublicKey':_0x1ec23c});_0x4bfa3a[_0x27d6c4(0x1f8)]=_0xd25829,_0x4bfa3a['bizContent'][_0x27d6c4(0x195)]=_0x5a58f3;const _0x1948b9=await _0x215146[_0xcf9257](_0x490829,_0x4bfa3a);return console[_0x27d6c4(0x1ae)](_0x27d6c4(0x205),_0x1948b9),_0x548e44===_0x27d6c4(0x1ec)?{'form':_0x1948b9}:{'data':_0x1948b9};}async['queryAliPay'](_0x1a0aea,_0x715ee){const _0x24b37c=_0x58d5fe;let _0x205de3,_0x142aba;const {payAliPublicSecret:_0x11638a,payAliWebAppId:_0x2cdecd,payAliWebSecret:_0x45c036,payAliAppAppId:_0x397e8e,payAliAppSecret:_0x2dc46a,payWeChatNotifyUrl:_0x174e4f}=await this['globalConfigService']['getConfigByKeys']([_0x24b37c(0x1ce),_0x24b37c(0x1a4),_0x24b37c(0x17f),_0x24b37c(0x1b4),'payAliAppSecret',_0x24b37c(0x1c0)]);_0x715ee===_0x24b37c(0x1ec)&&(_0x205de3=_0x2cdecd,_0x142aba=_0x45c036);_0x715ee==='app'&&(_0x205de3=_0x397e8e,_0x142aba=_0x2dc46a);const _0x101e51=new AlipaySdk({'appId':_0x205de3,'keyType':_0x24b37c(0x21c),'privateKey':_0x142aba,'alipayPublicKey':_0x11638a}),_0x2fca32=await _0x101e51[_0x24b37c(0x1a1)]('alipay.trade.query',{'bizContent':{'out_trade_no':_0x1a0aea}});return console['log'](_0x2fca32),_0x2fca32;}async[_0x58d5fe(0x1db)](_0x2674c3,_0x3db4fe,_0x3ac4be=_0x58d5fe(0x1ec)){const _0x1dbf5d=_0x58d5fe;console['log'](_0x1dbf5d(0x22d),_0x3ac4be);const _0x504d61=await this['orderEntity'][_0x1dbf5d(0x18a)]({'where':{'userId':_0x2674c3,'orderId':_0x3db4fe}});if(!_0x504d61)throw new common_1['HttpException'](_0x1dbf5d(0x228),common_1[_0x1dbf5d(0x1df)][_0x1dbf5d(0x1ca)]);const _0x560139=await this[_0x1dbf5d(0x1e0)]['findOne']({'where':{'id':_0x504d61['goodsId']}});if(!_0x560139)throw new common_1[(_0x1dbf5d(0x1cd))](_0x1dbf5d(0x18c),common_1[_0x1dbf5d(0x1df)][_0x1dbf5d(0x1ca)]);const {payWeChatAppId:_0x424d94,payWeMiniAppId:_0x31ef97,payWeChatMchId:_0x3be5c7,payWeChatPublicKey:_0x43ca41,payWeChatPrivateKey:_0x2aae0c,payWeChatNotifyUrl:_0x14e1bf,payWeChatH5Name:_0x4e06dc,payWeChatH5Url:_0x5d8094,WE_APP_APPID:_0x4d0857,WE_APP_APPSECRET:_0x5ce078}=await this[_0x1dbf5d(0x185)][_0x1dbf5d(0x1c3)]([_0x1dbf5d(0x17b),_0x1dbf5d(0x20c),_0x1dbf5d(0x1e9),_0x1dbf5d(0x1cf),_0x1dbf5d(0x1ed),_0x1dbf5d(0x1c0),_0x1dbf5d(0x177),'payWeChatH5Url',_0x1dbf5d(0x224)]),_0x5441eb=new WxPay({'appid':_0x3ac4be==='mini'?_0x31ef97:_0x424d94,'mchid':_0x3be5c7,'publicKey':_0x43ca41,'privateKey':_0x2aae0c}),_0x5776a3={'appid':_0x3ac4be===_0x1dbf5d(0x1c1)?_0x31ef97:_0x424d94,'mchid':_0x3be5c7,'description':_0x560139[_0x1dbf5d(0x1b6)],'out_trade_no':_0x3db4fe,'notify_url':_0x14e1bf,'amount':{'total':Number(_0x504d61[_0x1dbf5d(0x227)]*0x64)},'scene_info':{'payer_client_ip':_0x1dbf5d(0x1ee)}};console['log']('wechat-pay:\x20',_0x5776a3);if(_0x3ac4be=='h5'){_0x5776a3[_0x1dbf5d(0x19a)]['h5_info']={'type':_0x1dbf5d(0x210),'app_name':_0x4e06dc,'app_url':_0x5d8094};const _0x85feb2=await _0x5441eb['transactions_h5'](_0x5776a3);if(_0x85feb2[_0x1dbf5d(0x1c9)]===0x193){const _0x380629=_0x85feb2?.['errRaw']?.['response']?.[_0x1dbf5d(0x1f1)]?.[_0x1dbf5d(0x1d0)];throw new common_1[(_0x1dbf5d(0x1cd))](_0x85feb2?.[_0x1dbf5d(0x1d0)]||_0x1dbf5d(0x171),common_1[_0x1dbf5d(0x1df)][_0x1dbf5d(0x1ca)]);}const {h5_url:_0x558db7}=_0x85feb2;return{'url':_0x558db7};}if(_0x3ac4be==='app'){_0x5776a3[_0x1dbf5d(0x200)]=_0x4d0857;const _0x35a910=await _0x5441eb[_0x1dbf5d(0x20f)](_0x5776a3);return console[_0x1dbf5d(0x1ae)]('App支付结果返回值:\x20',_0x35a910),_0x35a910;}if(_0x3ac4be==_0x1dbf5d(0x1c1)){const _0xef5441=await this[_0x1dbf5d(0x222)][_0x1dbf5d(0x1be)](_0x2674c3);_0x5776a3[_0x1dbf5d(0x17c)]={'openid':_0xef5441};const _0x3a58cf=await _0x5441eb[_0x1dbf5d(0x22c)](_0x5776a3);return console[_0x1dbf5d(0x1ae)](_0x1dbf5d(0x1f2),_0x3a58cf),_0x3a58cf;}if(_0x3ac4be=='jsapi'){const _0x32e582=await this[_0x1dbf5d(0x222)][_0x1dbf5d(0x1f0)](_0x2674c3);console[_0x1dbf5d(0x1ae)](_0x1dbf5d(0x1f5),_0x32e582),_0x5776a3[_0x1dbf5d(0x17c)]={'openid':_0x32e582};const _0x32c7a7=await _0x5441eb[_0x1dbf5d(0x22c)](_0x5776a3);return console[_0x1dbf5d(0x1ae)](_0x1dbf5d(0x1f2),_0x32c7a7),_0x32c7a7;}if(_0x3ac4be==_0x1dbf5d(0x1ec)){const _0x32b738=await _0x5441eb[_0x1dbf5d(0x1e8)](_0x5776a3),{code_url:_0x4c8bfa}=_0x32b738;return!_0x4c8bfa&&console['log'](_0x1dbf5d(0x17a),_0x32b738),{'url_qrcode':_0x4c8bfa,'isRedirect':![]};}throw new common_1['HttpException'](_0x1dbf5d(0x1c7),common_1[_0x1dbf5d(0x1df)][_0x1dbf5d(0x1ca)]);}async['queryWeChat'](_0x476fca,_0xcc3218){const _0x36ce52=_0x58d5fe,{payWeChatAppId:_0x56d8e1,payWeMiniAppId:_0x2fa287,payWeChatMchId:_0x5e412e,payWeChatPublicKey:_0x354ff7,payWeChatPrivateKey:_0x3af18a}=await this[_0x36ce52(0x185)][_0x36ce52(0x1c3)](['payWeChatAppId',_0x36ce52(0x20c),'payWeChatMchId',_0x36ce52(0x1cf),'payWeChatPrivateKey']),_0x533a97=new WxPay({'appid':_0xcc3218===_0x36ce52(0x1c1)?_0x2fa287:_0x56d8e1,'mchid':_0x5e412e,'publicKey':_0x354ff7,'privateKey':_0x3af18a}),_0x2d0bae=await _0x533a97[_0x36ce52(0x1eb)]({'out_trade_no':_0x476fca});return _0x2d0bae;}async[_0x58d5fe(0x1fa)](_0x481efb){const _0x25f064=_0x58d5fe;_0x481efb[_0x25f064(0x1cb)]===_0x25f064(0x21d)&&await this['cancelWxOrder'](_0x481efb);}async[_0x58d5fe(0x1bd)](_0x2a7d8e){const _0x4ea0a3=_0x58d5fe,{payWeChatAppId:_0x2d1b3c,payWeMiniAppId:_0x367944,payWeChatMchId:_0x2cc44c,payWeChatPublicKey:_0x32c1c8,payWeChatPrivateKey:_0x576084}=await this[_0x4ea0a3(0x185)][_0x4ea0a3(0x1c3)](['payWeChatAppId','payWeMiniAppId',_0x4ea0a3(0x1e9),_0x4ea0a3(0x1cf),_0x4ea0a3(0x1ed),_0x4ea0a3(0x1c0),_0x4ea0a3(0x177),_0x4ea0a3(0x223)]),_0x4d52c6=new WxPay({'appid':_0x2a7d8e['channel']===_0x4ea0a3(0x1c1)?_0x367944:_0x2d1b3c,'mchid':_0x2cc44c,'publicKey':_0x32c1c8,'privateKey':_0x576084});await _0x4d52c6[_0x4ea0a3(0x204)](_0x2a7d8e[_0x4ea0a3(0x203)]);}[_0x58d5fe(0x1da)](_0x49e795,_0x556196){const _0x466969=_0x58d5fe,_0xc0beb4=Object[_0x466969(0x206)](_0x49e795)[_0x466969(0x1d7)]()[_0x466969(0x232)](_0x126d02=>_0x126d02+'='+_0x49e795[_0x126d02])[_0x466969(0x1fb)]('&')+_0x556196;return crypto[_0x466969(0x18e)]('md5')['update'](_0xc0beb4)['digest'](_0x466969(0x186));}};function _0x4df1(_0x72a955,_0x2d0d62){const _0x55ba8a=_0x55ba();return _0x4df1=function(_0x4df106,_0x4cf4fb){_0x4df106=_0x4df106-0x16b;let _0x1174fd=_0x55ba8a[_0x4df106];return _0x1174fd;},_0x4df1(_0x72a955,_0x2d0d62);}PayService=__decorate([(0x0,common_1[_0x58d5fe(0x21a)])(),__param(0x0,(0x0,typeorm_1[_0x58d5fe(0x193)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x58d5fe(0x208)])),__metadata(_0x58d5fe(0x1e2),[typeorm_2[_0x58d5fe(0x234)],typeorm_2['Repository'],userBalance_service_1['UserBalanceService'],globalConfig_service_1[_0x58d5fe(0x1af)],user_service_1[_0x58d5fe(0x219)],redisCache_service_1[_0x58d5fe(0x1bc)],typeorm_2[_0x58d5fe(0x181)]])],PayService),exports[_0x58d5fe(0x202)]=PayService;