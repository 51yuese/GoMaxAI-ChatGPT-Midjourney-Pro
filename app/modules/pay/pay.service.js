'use strict';function _0x48cf(_0x48d5cd,_0x39bd92){const _0x437024=_0x4370();return _0x48cf=function(_0x48cfa4,_0xcb554a){_0x48cfa4=_0x48cfa4-0xad;let _0x4faa53=_0x437024[_0x48cfa4];return _0x4faa53;},_0x48cf(_0x48d5cd,_0x39bd92);}const _0x5a7ea9=_0x48cf;function _0x4370(){const _0x153c34=['微信H5支付失败！','Connection','toDate','crypto','out_trade_no','6GyYBNP','wechat','query','app','payWeChat','transactions_jsapi','toString','payWeChatPublicKey','userBalanceService','hash','connection','globalConfigService','total','payEpayApiQueryUrl','h5_info','@nestjs/typeorm','校验签名','__param','wechat-pay:\x20','payMpayApiPayUrl','../order/order.entity','支付请求失败:\x20','length','orderId','payAliWebAppId','payWeChatNotifyUrl','includes','userService','payType:\x20','lock','notifyWeChat','map','wxpay','TRADE_SUCCESS','HttpException','hupi','Injectable','Repository','../../common/utils','epay','payWeChatH5Name','version','订单不存在!','typeorm','MD5','function','__metadata','resource','payMpayReturnUrl','error:\x20','addBalanceToOrder','alipay','md5','jsapi支付结果返回值:\x20','key','payMpay','PAY_UPDATE_ORDER','payer','HttpStatus','729336feDQeY','9425738JLNapS','sign_type','payWeChatH5Url','money','../userBalance/userBalance.service','payAliPublicSecret','method','cancelWxOrder','../../common/constants/redisKey.constant','response','affected','axios','nonce_str','notifyHupi','PKCS1','wx-native','now','payEpayNotifyUrl','event_type','1.1','SUCCESS','appid','digest','payMpayApiQueryUrl','data','close','PayService','orderEntity','payMpaySecret','design:paramtypes','queryMpay','trade_order_id','keys','校验签名通过','payWeChatSecret','InjectRepository','payHupiNotifyUrl','payMpayNotifyUrl','device','BAD_REQUEST','payEpaySecret','failed','join','@nestjs/common','5653616mMAAJh','payMpayPid','getMiniOpenIdByUserId','decipher_gcm','payWeChatPrivateKey','status','RedisCacheService','WE_APP_APPID','payHupiGatewayUrl','default','onModuleInit','3785724zxWCXt','payHupi','message','trade_status','cancel','cramiPackageEntity','3102485FWfXMN','sdkExec','alipay\x20result:\x20','payWeChatAppId','本次支付类型:\x20','alipay.trade.query','createHash','getOpenIdByUserId','https://api.xunhupay.com/payment/query.html','getOwnPropertyDescriptor','queryWeChat','Wap','param','title','FAST_INSTANT_TRADE_PAY','success','TRANSACTION.SUCCESS','time','UserBalanceService','object','get','192.168.1.100','order_no','payAli','status:\x20','支付请求失败!','submit.php','payHupiSecret','hex','sign','getConfigByKeys','payPlatform','payWeChatMchId','1045816pPykjD','clientip','queryHupi','payWeMiniAppId','notifyMpay','30lRMrbb','payEpayApiPayUrl','payAliWebSecret','out_trade_order','epay\x20--->\x20res:\x20','notifyEpay','redisCacheService','log','type','attach','findOne','native','decorate','transaction','bizContent','8578611WjpwpL','transactions_app','name','mini','mpay','payAliAppAppId','pid','notify_url','OrderEntity','sort','post','update','套餐不存在!','payAliAppSecret','用户openId:\x20','wechatpay-node-v3','createRandomNonceStr','../redisCache/redisCache.service','payEpayPid','queryEpay','metadata','goodsId','2ikvJOy','payHupiAppId','UserService','defineProperty','transaction_id','pay'];_0x4370=function(){return _0x153c34;};return _0x4370();}(function(_0x19f819,_0x4ee49a){const _0x4cb050=_0x48cf,_0x401588=_0x19f819();while(!![]){try{const _0x1f67bc=-parseInt(_0x4cb050(0x140))/0x1*(-parseInt(_0x4cb050(0x16a))/0x2)+parseInt(_0x4cb050(0x175))/0x3*(parseInt(_0x4cb050(0xe1))/0x4)+-parseInt(_0x4cb050(0x11f))/0x5+-parseInt(_0x4cb050(0x119))/0x6+-parseInt(_0x4cb050(0xe2))/0x7+-parseInt(_0x4cb050(0x10e))/0x8+parseInt(_0x4cb050(0x154))/0x9*(parseInt(_0x4cb050(0x145))/0xa);if(_0x1f67bc===_0x4ee49a)break;else _0x401588['push'](_0x401588['shift']());}catch(_0x7bb24d){_0x401588['push'](_0x401588['shift']());}}}(_0x4370,0xebad6));var __decorate=this&&this['__decorate']||function(_0x34bbcc,_0x8b7839,_0xc7586d,_0x4c74ae){const _0x3496f4=_0x48cf;var _0x1941b7=arguments[_0x3496f4(0xbc)],_0x1d2831=_0x1941b7<0x3?_0x8b7839:_0x4c74ae===null?_0x4c74ae=Object[_0x3496f4(0x128)](_0x8b7839,_0xc7586d):_0x4c74ae,_0x3c8a8b;if(typeof Reflect===_0x3496f4(0x132)&&typeof Reflect[_0x3496f4(0x151)]===_0x3496f4(0xd3))_0x1d2831=Reflect['decorate'](_0x34bbcc,_0x8b7839,_0xc7586d,_0x4c74ae);else{for(var _0x323938=_0x34bbcc['length']-0x1;_0x323938>=0x0;_0x323938--)if(_0x3c8a8b=_0x34bbcc[_0x323938])_0x1d2831=(_0x1941b7<0x3?_0x3c8a8b(_0x1d2831):_0x1941b7>0x3?_0x3c8a8b(_0x8b7839,_0xc7586d,_0x1d2831):_0x3c8a8b(_0x8b7839,_0xc7586d))||_0x1d2831;}return _0x1941b7>0x3&&_0x1d2831&&Object[_0x3496f4(0x16d)](_0x8b7839,_0xc7586d,_0x1d2831),_0x1d2831;},__metadata=this&&this[_0x5a7ea9(0xd4)]||function(_0x16b13b,_0x2247b6){const _0x1c8cef=_0x5a7ea9;if(typeof Reflect===_0x1c8cef(0x132)&&typeof Reflect[_0x1c8cef(0x168)]===_0x1c8cef(0xd3))return Reflect[_0x1c8cef(0x168)](_0x16b13b,_0x2247b6);},__param=this&&this[_0x5a7ea9(0xb7)]||function(_0xa4ec0a,_0xe5e2dd){return function(_0x17bea1,_0x41365e){_0xe5e2dd(_0x17bea1,_0x41365e,_0xa4ec0a);};};Object[_0x5a7ea9(0x16d)](exports,'__esModule',{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x5a7ea9(0xb5)),typeorm_2=require(_0x5a7ea9(0xd1)),common_1=require(_0x5a7ea9(0x10d)),crypto=require(_0x5a7ea9(0x173)),axios_1=require(_0x5a7ea9(0xed)),order_entity_1=require(_0x5a7ea9(0xba)),cramiPackage_entity_1=require('../crami/cramiPackage.entity'),userBalance_service_1=require(_0x5a7ea9(0xe6)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x5a7ea9(0xcc)),user_service_1=require('../user/user.service'),redisCache_service_1=require(_0x5a7ea9(0x165)),redisKey_constant_1=require(_0x5a7ea9(0xea)),date_1=require('../../common/utils/date'),WxPay=require(_0x5a7ea9(0x163)),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x5b69a3,_0x3f6f7f,_0x43858f,_0xc27710,_0x682cca,_0x4d901f,_0x9c4744){const _0x276467=_0x5a7ea9;this[_0x276467(0x11e)]=_0x5b69a3,this[_0x276467(0xfd)]=_0x3f6f7f,this[_0x276467(0xae)]=_0x43858f,this[_0x276467(0xb1)]=_0xc27710,this[_0x276467(0xc1)]=_0x682cca,this[_0x276467(0x14b)]=_0x4d901f,this[_0x276467(0xb0)]=_0x9c4744;}async[_0x5a7ea9(0x118)](){}async['notify'](_0x38badc){const _0x1d5179=_0x5a7ea9;if(_0x38badc['param']==_0x1d5179(0xcd))return this['notifyEpay'](_0x38badc);if(_0x38badc[_0x1d5179(0x14e)]==_0x1d5179(0xc9))return this['notifyHupi'](_0x38badc);if(typeof _0x38badc[_0x1d5179(0xd5)]==_0x1d5179(0x132))return this[_0x1d5179(0xc4)](_0x38badc);return this['notifyMpay'](_0x38badc);}async[_0x5a7ea9(0x16f)](_0x40f71a,_0x382d16,_0x39d08f=_0x5a7ea9(0xc6)){const _0xe5dc3a=_0x5a7ea9,_0xae51b2=await this[_0xe5dc3a(0xfd)][_0xe5dc3a(0x14f)]({'where':{'userId':_0x40f71a,'orderId':_0x382d16}});if(!_0xae51b2)throw new common_1[(_0xe5dc3a(0xc8))]('订单不存在!',common_1[_0xe5dc3a(0xe0)][_0xe5dc3a(0x109)]);const _0x885fa1=await this[_0xe5dc3a(0x11e)][_0xe5dc3a(0x14f)]({'where':{'id':_0xae51b2[_0xe5dc3a(0x169)]}});if(!_0x885fa1)throw new common_1[(_0xe5dc3a(0xc8))](_0xe5dc3a(0x160),common_1[_0xe5dc3a(0xe0)][_0xe5dc3a(0x109)]);console[_0xe5dc3a(0x14c)](_0xe5dc3a(0x123),_0xae51b2['payPlatform']);try{if(_0xae51b2[_0xe5dc3a(0x13e)]==_0xe5dc3a(0xd9))return this[_0xe5dc3a(0x136)](_0x40f71a,_0x382d16,_0x39d08f);if(_0xae51b2[_0xe5dc3a(0x13e)]=='wechat')return this[_0xe5dc3a(0x179)](_0x40f71a,_0x382d16,_0x39d08f);if(_0xae51b2[_0xe5dc3a(0x13e)]==_0xe5dc3a(0xcd))return this['payEpay'](_0x40f71a,_0x382d16,_0x39d08f);if(_0xae51b2[_0xe5dc3a(0x13e)]==_0xe5dc3a(0x158))return this[_0xe5dc3a(0xdd)](_0x40f71a,_0x382d16,_0x39d08f);if(_0xae51b2[_0xe5dc3a(0x13e)]==_0xe5dc3a(0xc9))return this[_0xe5dc3a(0x11a)](_0x40f71a,_0x382d16,_0x39d08f);}catch(_0x4c66eb){console[_0xe5dc3a(0x14c)](_0xe5dc3a(0xbb),_0x4c66eb);throw new common_1[(_0xe5dc3a(0xc8))](_0xe5dc3a(0x138),common_1[_0xe5dc3a(0xe0)][_0xe5dc3a(0x109)]);}}async[_0x5a7ea9(0x177)](_0x2b991a){const _0x694d02=_0x5a7ea9,_0x23232e=await this[_0x694d02(0xfd)][_0x694d02(0x14f)]({'where':{'orderId':_0x2b991a}});if(!_0x23232e)throw new common_1[(_0x694d02(0xc8))](_0x694d02(0xd0),common_1[_0x694d02(0xe0)]['BAD_REQUEST']);return _0x23232e;}async[_0x5a7ea9(0xef)](_0x17d3b6){const _0x12f9a1=_0x5a7ea9,_0x5a1582=await this[_0x12f9a1(0xb1)][_0x12f9a1(0x13d)]([_0x12f9a1(0x13a)]),_0x2af331=_0x17d3b6[_0x12f9a1(0xaf)];delete _0x17d3b6['hash'];if(this['sign'](_0x17d3b6,_0x5a1582)!=_0x2af331)return _0x12f9a1(0x10b);const _0xfb9b90=await this[_0x12f9a1(0xfd)][_0x12f9a1(0x14f)]({'where':{'orderId':_0x17d3b6['trade_order_id'],'status':0x0}});if(!_0xfb9b90)return _0x12f9a1(0x10b);await this[_0x12f9a1(0xae)][_0x12f9a1(0xd8)](_0xfb9b90);const _0x5b0318=await this[_0x12f9a1(0xfd)][_0x12f9a1(0x15f)]({'orderId':_0x17d3b6['trade_order_id']},{'status':0x1,'paydAt':(0x0,date_1[_0x12f9a1(0x117)])()[_0x12f9a1(0x172)]()});if(_0x5b0318['affected']!=0x1)return _0x12f9a1(0x10b);return'success';}async[_0x5a7ea9(0x11a)](_0x560dcb,_0x316ace,_0xd44ff6=_0x5a7ea9(0xc6)){const _0x23b5f6=_0x5a7ea9,_0x29d963=await this[_0x23b5f6(0xfd)][_0x23b5f6(0x14f)]({'where':{'userId':_0x560dcb,'orderId':_0x316ace}});if(!_0x29d963)throw new common_1[(_0x23b5f6(0xc8))](_0x23b5f6(0xd0),common_1[_0x23b5f6(0xe0)]['BAD_REQUEST']);const _0x57a284=await this[_0x23b5f6(0x11e)]['findOne']({'where':{'id':_0x29d963[_0x23b5f6(0x169)]}});if(!_0x57a284)throw new common_1[(_0x23b5f6(0xc8))](_0x23b5f6(0x160),common_1['HttpStatus'][_0x23b5f6(0x109)]);const {payHupiAppId:_0x2771d6,payHupiSecret:_0x4b116b,payHupiNotifyUrl:_0x136f77,payHupiReturnUrl:_0x4764f0,payHupiGatewayUrl:_0x2d6e70}=await this['globalConfigService'][_0x23b5f6(0x13d)]([_0x23b5f6(0x16b),_0x23b5f6(0x13a),_0x23b5f6(0x106),'payHupiReturnUrl',_0x23b5f6(0x116)]),_0x4de93d={};_0x4de93d[_0x23b5f6(0xcf)]=_0x23b5f6(0xf5),_0x4de93d[_0x23b5f6(0xf7)]=_0x2771d6,_0x4de93d[_0x23b5f6(0x130)]=(Date[_0x23b5f6(0xf2)]()/0x3e8)['toFixed'](0x0),_0x4de93d[_0x23b5f6(0xee)]=(0x0,utils_1[_0x23b5f6(0x164)])(0x20),_0x4de93d[_0x23b5f6(0x101)]=_0x316ace,_0x4de93d[_0x23b5f6(0x12c)]=_0x57a284[_0x23b5f6(0x156)],_0x4de93d['total_fee']=_0x29d963[_0x23b5f6(0xb2)],_0x4de93d[_0x23b5f6(0x15b)]=_0x136f77,_0x4de93d['return_url']=_0x4764f0,_0x4de93d['attach']=_0x23b5f6(0xc9),_0x4de93d[_0x23b5f6(0xaf)]=this[_0x23b5f6(0x13c)](_0x4de93d,_0x4b116b);const {data:{errcode:_0x3dd626,errmsg:_0x6e92f5,url_qrcode:_0x30bee4,url:_0x5d0722}}=await axios_1[_0x23b5f6(0x117)][_0x23b5f6(0x15e)](_0x2d6e70||'https://api.xunhupay.com/payment/do.html',_0x4de93d);if(_0x3dd626!=0x0)throw new common_1[(_0x23b5f6(0xc8))](_0x6e92f5,common_1[_0x23b5f6(0xe0)][_0x23b5f6(0x109)]);return{'url_qrcode':_0x30bee4,'url':_0x5d0722};}async[_0x5a7ea9(0x142)](_0x34a3df){const _0x2aad00=_0x5a7ea9,{payHupiAppId:_0x369ae7,payHupiSecret:_0x20ffa6}=await this[_0x2aad00(0xb1)][_0x2aad00(0x13d)]([_0x2aad00(0x16b),'payHupiSecret']),_0x13d8d6={};_0x13d8d6[_0x2aad00(0xcf)]=_0x2aad00(0xf5),_0x13d8d6[_0x2aad00(0xf7)]=_0x369ae7,_0x13d8d6[_0x2aad00(0x130)]=(Date[_0x2aad00(0xf2)]()/0x3e8)['toFixed'](0x0),_0x13d8d6['nonce_str']=(0x0,utils_1[_0x2aad00(0x164)])(0x20),_0x13d8d6[_0x2aad00(0x148)]=_0x34a3df,_0x13d8d6['hash']=this[_0x2aad00(0x13c)](_0x13d8d6,_0x20ffa6);const {data:{errcode:_0x67eb3b,errmsg:_0x35d44d,data:_0x3a5ffa}}=await axios_1[_0x2aad00(0x117)][_0x2aad00(0x15e)](_0x2aad00(0x127),_0x13d8d6);if(_0x67eb3b!=0x0)throw new common_1[(_0x2aad00(0xc8))](_0x35d44d,common_1['HttpStatus'][_0x2aad00(0x109)]);return _0x3a5ffa;}async[_0x5a7ea9(0x14a)](_0x4abc7b){const _0x1c5e12=_0x5a7ea9,_0x33b92d=_0x4abc7b[_0x1c5e12(0x13c)];delete _0x4abc7b[_0x1c5e12(0x13c)],delete _0x4abc7b['sign_type'];const _0x2dffa9=await this[_0x1c5e12(0xb1)][_0x1c5e12(0x13d)](['payEpaySecret']);if(this[_0x1c5e12(0x13c)](_0x4abc7b,_0x2dffa9)!=_0x33b92d)return _0x1c5e12(0x10b);console[_0x1c5e12(0x14c)]('校验签名通过');const _0x419f14=await this['orderEntity'][_0x1c5e12(0x14f)]({'where':{'orderId':_0x4abc7b[_0x1c5e12(0x174)],'status':0x0}});if(!_0x419f14)return'failed';const _0x43e4f9=_0x4abc7b[_0x1c5e12(0x11c)]==_0x1c5e12(0xc7)?0x1:0x2,_0x21def4=await this[_0x1c5e12(0xfd)]['update']({'orderId':_0x4abc7b[_0x1c5e12(0x174)]},{'status':_0x43e4f9,'paydAt':(0x0,date_1['default'])()[_0x1c5e12(0x172)]()});_0x43e4f9===0x1&&await this[_0x1c5e12(0xae)][_0x1c5e12(0xd8)](_0x419f14);if(_0x21def4[_0x1c5e12(0xec)]!=0x1)return _0x1c5e12(0x10b);return'success';}async['payEpay'](_0x31a633,_0x412e4e,_0x1b680a=_0x5a7ea9(0xd9)){const _0x3617de=_0x5a7ea9,_0x4ccc4d=await this[_0x3617de(0xfd)][_0x3617de(0x14f)]({'where':{'userId':_0x31a633,'orderId':_0x412e4e}});if(!_0x4ccc4d)throw new common_1[(_0x3617de(0xc8))](_0x3617de(0xd0),common_1[_0x3617de(0xe0)][_0x3617de(0x109)]);const _0x3c69ca=await this['cramiPackageEntity'][_0x3617de(0x14f)]({'where':{'id':_0x4ccc4d[_0x3617de(0x169)]}});if(!_0x3c69ca)throw new common_1[(_0x3617de(0xc8))](_0x3617de(0x160),common_1['HttpStatus'][_0x3617de(0x109)]);const {payEpayPid:_0x198af1,payEpaySecret:_0x35f923,payEpayNotifyUrl:_0x4a753f,payEpayReturnUrl:_0x378016,payEpayApiPayUrl:_0x281262}=await this[_0x3617de(0xb1)][_0x3617de(0x13d)]([_0x3617de(0x166),'payEpaySecret',_0x3617de(0xf3),'payEpayReturnUrl',_0x3617de(0x146)]);let _0x5b03ed;_0x198af1['length']<=0x10?_0x5b03ed=Number(_0x198af1):_0x5b03ed=BigInt(_0x198af1);const _0x282416={};_0x282416['pid']=_0x5b03ed,_0x282416[_0x3617de(0x14d)]=_0x1b680a,_0x282416['out_trade_no']=_0x412e4e,_0x282416[_0x3617de(0x156)]=_0x3c69ca[_0x3617de(0x156)],_0x282416[_0x3617de(0xe5)]=_0x4ccc4d[_0x3617de(0xb2)],_0x282416[_0x3617de(0x141)]=_0x3617de(0x134),_0x282416[_0x3617de(0x108)]='pc',_0x282416[_0x3617de(0x15b)]=_0x4a753f,_0x282416['return_url']=_0x378016,_0x282416[_0x3617de(0x12b)]=_0x3617de(0xcd),_0x282416[_0x3617de(0x13c)]=this[_0x3617de(0x13c)](_0x282416,_0x35f923),_0x282416[_0x3617de(0xe3)]=_0x3617de(0xd2);const _0x378bf7=new URLSearchParams(_0x282416)[_0x3617de(0x17b)](),_0x521162=_0x281262+'?'+_0x378bf7;if(_0x281262[_0x3617de(0xc0)](_0x3617de(0x139)))return{'url_qrcode':null,'redirectUrl':_0x521162,'channel':_0x1b680a,'isRedirect':!![]};else{const _0x41f425=await axios_1[_0x3617de(0x117)][_0x3617de(0x133)](_0x281262,{'params':_0x282416});console[_0x3617de(0x14c)](_0x3617de(0x149),_0x41f425[_0x3617de(0xfa)]);const {data:{code:_0x235027,msg:_0x18d3e3,qrcode:_0x51cf4d}}=_0x41f425;if(_0x235027!=0x1)throw new common_1[(_0x3617de(0xc8))](_0x18d3e3,common_1[_0x3617de(0xe0)][_0x3617de(0x109)]);return{'url_qrcode':_0x51cf4d,'redirectUrl':null,'channel':_0x1b680a,'isRedirect':![]};}}async[_0x5a7ea9(0x167)](_0x42ac9f){const _0x1026ae=_0x5a7ea9,{payEpayPid:_0x4a59d0,payEpaySecret:_0x1f21bc,payEpayApiQueryUrl:_0x3dfe44}=await this[_0x1026ae(0xb1)][_0x1026ae(0x13d)]([_0x1026ae(0x166),_0x1026ae(0x10a),_0x1026ae(0xb3)]),_0x2442e0={};_0x2442e0['act']='order',_0x2442e0[_0x1026ae(0x174)]=_0x42ac9f,_0x2442e0[_0x1026ae(0x15a)]=_0x4a59d0,_0x2442e0[_0x1026ae(0xdc)]=_0x1f21bc;const {data:{code:_0x501bc6,msg:_0x4a2983,data:_0x160e2f}}=await axios_1[_0x1026ae(0x117)][_0x1026ae(0x133)](_0x3dfe44,{'params':_0x2442e0});if(_0x501bc6!=0x1)throw new common_1['HttpException'](_0x4a2983,common_1[_0x1026ae(0xe0)][_0x1026ae(0x109)]);return _0x160e2f;}async[_0x5a7ea9(0x144)](_0x291f46){const _0x2ea8bb=_0x5a7ea9,_0x3d5607=_0x291f46[_0x2ea8bb(0x13c)];delete _0x291f46[_0x2ea8bb(0x13c)],delete _0x291f46['sign_type'];const _0x3a8385=await this[_0x2ea8bb(0xb1)][_0x2ea8bb(0x13d)]([_0x2ea8bb(0xfe)]);console['log'](_0x2ea8bb(0xb6));if(this[_0x2ea8bb(0x13c)](_0x291f46,_0x3a8385)!=_0x3d5607)return _0x2ea8bb(0x10b);console[_0x2ea8bb(0x14c)](_0x2ea8bb(0x103));const _0x46ff33=await this[_0x2ea8bb(0xfd)]['findOne']({'where':{'orderId':_0x291f46['out_trade_no'],'status':0x0}});if(!_0x46ff33)return _0x2ea8bb(0x10b);const _0x65b410=_0x291f46[_0x2ea8bb(0x11c)]=='TRADE_SUCCESS'?0x1:0x2;console[_0x2ea8bb(0x14c)](_0x2ea8bb(0x137),_0x65b410);const _0x3ceb59=await this[_0x2ea8bb(0xfd)][_0x2ea8bb(0x15f)]({'orderId':_0x291f46[_0x2ea8bb(0x174)]},{'status':_0x65b410,'paydAt':(0x0,date_1[_0x2ea8bb(0x117)])()[_0x2ea8bb(0x172)]()});_0x65b410===0x1&&await this[_0x2ea8bb(0xae)]['addBalanceToOrder'](_0x46ff33);if(_0x3ceb59['affected']!=0x1)return _0x2ea8bb(0x10b);return _0x2ea8bb(0x12e);}async[_0x5a7ea9(0xdd)](_0xd56ee4,_0xf5b1c1,_0x595d3b=_0x5a7ea9(0xc6)){const _0x1e9b19=_0x5a7ea9,_0x240899=await this['orderEntity'][_0x1e9b19(0x14f)]({'where':{'userId':_0xd56ee4,'orderId':_0xf5b1c1}});if(!_0x240899)throw new common_1[(_0x1e9b19(0xc8))](_0x1e9b19(0xd0),common_1[_0x1e9b19(0xe0)]['BAD_REQUEST']);const _0xd56136=await this['cramiPackageEntity'][_0x1e9b19(0x14f)]({'where':{'id':_0x240899[_0x1e9b19(0x169)]}});if(!_0xd56136)throw new common_1[(_0x1e9b19(0xc8))](_0x1e9b19(0x160),common_1[_0x1e9b19(0xe0)][_0x1e9b19(0x109)]);const {payMpayPid:_0x3a6f5b,payMpaySecret:_0x251ae0,payMpayNotifyUrl:_0x3b677d,payMpayReturnUrl:_0x36733a,payMpayApiPayUrl:_0xae17ce}=await this[_0x1e9b19(0xb1)][_0x1e9b19(0x13d)](['payMpayPid','payMpaySecret',_0x1e9b19(0x107),_0x1e9b19(0xd6),_0x1e9b19(0xb9)]),_0x37dd3a={};_0x37dd3a[_0x1e9b19(0x15a)]=Number(_0x3a6f5b),_0x37dd3a[_0x1e9b19(0x14d)]=_0x595d3b,_0x37dd3a[_0x1e9b19(0x174)]=_0xf5b1c1,_0x37dd3a[_0x1e9b19(0x156)]=_0xd56136[_0x1e9b19(0x156)],_0x37dd3a['money']=_0x240899[_0x1e9b19(0xb2)],_0x37dd3a[_0x1e9b19(0x15b)]=_0x3b677d,_0x37dd3a['return_url']=_0x36733a,_0x37dd3a['sign']=this[_0x1e9b19(0x13c)](_0x37dd3a,_0x251ae0),_0x37dd3a[_0x1e9b19(0xe3)]=_0x1e9b19(0xd2);const _0x23ab4d=new URLSearchParams(_0x37dd3a)[_0x1e9b19(0x17b)](),_0x1874ba=_0xae17ce+'?'+_0x23ab4d;return{'url_qrcode':null,'redirectUrl':_0x1874ba,'channel':_0x595d3b,'isRedirect':!![]};}async[_0x5a7ea9(0x100)](_0x45c521){const _0x22d471=_0x5a7ea9,{payMpayApiQueryUrl:_0x75a9b9}=await this[_0x22d471(0xb1)][_0x22d471(0x13d)]([_0x22d471(0x10f),_0x22d471(0xfe),_0x22d471(0xf9)]),_0x36bf88={};_0x36bf88['type']=0x2,_0x36bf88[_0x22d471(0x135)]=_0x45c521;const {data:{code:_0x935447,msg:_0x2f6750,data:_0x5a3ba1}}=await axios_1['default']['get'](_0x75a9b9,{'params':_0x36bf88});if(_0x935447!=0x1)throw new common_1[(_0x22d471(0xc8))](_0x2f6750,common_1['HttpStatus']['BAD_REQUEST']);return _0x5a3ba1;}async[_0x5a7ea9(0xc4)](_0x1cf121){const _0x1c0a46=_0x5a7ea9;console[_0x1c0a46(0x14c)]('微信支付通知params:\x20',_0x1cf121);const {payWeChatAppId:_0x452c88,payWeChatMchId:_0x44f5b1,payWeChatSecret:_0x416c96,payWeChatPublicKey:_0xd88425,payWeChatPrivateKey:_0x434729}=await this[_0x1c0a46(0xb1)][_0x1c0a46(0x13d)](['payWeChatAppId',_0x1c0a46(0x13f),_0x1c0a46(0x104),_0x1c0a46(0xad),'payWeChatPrivateKey']),_0x10de80=new WxPay({'appid':_0x452c88,'mchid':_0x44f5b1,'publicKey':_0xd88425,'privateKey':_0x434729});let _0x4c1a43;try{if(_0x1cf121[_0x1c0a46(0xf4)]==_0x1c0a46(0x12f)){const {ciphertext:_0x3a0f78,associated_data:_0x26ad59,nonce:_0x4e279b}=_0x1cf121['resource'],_0x47b901=_0x10de80[_0x1c0a46(0x111)](_0x3a0f78,_0x26ad59,_0x4e279b,_0x416c96),_0xc192ec=_0x47b901['out_trade_no'];_0x4c1a43=redisKey_constant_1[_0x1c0a46(0xde)]+_0xc192ec,await this[_0x1c0a46(0x14b)]['set']({'key':_0x4c1a43,'val':_0x1c0a46(0xc3)});const _0x4a794c=await this[_0x1c0a46(0xfd)][_0x1c0a46(0x14f)]({'where':{'orderId':_0xc192ec,'status':0x0}});if(!_0x4a794c)return'failed';if([0x1,0x2,0x3][_0x1c0a46(0xc0)](_0x4a794c[_0x1c0a46(0x113)]))return'success';const _0x4b2da3=await this[_0x1c0a46(0xb0)][_0x1c0a46(0x152)](async _0x2f95a3=>{const _0x40a9d8=_0x1c0a46,_0x4a0cf1=_0x47b901['trade_state']==_0x40a9d8(0xf6)?0x1:0x2,_0x20ccfa=await this[_0x40a9d8(0xfd)][_0x40a9d8(0x15f)]({'orderId':_0xc192ec},{'status':_0x4a0cf1,'paydAt':(0x0,date_1[_0x40a9d8(0x117)])()[_0x40a9d8(0x172)](),'tradeId':_0x47b901[_0x40a9d8(0x16e)]});return _0x4a0cf1===0x1&&await this[_0x40a9d8(0xae)][_0x40a9d8(0xd8)](_0x4a794c),_0x20ccfa;});if(_0x4b2da3[_0x1c0a46(0xec)]!=0x1)return'failed';}return _0x1c0a46(0x12e);}catch(_0x5b48d3){return console[_0x1c0a46(0x14c)](_0x1c0a46(0xd7),_0x5b48d3),console[_0x1c0a46(0x14c)]('支付通知验证失败:\x20',_0x5b48d3),_0x1c0a46(0x10b);}finally{_0x4c1a43&&await this[_0x1c0a46(0x14b)]['del']({'key':_0x4c1a43});}}async[_0x5a7ea9(0x136)](_0x1cd4b9,_0x491147,_0x40273d){const _0x57ef61=_0x5a7ea9,_0x1f6c9f=await this[_0x57ef61(0xfd)]['findOne']({'where':{'userId':_0x1cd4b9,'orderId':_0x491147}});if(!_0x1f6c9f)throw new common_1[(_0x57ef61(0xc8))]('订单不存在!',common_1[_0x57ef61(0xe0)][_0x57ef61(0x109)]);const _0x7bf736=await this[_0x57ef61(0x11e)][_0x57ef61(0x14f)]({'where':{'id':_0x1f6c9f['goodsId']}});if(!_0x7bf736)throw new common_1['HttpException'](_0x57ef61(0x160),common_1[_0x57ef61(0xe0)]['BAD_REQUEST']);const _0x1b34a1={'bizContent':{'out_trade_no':_0x491147,'total_amount':_0x1f6c9f[_0x57ef61(0xb2)],'subject':_0x7bf736[_0x57ef61(0x156)]}};let _0xd2d3c5,_0x55768b,_0x589552,_0x4d3f51,_0x2fecf8;const {payAliPublicSecret:_0x2341ed,payAliWebAppId:_0x14a8ae,payAliWebSecret:_0x53a829,payAliAppAppId:_0x4c206f,payAliAppSecret:_0x521bb4,payWeChatNotifyUrl:_0x17c9fe}=await this[_0x57ef61(0xb1)][_0x57ef61(0x13d)]([_0x57ef61(0xe7),_0x57ef61(0xbe),_0x57ef61(0x147),_0x57ef61(0x159),'payAliAppSecret',_0x57ef61(0xbf)]);_0x40273d===_0x57ef61(0x150)&&(_0x1b34a1[_0x57ef61(0xe8)]='POST',_0xd2d3c5=_0x14a8ae,_0x589552='pageExec',_0x55768b=_0x53a829,_0x4d3f51='alipay.trade.page.pay',_0x2fecf8=_0x57ef61(0x12d));_0x40273d==='app'&&(_0x589552=_0x57ef61(0x120),_0xd2d3c5=_0x4c206f,_0x55768b=_0x521bb4,_0x4d3f51='alipay.trade.app.pay',_0x2fecf8='QUICK_MSECURITY_PAY');const _0x235d98=new AlipaySdk({'appId':_0xd2d3c5,'keyType':_0x57ef61(0xf0),'privateKey':_0x55768b,'alipayPublicKey':_0x2341ed});_0x1b34a1['setNotifyUrl']=_0x17c9fe,_0x1b34a1[_0x57ef61(0x153)]['product_code']=_0x2fecf8;const _0x5e91eb=await _0x235d98[_0x589552](_0x4d3f51,_0x1b34a1);return console['log'](_0x57ef61(0x121),_0x5e91eb),_0x40273d===_0x57ef61(0x150)?{'form':_0x5e91eb}:{'data':_0x5e91eb};}async['queryAliPay'](_0x199667,_0x1bfd48){const _0x4d0f07=_0x5a7ea9;let _0x2a74a0,_0x3beee9;const {payAliPublicSecret:_0x470848,payAliWebAppId:_0x15d4d0,payAliWebSecret:_0x4c5041,payAliAppAppId:_0x52c0b9,payAliAppSecret:_0x179f93,payWeChatNotifyUrl:_0xa40173}=await this[_0x4d0f07(0xb1)][_0x4d0f07(0x13d)](['payAliPublicSecret',_0x4d0f07(0xbe),'payAliWebSecret',_0x4d0f07(0x159),_0x4d0f07(0x161),'payWeChatNotifyUrl']);_0x1bfd48===_0x4d0f07(0x150)&&(_0x2a74a0=_0x15d4d0,_0x3beee9=_0x4c5041);_0x1bfd48===_0x4d0f07(0x178)&&(_0x2a74a0=_0x52c0b9,_0x3beee9=_0x179f93);const _0x5b284c=new AlipaySdk({'appId':_0x2a74a0,'keyType':_0x4d0f07(0xf0),'privateKey':_0x3beee9,'alipayPublicKey':_0x470848}),_0x563d65=await _0x5b284c['exec'](_0x4d0f07(0x124),{'bizContent':{'out_trade_no':_0x199667}});return console[_0x4d0f07(0x14c)](_0x563d65),_0x563d65;}async[_0x5a7ea9(0x179)](_0x15111a,_0x3183ba,_0xb9fe9b=_0x5a7ea9(0x150)){const _0x4aafda=_0x5a7ea9;console[_0x4aafda(0x14c)](_0x4aafda(0xc2),_0xb9fe9b);const _0x400146=await this[_0x4aafda(0xfd)][_0x4aafda(0x14f)]({'where':{'userId':_0x15111a,'orderId':_0x3183ba}});if(!_0x400146)throw new common_1['HttpException'](_0x4aafda(0xd0),common_1['HttpStatus'][_0x4aafda(0x109)]);const _0x4378d5=await this[_0x4aafda(0x11e)][_0x4aafda(0x14f)]({'where':{'id':_0x400146[_0x4aafda(0x169)]}});if(!_0x4378d5)throw new common_1[(_0x4aafda(0xc8))]('套餐不存在!',common_1[_0x4aafda(0xe0)][_0x4aafda(0x109)]);const {payWeChatAppId:_0x3a917b,payWeMiniAppId:_0x4d328b,payWeChatMchId:_0x4d2ffb,payWeChatPublicKey:_0x4f25c5,payWeChatPrivateKey:_0x311438,payWeChatNotifyUrl:_0x2235eb,payWeChatH5Name:_0x20df60,payWeChatH5Url:_0x7f57e9,WE_APP_APPID:_0x493be3,WE_APP_APPSECRET:_0x2ccfda}=await this[_0x4aafda(0xb1)][_0x4aafda(0x13d)]([_0x4aafda(0x122),'payWeMiniAppId',_0x4aafda(0x13f),_0x4aafda(0xad),_0x4aafda(0x112),'payWeChatNotifyUrl','payWeChatH5Name',_0x4aafda(0xe4),_0x4aafda(0x115)]),_0x5b2cf4=new WxPay({'appid':_0xb9fe9b===_0x4aafda(0x157)?_0x4d328b:_0x3a917b,'mchid':_0x4d2ffb,'publicKey':_0x4f25c5,'privateKey':_0x311438}),_0x3a93b3={'appid':_0xb9fe9b==='mini'?_0x4d328b:_0x3a917b,'mchid':_0x4d2ffb,'description':_0x4378d5[_0x4aafda(0x156)],'out_trade_no':_0x3183ba,'notify_url':_0x2235eb,'amount':{'total':Number(_0x400146[_0x4aafda(0xb2)]*0x64)},'scene_info':{'payer_client_ip':_0x4aafda(0x134)}};console[_0x4aafda(0x14c)](_0x4aafda(0xb8),_0x3a93b3);if(_0xb9fe9b=='h5'){_0x3a93b3['scene_info'][_0x4aafda(0xb4)]={'type':_0x4aafda(0x12a),'app_name':_0x20df60,'app_url':_0x7f57e9};const _0x1149e1=await _0x5b2cf4['transactions_h5'](_0x3a93b3);if(_0x1149e1[_0x4aafda(0x113)]===0x193){const _0x2fa273=_0x1149e1?.['errRaw']?.[_0x4aafda(0xeb)]?.['text']?.[_0x4aafda(0x11b)];throw new common_1['HttpException'](_0x1149e1?.['message']||_0x4aafda(0x170),common_1[_0x4aafda(0xe0)]['BAD_REQUEST']);}const {h5_url:_0x256352}=_0x1149e1;return{'url':_0x256352};}if(_0xb9fe9b==='app'){_0x3a93b3[_0x4aafda(0xf7)]=_0x493be3;const _0x35b35f=await _0x5b2cf4[_0x4aafda(0x155)](_0x3a93b3);return console['log']('App支付结果返回值:\x20',_0x35b35f),_0x35b35f;}if(_0xb9fe9b=='mini'){const _0x2f1828=await this[_0x4aafda(0xc1)][_0x4aafda(0x110)](_0x15111a);_0x3a93b3['payer']={'openid':_0x2f1828};const _0x1b99f3=await _0x5b2cf4['transactions_jsapi'](_0x3a93b3);return console[_0x4aafda(0x14c)](_0x4aafda(0xdb),_0x1b99f3),_0x1b99f3;}if(_0xb9fe9b=='jsapi'){const _0x58f66d=await this['userService'][_0x4aafda(0x126)](_0x15111a);console[_0x4aafda(0x14c)](_0x4aafda(0x162),_0x58f66d),_0x3a93b3[_0x4aafda(0xdf)]={'openid':_0x58f66d};const _0x283cb5=await _0x5b2cf4[_0x4aafda(0x17a)](_0x3a93b3);return console[_0x4aafda(0x14c)](_0x4aafda(0xdb),_0x283cb5),_0x283cb5;}if(_0xb9fe9b=='native'){const _0x2ab546=await _0x5b2cf4['transactions_native'](_0x3a93b3),{code_url:_0x456d69}=_0x2ab546;return!_0x456d69&&console['log'](_0x4aafda(0xf1),_0x2ab546),{'url_qrcode':_0x456d69,'isRedirect':![]};}throw new common_1[(_0x4aafda(0xc8))]('unsupported\x20pay\x20type',common_1[_0x4aafda(0xe0)][_0x4aafda(0x109)]);}async[_0x5a7ea9(0x129)](_0x31f194,_0x48b0cb){const _0x5dc0d5=_0x5a7ea9,{payWeChatAppId:_0x18e4b3,payWeMiniAppId:_0x1a1f89,payWeChatMchId:_0x2efeec,payWeChatPublicKey:_0x43b892,payWeChatPrivateKey:_0x1656af}=await this[_0x5dc0d5(0xb1)][_0x5dc0d5(0x13d)]([_0x5dc0d5(0x122),_0x5dc0d5(0x143),'payWeChatMchId',_0x5dc0d5(0xad),_0x5dc0d5(0x112)]),_0x476aee=new WxPay({'appid':_0x48b0cb==='mini'?_0x1a1f89:_0x18e4b3,'mchid':_0x2efeec,'publicKey':_0x43b892,'privateKey':_0x1656af}),_0xab138f=await _0x476aee[_0x5dc0d5(0x177)]({'out_trade_no':_0x31f194});return _0xab138f;}async[_0x5a7ea9(0x11d)](_0x1c773d){const _0x2a7f3b=_0x5a7ea9;_0x1c773d[_0x2a7f3b(0x13e)]===_0x2a7f3b(0x176)&&await this[_0x2a7f3b(0xe9)](_0x1c773d);}async['cancelWxOrder'](_0x316959){const _0x2302d7=_0x5a7ea9,{payWeChatAppId:_0x28c1ff,payWeMiniAppId:_0x488b32,payWeChatMchId:_0x50978d,payWeChatPublicKey:_0x32c104,payWeChatPrivateKey:_0x4e84c3}=await this[_0x2302d7(0xb1)][_0x2302d7(0x13d)]([_0x2302d7(0x122),_0x2302d7(0x143),'payWeChatMchId','payWeChatPublicKey','payWeChatPrivateKey',_0x2302d7(0xbf),_0x2302d7(0xce),_0x2302d7(0xe4)]),_0x9f7ab5=new WxPay({'appid':_0x316959['channel']==='mini'?_0x488b32:_0x28c1ff,'mchid':_0x50978d,'publicKey':_0x32c104,'privateKey':_0x4e84c3});await _0x9f7ab5[_0x2302d7(0xfb)](_0x316959[_0x2302d7(0xbd)]);}['sign'](_0x4e6a36,_0x504ffc){const _0x4c4d8f=_0x5a7ea9,_0xb4e9d7=Object[_0x4c4d8f(0x102)](_0x4e6a36)[_0x4c4d8f(0x15d)]()[_0x4c4d8f(0xc5)](_0x2d5e6d=>_0x2d5e6d+'='+_0x4e6a36[_0x2d5e6d])[_0x4c4d8f(0x10c)]('&')+_0x504ffc;return crypto[_0x4c4d8f(0x125)](_0x4c4d8f(0xda))[_0x4c4d8f(0x15f)](_0xb4e9d7)[_0x4c4d8f(0xf8)](_0x4c4d8f(0x13b));}};PayService=__decorate([(0x0,common_1[_0x5a7ea9(0xca)])(),__param(0x0,(0x0,typeorm_1[_0x5a7ea9(0x105)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x5a7ea9(0x105)])(order_entity_1[_0x5a7ea9(0x15c)])),__metadata(_0x5a7ea9(0xff),[typeorm_2[_0x5a7ea9(0xcb)],typeorm_2[_0x5a7ea9(0xcb)],userBalance_service_1[_0x5a7ea9(0x131)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x5a7ea9(0x16c)],redisCache_service_1[_0x5a7ea9(0x114)],typeorm_2[_0x5a7ea9(0x171)]])],PayService),exports[_0x5a7ea9(0xfc)]=PayService;