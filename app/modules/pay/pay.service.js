'use strict';function _0x3218(_0x2e91b7,_0x375db1){const _0x5c6a7c=_0x5c6a();return _0x3218=function(_0x3218c3,_0x367345){_0x3218c3=_0x3218c3-0xe3;let _0x5ba050=_0x5c6a7c[_0x3218c3];return _0x5ba050;},_0x3218(_0x2e91b7,_0x375db1);}const _0xde2dfc=_0x3218;(function(_0x23ca33,_0x5d5897){const _0x546de8=_0x3218,_0x1f40ba=_0x23ca33();while(!![]){try{const _0x376e11=-parseInt(_0x546de8(0xf0))/0x1+parseInt(_0x546de8(0x18d))/0x2+parseInt(_0x546de8(0x183))/0x3+parseInt(_0x546de8(0x18e))/0x4*(parseInt(_0x546de8(0x179))/0x5)+parseInt(_0x546de8(0x109))/0x6*(parseInt(_0x546de8(0x141))/0x7)+parseInt(_0x546de8(0x160))/0x8*(-parseInt(_0x546de8(0x199))/0x9)+parseInt(_0x546de8(0x133))/0xa*(-parseInt(_0x546de8(0x14c))/0xb);if(_0x376e11===_0x5d5897)break;else _0x1f40ba['push'](_0x1f40ba['shift']());}catch(_0x83e83c){_0x1f40ba['push'](_0x1f40ba['shift']());}}}(_0x5c6a,0xc2aea));function _0x5c6a(){const _0x47a547=['unsupported\x20pay\x20type','Injectable','response','type','md5','scene_info','payEpaySecret','product_code','payAliAppSecret','支付通知验证失败:\x20','6264fTusja','Connection','notifyMpay','hash','addBalanceToOrder','transactions_h5','payMpayApiPayUrl','total','@nestjs/common','sign_type','update','payAli','appid','__esModule','log','jsapi','WE_APP_APPID','toFixed','payWeChatPublicKey','UserService','queryWeChat','PKCS1','UserBalanceService','../userBalance/userBalance.service','close','exec','app','套餐不存在!','App支付结果返回值:\x20','defineProperty','alipay.trade.page.pay','alipay-sdk','money','channel','method','getOwnPropertyDescriptor','transactions_app','total_fee','crypto','out_trade_no','version','trade_order_id','40wgSCfh','globalConfigService','1.1','length','用户openId:\x20','success','sdkExec','订单不存在!','queryMpay','HttpStatus','affected','query','hex','alipay.trade.query','4543BiTzzn','includes','decorate','text','../crami/cramiPackage.entity','校验签名通过','payEpayPid','payAliAppAppId','name','Wap','sign','5232029NIhwnX','payEpay','queryHupi','map','payWeChatAppId','attach','redisCacheService','本次支付类型:\x20','__decorate','transaction_id','GlobalConfigService','findOne','epay','userBalanceService','notify_url','status','setNotifyUrl','payMpay','payMpaySecret','payHupiReturnUrl','8pCZliv','payMpayApiQueryUrl','微信支付通知params:\x20','mpay','event_type','goodsId','payMpayPid','param','transactions_native','native','failed','payWeChatH5Name','../../common/utils','MD5','pid','../order/order.entity','Repository','__param','@nestjs/typeorm','BAD_REQUEST','userService','payType:\x20','createRandomNonceStr','toString','order_no','745djOHIy','alipay','payAliPublicSecret','mini','CramiPackageEntity','PayService','payHupiAppId','object','queryAliPay','metadata','3808347HiQTcP','h5_info','toDate','payHupiSecret','payHupi','payMpayReturnUrl','message','errRaw','sort','payWeChatNotifyUrl','1801784SBAdJi','37896yBnHRG','payWeChatPrivateKey','payHupiGatewayUrl','payer','wechat','支付请求失败:\x20','payWeChatH5Url','now','InjectRepository','pageExec','function','10063377JMwaUn','notifyHupi','transactions_jsapi','set','lock','hupi','payEpayApiPayUrl','order','payAliWebAppId','connection','title','alipay.trade.app.pay','https://api.xunhupay.com/payment/do.html','TRADE_SUCCESS','device','../../common/utils/date','time','../redisCache/redisCache.service','OrderEntity','cramiPackageEntity','onModuleInit','cancelWxOrder','orderEntity','payPlatform','trade_state','payWeMiniAppId','notifyEpay','POST','status:\x20','keys','wechat-pay:\x20','notifyWeChat','getConfigByKeys','payAliWebSecret','clientip','HttpException','get','payWeChatSecret','return_url','支付请求失败!','../globalConfig/globalConfig.service','typeorm','441396MbpiVG','__metadata','act','payWeChatMchId','nonce_str','payWeChat','jsapi支付结果返回值:\x20','default','payHupiNotifyUrl','SUCCESS','queryEpay','cancel','wechatpay-node-v3','TRANSACTION.SUCCESS','payEpayApiQueryUrl'];_0x5c6a=function(){return _0x47a547;};return _0x5c6a();}var __decorate=this&&this[_0xde2dfc(0x154)]||function(_0xc043,_0x4c483c,_0x4aa264,_0x5e05a9){const _0x3504dc=_0xde2dfc;var _0x44223b=arguments[_0x3504dc(0x136)],_0x58dfc9=_0x44223b<0x3?_0x4c483c:_0x5e05a9===null?_0x5e05a9=Object[_0x3504dc(0x12c)](_0x4c483c,_0x4aa264):_0x5e05a9,_0x5db6c2;if(typeof Reflect==='object'&&typeof Reflect[_0x3504dc(0x143)]===_0x3504dc(0x198))_0x58dfc9=Reflect[_0x3504dc(0x143)](_0xc043,_0x4c483c,_0x4aa264,_0x5e05a9);else{for(var _0x3a0184=_0xc043['length']-0x1;_0x3a0184>=0x0;_0x3a0184--)if(_0x5db6c2=_0xc043[_0x3a0184])_0x58dfc9=(_0x44223b<0x3?_0x5db6c2(_0x58dfc9):_0x44223b>0x3?_0x5db6c2(_0x4c483c,_0x4aa264,_0x58dfc9):_0x5db6c2(_0x4c483c,_0x4aa264))||_0x58dfc9;}return _0x44223b>0x3&&_0x58dfc9&&Object[_0x3504dc(0x126)](_0x4c483c,_0x4aa264,_0x58dfc9),_0x58dfc9;},__metadata=this&&this[_0xde2dfc(0xf1)]||function(_0x51bcf5,_0x19d1a9){const _0x17d7cd=_0xde2dfc;if(typeof Reflect===_0x17d7cd(0x180)&&typeof Reflect['metadata']==='function')return Reflect[_0x17d7cd(0x182)](_0x51bcf5,_0x19d1a9);},__param=this&&this[_0xde2dfc(0x171)]||function(_0x596cd9,_0x139a28){return function(_0x560cdd,_0x1b7fc6){_0x139a28(_0x560cdd,_0x1b7fc6,_0x596cd9);};};Object[_0xde2dfc(0x126)](exports,_0xde2dfc(0x116),{'value':!![]}),exports[_0xde2dfc(0x17e)]=void 0x0;const typeorm_1=require(_0xde2dfc(0x172)),typeorm_2=require(_0xde2dfc(0xef)),common_1=require(_0xde2dfc(0x111)),crypto=require(_0xde2dfc(0x12f)),axios_1=require('axios'),order_entity_1=require(_0xde2dfc(0x16f)),cramiPackage_entity_1=require(_0xde2dfc(0x145)),userBalance_service_1=require(_0xde2dfc(0x120)),globalConfig_service_1=require(_0xde2dfc(0xee)),utils_1=require(_0xde2dfc(0x16c)),user_service_1=require('../user/user.service'),redisCache_service_1=require(_0xde2dfc(0x1aa)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),date_1=require(_0xde2dfc(0x1a8)),WxPay=require(_0xde2dfc(0xfc)),AlipaySdk=require(_0xde2dfc(0x128));let PayService=class PayService{constructor(_0x445e98,_0x1dd810,_0x4922e9,_0x40c088,_0x1c089c,_0x2703f5,_0x24a492){const _0x1a7e97=_0xde2dfc;this['cramiPackageEntity']=_0x445e98,this[_0x1a7e97(0x1af)]=_0x1dd810,this['userBalanceService']=_0x4922e9,this['globalConfigService']=_0x40c088,this[_0x1a7e97(0x174)]=_0x1c089c,this[_0x1a7e97(0x152)]=_0x2703f5,this[_0x1a7e97(0x1a2)]=_0x24a492;}async[_0xde2dfc(0x1ad)](){}async['notify'](_0x3fba3d){const _0x5b1776=_0xde2dfc;if(_0x3fba3d[_0x5b1776(0x167)]==_0x5b1776(0x158))return this[_0x5b1776(0x1b3)](_0x3fba3d);if(_0x3fba3d[_0x5b1776(0x151)]=='hupi')return this[_0x5b1776(0x19a)](_0x3fba3d);if(typeof _0x3fba3d['resource']=='object')return this['notifyWeChat'](_0x3fba3d);return this[_0x5b1776(0x10b)](_0x3fba3d);}async['pay'](_0x29af3a,_0x5ba7cb,_0x4241fb='wxpay'){const _0x1daa35=_0xde2dfc,_0xb4d06b=await this[_0x1daa35(0x1af)][_0x1daa35(0x157)]({'where':{'userId':_0x29af3a,'orderId':_0x5ba7cb}});if(!_0xb4d06b)throw new common_1[(_0x1daa35(0xe9))](_0x1daa35(0x13a),common_1[_0x1daa35(0x13c)][_0x1daa35(0x173)]);const _0x209cc5=await this[_0x1daa35(0x1ac)][_0x1daa35(0x157)]({'where':{'id':_0xb4d06b[_0x1daa35(0x165)]}});if(!_0x209cc5)throw new common_1[(_0x1daa35(0xe9))](_0x1daa35(0x124),common_1['HttpStatus'][_0x1daa35(0x173)]);console['log'](_0x1daa35(0x153),_0xb4d06b[_0x1daa35(0x1b0)]);try{if(_0xb4d06b['payPlatform']==_0x1daa35(0x17a))return this['payAli'](_0x29af3a,_0x5ba7cb,_0x4241fb);if(_0xb4d06b['payPlatform']==_0x1daa35(0x192))return this['payWeChat'](_0x29af3a,_0x5ba7cb,_0x4241fb);if(_0xb4d06b[_0x1daa35(0x1b0)]=='epay')return this['payEpay'](_0x29af3a,_0x5ba7cb,_0x4241fb);if(_0xb4d06b[_0x1daa35(0x1b0)]==_0x1daa35(0x163))return this[_0x1daa35(0x15d)](_0x29af3a,_0x5ba7cb,_0x4241fb);if(_0xb4d06b[_0x1daa35(0x1b0)]==_0x1daa35(0x19e))return this['payHupi'](_0x29af3a,_0x5ba7cb,_0x4241fb);}catch(_0x43ff39){console[_0x1daa35(0x117)](_0x1daa35(0x193),_0x43ff39);throw new common_1[(_0x1daa35(0xe9))](_0x1daa35(0xed),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xde2dfc(0x13e)](_0x10510f){const _0xc6d149=_0xde2dfc,_0x191062=await this[_0xc6d149(0x1af)]['findOne']({'where':{'orderId':_0x10510f}});if(!_0x191062)throw new common_1['HttpException'](_0xc6d149(0x13a),common_1[_0xc6d149(0x13c)][_0xc6d149(0x173)]);return _0x191062;}async[_0xde2dfc(0x19a)](_0x1865c6){const _0x4b42e1=_0xde2dfc,_0x396db6=await this[_0x4b42e1(0x134)][_0x4b42e1(0xe6)]([_0x4b42e1(0x186)]),_0x2dad5d=_0x1865c6[_0x4b42e1(0x10c)];delete _0x1865c6[_0x4b42e1(0x10c)];if(this['sign'](_0x1865c6,_0x396db6)!=_0x2dad5d)return _0x4b42e1(0x16a);const _0x2631f0=await this[_0x4b42e1(0x1af)][_0x4b42e1(0x157)]({'where':{'orderId':_0x1865c6[_0x4b42e1(0x132)],'status':0x0}});if(!_0x2631f0)return'failed';await this[_0x4b42e1(0x159)][_0x4b42e1(0x10d)](_0x2631f0);const _0x20016c=await this[_0x4b42e1(0x1af)][_0x4b42e1(0x113)]({'orderId':_0x1865c6[_0x4b42e1(0x132)]},{'status':0x1,'paydAt':(0x0,date_1['default'])()[_0x4b42e1(0x185)]()});if(_0x20016c[_0x4b42e1(0x13d)]!=0x1)return _0x4b42e1(0x16a);return _0x4b42e1(0x138);}async[_0xde2dfc(0x187)](_0x15cc43,_0x1590bb,_0x3196d2='wxpay'){const _0xe51497=_0xde2dfc,_0x5935c0=await this['orderEntity'][_0xe51497(0x157)]({'where':{'userId':_0x15cc43,'orderId':_0x1590bb}});if(!_0x5935c0)throw new common_1['HttpException'](_0xe51497(0x13a),common_1['HttpStatus'][_0xe51497(0x173)]);const _0x193d65=await this[_0xe51497(0x1ac)]['findOne']({'where':{'id':_0x5935c0[_0xe51497(0x165)]}});if(!_0x193d65)throw new common_1['HttpException'](_0xe51497(0x124),common_1[_0xe51497(0x13c)][_0xe51497(0x173)]);const {payHupiAppId:_0x155e5f,payHupiSecret:_0x1e2363,payHupiNotifyUrl:_0x5044e0,payHupiReturnUrl:_0x2b6eed,payHupiGatewayUrl:_0x126b4b}=await this[_0xe51497(0x134)]['getConfigByKeys']([_0xe51497(0x17f),_0xe51497(0x186),_0xe51497(0xf8),_0xe51497(0x15f),_0xe51497(0x190)]),_0x3bb679={};_0x3bb679['version']=_0xe51497(0x135),_0x3bb679[_0xe51497(0x115)]=_0x155e5f,_0x3bb679['time']=(Date[_0xe51497(0x195)]()/0x3e8)[_0xe51497(0x11a)](0x0),_0x3bb679[_0xe51497(0xf4)]=(0x0,utils_1[_0xe51497(0x176)])(0x20),_0x3bb679[_0xe51497(0x132)]=_0x1590bb,_0x3bb679[_0xe51497(0x1a3)]=_0x193d65[_0xe51497(0x149)],_0x3bb679[_0xe51497(0x12e)]=_0x5935c0[_0xe51497(0x110)],_0x3bb679[_0xe51497(0x15a)]=_0x5044e0,_0x3bb679[_0xe51497(0xec)]=_0x2b6eed,_0x3bb679[_0xe51497(0x151)]=_0xe51497(0x19e),_0x3bb679[_0xe51497(0x10c)]=this[_0xe51497(0x14b)](_0x3bb679,_0x1e2363);const {data:{errcode:_0x4f2cee,errmsg:_0x5135b2,url_qrcode:_0x2d14c1,url:_0x1ba70e}}=await axios_1[_0xe51497(0xf7)]['post'](_0x126b4b||_0xe51497(0x1a5),_0x3bb679);if(_0x4f2cee!=0x0)throw new common_1[(_0xe51497(0xe9))](_0x5135b2,common_1[_0xe51497(0x13c)][_0xe51497(0x173)]);return{'url_qrcode':_0x2d14c1,'url':_0x1ba70e};}async[_0xde2dfc(0x14e)](_0x4223e2){const _0x504003=_0xde2dfc,{payHupiAppId:_0x50e965,payHupiSecret:_0xecb228}=await this[_0x504003(0x134)][_0x504003(0xe6)]([_0x504003(0x17f),_0x504003(0x186)]),_0xbbb7b0={};_0xbbb7b0[_0x504003(0x131)]=_0x504003(0x135),_0xbbb7b0[_0x504003(0x115)]=_0x50e965,_0xbbb7b0[_0x504003(0x1a9)]=(Date[_0x504003(0x195)]()/0x3e8)[_0x504003(0x11a)](0x0),_0xbbb7b0[_0x504003(0xf4)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0xbbb7b0['out_trade_order']=_0x4223e2,_0xbbb7b0[_0x504003(0x10c)]=this[_0x504003(0x14b)](_0xbbb7b0,_0xecb228);const {data:{errcode:_0x1aeaab,errmsg:_0x5884d7,data:_0x3f63bc}}=await axios_1[_0x504003(0xf7)]['post']('https://api.xunhupay.com/payment/query.html',_0xbbb7b0);if(_0x1aeaab!=0x0)throw new common_1[(_0x504003(0xe9))](_0x5884d7,common_1['HttpStatus'][_0x504003(0x173)]);return _0x3f63bc;}async[_0xde2dfc(0x1b3)](_0x2c58b8){const _0x591af7=_0xde2dfc,_0x37a9d0=_0x2c58b8[_0x591af7(0x14b)];delete _0x2c58b8[_0x591af7(0x14b)],delete _0x2c58b8[_0x591af7(0x112)];const _0x42c5fc=await this[_0x591af7(0x134)][_0x591af7(0xe6)]([_0x591af7(0x105)]);if(this['sign'](_0x2c58b8,_0x42c5fc)!=_0x37a9d0)return _0x591af7(0x16a);console[_0x591af7(0x117)](_0x591af7(0x146));const _0x5e6240=await this[_0x591af7(0x1af)]['findOne']({'where':{'orderId':_0x2c58b8[_0x591af7(0x130)],'status':0x0}});if(!_0x5e6240)return _0x591af7(0x16a);const _0x14b648=_0x2c58b8['trade_status']==_0x591af7(0x1a6)?0x1:0x2,_0x426375=await this['orderEntity'][_0x591af7(0x113)]({'orderId':_0x2c58b8[_0x591af7(0x130)]},{'status':_0x14b648,'paydAt':(0x0,date_1[_0x591af7(0xf7)])()[_0x591af7(0x185)]()});_0x14b648===0x1&&await this[_0x591af7(0x159)][_0x591af7(0x10d)](_0x5e6240);if(_0x426375[_0x591af7(0x13d)]!=0x1)return _0x591af7(0x16a);return _0x591af7(0x138);}async[_0xde2dfc(0x14d)](_0x301a78,_0x553199,_0x483e2e=_0xde2dfc(0x17a)){const _0x52ace2=_0xde2dfc,_0xb4897f=await this[_0x52ace2(0x1af)]['findOne']({'where':{'userId':_0x301a78,'orderId':_0x553199}});if(!_0xb4897f)throw new common_1[(_0x52ace2(0xe9))](_0x52ace2(0x13a),common_1[_0x52ace2(0x13c)][_0x52ace2(0x173)]);const _0x396a39=await this[_0x52ace2(0x1ac)][_0x52ace2(0x157)]({'where':{'id':_0xb4897f['goodsId']}});if(!_0x396a39)throw new common_1[(_0x52ace2(0xe9))](_0x52ace2(0x124),common_1[_0x52ace2(0x13c)]['BAD_REQUEST']);const {payEpayPid:_0x2c8e63,payEpaySecret:_0x2c0dd3,payEpayNotifyUrl:_0x117f84,payEpayReturnUrl:_0x1ea046,payEpayApiPayUrl:_0x96bf78}=await this[_0x52ace2(0x134)][_0x52ace2(0xe6)](['payEpayPid','payEpaySecret','payEpayNotifyUrl','payEpayReturnUrl',_0x52ace2(0x19f)]);let _0x4831bc;_0x2c8e63[_0x52ace2(0x136)]<=0x10?_0x4831bc=Number(_0x2c8e63):_0x4831bc=BigInt(_0x2c8e63);const _0x2e3d5d={};_0x2e3d5d[_0x52ace2(0x16e)]=_0x4831bc,_0x2e3d5d['type']=_0x483e2e,_0x2e3d5d[_0x52ace2(0x130)]=_0x553199,_0x2e3d5d[_0x52ace2(0x149)]=_0x396a39[_0x52ace2(0x149)],_0x2e3d5d[_0x52ace2(0x129)]=_0xb4897f[_0x52ace2(0x110)],_0x2e3d5d[_0x52ace2(0xe8)]='192.168.1.100',_0x2e3d5d[_0x52ace2(0x1a7)]='pc',_0x2e3d5d['notify_url']=_0x117f84,_0x2e3d5d[_0x52ace2(0xec)]=_0x1ea046,_0x2e3d5d[_0x52ace2(0x167)]='epay',_0x2e3d5d[_0x52ace2(0x14b)]=this[_0x52ace2(0x14b)](_0x2e3d5d,_0x2c0dd3),_0x2e3d5d[_0x52ace2(0x112)]=_0x52ace2(0x16d);const _0x232d54=new URLSearchParams(_0x2e3d5d)['toString'](),_0x347941=_0x96bf78+'?'+_0x232d54;if(_0x96bf78[_0x52ace2(0x142)]('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x347941,'channel':_0x483e2e,'isRedirect':!![]};else{const _0x15a6c3=await axios_1[_0x52ace2(0xf7)]['get'](_0x96bf78,{'params':_0x2e3d5d});console['log']('epay\x20--->\x20res:\x20',_0x15a6c3['data']);const {data:{code:_0x4e80f2,msg:_0x5e9da8,qrcode:_0x581cd1}}=_0x15a6c3;if(_0x4e80f2!=0x1)throw new common_1[(_0x52ace2(0xe9))](_0x5e9da8,common_1[_0x52ace2(0x13c)][_0x52ace2(0x173)]);return{'url_qrcode':_0x581cd1,'redirectUrl':null,'channel':_0x483e2e,'isRedirect':![]};}}async[_0xde2dfc(0xfa)](_0x55e82d){const _0x3e5a57=_0xde2dfc,{payEpayPid:_0x3203a3,payEpaySecret:_0x2b91cf,payEpayApiQueryUrl:_0x25dff2}=await this[_0x3e5a57(0x134)][_0x3e5a57(0xe6)]([_0x3e5a57(0x147),'payEpaySecret',_0x3e5a57(0xfe)]),_0x2771ad={};_0x2771ad[_0x3e5a57(0xf2)]=_0x3e5a57(0x1a0),_0x2771ad['out_trade_no']=_0x55e82d,_0x2771ad['pid']=_0x3203a3,_0x2771ad['key']=_0x2b91cf;const {data:{code:_0xee9206,msg:_0x46a17c,data:_0x28a0a0}}=await axios_1['default']['get'](_0x25dff2,{'params':_0x2771ad});if(_0xee9206!=0x1)throw new common_1[(_0x3e5a57(0xe9))](_0x46a17c,common_1[_0x3e5a57(0x13c)][_0x3e5a57(0x173)]);return _0x28a0a0;}async[_0xde2dfc(0x10b)](_0x574aa2){const _0x1cff69=_0xde2dfc,_0xf44d3=_0x574aa2[_0x1cff69(0x14b)];delete _0x574aa2[_0x1cff69(0x14b)],delete _0x574aa2[_0x1cff69(0x112)];const _0x404f16=await this[_0x1cff69(0x134)]['getConfigByKeys']([_0x1cff69(0x15e)]);console[_0x1cff69(0x117)]('校验签名');if(this[_0x1cff69(0x14b)](_0x574aa2,_0x404f16)!=_0xf44d3)return _0x1cff69(0x16a);console[_0x1cff69(0x117)](_0x1cff69(0x146));const _0x10c6d5=await this[_0x1cff69(0x1af)][_0x1cff69(0x157)]({'where':{'orderId':_0x574aa2['out_trade_no'],'status':0x0}});if(!_0x10c6d5)return'failed';const _0x3241af=_0x574aa2['trade_status']==_0x1cff69(0x1a6)?0x1:0x2;console[_0x1cff69(0x117)](_0x1cff69(0x1b5),_0x3241af);const _0x4be1c5=await this[_0x1cff69(0x1af)]['update']({'orderId':_0x574aa2[_0x1cff69(0x130)]},{'status':_0x3241af,'paydAt':(0x0,date_1[_0x1cff69(0xf7)])()[_0x1cff69(0x185)]()});_0x3241af===0x1&&await this[_0x1cff69(0x159)][_0x1cff69(0x10d)](_0x10c6d5);if(_0x4be1c5[_0x1cff69(0x13d)]!=0x1)return'failed';return'success';}async['payMpay'](_0x457f9d,_0x16c9de,_0x42602c='wxpay'){const _0x1aced9=_0xde2dfc,_0x5351ee=await this[_0x1aced9(0x1af)][_0x1aced9(0x157)]({'where':{'userId':_0x457f9d,'orderId':_0x16c9de}});if(!_0x5351ee)throw new common_1['HttpException'](_0x1aced9(0x13a),common_1['HttpStatus'][_0x1aced9(0x173)]);const _0x88bc40=await this[_0x1aced9(0x1ac)]['findOne']({'where':{'id':_0x5351ee['goodsId']}});if(!_0x88bc40)throw new common_1[(_0x1aced9(0xe9))](_0x1aced9(0x124),common_1['HttpStatus']['BAD_REQUEST']);const {payMpayPid:_0xbfba2e,payMpaySecret:_0x19debb,payMpayNotifyUrl:_0x3384a3,payMpayReturnUrl:_0x547031,payMpayApiPayUrl:_0x4b02c4}=await this[_0x1aced9(0x134)]['getConfigByKeys']([_0x1aced9(0x166),_0x1aced9(0x15e),'payMpayNotifyUrl',_0x1aced9(0x188),_0x1aced9(0x10f)]),_0x1cdba8={};_0x1cdba8[_0x1aced9(0x16e)]=Number(_0xbfba2e),_0x1cdba8['type']=_0x42602c,_0x1cdba8[_0x1aced9(0x130)]=_0x16c9de,_0x1cdba8['name']=_0x88bc40[_0x1aced9(0x149)],_0x1cdba8['money']=_0x5351ee[_0x1aced9(0x110)],_0x1cdba8[_0x1aced9(0x15a)]=_0x3384a3,_0x1cdba8[_0x1aced9(0xec)]=_0x547031,_0x1cdba8[_0x1aced9(0x14b)]=this[_0x1aced9(0x14b)](_0x1cdba8,_0x19debb),_0x1cdba8[_0x1aced9(0x112)]=_0x1aced9(0x16d);const _0x31b3d7=new URLSearchParams(_0x1cdba8)[_0x1aced9(0x177)](),_0x34cfbb=_0x4b02c4+'?'+_0x31b3d7;return{'url_qrcode':null,'redirectUrl':_0x34cfbb,'channel':_0x42602c,'isRedirect':!![]};}async[_0xde2dfc(0x13b)](_0x433a81){const _0x2c9b78=_0xde2dfc,{payMpayApiQueryUrl:_0x1be3f3}=await this[_0x2c9b78(0x134)][_0x2c9b78(0xe6)]([_0x2c9b78(0x166),_0x2c9b78(0x15e),_0x2c9b78(0x161)]),_0x299e35={};_0x299e35[_0x2c9b78(0x102)]=0x2,_0x299e35[_0x2c9b78(0x178)]=_0x433a81;const {data:{code:_0x35e8e8,msg:_0x48776f,data:_0x5d1409}}=await axios_1[_0x2c9b78(0xf7)][_0x2c9b78(0xea)](_0x1be3f3,{'params':_0x299e35});if(_0x35e8e8!=0x1)throw new common_1[(_0x2c9b78(0xe9))](_0x48776f,common_1[_0x2c9b78(0x13c)][_0x2c9b78(0x173)]);return _0x5d1409;}async[_0xde2dfc(0xe5)](_0x5047ba){const _0x2765df=_0xde2dfc;console[_0x2765df(0x117)](_0x2765df(0x162),_0x5047ba);const {payWeChatAppId:_0xbff51f,payWeChatMchId:_0x293256,payWeChatSecret:_0x28c79a,payWeChatPublicKey:_0x157167,payWeChatPrivateKey:_0x102110}=await this[_0x2765df(0x134)][_0x2765df(0xe6)](['payWeChatAppId',_0x2765df(0xf3),_0x2765df(0xeb),'payWeChatPublicKey',_0x2765df(0x18f)]),_0x267cdc=new WxPay({'appid':_0xbff51f,'mchid':_0x293256,'publicKey':_0x157167,'privateKey':_0x102110});let _0x4efcba;try{if(_0x5047ba[_0x2765df(0x164)]==_0x2765df(0xfd)){const {ciphertext:_0x5da7ef,associated_data:_0x252718,nonce:_0x5179a2}=_0x5047ba['resource'],_0x38c47b=_0x267cdc['decipher_gcm'](_0x5da7ef,_0x252718,_0x5179a2,_0x28c79a),_0x27ed40=_0x38c47b[_0x2765df(0x130)];_0x4efcba=redisKey_constant_1['PAY_UPDATE_ORDER']+_0x27ed40,await this[_0x2765df(0x152)][_0x2765df(0x19c)]({'key':_0x4efcba,'val':_0x2765df(0x19d)});const _0x1753a8=await this[_0x2765df(0x1af)][_0x2765df(0x157)]({'where':{'orderId':_0x27ed40,'status':0x0}});if(!_0x1753a8)return _0x2765df(0x16a);if([0x1,0x2,0x3][_0x2765df(0x142)](_0x1753a8[_0x2765df(0x15b)]))return _0x2765df(0x138);const _0x2b1c99=await this[_0x2765df(0x1a2)]['transaction'](async _0x1fcc29=>{const _0x18150c=_0x2765df,_0x41a3ad=_0x38c47b[_0x18150c(0x1b1)]==_0x18150c(0xf9)?0x1:0x2,_0x133d28=await this['orderEntity'][_0x18150c(0x113)]({'orderId':_0x27ed40},{'status':_0x41a3ad,'paydAt':(0x0,date_1[_0x18150c(0xf7)])()[_0x18150c(0x185)](),'tradeId':_0x38c47b[_0x18150c(0x155)]});return _0x41a3ad===0x1&&await this[_0x18150c(0x159)][_0x18150c(0x10d)](_0x1753a8),_0x133d28;});if(_0x2b1c99['affected']!=0x1)return'failed';}return'success';}catch(_0x1c18fe){return console[_0x2765df(0x117)]('error:\x20',_0x1c18fe),console[_0x2765df(0x117)](_0x2765df(0x108),_0x1c18fe),_0x2765df(0x16a);}finally{_0x4efcba&&await this[_0x2765df(0x152)]['del']({'key':_0x4efcba});}}async[_0xde2dfc(0x114)](_0x4e0df0,_0x4945f8,_0x2fff79){const _0x5a7242=_0xde2dfc,_0x32852f=await this[_0x5a7242(0x1af)][_0x5a7242(0x157)]({'where':{'userId':_0x4e0df0,'orderId':_0x4945f8}});if(!_0x32852f)throw new common_1[(_0x5a7242(0xe9))]('订单不存在!',common_1['HttpStatus'][_0x5a7242(0x173)]);const _0x41614c=await this[_0x5a7242(0x1ac)][_0x5a7242(0x157)]({'where':{'id':_0x32852f[_0x5a7242(0x165)]}});if(!_0x41614c)throw new common_1['HttpException'](_0x5a7242(0x124),common_1[_0x5a7242(0x13c)]['BAD_REQUEST']);const _0x469d54={'bizContent':{'out_trade_no':_0x4945f8,'total_amount':_0x32852f['total'],'subject':_0x41614c['name']}};let _0x36d8fa,_0x448be0,_0x55b677,_0x36e481,_0x1499ff;const {payAliPublicSecret:_0x22f251,payAliWebAppId:_0x2c3475,payAliWebSecret:_0x136255,payAliAppAppId:_0x3acdca,payAliAppSecret:_0x56daff,payWeChatNotifyUrl:_0x32c4db}=await this[_0x5a7242(0x134)][_0x5a7242(0xe6)]([_0x5a7242(0x17b),'payAliWebAppId',_0x5a7242(0xe7),_0x5a7242(0x148),_0x5a7242(0x107),_0x5a7242(0x18c)]);_0x2fff79==='native'&&(_0x469d54[_0x5a7242(0x12b)]=_0x5a7242(0x1b4),_0x36d8fa=_0x2c3475,_0x55b677=_0x5a7242(0x197),_0x448be0=_0x136255,_0x36e481=_0x5a7242(0x127),_0x1499ff='FAST_INSTANT_TRADE_PAY');_0x2fff79==='app'&&(_0x55b677=_0x5a7242(0x139),_0x36d8fa=_0x3acdca,_0x448be0=_0x56daff,_0x36e481=_0x5a7242(0x1a4),_0x1499ff='QUICK_MSECURITY_PAY');const _0x55b291=new AlipaySdk({'appId':_0x36d8fa,'keyType':_0x5a7242(0x11e),'privateKey':_0x448be0,'alipayPublicKey':_0x22f251});_0x469d54[_0x5a7242(0x15c)]=_0x32c4db,_0x469d54['bizContent'][_0x5a7242(0x106)]=_0x1499ff;const _0x37928c=await _0x55b291[_0x55b677](_0x36e481,_0x469d54);return console[_0x5a7242(0x117)]('alipay\x20result:\x20',_0x37928c),_0x2fff79===_0x5a7242(0x169)?{'form':_0x37928c}:{'data':_0x37928c};}async[_0xde2dfc(0x181)](_0x4dabb5,_0x72201){const _0x5ac717=_0xde2dfc;let _0xa4e6,_0x579072;const {payAliPublicSecret:_0x32ab21,payAliWebAppId:_0xd5b167,payAliWebSecret:_0x5a5b50,payAliAppAppId:_0x4db475,payAliAppSecret:_0x45bfad,payWeChatNotifyUrl:_0x5ac2d5}=await this['globalConfigService'][_0x5ac717(0xe6)](['payAliPublicSecret',_0x5ac717(0x1a1),_0x5ac717(0xe7),'payAliAppAppId',_0x5ac717(0x107),_0x5ac717(0x18c)]);_0x72201===_0x5ac717(0x169)&&(_0xa4e6=_0xd5b167,_0x579072=_0x5a5b50);_0x72201===_0x5ac717(0x123)&&(_0xa4e6=_0x4db475,_0x579072=_0x45bfad);const _0x481b84=new AlipaySdk({'appId':_0xa4e6,'keyType':_0x5ac717(0x11e),'privateKey':_0x579072,'alipayPublicKey':_0x32ab21}),_0xe7496=await _0x481b84[_0x5ac717(0x122)](_0x5ac717(0x140),{'bizContent':{'out_trade_no':_0x4dabb5}});return console[_0x5ac717(0x117)](_0xe7496),_0xe7496;}async[_0xde2dfc(0xf5)](_0x636d81,_0x2e6a53,_0x53b42a=_0xde2dfc(0x169)){const _0x4dca91=_0xde2dfc;console[_0x4dca91(0x117)](_0x4dca91(0x175),_0x53b42a);const _0x2f6589=await this['orderEntity'][_0x4dca91(0x157)]({'where':{'userId':_0x636d81,'orderId':_0x2e6a53}});if(!_0x2f6589)throw new common_1[(_0x4dca91(0xe9))](_0x4dca91(0x13a),common_1[_0x4dca91(0x13c)][_0x4dca91(0x173)]);const _0x1ffeed=await this['cramiPackageEntity'][_0x4dca91(0x157)]({'where':{'id':_0x2f6589[_0x4dca91(0x165)]}});if(!_0x1ffeed)throw new common_1[(_0x4dca91(0xe9))](_0x4dca91(0x124),common_1[_0x4dca91(0x13c)][_0x4dca91(0x173)]);const {payWeChatAppId:_0x4334b5,payWeMiniAppId:_0x172d12,payWeChatMchId:_0x15f73d,payWeChatPublicKey:_0x325e35,payWeChatPrivateKey:_0x3d9e48,payWeChatNotifyUrl:_0x40ff50,payWeChatH5Name:_0x4e8895,payWeChatH5Url:_0x24b0c4,WE_APP_APPID:_0xfddfe9,WE_APP_APPSECRET:_0x5e26fe}=await this[_0x4dca91(0x134)][_0x4dca91(0xe6)](['payWeChatAppId',_0x4dca91(0x1b2),'payWeChatMchId','payWeChatPublicKey',_0x4dca91(0x18f),'payWeChatNotifyUrl','payWeChatH5Name',_0x4dca91(0x194),_0x4dca91(0x119)]),_0x3a577a=new WxPay({'appid':_0x53b42a===_0x4dca91(0x17c)?_0x172d12:_0x4334b5,'mchid':_0x15f73d,'publicKey':_0x325e35,'privateKey':_0x3d9e48}),_0x23a34b={'appid':_0x53b42a===_0x4dca91(0x17c)?_0x172d12:_0x4334b5,'mchid':_0x15f73d,'description':_0x1ffeed[_0x4dca91(0x149)],'out_trade_no':_0x2e6a53,'notify_url':_0x40ff50,'amount':{'total':Number(_0x2f6589[_0x4dca91(0x110)]*0x64)},'scene_info':{'payer_client_ip':'192.168.1.100'}};console[_0x4dca91(0x117)](_0x4dca91(0xe4),_0x23a34b);if(_0x53b42a=='h5'){_0x23a34b[_0x4dca91(0x104)][_0x4dca91(0x184)]={'type':_0x4dca91(0x14a),'app_name':_0x4e8895,'app_url':_0x24b0c4};const _0x535578=await _0x3a577a[_0x4dca91(0x10e)](_0x23a34b);if(_0x535578[_0x4dca91(0x15b)]===0x193){const _0x3b6542=_0x535578?.[_0x4dca91(0x18a)]?.[_0x4dca91(0x101)]?.[_0x4dca91(0x144)]?.[_0x4dca91(0x189)];throw new common_1[(_0x4dca91(0xe9))](_0x535578?.[_0x4dca91(0x189)]||'微信H5支付失败！',common_1[_0x4dca91(0x13c)][_0x4dca91(0x173)]);}const {h5_url:_0xef165}=_0x535578;return{'url':_0xef165};}if(_0x53b42a==='app'){_0x23a34b[_0x4dca91(0x115)]=_0xfddfe9;const _0x2ade0d=await _0x3a577a[_0x4dca91(0x12d)](_0x23a34b);return console[_0x4dca91(0x117)](_0x4dca91(0x125),_0x2ade0d),_0x2ade0d;}if(_0x53b42a==_0x4dca91(0x17c)){const _0x1d366a=await this[_0x4dca91(0x174)]['getMiniOpenIdByUserId'](_0x636d81);_0x23a34b[_0x4dca91(0x191)]={'openid':_0x1d366a};const _0x37bac5=await _0x3a577a[_0x4dca91(0x19b)](_0x23a34b);return console[_0x4dca91(0x117)](_0x4dca91(0xf6),_0x37bac5),_0x37bac5;}if(_0x53b42a==_0x4dca91(0x118)){const _0x26beb0=await this[_0x4dca91(0x174)]['getOpenIdByUserId'](_0x636d81);console['log'](_0x4dca91(0x137),_0x26beb0),_0x23a34b[_0x4dca91(0x191)]={'openid':_0x26beb0};const _0x525980=await _0x3a577a[_0x4dca91(0x19b)](_0x23a34b);return console[_0x4dca91(0x117)](_0x4dca91(0xf6),_0x525980),_0x525980;}if(_0x53b42a==_0x4dca91(0x169)){const _0x856aec=await _0x3a577a[_0x4dca91(0x168)](_0x23a34b),{code_url:_0x3cdff5}=_0x856aec;return!_0x3cdff5&&console[_0x4dca91(0x117)]('wx-native',_0x856aec),{'url_qrcode':_0x3cdff5,'isRedirect':![]};}throw new common_1[(_0x4dca91(0xe9))](_0x4dca91(0xff),common_1[_0x4dca91(0x13c)][_0x4dca91(0x173)]);}async[_0xde2dfc(0x11d)](_0x5ab340,_0xdf7f19){const _0x3a0942=_0xde2dfc,{payWeChatAppId:_0x48d831,payWeMiniAppId:_0x580e52,payWeChatMchId:_0xb556de,payWeChatPublicKey:_0x11ea86,payWeChatPrivateKey:_0x5c8e10}=await this['globalConfigService'][_0x3a0942(0xe6)]([_0x3a0942(0x150),'payWeMiniAppId',_0x3a0942(0xf3),_0x3a0942(0x11b),_0x3a0942(0x18f)]),_0x59f44d=new WxPay({'appid':_0xdf7f19===_0x3a0942(0x17c)?_0x580e52:_0x48d831,'mchid':_0xb556de,'publicKey':_0x11ea86,'privateKey':_0x5c8e10}),_0xd6a699=await _0x59f44d[_0x3a0942(0x13e)]({'out_trade_no':_0x5ab340});return _0xd6a699;}async[_0xde2dfc(0xfb)](_0x5d7cef){const _0x36397d=_0xde2dfc;_0x5d7cef[_0x36397d(0x1b0)]===_0x36397d(0x192)&&await this[_0x36397d(0x1ae)](_0x5d7cef);}async[_0xde2dfc(0x1ae)](_0x735332){const _0xd5e72d=_0xde2dfc,{payWeChatAppId:_0x5c300e,payWeMiniAppId:_0x4e3524,payWeChatMchId:_0x5680c0,payWeChatPublicKey:_0x6bf346,payWeChatPrivateKey:_0x52ff5a}=await this['globalConfigService'][_0xd5e72d(0xe6)](['payWeChatAppId',_0xd5e72d(0x1b2),_0xd5e72d(0xf3),_0xd5e72d(0x11b),'payWeChatPrivateKey',_0xd5e72d(0x18c),_0xd5e72d(0x16b),_0xd5e72d(0x194)]),_0x1365a9=new WxPay({'appid':_0x735332[_0xd5e72d(0x12a)]===_0xd5e72d(0x17c)?_0x4e3524:_0x5c300e,'mchid':_0x5680c0,'publicKey':_0x6bf346,'privateKey':_0x52ff5a});await _0x1365a9[_0xd5e72d(0x121)](_0x735332['orderId']);}['sign'](_0x25d7de,_0x3467ec){const _0x5a1d20=_0xde2dfc,_0x2449a7=Object[_0x5a1d20(0xe3)](_0x25d7de)[_0x5a1d20(0x18b)]()[_0x5a1d20(0x14f)](_0x4a8e46=>_0x4a8e46+'='+_0x25d7de[_0x4a8e46])['join']('&')+_0x3467ec;return crypto['createHash'](_0x5a1d20(0x103))[_0x5a1d20(0x113)](_0x2449a7)['digest'](_0x5a1d20(0x13f));}};PayService=__decorate([(0x0,common_1[_0xde2dfc(0x100)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0xde2dfc(0x17d)])),__param(0x1,(0x0,typeorm_1[_0xde2dfc(0x196)])(order_entity_1[_0xde2dfc(0x1ab)])),__metadata('design:paramtypes',[typeorm_2[_0xde2dfc(0x170)],typeorm_2[_0xde2dfc(0x170)],userBalance_service_1[_0xde2dfc(0x11f)],globalConfig_service_1[_0xde2dfc(0x156)],user_service_1[_0xde2dfc(0x11c)],redisCache_service_1['RedisCacheService'],typeorm_2[_0xde2dfc(0x10a)]])],PayService),exports[_0xde2dfc(0x17e)]=PayService;