'use strict';const _0x56eac7=_0x31f4;(function(_0x51b3ee,_0x5d7d87){const _0x4595bf=_0x31f4,_0x4adaa5=_0x51b3ee();while(!![]){try{const _0xf87d3d=-parseInt(_0x4595bf(0x161))/0x1*(parseInt(_0x4595bf(0x124))/0x2)+parseInt(_0x4595bf(0x13d))/0x3*(-parseInt(_0x4595bf(0x1ce))/0x4)+parseInt(_0x4595bf(0x198))/0x5+-parseInt(_0x4595bf(0x12f))/0x6*(parseInt(_0x4595bf(0x1ba))/0x7)+parseInt(_0x4595bf(0x176))/0x8*(-parseInt(_0x4595bf(0x11b))/0x9)+parseInt(_0x4595bf(0x1b1))/0xa+parseInt(_0x4595bf(0x194))/0xb*(parseInt(_0x4595bf(0x14f))/0xc);if(_0xf87d3d===_0x5d7d87)break;else _0x4adaa5['push'](_0x4adaa5['shift']());}catch(_0x552a49){_0x4adaa5['push'](_0x4adaa5['shift']());}}}(_0x2cb9,0x9b3aa));function _0x31f4(_0x295ed1,_0x4203bf){const _0x2cb961=_0x2cb9();return _0x31f4=function(_0x31f464,_0x4a24db){_0x31f464=_0x31f464-0x10b;let _0x12ba81=_0x2cb961[_0x31f464];return _0x12ba81;},_0x31f4(_0x295ed1,_0x4203bf);}var __decorate=this&&this[_0x56eac7(0x147)]||function(_0x43d778,_0x452323,_0x1a11c6,_0x1be5bc){const _0xeb4c4e=_0x56eac7;var _0x568281=arguments[_0xeb4c4e(0x17f)],_0x3a5afe=_0x568281<0x3?_0x452323:_0x1be5bc===null?_0x1be5bc=Object[_0xeb4c4e(0x140)](_0x452323,_0x1a11c6):_0x1be5bc,_0x400a98;if(typeof Reflect===_0xeb4c4e(0x143)&&typeof Reflect['decorate']===_0xeb4c4e(0x10f))_0x3a5afe=Reflect[_0xeb4c4e(0x156)](_0x43d778,_0x452323,_0x1a11c6,_0x1be5bc);else{for(var _0x326322=_0x43d778[_0xeb4c4e(0x17f)]-0x1;_0x326322>=0x0;_0x326322--)if(_0x400a98=_0x43d778[_0x326322])_0x3a5afe=(_0x568281<0x3?_0x400a98(_0x3a5afe):_0x568281>0x3?_0x400a98(_0x452323,_0x1a11c6,_0x3a5afe):_0x400a98(_0x452323,_0x1a11c6))||_0x3a5afe;}return _0x568281>0x3&&_0x3a5afe&&Object[_0xeb4c4e(0x175)](_0x452323,_0x1a11c6,_0x3a5afe),_0x3a5afe;},__metadata=this&&this[_0x56eac7(0x1c8)]||function(_0x28d160,_0x10c7ed){const _0x8bbf78=_0x56eac7;if(typeof Reflect===_0x8bbf78(0x143)&&typeof Reflect[_0x8bbf78(0x1ad)]==='function')return Reflect[_0x8bbf78(0x1ad)](_0x28d160,_0x10c7ed);},__param=this&&this[_0x56eac7(0x182)]||function(_0x256fc5,_0x484fe3){return function(_0x30b30e,_0x10b48d){_0x484fe3(_0x30b30e,_0x10b48d,_0x256fc5);};};function _0x2cb9(){const _0x2cab66=['RedisCacheService','alipay','1337sVjMTj','get','OrderEntity','channel','../crami/cramiPackage.entity','transactions_native','notifyWeChat','now','act','out_trade_no','Connection','return_url','notify','crypto','__metadata','order','post','status:\x20','default','status','824ElWUbV','alipay.trade.page.pay','success','version','wxpay','__esModule','failed','Injectable','connection','wechatpay-node-v3','queryAliPay','sign','queryHupi','name','SUCCESS','toString','affected','transaction','message','wechat','wx-native','WE_APP_APPID','payMpayApiPayUrl','typeorm','payWeChatAppId','submit.php','epay','订单不存在!','Wap','response','function','HttpException','payMpayReturnUrl','TRADE_SUCCESS','clientip','axios','toDate','epay\x20--->\x20res:\x20','mini','del','event_type','payHupiAppId','83853XeIVys','createHash','套餐不存在!','FAST_INSTANT_TRADE_PAY','微信H5支付失败！','update','支付请求失败:\x20','param','set','14Hnzkxa','key','goodsId','TRANSACTION.SUCCESS','../../common/constants/redisKey.constant','globalConfigService','payEpaySecret','transaction_id','total','payWeChatH5Name','cramiPackageEntity','23466RyRNHh','GlobalConfigService','redisCacheService','../redisCache/redisCache.service','校验签名','payWeChatSecret','payMpayNotifyUrl','getConfigByKeys','payHupiGatewayUrl','notify_url','transactions_jsapi','payEpayPid','keys','payWeChatPrivateKey','9201zjdxwP','orderEntity','out_trade_order','getOwnPropertyDescriptor','BAD_REQUEST','@nestjs/typeorm','object','支付通知验证失败:\x20','192.168.1.100','join','__decorate','payWeMiniAppId','alipay\x20result:\x20','sign_type','native','../../common/utils/date','payMpayApiQueryUrl','setNotifyUrl','5458032qFWcCv','payEpay','payEpayNotifyUrl','queryWeChat','payAliAppAppId','device','payEpayApiQueryUrl','decorate','error:\x20','resource','query','payHupiSecret','payAliAppSecret','POST','payMpayPid','money','payHupiNotifyUrl','app','154338fnEypK','design:paramtypes','1.1','payEpayReturnUrl','payWeChatPublicKey','payPlatform','findOne','digest','alipay-sdk','jsapi支付结果返回值:\x20','unsupported\x20pay\x20type','bizContent','UserService','cancel','payAliPublicSecret','exec','payHupi','PKCS1','payMpaySecret','https://api.xunhupay.com/payment/do.html','defineProperty','104ZAuVSI','payAliWebSecret','notifyEpay','InjectRepository','log','sort','onModuleInit','mpay','order_no','length','@nestjs/common','hupi','__param','transactions_h5','Repository','payAliWebAppId','total_fee','App支付结果返回值:\x20','QUICK_MSECURITY_PAY','alipay.trade.query','payWeChat','attach','map','HttpStatus','getMiniOpenIdByUserId','userBalanceService','time','校验签名通过','appid','includes','66EeXkiL','本次支付类型:\x20','createRandomNonceStr','payWeChatH5Url','1963820TkhggU','toFixed','pid','type','queryMpay','notifyMpay','payWeChatNotifyUrl','addBalanceToOrder','hash','MD5','nonce_str','lock','alipay.trade.app.pay','trade_status','cancelWxOrder','userService','queryEpay','notifyHupi','UserBalanceService','transactions_app','用户openId:\x20','metadata','payer','payAli','trade_order_id','943280PRsriv','../user/user.service','pageExec','PayService','pay','payWeChatMchId','jsapi'];_0x2cb9=function(){return _0x2cab66;};return _0x2cb9();}Object[_0x56eac7(0x175)](exports,_0x56eac7(0x1d3),{'value':!![]}),exports[_0x56eac7(0x1b4)]=void 0x0;const typeorm_1=require(_0x56eac7(0x142)),typeorm_2=require(_0x56eac7(0x1e5)),common_1=require(_0x56eac7(0x180)),crypto=require(_0x56eac7(0x1c7)),axios_1=require(_0x56eac7(0x114)),order_entity_1=require('../order/order.entity'),cramiPackage_entity_1=require(_0x56eac7(0x1be)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require('../../common/utils'),user_service_1=require(_0x56eac7(0x1b2)),redisCache_service_1=require(_0x56eac7(0x132)),redisKey_constant_1=require(_0x56eac7(0x128)),date_1=require(_0x56eac7(0x14c)),WxPay=require(_0x56eac7(0x1d7)),AlipaySdk=require(_0x56eac7(0x169));let PayService=class PayService{constructor(_0x519855,_0x536d67,_0x28d251,_0x40ac23,_0x40ddfa,_0x5df0ce,_0x8a017){const _0x41280a=_0x56eac7;this[_0x41280a(0x12e)]=_0x519855,this[_0x41280a(0x13e)]=_0x536d67,this[_0x41280a(0x18f)]=_0x28d251,this[_0x41280a(0x129)]=_0x40ac23,this[_0x41280a(0x1a7)]=_0x40ddfa,this[_0x41280a(0x131)]=_0x5df0ce,this[_0x41280a(0x1d6)]=_0x8a017;}async[_0x56eac7(0x17c)](){}async[_0x56eac7(0x1c6)](_0x5e5bc9){const _0x4bf99a=_0x56eac7;if(_0x5e5bc9[_0x4bf99a(0x122)]==_0x4bf99a(0x10b))return this[_0x4bf99a(0x178)](_0x5e5bc9);if(_0x5e5bc9[_0x4bf99a(0x18b)]==_0x4bf99a(0x181))return this[_0x4bf99a(0x1a9)](_0x5e5bc9);if(typeof _0x5e5bc9[_0x4bf99a(0x158)]==_0x4bf99a(0x143))return this[_0x4bf99a(0x1c0)](_0x5e5bc9);return this[_0x4bf99a(0x19d)](_0x5e5bc9);}async[_0x56eac7(0x1b5)](_0xa8700f,_0x14dceb,_0x133ddc=_0x56eac7(0x1d2)){const _0x1db935=_0x56eac7,_0x1d300c=await this[_0x1db935(0x13e)]['findOne']({'where':{'userId':_0xa8700f,'orderId':_0x14dceb}});if(!_0x1d300c)throw new common_1[(_0x1db935(0x110))](_0x1db935(0x10c),common_1[_0x1db935(0x18d)]['BAD_REQUEST']);const _0x1db608=await this[_0x1db935(0x12e)][_0x1db935(0x167)]({'where':{'id':_0x1d300c[_0x1db935(0x126)]}});if(!_0x1db608)throw new common_1['HttpException'](_0x1db935(0x11d),common_1[_0x1db935(0x18d)][_0x1db935(0x141)]);console[_0x1db935(0x17a)](_0x1db935(0x195),_0x1d300c[_0x1db935(0x166)]);try{if(_0x1d300c[_0x1db935(0x166)]==_0x1db935(0x1b9))return this['payAli'](_0xa8700f,_0x14dceb,_0x133ddc);if(_0x1d300c[_0x1db935(0x166)]==_0x1db935(0x1e1))return this[_0x1db935(0x18a)](_0xa8700f,_0x14dceb,_0x133ddc);if(_0x1d300c['payPlatform']==_0x1db935(0x10b))return this[_0x1db935(0x150)](_0xa8700f,_0x14dceb,_0x133ddc);if(_0x1d300c['payPlatform']==_0x1db935(0x17d))return this['payMpay'](_0xa8700f,_0x14dceb,_0x133ddc);if(_0x1d300c[_0x1db935(0x166)]==_0x1db935(0x181))return this[_0x1db935(0x171)](_0xa8700f,_0x14dceb,_0x133ddc);}catch(_0x11e3d5){console[_0x1db935(0x17a)](_0x1db935(0x121),_0x11e3d5);throw new common_1[(_0x1db935(0x110))]('支付请求失败!',common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x56eac7(0x159)](_0x17e57e){const _0x29e3af=_0x56eac7,_0x5c30c4=await this['orderEntity'][_0x29e3af(0x167)]({'where':{'orderId':_0x17e57e}});if(!_0x5c30c4)throw new common_1['HttpException']('订单不存在!',common_1[_0x29e3af(0x18d)][_0x29e3af(0x141)]);return _0x5c30c4;}async[_0x56eac7(0x1a9)](_0x3d9a4f){const _0x16346f=_0x56eac7,_0x30bed0=await this[_0x16346f(0x129)]['getConfigByKeys'](['payHupiSecret']),_0x3e134b=_0x3d9a4f[_0x16346f(0x1a0)];delete _0x3d9a4f['hash'];if(this['sign'](_0x3d9a4f,_0x30bed0)!=_0x3e134b)return _0x16346f(0x1d4);const _0x5bd59b=await this[_0x16346f(0x13e)][_0x16346f(0x167)]({'where':{'orderId':_0x3d9a4f[_0x16346f(0x1b0)],'status':0x0}});if(!_0x5bd59b)return'failed';await this['userBalanceService'][_0x16346f(0x19f)](_0x5bd59b);const _0xa13c03=await this[_0x16346f(0x13e)][_0x16346f(0x120)]({'orderId':_0x3d9a4f['trade_order_id']},{'status':0x1,'paydAt':(0x0,date_1[_0x16346f(0x1cc)])()[_0x16346f(0x115)]()});if(_0xa13c03[_0x16346f(0x1de)]!=0x1)return _0x16346f(0x1d4);return _0x16346f(0x1d0);}async['payHupi'](_0x4bf070,_0xdd1c6a,_0x430a8a=_0x56eac7(0x1d2)){const _0x22e014=_0x56eac7,_0x1bea16=await this[_0x22e014(0x13e)]['findOne']({'where':{'userId':_0x4bf070,'orderId':_0xdd1c6a}});if(!_0x1bea16)throw new common_1[(_0x22e014(0x110))](_0x22e014(0x10c),common_1['HttpStatus']['BAD_REQUEST']);const _0x1a6d2c=await this[_0x22e014(0x12e)][_0x22e014(0x167)]({'where':{'id':_0x1bea16[_0x22e014(0x126)]}});if(!_0x1a6d2c)throw new common_1[(_0x22e014(0x110))](_0x22e014(0x11d),common_1[_0x22e014(0x18d)][_0x22e014(0x141)]);const {payHupiAppId:_0x3448af,payHupiSecret:_0x529237,payHupiNotifyUrl:_0x2d14e3,payHupiReturnUrl:_0x3df591,payHupiGatewayUrl:_0x29b419}=await this['globalConfigService'][_0x22e014(0x136)]([_0x22e014(0x11a),_0x22e014(0x15a),_0x22e014(0x15f),'payHupiReturnUrl',_0x22e014(0x137)]),_0x361bb2={};_0x361bb2[_0x22e014(0x1d1)]=_0x22e014(0x163),_0x361bb2['appid']=_0x3448af,_0x361bb2[_0x22e014(0x190)]=(Date[_0x22e014(0x1c1)]()/0x3e8)[_0x22e014(0x199)](0x0),_0x361bb2[_0x22e014(0x1a2)]=(0x0,utils_1[_0x22e014(0x196)])(0x20),_0x361bb2[_0x22e014(0x1b0)]=_0xdd1c6a,_0x361bb2['title']=_0x1a6d2c[_0x22e014(0x1db)],_0x361bb2[_0x22e014(0x186)]=_0x1bea16[_0x22e014(0x12c)],_0x361bb2[_0x22e014(0x138)]=_0x2d14e3,_0x361bb2[_0x22e014(0x1c5)]=_0x3df591,_0x361bb2['attach']='hupi',_0x361bb2[_0x22e014(0x1a0)]=this[_0x22e014(0x1d9)](_0x361bb2,_0x529237);const {data:{errcode:_0x30482c,errmsg:_0x2efc6b,url_qrcode:_0x174df8,url:_0x28492f}}=await axios_1[_0x22e014(0x1cc)][_0x22e014(0x1ca)](_0x29b419||_0x22e014(0x174),_0x361bb2);if(_0x30482c!=0x0)throw new common_1[(_0x22e014(0x110))](_0x2efc6b,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x174df8,'url':_0x28492f};}async[_0x56eac7(0x1da)](_0x2429f7){const _0x4a4c91=_0x56eac7,{payHupiAppId:_0x4aedc4,payHupiSecret:_0x126150}=await this[_0x4a4c91(0x129)][_0x4a4c91(0x136)]([_0x4a4c91(0x11a),_0x4a4c91(0x15a)]),_0x1cfe44={};_0x1cfe44[_0x4a4c91(0x1d1)]=_0x4a4c91(0x163),_0x1cfe44[_0x4a4c91(0x192)]=_0x4aedc4,_0x1cfe44[_0x4a4c91(0x190)]=(Date[_0x4a4c91(0x1c1)]()/0x3e8)['toFixed'](0x0),_0x1cfe44['nonce_str']=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x1cfe44[_0x4a4c91(0x13f)]=_0x2429f7,_0x1cfe44[_0x4a4c91(0x1a0)]=this[_0x4a4c91(0x1d9)](_0x1cfe44,_0x126150);const {data:{errcode:_0x44bc2f,errmsg:_0x436bf8,data:_0x51bcd6}}=await axios_1[_0x4a4c91(0x1cc)]['post']('https://api.xunhupay.com/payment/query.html',_0x1cfe44);if(_0x44bc2f!=0x0)throw new common_1[(_0x4a4c91(0x110))](_0x436bf8,common_1[_0x4a4c91(0x18d)][_0x4a4c91(0x141)]);return _0x51bcd6;}async[_0x56eac7(0x178)](_0x418133){const _0x1502c4=_0x56eac7,_0x5083a3=_0x418133[_0x1502c4(0x1d9)];delete _0x418133[_0x1502c4(0x1d9)],delete _0x418133[_0x1502c4(0x14a)];const _0x1b47b8=await this[_0x1502c4(0x129)]['getConfigByKeys']([_0x1502c4(0x12a)]);if(this[_0x1502c4(0x1d9)](_0x418133,_0x1b47b8)!=_0x5083a3)return _0x1502c4(0x1d4);console['log']('校验签名通过');const _0xc57d13=await this[_0x1502c4(0x13e)][_0x1502c4(0x167)]({'where':{'orderId':_0x418133['out_trade_no'],'status':0x0}});if(!_0xc57d13)return _0x1502c4(0x1d4);const _0x25de50=_0x418133[_0x1502c4(0x1a5)]==_0x1502c4(0x112)?0x1:0x2,_0x3bc9f7=await this['orderEntity'][_0x1502c4(0x120)]({'orderId':_0x418133[_0x1502c4(0x1c3)]},{'status':_0x25de50,'paydAt':(0x0,date_1['default'])()[_0x1502c4(0x115)]()});_0x25de50===0x1&&await this['userBalanceService'][_0x1502c4(0x19f)](_0xc57d13);if(_0x3bc9f7[_0x1502c4(0x1de)]!=0x1)return _0x1502c4(0x1d4);return _0x1502c4(0x1d0);}async[_0x56eac7(0x150)](_0x15a5e5,_0x74198d,_0x4fb5aa=_0x56eac7(0x1b9)){const _0x493131=_0x56eac7,_0x3641e7=await this[_0x493131(0x13e)][_0x493131(0x167)]({'where':{'userId':_0x15a5e5,'orderId':_0x74198d}});if(!_0x3641e7)throw new common_1[(_0x493131(0x110))](_0x493131(0x10c),common_1[_0x493131(0x18d)]['BAD_REQUEST']);const _0x4f470b=await this[_0x493131(0x12e)][_0x493131(0x167)]({'where':{'id':_0x3641e7[_0x493131(0x126)]}});if(!_0x4f470b)throw new common_1[(_0x493131(0x110))](_0x493131(0x11d),common_1[_0x493131(0x18d)][_0x493131(0x141)]);const {payEpayPid:_0x13298c,payEpaySecret:_0x40d05a,payEpayNotifyUrl:_0x564717,payEpayReturnUrl:_0xf6905c,payEpayApiPayUrl:_0x3908b1}=await this[_0x493131(0x129)][_0x493131(0x136)](['payEpayPid',_0x493131(0x12a),_0x493131(0x151),_0x493131(0x164),'payEpayApiPayUrl']);let _0x1e7253;_0x13298c[_0x493131(0x17f)]<=0x10?_0x1e7253=Number(_0x13298c):_0x1e7253=BigInt(_0x13298c);const _0x157315={};_0x157315[_0x493131(0x19a)]=_0x1e7253,_0x157315[_0x493131(0x19b)]=_0x4fb5aa,_0x157315[_0x493131(0x1c3)]=_0x74198d,_0x157315[_0x493131(0x1db)]=_0x4f470b[_0x493131(0x1db)],_0x157315[_0x493131(0x15e)]=_0x3641e7['total'],_0x157315[_0x493131(0x113)]=_0x493131(0x145),_0x157315[_0x493131(0x154)]='pc',_0x157315['notify_url']=_0x564717,_0x157315[_0x493131(0x1c5)]=_0xf6905c,_0x157315[_0x493131(0x122)]=_0x493131(0x10b),_0x157315['sign']=this['sign'](_0x157315,_0x40d05a),_0x157315[_0x493131(0x14a)]=_0x493131(0x1a1);const _0x5646d9=new URLSearchParams(_0x157315)[_0x493131(0x1dd)](),_0x4eb67b=_0x3908b1+'?'+_0x5646d9;if(_0x3908b1['includes'](_0x493131(0x1e7)))return{'url_qrcode':null,'redirectUrl':_0x4eb67b,'channel':_0x4fb5aa,'isRedirect':!![]};else{const _0x4e4e27=await axios_1[_0x493131(0x1cc)]['get'](_0x3908b1,{'params':_0x157315});console[_0x493131(0x17a)](_0x493131(0x116),_0x4e4e27['data']);const {data:{code:_0x5e0f66,msg:_0x321061,qrcode:_0x26716d}}=_0x4e4e27;if(_0x5e0f66!=0x1)throw new common_1[(_0x493131(0x110))](_0x321061,common_1[_0x493131(0x18d)][_0x493131(0x141)]);return{'url_qrcode':_0x26716d,'redirectUrl':null,'channel':_0x4fb5aa,'isRedirect':![]};}}async[_0x56eac7(0x1a8)](_0x7f4845){const _0x3a263c=_0x56eac7,{payEpayPid:_0x193c61,payEpaySecret:_0x48a9ef,payEpayApiQueryUrl:_0x5f4dd1}=await this[_0x3a263c(0x129)][_0x3a263c(0x136)]([_0x3a263c(0x13a),_0x3a263c(0x12a),_0x3a263c(0x155)]),_0x5a04e={};_0x5a04e[_0x3a263c(0x1c2)]=_0x3a263c(0x1c9),_0x5a04e[_0x3a263c(0x1c3)]=_0x7f4845,_0x5a04e[_0x3a263c(0x19a)]=_0x193c61,_0x5a04e[_0x3a263c(0x125)]=_0x48a9ef;const {data:{code:_0x16dcbb,msg:_0x4388ce,data:_0x3e7374}}=await axios_1['default'][_0x3a263c(0x1bb)](_0x5f4dd1,{'params':_0x5a04e});if(_0x16dcbb!=0x1)throw new common_1[(_0x3a263c(0x110))](_0x4388ce,common_1[_0x3a263c(0x18d)][_0x3a263c(0x141)]);return _0x3e7374;}async['notifyMpay'](_0x2a25df){const _0x24d068=_0x56eac7,_0x59796b=_0x2a25df[_0x24d068(0x1d9)];delete _0x2a25df[_0x24d068(0x1d9)],delete _0x2a25df[_0x24d068(0x14a)];const _0x364ff6=await this['globalConfigService'][_0x24d068(0x136)]([_0x24d068(0x173)]);console['log'](_0x24d068(0x133));if(this[_0x24d068(0x1d9)](_0x2a25df,_0x364ff6)!=_0x59796b)return _0x24d068(0x1d4);console['log'](_0x24d068(0x191));const _0x4984b7=await this[_0x24d068(0x13e)][_0x24d068(0x167)]({'where':{'orderId':_0x2a25df['out_trade_no'],'status':0x0}});if(!_0x4984b7)return _0x24d068(0x1d4);const _0x465e13=_0x2a25df[_0x24d068(0x1a5)]==_0x24d068(0x112)?0x1:0x2;console[_0x24d068(0x17a)](_0x24d068(0x1cb),_0x465e13);const _0x2ee765=await this[_0x24d068(0x13e)][_0x24d068(0x120)]({'orderId':_0x2a25df['out_trade_no']},{'status':_0x465e13,'paydAt':(0x0,date_1[_0x24d068(0x1cc)])()[_0x24d068(0x115)]()});_0x465e13===0x1&&await this[_0x24d068(0x18f)][_0x24d068(0x19f)](_0x4984b7);if(_0x2ee765['affected']!=0x1)return _0x24d068(0x1d4);return'success';}async['payMpay'](_0x407af9,_0x86f00,_0x80f207=_0x56eac7(0x1d2)){const _0x548ddb=_0x56eac7,_0x53c489=await this[_0x548ddb(0x13e)][_0x548ddb(0x167)]({'where':{'userId':_0x407af9,'orderId':_0x86f00}});if(!_0x53c489)throw new common_1[(_0x548ddb(0x110))](_0x548ddb(0x10c),common_1[_0x548ddb(0x18d)][_0x548ddb(0x141)]);const _0x32b5c9=await this[_0x548ddb(0x12e)]['findOne']({'where':{'id':_0x53c489['goodsId']}});if(!_0x32b5c9)throw new common_1[(_0x548ddb(0x110))](_0x548ddb(0x11d),common_1['HttpStatus']['BAD_REQUEST']);const {payMpayPid:_0x3deaae,payMpaySecret:_0x4d36c4,payMpayNotifyUrl:_0x17e5c1,payMpayReturnUrl:_0x2628f1,payMpayApiPayUrl:_0x5c8550}=await this['globalConfigService'][_0x548ddb(0x136)]([_0x548ddb(0x15d),_0x548ddb(0x173),_0x548ddb(0x135),_0x548ddb(0x111),_0x548ddb(0x1e4)]),_0x1054f4={};_0x1054f4[_0x548ddb(0x19a)]=Number(_0x3deaae),_0x1054f4['type']=_0x80f207,_0x1054f4['out_trade_no']=_0x86f00,_0x1054f4[_0x548ddb(0x1db)]=_0x32b5c9[_0x548ddb(0x1db)],_0x1054f4[_0x548ddb(0x15e)]=_0x53c489[_0x548ddb(0x12c)],_0x1054f4['notify_url']=_0x17e5c1,_0x1054f4['return_url']=_0x2628f1,_0x1054f4[_0x548ddb(0x1d9)]=this[_0x548ddb(0x1d9)](_0x1054f4,_0x4d36c4),_0x1054f4['sign_type']=_0x548ddb(0x1a1);const _0x5bc8b1=new URLSearchParams(_0x1054f4)[_0x548ddb(0x1dd)](),_0x2fc8d1=_0x5c8550+'?'+_0x5bc8b1;return{'url_qrcode':null,'redirectUrl':_0x2fc8d1,'channel':_0x80f207,'isRedirect':!![]};}async[_0x56eac7(0x19c)](_0xd10fe6){const _0x595e6c=_0x56eac7,{payMpayApiQueryUrl:_0x216d7a}=await this['globalConfigService'][_0x595e6c(0x136)]([_0x595e6c(0x15d),_0x595e6c(0x173),_0x595e6c(0x14d)]),_0x324731={};_0x324731[_0x595e6c(0x19b)]=0x2,_0x324731[_0x595e6c(0x17e)]=_0xd10fe6;const {data:{code:_0x5ca9b9,msg:_0x2c7fbf,data:_0x2ecb65}}=await axios_1[_0x595e6c(0x1cc)]['get'](_0x216d7a,{'params':_0x324731});if(_0x5ca9b9!=0x1)throw new common_1[(_0x595e6c(0x110))](_0x2c7fbf,common_1[_0x595e6c(0x18d)]['BAD_REQUEST']);return _0x2ecb65;}async[_0x56eac7(0x1c0)](_0x46d696){const _0x3e8a22=_0x56eac7;console['log']('微信支付通知params:\x20',_0x46d696);const {payWeChatAppId:_0x5d5838,payWeChatMchId:_0x2854cb,payWeChatSecret:_0x47d881,payWeChatPublicKey:_0x2e5ee7,payWeChatPrivateKey:_0x39821f}=await this['globalConfigService'][_0x3e8a22(0x136)]([_0x3e8a22(0x1e6),'payWeChatMchId',_0x3e8a22(0x134),_0x3e8a22(0x165),_0x3e8a22(0x13c)]),_0x33b8e5=new WxPay({'appid':_0x5d5838,'mchid':_0x2854cb,'publicKey':_0x2e5ee7,'privateKey':_0x39821f});let _0x2f230b;try{if(_0x46d696[_0x3e8a22(0x119)]==_0x3e8a22(0x127)){const {ciphertext:_0x2ad1d8,associated_data:_0x5bb2ab,nonce:_0x5ddce0}=_0x46d696[_0x3e8a22(0x158)],_0x379789=_0x33b8e5['decipher_gcm'](_0x2ad1d8,_0x5bb2ab,_0x5ddce0,_0x47d881),_0x3146a3=_0x379789[_0x3e8a22(0x1c3)];_0x2f230b=redisKey_constant_1['PAY_UPDATE_ORDER']+_0x3146a3,await this[_0x3e8a22(0x131)][_0x3e8a22(0x123)]({'key':_0x2f230b,'val':_0x3e8a22(0x1a3)});const _0x42cd13=await this['orderEntity'][_0x3e8a22(0x167)]({'where':{'orderId':_0x3146a3,'status':0x0}});if(!_0x42cd13)return _0x3e8a22(0x1d4);if([0x1,0x2,0x3][_0x3e8a22(0x193)](_0x42cd13[_0x3e8a22(0x1cd)]))return'success';const _0x56762b=await this['connection'][_0x3e8a22(0x1df)](async _0x536bcd=>{const _0x1bb959=_0x3e8a22,_0x33617e=_0x379789['trade_state']==_0x1bb959(0x1dc)?0x1:0x2,_0x37df33=await this[_0x1bb959(0x13e)][_0x1bb959(0x120)]({'orderId':_0x3146a3},{'status':_0x33617e,'paydAt':(0x0,date_1['default'])()[_0x1bb959(0x115)](),'tradeId':_0x379789[_0x1bb959(0x12b)]});return _0x33617e===0x1&&await this['userBalanceService'][_0x1bb959(0x19f)](_0x42cd13),_0x37df33;});if(_0x56762b['affected']!=0x1)return'failed';}return _0x3e8a22(0x1d0);}catch(_0x1435c8){return console['log'](_0x3e8a22(0x157),_0x1435c8),console['log'](_0x3e8a22(0x144),_0x1435c8),_0x3e8a22(0x1d4);}finally{_0x2f230b&&await this[_0x3e8a22(0x131)][_0x3e8a22(0x118)]({'key':_0x2f230b});}}async[_0x56eac7(0x1af)](_0x5444b3,_0x580675,_0x588404){const _0x14e9a8=_0x56eac7,_0x39f0bc=await this['orderEntity'][_0x14e9a8(0x167)]({'where':{'userId':_0x5444b3,'orderId':_0x580675}});if(!_0x39f0bc)throw new common_1['HttpException'](_0x14e9a8(0x10c),common_1[_0x14e9a8(0x18d)][_0x14e9a8(0x141)]);const _0x54167c=await this[_0x14e9a8(0x12e)]['findOne']({'where':{'id':_0x39f0bc['goodsId']}});if(!_0x54167c)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus'][_0x14e9a8(0x141)]);const _0x40fed9={'bizContent':{'out_trade_no':_0x580675,'total_amount':_0x39f0bc[_0x14e9a8(0x12c)],'subject':_0x54167c[_0x14e9a8(0x1db)]}};let _0x33b6ff,_0x2c685e,_0x20bccb,_0x428644,_0x4f0ad9;const {payAliPublicSecret:_0x4625c4,payAliWebAppId:_0x1ded68,payAliWebSecret:_0x2f4737,payAliAppAppId:_0x251820,payAliAppSecret:_0xd3a69b,payWeChatNotifyUrl:_0x1cda87}=await this[_0x14e9a8(0x129)][_0x14e9a8(0x136)](['payAliPublicSecret',_0x14e9a8(0x185),_0x14e9a8(0x177),_0x14e9a8(0x153),'payAliAppSecret','payWeChatNotifyUrl']);_0x588404===_0x14e9a8(0x14b)&&(_0x40fed9['method']=_0x14e9a8(0x15c),_0x33b6ff=_0x1ded68,_0x20bccb=_0x14e9a8(0x1b3),_0x2c685e=_0x2f4737,_0x428644=_0x14e9a8(0x1cf),_0x4f0ad9=_0x14e9a8(0x11e));_0x588404===_0x14e9a8(0x160)&&(_0x20bccb='sdkExec',_0x33b6ff=_0x251820,_0x2c685e=_0xd3a69b,_0x428644=_0x14e9a8(0x1a4),_0x4f0ad9=_0x14e9a8(0x188));const _0x237c50=new AlipaySdk({'appId':_0x33b6ff,'keyType':_0x14e9a8(0x172),'privateKey':_0x2c685e,'alipayPublicKey':_0x4625c4});_0x40fed9[_0x14e9a8(0x14e)]=_0x1cda87,_0x40fed9[_0x14e9a8(0x16c)]['product_code']=_0x4f0ad9;const _0x1d5b1e=await _0x237c50[_0x20bccb](_0x428644,_0x40fed9);return console['log'](_0x14e9a8(0x149),_0x1d5b1e),_0x588404===_0x14e9a8(0x14b)?{'form':_0x1d5b1e}:{'data':_0x1d5b1e};}async[_0x56eac7(0x1d8)](_0x50c264,_0x3b48c0){const _0x3c50f8=_0x56eac7;let _0x2564ec,_0x211ec0;const {payAliPublicSecret:_0x5b3d17,payAliWebAppId:_0x5d9835,payAliWebSecret:_0x135c4f,payAliAppAppId:_0x5ca5bf,payAliAppSecret:_0x1a8c80,payWeChatNotifyUrl:_0xa289ba}=await this[_0x3c50f8(0x129)][_0x3c50f8(0x136)]([_0x3c50f8(0x16f),_0x3c50f8(0x185),_0x3c50f8(0x177),_0x3c50f8(0x153),_0x3c50f8(0x15b),_0x3c50f8(0x19e)]);_0x3b48c0===_0x3c50f8(0x14b)&&(_0x2564ec=_0x5d9835,_0x211ec0=_0x135c4f);_0x3b48c0==='app'&&(_0x2564ec=_0x5ca5bf,_0x211ec0=_0x1a8c80);const _0x3640a7=new AlipaySdk({'appId':_0x2564ec,'keyType':_0x3c50f8(0x172),'privateKey':_0x211ec0,'alipayPublicKey':_0x5b3d17}),_0x1fdd55=await _0x3640a7[_0x3c50f8(0x170)](_0x3c50f8(0x189),{'bizContent':{'out_trade_no':_0x50c264}});return console[_0x3c50f8(0x17a)](_0x1fdd55),_0x1fdd55;}async[_0x56eac7(0x18a)](_0x3dbc8e,_0x325c6f,_0x21e44d=_0x56eac7(0x14b)){const _0x48b903=_0x56eac7;console['log']('payType:\x20',_0x21e44d);const _0x5cf9fc=await this[_0x48b903(0x13e)][_0x48b903(0x167)]({'where':{'userId':_0x3dbc8e,'orderId':_0x325c6f}});if(!_0x5cf9fc)throw new common_1[(_0x48b903(0x110))](_0x48b903(0x10c),common_1[_0x48b903(0x18d)][_0x48b903(0x141)]);const _0x2e115f=await this[_0x48b903(0x12e)][_0x48b903(0x167)]({'where':{'id':_0x5cf9fc[_0x48b903(0x126)]}});if(!_0x2e115f)throw new common_1[(_0x48b903(0x110))]('套餐不存在!',common_1[_0x48b903(0x18d)][_0x48b903(0x141)]);const {payWeChatAppId:_0x226df6,payWeMiniAppId:_0x5e0105,payWeChatMchId:_0xf594d8,payWeChatPublicKey:_0x977bcc,payWeChatPrivateKey:_0x5d9839,payWeChatNotifyUrl:_0x3c6d87,payWeChatH5Name:_0x487d39,payWeChatH5Url:_0x5bf41c,WE_APP_APPID:_0x39512d,WE_APP_APPSECRET:_0x41eb65}=await this[_0x48b903(0x129)][_0x48b903(0x136)]([_0x48b903(0x1e6),_0x48b903(0x148),_0x48b903(0x1b6),_0x48b903(0x165),_0x48b903(0x13c),_0x48b903(0x19e),_0x48b903(0x12d),_0x48b903(0x197),_0x48b903(0x1e3)]),_0x1cb779=new WxPay({'appid':_0x21e44d===_0x48b903(0x117)?_0x5e0105:_0x226df6,'mchid':_0xf594d8,'publicKey':_0x977bcc,'privateKey':_0x5d9839}),_0x3d7af8={'appid':_0x21e44d===_0x48b903(0x117)?_0x5e0105:_0x226df6,'mchid':_0xf594d8,'description':_0x2e115f['name'],'out_trade_no':_0x325c6f,'notify_url':_0x3c6d87,'amount':{'total':Number(_0x5cf9fc[_0x48b903(0x12c)]*0x64)},'scene_info':{'payer_client_ip':_0x48b903(0x145)}};console[_0x48b903(0x17a)]('wechat-pay:\x20',_0x3d7af8);if(_0x21e44d=='h5'){_0x3d7af8['scene_info']['h5_info']={'type':_0x48b903(0x10d),'app_name':_0x487d39,'app_url':_0x5bf41c};const _0x2e60d9=await _0x1cb779[_0x48b903(0x183)](_0x3d7af8);if(_0x2e60d9[_0x48b903(0x1cd)]===0x193){const _0x133e8a=_0x2e60d9?.['errRaw']?.[_0x48b903(0x10e)]?.['text']?.['message'];throw new common_1[(_0x48b903(0x110))](_0x2e60d9?.[_0x48b903(0x1e0)]||_0x48b903(0x11f),common_1[_0x48b903(0x18d)][_0x48b903(0x141)]);}const {h5_url:_0x22284a}=_0x2e60d9;return{'url':_0x22284a};}if(_0x21e44d===_0x48b903(0x160)){_0x3d7af8[_0x48b903(0x192)]=_0x39512d;const _0x4ba334=await _0x1cb779[_0x48b903(0x1ab)](_0x3d7af8);return console[_0x48b903(0x17a)](_0x48b903(0x187),_0x4ba334),_0x4ba334;}if(_0x21e44d==_0x48b903(0x117)){const _0x49ee91=await this[_0x48b903(0x1a7)][_0x48b903(0x18e)](_0x3dbc8e);_0x3d7af8[_0x48b903(0x1ae)]={'openid':_0x49ee91};const _0x2a3f9f=await _0x1cb779[_0x48b903(0x139)](_0x3d7af8);return console['log'](_0x48b903(0x16a),_0x2a3f9f),_0x2a3f9f;}if(_0x21e44d==_0x48b903(0x1b7)){const _0x166a2b=await this['userService']['getOpenIdByUserId'](_0x3dbc8e);console[_0x48b903(0x17a)](_0x48b903(0x1ac),_0x166a2b),_0x3d7af8[_0x48b903(0x1ae)]={'openid':_0x166a2b};const _0xe8a6b9=await _0x1cb779['transactions_jsapi'](_0x3d7af8);return console[_0x48b903(0x17a)](_0x48b903(0x16a),_0xe8a6b9),_0xe8a6b9;}if(_0x21e44d==_0x48b903(0x14b)){const _0x5c14b1=await _0x1cb779[_0x48b903(0x1bf)](_0x3d7af8),{code_url:_0x1647e2}=_0x5c14b1;return!_0x1647e2&&console[_0x48b903(0x17a)](_0x48b903(0x1e2),_0x5c14b1),{'url_qrcode':_0x1647e2,'isRedirect':![]};}throw new common_1[(_0x48b903(0x110))](_0x48b903(0x16b),common_1[_0x48b903(0x18d)][_0x48b903(0x141)]);}async[_0x56eac7(0x152)](_0x4ee98b,_0x4ee6e7){const _0x19dbe0=_0x56eac7,{payWeChatAppId:_0x268afa,payWeMiniAppId:_0x123f1b,payWeChatMchId:_0x12b3f1,payWeChatPublicKey:_0x1a0cfe,payWeChatPrivateKey:_0xbdfa09}=await this['globalConfigService'][_0x19dbe0(0x136)](['payWeChatAppId',_0x19dbe0(0x148),_0x19dbe0(0x1b6),_0x19dbe0(0x165),_0x19dbe0(0x13c)]),_0x30bd00=new WxPay({'appid':_0x4ee6e7==='mini'?_0x123f1b:_0x268afa,'mchid':_0x12b3f1,'publicKey':_0x1a0cfe,'privateKey':_0xbdfa09}),_0x267dfc=await _0x30bd00[_0x19dbe0(0x159)]({'out_trade_no':_0x4ee98b});return _0x267dfc;}async[_0x56eac7(0x16e)](_0x27c2a7){const _0x2f67e2=_0x56eac7;_0x27c2a7[_0x2f67e2(0x166)]==='wechat'&&await this[_0x2f67e2(0x1a6)](_0x27c2a7);}async['cancelWxOrder'](_0x11ef31){const _0x404cdb=_0x56eac7,{payWeChatAppId:_0x39a639,payWeMiniAppId:_0x460159,payWeChatMchId:_0x366c9b,payWeChatPublicKey:_0x121e14,payWeChatPrivateKey:_0x16e00a}=await this[_0x404cdb(0x129)][_0x404cdb(0x136)]([_0x404cdb(0x1e6),'payWeMiniAppId',_0x404cdb(0x1b6),_0x404cdb(0x165),_0x404cdb(0x13c),_0x404cdb(0x19e),_0x404cdb(0x12d),'payWeChatH5Url']),_0x1ddcd1=new WxPay({'appid':_0x11ef31[_0x404cdb(0x1bd)]===_0x404cdb(0x117)?_0x460159:_0x39a639,'mchid':_0x366c9b,'publicKey':_0x121e14,'privateKey':_0x16e00a});await _0x1ddcd1['close'](_0x11ef31['orderId']);}[_0x56eac7(0x1d9)](_0x41e189,_0xc0d9cb){const _0x3d2140=_0x56eac7,_0x415511=Object[_0x3d2140(0x13b)](_0x41e189)[_0x3d2140(0x17b)]()[_0x3d2140(0x18c)](_0x130bbe=>_0x130bbe+'='+_0x41e189[_0x130bbe])[_0x3d2140(0x146)]('&')+_0xc0d9cb;return crypto[_0x3d2140(0x11c)]('md5')['update'](_0x415511)[_0x3d2140(0x168)]('hex');}};PayService=__decorate([(0x0,common_1[_0x56eac7(0x1d5)])(),__param(0x0,(0x0,typeorm_1[_0x56eac7(0x179)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x56eac7(0x179)])(order_entity_1[_0x56eac7(0x1bc)])),__metadata(_0x56eac7(0x162),[typeorm_2['Repository'],typeorm_2[_0x56eac7(0x184)],userBalance_service_1[_0x56eac7(0x1aa)],globalConfig_service_1[_0x56eac7(0x130)],user_service_1[_0x56eac7(0x16d)],redisCache_service_1[_0x56eac7(0x1b8)],typeorm_2[_0x56eac7(0x1c4)]])],PayService),exports[_0x56eac7(0x1b4)]=PayService;