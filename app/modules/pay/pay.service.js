'use strict';const _0x3f845f=_0x5c9a;(function(_0x20852d,_0x33d100){const _0x20d6ae=_0x5c9a,_0x1dfbcf=_0x20852d();while(!![]){try{const _0x43dd91=-parseInt(_0x20d6ae(0x12b))/0x1+-parseInt(_0x20d6ae(0x19b))/0x2+parseInt(_0x20d6ae(0x1b2))/0x3*(parseInt(_0x20d6ae(0x14f))/0x4)+-parseInt(_0x20d6ae(0x119))/0x5*(parseInt(_0x20d6ae(0x1b4))/0x6)+-parseInt(_0x20d6ae(0x181))/0x7+parseInt(_0x20d6ae(0x18e))/0x8+parseInt(_0x20d6ae(0x1c2))/0x9;if(_0x43dd91===_0x33d100)break;else _0x1dfbcf['push'](_0x1dfbcf['shift']());}catch(_0x2ec344){_0x1dfbcf['push'](_0x1dfbcf['shift']());}}}(_0x4e61,0x29de9));function _0x5c9a(_0x32580f,_0x15d484){const _0x4e61ab=_0x4e61();return _0x5c9a=function(_0x5c9a8f,_0x5c629d){_0x5c9a8f=_0x5c9a8f-0x116;let _0x210233=_0x4e61ab[_0x5c9a8f];return _0x210233;},_0x5c9a(_0x32580f,_0x15d484);}var __decorate=this&&this[_0x3f845f(0x164)]||function(_0x649612,_0x1ea4cf,_0x5b9336,_0x1d8805){const _0x2b4c02=_0x3f845f;var _0x3c3fb0=arguments[_0x2b4c02(0x1d1)],_0x52ca26=_0x3c3fb0<0x3?_0x1ea4cf:_0x1d8805===null?_0x1d8805=Object[_0x2b4c02(0x1ba)](_0x1ea4cf,_0x5b9336):_0x1d8805,_0x5c8ede;if(typeof Reflect===_0x2b4c02(0x1a7)&&typeof Reflect[_0x2b4c02(0x138)]===_0x2b4c02(0x151))_0x52ca26=Reflect[_0x2b4c02(0x138)](_0x649612,_0x1ea4cf,_0x5b9336,_0x1d8805);else{for(var _0x3fb92b=_0x649612[_0x2b4c02(0x1d1)]-0x1;_0x3fb92b>=0x0;_0x3fb92b--)if(_0x5c8ede=_0x649612[_0x3fb92b])_0x52ca26=(_0x3c3fb0<0x3?_0x5c8ede(_0x52ca26):_0x3c3fb0>0x3?_0x5c8ede(_0x1ea4cf,_0x5b9336,_0x52ca26):_0x5c8ede(_0x1ea4cf,_0x5b9336))||_0x52ca26;}return _0x3c3fb0>0x3&&_0x52ca26&&Object['defineProperty'](_0x1ea4cf,_0x5b9336,_0x52ca26),_0x52ca26;},__metadata=this&&this[_0x3f845f(0x137)]||function(_0x28b02d,_0x45e38c){const _0x1b9a08=_0x3f845f;if(typeof Reflect===_0x1b9a08(0x1a7)&&typeof Reflect[_0x1b9a08(0x17a)]===_0x1b9a08(0x151))return Reflect[_0x1b9a08(0x17a)](_0x28b02d,_0x45e38c);},__param=this&&this[_0x3f845f(0x126)]||function(_0x2ca462,_0x30a64d){return function(_0x315167,_0x20bd73){_0x30a64d(_0x315167,_0x20bd73,_0x2ca462);};};function _0x4e61(){const _0x306eb6=['RedisCacheService','update','payAliWebAppId','32UQspDo','transaction_id','function','submit.php','act','connection','appid','payWeChatNotifyUrl','globalConfigService','mini','errRaw','TRANSACTION.SUCCESS','lock','@nestjs/typeorm','wx-native','failed','../user/user.service','payEpayPid','product_code','affected','订单不存在!','__decorate','wechatpay-node-v3','payWeChatMchId','app','unsupported\x20pay\x20type','payHupiSecret','transactions_jsapi','HttpStatus','time','payWeChat','trade_order_id','TRADE_SUCCESS','goodsId','createHash','校验签名通过','../order/order.entity','支付请求失败!','queryWeChat','notify_url','set','typeorm','PayService','metadata','WE_APP_APPID','notifyHupi','message','epay\x20--->\x20res:\x20','epay','__esModule','1911504evqgeJ','notifyEpay','decipher_gcm','payMpayNotifyUrl','onModuleInit','POST','1.1','SUCCESS','sign_type','defineProperty','Repository','method','param','2049960jcPlkM','payWeChatSecret','md5','exec','payEpaySecret','out_trade_order','cramiPackageEntity','order_no','default','QUICK_MSECURITY_PAY','order','keys','pageExec','446638XsiYCv','校验签名','key','payEpayNotifyUrl','payType:\x20','payWeChatH5Name','payHupiNotifyUrl','CramiPackageEntity','attach','套餐不存在!','scene_info','notify','object','title','App支付结果返回值:\x20','money','payWeMiniAppId','setNotifyUrl','toDate','total_fee','payMpayApiQueryUrl','crypto','HttpException','2853WVwgGY','PAY_UPDATE_ORDER','73344KLxLzk','getConfigs','pid','now','UserBalanceService','resource','getOwnPropertyDescriptor','name','orderId','payWeChatAppId','payWeChatPrivateKey','transaction','close','payMpayApiPayUrl','5461326mHzSdK','alipay.trade.app.pay','clientip','hash','device','post','payHupiReturnUrl','payMpaySecret','payEpayReturnUrl','getOpenIdByUserId','createRandomNonceStr','MD5','BAD_REQUEST','del','微信H5支付失败！','length','../redisCache/redisCache.service','log','addBalanceToOrder','type','mpay','join','version','toString','payWeChatH5Url','wxpay','alipay','event_type','native','trade_state','map','wechat','get','FAST_INSTANT_TRADE_PAY','payMpayReturnUrl','微信支付通知params:\x20','用户openId:\x20','../../common/constants/redisKey.constant','../../common/utils/date','payAliAppAppId','out_trade_no','payMpayPid','userBalanceService','payAliAppSecret','sdkExec','response','30szdXKQ','payWeChatPublicKey','payHupiAppId','notifyMpay','text','query','includes','payAli','../userBalance/userBalance.service','total','findOne','queryEpay','sign','__param','payMpay','InjectRepository','OrderEntity','@nestjs/common','129435YZeJdW','payAliWebSecret','payer','cancel','payPlatform','payEpay','return_url','notifyWeChat','redisCacheService','192.168.1.100','orderEntity','Wap','__metadata','decorate','../globalConfig/globalConfig.service','https://api.xunhupay.com/payment/query.html','hupi','userService','nonce_str','design:paramtypes','channel','success','Connection','h5_info','toFixed','alipay\x20result:\x20','支付通知验证失败:\x20','queryMpay','PKCS1','Injectable','UserService','../crami/cramiPackage.entity','cancelWxOrder'];_0x4e61=function(){return _0x306eb6;};return _0x4e61();}Object[_0x3f845f(0x18a)](exports,_0x3f845f(0x180),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x3f845f(0x15c)),typeorm_2=require(_0x3f845f(0x178)),common_1=require(_0x3f845f(0x12a)),crypto=require(_0x3f845f(0x1b0)),axios_1=require('axios'),order_entity_1=require(_0x3f845f(0x173)),cramiPackage_entity_1=require(_0x3f845f(0x14a)),userBalance_service_1=require(_0x3f845f(0x121)),globalConfig_service_1=require(_0x3f845f(0x139)),utils_1=require('../../common/utils'),user_service_1=require(_0x3f845f(0x15f)),redisCache_service_1=require(_0x3f845f(0x1d2)),redisKey_constant_1=require(_0x3f845f(0x1e7)),date_1=require(_0x3f845f(0x1e8)),WxPay=require(_0x3f845f(0x165)),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x13d2d0,_0x59a62e,_0x1e756b,_0x325d43,_0x82789a,_0x25534d,_0x10d17b){const _0x403bc9=_0x3f845f;this[_0x403bc9(0x194)]=_0x13d2d0,this[_0x403bc9(0x135)]=_0x59a62e,this[_0x403bc9(0x1ec)]=_0x1e756b,this[_0x403bc9(0x157)]=_0x325d43,this['userService']=_0x82789a,this[_0x403bc9(0x133)]=_0x25534d,this['connection']=_0x10d17b;}async[_0x3f845f(0x185)](){}async[_0x3f845f(0x1a6)](_0x214df9){const _0x4ccbc8=_0x3f845f;if(_0x214df9[_0x4ccbc8(0x18d)]==_0x4ccbc8(0x17f))return this[_0x4ccbc8(0x182)](_0x214df9);if(_0x214df9[_0x4ccbc8(0x1a3)]==_0x4ccbc8(0x13b))return this['notifyHupi'](_0x214df9);if(typeof _0x214df9['resource']==_0x4ccbc8(0x1a7))return this[_0x4ccbc8(0x132)](_0x214df9);return this[_0x4ccbc8(0x11c)](_0x214df9);}async['pay'](_0x27764d,_0x2f0104,_0x543ebe=_0x3f845f(0x1db)){const _0x57dc56=_0x3f845f,_0xb9e6f6=await this['orderEntity'][_0x57dc56(0x123)]({'where':{'userId':_0x27764d,'orderId':_0x2f0104}});if(!_0xb9e6f6)throw new common_1[(_0x57dc56(0x1b1))](_0x57dc56(0x163),common_1[_0x57dc56(0x16b)][_0x57dc56(0x1ce)]);const _0x35bb9a=await this['cramiPackageEntity']['findOne']({'where':{'id':_0xb9e6f6[_0x57dc56(0x170)]}});if(!_0x35bb9a)throw new common_1[(_0x57dc56(0x1b1))](_0x57dc56(0x1a4),common_1[_0x57dc56(0x16b)][_0x57dc56(0x1ce)]);console[_0x57dc56(0x1d3)]('本次支付类型:\x20',_0xb9e6f6[_0x57dc56(0x12f)]);try{if(_0xb9e6f6[_0x57dc56(0x12f)]==_0x57dc56(0x1dc))return this['payAli'](_0x27764d,_0x2f0104,_0x543ebe);if(_0xb9e6f6['payPlatform']==_0x57dc56(0x1e1))return this[_0x57dc56(0x16d)](_0x27764d,_0x2f0104,_0x543ebe);if(_0xb9e6f6[_0x57dc56(0x12f)]==_0x57dc56(0x17f))return this[_0x57dc56(0x130)](_0x27764d,_0x2f0104,_0x543ebe);if(_0xb9e6f6[_0x57dc56(0x12f)]==_0x57dc56(0x1d6))return this[_0x57dc56(0x127)](_0x27764d,_0x2f0104,_0x543ebe);if(_0xb9e6f6[_0x57dc56(0x12f)]==_0x57dc56(0x13b))return this['payHupi'](_0x27764d,_0x2f0104,_0x543ebe);}catch(_0x52d439){console[_0x57dc56(0x1d3)]('支付请求失败:\x20',_0x52d439);throw new common_1[(_0x57dc56(0x1b1))](_0x57dc56(0x174),common_1[_0x57dc56(0x16b)][_0x57dc56(0x1ce)]);}}async['query'](_0x530fe0){const _0xdaf866=_0x3f845f,_0x59196c=await this[_0xdaf866(0x135)][_0xdaf866(0x123)]({'where':{'orderId':_0x530fe0}});if(!_0x59196c)throw new common_1[(_0xdaf866(0x1b1))](_0xdaf866(0x163),common_1[_0xdaf866(0x16b)][_0xdaf866(0x1ce)]);return _0x59196c;}async[_0x3f845f(0x17c)](_0x1e8133){const _0x1dcca4=_0x3f845f,_0x286efa=await this[_0x1dcca4(0x157)][_0x1dcca4(0x1b5)](['payHupiSecret']),_0x4d2162=_0x1e8133[_0x1dcca4(0x1c5)];delete _0x1e8133[_0x1dcca4(0x1c5)];if(this[_0x1dcca4(0x125)](_0x1e8133,_0x286efa)!=_0x4d2162)return'failed';const _0x598969=await this[_0x1dcca4(0x135)]['findOne']({'where':{'orderId':_0x1e8133[_0x1dcca4(0x16e)],'status':0x0}});if(!_0x598969)return _0x1dcca4(0x15e);await this[_0x1dcca4(0x1ec)][_0x1dcca4(0x1d4)](_0x598969);const _0x14cb58=await this[_0x1dcca4(0x135)][_0x1dcca4(0x14d)]({'orderId':_0x1e8133[_0x1dcca4(0x16e)]},{'status':0x1,'paydAt':(0x0,date_1[_0x1dcca4(0x196)])()[_0x1dcca4(0x1ad)]()});if(_0x14cb58[_0x1dcca4(0x162)]!=0x1)return _0x1dcca4(0x15e);return _0x1dcca4(0x140);}async['payHupi'](_0x3a70f3,_0x24f399,_0x1c8d43=_0x3f845f(0x1db)){const _0x5d6b4d=_0x3f845f,_0x75433a=await this[_0x5d6b4d(0x135)][_0x5d6b4d(0x123)]({'where':{'userId':_0x3a70f3,'orderId':_0x24f399}});if(!_0x75433a)throw new common_1[(_0x5d6b4d(0x1b1))](_0x5d6b4d(0x163),common_1[_0x5d6b4d(0x16b)][_0x5d6b4d(0x1ce)]);const _0x548a0e=await this[_0x5d6b4d(0x194)][_0x5d6b4d(0x123)]({'where':{'id':_0x75433a[_0x5d6b4d(0x170)]}});if(!_0x548a0e)throw new common_1[(_0x5d6b4d(0x1b1))](_0x5d6b4d(0x1a4),common_1[_0x5d6b4d(0x16b)][_0x5d6b4d(0x1ce)]);const {payHupiAppId:_0x5ad2d0,payHupiSecret:_0x2a34b0,payHupiNotifyUrl:_0x5001aa,payHupiReturnUrl:_0x1c5d3b,payHupiGatewayUrl:_0x54b28c}=await this[_0x5d6b4d(0x157)]['getConfigs']([_0x5d6b4d(0x11b),_0x5d6b4d(0x169),_0x5d6b4d(0x1a1),_0x5d6b4d(0x1c8),'payHupiGatewayUrl']),_0x50726c={};_0x50726c[_0x5d6b4d(0x1d8)]=_0x5d6b4d(0x187),_0x50726c[_0x5d6b4d(0x155)]=_0x5ad2d0,_0x50726c[_0x5d6b4d(0x16c)]=(Date[_0x5d6b4d(0x1b7)]()/0x3e8)[_0x5d6b4d(0x143)](0x0),_0x50726c[_0x5d6b4d(0x13d)]=(0x0,utils_1[_0x5d6b4d(0x1cc)])(0x20),_0x50726c[_0x5d6b4d(0x16e)]=_0x24f399,_0x50726c[_0x5d6b4d(0x1a8)]=_0x548a0e[_0x5d6b4d(0x1bb)],_0x50726c[_0x5d6b4d(0x1ae)]=_0x75433a[_0x5d6b4d(0x122)],_0x50726c[_0x5d6b4d(0x176)]=_0x5001aa,_0x50726c[_0x5d6b4d(0x131)]=_0x1c5d3b,_0x50726c[_0x5d6b4d(0x1a3)]='hupi',_0x50726c[_0x5d6b4d(0x1c5)]=this[_0x5d6b4d(0x125)](_0x50726c,_0x2a34b0);const {data:{errcode:_0x1afce0,errmsg:_0xa05a57,url_qrcode:_0x1533a4,url:_0x8f280c}}=await axios_1['default'][_0x5d6b4d(0x1c7)](_0x54b28c||'https://api.xunhupay.com/payment/do.html',_0x50726c);if(_0x1afce0!=0x0)throw new common_1['HttpException'](_0xa05a57,common_1['HttpStatus'][_0x5d6b4d(0x1ce)]);return{'url_qrcode':_0x1533a4,'url':_0x8f280c};}async['queryHupi'](_0x557759){const _0x47e440=_0x3f845f,{payHupiAppId:_0x9682b1,payHupiSecret:_0x3d527e}=await this['globalConfigService'][_0x47e440(0x1b5)]([_0x47e440(0x11b),_0x47e440(0x169)]),_0x462b78={};_0x462b78[_0x47e440(0x1d8)]=_0x47e440(0x187),_0x462b78[_0x47e440(0x155)]=_0x9682b1,_0x462b78[_0x47e440(0x16c)]=(Date[_0x47e440(0x1b7)]()/0x3e8)[_0x47e440(0x143)](0x0),_0x462b78[_0x47e440(0x13d)]=(0x0,utils_1[_0x47e440(0x1cc)])(0x20),_0x462b78[_0x47e440(0x193)]=_0x557759,_0x462b78['hash']=this[_0x47e440(0x125)](_0x462b78,_0x3d527e);const {data:{errcode:_0x544ebb,errmsg:_0x2012d5,data:_0x54bc85}}=await axios_1[_0x47e440(0x196)][_0x47e440(0x1c7)](_0x47e440(0x13a),_0x462b78);if(_0x544ebb!=0x0)throw new common_1[(_0x47e440(0x1b1))](_0x2012d5,common_1['HttpStatus'][_0x47e440(0x1ce)]);return _0x54bc85;}async[_0x3f845f(0x182)](_0x3322e3){const _0x336f88=_0x3f845f,_0x4db327=_0x3322e3[_0x336f88(0x125)];delete _0x3322e3[_0x336f88(0x125)],delete _0x3322e3[_0x336f88(0x189)];const _0x101d2e=await this[_0x336f88(0x157)][_0x336f88(0x1b5)](['payEpaySecret']);if(this[_0x336f88(0x125)](_0x3322e3,_0x101d2e)!=_0x4db327)return _0x336f88(0x15e);console[_0x336f88(0x1d3)]('校验签名通过');const _0x18176d=await this['orderEntity'][_0x336f88(0x123)]({'where':{'orderId':_0x3322e3['out_trade_no'],'status':0x0}});if(!_0x18176d)return _0x336f88(0x15e);const _0x1c485c=_0x3322e3['trade_status']==_0x336f88(0x16f)?0x1:0x2,_0x49113f=await this[_0x336f88(0x135)][_0x336f88(0x14d)]({'orderId':_0x3322e3[_0x336f88(0x1ea)]},{'status':_0x1c485c,'paydAt':(0x0,date_1[_0x336f88(0x196)])()[_0x336f88(0x1ad)]()});_0x1c485c===0x1&&await this[_0x336f88(0x1ec)][_0x336f88(0x1d4)](_0x18176d);if(_0x49113f[_0x336f88(0x162)]!=0x1)return'failed';return _0x336f88(0x140);}async[_0x3f845f(0x130)](_0x2e4524,_0x166103,_0x2a3799=_0x3f845f(0x1dc)){const _0x45d509=_0x3f845f,_0x7f628f=await this[_0x45d509(0x135)][_0x45d509(0x123)]({'where':{'userId':_0x2e4524,'orderId':_0x166103}});if(!_0x7f628f)throw new common_1[(_0x45d509(0x1b1))](_0x45d509(0x163),common_1['HttpStatus'][_0x45d509(0x1ce)]);const _0x3e5fcd=await this[_0x45d509(0x194)][_0x45d509(0x123)]({'where':{'id':_0x7f628f[_0x45d509(0x170)]}});if(!_0x3e5fcd)throw new common_1['HttpException']('套餐不存在!',common_1['HttpStatus']['BAD_REQUEST']);const {payEpayPid:_0x3942fc,payEpaySecret:_0x1cfdb2,payEpayNotifyUrl:_0x232b8a,payEpayReturnUrl:_0x482ea9,payEpayApiPayUrl:_0x15a5bf}=await this[_0x45d509(0x157)][_0x45d509(0x1b5)]([_0x45d509(0x160),_0x45d509(0x192),_0x45d509(0x19e),_0x45d509(0x1ca),'payEpayApiPayUrl']);let _0x547118;_0x3942fc['length']<=0x10?_0x547118=Number(_0x3942fc):_0x547118=BigInt(_0x3942fc);const _0x2329f0={};_0x2329f0[_0x45d509(0x1b6)]=_0x547118,_0x2329f0[_0x45d509(0x1d5)]=_0x2a3799,_0x2329f0[_0x45d509(0x1ea)]=_0x166103,_0x2329f0[_0x45d509(0x1bb)]=_0x3e5fcd[_0x45d509(0x1bb)],_0x2329f0[_0x45d509(0x1aa)]=_0x7f628f[_0x45d509(0x122)],_0x2329f0[_0x45d509(0x1c4)]=_0x45d509(0x134),_0x2329f0[_0x45d509(0x1c6)]='pc',_0x2329f0[_0x45d509(0x176)]=_0x232b8a,_0x2329f0[_0x45d509(0x131)]=_0x482ea9,_0x2329f0[_0x45d509(0x18d)]=_0x45d509(0x17f),_0x2329f0[_0x45d509(0x125)]=this[_0x45d509(0x125)](_0x2329f0,_0x1cfdb2),_0x2329f0[_0x45d509(0x189)]=_0x45d509(0x1cd);const _0x1918e6=new URLSearchParams(_0x2329f0)[_0x45d509(0x1d9)](),_0x235b1c=_0x15a5bf+'?'+_0x1918e6;if(_0x15a5bf[_0x45d509(0x11f)](_0x45d509(0x152)))return{'url_qrcode':null,'redirectUrl':_0x235b1c,'channel':_0x2a3799,'isRedirect':!![]};else{const _0x3e0696=await axios_1[_0x45d509(0x196)][_0x45d509(0x1e2)](_0x15a5bf,{'params':_0x2329f0});console[_0x45d509(0x1d3)](_0x45d509(0x17e),_0x3e0696['data']);const {data:{code:_0x37f64c,msg:_0x343989,qrcode:_0x13718b}}=_0x3e0696;if(_0x37f64c!=0x1)throw new common_1['HttpException'](_0x343989,common_1[_0x45d509(0x16b)]['BAD_REQUEST']);return{'url_qrcode':_0x13718b,'redirectUrl':null,'channel':_0x2a3799,'isRedirect':![]};}}async[_0x3f845f(0x124)](_0x23edc5){const _0x32c109=_0x3f845f,{payEpayPid:_0x208d00,payEpaySecret:_0x3c06b4,payEpayApiQueryUrl:_0x9233d5}=await this[_0x32c109(0x157)]['getConfigs']([_0x32c109(0x160),_0x32c109(0x192),'payEpayApiQueryUrl']),_0x5ae570={};_0x5ae570[_0x32c109(0x153)]=_0x32c109(0x198),_0x5ae570[_0x32c109(0x1ea)]=_0x23edc5,_0x5ae570[_0x32c109(0x1b6)]=_0x208d00,_0x5ae570[_0x32c109(0x19d)]=_0x3c06b4;const {data:{code:_0x1eca68,msg:_0x100c14,data:_0x8c7690}}=await axios_1['default'][_0x32c109(0x1e2)](_0x9233d5,{'params':_0x5ae570});if(_0x1eca68!=0x1)throw new common_1[(_0x32c109(0x1b1))](_0x100c14,common_1['HttpStatus'][_0x32c109(0x1ce)]);return _0x8c7690;}async['notifyMpay'](_0x81ec25){const _0x2aff63=_0x3f845f,_0x41c240=_0x81ec25[_0x2aff63(0x125)];delete _0x81ec25['sign'],delete _0x81ec25[_0x2aff63(0x189)];const _0x920a85=await this['globalConfigService'][_0x2aff63(0x1b5)]([_0x2aff63(0x1c9)]);console[_0x2aff63(0x1d3)](_0x2aff63(0x19c));if(this['sign'](_0x81ec25,_0x920a85)!=_0x41c240)return _0x2aff63(0x15e);console['log'](_0x2aff63(0x172));const _0x5e4cf3=await this['orderEntity']['findOne']({'where':{'orderId':_0x81ec25[_0x2aff63(0x1ea)],'status':0x0}});if(!_0x5e4cf3)return _0x2aff63(0x15e);const _0x4904f2=_0x81ec25['trade_status']==_0x2aff63(0x16f)?0x1:0x2;console[_0x2aff63(0x1d3)]('status:\x20',_0x4904f2);const _0x313b50=await this['orderEntity'][_0x2aff63(0x14d)]({'orderId':_0x81ec25['out_trade_no']},{'status':_0x4904f2,'paydAt':(0x0,date_1['default'])()['toDate']()});_0x4904f2===0x1&&await this[_0x2aff63(0x1ec)][_0x2aff63(0x1d4)](_0x5e4cf3);if(_0x313b50[_0x2aff63(0x162)]!=0x1)return'failed';return _0x2aff63(0x140);}async['payMpay'](_0x1b882b,_0xb23016,_0x1b23d1=_0x3f845f(0x1db)){const _0xd3d2fb=_0x3f845f,_0x3295dd=await this[_0xd3d2fb(0x135)]['findOne']({'where':{'userId':_0x1b882b,'orderId':_0xb23016}});if(!_0x3295dd)throw new common_1[(_0xd3d2fb(0x1b1))](_0xd3d2fb(0x163),common_1['HttpStatus'][_0xd3d2fb(0x1ce)]);const _0x2e9194=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x3295dd['goodsId']}});if(!_0x2e9194)throw new common_1[(_0xd3d2fb(0x1b1))]('套餐不存在!',common_1[_0xd3d2fb(0x16b)][_0xd3d2fb(0x1ce)]);const {payMpayPid:_0x4c772d,payMpaySecret:_0x1baef8,payMpayNotifyUrl:_0x1cbe13,payMpayReturnUrl:_0x5ce420,payMpayApiPayUrl:_0xc33c88}=await this[_0xd3d2fb(0x157)][_0xd3d2fb(0x1b5)](['payMpayPid','payMpaySecret',_0xd3d2fb(0x184),_0xd3d2fb(0x1e4),_0xd3d2fb(0x1c1)]),_0x515cb1={};_0x515cb1[_0xd3d2fb(0x1b6)]=Number(_0x4c772d),_0x515cb1[_0xd3d2fb(0x1d5)]=_0x1b23d1,_0x515cb1[_0xd3d2fb(0x1ea)]=_0xb23016,_0x515cb1['name']=_0x2e9194[_0xd3d2fb(0x1bb)],_0x515cb1[_0xd3d2fb(0x1aa)]=_0x3295dd[_0xd3d2fb(0x122)],_0x515cb1[_0xd3d2fb(0x176)]=_0x1cbe13,_0x515cb1[_0xd3d2fb(0x131)]=_0x5ce420,_0x515cb1['sign']=this[_0xd3d2fb(0x125)](_0x515cb1,_0x1baef8),_0x515cb1['sign_type']=_0xd3d2fb(0x1cd);const _0x5eb1b4=new URLSearchParams(_0x515cb1)['toString'](),_0x4e41ad=_0xc33c88+'?'+_0x5eb1b4;return{'url_qrcode':null,'redirectUrl':_0x4e41ad,'channel':_0x1b23d1,'isRedirect':!![]};}async[_0x3f845f(0x146)](_0x420702){const _0x34b932=_0x3f845f,{payMpayApiQueryUrl:_0x402657}=await this[_0x34b932(0x157)][_0x34b932(0x1b5)]([_0x34b932(0x1eb),_0x34b932(0x1c9),_0x34b932(0x1af)]),_0x4c1482={};_0x4c1482[_0x34b932(0x1d5)]=0x2,_0x4c1482[_0x34b932(0x195)]=_0x420702;const {data:{code:_0x3d6071,msg:_0x5c35a9,data:_0x4f0f01}}=await axios_1['default'][_0x34b932(0x1e2)](_0x402657,{'params':_0x4c1482});if(_0x3d6071!=0x1)throw new common_1[(_0x34b932(0x1b1))](_0x5c35a9,common_1[_0x34b932(0x16b)]['BAD_REQUEST']);return _0x4f0f01;}async[_0x3f845f(0x132)](_0xc5398f){const _0x43d465=_0x3f845f;console[_0x43d465(0x1d3)](_0x43d465(0x1e5),_0xc5398f);const {payWeChatAppId:_0x3b50c5,payWeChatMchId:_0x5aea47,payWeChatSecret:_0x57f22c,payWeChatPublicKey:_0x32cb2e,payWeChatPrivateKey:_0x591125}=await this['globalConfigService'][_0x43d465(0x1b5)]([_0x43d465(0x1bd),_0x43d465(0x166),_0x43d465(0x18f),'payWeChatPublicKey',_0x43d465(0x1be)]),_0x233b1d=new WxPay({'appid':_0x3b50c5,'mchid':_0x5aea47,'publicKey':_0x32cb2e,'privateKey':_0x591125});let _0x74de06;try{if(_0xc5398f[_0x43d465(0x1dd)]==_0x43d465(0x15a)){const {ciphertext:_0x2a2eef,associated_data:_0x211506,nonce:_0x2b23ea}=_0xc5398f[_0x43d465(0x1b9)],_0x7d1d14=_0x233b1d[_0x43d465(0x183)](_0x2a2eef,_0x211506,_0x2b23ea,_0x57f22c),_0x467715=_0x7d1d14['out_trade_no'];_0x74de06=redisKey_constant_1[_0x43d465(0x1b3)]+_0x467715,await this['redisCacheService'][_0x43d465(0x177)]({'key':_0x74de06,'val':_0x43d465(0x15b)});const _0x5a7453=await this[_0x43d465(0x135)]['findOne']({'where':{'orderId':_0x467715,'status':0x0}});if(!_0x5a7453)return _0x43d465(0x15e);if([0x1,0x2,0x3][_0x43d465(0x11f)](_0x5a7453['status']))return'success';const _0x4d65a1=await this[_0x43d465(0x154)][_0x43d465(0x1bf)](async _0x5667a7=>{const _0x18a26f=_0x43d465,_0x1f8866=_0x7d1d14[_0x18a26f(0x1df)]==_0x18a26f(0x188)?0x1:0x2,_0x12e189=await this[_0x18a26f(0x135)][_0x18a26f(0x14d)]({'orderId':_0x467715},{'status':_0x1f8866,'paydAt':(0x0,date_1[_0x18a26f(0x196)])()['toDate'](),'tradeId':_0x7d1d14[_0x18a26f(0x150)]});return _0x1f8866===0x1&&await this[_0x18a26f(0x1ec)][_0x18a26f(0x1d4)](_0x5a7453),_0x12e189;});if(_0x4d65a1[_0x43d465(0x162)]!=0x1)return _0x43d465(0x15e);}return _0x43d465(0x140);}catch(_0x1d086e){return console[_0x43d465(0x1d3)]('error:\x20',_0x1d086e),console[_0x43d465(0x1d3)](_0x43d465(0x145),_0x1d086e),'failed';}finally{_0x74de06&&await this['redisCacheService'][_0x43d465(0x1cf)]({'key':_0x74de06});}}async[_0x3f845f(0x120)](_0x221e95,_0x30405c,_0x468607){const _0x7250f7=_0x3f845f,_0x109aaf=await this[_0x7250f7(0x135)]['findOne']({'where':{'userId':_0x221e95,'orderId':_0x30405c}});if(!_0x109aaf)throw new common_1[(_0x7250f7(0x1b1))]('订单不存在!',common_1[_0x7250f7(0x16b)][_0x7250f7(0x1ce)]);const _0xe9b146=await this['cramiPackageEntity'][_0x7250f7(0x123)]({'where':{'id':_0x109aaf['goodsId']}});if(!_0xe9b146)throw new common_1[(_0x7250f7(0x1b1))]('套餐不存在!',common_1[_0x7250f7(0x16b)][_0x7250f7(0x1ce)]);const _0x14f696={'bizContent':{'out_trade_no':_0x30405c,'total_amount':_0x109aaf[_0x7250f7(0x122)],'subject':_0xe9b146[_0x7250f7(0x1bb)]}};let _0x2ed7e6,_0x372d03,_0x2fe647,_0x1332b2,_0x26079e;const {payAliPublicSecret:_0x34bbf8,payAliWebAppId:_0x518ba4,payAliWebSecret:_0x965a95,payAliAppAppId:_0x33757a,payAliAppSecret:_0x30b062,payWeChatNotifyUrl:_0x50bd81}=await this[_0x7250f7(0x157)][_0x7250f7(0x1b5)](['payAliPublicSecret',_0x7250f7(0x14e),_0x7250f7(0x12c),_0x7250f7(0x1e9),_0x7250f7(0x116),_0x7250f7(0x156)]);_0x468607===_0x7250f7(0x1de)&&(_0x14f696[_0x7250f7(0x18c)]=_0x7250f7(0x186),_0x2ed7e6=_0x518ba4,_0x2fe647=_0x7250f7(0x19a),_0x372d03=_0x965a95,_0x1332b2='alipay.trade.page.pay',_0x26079e=_0x7250f7(0x1e3));_0x468607==='app'&&(_0x2fe647=_0x7250f7(0x117),_0x2ed7e6=_0x33757a,_0x372d03=_0x30b062,_0x1332b2=_0x7250f7(0x1c3),_0x26079e=_0x7250f7(0x197));const _0x518776=new AlipaySdk({'appId':_0x2ed7e6,'keyType':'PKCS1','privateKey':_0x372d03,'alipayPublicKey':_0x34bbf8});_0x14f696[_0x7250f7(0x1ac)]=_0x50bd81,_0x14f696['bizContent'][_0x7250f7(0x161)]=_0x26079e;const _0x575166=await _0x518776[_0x2fe647](_0x1332b2,_0x14f696);return console[_0x7250f7(0x1d3)](_0x7250f7(0x144),_0x575166),_0x468607===_0x7250f7(0x1de)?{'form':_0x575166}:{'data':_0x575166};}async['queryAliPay'](_0x38df48,_0x326a38){const _0x54bb65=_0x3f845f;let _0x3a5b7c,_0x5b5b80;const {payAliPublicSecret:_0x471631,payAliWebAppId:_0x27d16e,payAliWebSecret:_0x2727a8,payAliAppAppId:_0x4ab810,payAliAppSecret:_0x514271,payWeChatNotifyUrl:_0x23ff8e}=await this['globalConfigService'][_0x54bb65(0x1b5)](['payAliPublicSecret',_0x54bb65(0x14e),_0x54bb65(0x12c),_0x54bb65(0x1e9),'payAliAppSecret','payWeChatNotifyUrl']);_0x326a38===_0x54bb65(0x1de)&&(_0x3a5b7c=_0x27d16e,_0x5b5b80=_0x2727a8);_0x326a38==='app'&&(_0x3a5b7c=_0x4ab810,_0x5b5b80=_0x514271);const _0x51dc42=new AlipaySdk({'appId':_0x3a5b7c,'keyType':_0x54bb65(0x147),'privateKey':_0x5b5b80,'alipayPublicKey':_0x471631}),_0x4ea95a=await _0x51dc42[_0x54bb65(0x191)]('alipay.trade.query',{'bizContent':{'out_trade_no':_0x38df48}});return console[_0x54bb65(0x1d3)](_0x4ea95a),_0x4ea95a;}async[_0x3f845f(0x16d)](_0x53509f,_0x5b835b,_0x1e803b=_0x3f845f(0x1de)){const _0x54b6d5=_0x3f845f;console[_0x54b6d5(0x1d3)](_0x54b6d5(0x19f),_0x1e803b);const _0x57dc96=await this[_0x54b6d5(0x135)][_0x54b6d5(0x123)]({'where':{'userId':_0x53509f,'orderId':_0x5b835b}});if(!_0x57dc96)throw new common_1['HttpException']('订单不存在!',common_1[_0x54b6d5(0x16b)][_0x54b6d5(0x1ce)]);const _0x3fa706=await this[_0x54b6d5(0x194)][_0x54b6d5(0x123)]({'where':{'id':_0x57dc96['goodsId']}});if(!_0x3fa706)throw new common_1[(_0x54b6d5(0x1b1))](_0x54b6d5(0x1a4),common_1['HttpStatus'][_0x54b6d5(0x1ce)]);const {payWeChatAppId:_0x496b6e,payWeMiniAppId:_0x291f6a,payWeChatMchId:_0x4c3840,payWeChatPublicKey:_0x44f6b8,payWeChatPrivateKey:_0x4e408e,payWeChatNotifyUrl:_0x3fe43b,payWeChatH5Name:_0x31763a,payWeChatH5Url:_0xe0fef3,WE_APP_APPID:_0x3917a1,WE_APP_APPSECRET:_0x3be706}=await this[_0x54b6d5(0x157)][_0x54b6d5(0x1b5)](['payWeChatAppId',_0x54b6d5(0x1ab),_0x54b6d5(0x166),_0x54b6d5(0x11a),_0x54b6d5(0x1be),_0x54b6d5(0x156),_0x54b6d5(0x1a0),_0x54b6d5(0x1da),_0x54b6d5(0x17b)]),_0xb7a2ae=new WxPay({'appid':_0x1e803b===_0x54b6d5(0x158)?_0x291f6a:_0x496b6e,'mchid':_0x4c3840,'publicKey':_0x44f6b8,'privateKey':_0x4e408e}),_0x3fc9da={'appid':_0x1e803b===_0x54b6d5(0x158)?_0x291f6a:_0x496b6e,'mchid':_0x4c3840,'description':_0x3fa706['name'],'out_trade_no':_0x5b835b,'notify_url':_0x3fe43b,'amount':{'total':Number(_0x57dc96[_0x54b6d5(0x122)]*0x64)},'scene_info':{'payer_client_ip':_0x54b6d5(0x134)}};console[_0x54b6d5(0x1d3)]('wechat-pay:\x20',_0x3fc9da);if(_0x1e803b=='h5'){_0x3fc9da[_0x54b6d5(0x1a5)][_0x54b6d5(0x142)]={'type':_0x54b6d5(0x136),'app_name':_0x31763a,'app_url':_0xe0fef3};const _0xa86547=await _0xb7a2ae['transactions_h5'](_0x3fc9da);if(_0xa86547['status']===0x193){const _0x1526bd=_0xa86547?.[_0x54b6d5(0x159)]?.[_0x54b6d5(0x118)]?.[_0x54b6d5(0x11d)]?.['message'];throw new common_1['HttpException'](_0xa86547?.[_0x54b6d5(0x17d)]||_0x54b6d5(0x1d0),common_1['HttpStatus'][_0x54b6d5(0x1ce)]);}const {h5_url:_0x434bea}=_0xa86547;return{'url':_0x434bea};}if(_0x1e803b===_0x54b6d5(0x167)){_0x3fc9da[_0x54b6d5(0x155)]=_0x3917a1;const _0x23217f=await _0xb7a2ae['transactions_app'](_0x3fc9da);return console[_0x54b6d5(0x1d3)](_0x54b6d5(0x1a9),_0x23217f),_0x23217f;}if(_0x1e803b==_0x54b6d5(0x158)){const _0x393d9a=await this[_0x54b6d5(0x13c)]['getMiniOpenIdByUserId'](_0x53509f);_0x3fc9da[_0x54b6d5(0x12d)]={'openid':_0x393d9a};const _0x3f9285=await _0xb7a2ae['transactions_jsapi'](_0x3fc9da);return console[_0x54b6d5(0x1d3)]('jsapi支付结果返回值:\x20',_0x3f9285),_0x3f9285;}if(_0x1e803b=='jsapi'){const _0x24d2a2=await this[_0x54b6d5(0x13c)][_0x54b6d5(0x1cb)](_0x53509f);console[_0x54b6d5(0x1d3)](_0x54b6d5(0x1e6),_0x24d2a2),_0x3fc9da['payer']={'openid':_0x24d2a2};const _0x78598c=await _0xb7a2ae[_0x54b6d5(0x16a)](_0x3fc9da);return console[_0x54b6d5(0x1d3)]('jsapi支付结果返回值:\x20',_0x78598c),_0x78598c;}if(_0x1e803b==_0x54b6d5(0x1de)){const _0x41bcf4=await _0xb7a2ae['transactions_native'](_0x3fc9da),{code_url:_0x5a7fd1}=_0x41bcf4;return!_0x5a7fd1&&console[_0x54b6d5(0x1d3)](_0x54b6d5(0x15d),_0x41bcf4),{'url_qrcode':_0x5a7fd1,'isRedirect':![]};}throw new common_1[(_0x54b6d5(0x1b1))](_0x54b6d5(0x168),common_1[_0x54b6d5(0x16b)][_0x54b6d5(0x1ce)]);}async[_0x3f845f(0x175)](_0x5f0477,_0x20a48f){const _0x26e48f=_0x3f845f,{payWeChatAppId:_0x26ef12,payWeMiniAppId:_0x29a16e,payWeChatMchId:_0x2cc978,payWeChatPublicKey:_0x5552ae,payWeChatPrivateKey:_0x580e69}=await this['globalConfigService'][_0x26e48f(0x1b5)]([_0x26e48f(0x1bd),_0x26e48f(0x1ab),_0x26e48f(0x166),'payWeChatPublicKey','payWeChatPrivateKey']),_0x555fc6=new WxPay({'appid':_0x20a48f==='mini'?_0x29a16e:_0x26ef12,'mchid':_0x2cc978,'publicKey':_0x5552ae,'privateKey':_0x580e69}),_0x92e298=await _0x555fc6[_0x26e48f(0x11e)]({'out_trade_no':_0x5f0477});return _0x92e298;}async[_0x3f845f(0x12e)](_0x366b9b){const _0x168ae4=_0x3f845f;_0x366b9b[_0x168ae4(0x12f)]===_0x168ae4(0x1e1)&&await this[_0x168ae4(0x14b)](_0x366b9b);}async[_0x3f845f(0x14b)](_0x25bad3){const _0x385c29=_0x3f845f,{payWeChatAppId:_0x2e6493,payWeMiniAppId:_0x5e32b4,payWeChatMchId:_0x19639e,payWeChatPublicKey:_0x437363,payWeChatPrivateKey:_0x4a069c}=await this[_0x385c29(0x157)]['getConfigs']([_0x385c29(0x1bd),_0x385c29(0x1ab),_0x385c29(0x166),_0x385c29(0x11a),'payWeChatPrivateKey','payWeChatNotifyUrl',_0x385c29(0x1a0),_0x385c29(0x1da)]),_0x141909=new WxPay({'appid':_0x25bad3[_0x385c29(0x13f)]===_0x385c29(0x158)?_0x5e32b4:_0x2e6493,'mchid':_0x19639e,'publicKey':_0x437363,'privateKey':_0x4a069c});await _0x141909[_0x385c29(0x1c0)](_0x25bad3[_0x385c29(0x1bc)]);}[_0x3f845f(0x125)](_0x2ee9b0,_0x1e60d0){const _0x5d87c4=_0x3f845f,_0x157821=Object[_0x5d87c4(0x199)](_0x2ee9b0)['sort']()[_0x5d87c4(0x1e0)](_0x5a0942=>_0x5a0942+'='+_0x2ee9b0[_0x5a0942])[_0x5d87c4(0x1d7)]('&')+_0x1e60d0;return crypto[_0x5d87c4(0x171)](_0x5d87c4(0x190))['update'](_0x157821)['digest']('hex');}};PayService=__decorate([(0x0,common_1[_0x3f845f(0x148)])(),__param(0x0,(0x0,typeorm_1[_0x3f845f(0x128)])(cramiPackage_entity_1[_0x3f845f(0x1a2)])),__param(0x1,(0x0,typeorm_1[_0x3f845f(0x128)])(order_entity_1[_0x3f845f(0x129)])),__metadata(_0x3f845f(0x13e),[typeorm_2[_0x3f845f(0x18b)],typeorm_2[_0x3f845f(0x18b)],userBalance_service_1[_0x3f845f(0x1b8)],globalConfig_service_1['GlobalConfigService'],user_service_1[_0x3f845f(0x149)],redisCache_service_1[_0x3f845f(0x14c)],typeorm_2[_0x3f845f(0x141)]])],PayService),exports[_0x3f845f(0x179)]=PayService;