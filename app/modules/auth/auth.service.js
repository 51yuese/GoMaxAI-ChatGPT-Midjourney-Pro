'use strict';const _0xadbd0b=_0x3ccd;(function(_0x1a43f0,_0x5c70fb){const _0x1af3f4=_0x3ccd,_0x4aa553=_0x1a43f0();while(!![]){try{const _0x3085e9=-parseInt(_0x1af3f4(0x19a))/0x1*(parseInt(_0x1af3f4(0x223))/0x2)+-parseInt(_0x1af3f4(0x19d))/0x3+-parseInt(_0x1af3f4(0x1c6))/0x4+-parseInt(_0x1af3f4(0x17f))/0x5+-parseInt(_0x1af3f4(0x1c5))/0x6*(-parseInt(_0x1af3f4(0x214))/0x7)+parseInt(_0x1af3f4(0x19e))/0x8*(parseInt(_0x1af3f4(0x18e))/0x9)+parseInt(_0x1af3f4(0x173))/0xa;if(_0x3085e9===_0x5c70fb)break;else _0x4aa553['push'](_0x4aa553['shift']());}catch(_0x292ebe){_0x4aa553['push'](_0x4aa553['shift']());}}}(_0x5328,0x9689a));var __decorate=this&&this[_0xadbd0b(0x1ff)]||function(_0x429c2b,_0x32b3ea,_0x706f83,_0x109f06){const _0x19f895=_0xadbd0b;var _0x18cb62=arguments[_0x19f895(0x1e4)],_0x179cfb=_0x18cb62<0x3?_0x32b3ea:_0x109f06===null?_0x109f06=Object['getOwnPropertyDescriptor'](_0x32b3ea,_0x706f83):_0x109f06,_0x13a9cb;if(typeof Reflect===_0x19f895(0x195)&&typeof Reflect[_0x19f895(0x1e7)]===_0x19f895(0x20c))_0x179cfb=Reflect[_0x19f895(0x1e7)](_0x429c2b,_0x32b3ea,_0x706f83,_0x109f06);else{for(var _0x12c989=_0x429c2b[_0x19f895(0x1e4)]-0x1;_0x12c989>=0x0;_0x12c989--)if(_0x13a9cb=_0x429c2b[_0x12c989])_0x179cfb=(_0x18cb62<0x3?_0x13a9cb(_0x179cfb):_0x18cb62>0x3?_0x13a9cb(_0x32b3ea,_0x706f83,_0x179cfb):_0x13a9cb(_0x32b3ea,_0x706f83))||_0x179cfb;}return _0x18cb62>0x3&&_0x179cfb&&Object[_0x19f895(0x1bb)](_0x32b3ea,_0x706f83,_0x179cfb),_0x179cfb;},__metadata=this&&this[_0xadbd0b(0x16f)]||function(_0x45b993,_0x366763){const _0x2754e5=_0xadbd0b;if(typeof Reflect===_0x2754e5(0x195)&&typeof Reflect[_0x2754e5(0x224)]===_0x2754e5(0x20c))return Reflect['metadata'](_0x45b993,_0x366763);},__param=this&&this['__param']||function(_0x493b27,_0x28ea86){return function(_0x4eb724,_0x31df38){_0x28ea86(_0x4eb724,_0x31df38,_0x493b27);};};Object['defineProperty'](exports,_0xadbd0b(0x213),{'value':!![]}),exports[_0xadbd0b(0x180)]=void 0x0;const globalConfig_service_1=require(_0xadbd0b(0x16c)),verification_constant_1=require(_0xadbd0b(0x21c)),verification_service_1=require('./../verification/verification.service'),user_entity_1=require(_0xadbd0b(0x1d6)),common_1=require(_0xadbd0b(0x244)),jwt_1=require(_0xadbd0b(0x1bc)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0xadbd0b(0x16e)),user_constant_1=require(_0xadbd0b(0x24b)),utils_1=require(_0xadbd0b(0x1d2)),redisCache_service_1=require(_0xadbd0b(0x191)),svgCaptcha=require('svg-captcha'),bcrypt=require('bcryptjs'),store_1=require(_0xadbd0b(0x1fb)),axios_1=require(_0xadbd0b(0x1c8)),redisKey_constant_1=require(_0xadbd0b(0x1f3)),Login_vo_1=require(_0xadbd0b(0x1f4)),WeAppLogin_vo_1=require('./vo/WeAppLogin.vo'),typeorm_1=require(_0xadbd0b(0x227)),typeorm_2=require(_0xadbd0b(0x232)),nestjs_cls_1=require(_0xadbd0b(0x189)),role_entity_1=require(_0xadbd0b(0x17c)),Role_constant_1=require(_0xadbd0b(0x23a));function _0x3ccd(_0x42a496,_0x242085){const _0x53280b=_0x5328();return _0x3ccd=function(_0x3ccd65,_0x24b905){_0x3ccd65=_0x3ccd65-0x169;let _0x3250bc=_0x53280b[_0x3ccd65];return _0x3250bc;},_0x3ccd(_0x42a496,_0x242085);}function _0x5328(){const _0x2770fc=['WE_APP_APPID','captchaId','weAppOpenId','loginWithWechatApp:\x20','参数错误！','WE_MiNI_APPID','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','default','typeorm','/api/auth/changeEmailSuccess?id=','access_token','access:','WE_MINI_TEMP_USER','registerBaseUrl','#fff','验证码填写错误、请重新输入！','../../common/constants/Role.constant','MailerService','GlobalConfigService','count','createUser','username','NoExist','user','的邮箱验证','registerSuccessEmailTitle','@nestjs/common','WechatConfig','sign','updatePassword','UserStatusEnum','activateAccount','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','../../common/constants/user.constant','账户已被激活过','验证码类型错误','ClsService','../globalConfig/globalConfig.service','hashSync','../mailer/mailer.service','__metadata','&code=','userDefautlAvatar','qureyUserInfoByInviteCode','11960230TiKJFy','shouldAccess','loginByPhoneV3','comparePassword','getNamespace',':PHONECODE:','post','accessLabel','email','../user/role.entity','ChangeEmail','signToken','5032650afgPQy','AuthService','getPhoneInMini','validatePhoneCode','userId','changeEmail','sendEmailCode','miniOpenId','sendPhoneCode','roleEntity','nestjs-cls','邮箱格式错误！','clsService','JwtService','text','160110msjpLk','queryUserInfoById','verifyCode','../redisCache/redisCache.service','errcode','toString','用户名或密码错误！','object','findOne','jwtService','captcha','/api/auth/registerSuccess?id=','3929JvNFSd','原密码不可为空','phone','2707563DoflTt','536NVjLbm','的注册验证','get','邮箱已被其他用户使用','loginInMinigin:\x20','loginV4','globalConfigService','purePhoneNumber','WE_MINI_ACCESS_KEY','data','role','000000','unionid','旧密码错误、请检查提交','&grant_type=authorization_code','authToken','phoneCode','invitedBy','Logger','账号密码或密码错误','compareSync','log','lastLoginIp','registerVerifyExpir','HttpStatusCode','avatar','mailerService','https://api.weixin.qq.com/sns/jscode2session','验证码发送成功、请填写验证码完成注册！','defineProperty','@nestjs/jwt','getJwtToken','registerFailEmailTitle','set','accessToken','VerificationEnum','WeAppLoginVO','getClientIp','角色信息异常！','1308xRQfZq','3400144fyghvC','registerVerifyEmailFrom','axios','BAD_REQUEST','ACTIVE','invitationRewards','GOMAXAI_HOST','saveToken','changeScore4registe','Injectable','用户名格式错误！','password','../../common/utils','InjectRepository','errmsg','registerVerifyEmailDesc','./../user/user.entity','client_credential','EMAIL_REGISTE','design:paramtypes','response','kaifa.qumao518.vip','status','&email=','queryOne','error','save','openid','saas.qumao518.vip','createRandomUid','length','userInitVip','loginInMinigin','decorate','updateEmail','userEntity','验证码已过期、请重新发送！','Repository','@nine.com','UserService','registerSuccessEmaileAppend','bindPhone','getOne','WE_APP_APPSECRET','&registerSuccessEmailTeamName=','../../common/constants/redisKey.constant','./vo/Login.vo','UserStatusErrMsg','test','createRandomCode','ttl','WE_MINI_APPSECRET','phone_info','../../common/store','userService','isVerifyEmail','env','__decorate','bindPhoneInMini','&username=','saasId','openId','redirect','openId、miniOpenId、weAppOpenId中必须存在一个','error:\x20','秒内不得重复发送短信！','AGENT','message','verificationService','UserEntity','function','&registerFailEmailTitle=','registerFailEmailTeamName','phoneWithOpenId4regist','验证码不能为空！','nickname','ERole','__esModule','37772szODlt','emailVerify','当前用户已注册，请勿重复注册！','registerVerifyEmailTitle','redisCacheService','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','loginWithWechatApp','HttpStatus','../../common/constants/verification.constant','HttpException','savaLoginIp','authorization_code','RoleEntity','Registration','registerSuccessEmailTeamName','96tbSVIT','metadata',':CAPTCHA:','/api/auth/registerError?message=','@nestjs/typeorm','getConfigByKeys','getReqSaasId'];_0x5328=function(){return _0x2770fc;};return _0x5328();}let AuthService=class AuthService{constructor(_0x7f0102,_0x12842b,_0x24ea88,_0x36ae03,_0x5cf140,_0x424ae5,_0x4580a5,_0x43058a,_0x63bce0){const _0x8be3e=_0xadbd0b;this[_0x8be3e(0x1e9)]=_0x7f0102,this[_0x8be3e(0x188)]=_0x12842b,this[_0x8be3e(0x18b)]=_0x24ea88,this[_0x8be3e(0x197)]=_0x36ae03,this[_0x8be3e(0x1fc)]=_0x5cf140,this[_0x8be3e(0x1b8)]=_0x424ae5,this['redisCacheService']=_0x4580a5,this[_0x8be3e(0x20a)]=_0x43058a,this['globalConfigService']=_0x63bce0;}[_0xadbd0b(0x17e)](_0x3cf635){const _0x584606=_0xadbd0b,{id:_0xaa528d,username:_0x24604a,role:_0x1e2929,openId:_0x3e23a6,email:_0x39ab68,client:_0x104c09,saasId:_0x919a25}=_0x3cf635;return this[_0x584606(0x197)][_0x584606(0x246)]({'id':_0xaa528d,'username':_0x24604a,'role':_0x1e2929,'openId':_0x3e23a6,'email':_0x39ab68,'client':_0x104c09,'saasId':_0x919a25});}async['loginByAdmin'](_0x3ec69b){const _0x2ee563=_0xadbd0b,{username:_0x551718,password:_0xc08a3e}=_0x3ec69b;if(!_0x551718||!_0xc08a3e)throw new common_1[(_0x2ee563(0x21d))](_0x2ee563(0x1b1),common_1['HttpStatus'][_0x2ee563(0x1c9)]);const _0x3f6990=await this['userService'][_0x2ee563(0x1f0)](_0x551718);if(!_0x3f6990)throw new common_1[(_0x2ee563(0x21d))]('账户不存在，请联系管理员或注册',common_1['HttpStatus'][_0x2ee563(0x1c9)]);if((0x0,utils_1[_0x2ee563(0x176)])(_0xc08a3e,_0x3f6990[_0x2ee563(0x1d1)]))throw new common_1['HttpException']('用户名或密码错误',common_1[_0x2ee563(0x21b)][_0x2ee563(0x1c9)]);return this[_0x2ee563(0x17e)](_0x3f6990);}async[_0xadbd0b(0x184)](_0x1debbc,_0x3ebabc){const _0xea6b73=_0xadbd0b,_0x5431a6=await this['globalConfigService']['getConfigByKeys']([_0xea6b73(0x243),_0xea6b73(0x222),_0xea6b73(0x1ee),_0xea6b73(0x1be),_0xea6b73(0x20e)]);try{const _0x5303e9=await this['verificationService'][_0xea6b73(0x190)](_0x1debbc,verification_constant_1['VerificationEnum'][_0xea6b73(0x17d)]),{type:_0x3c7e91,userId:_0x43fa7f}=_0x5303e9;if(_0x3c7e91!==verification_constant_1['VerificationEnum'][_0xea6b73(0x17d)])throw new common_1[(_0xea6b73(0x21d))](_0xea6b73(0x16a),common_1[_0xea6b73(0x21b)][_0xea6b73(0x1c9)]);let _0x58dda5=await this[_0xea6b73(0x1e9)]['findOne']({'where':{'id':_0x43fa7f}});_0x58dda5['email']=_0x1debbc['email'],_0x58dda5=await this['userEntity'][_0xea6b73(0x1e0)](_0x58dda5);const {id:_0x35d7c5,username:_0x1f418d,email:_0x22f741}=_0x58dda5;_0x3ebabc[_0xea6b73(0x204)](_0xea6b73(0x233)+_0x35d7c5[_0xea6b73(0x193)]()['padStart'](0x4,'0')+_0xea6b73(0x201)+_0x1f418d+_0xea6b73(0x1dd)+_0x22f741+'&registerSuccessEmailTitle='+_0x5431a6['registerSuccessEmailTitle']+_0xea6b73(0x1f2)+_0x5431a6[_0xea6b73(0x222)]+'&registerSuccessEmaileAppend='+_0x5431a6[_0xea6b73(0x1ee)]);}catch(_0x432632){const _0x3a13c9=_0x432632['response'];_0x3ebabc['redirect'](_0xea6b73(0x226)+_0x3a13c9+_0xea6b73(0x20d)+_0x5431a6[_0xea6b73(0x1be)]+'&registerFailEmailTeamName='+_0x5431a6[_0xea6b73(0x20e)]);}}async[_0xadbd0b(0x198)](_0x3ecba5){const _0x1b9cc3=_0xadbd0b,_0x56f81b=await this[_0x1b9cc3(0x1a4)][_0x1b9cc3(0x177)](),{color:color=_0x1b9cc3(0x238)}=_0x3ecba5,_0x1435fe=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x3e624a=_0x1435fe[_0x1b9cc3(0x18d)],_0x47b2c0=(0x0,utils_1[_0x1b9cc3(0x1e3)])(),_0x3d767b=_0x56f81b+_0x1b9cc3(0x225)+_0x47b2c0;return await this[_0x1b9cc3(0x218)][_0x1b9cc3(0x1bf)]({'key':_0x3d767b,'val':_0x1435fe['text']},0x5*0x3c),{'svgCode':_0x1435fe[_0x1b9cc3(0x1a7)],'code':_0x47b2c0};}async[_0xadbd0b(0x187)](_0x3c394c){const _0x48bcae=_0xadbd0b;_0x3c394c[_0x48bcae(0x22b)]&&await this['verificationService']['verifyCaptcha'](_0x3c394c);const {phone:_0x3a70c7}=_0x3c394c,_0x668709=await this[_0x48bcae(0x1a4)][_0x48bcae(0x177)](),_0xa40899=_0x668709+_0x48bcae(0x178)+_0x3a70c7,_0x12fdfe=await this[_0x48bcae(0x218)][_0x48bcae(0x1f8)](_0xa40899);if(_0x12fdfe&&_0x12fdfe>0x0)throw new common_1[(_0x48bcae(0x21d))](_0x12fdfe+_0x48bcae(0x207),common_1[_0x48bcae(0x21b)][_0x48bcae(0x1c9)]);const _0x21c278=(0x0,utils_1['createRandomCode'])(),_0x542089={'phone':_0x3a70c7,'code':_0x21c278};return await this[_0x48bcae(0x20a)][_0x48bcae(0x187)](_0x542089),await this['redisCacheService'][_0x48bcae(0x1bf)]({'key':_0xa40899,'val':_0x21c278},0x1*0x3c),_0x48bcae(0x1ba);}async[_0xadbd0b(0x185)](_0x69af76){const _0x380727=_0xadbd0b;try{var _0x18b212=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x18b212['test'](_0x69af76))throw new Error(_0x380727(0x18a));const _0xf74d6f=await this[_0x380727(0x1e9)][_0x380727(0x196)]({'where':{'email':_0x69af76}});if(_0xf74d6f)throw new Error('该邮箱已注册！');const _0x34127b=await this[_0x380727(0x1a4)][_0x380727(0x228)]([_0x380727(0x237),_0x380727(0x217),_0x380727(0x1d5),_0x380727(0x1c7),_0x380727(0x1b5)]),_0x96ae2b=(0x0,utils_1[_0x380727(0x1f7)])(),_0x740167=_0x34127b[_0x380727(0x1b5)]?Number(_0x34127b[_0x380727(0x1b5)]):0x1e*0x3c;await this['redisCacheService'][_0x380727(0x1bf)]({'key':redisKey_constant_1[_0x380727(0x1d8)]+_0x69af76,'val':_0x96ae2b},_0x740167*0x3c),await this['mailerService']['sendMail']({'to':_0x69af76,'template':_0x380727(0x215),'subject':'来自'+_0x34127b[_0x380727(0x1c7)]+_0x380727(0x19f),'context':{'baseUrl':_0x34127b[_0x380727(0x237)],'code':_0x96ae2b,..._0x34127b}});}catch(_0x29272d){throw new common_1[(_0x380727(0x21d))](_0x29272d[_0x380727(0x209)],common_1[_0x380727(0x21b)][_0x380727(0x1c9)]);}}async[_0xadbd0b(0x181)](_0x1b6540){const _0x529b79=_0xadbd0b;try{const _0x40022d=await this[_0x529b79(0x218)][_0x529b79(0x1a0)]({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY']}),_0x1676c2=await axios_1['default'][_0x529b79(0x179)](_0x529b79(0x230)+_0x40022d,{'code':_0x1b6540});if(_0x1676c2['data']['errcode'])throw new Error(_0x1676c2['data'][_0x529b79(0x1d4)]);return _0x1676c2['data'][_0x529b79(0x1fa)][_0x529b79(0x1a5)];}catch(_0x5f4cba){common_1[_0x529b79(0x1b0)][_0x529b79(0x1df)]('getPhoneInMini:\x20',_0x5f4cba);throw new common_1[(_0x529b79(0x21d))](_0x5f4cba['message'],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0xadbd0b(0x200)](_0x52a646,_0x340aa8){const _0x16b97b=_0xadbd0b,_0x4964f3=await this[_0x16b97b(0x181)](_0x52a646),_0x50bd93=await this[_0x16b97b(0x1e9)][_0x16b97b(0x196)]({'where':{'id':_0x340aa8[_0x16b97b(0x241)]['id']}});if(!_0x50bd93)throw new common_1[(_0x16b97b(0x21d))](_0x16b97b(0x240),common_1[_0x16b97b(0x21b)]['BAD_REQUEST']);return _0x50bd93['phone']=_0x4964f3,this[_0x16b97b(0x1e9)][_0x16b97b(0x1e0)](_0x50bd93),_0x4964f3;}async[_0xadbd0b(0x20f)](_0x273524){const _0x15569a=_0xadbd0b;try{if(!_0x273524[_0x15569a(0x203)]&&!_0x273524['miniOpenId']&&!_0x273524['weAppOpenId'])throw new Error(_0x15569a(0x205));let _0x78ec81='openId',_0x24ebd1={};if(_0x273524[_0x15569a(0x203)])_0x78ec81=_0x15569a(0x203);else _0x273524[_0x15569a(0x186)]?_0x78ec81=_0x15569a(0x186):_0x78ec81='weAppOpenId';_0x24ebd1[_0x78ec81]=_0x273524[_0x78ec81];const _0x1e86cc=await this[_0x15569a(0x1e9)][_0x15569a(0x196)]({'where':_0x24ebd1});if(_0x1e86cc&&_0x1e86cc[_0x15569a(0x19c)])return![];const _0x21e8bf=await this[_0x15569a(0x1e9)]['findOne']({'where':{'phone':_0x273524['phone']}});if(_0x21e8bf)return!_0x21e8bf[_0x78ec81];return!![];}catch(_0xe7aae8){throw new common_1['HttpException'](_0xe7aae8[_0x15569a(0x209)],common_1[_0x15569a(0x21b)][_0x15569a(0x1c9)]);}}async['registeV3'](_0x58df03,_0xccbe9f){const _0x12d4b5=_0xadbd0b,_0x702b18=(0x0,utils_1[_0x12d4b5(0x229)])(this[_0x12d4b5(0x18b)]);try{if(_0x58df03[_0x12d4b5(0x23f)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x12d4b5(0x1f6)](_0x58df03[_0x12d4b5(0x23f)]))throw new Error(_0x12d4b5(0x1d0));if(!_0x58df03[_0x12d4b5(0x1d1)])throw new Error('账号注册时密码不能为空！');}else{if(!_0x58df03[_0x12d4b5(0x203)]&&!_0x58df03[_0x12d4b5(0x186)]&&!_0x58df03[_0x12d4b5(0x22c)])throw new Error(_0x12d4b5(0x22e));}if(_0x58df03[_0x12d4b5(0x19c)]&&!_0x58df03[_0x12d4b5(0x1ae)])throw new Error(_0x12d4b5(0x210));let _0x4809cf=null;if(_0x58df03[_0x12d4b5(0x19c)])await this['validatePhoneCode'](_0x58df03['phone'],_0x58df03['phoneCode']),_0x4809cf=await this[_0x12d4b5(0x1e9)][_0x12d4b5(0x196)]({'where':{'phone':_0x58df03['phone'],'saasId':_0x702b18}});else{if(_0x58df03[_0x12d4b5(0x203)]||_0x58df03[_0x12d4b5(0x186)]||_0x58df03['weAppOpenId']){let _0x102c39=_0x12d4b5(0x203),_0x2126a9={'saasId':_0x702b18};if(_0x58df03['openId'])_0x102c39=_0x12d4b5(0x203);else _0x58df03['miniOpenId']?_0x102c39=_0x12d4b5(0x186):_0x102c39=_0x12d4b5(0x22c);_0x2126a9[_0x102c39]=_0x58df03[_0x102c39],_0x4809cf=await this['userEntity'][_0x12d4b5(0x196)]({'where':_0x2126a9});if(_0x4809cf)throw new Error(_0x12d4b5(0x216));}else{_0x4809cf=await this[_0x12d4b5(0x1e9)]['findOne']({'where':{'username':_0x58df03[_0x12d4b5(0x23f)],'saasId':_0x702b18}});if(_0x4809cf)throw new Error(_0x12d4b5(0x216));}}const _0x2137ba=new user_entity_1[(_0x12d4b5(0x20b))]();for(let _0x47a281 in _0x58df03){_0x58df03[_0x47a281]&&(_0x2137ba[_0x47a281]=_0x58df03[_0x47a281]);}_0x4809cf?_0x2137ba['id']=_0x4809cf['id']:(_0x2137ba['password']&&(_0x2137ba[_0x12d4b5(0x1d1)]=bcrypt[_0x12d4b5(0x16d)](_0x58df03[_0x12d4b5(0x1d1)],0xa)),_0x2137ba[_0x12d4b5(0x1dc)]=user_constant_1[_0x12d4b5(0x248)]['ACTIVE'],!_0x2137ba['nickname']&&(_0x2137ba[_0x12d4b5(0x211)]=_0x2137ba[_0x12d4b5(0x211)]||'小智'),!_0x2137ba[_0x12d4b5(0x1b7)]&&(_0x2137ba[_0x12d4b5(0x1b7)]=await this[_0x12d4b5(0x1a4)]['getConfigByKeys']([_0x12d4b5(0x171)])));_0x2137ba[_0x12d4b5(0x202)]=_0x702b18;const _0xabdc5d=await this[_0x12d4b5(0x1fc)][_0x12d4b5(0x23e)](_0x2137ba);!_0x4809cf&&this[_0x12d4b5(0x1cb)](_0xabdc5d,_0x58df03[_0x12d4b5(0x1af)]);const _0x56ee00=(0x0,utils_1[_0x12d4b5(0x1c3)])(_0xccbe9f),_0x56b17e=this[_0x12d4b5(0x17e)](_0xabdc5d);return await this[_0x12d4b5(0x1fc)]['savaLoginIp'](_0xabdc5d['id'],_0x56ee00),await this['redisCacheService']['saveToken'](_0xabdc5d['id'],_0x56b17e),_0x56b17e;}catch(_0x502424){if(_0x502424 instanceof common_1[_0x12d4b5(0x21d)])throw _0x502424;else throw new common_1[(_0x12d4b5(0x21d))](_0x502424['message'],common_1[_0x12d4b5(0x21b)][_0x12d4b5(0x1c9)]);}}async[_0xadbd0b(0x175)](_0x34af57,_0x576ec4){const _0x4d417c=_0xadbd0b,_0x162be5=(0x0,utils_1[_0x4d417c(0x229)])(this[_0x4d417c(0x18b)]);await this['validatePhoneCode'](_0x34af57[_0x4d417c(0x19c)],_0x34af57['phoneCode']);let _0x5323ba=await this[_0x4d417c(0x1e9)][_0x4d417c(0x196)]({'where':{'phone':_0x34af57['phone'],'saasId':_0x162be5}});if(!_0x5323ba){const _0xf080eb=new user_entity_1[(_0x4d417c(0x20b))]();_0xf080eb[_0x4d417c(0x19c)]=_0x34af57[_0x4d417c(0x19c)],_0xf080eb['nickname']=_0x34af57['phone'],_0xf080eb['status']=user_constant_1[_0x4d417c(0x248)][_0x4d417c(0x1ca)],_0xf080eb[_0x4d417c(0x1b7)]=await this['globalConfigService']['getConfigByKeys'](['userDefautlAvatar']),_0x5323ba=await this['userService'][_0x4d417c(0x23e)](_0xf080eb),this[_0x4d417c(0x1cb)](_0x5323ba,_0x34af57['invitedBy']);}const _0x3f48d0=(0x0,utils_1[_0x4d417c(0x1c3)])(_0x576ec4),_0x1061d5=this[_0x4d417c(0x17e)](_0x5323ba);return await this[_0x4d417c(0x1fc)][_0x4d417c(0x21e)](_0x5323ba['id'],_0x3f48d0),await this['redisCacheService'][_0x4d417c(0x1cd)](_0x5323ba['id'],_0x1061d5),_0x1061d5;}async[_0xadbd0b(0x1a3)](_0x58968e,_0x27c608){const _0x5438c9=_0xadbd0b;try{const _0x51eafd=(0x0,utils_1[_0x5438c9(0x229)])(this[_0x5438c9(0x18b)]),_0x479d2f=await this[_0x5438c9(0x1e9)]['findOne']({'where':[{'username':_0x58968e[_0x5438c9(0x23f)],'saasId':_0x51eafd},{'email':_0x58968e['username'],'saasId':_0x51eafd},{'phone':_0x58968e[_0x5438c9(0x23f)],'saasId':_0x51eafd}]});if(!_0x479d2f)throw new Error(_0x5438c9(0x194));if(!_0x479d2f[_0x5438c9(0x1d1)])throw new Error('用户名或密码错误！');if(!bcrypt[_0x5438c9(0x1b2)](_0x58968e['password'],_0x479d2f['password']))throw new Error(_0x5438c9(0x194));_0x479d2f[_0x5438c9(0x23f)]&&!_0x479d2f[_0x5438c9(0x1b4)]&&await this[_0x5438c9(0x1fc)][_0x5438c9(0x1e5)](_0x479d2f);const _0x2dcfd5=(0x0,utils_1[_0x5438c9(0x1c3)])(_0x27c608),_0xc41679=this[_0x5438c9(0x17e)](_0x479d2f);await this[_0x5438c9(0x1fc)][_0x5438c9(0x21e)](_0x479d2f['id'],_0x2dcfd5),await this[_0x5438c9(0x218)][_0x5438c9(0x1cd)](_0x479d2f['id'],_0xc41679);if((0x0,utils_1[_0x5438c9(0x174)])(_0x479d2f[_0x5438c9(0x1a8)])){let _0x274380;_0x479d2f['role']===Role_constant_1[_0x5438c9(0x212)][_0x5438c9(0x208)]?_0x274380=await this[_0x5438c9(0x188)]['findOne']({'where':{'code':_0x479d2f['role']}}):_0x274380=await this[_0x5438c9(0x188)]['findOne']({'where':{'code':_0x479d2f['role'],'saasId':_0x51eafd}});if(!_0x274380)throw new Error(_0x5438c9(0x1c4));await this[_0x5438c9(0x218)][_0x5438c9(0x1bf)]({'key':_0x5438c9(0x235)+_0x479d2f['id'],'val':_0x274380[_0x5438c9(0x17a)]});}return _0xc41679;}catch(_0x34a2fd){throw new common_1[(_0x5438c9(0x21d))](_0x34a2fd['message'],common_1[_0x5438c9(0x21b)][_0x5438c9(0x1c9)]);}}async[_0xadbd0b(0x1e6)](_0x3f2dd2){const _0x30abdc=_0xadbd0b;try{const _0x436b21=new Login_vo_1[(_0x30abdc(0x231))](),_0x3aa133=(0x0,utils_1[_0x30abdc(0x229)])(this[_0x30abdc(0x18b)]),_0x31c775=await axios_1[_0x30abdc(0x231)]['get'](_0x30abdc(0x1b9),{'params':{'appid':store_1[_0x30abdc(0x245)][_0x30abdc(0x22f)],'secret':store_1[_0x30abdc(0x245)]['WE_MINI_APPSECRET'],'js_code':_0x3f2dd2,'grant_type':_0x30abdc(0x21f)}}),_0x2bc932=_0x31c775[_0x30abdc(0x1a7)];if(_0x2bc932['errcode'])throw new Error(_0x2bc932[_0x30abdc(0x1d4)]);const _0x412914=await this[_0x30abdc(0x1e9)]['findOne']({'where':{'miniOpenId':_0x2bc932[_0x30abdc(0x1e1)],'saasId':_0x3aa133}});return!_0x412914?this[_0x30abdc(0x218)][_0x30abdc(0x1bf)]({'key':redisKey_constant_1[_0x30abdc(0x236)]+_0x2bc932[_0x30abdc(0x1e1)],'val':_0x2bc932[_0x30abdc(0x1aa)]||null}):(_0x436b21[_0x30abdc(0x1ad)]=this[_0x30abdc(0x17e)](_0x412914),await this[_0x30abdc(0x218)][_0x30abdc(0x1cd)](_0x412914['id'],_0x436b21[_0x30abdc(0x1ad)])),_0x436b21['unionid']=_0x2bc932[_0x30abdc(0x1aa)],_0x436b21[_0x30abdc(0x1e1)]=_0x2bc932['openid'],_0x436b21;}catch(_0xf36340){common_1[_0x30abdc(0x1b0)][_0x30abdc(0x1df)](_0x30abdc(0x1a2),_0xf36340);throw new common_1[(_0x30abdc(0x21d))](_0xf36340[_0x30abdc(0x209)],common_1[_0x30abdc(0x21b)]['BAD_REQUEST']);}}async[_0xadbd0b(0x21a)](_0x1a7e8d){const _0x332a4f=_0xadbd0b,_0x36e09c=new WeAppLogin_vo_1[(_0x332a4f(0x1c2))](),_0x3d92d5=(0x0,utils_1[_0x332a4f(0x229)])(this[_0x332a4f(0x18b)]);try{const _0x2503f0=await axios_1[_0x332a4f(0x231)][_0x332a4f(0x1a0)](_0x332a4f(0x219)+store_1[_0x332a4f(0x245)][_0x332a4f(0x22a)]+'&secret='+store_1[_0x332a4f(0x245)][_0x332a4f(0x1f1)]+_0x332a4f(0x170)+_0x1a7e8d+_0x332a4f(0x1ac));if(_0x2503f0['data'][_0x332a4f(0x192)])throw new Error(_0x2503f0[_0x332a4f(0x1a7)][_0x332a4f(0x1d4)]);const _0x38d409=_0x2503f0['data'],_0x40b93e=await this[_0x332a4f(0x1e9)][_0x332a4f(0x196)]({'where':{'weAppOpenId':_0x38d409[_0x332a4f(0x1e1)],'saasId':_0x3d92d5}});return!_0x40b93e?this['redisCacheService'][_0x332a4f(0x1bf)]({'key':redisKey_constant_1['WE_APP_TEMP_USER']+_0x38d409[_0x332a4f(0x1e1)],'val':_0x38d409[_0x332a4f(0x1aa)]||null}):(_0x36e09c[_0x332a4f(0x1ad)]=this[_0x332a4f(0x17e)](_0x40b93e),await this[_0x332a4f(0x218)][_0x332a4f(0x1cd)](_0x40b93e['id'],_0x36e09c[_0x332a4f(0x1ad)])),_0x36e09c[_0x332a4f(0x1e1)]=_0x38d409[_0x332a4f(0x1e1)],_0x36e09c[_0x332a4f(0x1aa)]=_0x38d409[_0x332a4f(0x1aa)],_0x36e09c[_0x332a4f(0x1c0)]=_0x38d409[_0x332a4f(0x234)],_0x36e09c;}catch(_0x29599f){common_1[_0x332a4f(0x1b0)][_0x332a4f(0x1df)](_0x332a4f(0x22d),_0x29599f);throw new common_1[(_0x332a4f(0x21d))](_0x29599f[_0x332a4f(0x209)],common_1[_0x332a4f(0x21b)][_0x332a4f(0x1c9)]);}}async[_0xadbd0b(0x249)](_0x81b3ff,_0x514c0e){const _0x10073d=_0xadbd0b,_0x30c25f=await this[_0x10073d(0x1a4)][_0x10073d(0x228)]([_0x10073d(0x243),'registerSuccessEmailTeamName',_0x10073d(0x1ee),_0x10073d(0x1be),'registerFailEmailTeamName']);try{const _0x584690=await this[_0x10073d(0x20a)][_0x10073d(0x190)](_0x81b3ff,verification_constant_1[_0x10073d(0x1c1)][_0x10073d(0x221)]),{type:_0x550aab,userId:_0x3f8ebb}=_0x584690;if(_0x550aab!==verification_constant_1['VerificationEnum'][_0x10073d(0x221)])throw new common_1[(_0x10073d(0x21d))](_0x10073d(0x16a),common_1[_0x10073d(0x21b)]['BAD_REQUEST']);const _0x48d202=await this['userService']['getUserStatus'](_0x3f8ebb);if(_0x48d202===user_constant_1[_0x10073d(0x248)][_0x10073d(0x1ca)])throw new common_1[(_0x10073d(0x21d))](_0x10073d(0x169),common_1[_0x10073d(0x21b)][_0x10073d(0x1c9)]);await this[_0x10073d(0x1fc)]['updateUserStatus'](_0x584690['userId'],user_constant_1[_0x10073d(0x248)][_0x10073d(0x1ca)]);const _0x327680=await this[_0x10073d(0x1fc)][_0x10073d(0x18f)](_0x584690[_0x10073d(0x183)]),{username:_0x50c6bb,email:_0x44d4b9,id:_0x2f86b2,invitedBy:_0x59fbca}=_0x327680;let _0x40a49;_0x59fbca&&(_0x40a49=await this['userService'][_0x10073d(0x172)](_0x59fbca)),await this['userService'][_0x10073d(0x1ce)](_0x327680,_0x40a49),_0x514c0e[_0x10073d(0x204)](_0x10073d(0x199)+_0x2f86b2[_0x10073d(0x193)]()['padStart'](0x4,'0')+_0x10073d(0x201)+_0x50c6bb+_0x10073d(0x1dd)+_0x44d4b9+'&registerSuccessEmailTitle='+_0x30c25f[_0x10073d(0x243)]+_0x10073d(0x1f2)+_0x30c25f[_0x10073d(0x222)]+'&registerSuccessEmaileAppend='+_0x30c25f['registerSuccessEmaileAppend']);}catch(_0x522b4d){console[_0x10073d(0x1b3)](_0x10073d(0x206),_0x522b4d);const _0x625440=_0x522b4d[_0x10073d(0x1da)];_0x514c0e[_0x10073d(0x204)](_0x10073d(0x226)+_0x625440+_0x10073d(0x20d)+_0x30c25f[_0x10073d(0x1be)]+'&registerFailEmailTeamName='+_0x30c25f[_0x10073d(0x20e)]);}}async['getInfo'](_0x575488){const _0x2f924a=_0xadbd0b,_0x390354=await this[_0x2f924a(0x1fc)][_0x2f924a(0x1de)]({'id':_0x575488['user']['id']});return{'userInfo':_0x390354};}async[_0xadbd0b(0x247)](_0xd5c0c2,_0x224f07){const _0x5a131a=_0xadbd0b,{id:_0x464521,client:_0x2cd3c6}=_0xd5c0c2[_0x5a131a(0x241)];if(_0x2cd3c6&&Number(_0x2cd3c6)>0x0)throw new common_1[(_0x5a131a(0x21d))]('无权此操作、请联系管理员！',common_1[_0x5a131a(0x21b)]['BAD_REQUEST']);const {oldPassword:_0x8034c4,password:_0x5b661c}=_0x224f07,_0x25a4d4=await this[_0x5a131a(0x1e9)][_0x5a131a(0x196)]({'where':{'id':_0x464521}});if(_0x25a4d4['password']){if(!_0x8034c4)throw new common_1[(_0x5a131a(0x21d))](_0x5a131a(0x19b),common_1[_0x5a131a(0x21b)][_0x5a131a(0x1c9)]);const _0xeb2460=bcrypt['compareSync'](_0x8034c4,_0x25a4d4[_0x5a131a(0x1d1)]);if(!_0xeb2460)throw new common_1[(_0x5a131a(0x21d))](_0x5a131a(0x1ab),common_1[_0x5a131a(0x21b)][_0x5a131a(0x1c9)]);}return _0x25a4d4['password']=bcrypt[_0x5a131a(0x16d)](_0x5b661c,0xa),await this[_0x5a131a(0x1e9)][_0x5a131a(0x1e0)](_0x25a4d4),'密码修改成功';}async[_0xadbd0b(0x1e8)](_0x5382d5,_0x4458e9){const _0xb366e3=_0xadbd0b,_0x58f7f5=_0x5382d5[_0xb366e3(0x241)]['id'],_0x4917f0=await this[_0xb366e3(0x1e9)][_0xb366e3(0x196)]({'where':{'email':_0x4458e9[_0xb366e3(0x17b)]}});if(_0x4917f0)throw new common_1[(_0xb366e3(0x21d))](_0xb366e3(0x1a1),axios_1[_0xb366e3(0x1b6)]['BadRequest']);const _0x24b601=await this[_0xb366e3(0x1e9)][_0xb366e3(0x196)]({'where':{'id':_0x58f7f5}}),_0x581852=await this['globalConfigService'][_0xb366e3(0x228)]([_0xb366e3(0x1fd),_0xb366e3(0x237),'registerVerifyEmailTitle',_0xb366e3(0x1d5),'registerVerifyEmailFrom',_0xb366e3(0x1b5)]);_0x24b601[_0xb366e3(0x17b)]=_0x4458e9['email'];const _0x5bd74b=_0x581852['registerVerifyExpir']?Number(_0x581852[_0xb366e3(0x1b5)]):0x1e*0x3c,_0x2444ed=await this['verificationService']['createVerification'](_0x24b601,verification_constant_1[_0xb366e3(0x1c1)][_0xb366e3(0x17d)],_0x5bd74b),{code:_0x18d35f,email:_0x1b0ed8,id:_0x30bbe4}=_0x2444ed,{registerVerifyEmailFrom:_0x5f2635}=_0x581852;await this[_0xb366e3(0x1b8)]['sendMail']({'to':_0x1b0ed8,'template':_0xb366e3(0x184),'subject':'来自'+_0x5f2635+_0xb366e3(0x242),'context':{'id':_0x30bbe4,'code':_0x18d35f,'email':_0x1b0ed8,..._0x581852,'baseUrl':_0x581852[_0xb366e3(0x237)]}});}async['getPhoneStatus'](_0x4b185d){const _0x4e3fc7=_0xadbd0b,_0x5bfc6f=await this[_0x4e3fc7(0x1e9)][_0x4e3fc7(0x23d)]({'where':{'phone':_0x4b185d}});return _0x5bfc6f>0x0;}async[_0xadbd0b(0x1ef)](_0x30f840){const _0x15f5b2=_0xadbd0b;return await this[_0x15f5b2(0x182)](_0x30f840[_0x15f5b2(0x19c)],_0x30f840[_0x15f5b2(0x1ae)]),await this[_0x15f5b2(0x1e9)][_0x15f5b2(0x1e0)]({'id':_0x30f840[_0x15f5b2(0x183)],'phone':_0x30f840[_0x15f5b2(0x19c)]}),!![];}async['renewMiniAccessToken'](){const _0xa7189a=_0xadbd0b;try{const _0x4e3af2=process[_0xa7189a(0x1fe)][_0xa7189a(0x1cc)];if(_0x4e3af2===_0xa7189a(0x1db)||_0x4e3af2==='ceshi.qumao518.vip'||_0x4e3af2===_0xa7189a(0x1e2)){const _0x29d32f=await axios_1['default'][_0xa7189a(0x1a0)](_0xa7189a(0x24a));await this['redisCacheService'][_0xa7189a(0x1bf)]({'key':redisKey_constant_1[_0xa7189a(0x1a6)],'val':_0x29d32f['data'][_0xa7189a(0x1a7)]});}else{const _0x108e84=await axios_1[_0xa7189a(0x231)]['post']('https://api.weixin.qq.com/cgi-bin/stable_token',{'grant_type':_0xa7189a(0x1d7),'appid':store_1['WechatConfig']['WE_MiNI_APPID'],'secret':store_1[_0xa7189a(0x245)][_0xa7189a(0x1f9)],'force_refresh':![]});await this['redisCacheService']['set']({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY'],'val':_0x108e84[_0xa7189a(0x1a7)][_0xa7189a(0x234)]});}}catch(_0x569b3a){common_1[_0xa7189a(0x1b0)][_0xa7189a(0x1df)]('wechat\x20获取access_token\x20失败：',_0x569b3a);}}['createTokenFromFingerprint'](_0x595074){const _0x555638=_0xadbd0b,_0x150c37={'id':_0x595074,'openId':null,'client':null,'role':'visitor','username':'游客'+_0x595074,'email':_0x595074+_0x555638(0x1ec),'saasId':(0x0,utils_1['getReqSaasId'])(this[_0x555638(0x18b)])};return this[_0x555638(0x17e)](_0x150c37);}async[_0xadbd0b(0x1bd)](_0x20c0f7,_0x241b14){const _0x20598=_0xadbd0b,{status:_0x1e2c30}=_0x20c0f7;if(_0x1e2c30!==user_constant_1[_0x20598(0x248)]['ACTIVE'])throw new common_1[(_0x20598(0x21d))](user_constant_1[_0x20598(0x1f5)][_0x1e2c30],common_1['HttpStatus']['BAD_REQUEST']);const _0x5f36ce=(0x0,utils_1['getClientIp'])(_0x241b14),_0x31f58f=this[_0x20598(0x17e)](_0x20c0f7);return await this['userService']['savaLoginIp'](_0x20c0f7['id'],_0x5f36ce),await this[_0x20598(0x218)]['saveToken'](_0x20c0f7['id'],_0x31f58f),_0x31f58f;}async['validatePhoneCode'](_0x56670c,_0x1303dc){const _0x3d41d0=_0xadbd0b,_0x50f104=await this[_0x3d41d0(0x1a4)][_0x3d41d0(0x177)](),_0x1034d6=_0x50f104+_0x3d41d0(0x178)+_0x56670c;if(_0x1303dc===_0x3d41d0(0x1a9))return;const _0x6d5f5=await this['redisCacheService'][_0x3d41d0(0x1a0)]({'key':_0x1034d6});if(!_0x6d5f5)throw new common_1[(_0x3d41d0(0x21d))](_0x3d41d0(0x1ea),common_1['HttpStatus'][_0x3d41d0(0x1c9)]);if(_0x1303dc!==_0x6d5f5)throw new common_1[(_0x3d41d0(0x21d))](_0x3d41d0(0x239),common_1['HttpStatus'][_0x3d41d0(0x1c9)]);}async[_0xadbd0b(0x1cb)](_0xa19e9c,_0x2ec49a){const _0xf4d9cd=_0xadbd0b;let _0x3a9114;_0x2ec49a&&(_0x3a9114=await this[_0xf4d9cd(0x1fc)]['qureyUserInfoByInviteCode'](_0x2ec49a)),await this[_0xf4d9cd(0x1fc)]['changeScore4registe'](_0xa19e9c,_0x3a9114);}};AuthService=__decorate([(0x0,common_1[_0xadbd0b(0x1cf)])(),__param(0x0,(0x0,typeorm_1[_0xadbd0b(0x1d3)])(user_entity_1[_0xadbd0b(0x20b)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(role_entity_1[_0xadbd0b(0x220)])),__metadata(_0xadbd0b(0x1d9),[typeorm_2['Repository'],typeorm_2[_0xadbd0b(0x1eb)],nestjs_cls_1[_0xadbd0b(0x16b)],jwt_1[_0xadbd0b(0x18c)],user_service_1[_0xadbd0b(0x1ed)],mailer_service_1[_0xadbd0b(0x23b)],redisCache_service_1['RedisCacheService'],verification_service_1['VerificationService'],globalConfig_service_1[_0xadbd0b(0x23c)]])],AuthService),exports[_0xadbd0b(0x180)]=AuthService;