'use strict';const _0x10e9ba=_0x3426;function _0x1684(){const _0x55985c=['queryUserInfoById','role','sendPhoneCode','registerVerifyEmailDesc','errmsg','000000','validatePhoneCode','compareSync','metadata','/api/auth/changeEmailSuccess?id=','VerificationEnum','access_token','renewMiniAccessToken','../../common/constants/redisKey.constant','MailerService','getReqSaasId','./vo/Login.vo','object','post','user','padStart','count','&username=','用户名或密码错误！','redisCacheService','kaifa.qumao518.vip','../globalConfig/globalConfig.service','getOwnPropertyDescriptor','updateUserStatus','phoneCode','380hutbyg','registerSuccessEmaileAppend','username','createRandomCode','/api/auth/registerError?message=','账号注册时密码不能为空！','updateEmail','WechatConfig','phone_info','账户不存在，请联系管理员或注册','roleEntity','BadRequest','#fff','toString','InjectRepository','__esModule','invitedBy','registerFailEmailTeamName','loginV4','getNamespace','角色信息异常！','test','verifyCode','registerSuccessEmailTitle','WE_MiNI_APPID','createMathExpr','&registerSuccessEmaileAppend=','11dKNQyL','userDefautlAvatar','../mailer/mailer.service','createUser','registerVerifyExpir','@nestjs/typeorm','ClsService','status','ceshi.qumao518.vip','saas.qumao518.vip','userId','Registration','../../common/constants/user.constant','bcryptjs','验证码已过期、请重新发送！','changeEmail','密码修改成功','验证码类型错误','updatePassword','ACTIVE','verificationService','verifyCaptcha','loginByAdmin','createRandomUid','queryOne','response','invitationRewards','design:paramtypes','sendMail','function','saveToken','../../common/utils','ttl','data',':PHONECODE:','&registerFailEmailTitle=','emailVerify','set','验证码不能为空！','getClientIp','用户名格式错误！','registerBaseUrl','5350060UJxetz','6yqapTy','length','loginWithWechatApp:\x20','userEntity','getOne','../user/role.entity','/api/auth/registerSuccess?id=','GOMAXAI_HOST','@nestjs/common','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','save','用户名或密码错误','findOne','loginInMinigin:\x20','savaLoginIp','redirect','defineProperty','phone','GlobalConfigService','svg-captcha','WE_MINI_TEMP_USER','WE_APP_TEMP_USER','loginWithWechatApp','AuthService','jwtService','bindPhone','HttpException','error','旧密码错误、请检查提交','purePhoneNumber','mailerService','unionid','./../verification/verification.service','comparePassword','UserService','captchaId','无权此操作、请联系管理员！','nestjs-cls','userInitVip','typeorm','当前用户已注册，请勿重复注册！','HttpStatus','decorate','https://api.weixin.qq.com/sns/jscode2session','__metadata','registerVerifyEmailFrom','clsService','createVerification','该邮箱已注册！','getPhoneStatus','password','Repository','email','changeScore4registe','UserStatusEnum','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','captcha','ChangeEmail','JwtService','UserStatusErrMsg','WE_MINI_ACCESS_KEY','&grant_type=authorization_code','openId、miniOpenId、weAppOpenId中必须存在一个','hashSync','authorization_code','userService','&code=','axios','6047916tYwTli','邮箱已被其他用户使用','authToken','phoneWithOpenId4regist','registerFailEmailTitle','7qaoRRb','access:','秒内不得重复发送短信！','avatar','getUserStatus','HttpStatusCode','registerVerifyEmailTitle','getPhoneInMini','&registerFailEmailTeamName=','getConfigByKeys','default','../user/user.service','openid','的邮箱验证','registerSuccessEmailTeamName','账号密码或密码错误','getInfo','4348962uIEpkW','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','loginInMinigin','openId','RoleEntity','WE_APP_APPSECRET','&registerSuccessEmailTeamName=','getJwtToken','get','WE_MINI_APPSECRET','signToken','BAD_REQUEST','miniOpenId','原密码不可为空','51966YgafYy','__decorate','@nestjs/jwt','../../common/constants/Role.constant','accessLabel','AGENT','&registerSuccessEmailTitle=','__param','globalConfigService','qureyUserInfoByInviteCode','weAppOpenId','Logger','&secret=','参数错误！','../../common/store','1573944BLVKVq','sendEmailCode','activateAccount','./vo/WeAppLogin.vo','Injectable','15064wfiZar','8OfNTGn','https://api.weixin.qq.com/cgi-bin/stable_token','1953132hDeGtI','text','nickname','message','registeV3','errcode','&email='];_0x1684=function(){return _0x55985c;};return _0x1684();}(function(_0xd00d6,_0x161891){const _0x1eec3c=_0x3426,_0x3ed947=_0xd00d6();while(!![]){try{const _0x530c1e=-parseInt(_0x1eec3c(0x19b))/0x1*(-parseInt(_0x1eec3c(0x1ce))/0x2)+-parseInt(_0x1eec3c(0x152))/0x3*(parseInt(_0x1eec3c(0x1c9))/0x4)+parseInt(_0x1eec3c(0x1f6))/0x5*(parseInt(_0x1eec3c(0x1ba))/0x6)+-parseInt(_0x1eec3c(0x196))/0x7*(-parseInt(_0x1eec3c(0x1cf))/0x8)+-parseInt(_0x1eec3c(0x1ac))/0x9+-parseInt(_0x1eec3c(0x151))/0xa*(-parseInt(_0x1eec3c(0x127))/0xb)+-parseInt(_0x1eec3c(0x1d1))/0xc;if(_0x530c1e===_0x161891)break;else _0x3ed947['push'](_0x3ed947['shift']());}catch(_0x1fc56f){_0x3ed947['push'](_0x3ed947['shift']());}}}(_0x1684,0xa548b));function _0x3426(_0x178b67,_0x52ed12){const _0x1684b6=_0x1684();return _0x3426=function(_0x3426d9,_0x1b6dd6){_0x3426d9=_0x3426d9-0x112;let _0x49c972=_0x1684b6[_0x3426d9];return _0x49c972;},_0x3426(_0x178b67,_0x52ed12);}var __decorate=this&&this[_0x10e9ba(0x1bb)]||function(_0x1f84e4,_0x976eea,_0x29f4f7,_0x511c22){const _0x23ba68=_0x10e9ba;var _0x37c02e=arguments[_0x23ba68(0x153)],_0x1b274b=_0x37c02e<0x3?_0x976eea:_0x511c22===null?_0x511c22=Object[_0x23ba68(0x1f3)](_0x976eea,_0x29f4f7):_0x511c22,_0x531750;if(typeof Reflect===_0x23ba68(0x1e9)&&typeof Reflect[_0x23ba68(0x17c)]===_0x23ba68(0x144))_0x1b274b=Reflect[_0x23ba68(0x17c)](_0x1f84e4,_0x976eea,_0x29f4f7,_0x511c22);else{for(var _0x4dcffa=_0x1f84e4['length']-0x1;_0x4dcffa>=0x0;_0x4dcffa--)if(_0x531750=_0x1f84e4[_0x4dcffa])_0x1b274b=(_0x37c02e<0x3?_0x531750(_0x1b274b):_0x37c02e>0x3?_0x531750(_0x976eea,_0x29f4f7,_0x1b274b):_0x531750(_0x976eea,_0x29f4f7))||_0x1b274b;}return _0x37c02e>0x3&&_0x1b274b&&Object[_0x23ba68(0x162)](_0x976eea,_0x29f4f7,_0x1b274b),_0x1b274b;},__metadata=this&&this[_0x10e9ba(0x17e)]||function(_0x40b466,_0x324cc2){const _0x226a65=_0x10e9ba;if(typeof Reflect===_0x226a65(0x1e9)&&typeof Reflect['metadata']==='function')return Reflect[_0x226a65(0x1e0)](_0x40b466,_0x324cc2);},__param=this&&this[_0x10e9ba(0x1c1)]||function(_0x15e4ed,_0x38f4b8){return function(_0x337212,_0x2fdf6f){_0x38f4b8(_0x337212,_0x2fdf6f,_0x15e4ed);};};Object[_0x10e9ba(0x162)](exports,_0x10e9ba(0x11b),{'value':!![]}),exports[_0x10e9ba(0x169)]=void 0x0;const globalConfig_service_1=require(_0x10e9ba(0x1f2)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x10e9ba(0x172)),user_entity_1=require('./../user/user.entity'),common_1=require(_0x10e9ba(0x15a)),jwt_1=require(_0x10e9ba(0x1bc)),user_service_1=require(_0x10e9ba(0x1a6)),mailer_service_1=require(_0x10e9ba(0x129)),user_constant_1=require(_0x10e9ba(0x133)),utils_1=require(_0x10e9ba(0x146)),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require(_0x10e9ba(0x165)),bcrypt=require(_0x10e9ba(0x134)),store_1=require(_0x10e9ba(0x1c8)),axios_1=require(_0x10e9ba(0x195)),redisKey_constant_1=require(_0x10e9ba(0x1e5)),Login_vo_1=require(_0x10e9ba(0x1e8)),WeAppLogin_vo_1=require(_0x10e9ba(0x1cc)),typeorm_1=require(_0x10e9ba(0x12c)),typeorm_2=require(_0x10e9ba(0x179)),nestjs_cls_1=require(_0x10e9ba(0x177)),role_entity_1=require(_0x10e9ba(0x157)),Role_constant_1=require(_0x10e9ba(0x1bd));let AuthService=class AuthService{constructor(_0x266bd9,_0x5a05f2,_0x1de4d8,_0x204b05,_0x21385b,_0x246f86,_0x34fa69,_0x295fc2,_0x14c837){const _0x600a88=_0x10e9ba;this[_0x600a88(0x155)]=_0x266bd9,this[_0x600a88(0x116)]=_0x5a05f2,this[_0x600a88(0x180)]=_0x1de4d8,this['jwtService']=_0x204b05,this[_0x600a88(0x193)]=_0x21385b,this[_0x600a88(0x170)]=_0x246f86,this[_0x600a88(0x1f0)]=_0x34fa69,this['verificationService']=_0x295fc2,this[_0x600a88(0x1c2)]=_0x14c837;}[_0x10e9ba(0x1b6)](_0x40d2a0){const _0x30a93d=_0x10e9ba,{id:_0x21e0f4,username:_0x142bb2,role:_0x56b0c9,openId:_0x41542d,email:_0xa8cdf8,client:_0xd84db5,saasId:_0x1fcf8a}=_0x40d2a0;return this[_0x30a93d(0x16a)]['sign']({'id':_0x21e0f4,'username':_0x142bb2,'role':_0x56b0c9,'openId':_0x41542d,'email':_0xa8cdf8,'client':_0xd84db5,'saasId':_0x1fcf8a});}async[_0x10e9ba(0x13d)](_0x419ff6){const _0x1b491f=_0x10e9ba,{username:_0x50be55,password:_0x2455dc}=_0x419ff6;if(!_0x50be55||!_0x2455dc)throw new common_1[(_0x1b491f(0x16c))](_0x1b491f(0x1aa),common_1[_0x1b491f(0x17b)][_0x1b491f(0x1b7)]);const _0x16f29a=await this['userService'][_0x1b491f(0x156)](_0x50be55);if(!_0x16f29a)throw new common_1[(_0x1b491f(0x16c))](_0x1b491f(0x115),common_1[_0x1b491f(0x17b)][_0x1b491f(0x1b7)]);if((0x0,utils_1[_0x1b491f(0x173)])(_0x2455dc,_0x16f29a[_0x1b491f(0x184)]))throw new common_1[(_0x1b491f(0x16c))](_0x1b491f(0x15d),common_1['HttpStatus'][_0x1b491f(0x1b7)]);return this['signToken'](_0x16f29a);}async[_0x10e9ba(0x136)](_0x252902,_0xd3dd7c){const _0x20f312=_0x10e9ba,_0x27835d=await this['globalConfigService'][_0x20f312(0x1a4)](['registerSuccessEmailTitle',_0x20f312(0x1a9),_0x20f312(0x1f7),_0x20f312(0x19a),_0x20f312(0x11d)]);try{const _0x4545f1=await this['verificationService'][_0x20f312(0x122)](_0x252902,verification_constant_1[_0x20f312(0x1e2)]['ChangeEmail']),{type:_0xfb90bc,userId:_0x2920a9}=_0x4545f1;if(_0xfb90bc!==verification_constant_1[_0x20f312(0x1e2)][_0x20f312(0x18b)])throw new common_1[(_0x20f312(0x16c))](_0x20f312(0x138),common_1[_0x20f312(0x17b)][_0x20f312(0x1b7)]);let _0xd0c167=await this[_0x20f312(0x155)][_0x20f312(0x15e)]({'where':{'id':_0x2920a9}});_0xd0c167[_0x20f312(0x186)]=_0x252902['email'],_0xd0c167=await this[_0x20f312(0x155)][_0x20f312(0x15c)](_0xd0c167);const {id:_0x2de03b,username:_0x22ecc6,email:_0x34371b}=_0xd0c167;_0xd3dd7c['redirect'](_0x20f312(0x1e1)+_0x2de03b[_0x20f312(0x119)]()[_0x20f312(0x1ec)](0x4,'0')+_0x20f312(0x1ee)+_0x22ecc6+_0x20f312(0x1d7)+_0x34371b+_0x20f312(0x1c0)+_0x27835d['registerSuccessEmailTitle']+_0x20f312(0x1b2)+_0x27835d[_0x20f312(0x1a9)]+_0x20f312(0x126)+_0x27835d['registerSuccessEmaileAppend']);}catch(_0x29c2d0){const _0x57b250=_0x29c2d0[_0x20f312(0x140)];_0xd3dd7c[_0x20f312(0x161)](_0x20f312(0x1fa)+_0x57b250+'&registerFailEmailTitle='+_0x27835d[_0x20f312(0x19a)]+'&registerFailEmailTeamName='+_0x27835d['registerFailEmailTeamName']);}}async[_0x10e9ba(0x18a)](_0xd143db){const _0x548e14=_0x10e9ba,_0x27adc4=await this[_0x548e14(0x1c2)][_0x548e14(0x11f)](),{color:color=_0x548e14(0x118)}=_0xd143db,_0x1189c0=svgCaptcha[_0x548e14(0x125)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5b144c=_0x1189c0['text'],_0x312c2d=(0x0,utils_1[_0x548e14(0x13e)])(),_0x188a83=_0x27adc4+':CAPTCHA:'+_0x312c2d;return await this[_0x548e14(0x1f0)][_0x548e14(0x14c)]({'key':_0x188a83,'val':_0x1189c0[_0x548e14(0x1d2)]},0x5*0x3c),{'svgCode':_0x1189c0['data'],'code':_0x312c2d};}async[_0x10e9ba(0x1da)](_0x4907df){const _0x3f1c2c=_0x10e9ba;_0x4907df[_0x3f1c2c(0x175)]&&await this[_0x3f1c2c(0x13b)][_0x3f1c2c(0x13c)](_0x4907df);const {phone:_0x3142ba}=_0x4907df,_0x111288=await this[_0x3f1c2c(0x1c2)]['getNamespace'](),_0x398926=_0x111288+_0x3f1c2c(0x149)+_0x3142ba,_0x4660ad=await this[_0x3f1c2c(0x1f0)][_0x3f1c2c(0x147)](_0x398926);if(_0x4660ad&&_0x4660ad>0x0)throw new common_1[(_0x3f1c2c(0x16c))](_0x4660ad+_0x3f1c2c(0x19d),common_1['HttpStatus']['BAD_REQUEST']);const _0x19e101=(0x0,utils_1[_0x3f1c2c(0x1f9)])(),_0x16e782={'phone':_0x3142ba,'code':_0x19e101};return await this[_0x3f1c2c(0x13b)][_0x3f1c2c(0x1da)](_0x16e782),await this[_0x3f1c2c(0x1f0)]['set']({'key':_0x398926,'val':_0x19e101},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}async[_0x10e9ba(0x1ca)](_0x4627e1){const _0x5d7e1e=_0x10e9ba;try{var _0x4eb22d=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x4eb22d[_0x5d7e1e(0x121)](_0x4627e1))throw new Error('邮箱格式错误！');const _0x42864a=await this['userEntity'][_0x5d7e1e(0x15e)]({'where':{'email':_0x4627e1}});if(_0x42864a)throw new Error(_0x5d7e1e(0x182));const _0x5c2993=await this[_0x5d7e1e(0x1c2)][_0x5d7e1e(0x1a4)]([_0x5d7e1e(0x150),_0x5d7e1e(0x1a1),_0x5d7e1e(0x1db),'registerVerifyEmailFrom',_0x5d7e1e(0x12b)]),_0x443037=(0x0,utils_1[_0x5d7e1e(0x1f9)])(),_0x177ae9=_0x5c2993[_0x5d7e1e(0x12b)]?Number(_0x5c2993[_0x5d7e1e(0x12b)]):0x1e*0x3c;await this[_0x5d7e1e(0x1f0)]['set']({'key':redisKey_constant_1['EMAIL_REGISTE']+_0x4627e1,'val':_0x443037},_0x177ae9*0x3c),await this['mailerService'][_0x5d7e1e(0x143)]({'to':_0x4627e1,'template':_0x5d7e1e(0x14b),'subject':'来自'+_0x5c2993[_0x5d7e1e(0x17f)]+'的注册验证','context':{'baseUrl':_0x5c2993[_0x5d7e1e(0x150)],'code':_0x443037,..._0x5c2993}});}catch(_0x58c011){throw new common_1[(_0x5d7e1e(0x16c))](_0x58c011[_0x5d7e1e(0x1d4)],common_1[_0x5d7e1e(0x17b)][_0x5d7e1e(0x1b7)]);}}async[_0x10e9ba(0x1a2)](_0x2ce7c4){const _0x414b38=_0x10e9ba;try{const _0x434dfe=await this[_0x414b38(0x1f0)][_0x414b38(0x1b4)]({'key':redisKey_constant_1[_0x414b38(0x18e)]}),_0x54a2b8=await axios_1['default']['post'](_0x414b38(0x15b)+_0x434dfe,{'code':_0x2ce7c4});if(_0x54a2b8[_0x414b38(0x148)][_0x414b38(0x1d6)])throw new Error(_0x54a2b8['data'][_0x414b38(0x1dc)]);return _0x54a2b8[_0x414b38(0x148)][_0x414b38(0x114)][_0x414b38(0x16f)];}catch(_0x31eab4){common_1[_0x414b38(0x1c5)][_0x414b38(0x16d)]('getPhoneInMini:\x20',_0x31eab4);throw new common_1[(_0x414b38(0x16c))](_0x31eab4[_0x414b38(0x1d4)],common_1[_0x414b38(0x17b)][_0x414b38(0x1b7)]);}}async[_0x10e9ba(0x199)](_0x43c66f){const _0x53fffb=_0x10e9ba;try{if(!_0x43c66f[_0x53fffb(0x1af)]&&!_0x43c66f[_0x53fffb(0x1b8)]&&!_0x43c66f['weAppOpenId'])throw new Error(_0x53fffb(0x190));let _0x5b4ab4=_0x53fffb(0x1af),_0x68b5ac={};if(_0x43c66f[_0x53fffb(0x1af)])_0x5b4ab4=_0x53fffb(0x1af);else _0x43c66f[_0x53fffb(0x1b8)]?_0x5b4ab4=_0x53fffb(0x1b8):_0x5b4ab4=_0x53fffb(0x1c4);_0x68b5ac[_0x5b4ab4]=_0x43c66f[_0x5b4ab4];const _0x308231=await this[_0x53fffb(0x155)][_0x53fffb(0x15e)]({'where':_0x68b5ac});if(_0x308231&&_0x308231['phone'])return![];const _0xc502f7=await this[_0x53fffb(0x155)][_0x53fffb(0x15e)]({'where':{'phone':_0x43c66f[_0x53fffb(0x163)]}});if(_0xc502f7)return!_0xc502f7[_0x5b4ab4];return!![];}catch(_0x4ec5cb){throw new common_1['HttpException'](_0x4ec5cb['message'],common_1[_0x53fffb(0x17b)][_0x53fffb(0x1b7)]);}}async[_0x10e9ba(0x1d5)](_0x5653f2,_0x88e3bc){const _0x553525=_0x10e9ba,_0x4baa4d=(0x0,utils_1[_0x553525(0x1e7)])(this[_0x553525(0x180)]);try{if(_0x5653f2['username']){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x553525(0x121)](_0x5653f2[_0x553525(0x1f8)]))throw new Error(_0x553525(0x14f));if(!_0x5653f2[_0x553525(0x184)])throw new Error(_0x553525(0x1fb));}else{if(!_0x5653f2[_0x553525(0x1af)]&&!_0x5653f2[_0x553525(0x1b8)]&&!_0x5653f2[_0x553525(0x1c4)])throw new Error(_0x553525(0x1c7));}if(_0x5653f2[_0x553525(0x163)]&&!_0x5653f2[_0x553525(0x1f5)])throw new Error(_0x553525(0x14d));let _0x26c5b3=null;if(_0x5653f2[_0x553525(0x163)])await this[_0x553525(0x1de)](_0x5653f2['phone'],_0x5653f2[_0x553525(0x1f5)]),_0x26c5b3=await this[_0x553525(0x155)][_0x553525(0x15e)]({'where':{'phone':_0x5653f2[_0x553525(0x163)],'saasId':_0x4baa4d}});else{if(_0x5653f2[_0x553525(0x1af)]||_0x5653f2[_0x553525(0x1b8)]||_0x5653f2[_0x553525(0x1c4)]){let _0x2562f4=_0x553525(0x1af),_0x5aced7={'saasId':_0x4baa4d};if(_0x5653f2[_0x553525(0x1af)])_0x2562f4=_0x553525(0x1af);else _0x5653f2[_0x553525(0x1b8)]?_0x2562f4=_0x553525(0x1b8):_0x2562f4=_0x553525(0x1c4);_0x5aced7[_0x2562f4]=_0x5653f2[_0x2562f4],_0x26c5b3=await this[_0x553525(0x155)]['findOne']({'where':_0x5aced7});if(_0x26c5b3)throw new Error('当前用户已注册，请勿重复注册！');}else{_0x26c5b3=await this[_0x553525(0x155)][_0x553525(0x15e)]({'where':{'username':_0x5653f2['username'],'saasId':_0x4baa4d}});if(_0x26c5b3)throw new Error(_0x553525(0x17a));}}const _0xf055f7=new user_entity_1['UserEntity']();for(let _0x10e349 in _0x5653f2){_0x5653f2[_0x10e349]&&(_0xf055f7[_0x10e349]=_0x5653f2[_0x10e349]);}_0x26c5b3?_0xf055f7['id']=_0x26c5b3['id']:(_0xf055f7[_0x553525(0x184)]&&(_0xf055f7['password']=bcrypt['hashSync'](_0x5653f2[_0x553525(0x184)],0xa)),_0xf055f7[_0x553525(0x12e)]=user_constant_1[_0x553525(0x188)][_0x553525(0x13a)],!_0xf055f7['nickname']&&(_0xf055f7[_0x553525(0x1d3)]=_0xf055f7[_0x553525(0x1d3)]||'小智'),!_0xf055f7['avatar']&&(_0xf055f7[_0x553525(0x19e)]=await this[_0x553525(0x1c2)][_0x553525(0x1a4)]([_0x553525(0x128)])));_0xf055f7['saasId']=_0x4baa4d;const _0x2c7d65=await this[_0x553525(0x193)][_0x553525(0x12a)](_0xf055f7);!_0x26c5b3&&this[_0x553525(0x141)](_0x2c7d65,_0x5653f2[_0x553525(0x11c)]);const _0x29d060=(0x0,utils_1['getClientIp'])(_0x88e3bc),_0xb95b58=this[_0x553525(0x1b6)](_0x2c7d65);return await this[_0x553525(0x193)][_0x553525(0x160)](_0x2c7d65['id'],_0x29d060),await this['redisCacheService'][_0x553525(0x145)](_0x2c7d65['id'],_0xb95b58),_0xb95b58;}catch(_0x48ec58){if(_0x48ec58 instanceof common_1[_0x553525(0x16c)])throw _0x48ec58;else throw new common_1[(_0x553525(0x16c))](_0x48ec58[_0x553525(0x1d4)],common_1[_0x553525(0x17b)][_0x553525(0x1b7)]);}}async['loginByPhoneV3'](_0x543737,_0x3c4508){const _0x2c663d=_0x10e9ba,_0x5ff4b1=(0x0,utils_1['getReqSaasId'])(this['clsService']);await this['validatePhoneCode'](_0x543737[_0x2c663d(0x163)],_0x543737[_0x2c663d(0x1f5)]);let _0x11b0f5=await this[_0x2c663d(0x155)][_0x2c663d(0x15e)]({'where':{'phone':_0x543737[_0x2c663d(0x163)],'saasId':_0x5ff4b1}});if(!_0x11b0f5){const _0x36db53=new user_entity_1['UserEntity']();_0x36db53[_0x2c663d(0x163)]=_0x543737[_0x2c663d(0x163)],_0x36db53[_0x2c663d(0x1d3)]=_0x543737[_0x2c663d(0x163)],_0x36db53[_0x2c663d(0x12e)]=user_constant_1[_0x2c663d(0x188)][_0x2c663d(0x13a)],_0x36db53[_0x2c663d(0x19e)]=await this['globalConfigService'][_0x2c663d(0x1a4)](['userDefautlAvatar']),_0x11b0f5=await this['userService'][_0x2c663d(0x12a)](_0x36db53),this['invitationRewards'](_0x11b0f5,_0x543737['invitedBy']);}const _0x5c41d4=(0x0,utils_1[_0x2c663d(0x14e)])(_0x3c4508),_0xac93e5=this[_0x2c663d(0x1b6)](_0x11b0f5);return await this[_0x2c663d(0x193)][_0x2c663d(0x160)](_0x11b0f5['id'],_0x5c41d4),await this['redisCacheService']['saveToken'](_0x11b0f5['id'],_0xac93e5),_0xac93e5;}async[_0x10e9ba(0x11e)](_0x5ae11f,_0x4a95e){const _0x1bf527=_0x10e9ba;try{const _0x5a6dc3=(0x0,utils_1[_0x1bf527(0x1e7)])(this['clsService']),_0x1aba4c=await this[_0x1bf527(0x155)][_0x1bf527(0x15e)]({'where':[{'username':_0x5ae11f['username'],'saasId':_0x5a6dc3},{'email':_0x5ae11f[_0x1bf527(0x1f8)],'saasId':_0x5a6dc3},{'phone':_0x5ae11f[_0x1bf527(0x1f8)],'saasId':_0x5a6dc3}]});if(!_0x1aba4c)throw new Error(_0x1bf527(0x1ef));if(!_0x1aba4c['password'])throw new Error(_0x1bf527(0x1ef));if(!bcrypt[_0x1bf527(0x1df)](_0x5ae11f['password'],_0x1aba4c[_0x1bf527(0x184)]))throw new Error(_0x1bf527(0x1ef));_0x1aba4c[_0x1bf527(0x1f8)]&&!_0x1aba4c['lastLoginIp']&&await this[_0x1bf527(0x193)][_0x1bf527(0x178)](_0x1aba4c);const _0x53beb1=(0x0,utils_1[_0x1bf527(0x14e)])(_0x4a95e),_0xc79469=this[_0x1bf527(0x1b6)](_0x1aba4c);await this[_0x1bf527(0x193)][_0x1bf527(0x160)](_0x1aba4c['id'],_0x53beb1),await this[_0x1bf527(0x1f0)]['saveToken'](_0x1aba4c['id'],_0xc79469);if((0x0,utils_1['shouldAccess'])(_0x1aba4c[_0x1bf527(0x1d9)])){let _0x1651ae;_0x1aba4c[_0x1bf527(0x1d9)]===Role_constant_1['ERole'][_0x1bf527(0x1bf)]?_0x1651ae=await this[_0x1bf527(0x116)]['findOne']({'where':{'code':_0x1aba4c[_0x1bf527(0x1d9)]}}):_0x1651ae=await this[_0x1bf527(0x116)][_0x1bf527(0x15e)]({'where':{'code':_0x1aba4c['role'],'saasId':_0x5a6dc3}});if(!_0x1651ae)throw new Error(_0x1bf527(0x120));await this['redisCacheService'][_0x1bf527(0x14c)]({'key':_0x1bf527(0x19c)+_0x1aba4c['id'],'val':_0x1651ae[_0x1bf527(0x1be)]});}return _0xc79469;}catch(_0x369b52){throw new common_1[(_0x1bf527(0x16c))](_0x369b52[_0x1bf527(0x1d4)],common_1[_0x1bf527(0x17b)]['BAD_REQUEST']);}}async[_0x10e9ba(0x1ae)](_0x123542){const _0x149a3=_0x10e9ba;try{const _0x26fe5e=new Login_vo_1[(_0x149a3(0x1a5))](),_0x485ca5=(0x0,utils_1[_0x149a3(0x1e7)])(this[_0x149a3(0x180)]),_0x5af216=await axios_1['default']['get'](_0x149a3(0x17d),{'params':{'appid':store_1[_0x149a3(0x113)][_0x149a3(0x124)],'secret':store_1[_0x149a3(0x113)][_0x149a3(0x1b5)],'js_code':_0x123542,'grant_type':_0x149a3(0x192)}}),_0x202e32=_0x5af216[_0x149a3(0x148)];if(_0x202e32['errcode'])throw new Error(_0x202e32[_0x149a3(0x1dc)]);const _0x20be88=await this['userEntity'][_0x149a3(0x15e)]({'where':{'miniOpenId':_0x202e32[_0x149a3(0x1a7)],'saasId':_0x485ca5}});return!_0x20be88?this[_0x149a3(0x1f0)][_0x149a3(0x14c)]({'key':redisKey_constant_1[_0x149a3(0x166)]+_0x202e32['openid'],'val':_0x202e32[_0x149a3(0x171)]||null}):(_0x26fe5e[_0x149a3(0x198)]=this['signToken'](_0x20be88),await this[_0x149a3(0x1f0)][_0x149a3(0x145)](_0x20be88['id'],_0x26fe5e[_0x149a3(0x198)])),_0x26fe5e[_0x149a3(0x1a7)]=_0x202e32['openid'],_0x26fe5e;}catch(_0x86cac7){common_1[_0x149a3(0x1c5)][_0x149a3(0x16d)](_0x149a3(0x15f),_0x86cac7);throw new common_1[(_0x149a3(0x16c))](_0x86cac7[_0x149a3(0x1d4)],common_1[_0x149a3(0x17b)]['BAD_REQUEST']);}}async[_0x10e9ba(0x168)](_0x225e67){const _0x570190=_0x10e9ba,_0x5295dd=new WeAppLogin_vo_1['WeAppLoginVO'](),_0x4cbd2e=(0x0,utils_1[_0x570190(0x1e7)])(this[_0x570190(0x180)]);try{const _0x34df94=await axios_1[_0x570190(0x1a5)][_0x570190(0x1b4)](_0x570190(0x189)+store_1['WechatConfig']['WE_APP_APPID']+_0x570190(0x1c6)+store_1[_0x570190(0x113)][_0x570190(0x1b1)]+_0x570190(0x194)+_0x225e67+_0x570190(0x18f));if(_0x34df94[_0x570190(0x148)]['errcode'])throw new Error(_0x34df94[_0x570190(0x148)][_0x570190(0x1dc)]);const _0x5e85e6=_0x34df94[_0x570190(0x148)],_0xa1a302=await this[_0x570190(0x155)][_0x570190(0x15e)]({'where':{'weAppOpenId':_0x5e85e6[_0x570190(0x1a7)],'saasId':_0x4cbd2e}});return!_0xa1a302?this[_0x570190(0x1f0)][_0x570190(0x14c)]({'key':redisKey_constant_1[_0x570190(0x167)]+_0x5e85e6['openid'],'val':_0x5e85e6['unionid']||null}):(_0x5295dd[_0x570190(0x198)]=this[_0x570190(0x1b6)](_0xa1a302),await this[_0x570190(0x1f0)]['saveToken'](_0xa1a302['id'],_0x5295dd[_0x570190(0x198)])),_0x5295dd[_0x570190(0x1a7)]=_0x5e85e6[_0x570190(0x1a7)],_0x5295dd['accessToken']=_0x5e85e6['access_token'],_0x5295dd;}catch(_0x4c4e4a){common_1[_0x570190(0x1c5)][_0x570190(0x16d)](_0x570190(0x154),_0x4c4e4a);throw new common_1[(_0x570190(0x16c))](_0x4c4e4a[_0x570190(0x1d4)],common_1[_0x570190(0x17b)]['BAD_REQUEST']);}}async[_0x10e9ba(0x1cb)](_0x95a9c,_0x48485a){const _0x20ba2f=_0x10e9ba,_0x38c0e5=await this[_0x20ba2f(0x1c2)]['getConfigByKeys']([_0x20ba2f(0x123),_0x20ba2f(0x1a9),_0x20ba2f(0x1f7),_0x20ba2f(0x19a),'registerFailEmailTeamName']);try{const _0x4bad21=await this[_0x20ba2f(0x13b)][_0x20ba2f(0x122)](_0x95a9c,verification_constant_1[_0x20ba2f(0x1e2)][_0x20ba2f(0x132)]),{type:_0x48c254,userId:_0x4ea19c}=_0x4bad21;if(_0x48c254!==verification_constant_1['VerificationEnum']['Registration'])throw new common_1[(_0x20ba2f(0x16c))]('验证码类型错误',common_1[_0x20ba2f(0x17b)]['BAD_REQUEST']);const _0x113b90=await this['userService'][_0x20ba2f(0x19f)](_0x4ea19c);if(_0x113b90===user_constant_1[_0x20ba2f(0x188)][_0x20ba2f(0x13a)])throw new common_1[(_0x20ba2f(0x16c))]('账户已被激活过',common_1[_0x20ba2f(0x17b)][_0x20ba2f(0x1b7)]);await this[_0x20ba2f(0x193)][_0x20ba2f(0x1f4)](_0x4bad21[_0x20ba2f(0x131)],user_constant_1[_0x20ba2f(0x188)][_0x20ba2f(0x13a)]);const _0x462395=await this[_0x20ba2f(0x193)][_0x20ba2f(0x1d8)](_0x4bad21[_0x20ba2f(0x131)]),{username:_0x19bfa1,email:_0x264a4d,id:_0x5242e9,invitedBy:_0x5ed189}=_0x462395;let _0x4b6f28;_0x5ed189&&(_0x4b6f28=await this[_0x20ba2f(0x193)][_0x20ba2f(0x1c3)](_0x5ed189)),await this[_0x20ba2f(0x193)][_0x20ba2f(0x187)](_0x462395,_0x4b6f28),_0x48485a[_0x20ba2f(0x161)](_0x20ba2f(0x158)+_0x5242e9['toString']()[_0x20ba2f(0x1ec)](0x4,'0')+_0x20ba2f(0x1ee)+_0x19bfa1+_0x20ba2f(0x1d7)+_0x264a4d+_0x20ba2f(0x1c0)+_0x38c0e5[_0x20ba2f(0x123)]+'&registerSuccessEmailTeamName='+_0x38c0e5[_0x20ba2f(0x1a9)]+_0x20ba2f(0x126)+_0x38c0e5[_0x20ba2f(0x1f7)]);}catch(_0x23af59){console['log']('error:\x20',_0x23af59);const _0x47244c=_0x23af59[_0x20ba2f(0x140)];_0x48485a[_0x20ba2f(0x161)](_0x20ba2f(0x1fa)+_0x47244c+_0x20ba2f(0x14a)+_0x38c0e5[_0x20ba2f(0x19a)]+_0x20ba2f(0x1a3)+_0x38c0e5[_0x20ba2f(0x11d)]);}}async[_0x10e9ba(0x1ab)](_0xce60a5){const _0x585da3=_0x10e9ba,_0x5920c1=await this['userService'][_0x585da3(0x13f)]({'id':_0xce60a5['user']['id']});return{'userInfo':_0x5920c1};}async[_0x10e9ba(0x139)](_0x4a0249,_0x950d22){const _0x5e65f2=_0x10e9ba,{id:_0x4497fd,client:_0x2879e3}=_0x4a0249['user'];if(_0x2879e3&&Number(_0x2879e3)>0x0)throw new common_1[(_0x5e65f2(0x16c))](_0x5e65f2(0x176),common_1[_0x5e65f2(0x17b)][_0x5e65f2(0x1b7)]);const {oldPassword:_0x5773dc,password:_0xafbb90}=_0x950d22,_0xff0332=await this['userEntity'][_0x5e65f2(0x15e)]({'where':{'id':_0x4497fd}});if(_0xff0332[_0x5e65f2(0x184)]){if(!_0x5773dc)throw new common_1['HttpException'](_0x5e65f2(0x1b9),common_1[_0x5e65f2(0x17b)][_0x5e65f2(0x1b7)]);const _0x3d28bf=bcrypt[_0x5e65f2(0x1df)](_0x5773dc,_0xff0332[_0x5e65f2(0x184)]);if(!_0x3d28bf)throw new common_1[(_0x5e65f2(0x16c))](_0x5e65f2(0x16e),common_1[_0x5e65f2(0x17b)][_0x5e65f2(0x1b7)]);}return _0xff0332[_0x5e65f2(0x184)]=bcrypt[_0x5e65f2(0x191)](_0xafbb90,0xa),await this[_0x5e65f2(0x155)][_0x5e65f2(0x15c)](_0xff0332),_0x5e65f2(0x137);}async[_0x10e9ba(0x112)](_0x161782,_0xe699fb){const _0x3da854=_0x10e9ba,_0x3b7d7e=_0x161782[_0x3da854(0x1eb)]['id'],_0x1a6972=await this['userEntity'][_0x3da854(0x15e)]({'where':{'email':_0xe699fb[_0x3da854(0x186)]}});if(_0x1a6972)throw new common_1['HttpException'](_0x3da854(0x197),axios_1[_0x3da854(0x1a0)][_0x3da854(0x117)]);const _0x56ae47=await this[_0x3da854(0x155)][_0x3da854(0x15e)]({'where':{'id':_0x3b7d7e}}),_0x40376f=await this['globalConfigService'][_0x3da854(0x1a4)](['isVerifyEmail',_0x3da854(0x150),_0x3da854(0x1a1),_0x3da854(0x1db),_0x3da854(0x17f),_0x3da854(0x12b)]);_0x56ae47[_0x3da854(0x186)]=_0xe699fb[_0x3da854(0x186)];const _0x33d329=_0x40376f[_0x3da854(0x12b)]?Number(_0x40376f[_0x3da854(0x12b)]):0x1e*0x3c,_0x3d6189=await this[_0x3da854(0x13b)][_0x3da854(0x181)](_0x56ae47,verification_constant_1[_0x3da854(0x1e2)]['ChangeEmail'],_0x33d329),{code:_0xaeb0f7,email:_0x20e865,id:_0x449fd3}=_0x3d6189,{registerVerifyEmailFrom:_0x26c174}=_0x40376f;await this[_0x3da854(0x170)][_0x3da854(0x143)]({'to':_0x20e865,'template':_0x3da854(0x136),'subject':'来自'+_0x26c174+_0x3da854(0x1a8),'context':{'id':_0x449fd3,'code':_0xaeb0f7,'email':_0x20e865,..._0x40376f,'baseUrl':_0x40376f['registerBaseUrl']}});}async[_0x10e9ba(0x183)](_0x3f7e85){const _0x3cf4da=_0x10e9ba,_0x1f355e=await this[_0x3cf4da(0x155)][_0x3cf4da(0x1ed)]({'where':{'phone':_0x3f7e85}});return _0x1f355e>0x0;}async[_0x10e9ba(0x16b)](_0x5e84dd){const _0x33dc84=_0x10e9ba;return await this[_0x33dc84(0x1de)](_0x5e84dd[_0x33dc84(0x163)],_0x5e84dd[_0x33dc84(0x1f5)]),await this[_0x33dc84(0x155)][_0x33dc84(0x15c)]({'id':_0x5e84dd[_0x33dc84(0x131)],'phone':_0x5e84dd[_0x33dc84(0x163)]}),!![];}async[_0x10e9ba(0x1e4)](){const _0x23584d=_0x10e9ba;try{const _0x21488c=process['env'][_0x23584d(0x159)];if(_0x21488c===_0x23584d(0x1f1)||_0x21488c===_0x23584d(0x12f)||_0x21488c===_0x23584d(0x130)){const _0x260e16=await axios_1['default']['get'](_0x23584d(0x1ad));await this[_0x23584d(0x1f0)][_0x23584d(0x14c)]({'key':redisKey_constant_1[_0x23584d(0x18e)],'val':_0x260e16[_0x23584d(0x148)]['data']});}else{const _0x2d846d=await axios_1['default'][_0x23584d(0x1ea)](_0x23584d(0x1d0),{'grant_type':'client_credential','appid':store_1['WechatConfig']['WE_MiNI_APPID'],'secret':store_1['WechatConfig']['WE_MINI_APPSECRET'],'force_refresh':![]});await this[_0x23584d(0x1f0)][_0x23584d(0x14c)]({'key':redisKey_constant_1[_0x23584d(0x18e)],'val':_0x2d846d['data'][_0x23584d(0x1e3)]});}}catch(_0x15bee3){common_1[_0x23584d(0x1c5)][_0x23584d(0x16d)]('wechat\x20获取access_token\x20失败：',_0x15bee3);}}['createTokenFromFingerprint'](_0x435f20){const _0x56ee18=_0x10e9ba,_0x46d916={'id':_0x435f20,'openId':null,'client':null,'role':'visitor','username':'游客'+_0x435f20,'email':_0x435f20+'@nine.com','saasId':(0x0,utils_1['getReqSaasId'])(this[_0x56ee18(0x180)])};return this['signToken'](_0x46d916);}async[_0x10e9ba(0x1b3)](_0x3d7eff,_0x4b96e6){const _0x1ca30f=_0x10e9ba,{status:_0x18b66c}=_0x3d7eff;if(_0x18b66c!==user_constant_1[_0x1ca30f(0x188)][_0x1ca30f(0x13a)])throw new common_1[(_0x1ca30f(0x16c))](user_constant_1[_0x1ca30f(0x18d)][_0x18b66c],common_1[_0x1ca30f(0x17b)][_0x1ca30f(0x1b7)]);const _0x225cbe=(0x0,utils_1[_0x1ca30f(0x14e)])(_0x4b96e6),_0xb77949=this[_0x1ca30f(0x1b6)](_0x3d7eff);return await this[_0x1ca30f(0x193)][_0x1ca30f(0x160)](_0x3d7eff['id'],_0x225cbe),await this[_0x1ca30f(0x1f0)]['saveToken'](_0x3d7eff['id'],_0xb77949),_0xb77949;}async[_0x10e9ba(0x1de)](_0x49413a,_0x3849b9){const _0x3ec61a=_0x10e9ba,_0x4adf8a=await this[_0x3ec61a(0x1c2)][_0x3ec61a(0x11f)](),_0x5ab5c7=_0x4adf8a+_0x3ec61a(0x149)+_0x49413a;if(_0x3849b9===_0x3ec61a(0x1dd))return;const _0x4930a2=await this[_0x3ec61a(0x1f0)][_0x3ec61a(0x1b4)]({'key':_0x5ab5c7});if(!_0x4930a2)throw new common_1[(_0x3ec61a(0x16c))](_0x3ec61a(0x135),common_1['HttpStatus']['BAD_REQUEST']);if(_0x3849b9!==_0x4930a2)throw new common_1[(_0x3ec61a(0x16c))]('验证码填写错误、请重新输入！',common_1[_0x3ec61a(0x17b)][_0x3ec61a(0x1b7)]);}async[_0x10e9ba(0x141)](_0x18db33,_0x1cdfca){const _0x6ab734=_0x10e9ba;let _0x5f3ba3;_0x1cdfca&&(_0x5f3ba3=await this[_0x6ab734(0x193)][_0x6ab734(0x1c3)](_0x1cdfca)),await this[_0x6ab734(0x193)][_0x6ab734(0x187)](_0x18db33,_0x5f3ba3);}};AuthService=__decorate([(0x0,common_1[_0x10e9ba(0x1cd)])(),__param(0x0,(0x0,typeorm_1[_0x10e9ba(0x11a)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x10e9ba(0x11a)])(role_entity_1[_0x10e9ba(0x1b0)])),__metadata(_0x10e9ba(0x142),[typeorm_2[_0x10e9ba(0x185)],typeorm_2[_0x10e9ba(0x185)],nestjs_cls_1[_0x10e9ba(0x12d)],jwt_1[_0x10e9ba(0x18c)],user_service_1[_0x10e9ba(0x174)],mailer_service_1[_0x10e9ba(0x1e6)],redisCache_service_1['RedisCacheService'],verification_service_1['VerificationService'],globalConfig_service_1[_0x10e9ba(0x164)]])],AuthService),exports[_0x10e9ba(0x169)]=AuthService;