'use strict';const _0x116a86=_0x40ef;function _0x40ef(_0x4e6723,_0x3af73c){const _0x1a8628=_0x1a86();return _0x40ef=function(_0x40efa6,_0x3fe59e){_0x40efa6=_0x40efa6-0x12f;let _0x3881e1=_0x1a8628[_0x40efa6];return _0x3881e1;},_0x40ef(_0x4e6723,_0x3af73c);}(function(_0x1ceb4f,_0x400bd1){const _0x7144e2=_0x40ef,_0x512315=_0x1ceb4f();while(!![]){try{const _0x5167b2=parseInt(_0x7144e2(0x1a7))/0x1+parseInt(_0x7144e2(0x1f5))/0x2+parseInt(_0x7144e2(0x175))/0x3*(-parseInt(_0x7144e2(0x1cc))/0x4)+parseInt(_0x7144e2(0x1f8))/0x5*(-parseInt(_0x7144e2(0x131))/0x6)+parseInt(_0x7144e2(0x162))/0x7*(-parseInt(_0x7144e2(0x224))/0x8)+-parseInt(_0x7144e2(0x16c))/0x9*(-parseInt(_0x7144e2(0x1e7))/0xa)+-parseInt(_0x7144e2(0x1fc))/0xb*(parseInt(_0x7144e2(0x1a2))/0xc);if(_0x5167b2===_0x400bd1)break;else _0x512315['push'](_0x512315['shift']());}catch(_0x5cb6e8){_0x512315['push'](_0x512315['shift']());}}}(_0x1a86,0x4312d));function _0x1a86(){const _0x3f08a9=['HttpStatusCode','ChangeEmail','verifyUserCredentials','10968ylAhki','log','captchaId','@nestjs/common','message','404545UvEGtY','invitationRewards','accessService','AuthService','HttpStatus','bcryptjs','test','savaLoginIp','networkInterfaces','registerVerifyEmailTitle','账号已停用','find','data','phoneCode','用户名或密码错误！','lastLoginIp','的注册验证','__param','admin','globalConfigService','../redisCache/redisCache.service','用户名或密码错误','WE_APP_APPID','renewMiniAccessToken','padStart','registerBaseUrl','registerVerifyEmailDesc','RedisCacheService','miniOpenId','object','&registerSuccessEmailTitle=','visitor','errcode','stop','client','registerVerifyExpir','../user/user.service','2492XZDzrV','../access/access.service','error','WE_APP_TEMP_USER','errmsg','registerByPhone','#fff','000000','getClientIp','旧密码错误、请检查提交','../../common/constants/status.constant','decorate','verificationService','email','该邮箱已注册！','accessToken','jwtService','Logger','的邮箱验证','UserStatusEnum','registerFailEmailTitle','&code=','configEntity','账户不存在，请联系管理员或注册','redisCacheService','&email=','internal','110980mgpUHr','createVerification','用户名格式错误！','JwtService','configKey','queryUserInfoById','UserStatusErrMsg','design:paramtypes','text','参数错误！','role','login','BadRequest','createRandomUid','942624gMDODA','get','createUserAndVerifycation','5gOxgDR','sendMail','changeScore4registe','configVal','7447wGjLFo','getConfigs','compareSync','../mailer/mailer.service','loginInMinigin:\x20','当前用户已注册，请勿重复注册！','super','ttl','typeorm','UserEntity','env','username','sign','验证码填写错误、请重新输入！','purePhoneNumber','WE_MINI_TEMP_USER','getUserInfo','getOwnPropertyDescriptor','keys','UserStatus','账号注册时密码不能为空！','redirect','updateUserStatus','onModuleInit','changeEmail','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','post','set','&registerFailEmailTitle=','password','无权此操作！','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','hashSync','sendEmailCode','loginByAdmin','response','&registerSuccessEmaileAppend=','updatePassByOther','getPhoneInMini:\x20','IPv4','8ShxWMW','Injectable','getIp','1260330KXYvQn','weAppOpenId','账号密码或密码错误','validatePhoneCode','&username=','邮箱已被其他用户使用','saveToken','authToken','reduce','账户已被激活过','createTokenFromFingerprint','../../config/WechatConfig','registerSuccessEmaileAppend','getPhoneStatus','InjectRepository','function','Registration','GOMAXAI_HOST','activateAccount','comparePassword','unionid','createRandomCode','/api/auth/registerError?message=','verifyCode','https://api.weixin.qq.com/cgi-bin/stable_token','openId、miniOpenId、weAppOpenId中必须存在一个','ACTIVE','registeV3','managerStatus','updateUserPassword','access_token','kaifa.qumao518.vip','address','验证码类型错误','非法操作、请联系管理员！','toString','HttpException','updateEmail','../../common/utils','/api/auth/changeEmailSuccess?id=','https://api.weixin.qq.com/sns/jscode2session','hasOwnProperty','loginByOpenId','mailerService','WE_MINI_ACCESS_KEY','VerificationService','userService',':PHONECODE:','authorization_code','1485687vHkoVE','验证码发送成功、请填写验证码完成注册！','invitedBy','save','../globalConfig/globalConfig.service','验证码已过期、请重新发送！','127.0.0.1','__esModule','userId','../../common/constants/verification.constant','378fRTKVS','client_credential','findOne','../../common/constants/user.constant','userEntity','default','status','phone','verifyCaptcha','126TnPCei','BAD_REQUEST','&secret=','user','&registerSuccessEmailTeamName=','wechat\x20获取access_token\x20失败：','WE_MiNI_APPID',':CAPTCHA:','axios','registerVerifyEmailFrom','isVerifyEmail','验证码不能为空！','userInitVip','defineProperty','VerificationEnum','userDefautlAvatar','getJwtToken','openId','createMathExpr','svg-captcha','getPhoneInMini','registerSuccessEmailTeamName','getNamespace','length','avatar','validateRegiste','小程序openid不能为空！','WE_APP_APPSECRET','registerSuccessEmailTitle','loginInMinigin','用户名不可修改','WE_MINI_APPSECRET','邮箱格式错误！','registerFailEmailTeamName','qureyUserInfoByInviteCode','nickname','openid','loginWithWechatApp:\x20','createUser','GlobalConfigService','del','Repository'];_0x1a86=function(){return _0x3f08a9;};return _0x1a86();}var __decorate=this&&this['__decorate']||function(_0x1ed4d6,_0x120b62,_0x3ad060,_0x1fae58){const _0x528fcc=_0x40ef;var _0xe7cf43=arguments[_0x528fcc(0x18c)],_0x42b404=_0xe7cf43<0x3?_0x120b62:_0x1fae58===null?_0x1fae58=Object[_0x528fcc(0x20d)](_0x120b62,_0x3ad060):_0x1fae58,_0x57e2e1;if(typeof Reflect===_0x528fcc(0x1c4)&&typeof Reflect[_0x528fcc(0x1d7)]===_0x528fcc(0x140))_0x42b404=Reflect[_0x528fcc(0x1d7)](_0x1ed4d6,_0x120b62,_0x3ad060,_0x1fae58);else{for(var _0x53b69a=_0x1ed4d6[_0x528fcc(0x18c)]-0x1;_0x53b69a>=0x0;_0x53b69a--)if(_0x57e2e1=_0x1ed4d6[_0x53b69a])_0x42b404=(_0xe7cf43<0x3?_0x57e2e1(_0x42b404):_0xe7cf43>0x3?_0x57e2e1(_0x120b62,_0x3ad060,_0x42b404):_0x57e2e1(_0x120b62,_0x3ad060))||_0x42b404;}return _0xe7cf43>0x3&&_0x42b404&&Object[_0x528fcc(0x182)](_0x120b62,_0x3ad060,_0x42b404),_0x42b404;},__metadata=this&&this['__metadata']||function(_0x594fdd,_0x20b1b3){const _0x151010=_0x40ef;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x151010(0x140))return Reflect['metadata'](_0x594fdd,_0x20b1b3);},__param=this&&this[_0x116a86(0x1b8)]||function(_0x39a7dc,_0x409aa4){return function(_0xd9e441,_0x5aeeae){_0x409aa4(_0xd9e441,_0x5aeeae,_0x39a7dc);};};Object[_0x116a86(0x182)](exports,_0x116a86(0x169),{'value':!![]}),exports[_0x116a86(0x1aa)]=void 0x0;const globalConfig_service_1=require(_0x116a86(0x166)),access_service_1=require(_0x116a86(0x1cd)),verification_constant_1=require(_0x116a86(0x16b)),verification_service_1=require('./../verification/verification.service'),user_entity_1=require('./../user/user.entity'),common_1=require(_0x116a86(0x1a5)),jwt_1=require('@nestjs/jwt'),user_service_1=require(_0x116a86(0x1cb)),mailer_service_1=require(_0x116a86(0x1ff)),user_constant_1=require(_0x116a86(0x16f)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x116a86(0x204)),typeorm_2=require('@nestjs/typeorm'),utils_1=require(_0x116a86(0x157)),os=require('os'),redisCache_service_1=require(_0x116a86(0x1bb)),svgCaptcha=require(_0x116a86(0x188)),bcrypt=require(_0x116a86(0x1ac)),status_constant_1=require(_0x116a86(0x1d6)),WechatConfig_1=require(_0x116a86(0x13c)),axios_1=require(_0x116a86(0x17d)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),Login_vo_1=require('./vo/Login.vo'),WeAppLogin_vo_1=require('./vo/WeAppLogin.vo');let AuthService=class AuthService{constructor(_0x440350,_0x293194,_0x118d69,_0x18c830,_0x4ba907,_0x564980,_0x1bb5d2,_0x3b8db0,_0x3811e7){const _0x8bad2c=_0x116a86;this['userEntity']=_0x440350,this[_0x8bad2c(0x1e2)]=_0x293194,this['userService']=_0x118d69,this[_0x8bad2c(0x1dc)]=_0x18c830,this[_0x8bad2c(0x15c)]=_0x4ba907,this[_0x8bad2c(0x1d8)]=_0x564980,this[_0x8bad2c(0x1e4)]=_0x1bb5d2,this['globalConfigService']=_0x3b8db0,this[_0x8bad2c(0x1a9)]=_0x3811e7;}async[_0x116a86(0x213)](){const _0x2e1144=_0x116a86;this[_0x2e1144(0x130)]();}async['register'](_0x554bea,_0x38b0d1){const _0x69b17f=_0x116a86;await this[_0x69b17f(0x1d8)]['verifyCaptcha'](_0x554bea);const _0x52bd62=await this['userService'][_0x69b17f(0x1f7)](_0x554bea,_0x38b0d1),{username:_0x435343,email:_0x806c60,client:_0x5eac9e,id:_0x32b7f0}=_0x52bd62,_0x189e61={'username':_0x435343,'email':_0x806c60,'id':_0x32b7f0};return _0x5eac9e&&(_0x189e61[_0x69b17f(0x1c9)]=_0x5eac9e),_0x189e61;}async[_0x116a86(0x1d1)](_0x937960,_0x457bea){const _0x5bfec1=_0x116a86;return this[_0x5bfec1(0x19b)](_0x937960);}async[_0x116a86(0x1f2)](_0x369d8c,_0x3afe51){const _0x1b8995=_0x116a86,_0x5f21e9=await this[_0x1b8995(0x15f)][_0x1b8995(0x1a1)](_0x369d8c),{username:_0xdb320,id:_0xcbb55c,email:_0x1bd49a,role:_0x2a6182,openId:_0x377c68,client:_0x1ee985}=_0x5f21e9,_0x27172a=(0x0,utils_1['getClientIp'])(_0x3afe51);await this[_0x1b8995(0x15f)][_0x1b8995(0x1ae)](_0xcbb55c,_0x27172a);const _0x3942b8=this[_0x1b8995(0x1dc)]['sign']({'username':_0xdb320,'id':_0xcbb55c,'email':_0x1bd49a,'role':_0x2a6182,'openId':_0x377c68,'client':_0x1ee985});return await this[_0x1b8995(0x1e4)]['saveToken'](_0xcbb55c,_0x3942b8),_0x3942b8;}async['loginV4'](_0x10d6a3,_0x4732d1){const _0x4d82b1=_0x116a86;try{const _0x3923bc=await this['userEntity'][_0x4d82b1(0x16e)]({'where':[{'username':_0x10d6a3[_0x4d82b1(0x207)]},{'email':_0x10d6a3['username']},{'phone':_0x10d6a3[_0x4d82b1(0x207)]}]});if(!_0x3923bc)throw new Error(_0x4d82b1(0x1b5));if(!_0x3923bc[_0x4d82b1(0x219)])throw new Error('用户名或密码错误！');if(!bcrypt[_0x4d82b1(0x1fe)](_0x10d6a3['password'],_0x3923bc[_0x4d82b1(0x219)]))throw new Error(_0x4d82b1(0x1b5));_0x3923bc[_0x4d82b1(0x207)]&&!_0x3923bc[_0x4d82b1(0x1b6)]&&await this[_0x4d82b1(0x15f)][_0x4d82b1(0x181)](_0x3923bc);const _0x1fee88=(0x0,utils_1[_0x4d82b1(0x1d4)])(_0x4732d1);await this[_0x4d82b1(0x15f)][_0x4d82b1(0x1ae)](_0x3923bc['id'],_0x1fee88);const _0x277326=this[_0x4d82b1(0x1dc)]['sign']({'id':_0x3923bc['id'],'role':_0x3923bc[_0x4d82b1(0x1f1)],'email':_0x3923bc[_0x4d82b1(0x1d9)],'openId':_0x3923bc['openId'],'client':_0x3923bc[_0x4d82b1(0x1c9)],'username':_0x3923bc['username']});return await this['redisCacheService'][_0x4d82b1(0x137)](_0x3923bc['id'],_0x277326),_0x277326;}catch(_0x1abf4f){throw new common_1[(_0x4d82b1(0x155))](_0x1abf4f[_0x4d82b1(0x1a6)],common_1[_0x4d82b1(0x1ab)]['BAD_REQUEST']);}}async[_0x116a86(0x21e)](_0x71935a){const _0x54b711=_0x116a86,{username:_0x338642,password:_0x5b18a6}=_0x71935a;if(!_0x338642||!_0x5b18a6)throw new common_1[(_0x54b711(0x155))](_0x54b711(0x133),common_1[_0x54b711(0x1ab)][_0x54b711(0x176)]);const _0x314e7f=await this[_0x54b711(0x15f)]['getOne'](_0x338642);if(!_0x314e7f)throw new common_1[(_0x54b711(0x155))](_0x54b711(0x1e3),common_1[_0x54b711(0x1ab)][_0x54b711(0x176)]);if((0x0,utils_1[_0x54b711(0x144)])(_0x5b18a6,_0x314e7f[_0x54b711(0x219)]))throw new common_1['HttpException'](_0x54b711(0x1bc),common_1[_0x54b711(0x1ab)]['BAD_REQUEST']);if(_0x314e7f[_0x54b711(0x1f1)]!==_0x54b711(0x202)){const _0x3d3c58=await this['accessService']['getOne'](_0x314e7f['id']);if(_0x3d3c58[_0x54b711(0x14d)]===status_constant_1[_0x54b711(0x20f)][_0x54b711(0x1c8)])throw new common_1[(_0x54b711(0x155))](_0x54b711(0x1b1),common_1[_0x54b711(0x1ab)][_0x54b711(0x176)]);}const {email:_0x1844a9,id:_0x143f18,role:_0x2fb7c8,openId:_0x2b2b52,client:_0x4ecdaf}=_0x314e7f;return this['jwtService'][_0x54b711(0x208)]({'username':_0x338642,'openId':_0x2b2b52,'id':_0x143f18,'email':_0x1844a9,'role':_0x2fb7c8,'client':_0x4ecdaf});}async['loginByPhone'](_0x15b7ec,_0x4b7b59){const _0x300a6b=_0x116a86,_0x10ad12=await this[_0x300a6b(0x15f)][_0x300a6b(0x1a1)](_0x15b7ec),{username:_0x2ee2d7,id:_0x4045db,email:_0xf8d4dc,role:_0x3349cd,openId:_0x3fdf7c,client:_0x5a0853}=_0x10ad12,_0x3a14ef=(0x0,utils_1[_0x300a6b(0x1d4)])(_0x4b7b59);await this[_0x300a6b(0x15f)][_0x300a6b(0x1ae)](_0x4045db,_0x3a14ef);const {phone:_0x568fa1}=_0x15b7ec,_0x3ba522=await this[_0x300a6b(0x1dc)]['sign']({'username':_0x2ee2d7,'id':_0x4045db,'email':_0xf8d4dc,'role':_0x3349cd,'openId':_0x3fdf7c,'client':_0x5a0853,'phone':_0x568fa1});return await this[_0x300a6b(0x1e4)][_0x300a6b(0x137)](_0x4045db,_0x3ba522),_0x3ba522;}async['loginByPhoneV3'](_0x9592d2,_0x1327c5){const _0x3feb3f=_0x116a86;await this['validatePhoneCode'](_0x9592d2[_0x3feb3f(0x173)],_0x9592d2[_0x3feb3f(0x1b4)]);let _0x6af033=await this[_0x3feb3f(0x170)][_0x3feb3f(0x16e)]({'where':{'phone':_0x9592d2['phone']}});if(!_0x6af033){const _0x11ec3d=new user_entity_1['UserEntity']();_0x11ec3d[_0x3feb3f(0x173)]=_0x9592d2['phone'],_0x11ec3d[_0x3feb3f(0x198)]=_0x9592d2[_0x3feb3f(0x173)],_0x11ec3d[_0x3feb3f(0x172)]=user_constant_1[_0x3feb3f(0x1df)][_0x3feb3f(0x14b)],_0x11ec3d[_0x3feb3f(0x18d)]=await this[_0x3feb3f(0x1ba)]['getConfigs'](['userDefautlAvatar']),_0x6af033=await this['userService'][_0x3feb3f(0x19b)](_0x11ec3d),this[_0x3feb3f(0x1a8)](_0x6af033,_0x9592d2['invitedBy']);}const _0x2a14ee=(0x0,utils_1[_0x3feb3f(0x1d4)])(_0x1327c5);await this[_0x3feb3f(0x15f)][_0x3feb3f(0x1ae)](_0x6af033['id'],_0x2a14ee);const {id:_0x5c551d,role:_0xd10636,email:_0x55d84e,client:_0x12f06f,openId:_0x29022b,username:_0x44c7db}=_0x6af033,_0x4f6981=this['jwtService'][_0x3feb3f(0x208)]({'id':_0x5c551d,'role':_0xd10636,'email':_0x55d84e,'client':_0x12f06f,'openId':_0x29022b,'username':_0x44c7db});return await this[_0x3feb3f(0x1e4)][_0x3feb3f(0x137)](_0x5c551d,_0x4f6981),_0x4f6981;}async[_0x116a86(0x185)](_0x1baeb3,_0x2b29c5){const _0x455a4f=_0x116a86,{status:_0xc53a9c}=_0x1baeb3;if(_0xc53a9c!==user_constant_1['UserStatusEnum'][_0x455a4f(0x14b)])throw new common_1[(_0x455a4f(0x155))](user_constant_1[_0x455a4f(0x1ed)][_0xc53a9c],common_1['HttpStatus'][_0x455a4f(0x176)]);const {username:_0x182c5a,id:_0xb55d16,email:_0x5bce37,role:_0x3c2852,openId:_0x33313d,client:_0x2961c7}=_0x1baeb3,_0x20021b=(0x0,utils_1[_0x455a4f(0x1d4)])(_0x2b29c5);await this[_0x455a4f(0x15f)][_0x455a4f(0x1ae)](_0xb55d16,_0x20021b);const _0x448abd=await this[_0x455a4f(0x1dc)]['sign']({'username':_0x182c5a,'id':_0xb55d16,'email':_0x5bce37,'role':_0x3c2852,'openId':_0x33313d,'client':_0x2961c7});return await this[_0x455a4f(0x1e4)]['saveToken'](_0xb55d16,_0x448abd),_0x448abd;}async[_0x116a86(0x15b)](_0x135b5f,_0x3441ea){const _0x336b73=_0x116a86,{status:_0x3071ed}=_0x135b5f;if(_0x3071ed!==user_constant_1[_0x336b73(0x1df)][_0x336b73(0x14b)])throw new common_1['HttpException'](user_constant_1[_0x336b73(0x1ed)][_0x3071ed],common_1['HttpStatus'][_0x336b73(0x176)]);const {username:_0xeafcd3,id:_0x213fa9,email:_0x32d1b0,role:_0x2118bf,openId:_0x37a829,client:_0x45d551}=_0x135b5f,_0x9c27fe=(0x0,utils_1[_0x336b73(0x1d4)])(_0x3441ea);await this[_0x336b73(0x15f)][_0x336b73(0x1ae)](_0x213fa9,_0x9c27fe);const _0x1c89da=await this[_0x336b73(0x1dc)][_0x336b73(0x208)]({'username':_0xeafcd3,'id':_0x213fa9,'email':_0x32d1b0,'role':_0x2118bf,'openId':_0x37a829,'client':_0x45d551});return await this[_0x336b73(0x1e4)][_0x336b73(0x137)](_0x213fa9,_0x1c89da),_0x1c89da;}async['getInfo'](_0x538713){const _0x214998=_0x116a86,{id:_0x8a82c3}=_0x538713[_0x214998(0x178)];return await this[_0x214998(0x15f)][_0x214998(0x20c)](_0x8a82c3);}async[_0x116a86(0x143)](_0x22f829,_0x909cc6){const _0x2373bc=_0x116a86,_0x433105=await this[_0x2373bc(0x1e2)][_0x2373bc(0x1b2)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x2373bc(0x191),'registerSuccessEmailTeamName',_0x2373bc(0x13d),'registerFailEmailTitle',_0x2373bc(0x196)])}}),_0x29b07d=_0x433105[_0x2373bc(0x139)]((_0x39585f,_0x28bc51)=>{const _0x40ef91=_0x2373bc;return _0x39585f[_0x28bc51['configKey']]=_0x28bc51[_0x40ef91(0x1fb)],_0x39585f;},{});try{const _0x430094=await this[_0x2373bc(0x1d8)][_0x2373bc(0x148)](_0x22f829,verification_constant_1[_0x2373bc(0x183)][_0x2373bc(0x141)]),{type:_0x21f3a7,userId:_0xc86986}=_0x430094;if(_0x21f3a7!==verification_constant_1['VerificationEnum']['Registration'])throw new common_1[(_0x2373bc(0x155))](_0x2373bc(0x152),common_1['HttpStatus'][_0x2373bc(0x176)]);const _0x5023e3=await this[_0x2373bc(0x15f)]['getUserStatus'](_0xc86986);if(_0x5023e3===user_constant_1[_0x2373bc(0x1df)][_0x2373bc(0x14b)])throw new common_1[(_0x2373bc(0x155))](_0x2373bc(0x13a),common_1[_0x2373bc(0x1ab)][_0x2373bc(0x176)]);await this['userService'][_0x2373bc(0x212)](_0x430094[_0x2373bc(0x16a)],user_constant_1[_0x2373bc(0x1df)][_0x2373bc(0x14b)]);const _0x2424e9=await this[_0x2373bc(0x15f)][_0x2373bc(0x1ec)](_0x430094['userId']),{username:_0x2a769d,email:_0x5c9604,id:_0x25f80c,invitedBy:_0x281243}=_0x2424e9;let _0x592164;_0x281243&&(_0x592164=await this[_0x2373bc(0x15f)][_0x2373bc(0x197)](_0x281243)),await this[_0x2373bc(0x15f)][_0x2373bc(0x1fa)](_0x2424e9,_0x592164),_0x909cc6[_0x2373bc(0x211)]('/api/auth/registerSuccess?id='+_0x25f80c[_0x2373bc(0x154)]()[_0x2373bc(0x1bf)](0x4,'0')+_0x2373bc(0x135)+_0x2a769d+_0x2373bc(0x1e5)+_0x5c9604+_0x2373bc(0x1c5)+_0x29b07d[_0x2373bc(0x191)]+'&registerSuccessEmailTeamName='+_0x29b07d[_0x2373bc(0x18a)]+'&registerSuccessEmaileAppend='+_0x29b07d['registerSuccessEmaileAppend']);}catch(_0x34e8d3){console[_0x2373bc(0x1a3)]('error:\x20',_0x34e8d3);const _0x5c74b2=_0x34e8d3['response'];_0x909cc6[_0x2373bc(0x211)]('/api/auth/registerError?message='+_0x5c74b2+_0x2373bc(0x218)+_0x29b07d['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x29b07d[_0x2373bc(0x196)]);}}async['changeEmail'](_0x38c67d,_0x4931ff){const _0x2d9d6e=_0x116a86,_0xba9dfe=await this[_0x2d9d6e(0x1e2)][_0x2d9d6e(0x1b2)]({'where':{'configKey':(0x0,typeorm_1['In'])(['registerSuccessEmailTitle',_0x2d9d6e(0x18a),_0x2d9d6e(0x13d),_0x2d9d6e(0x1e0),_0x2d9d6e(0x196)])}}),_0xed1364=_0xba9dfe[_0x2d9d6e(0x139)]((_0x175ca7,_0x42ed48)=>{const _0x18fe17=_0x2d9d6e;return _0x175ca7[_0x42ed48[_0x18fe17(0x1eb)]]=_0x42ed48[_0x18fe17(0x1fb)],_0x175ca7;},{});try{const _0x174647=await this['verificationService']['verifyCode'](_0x38c67d,verification_constant_1['VerificationEnum'][_0x2d9d6e(0x1a0)]),{type:_0x546e74,userId:_0x4d810d}=_0x174647;if(_0x546e74!==verification_constant_1[_0x2d9d6e(0x183)]['ChangeEmail'])throw new common_1[(_0x2d9d6e(0x155))](_0x2d9d6e(0x152),common_1[_0x2d9d6e(0x1ab)][_0x2d9d6e(0x176)]);let _0xe9582b=await this[_0x2d9d6e(0x170)][_0x2d9d6e(0x16e)]({'where':{'id':_0x4d810d}});_0xe9582b['email']=_0x38c67d[_0x2d9d6e(0x1d9)],_0xe9582b=await this[_0x2d9d6e(0x170)]['save'](_0xe9582b);const {id:_0x4d98d7,username:_0x4fba30,email:_0x42a3d7}=_0xe9582b;_0x4931ff['redirect'](_0x2d9d6e(0x158)+_0x4d98d7[_0x2d9d6e(0x154)]()[_0x2d9d6e(0x1bf)](0x4,'0')+_0x2d9d6e(0x135)+_0x4fba30+_0x2d9d6e(0x1e5)+_0x42a3d7+_0x2d9d6e(0x1c5)+_0xed1364['registerSuccessEmailTitle']+_0x2d9d6e(0x179)+_0xed1364['registerSuccessEmailTeamName']+_0x2d9d6e(0x220)+_0xed1364[_0x2d9d6e(0x13d)]);}catch(_0x42d339){const _0x2701a0=_0x42d339[_0x2d9d6e(0x21f)];_0x4931ff[_0x2d9d6e(0x211)](_0x2d9d6e(0x147)+_0x2701a0+_0x2d9d6e(0x218)+_0xed1364[_0x2d9d6e(0x1e0)]+'&registerFailEmailTeamName='+_0xed1364[_0x2d9d6e(0x196)]);}}async['updatePassword'](_0x8e1aac,_0x542da7){const _0x29de69=_0x116a86,{id:_0x4cfe2e,client:_0x1ec33b,role:_0x34fb00}=_0x8e1aac['user'];if(_0x1ec33b&&Number(_0x1ec33b)>0x0)throw new common_1[(_0x29de69(0x155))]('无权此操作、请联系管理员！',common_1[_0x29de69(0x1ab)][_0x29de69(0x176)]);if(_0x34fb00===_0x29de69(0x1b9))throw new common_1['HttpException'](_0x29de69(0x153),common_1['HttpStatus'][_0x29de69(0x176)]);const {username:_0x44e7f9,oldPassword:_0x3aa882,password:_0x433639}=_0x542da7,_0x9e88ac=await this['userEntity']['findOne']({'where':{'id':_0x4cfe2e}});if(_0x9e88ac[_0x29de69(0x207)]&&_0x44e7f9)throw new common_1[(_0x29de69(0x155))](_0x29de69(0x193),common_1[_0x29de69(0x1ab)][_0x29de69(0x176)]);if(_0x9e88ac[_0x29de69(0x219)]){if(!_0x3aa882)throw new common_1[(_0x29de69(0x155))]('原密码不可为空',common_1[_0x29de69(0x1ab)]['BAD_REQUEST']);const _0x547a02=bcrypt['compareSync'](_0x3aa882,_0x9e88ac[_0x29de69(0x219)]);if(!_0x547a02)throw new common_1[(_0x29de69(0x155))](_0x29de69(0x1d5),common_1['HttpStatus']['BAD_REQUEST']);}return _0x9e88ac['username']=_0x9e88ac['username']??_0x44e7f9,_0x9e88ac[_0x29de69(0x219)]=bcrypt['hashSync'](_0x433639,0xa),await this[_0x29de69(0x170)]['save'](_0x9e88ac),'密码修改成功';}async[_0x116a86(0x156)](_0x13a308,_0x43a6c2){const _0x42bd8f=_0x116a86,_0x941e7f=_0x13a308['user']['id'],_0x1a4a51=await this[_0x42bd8f(0x170)][_0x42bd8f(0x16e)]({'where':{'email':_0x43a6c2[_0x42bd8f(0x1d9)]}});if(_0x1a4a51)throw new common_1['HttpException'](_0x42bd8f(0x136),axios_1[_0x42bd8f(0x19f)][_0x42bd8f(0x1f3)]);const _0x547a17=await this[_0x42bd8f(0x170)][_0x42bd8f(0x16e)]({'where':{'id':_0x941e7f}}),_0x178137=await this[_0x42bd8f(0x1e2)][_0x42bd8f(0x1b2)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x42bd8f(0x17f),_0x42bd8f(0x1c0),_0x42bd8f(0x1b0),_0x42bd8f(0x1c1),_0x42bd8f(0x17e),_0x42bd8f(0x1ca)])}}),_0x2c9a41=_0x178137['reduce']((_0x2e18ca,_0x2a65fc)=>{const _0x4c0cba=_0x42bd8f;return _0x2e18ca[_0x2a65fc['configKey']]=_0x2a65fc[_0x4c0cba(0x1fb)],_0x2e18ca;},{});_0x547a17['email']=_0x43a6c2['email'];const _0x5a56c8=_0x2c9a41['registerVerifyExpir']?Number(_0x2c9a41[_0x42bd8f(0x1ca)]):0x1e*0x3c,_0x4df9ed=await this[_0x42bd8f(0x1d8)][_0x42bd8f(0x1e8)](_0x547a17,verification_constant_1[_0x42bd8f(0x183)]['ChangeEmail'],_0x5a56c8),{code:_0x5da322,email:_0x135c38,id:_0x327a02}=_0x4df9ed,{registerVerifyEmailFrom:_0x574502}=_0x2c9a41;await this[_0x42bd8f(0x15c)]['sendMail']({'to':_0x135c38,'template':_0x42bd8f(0x214),'subject':'来自'+_0x574502+_0x42bd8f(0x1de),'context':{'id':_0x327a02,'code':_0x5da322,'email':_0x135c38,..._0x2c9a41,'baseUrl':_0x2c9a41[_0x42bd8f(0x1c0)]}});}async[_0x116a86(0x221)](_0x1edcde,_0x2902c8){const _0x3b0b0d=_0x116a86,{id:_0x552f12,client:_0x2bfa67}=_0x1edcde[_0x3b0b0d(0x178)];if(!_0x2bfa67)throw new common_1[(_0x3b0b0d(0x155))](_0x3b0b0d(0x21a),common_1[_0x3b0b0d(0x1ab)]['BAD_REQUEST']);return this[_0x3b0b0d(0x15f)][_0x3b0b0d(0x14e)](_0x552f12,_0x2902c8[_0x3b0b0d(0x219)]),'密码修改成功';}[_0x116a86(0x130)](){const _0x47870f=_0x116a86;let _0x43a6e1;const _0x369bdb=os[_0x47870f(0x1af)]();Object[_0x47870f(0x20e)](_0x369bdb)['forEach'](_0x23abc5=>{const _0x446a71=_0x47870f,_0x2482e9=_0x369bdb[_0x23abc5];for(let _0x3828ec=0x0;_0x3828ec<_0x2482e9['length'];_0x3828ec++){const _0x2f796e=_0x2482e9[_0x3828ec];if(_0x2f796e['family']===_0x446a71(0x223)&&_0x2f796e['address']!==_0x446a71(0x168)&&!_0x2f796e[_0x446a71(0x1e6)]){_0x43a6e1=_0x2f796e[_0x446a71(0x151)];break;}}});}async['captcha'](_0x3a8002){const _0x1e4e1c=_0x116a86,_0x55ae5c=await this['globalConfigService'][_0x1e4e1c(0x18b)](),{color:color=_0x1e4e1c(0x1d2)}=_0x3a8002,_0x413c04=svgCaptcha[_0x1e4e1c(0x187)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x8e0c10=_0x413c04[_0x1e4e1c(0x1ef)],_0x486699=(0x0,utils_1[_0x1e4e1c(0x1f4)])(),_0x52fd74=_0x55ae5c+_0x1e4e1c(0x17c)+_0x486699;return await this[_0x1e4e1c(0x1e4)][_0x1e4e1c(0x217)]({'key':_0x52fd74,'val':_0x413c04[_0x1e4e1c(0x1ef)]},0x5*0x3c),{'svgCode':_0x413c04[_0x1e4e1c(0x1b3)],'code':_0x486699};}async['sendPhoneCode'](_0x49fbdd){const _0x960c27=_0x116a86;_0x49fbdd[_0x960c27(0x1a4)]&&await this[_0x960c27(0x1d8)][_0x960c27(0x174)](_0x49fbdd);const {phone:_0x81a42b}=_0x49fbdd,_0x27a259=await this[_0x960c27(0x1ba)]['getNamespace'](),_0x575036=_0x27a259+_0x960c27(0x160)+_0x81a42b,_0x95adcc=await this['redisCacheService'][_0x960c27(0x203)](_0x575036);if(_0x95adcc&&_0x95adcc>0x0)throw new common_1['HttpException'](_0x95adcc+'秒内不得重复发送短信！',common_1[_0x960c27(0x1ab)]['BAD_REQUEST']);const _0x35e370=(0x0,utils_1[_0x960c27(0x146)])(),_0x39dec7={'phone':_0x81a42b,'code':_0x35e370};return await this[_0x960c27(0x1d8)]['sendPhoneCode'](_0x39dec7),await this['redisCacheService'][_0x960c27(0x217)]({'key':_0x575036,'val':_0x35e370},0x1*0x3c),_0x960c27(0x163);}async[_0x116a86(0x21d)](_0x5df61d){const _0x25fef5=_0x116a86;try{var _0x1e4056=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x1e4056[_0x25fef5(0x1ad)](_0x5df61d))throw new Error(_0x25fef5(0x195));const _0x5b3a6f=await this['userEntity'][_0x25fef5(0x16e)]({'where':{'email':_0x5df61d}});if(_0x5b3a6f)throw new Error(_0x25fef5(0x1da));const _0x479907=await this[_0x25fef5(0x1e2)][_0x25fef5(0x1b2)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x25fef5(0x1c0),'registerVerifyEmailTitle',_0x25fef5(0x1c1),_0x25fef5(0x17e),_0x25fef5(0x1ca)])}}),_0x1b5df0=_0x479907[_0x25fef5(0x139)]((_0x246bd4,_0x41cbc5)=>{const _0x6d4582=_0x25fef5;return _0x246bd4[_0x41cbc5['configKey']]=_0x41cbc5[_0x6d4582(0x1fb)],_0x246bd4;},{}),_0x3f8078=(0x0,utils_1[_0x25fef5(0x146)])(),_0xf78bdb=_0x1b5df0[_0x25fef5(0x1ca)]?Number(_0x1b5df0[_0x25fef5(0x1ca)]):0x1e*0x3c;await this[_0x25fef5(0x1e4)][_0x25fef5(0x217)]({'key':redisKey_constant_1['EMAIL_REGISTE']+_0x5df61d,'val':_0x3f8078},_0xf78bdb*0x3c),await this[_0x25fef5(0x15c)][_0x25fef5(0x1f9)]({'to':_0x5df61d,'template':'emailVerify','subject':'来自'+_0x1b5df0['registerVerifyEmailFrom']+_0x25fef5(0x1b7),'context':{'baseUrl':_0x1b5df0[_0x25fef5(0x1c0)],'code':_0x3f8078,..._0x1b5df0}});}catch(_0x5e198f){throw new common_1[(_0x25fef5(0x155))](_0x5e198f[_0x25fef5(0x1a6)],common_1[_0x25fef5(0x1ab)][_0x25fef5(0x176)]);}}[_0x116a86(0x13b)](_0x12ce69){const _0xb1f3e0=_0x116a86,_0x2802d6=this['jwtService'][_0xb1f3e0(0x208)]({'username':'游客'+_0x12ce69,'id':_0x12ce69,'email':_0x12ce69+'@nine.com','role':_0xb1f3e0(0x1c6),'openId':null,'client':null});return _0x2802d6;}async[_0x116a86(0x134)](_0x7444c2,_0x3aea18){const _0x17f6f1=_0x116a86,_0xd2aeaf=await this[_0x17f6f1(0x1ba)]['getNamespace'](),_0x27d729=_0xd2aeaf+_0x17f6f1(0x160)+_0x7444c2;if(_0x3aea18===_0x17f6f1(0x1d3))return;const _0xc1c4be=await this['redisCacheService']['get']({'key':_0x27d729});if(!_0xc1c4be)throw new common_1[(_0x17f6f1(0x155))](_0x17f6f1(0x167),common_1[_0x17f6f1(0x1ab)][_0x17f6f1(0x176)]);if(_0x3aea18!==_0xc1c4be)throw new common_1[(_0x17f6f1(0x155))](_0x17f6f1(0x209),common_1[_0x17f6f1(0x1ab)][_0x17f6f1(0x176)]);}async[_0x116a86(0x18e)](_0x47c453){const _0x25454b=_0x116a86;await this[_0x25454b(0x15f)]['verifyUserRegisterByPhone'](_0x47c453),await this[_0x25454b(0x134)](_0x47c453[_0x25454b(0x173)],_0x47c453[_0x25454b(0x1b4)]);}async[_0x116a86(0x1a8)](_0x9bb7ce,_0x1121b2){const _0x1cdfaf=_0x116a86;let _0x31eb8c;_0x1121b2&&(_0x31eb8c=await this[_0x1cdfaf(0x15f)]['qureyUserInfoByInviteCode'](_0x1121b2)),await this[_0x1cdfaf(0x15f)][_0x1cdfaf(0x1fa)](_0x9bb7ce,_0x31eb8c);}async[_0x116a86(0x19b)](_0x7382e5){const _0x92073c=_0x116a86;try{let _0x34d6b5;await this['validateRegiste'](_0x7382e5);const _0x335f78=(0x0,utils_1[_0x92073c(0x1f4)])()+'@gomaxai.com',_0x189987=new user_entity_1[(_0x92073c(0x205))]();_0x189987[_0x92073c(0x207)]=_0x7382e5[_0x92073c(0x207)],_0x189987['password']=_0x7382e5[_0x92073c(0x219)],_0x189987[_0x92073c(0x173)]=_0x7382e5['phone'],_0x189987[_0x92073c(0x1d9)]=_0x335f78,_0x189987[_0x92073c(0x172)]=user_constant_1[_0x92073c(0x1df)][_0x92073c(0x14b)],_0x189987[_0x92073c(0x219)]=bcrypt[_0x92073c(0x21c)](_0x7382e5[_0x92073c(0x219)],0xa);if(_0x7382e5[_0x92073c(0x15a)](_0x92073c(0x1c3))){const _0x45b012=_0x7382e5;_0x189987[_0x92073c(0x18d)]=_0x45b012[_0x92073c(0x18d)],_0x189987[_0x92073c(0x198)]=_0x45b012[_0x92073c(0x198)],_0x189987['miniOpenId']=_0x45b012[_0x92073c(0x1c3)],_0x34d6b5=redisKey_constant_1[_0x92073c(0x20b)]+_0x45b012[_0x92073c(0x1c3)],_0x189987[_0x92073c(0x145)]=await this['redisCacheService'][_0x92073c(0x1f6)]({'key':_0x34d6b5});}else _0x189987['avatar']=await this[_0x92073c(0x1ba)][_0x92073c(0x1fd)]([_0x92073c(0x184)]);const _0x5d48e8=await this['userService'][_0x92073c(0x19b)](_0x189987);this[_0x92073c(0x1a8)](_0x5d48e8,_0x7382e5['invitedBy']);const {username:_0x4a2387,openId:_0x237415,id:_0x155226,role:_0x115654,client:_0x3a0295}=_0x5d48e8,_0x505426=this[_0x92073c(0x1dc)]['sign']({'username':_0x4a2387,'openId':_0x237415,'id':_0x155226,'email':_0x335f78,'role':_0x115654,'client':_0x3a0295});return this[_0x92073c(0x1e4)][_0x92073c(0x19d)]({'key':_0x34d6b5}),_0x505426;}catch(_0x4ee5c6){throw new common_1['HttpException'](_0x4ee5c6[_0x92073c(0x1a6)],common_1[_0x92073c(0x1ab)][_0x92073c(0x176)]);}}async[_0x116a86(0x1be)](){const _0x367b08=_0x116a86;try{const _0x3f576e=process[_0x367b08(0x206)][_0x367b08(0x142)];if(_0x3f576e===_0x367b08(0x150)||_0x3f576e==='ceshi.qumao518.vip'){const _0x4430a1=await axios_1['default']['get'](_0x367b08(0x215));await this[_0x367b08(0x1e4)][_0x367b08(0x217)]({'key':redisKey_constant_1[_0x367b08(0x15d)],'val':_0x4430a1[_0x367b08(0x1b3)][_0x367b08(0x1b3)]});}else{const _0x3a16d6=await axios_1['default'][_0x367b08(0x216)](_0x367b08(0x149),{'grant_type':_0x367b08(0x16d),'appid':WechatConfig_1[_0x367b08(0x171)][_0x367b08(0x17b)],'secret':WechatConfig_1[_0x367b08(0x171)][_0x367b08(0x194)],'force_refresh':![]});await this[_0x367b08(0x1e4)][_0x367b08(0x217)]({'key':redisKey_constant_1[_0x367b08(0x15d)],'val':_0x3a16d6[_0x367b08(0x1b3)][_0x367b08(0x14f)]});}}catch(_0x3519bb){common_1[_0x367b08(0x1dd)]['error'](_0x367b08(0x17a),_0x3519bb);}}async[_0x116a86(0x192)](_0x1d2fd9){const _0x3ae34d=_0x116a86;try{const _0x2c10e4=new Login_vo_1['default'](),_0x274141=await axios_1[_0x3ae34d(0x171)]['get'](_0x3ae34d(0x159),{'params':{'appid':WechatConfig_1[_0x3ae34d(0x171)][_0x3ae34d(0x17b)],'secret':WechatConfig_1['default'][_0x3ae34d(0x194)],'js_code':_0x1d2fd9,'grant_type':_0x3ae34d(0x161)}}),_0x70a495=_0x274141[_0x3ae34d(0x1b3)];if(_0x70a495[_0x3ae34d(0x1c7)])throw new Error(_0x70a495[_0x3ae34d(0x1d0)]);const _0x531574=await this[_0x3ae34d(0x170)][_0x3ae34d(0x16e)]({'where':{'miniOpenId':_0x70a495['openid']}});if(!_0x531574)this[_0x3ae34d(0x1e4)][_0x3ae34d(0x217)]({'key':redisKey_constant_1[_0x3ae34d(0x20b)]+_0x70a495[_0x3ae34d(0x199)],'val':_0x70a495[_0x3ae34d(0x145)]||null});else{const {username:_0x34b8aa,id:_0x50aa09,email:_0x4cf87e,role:_0x413b2d,openId:_0x479b4f,client:_0x1d883c}=_0x531574;_0x2c10e4[_0x3ae34d(0x138)]=this[_0x3ae34d(0x1dc)][_0x3ae34d(0x208)]({'username':_0x34b8aa,'id':_0x50aa09,'email':_0x4cf87e,'role':_0x413b2d,'openId':_0x479b4f,'client':_0x1d883c}),await this[_0x3ae34d(0x1e4)][_0x3ae34d(0x137)](_0x50aa09,_0x2c10e4[_0x3ae34d(0x138)]);}return _0x2c10e4[_0x3ae34d(0x199)]=_0x70a495[_0x3ae34d(0x199)],_0x2c10e4;}catch(_0x5cd47b){common_1[_0x3ae34d(0x1dd)][_0x3ae34d(0x1ce)](_0x3ae34d(0x200),_0x5cd47b);throw new common_1[(_0x3ae34d(0x155))](_0x5cd47b[_0x3ae34d(0x1a6)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x116a86(0x189)](_0x46f4f3){const _0x5419af=_0x116a86;try{const _0x42dfe9=await this[_0x5419af(0x1e4)][_0x5419af(0x1f6)]({'key':redisKey_constant_1[_0x5419af(0x15d)]}),_0x55bffd=await axios_1['default']['post']('https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token='+_0x42dfe9,{'code':_0x46f4f3});if(_0x55bffd[_0x5419af(0x1b3)][_0x5419af(0x1c7)])throw new Error(_0x55bffd[_0x5419af(0x1b3)][_0x5419af(0x1d0)]);return _0x55bffd[_0x5419af(0x1b3)]['phone_info'][_0x5419af(0x20a)];}catch(_0x2a978f){common_1[_0x5419af(0x1dd)][_0x5419af(0x1ce)](_0x5419af(0x222),_0x2a978f);throw new common_1['HttpException'](_0x2a978f[_0x5419af(0x1a6)],common_1['HttpStatus'][_0x5419af(0x176)]);}}['registeInMini'](_0xd979d3){const _0x3c1d6f=_0x116a86;if(!_0xd979d3['miniOpenId'])throw new common_1[(_0x3c1d6f(0x155))](_0x3c1d6f(0x18f),common_1['HttpStatus']['BAD_REQUEST']);return this[_0x3c1d6f(0x19b)](_0xd979d3);}async['loginWithWechatApp'](_0x1f87b4){const _0x402fc0=_0x116a86,_0x15e801=new WeAppLogin_vo_1['WeAppLoginVO']();try{const _0x1faaf5=await axios_1['default'][_0x402fc0(0x1f6)](_0x402fc0(0x21b)+WechatConfig_1[_0x402fc0(0x171)][_0x402fc0(0x1bd)]+_0x402fc0(0x177)+WechatConfig_1[_0x402fc0(0x171)][_0x402fc0(0x190)]+_0x402fc0(0x1e1)+_0x1f87b4+'&grant_type=authorization_code');if(_0x1faaf5[_0x402fc0(0x1b3)][_0x402fc0(0x1c7)])throw new Error(_0x1faaf5['data'][_0x402fc0(0x1d0)]);const _0x50dd25=_0x1faaf5[_0x402fc0(0x1b3)],_0x1a14f8=await this['userEntity'][_0x402fc0(0x16e)]({'where':{'weAppOpenId':_0x50dd25[_0x402fc0(0x199)]}});if(!_0x1a14f8)this['redisCacheService'][_0x402fc0(0x217)]({'key':redisKey_constant_1[_0x402fc0(0x1cf)]+_0x50dd25[_0x402fc0(0x199)],'val':_0x50dd25[_0x402fc0(0x145)]||null});else{const {username:_0x390e90,id:_0x4a060f,email:_0x43f6cf,role:_0x15ca44,openId:_0x4e61c5,client:_0x5b91ec}=_0x1a14f8;_0x15e801[_0x402fc0(0x138)]=this[_0x402fc0(0x1dc)][_0x402fc0(0x208)]({'username':_0x390e90,'id':_0x4a060f,'email':_0x43f6cf,'role':_0x15ca44,'openId':_0x4e61c5,'client':_0x5b91ec}),await this[_0x402fc0(0x1e4)][_0x402fc0(0x137)](_0x4a060f,_0x15e801[_0x402fc0(0x138)]);}return _0x15e801['openid']=_0x50dd25[_0x402fc0(0x199)],_0x15e801[_0x402fc0(0x1db)]=_0x50dd25[_0x402fc0(0x14f)],_0x15e801;}catch(_0x3e344b){common_1['Logger']['error'](_0x402fc0(0x19a),_0x3e344b);throw new common_1['HttpException'](_0x3e344b[_0x402fc0(0x1a6)],common_1[_0x402fc0(0x1ab)][_0x402fc0(0x176)]);}}async['phoneWithOpenId4regist'](_0x2b5a82){const _0x1ddb2e=_0x116a86;try{if(!_0x2b5a82[_0x1ddb2e(0x186)]&&!_0x2b5a82['miniOpenId']&&!_0x2b5a82['weAppOpenId'])throw new Error(_0x1ddb2e(0x14a));let _0x5cef5c='openId',_0x2d79cf={};if(_0x2b5a82[_0x1ddb2e(0x186)])_0x5cef5c=_0x1ddb2e(0x186);else _0x2b5a82[_0x1ddb2e(0x1c3)]?_0x5cef5c=_0x1ddb2e(0x1c3):_0x5cef5c=_0x1ddb2e(0x132);_0x2d79cf[_0x5cef5c]=_0x2b5a82[_0x5cef5c];const _0x19da20=await this[_0x1ddb2e(0x170)]['findOne']({'where':_0x2d79cf});if(_0x19da20&&_0x19da20[_0x1ddb2e(0x173)])return![];const _0x2253ba=await this[_0x1ddb2e(0x170)][_0x1ddb2e(0x16e)]({'where':{'phone':_0x2b5a82[_0x1ddb2e(0x173)]}});if(_0x2253ba)return!_0x2253ba[_0x5cef5c];return!![];}catch(_0xf4dffb){throw new common_1['HttpException'](_0xf4dffb[_0x1ddb2e(0x1a6)],common_1[_0x1ddb2e(0x1ab)]['BAD_REQUEST']);}}async[_0x116a86(0x14c)](_0x58c039,_0xebf456){const _0x4f337c=_0x116a86;try{if(_0x58c039['username']){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x4f337c(0x1ad)](_0x58c039[_0x4f337c(0x207)]))throw new Error(_0x4f337c(0x1e9));if(!_0x58c039[_0x4f337c(0x219)])throw new Error(_0x4f337c(0x210));}else{if(!_0x58c039[_0x4f337c(0x186)]&&!_0x58c039[_0x4f337c(0x1c3)]&&!_0x58c039[_0x4f337c(0x132)])throw new Error(_0x4f337c(0x1f0));}if(_0x58c039[_0x4f337c(0x173)]&&!_0x58c039[_0x4f337c(0x1b4)])throw new Error(_0x4f337c(0x180));let _0x2649d2=null;if(_0x58c039[_0x4f337c(0x173)])await this[_0x4f337c(0x134)](_0x58c039[_0x4f337c(0x173)],_0x58c039[_0x4f337c(0x1b4)]),_0x2649d2=await this[_0x4f337c(0x170)]['findOne']({'where':{'phone':_0x58c039[_0x4f337c(0x173)]}});else{if(_0x58c039['openId']||_0x58c039['miniOpenId']||_0x58c039['weAppOpenId']){let _0x42e7b6=_0x4f337c(0x186),_0x38edbe={};if(_0x58c039[_0x4f337c(0x186)])_0x42e7b6=_0x4f337c(0x186);else _0x58c039['miniOpenId']?_0x42e7b6=_0x4f337c(0x1c3):_0x42e7b6=_0x4f337c(0x132);_0x38edbe[_0x42e7b6]=_0x58c039[_0x42e7b6],_0x2649d2=await this[_0x4f337c(0x170)]['findOne']({'where':_0x38edbe});if(_0x2649d2)throw new Error('当前用户已注册，请勿重复注册！');}else{_0x2649d2=await this[_0x4f337c(0x170)][_0x4f337c(0x16e)]({'where':{'username':_0x58c039['username']}});if(_0x2649d2)throw new Error(_0x4f337c(0x201));}}const _0x50c742=new user_entity_1[(_0x4f337c(0x205))]();for(let _0x5f0835 in _0x58c039){_0x58c039[_0x5f0835]&&(_0x50c742[_0x5f0835]=_0x58c039[_0x5f0835]);}_0x2649d2?_0x50c742['id']=_0x2649d2['id']:(_0x50c742[_0x4f337c(0x219)]&&(_0x50c742['password']=bcrypt[_0x4f337c(0x21c)](_0x58c039[_0x4f337c(0x219)],0xa)),_0x50c742[_0x4f337c(0x172)]=user_constant_1[_0x4f337c(0x1df)][_0x4f337c(0x14b)],!_0x50c742[_0x4f337c(0x198)]&&(_0x50c742[_0x4f337c(0x198)]=_0x50c742[_0x4f337c(0x198)]||'小智'),!_0x50c742[_0x4f337c(0x18d)]&&(_0x50c742['avatar']=await this['globalConfigService']['getConfigs']([_0x4f337c(0x184)])));const _0x5e85c1=await this['userService'][_0x4f337c(0x19b)](_0x50c742);!_0x2649d2&&this[_0x4f337c(0x1a8)](_0x5e85c1,_0x58c039[_0x4f337c(0x164)]);const _0x4e2996=(0x0,utils_1['getClientIp'])(_0xebf456);await this[_0x4f337c(0x15f)][_0x4f337c(0x1ae)](_0x5e85c1['id'],_0x4e2996);const {id:_0x2e7f0f,role:_0x5cd7bb,email:_0x51bb3b,client:_0x3b03ff,openId:_0x36e792,username:_0x4524f4}=_0x5e85c1,_0x403042=this['jwtService'][_0x4f337c(0x208)]({'id':_0x2e7f0f,'role':_0x5cd7bb,'email':_0x51bb3b,'client':_0x3b03ff,'openId':_0x36e792,'username':_0x4524f4});return await this['redisCacheService'][_0x4f337c(0x137)](_0x2e7f0f,_0x403042),_0x403042;}catch(_0x2ded9b){if(_0x2ded9b instanceof common_1[_0x4f337c(0x155)])throw _0x2ded9b;else throw new common_1[(_0x4f337c(0x155))](_0x2ded9b[_0x4f337c(0x1a6)],common_1[_0x4f337c(0x1ab)][_0x4f337c(0x176)]);}}async[_0x116a86(0x13e)](_0x22deb5){const _0x235236=_0x116a86,_0x1ea9a8=await this[_0x235236(0x170)]['count']({'where':{'phone':_0x22deb5}});return _0x1ea9a8>0x0;}async['bindPhone'](_0x15eb25){const _0x36e323=_0x116a86;return await this[_0x36e323(0x134)](_0x15eb25[_0x36e323(0x173)],_0x15eb25[_0x36e323(0x1b4)]),await this[_0x36e323(0x170)][_0x36e323(0x165)]({'id':_0x15eb25[_0x36e323(0x16a)],'phone':_0x15eb25[_0x36e323(0x173)]}),!![];}};AuthService=__decorate([(0x0,common_1[_0x116a86(0x12f)])(),__param(0x0,(0x0,typeorm_2[_0x116a86(0x13f)])(user_entity_1[_0x116a86(0x205)])),__param(0x1,(0x0,typeorm_2[_0x116a86(0x13f)])(config_entity_1['ConfigEntity'])),__metadata(_0x116a86(0x1ee),[typeorm_1[_0x116a86(0x19e)],typeorm_1[_0x116a86(0x19e)],user_service_1['UserService'],jwt_1[_0x116a86(0x1ea)],mailer_service_1['MailerService'],verification_service_1[_0x116a86(0x15e)],redisCache_service_1[_0x116a86(0x1c2)],globalConfig_service_1[_0x116a86(0x19c)],access_service_1['AccessService']])],AuthService),exports[_0x116a86(0x1aa)]=AuthService;