'use strict';const _0x49926f=_0x3bb8;(function(_0x16cc87,_0x1cda86){const _0xd9c731=_0x3bb8,_0x3ae239=_0x16cc87();while(!![]){try{const _0x25a65e=-parseInt(_0xd9c731(0x219))/0x1*(parseInt(_0xd9c731(0x1d7))/0x2)+parseInt(_0xd9c731(0x23c))/0x3*(-parseInt(_0xd9c731(0x234))/0x4)+-parseInt(_0xd9c731(0x21b))/0x5+parseInt(_0xd9c731(0x211))/0x6*(-parseInt(_0xd9c731(0x1de))/0x7)+parseInt(_0xd9c731(0x1d5))/0x8*(-parseInt(_0xd9c731(0x22d))/0x9)+-parseInt(_0xd9c731(0x252))/0xa*(parseInt(_0xd9c731(0x191))/0xb)+-parseInt(_0xd9c731(0x1f8))/0xc*(-parseInt(_0xd9c731(0x238))/0xd);if(_0x25a65e===_0x1cda86)break;else _0x3ae239['push'](_0x3ae239['shift']());}catch(_0x4b0a88){_0x3ae239['push'](_0x3ae239['shift']());}}}(_0x53e1,0xa6812));var __decorate=this&&this[_0x49926f(0x27b)]||function(_0x13bbec,_0x5978c2,_0x1da33b,_0x3b1c03){const _0x3d314e=_0x49926f;var _0x504f2d=arguments[_0x3d314e(0x20e)],_0x2ff3ec=_0x504f2d<0x3?_0x5978c2:_0x3b1c03===null?_0x3b1c03=Object[_0x3d314e(0x18d)](_0x5978c2,_0x1da33b):_0x3b1c03,_0x2ccfc4;if(typeof Reflect==='object'&&typeof Reflect['decorate']==='function')_0x2ff3ec=Reflect['decorate'](_0x13bbec,_0x5978c2,_0x1da33b,_0x3b1c03);else{for(var _0xd84229=_0x13bbec[_0x3d314e(0x20e)]-0x1;_0xd84229>=0x0;_0xd84229--)if(_0x2ccfc4=_0x13bbec[_0xd84229])_0x2ff3ec=(_0x504f2d<0x3?_0x2ccfc4(_0x2ff3ec):_0x504f2d>0x3?_0x2ccfc4(_0x5978c2,_0x1da33b,_0x2ff3ec):_0x2ccfc4(_0x5978c2,_0x1da33b))||_0x2ff3ec;}return _0x504f2d>0x3&&_0x2ff3ec&&Object[_0x3d314e(0x257)](_0x5978c2,_0x1da33b,_0x2ff3ec),_0x2ff3ec;},__metadata=this&&this[_0x49926f(0x26e)]||function(_0x55269c,_0x18c2a4){const _0x1bec68=_0x49926f;if(typeof Reflect===_0x1bec68(0x1f6)&&typeof Reflect[_0x1bec68(0x1da)]===_0x1bec68(0x1bd))return Reflect['metadata'](_0x55269c,_0x18c2a4);},__param=this&&this[_0x49926f(0x1c8)]||function(_0x4d3042,_0x51189d){return function(_0x4f1f26,_0x4fac1c){_0x51189d(_0x4f1f26,_0x4fac1c,_0x4d3042);};};function _0x3bb8(_0x17d131,_0x57d8ad){const _0x53e11d=_0x53e1();return _0x3bb8=function(_0x3bb811,_0x550582){_0x3bb811=_0x3bb811-0x186;let _0x16b6ca=_0x53e11d[_0x3bb811];return _0x16b6ca;},_0x3bb8(_0x17d131,_0x57d8ad);}Object[_0x49926f(0x257)](exports,'__esModule',{'value':!![]}),exports[_0x49926f(0x1d2)]=void 0x0;function _0x53e1(){const _0x1978cf=['验证码填写错误、请重新输入！','authorization_code','&username=','SigninEntity','#fff','&registerSuccessEmailTitle=','globalConfigService','registerFailEmailTitle','手机号不能为空','getJwtToken','WE_MINI_ACCESS_KEY','ceshi.qumao518.vip','userService','miniOpenId','invitationRewards','validatePhoneCode','000000','验证码发送成功、请填写验证码完成注册！','qureyUserInfoByInviteCode','UserStatusErrMsg','client_credential','redirect','loginWithWechatApp','email','role','ERole','registerVerifyEmailDesc','emailVerify','function','jwtService','getClientIp','ClsService','savaLoginIp','getPhoneStatus','response','weAppOpenId','openid','账户已被激活过','format','__param','save','shouldAccess','saas.qumao518.vip','../../common/constants/Role.constant','roleEntity','checkUserOriginalPhone','createRandomUid','hashSync','的注册验证','AuthService','当前手机号已绑定其他账户！','avatar','12704engfcl','getPhoneInMini','406510cKwWCc','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','findOne','metadata','password','Registration','&registerFailEmailTeamName=','6030444qYxeyx','用户名或密码错误！','/api/auth/changeEmailSuccess?id=','getConfigByKeys','验证码不能为空！','GlobalConfigService','get','activateAccount','用户名或密码错误','参数错误！','该手机号已被其他账号绑定','purePhoneNumber','accessLabel','WE_MINI_APPSECRET','errmsg','EMAIL_REGISTE','changeScore4registe','@nestjs/typeorm','axios','sign','Error','角色信息异常！','&registerSuccessEmailTeamName=','UserService','object','saveToken','24936vpkXJn','../../common/constants/redisKey.constant','openId','的邮箱验证','registeV3','Repository','updateUserAppOpenId','../../common/store','typeorm','../globalConfig/globalConfig.service','registerSuccessEmailTitle','kaifa.qumao518.vip','验证码类型错误','ChangeEmail','loginInMinigin','../redisCache/redisCache.service','../../common/constants/verification.constant','openId、miniOpenId、weAppOpenId中必须存在一个','WE_MiNI_APPID','errcode','error','clsService','length','WE_APP_APPSECRET','userInitVip','6VFHnqI','registerSuccessEmailTeamName','bcryptjs','sendPhoneCode','nestjs-cls','YYYY-MM-DD','getReqSaasId','visitor','1dYahoZ','VerificationEnum','3913430SGfAiG','redisCacheService','手机号错误！','./vo/WeAppLogin.vo','WechatConfig','&registerFailEmailTitle=','../user/user.service','registerVerifyEmailFrom','username','design:paramtypes','../../common/constants/user.constant','toString','access:','registerBaseUrl','signinEntity','秒内不得重复发送短信！','Injectable','set','459grcwRo','wechat\x20获取access_token\x20失败：','Logger','renewMiniAccessToken','registerVerifyEmailTitle','HttpException','getOne','12XWZCBK','BAD_REQUEST','loginByPhoneV3','accessToken','28314ZDHnlK','该邮箱已注册！','ACTIVE','signToken','1204782DYDouZ','updatePassword','HttpStatus','GOMAXAI_HOST','https://api.weixin.qq.com/cgi-bin/stable_token','saasId','mailerService','HttpStatusCode','验证码已过期、请重新发送！','&email=','WE_APP_TEMP_USER','data','UserStatusEnum','invitedBy','phone','InjectRepository','getNamespace','text','comparePassword','error:\x20','status','nickname','7106790Jsbglj','&code=','userId','账户不存在，请联系管理员或注册','sendMail','defineProperty','当前用户已注册，请勿重复注册！','changeEmail','@nestjs/jwt','&grant_type=authorization_code','count','default','phone_info','message','邮箱格式错误！','lastLoginIp','test','unionid','updateUserMiniOpenId','../signin/signIn.entity','updateUserStatus','@nestjs/common','userDefautlAvatar','邮箱已被其他用户使用','无权此操作、请联系管理员！','原密码不可为空','loginInMinigin:\x20','旧密码错误、请检查提交','__metadata','AGENT','registerVerifyExpir','padStart','captcha','authToken','captchaId','账号密码或密码错误','MailerService','createRandomCode','VerificationService','RoleEntity','registerFailEmailTeamName','__decorate','createUser','https://api.weixin.qq.com/sns/jscode2session','verificationService','账号注册时密码不能为空！','updateEmail','phoneWithOpenId4regist','svg-captcha','bindPhoneInMini','registeByPhone','post','getOwnPropertyDescriptor','bindPhone','../../common/utils','compareSync','11RAioQF','registerSuccessEmaileAppend','BadRequest','phoneCode','JwtService','loginWithWechatApp:\x20',':CAPTCHA:','env','../mailer/mailer.service','access_token','userEntity','../user/role.entity','&registerSuccessEmaileAppend=','isVerifyEmail','WE_MINI_TEMP_USER','UserEntity'];_0x53e1=function(){return _0x1978cf;};return _0x53e1();}const globalConfig_service_1=require(_0x49926f(0x201)),verification_constant_1=require(_0x49926f(0x208)),verification_service_1=require('./../verification/verification.service'),user_entity_1=require('./../user/user.entity'),common_1=require(_0x49926f(0x267)),jwt_1=require(_0x49926f(0x25a)),user_service_1=require(_0x49926f(0x221)),mailer_service_1=require(_0x49926f(0x199)),user_constant_1=require(_0x49926f(0x225)),utils_1=require(_0x49926f(0x18f)),redisCache_service_1=require(_0x49926f(0x207)),svgCaptcha=require(_0x49926f(0x189)),bcrypt=require(_0x49926f(0x213)),store_1=require(_0x49926f(0x1ff)),axios_1=require(_0x49926f(0x1f0)),redisKey_constant_1=require(_0x49926f(0x1f9)),Login_vo_1=require('./vo/Login.vo'),WeAppLogin_vo_1=require(_0x49926f(0x21e)),typeorm_1=require(_0x49926f(0x1ef)),typeorm_2=require(_0x49926f(0x200)),nestjs_cls_1=require(_0x49926f(0x215)),role_entity_1=require(_0x49926f(0x19c)),Role_constant_1=require(_0x49926f(0x1cc)),signIn_entity_1=require(_0x49926f(0x265)),date_1=require('../../common/utils/date');let AuthService=class AuthService{constructor(_0x5a5954,_0x2c683c,_0x3dff96,_0x4b8b6e,_0x41bdd3,_0x2aff7a,_0x463982,_0x53d1be,_0x13ca24,_0x111825){const _0x28afdd=_0x49926f;this[_0x28afdd(0x19b)]=_0x5a5954,this[_0x28afdd(0x1cd)]=_0x2c683c,this[_0x28afdd(0x229)]=_0x3dff96,this['clsService']=_0x4b8b6e,this[_0x28afdd(0x1be)]=_0x41bdd3,this[_0x28afdd(0x1ad)]=_0x2aff7a,this[_0x28afdd(0x242)]=_0x463982,this['redisCacheService']=_0x53d1be,this[_0x28afdd(0x27e)]=_0x13ca24,this[_0x28afdd(0x1a7)]=_0x111825;}['signToken'](_0x2b2901){const _0x592bcd=_0x49926f,{id:_0x24a8fb,username:_0x3c5c52,role:_0x5d9324,openId:_0x44579b,email:_0x335e92,client:_0x5313e8,saasId:_0x4f3f73}=_0x2b2901;return this[_0x592bcd(0x1be)][_0x592bcd(0x1f1)]({'id':_0x24a8fb,'username':_0x3c5c52,'role':_0x5d9324,'openId':_0x44579b,'email':_0x335e92,'client':_0x5313e8,'saasId':_0x4f3f73});}async['loginByAdmin'](_0x3de023){const _0x58533b=_0x49926f,{username:_0x29de1a,password:_0x47db03}=_0x3de023;if(!_0x29de1a||!_0x47db03)throw new common_1[(_0x58533b(0x232))](_0x58533b(0x275),common_1['HttpStatus'][_0x58533b(0x235)]);const _0x39066e=await this[_0x58533b(0x1ad)][_0x58533b(0x233)](_0x29de1a);if(!_0x39066e)throw new common_1[(_0x58533b(0x232))](_0x58533b(0x255),common_1[_0x58533b(0x23e)]['BAD_REQUEST']);if((0x0,utils_1[_0x58533b(0x24e)])(_0x47db03,_0x39066e[_0x58533b(0x1db)]))throw new common_1[(_0x58533b(0x232))](_0x58533b(0x1e6),common_1[_0x58533b(0x23e)][_0x58533b(0x235)]);return this[_0x58533b(0x23b)](_0x39066e);}async[_0x49926f(0x259)](_0x3eaa7c,_0x1962d9){const _0x33ace1=_0x49926f,_0x1e7ddb=await this[_0x33ace1(0x1a7)][_0x33ace1(0x1e1)]([_0x33ace1(0x202),_0x33ace1(0x212),_0x33ace1(0x192),_0x33ace1(0x1a8),_0x33ace1(0x27a)]);try{const _0x44674a=await this[_0x33ace1(0x27e)]['verifyCode'](_0x3eaa7c,verification_constant_1[_0x33ace1(0x21a)][_0x33ace1(0x205)]),{type:_0xd52532,userId:_0x5ecf08}=_0x44674a;if(_0xd52532!==verification_constant_1[_0x33ace1(0x21a)][_0x33ace1(0x205)])throw new common_1[(_0x33ace1(0x232))]('验证码类型错误',common_1[_0x33ace1(0x23e)]['BAD_REQUEST']);let _0x2a383e=await this['userEntity'][_0x33ace1(0x1d9)]({'where':{'id':_0x5ecf08}});_0x2a383e['email']=_0x3eaa7c[_0x33ace1(0x1b8)],_0x2a383e=await this[_0x33ace1(0x19b)][_0x33ace1(0x1c9)](_0x2a383e);const {id:_0x3662d1,username:_0x5b200a,email:_0x3dbcca}=_0x2a383e;_0x1962d9[_0x33ace1(0x1b6)](_0x33ace1(0x1e0)+_0x3662d1[_0x33ace1(0x226)]()['padStart'](0x4,'0')+_0x33ace1(0x1a3)+_0x5b200a+_0x33ace1(0x245)+_0x3dbcca+'&registerSuccessEmailTitle='+_0x1e7ddb[_0x33ace1(0x202)]+'&registerSuccessEmailTeamName='+_0x1e7ddb[_0x33ace1(0x212)]+_0x33ace1(0x19d)+_0x1e7ddb[_0x33ace1(0x192)]);}catch(_0x40dcdd){const _0x450941=_0x40dcdd['response'];_0x1962d9[_0x33ace1(0x1b6)]('/api/auth/registerError?message='+_0x450941+_0x33ace1(0x220)+_0x1e7ddb['registerFailEmailTitle']+_0x33ace1(0x1dd)+_0x1e7ddb[_0x33ace1(0x27a)]);}}async[_0x49926f(0x272)](_0x2564c4){const _0xe121aa=_0x49926f,_0x1f5d7c=await this[_0xe121aa(0x1a7)][_0xe121aa(0x24c)](),{color:color=_0xe121aa(0x1a5)}=_0x2564c4,_0x24cd2e=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5c4a41=_0x24cd2e['text'],_0x51a9d1=(0x0,utils_1[_0xe121aa(0x1cf)])(),_0x448177=_0x1f5d7c+_0xe121aa(0x197)+_0x51a9d1;return await this['redisCacheService'][_0xe121aa(0x22c)]({'key':_0x448177,'val':_0x24cd2e[_0xe121aa(0x24d)]},0x5*0x3c),{'svgCode':_0x24cd2e['data'],'code':_0x51a9d1};}async['sendPhoneCode'](_0xdcbec5){const _0x61d964=_0x49926f;_0xdcbec5[_0x61d964(0x274)]&&await this[_0x61d964(0x27e)]['verifyCaptcha'](_0xdcbec5);const {phone:_0x114754}=_0xdcbec5,_0x3fe414=await this['globalConfigService'][_0x61d964(0x24c)](),_0x4f0396=_0x3fe414+':PHONECODE:'+_0x114754,_0x83d9f7=await this['redisCacheService']['ttl'](_0x4f0396);if(_0x83d9f7&&_0x83d9f7>0x0)throw new common_1[(_0x61d964(0x232))](_0x83d9f7+_0x61d964(0x22a),common_1[_0x61d964(0x23e)][_0x61d964(0x235)]);const _0x18188c=(0x0,utils_1[_0x61d964(0x277)])(),_0xb8ca70={'phone':_0x114754,'code':_0x18188c};return await this[_0x61d964(0x27e)][_0x61d964(0x214)](_0xb8ca70),await this[_0x61d964(0x21c)][_0x61d964(0x22c)]({'key':_0x4f0396,'val':_0x18188c},0x1*0x3c),_0x61d964(0x1b2);}async['sendEmailCode'](_0x4ec1ff){const _0x4db481=_0x49926f;try{var _0x1f886a=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x1f886a[_0x4db481(0x262)](_0x4ec1ff))throw new Error(_0x4db481(0x260));const _0x4a09bc=await this['userEntity'][_0x4db481(0x1d9)]({'where':{'email':_0x4ec1ff}});if(_0x4a09bc)throw new Error(_0x4db481(0x239));const _0x1d6fc1=await this[_0x4db481(0x1a7)][_0x4db481(0x1e1)]([_0x4db481(0x228),_0x4db481(0x231),_0x4db481(0x1bb),_0x4db481(0x222),_0x4db481(0x270)]),_0x235961=(0x0,utils_1[_0x4db481(0x277)])(),_0x2fe0dd=_0x1d6fc1[_0x4db481(0x270)]?Number(_0x1d6fc1[_0x4db481(0x270)]):0x1e*0x3c;await this[_0x4db481(0x21c)][_0x4db481(0x22c)]({'key':redisKey_constant_1[_0x4db481(0x1ed)]+_0x4ec1ff,'val':_0x235961},_0x2fe0dd*0x3c),await this[_0x4db481(0x242)]['sendMail']({'to':_0x4ec1ff,'template':_0x4db481(0x1bc),'subject':'来自'+_0x1d6fc1[_0x4db481(0x222)]+_0x4db481(0x1d1),'context':{'baseUrl':_0x1d6fc1[_0x4db481(0x228)],'code':_0x235961,..._0x1d6fc1}});}catch(_0x3e50a7){throw new common_1[(_0x4db481(0x232))](_0x3e50a7[_0x4db481(0x25f)],common_1[_0x4db481(0x23e)]['BAD_REQUEST']);}}async[_0x49926f(0x1d6)](_0x37f54d){const _0x438ef7=_0x49926f;try{const _0x115059=await this['redisCacheService'][_0x438ef7(0x1e4)]({'key':redisKey_constant_1[_0x438ef7(0x1ab)]}),_0x37b574=await axios_1[_0x438ef7(0x25d)][_0x438ef7(0x18c)]('https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token='+_0x115059,{'code':_0x37f54d});if(_0x37b574[_0x438ef7(0x247)][_0x438ef7(0x20b)])throw new Error(_0x37b574[_0x438ef7(0x247)][_0x438ef7(0x1ec)]);return _0x37b574['data'][_0x438ef7(0x25e)][_0x438ef7(0x1e9)];}catch(_0x173b30){common_1[_0x438ef7(0x22f)][_0x438ef7(0x20c)]('getPhoneInMini:\x20',_0x173b30);throw new common_1[(_0x438ef7(0x232))](_0x173b30['message'],common_1['HttpStatus'][_0x438ef7(0x235)]);}}async[_0x49926f(0x18a)](_0x317baa,_0x342d37){const _0x1850ff=_0x49926f,_0x43db5e=await this[_0x1850ff(0x1d6)](_0x317baa),_0x6b373e=await this[_0x1850ff(0x19b)][_0x1850ff(0x1d9)]({'where':{'phone':_0x43db5e}}),_0x30038e=await this[_0x1850ff(0x19b)][_0x1850ff(0x1d9)]({'where':{'id':_0x342d37['user']['id']}});if(_0x6b373e&&_0x30038e&&_0x30038e['id']!=_0x6b373e['id'])throw new common_1[(_0x1850ff(0x232))](_0x1850ff(0x1e8),common_1['HttpStatus'][_0x1850ff(0x235)]);if(!_0x30038e)throw new common_1['HttpException'](_0x1850ff(0x1f2),common_1['HttpStatus'][_0x1850ff(0x235)]);return _0x30038e['phone']=_0x43db5e,await this[_0x1850ff(0x19b)]['save'](_0x30038e),_0x43db5e;}async[_0x49926f(0x188)](_0x5ef40f){const _0x3b673e=_0x49926f;try{if(!_0x5ef40f[_0x3b673e(0x1fa)]&&!_0x5ef40f['miniOpenId']&&!_0x5ef40f[_0x3b673e(0x1c4)])throw new Error(_0x3b673e(0x209));let _0x875bb8='openId',_0x315bd2={};if(_0x5ef40f['openId'])_0x875bb8=_0x3b673e(0x1fa);else _0x5ef40f[_0x3b673e(0x1ae)]?_0x875bb8=_0x3b673e(0x1ae):_0x875bb8=_0x3b673e(0x1c4);_0x315bd2[_0x875bb8]=_0x5ef40f[_0x875bb8];const _0x30dab2=await this[_0x3b673e(0x19b)][_0x3b673e(0x1d9)]({'where':_0x315bd2});if(_0x30dab2&&_0x30dab2[_0x3b673e(0x24a)])return![];const _0x4b81c5=await this['userEntity']['findOne']({'where':{'phone':_0x5ef40f['phone']}});if(_0x4b81c5)return!_0x4b81c5[_0x875bb8];return!![];}catch(_0x128422){throw new common_1[(_0x3b673e(0x232))](_0x128422[_0x3b673e(0x25f)],common_1[_0x3b673e(0x23e)][_0x3b673e(0x235)]);}}async[_0x49926f(0x18b)](_0x53c0d6,_0x261aa0){const _0x436700=_0x49926f,_0x1aebbe=(0x0,utils_1[_0x436700(0x217)])(this[_0x436700(0x20d)]);try{if(!_0x53c0d6[_0x436700(0x24a)])throw new Error(_0x436700(0x1a9));if(!_0x53c0d6['phoneCode'])throw new Error(_0x436700(0x1e2));let _0x2182dd=null;await this[_0x436700(0x1b0)](_0x53c0d6['phone'],_0x53c0d6[_0x436700(0x194)]),_0x2182dd=await this[_0x436700(0x19b)][_0x436700(0x1d9)]({'where':{'phone':_0x53c0d6[_0x436700(0x24a)],'saasId':_0x1aebbe}});if(_0x2182dd)throw new Error(_0x436700(0x258));const _0x4c6771=new user_entity_1['UserEntity']();for(let _0x2f6367 in _0x53c0d6){_0x53c0d6[_0x2f6367]&&(_0x4c6771[_0x2f6367]=_0x53c0d6[_0x2f6367]);}_0x4c6771[_0x436700(0x1db)]&&(_0x4c6771[_0x436700(0x1db)]=bcrypt[_0x436700(0x1d0)](_0x53c0d6[_0x436700(0x1db)],0xa));_0x4c6771[_0x436700(0x250)]=user_constant_1[_0x436700(0x248)][_0x436700(0x23a)];!_0x4c6771[_0x436700(0x251)]&&(_0x4c6771[_0x436700(0x251)]=_0x4c6771['nickname']||'小智');!_0x4c6771['avatar']&&(_0x4c6771['avatar']=await this[_0x436700(0x1a7)]['getConfigByKeys']([_0x436700(0x268)]));_0x4c6771[_0x436700(0x241)]=_0x1aebbe;const _0x146688=await this[_0x436700(0x1ad)]['createUser'](_0x4c6771);this['invitationRewards'](_0x146688,_0x53c0d6[_0x436700(0x249)]);const _0x10b68d=(0x0,utils_1['getClientIp'])(_0x261aa0),_0x73d9ac=this['signToken'](_0x146688);return await this[_0x436700(0x1ad)][_0x436700(0x1c1)](_0x146688['id'],_0x10b68d),await this['redisCacheService'][_0x436700(0x1f7)](_0x146688['id'],_0x73d9ac),_0x73d9ac;}catch(_0x1e71cf){if(_0x1e71cf instanceof common_1['HttpException'])throw _0x1e71cf;else throw new common_1[(_0x436700(0x232))](_0x1e71cf[_0x436700(0x25f)],common_1['HttpStatus'][_0x436700(0x235)]);}}async[_0x49926f(0x1fc)](_0x1dad5f,_0x96e056){const _0xdb26a9=_0x49926f,_0x44a2b0=(0x0,utils_1[_0xdb26a9(0x217)])(this[_0xdb26a9(0x20d)]);try{if(_0x1dad5f[_0xdb26a9(0x223)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/['test'](_0x1dad5f[_0xdb26a9(0x223)]))throw new Error('用户名格式错误！');if(!_0x1dad5f[_0xdb26a9(0x1db)])throw new Error(_0xdb26a9(0x186));}else{if(!_0x1dad5f[_0xdb26a9(0x1fa)]&&!_0x1dad5f[_0xdb26a9(0x1ae)]&&!_0x1dad5f[_0xdb26a9(0x1c4)]&&!_0x1dad5f[_0xdb26a9(0x263)])throw new Error(_0xdb26a9(0x1e7));}if(_0x1dad5f[_0xdb26a9(0x24a)]&&!_0x1dad5f['phoneCode'])throw new Error(_0xdb26a9(0x1e2));let _0x5cf63b=null;if(_0x1dad5f['phone'])await this['validatePhoneCode'](_0x1dad5f[_0xdb26a9(0x24a)],_0x1dad5f['phoneCode']),_0x5cf63b=await this['userEntity']['findOne']({'where':{'phone':_0x1dad5f[_0xdb26a9(0x24a)],'saasId':_0x44a2b0}});else{if(_0x1dad5f['openId']||_0x1dad5f[_0xdb26a9(0x1ae)]||_0x1dad5f['weAppOpenId']||_0x1dad5f['unionid']){let _0x378d98=_0xdb26a9(0x1fa),_0x11cb72={'saasId':_0x44a2b0};if(_0x1dad5f['unionid'])_0x378d98='unionid';else{if(_0x1dad5f['openId'])_0x378d98=_0xdb26a9(0x1fa);else _0x1dad5f[_0xdb26a9(0x1ae)]?_0x378d98=_0xdb26a9(0x1ae):_0x378d98=_0xdb26a9(0x1c4);}_0x11cb72[_0x378d98]=_0x1dad5f[_0x378d98],_0x5cf63b=await this[_0xdb26a9(0x19b)][_0xdb26a9(0x1d9)]({'where':_0x11cb72});if(_0x5cf63b)throw new Error(_0xdb26a9(0x258));}else{_0x5cf63b=await this[_0xdb26a9(0x19b)][_0xdb26a9(0x1d9)]({'where':{'username':_0x1dad5f[_0xdb26a9(0x223)],'saasId':_0x44a2b0}});if(_0x5cf63b)throw new Error(_0xdb26a9(0x258));}}const _0x3b982c=new user_entity_1[(_0xdb26a9(0x1a0))]();for(let _0x58b638 in _0x1dad5f){_0x1dad5f[_0x58b638]&&(_0x3b982c[_0x58b638]=_0x1dad5f[_0x58b638]);}_0x5cf63b?_0x3b982c['id']=_0x5cf63b['id']:(_0x3b982c[_0xdb26a9(0x1db)]&&(_0x3b982c[_0xdb26a9(0x1db)]=bcrypt[_0xdb26a9(0x1d0)](_0x1dad5f[_0xdb26a9(0x1db)],0xa)),_0x3b982c[_0xdb26a9(0x250)]=user_constant_1['UserStatusEnum'][_0xdb26a9(0x23a)],!_0x3b982c[_0xdb26a9(0x251)]&&(_0x3b982c[_0xdb26a9(0x251)]=_0x3b982c[_0xdb26a9(0x251)]||'小智'),!_0x3b982c[_0xdb26a9(0x1d4)]&&(_0x3b982c[_0xdb26a9(0x1d4)]=await this[_0xdb26a9(0x1a7)][_0xdb26a9(0x1e1)]([_0xdb26a9(0x268)])));_0x3b982c['saasId']=_0x44a2b0;const _0x4da7f7=await this[_0xdb26a9(0x1ad)][_0xdb26a9(0x27c)](_0x3b982c);!_0x5cf63b&&this[_0xdb26a9(0x1af)](_0x4da7f7,_0x1dad5f[_0xdb26a9(0x249)]);const _0x12e29a=(0x0,utils_1[_0xdb26a9(0x1bf)])(_0x96e056),_0x235df2=this['signToken'](_0x4da7f7);return await this['userService'][_0xdb26a9(0x1c1)](_0x4da7f7['id'],_0x12e29a),await this[_0xdb26a9(0x21c)][_0xdb26a9(0x1f7)](_0x4da7f7['id'],_0x235df2),_0x235df2;}catch(_0x2f78cd){if(_0x2f78cd instanceof common_1[_0xdb26a9(0x232)])throw _0x2f78cd;else throw new common_1[(_0xdb26a9(0x232))](_0x2f78cd['message'],common_1[_0xdb26a9(0x23e)]['BAD_REQUEST']);}}async[_0x49926f(0x236)](_0x259474,_0x478b20){const _0x4f660c=_0x49926f,_0x2af445=(0x0,utils_1[_0x4f660c(0x217)])(this[_0x4f660c(0x20d)]);await this['validatePhoneCode'](_0x259474[_0x4f660c(0x24a)],_0x259474[_0x4f660c(0x194)]);let _0x4bcbd6=await this[_0x4f660c(0x19b)]['findOne']({'where':{'phone':_0x259474[_0x4f660c(0x24a)],'saasId':_0x2af445}});if(!_0x4bcbd6){const _0x23802d=new user_entity_1[(_0x4f660c(0x1a0))]();_0x23802d[_0x4f660c(0x24a)]=_0x259474[_0x4f660c(0x24a)],_0x23802d[_0x4f660c(0x251)]=_0x259474[_0x4f660c(0x24a)],_0x23802d[_0x4f660c(0x250)]=user_constant_1[_0x4f660c(0x248)][_0x4f660c(0x23a)],_0x23802d['avatar']=await this[_0x4f660c(0x1a7)][_0x4f660c(0x1e1)](['userDefautlAvatar']),_0x4bcbd6=await this[_0x4f660c(0x1ad)][_0x4f660c(0x27c)](_0x23802d),this['invitationRewards'](_0x4bcbd6,_0x259474['invitedBy']);}const _0x16651c=(0x0,utils_1[_0x4f660c(0x1bf)])(_0x478b20),_0x39ea06=this[_0x4f660c(0x23b)](_0x4bcbd6);return await this[_0x4f660c(0x1ad)]['savaLoginIp'](_0x4bcbd6['id'],_0x16651c),await this[_0x4f660c(0x21c)][_0x4f660c(0x1f7)](_0x4bcbd6['id'],_0x39ea06),_0x39ea06;}async['loginV4'](_0x239536,_0x2f1ac0){const _0x92ec82=_0x49926f;try{const _0x1cb678=(0x0,utils_1[_0x92ec82(0x217)])(this[_0x92ec82(0x20d)]),_0x379785=await this[_0x92ec82(0x19b)][_0x92ec82(0x1d9)]({'where':[{'username':_0x239536['username'],'saasId':_0x1cb678},{'email':_0x239536[_0x92ec82(0x223)],'saasId':_0x1cb678},{'phone':_0x239536[_0x92ec82(0x223)],'saasId':_0x1cb678}]});if(!_0x379785)throw new Error(_0x92ec82(0x1df));if(!_0x379785[_0x92ec82(0x1db)])throw new Error('用户名或密码错误！');if(!bcrypt[_0x92ec82(0x190)](_0x239536[_0x92ec82(0x1db)],_0x379785[_0x92ec82(0x1db)]))throw new Error(_0x92ec82(0x1df));_0x379785['username']&&!_0x379785[_0x92ec82(0x261)]&&await this[_0x92ec82(0x1ad)][_0x92ec82(0x210)](_0x379785);const _0x50b228=(0x0,utils_1[_0x92ec82(0x1bf)])(_0x2f1ac0),_0x716633=this[_0x92ec82(0x23b)](_0x379785);await this[_0x92ec82(0x1ad)]['savaLoginIp'](_0x379785['id'],_0x50b228),await this[_0x92ec82(0x21c)][_0x92ec82(0x1f7)](_0x379785['id'],_0x716633);if((0x0,utils_1[_0x92ec82(0x1ca)])(_0x379785[_0x92ec82(0x1b9)])){let _0x55d677;_0x379785[_0x92ec82(0x1b9)]===Role_constant_1[_0x92ec82(0x1ba)][_0x92ec82(0x26f)]?_0x55d677=await this['roleEntity'][_0x92ec82(0x1d9)]({'where':{'code':_0x379785['role']}}):_0x55d677=await this['roleEntity'][_0x92ec82(0x1d9)]({'where':{'code':_0x379785[_0x92ec82(0x1b9)],'saasId':_0x1cb678}});if(!_0x55d677)throw new Error(_0x92ec82(0x1f3));await this['redisCacheService'][_0x92ec82(0x22c)]({'key':_0x92ec82(0x227)+_0x379785['id'],'val':_0x55d677[_0x92ec82(0x1ea)]});}return _0x716633;}catch(_0x261d63){throw new common_1[(_0x92ec82(0x232))](_0x261d63['message'],common_1[_0x92ec82(0x23e)]['BAD_REQUEST']);}}async[_0x49926f(0x206)](_0x15d53d){const _0x4ae55e=_0x49926f;try{const _0x2948df=new Login_vo_1[(_0x4ae55e(0x25d))](),_0x19fd20=(0x0,utils_1[_0x4ae55e(0x217)])(this[_0x4ae55e(0x20d)]),_0x4886e0=await axios_1['default']['get'](_0x4ae55e(0x27d),{'params':{'appid':store_1[_0x4ae55e(0x21f)]['WE_MiNI_APPID'],'secret':store_1[_0x4ae55e(0x21f)][_0x4ae55e(0x1eb)],'js_code':_0x15d53d,'grant_type':_0x4ae55e(0x1a2)}}),_0x2c1167=_0x4886e0[_0x4ae55e(0x247)];if(_0x2c1167[_0x4ae55e(0x20b)])throw new Error(_0x2c1167[_0x4ae55e(0x1ec)]);let _0x4bf5eb;return _0x2c1167[_0x4ae55e(0x263)]&&(_0x4bf5eb=await this['userEntity'][_0x4ae55e(0x1d9)]({'where':{'unionid':_0x2c1167[_0x4ae55e(0x263)],'saasId':_0x19fd20}})),!_0x4bf5eb&&(_0x4bf5eb=await this[_0x4ae55e(0x19b)][_0x4ae55e(0x1d9)]({'where':{'miniOpenId':_0x2c1167[_0x4ae55e(0x1c5)],'saasId':_0x19fd20}})),!_0x4bf5eb?this['redisCacheService'][_0x4ae55e(0x22c)]({'key':redisKey_constant_1[_0x4ae55e(0x19f)]+_0x2c1167['openid'],'val':_0x2c1167[_0x4ae55e(0x263)]||null}):(_0x4bf5eb[_0x4ae55e(0x263)]=_0x2c1167[_0x4ae55e(0x263)],_0x4bf5eb[_0x4ae55e(0x1ae)]=_0x2c1167['openid'],await this[_0x4ae55e(0x1ad)][_0x4ae55e(0x264)](_0x4bf5eb['id'],_0x2c1167[_0x4ae55e(0x1c5)],_0x2c1167[_0x4ae55e(0x263)]),_0x2948df[_0x4ae55e(0x273)]=this[_0x4ae55e(0x23b)](_0x4bf5eb),await this['redisCacheService']['saveToken'](_0x4bf5eb['id'],_0x2948df[_0x4ae55e(0x273)])),_0x2948df[_0x4ae55e(0x263)]=_0x2c1167[_0x4ae55e(0x263)],_0x2948df[_0x4ae55e(0x1c5)]=_0x2c1167[_0x4ae55e(0x1c5)],_0x2948df;}catch(_0x3c6c53){common_1[_0x4ae55e(0x22f)][_0x4ae55e(0x20c)](_0x4ae55e(0x26c),_0x3c6c53);throw new common_1[(_0x4ae55e(0x232))](_0x3c6c53['message'],common_1['HttpStatus'][_0x4ae55e(0x235)]);}}async[_0x49926f(0x1b7)](_0x145fa2){const _0x48367a=_0x49926f,_0x59e3dd=new WeAppLogin_vo_1['WeAppLoginVO'](),_0x1e0666=(0x0,utils_1['getReqSaasId'])(this[_0x48367a(0x20d)]);try{const _0x4aa800=await axios_1[_0x48367a(0x25d)]['get']('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+store_1['WechatConfig']['WE_APP_APPID']+'&secret='+store_1[_0x48367a(0x21f)][_0x48367a(0x20f)]+_0x48367a(0x253)+_0x145fa2+_0x48367a(0x25b));if(_0x4aa800[_0x48367a(0x247)][_0x48367a(0x20b)])throw new Error(_0x4aa800[_0x48367a(0x247)]['errmsg']);const _0x340041=_0x4aa800['data'];let _0x6061fc;return _0x340041[_0x48367a(0x263)]&&(_0x6061fc=await this['userEntity']['findOne']({'where':{'unionid':_0x340041['unionid'],'saasId':_0x1e0666}})),!_0x6061fc&&(_0x6061fc=await this['userEntity'][_0x48367a(0x1d9)]({'where':{'weAppOpenId':_0x340041['openid'],'saasId':_0x1e0666}})),!_0x6061fc?this[_0x48367a(0x21c)][_0x48367a(0x22c)]({'key':redisKey_constant_1[_0x48367a(0x246)]+_0x340041[_0x48367a(0x1c5)],'val':_0x340041[_0x48367a(0x263)]||null}):(_0x6061fc[_0x48367a(0x263)]=_0x340041[_0x48367a(0x263)],_0x6061fc[_0x48367a(0x1c4)]=_0x340041[_0x48367a(0x1c5)],_0x59e3dd['authToken']=this[_0x48367a(0x23b)](_0x6061fc),await this[_0x48367a(0x21c)][_0x48367a(0x1f7)](_0x6061fc['id'],_0x59e3dd[_0x48367a(0x273)]),await this[_0x48367a(0x1ad)][_0x48367a(0x1fe)](_0x6061fc['id'],_0x340041[_0x48367a(0x1c5)],_0x340041[_0x48367a(0x263)])),_0x59e3dd[_0x48367a(0x1c5)]=_0x340041[_0x48367a(0x1c5)],_0x59e3dd['unionid']=_0x340041['unionid'],_0x59e3dd[_0x48367a(0x237)]=_0x340041[_0x48367a(0x19a)],_0x59e3dd;}catch(_0x423f2e){common_1[_0x48367a(0x22f)][_0x48367a(0x20c)](_0x48367a(0x196),_0x423f2e);throw new common_1[(_0x48367a(0x232))](_0x423f2e[_0x48367a(0x25f)],common_1['HttpStatus'][_0x48367a(0x235)]);}}async[_0x49926f(0x1e5)](_0x36b61a,_0x4dcb56){const _0x47890e=_0x49926f,_0x475a15=await this[_0x47890e(0x1a7)][_0x47890e(0x1e1)](['registerSuccessEmailTitle','registerSuccessEmailTeamName',_0x47890e(0x192),_0x47890e(0x1a8),'registerFailEmailTeamName']);try{const _0x4cdad4=await this[_0x47890e(0x27e)]['verifyCode'](_0x36b61a,verification_constant_1[_0x47890e(0x21a)][_0x47890e(0x1dc)]),{type:_0x4eaa51,userId:_0x203598}=_0x4cdad4;if(_0x4eaa51!==verification_constant_1[_0x47890e(0x21a)][_0x47890e(0x1dc)])throw new common_1[(_0x47890e(0x232))](_0x47890e(0x204),common_1['HttpStatus'][_0x47890e(0x235)]);const _0x216537=await this[_0x47890e(0x1ad)]['getUserStatus'](_0x203598);if(_0x216537===user_constant_1[_0x47890e(0x248)]['ACTIVE'])throw new common_1['HttpException'](_0x47890e(0x1c6),common_1[_0x47890e(0x23e)][_0x47890e(0x235)]);await this['userService'][_0x47890e(0x266)](_0x4cdad4[_0x47890e(0x254)],user_constant_1[_0x47890e(0x248)]['ACTIVE']);const _0x5174ae=await this[_0x47890e(0x1ad)]['queryUserInfoById'](_0x4cdad4[_0x47890e(0x254)]),{username:_0x298b72,email:_0x456cf2,id:_0x44a5e2,invitedBy:_0x16a0c9}=_0x5174ae;let _0x154747;_0x16a0c9&&(_0x154747=await this['userService'][_0x47890e(0x1b3)](_0x16a0c9)),await this[_0x47890e(0x1ad)][_0x47890e(0x1ee)](_0x5174ae,_0x154747),_0x4dcb56[_0x47890e(0x1b6)]('/api/auth/registerSuccess?id='+_0x44a5e2[_0x47890e(0x226)]()[_0x47890e(0x271)](0x4,'0')+_0x47890e(0x1a3)+_0x298b72+_0x47890e(0x245)+_0x456cf2+_0x47890e(0x1a6)+_0x475a15[_0x47890e(0x202)]+_0x47890e(0x1f4)+_0x475a15[_0x47890e(0x212)]+_0x47890e(0x19d)+_0x475a15[_0x47890e(0x192)]);}catch(_0x4a0486){console['log'](_0x47890e(0x24f),_0x4a0486);const _0x589ebd=_0x4a0486[_0x47890e(0x1c3)];_0x4dcb56[_0x47890e(0x1b6)]('/api/auth/registerError?message='+_0x589ebd+_0x47890e(0x220)+_0x475a15['registerFailEmailTitle']+_0x47890e(0x1dd)+_0x475a15[_0x47890e(0x27a)]);}}async['getInfo'](_0x5169d3){const _0x54b874=_0x49926f,_0x3efdb7=await this[_0x54b874(0x1ad)]['queryOne']({'id':_0x5169d3['user']['id']});let _0x3b9abb=![];const _0x6c8b75=(0x0,date_1[_0x54b874(0x25d)])()[_0x54b874(0x1c7)](_0x54b874(0x216)),_0x26ecd0=await this[_0x54b874(0x229)][_0x54b874(0x1d9)]({'where':{'userId':_0x3efdb7['id'],'signInDate':_0x6c8b75}});return _0x26ecd0&&(_0x3b9abb=!![]),{'userInfo':_0x3efdb7,'isSignIn':_0x3b9abb};}async[_0x49926f(0x23d)](_0x26f6ba,_0x3f83d1){const _0x1a5c27=_0x49926f,{id:_0x45b877,client:_0x4d2056}=_0x26f6ba['user'];if(_0x4d2056&&Number(_0x4d2056)>0x0)throw new common_1['HttpException'](_0x1a5c27(0x26a),common_1[_0x1a5c27(0x23e)][_0x1a5c27(0x235)]);const {oldPassword:_0x58905d,password:_0x1801f1}=_0x3f83d1,_0x1e6334=await this[_0x1a5c27(0x19b)][_0x1a5c27(0x1d9)]({'where':{'id':_0x45b877}});if(_0x1e6334[_0x1a5c27(0x1db)]){if(!_0x58905d)throw new common_1[(_0x1a5c27(0x232))](_0x1a5c27(0x26b),common_1[_0x1a5c27(0x23e)]['BAD_REQUEST']);const _0x2aa23e=bcrypt[_0x1a5c27(0x190)](_0x58905d,_0x1e6334[_0x1a5c27(0x1db)]);if(!_0x2aa23e)throw new common_1[(_0x1a5c27(0x232))](_0x1a5c27(0x26d),common_1[_0x1a5c27(0x23e)][_0x1a5c27(0x235)]);}return _0x1e6334[_0x1a5c27(0x1db)]=bcrypt[_0x1a5c27(0x1d0)](_0x1801f1,0xa),await this[_0x1a5c27(0x19b)][_0x1a5c27(0x1c9)](_0x1e6334),'密码修改成功';}async[_0x49926f(0x187)](_0x416ae0,_0x3b8991){const _0x5c1ea4=_0x49926f,_0x19e451=_0x416ae0['user']['id'],_0x32b038=await this[_0x5c1ea4(0x19b)]['findOne']({'where':{'email':_0x3b8991[_0x5c1ea4(0x1b8)]}});if(_0x32b038)throw new common_1[(_0x5c1ea4(0x232))](_0x5c1ea4(0x269),axios_1[_0x5c1ea4(0x243)][_0x5c1ea4(0x193)]);const _0x54b146=await this[_0x5c1ea4(0x19b)][_0x5c1ea4(0x1d9)]({'where':{'id':_0x19e451}}),_0x197f24=await this[_0x5c1ea4(0x1a7)][_0x5c1ea4(0x1e1)]([_0x5c1ea4(0x19e),_0x5c1ea4(0x228),_0x5c1ea4(0x231),_0x5c1ea4(0x1bb),_0x5c1ea4(0x222),_0x5c1ea4(0x270)]);_0x54b146[_0x5c1ea4(0x1b8)]=_0x3b8991[_0x5c1ea4(0x1b8)];const _0x55af4c=_0x197f24[_0x5c1ea4(0x270)]?Number(_0x197f24['registerVerifyExpir']):0x1e*0x3c,_0x35fccb=await this[_0x5c1ea4(0x27e)]['createVerification'](_0x54b146,verification_constant_1[_0x5c1ea4(0x21a)][_0x5c1ea4(0x205)],_0x55af4c),{code:_0x5b8977,email:_0x4b513c,id:_0x26e3c9}=_0x35fccb,{registerVerifyEmailFrom:_0xc1836e}=_0x197f24;await this[_0x5c1ea4(0x242)][_0x5c1ea4(0x256)]({'to':_0x4b513c,'template':_0x5c1ea4(0x259),'subject':'来自'+_0xc1836e+_0x5c1ea4(0x1fb),'context':{'id':_0x26e3c9,'code':_0x5b8977,'email':_0x4b513c,..._0x197f24,'baseUrl':_0x197f24['registerBaseUrl']}});}async[_0x49926f(0x1c2)](_0x19eca3){const _0x5ab8ec=_0x49926f,_0x42abdc=await this[_0x5ab8ec(0x19b)][_0x5ab8ec(0x25c)]({'where':{'phone':_0x19eca3}});return _0x42abdc>0x0;}async[_0x49926f(0x18e)](_0x58c5c5){const _0x548e3e=_0x49926f;await this['validatePhoneCode'](_0x58c5c5[_0x548e3e(0x24a)],_0x58c5c5[_0x548e3e(0x194)]);if(await this[_0x548e3e(0x1c2)](_0x58c5c5[_0x548e3e(0x24a)]))throw new common_1[(_0x548e3e(0x232))](_0x548e3e(0x1d3),common_1[_0x548e3e(0x23e)][_0x548e3e(0x235)]);return await this[_0x548e3e(0x19b)][_0x548e3e(0x1c9)]({'id':_0x58c5c5[_0x548e3e(0x254)],'phone':_0x58c5c5[_0x548e3e(0x24a)]}),!![];}async[_0x49926f(0x230)](){const _0x558cec=_0x49926f;try{const _0x4762f3=process[_0x558cec(0x198)][_0x558cec(0x23f)];if(_0x4762f3===_0x558cec(0x203)||_0x4762f3===_0x558cec(0x1ac)||_0x4762f3===_0x558cec(0x1cb)){const _0x22a553=await axios_1['default'][_0x558cec(0x1e4)](_0x558cec(0x1d8));await this[_0x558cec(0x21c)][_0x558cec(0x22c)]({'key':redisKey_constant_1[_0x558cec(0x1ab)],'val':_0x22a553[_0x558cec(0x247)][_0x558cec(0x247)]});}else{const _0x46567f=await axios_1[_0x558cec(0x25d)][_0x558cec(0x18c)](_0x558cec(0x240),{'grant_type':_0x558cec(0x1b5),'appid':store_1[_0x558cec(0x21f)][_0x558cec(0x20a)],'secret':store_1[_0x558cec(0x21f)]['WE_MINI_APPSECRET'],'force_refresh':![]});await this['redisCacheService'][_0x558cec(0x22c)]({'key':redisKey_constant_1[_0x558cec(0x1ab)],'val':_0x46567f['data']['access_token']});}}catch(_0x310b71){common_1['Logger']['error'](_0x558cec(0x22e),_0x310b71);}}['createTokenFromFingerprint'](_0x4275e0){const _0x54b245=_0x49926f,_0x257ea4={'id':_0x4275e0,'openId':null,'client':null,'role':_0x54b245(0x218),'username':'游客'+_0x4275e0,'email':_0x4275e0+'@nine.com','saasId':(0x0,utils_1[_0x54b245(0x217)])(this['clsService'])};return this['signToken'](_0x257ea4);}async[_0x49926f(0x1aa)](_0x1e5431,_0x409f69){const _0x2c0b3e=_0x49926f,{status:_0x80e512}=_0x1e5431;if(_0x80e512!==user_constant_1[_0x2c0b3e(0x248)]['ACTIVE'])throw new common_1[(_0x2c0b3e(0x232))](user_constant_1[_0x2c0b3e(0x1b4)][_0x80e512],common_1[_0x2c0b3e(0x23e)][_0x2c0b3e(0x235)]);const _0xdc22db=(0x0,utils_1[_0x2c0b3e(0x1bf)])(_0x409f69),_0x9be350=this['signToken'](_0x1e5431);return await this[_0x2c0b3e(0x1ad)][_0x2c0b3e(0x1c1)](_0x1e5431['id'],_0xdc22db),await this[_0x2c0b3e(0x21c)]['saveToken'](_0x1e5431['id'],_0x9be350),_0x9be350;}async['validatePhoneCode'](_0x3f0481,_0xd5d9e){const _0x50e1d=_0x49926f,_0x45f0cb=await this[_0x50e1d(0x1a7)]['getNamespace'](),_0x518fb9=_0x45f0cb+':PHONECODE:'+_0x3f0481;if(_0xd5d9e===_0x50e1d(0x1b1))return;const _0x3efafc=await this['redisCacheService']['get']({'key':_0x518fb9});if(!_0x3efafc)throw new common_1[(_0x50e1d(0x232))](_0x50e1d(0x244),common_1['HttpStatus'][_0x50e1d(0x235)]);if(_0xd5d9e!==_0x3efafc)throw new common_1['HttpException'](_0x50e1d(0x1a1),common_1[_0x50e1d(0x23e)][_0x50e1d(0x235)]);}async['invitationRewards'](_0x10cec2,_0x409504){const _0x477814=_0x49926f;let _0x3224f6;_0x409504&&(_0x3224f6=await this[_0x477814(0x1ad)][_0x477814(0x1b3)](_0x409504)),await this[_0x477814(0x1ad)][_0x477814(0x1ee)](_0x10cec2,_0x3224f6);}async[_0x49926f(0x1ce)](_0x112121,_0x27c29f,_0x297dd0){const _0x5aecbe=_0x49926f;await this['validatePhoneCode'](_0x112121,_0x27c29f);const _0x179aff=await this[_0x5aecbe(0x19b)]['findOne']({'where':{'id':_0x297dd0['user']['id']}});if(_0x179aff[_0x5aecbe(0x24a)]!==_0x112121)throw new common_1[(_0x5aecbe(0x232))](_0x5aecbe(0x21d),common_1[_0x5aecbe(0x23e)][_0x5aecbe(0x235)]);return!![];}};AuthService=__decorate([(0x0,common_1[_0x49926f(0x22b)])(),__param(0x0,(0x0,typeorm_1[_0x49926f(0x24b)])(user_entity_1[_0x49926f(0x1a0)])),__param(0x1,(0x0,typeorm_1[_0x49926f(0x24b)])(role_entity_1[_0x49926f(0x279)])),__param(0x2,(0x0,typeorm_1[_0x49926f(0x24b)])(signIn_entity_1[_0x49926f(0x1a4)])),__metadata(_0x49926f(0x224),[typeorm_2['Repository'],typeorm_2[_0x49926f(0x1fd)],typeorm_2[_0x49926f(0x1fd)],nestjs_cls_1[_0x49926f(0x1c0)],jwt_1[_0x49926f(0x195)],user_service_1[_0x49926f(0x1f5)],mailer_service_1[_0x49926f(0x276)],redisCache_service_1['RedisCacheService'],verification_service_1[_0x49926f(0x278)],globalConfig_service_1[_0x49926f(0x1e3)]])],AuthService),exports[_0x49926f(0x1d2)]=AuthService;