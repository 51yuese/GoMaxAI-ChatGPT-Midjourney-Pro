'use strict';const _0x546755=_0x53e0;(function(_0x44c8bc,_0x3074c4){const _0x54e61d=_0x53e0,_0xb83a2b=_0x44c8bc();while(!![]){try{const _0x117a6a=parseInt(_0x54e61d(0x98))/0x1*(parseInt(_0x54e61d(0x107))/0x2)+parseInt(_0x54e61d(0x97))/0x3+parseInt(_0x54e61d(0xa9))/0x4+parseInt(_0x54e61d(0x9a))/0x5*(-parseInt(_0x54e61d(0xed))/0x6)+-parseInt(_0x54e61d(0x11d))/0x7*(-parseInt(_0x54e61d(0x9f))/0x8)+parseInt(_0x54e61d(0xec))/0x9*(-parseInt(_0x54e61d(0xb6))/0xa)+parseInt(_0x54e61d(0xd9))/0xb*(parseInt(_0x54e61d(0xcb))/0xc);if(_0x117a6a===_0x3074c4)break;else _0xb83a2b['push'](_0xb83a2b['shift']());}catch(_0x3e46b2){_0xb83a2b['push'](_0xb83a2b['shift']());}}}(_0x532f,0xd0bc1));function _0x53e0(_0x21a434,_0x2ba290){const _0x532f24=_0x532f();return _0x53e0=function(_0x53e0c6,_0x1d0b7f){_0x53e0c6=_0x53e0c6-0x97;let _0x2228d8=_0x532f24[_0x53e0c6];return _0x2228d8;},_0x53e0(_0x21a434,_0x2ba290);}function _0x532f(){const _0x221408=['length','metadata','signature','../user/user.service','63OFMmUE','6TwEqyd','resultList','findAndCount','batchMakeInfo','config','LinkFox文件上传失败','findOne','getHeaders','design:paramtypes','nestjs-cls','createClient','createdAt','list','taskEntity','./gallery.entity','validateBalanceLinxFox','__decorate','code','findBy','./task.entity','resultBody','style','DESC','/linkfox-ai/image/v1/make/create/3','style\x20like\x20\x27%','axios','8036zzJjfG','getRequestType','】当前进度','append','keys','select\x20*\x20from\x20lx_task_tb\x20where\x20status\x20in\x20(1,2)','log','createTime','cmConfigService','message','buffer','\x20order\x20by\x20createdAt\x20desc\x20limit\x20','object','status','interactCutout','lfAppId','updateTime','function','policy','thumb','updatedAt','decorate','7259035aPDbbO','RequestType','Repository','map','HttpException','fileService','/auth/get_app_token','数据不存在','234498yxMdhE','98YEFQQP','uploadFile','4209815luLasj','file','lfPrivateKey','typeorm','\x20and\x20','8WakoWZ','@nestjs/common','progress','Injectable','clsService','getOwnPropertyDescriptor','galleryID','executeAppToken','select\x20*\x20from\x20lx_gallery_tb\x20where\x20','toString','2028300QGCYkU','defineProperty','key','isSuper','taskPage','galleryPage','taskId','/linkfox-ai/image/v1/make/info/','getLfVipFree','post','getReqSaasId','galleryEntity','query','1104100youafu','bizModel','------------------token---------------------------','lfPrice','forEach','/linkfox-ai/image/v1/generateUploadUrl','@nestjs/typeorm','saasId','InjectRepository','select\x20count(0)\x20as\x20count\x20from\x20lx_gallery_tb\x20where\x20','/linkfox-ai/image/v1/make/style','split','CmConfigService','executeWithToken','data','../../common/linkFox/OpenClient','__metadata','UserService','userService','\x201=1\x20','OpenClient','544560sEwCuN','filename','save','gallery','AiLinkFoxPreset','msg','taskType','default','getAppToken','__esModule','LinkFoxService','deductBalanceLinxFox','POST_JSON','user','110Ggjrzh','BAD_REQUEST','getMethod','获取Token失败','onModuleInit','GalleryEntity','----------------------获取精选图库完成---------------------------------','LinkFoxConfig','executeWithTokenAndBalance','../cmConfig/admin/cm.service','saveGallery','createRequest','update','../file/file.service','galleryDb'];_0x532f=function(){return _0x221408;};return _0x532f();}var __decorate=this&&this[_0x546755(0xfd)]||function(_0x6164f4,_0x1651cd,_0x40188b,_0x56e6b0){const _0x487a24=_0x546755;var _0x4d1d9f=arguments[_0x487a24(0xe8)],_0x759fb9=_0x4d1d9f<0x3?_0x1651cd:_0x56e6b0===null?_0x56e6b0=Object[_0x487a24(0xa4)](_0x1651cd,_0x40188b):_0x56e6b0,_0x467951;if(typeof Reflect===_0x487a24(0x113)&&typeof Reflect['decorate']===_0x487a24(0x118))_0x759fb9=Reflect[_0x487a24(0x11c)](_0x6164f4,_0x1651cd,_0x40188b,_0x56e6b0);else{for(var _0x25a7e9=_0x6164f4[_0x487a24(0xe8)]-0x1;_0x25a7e9>=0x0;_0x25a7e9--)if(_0x467951=_0x6164f4[_0x25a7e9])_0x759fb9=(_0x4d1d9f<0x3?_0x467951(_0x759fb9):_0x4d1d9f>0x3?_0x467951(_0x1651cd,_0x40188b,_0x759fb9):_0x467951(_0x1651cd,_0x40188b))||_0x759fb9;}return _0x4d1d9f>0x3&&_0x759fb9&&Object[_0x487a24(0xaa)](_0x1651cd,_0x40188b,_0x759fb9),_0x759fb9;},__metadata=this&&this[_0x546755(0xc6)]||function(_0x519674,_0x58203b){const _0x1f6bf4=_0x546755;if(typeof Reflect==='object'&&typeof Reflect[_0x1f6bf4(0xe9)]===_0x1f6bf4(0x118))return Reflect[_0x1f6bf4(0xe9)](_0x519674,_0x58203b);},__param=this&&this['__param']||function(_0x5ca942,_0x2919f8){return function(_0x290582,_0x346ab0){_0x2919f8(_0x290582,_0x346ab0,_0x5ca942);};};Object['defineProperty'](exports,_0x546755(0xd4),{'value':!![]}),exports[_0x546755(0xd5)]=void 0x0;const common_1=require(_0x546755(0xa0)),BaseRequest_1=require('../../common/linkFox/BaseRequest'),RequestType_1=require('../../common/linkFox/RequestType'),OpenClient_1=require(_0x546755(0xc5)),store_1=require('../../common/store'),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x546755(0xf6)),typeorm_1=require(_0x546755(0x9d)),task_entity_1=require(_0x546755(0x100)),typeorm_2=require(_0x546755(0xbc)),user_service_1=require(_0x546755(0xeb)),gallery_entity_1=require(_0x546755(0xfb)),cm_service_1=require(_0x546755(0xe2)),axios_1=require(_0x546755(0x106)),FormData=require('form-data'),file_service_1=require(_0x546755(0xe6));let LinkFoxService=class LinkFoxService{constructor(_0x2cf1a1,_0x47ba98,_0x3f3107,_0xcd6f93,_0x176e24,_0x397b8d){const _0x17a453=_0x546755;this[_0x17a453(0xc8)]=_0x2cf1a1,this[_0x17a453(0xa3)]=_0x47ba98,this['cmConfigService']=_0x3f3107,this[_0x17a453(0x122)]=_0xcd6f93,this[_0x17a453(0xfa)]=_0x176e24,this['galleryEntity']=_0x397b8d;}[_0x546755(0xdd)](){}[_0x546755(0xe4)](_0x58a111){const _0x411bcc=_0x546755,_0x1681f9=new BaseRequest_1['BaseRequest']();return _0x1681f9[_0x411bcc(0xdb)]=function(){return _0x58a111;},_0x1681f9[_0x411bcc(0x108)]=function(){const _0x4d2dbe=_0x411bcc;return RequestType_1[_0x4d2dbe(0x11e)][_0x4d2dbe(0xd7)];},_0x1681f9;}[_0x546755(0xf7)](){const _0x372107=_0x546755;return new OpenClient_1[(_0x372107(0xca))](store_1[_0x372107(0xe0)][_0x372107(0x116)],store_1['LinkFoxConfig'][_0x372107(0x9c)],store_1[_0x372107(0xe0)]['lfUrl']);}async[_0x546755(0xd3)](){const _0x560e41=_0x546755,_0x43fcc2=this[_0x560e41(0xe4)](_0x560e41(0x123)),_0x59a291=await this[_0x560e41(0xf7)]()['execute'](_0x43fcc2);if(_0x59a291[_0x560e41(0xfe)]==='0'||_0x59a291[_0x560e41(0xfe)]===0x0)return _0x59a291[_0x560e41(0xc4)]['appAuthToken'];return'';}async[_0x546755(0xe1)](_0x2a44ca,_0x20e5cf){const _0x3ab2bb=_0x546755;await this['userService'][_0x3ab2bb(0xfc)](_0x20e5cf['user']['id']);const _0xd12caa=await this[_0x3ab2bb(0xc3)](_0x2a44ca);return _0xd12caa;}async[_0x546755(0xc3)](_0xdca967){const _0x34c543=_0x546755,_0x32e872=await this[_0x34c543(0xd3)]();if(!_0x32e872)throw new Error(_0x34c543(0xdc));console[_0x34c543(0x10d)](_0x34c543(0xb8),_0x32e872);const _0x53115c=await this[_0x34c543(0xf7)]()['executeAppToken'](_0xdca967,_0x32e872);if(_0x53115c[_0x34c543(0xfe)]!=='0'&&_0x53115c[_0x34c543(0xfe)]!==0x0||!_0x53115c[_0x34c543(0xc4)]['data'])throw new common_1[(_0x34c543(0x121))](_0x53115c['data']?.[_0x34c543(0xd0)]||'接口请求失败',axios_1['HttpStatusCode']['InternalServerError']);return _0x53115c[_0x34c543(0xc4)];}async[_0x546755(0x99)](_0x5e3d52){const _0x157507=_0x546755,_0x274a4d=this[_0x157507(0xe4)](_0x157507(0xbb));_0x274a4d['bizModel']={'fileName':_0x5e3d52[_0x157507(0xcc)]};const _0x6e5f80=await this['executeWithToken'](_0x274a4d),{OSSAccessKeyId:_0x5d556b,signature:_0x3e7c80,policy:_0x49d473,key:_0x563879,url:_0x1d2ac7}=_0x6e5f80[_0x157507(0xc4)][_0x157507(0x119)];if(_0x6e5f80[_0x157507(0xc4)])try{const _0xcc293b=new FormData();_0xcc293b[_0x157507(0x10a)]('OSSAccessKeyId',_0x5d556b),_0xcc293b[_0x157507(0x10a)](_0x157507(0xea),_0x3e7c80),_0xcc293b[_0x157507(0x10a)](_0x157507(0x119),_0x49d473),_0xcc293b[_0x157507(0x10a)](_0x157507(0xab),_0x563879),_0xcc293b[_0x157507(0x10a)]('success_action_status','200'),_0xcc293b[_0x157507(0x10a)](_0x157507(0x9b),_0x5e3d52[_0x157507(0x111)],_0x5e3d52['originalname']);const _0x4dd367={..._0xcc293b[_0x157507(0xf4)]()},_0xcdbe52=await axios_1[_0x157507(0xd2)][_0x157507(0xb2)]('https://linkfoxai-ailab-prod.oss-cn-shenzhen.aliyuncs.com/',_0xcc293b,{'headers':_0x4dd367});if(_0xcdbe52['status']===0xc8)return _0x6e5f80[_0x157507(0xc4)]['viewUrl'];}catch{}throw new Error(_0x157507(0xf2));}async['changeClothing'](_0x1a3e6e,_0x3d3aab){const _0x55a0b7=_0x546755,_0x2e6fe9=this[_0x55a0b7(0xe4)]('/linkfox-ai/image/v1/make/create/24');_0x2e6fe9[_0x55a0b7(0xb7)]=_0x1a3e6e;const _0x381483=await this[_0x55a0b7(0xe1)](_0x2e6fe9,_0x3d3aab),_0x566582=(0x0,utils_1[_0x55a0b7(0xb3)])(this[_0x55a0b7(0xa3)]),_0x593bc7={'taskType':0x1,'saasId':_0x566582,'userId':_0x3d3aab[_0x55a0b7(0xd8)]['id'],'taskId':_0x381483[_0x55a0b7(0xc4)]['id'],'status':0x1,'postBody':_0x1a3e6e,'resultBody':_0x381483['data'],'testBody':_0x1a3e6e},_0x44b967=await this['taskEntity'][_0x55a0b7(0xcd)](_0x593bc7);return await this[_0x55a0b7(0xc8)][_0x55a0b7(0xd6)](_0x3d3aab['user']['id'],_0x44b967['id']),_0x381483[_0x55a0b7(0xc4)];}async['aiCutoutImage'](_0x16036f,_0x5c3c6c){const _0x592d1c=_0x546755,_0x1249a2=this[_0x592d1c(0xe4)](_0x592d1c(0x104));_0x1249a2[_0x592d1c(0xb7)]=_0x16036f;const _0x2602cf=await this['executeWithTokenAndBalance'](_0x1249a2,_0x5c3c6c),_0x19141a=(0x0,utils_1['getReqSaasId'])(this[_0x592d1c(0xa3)]),_0x1289f8={'taskType':0x2,'saasId':_0x19141a,'userId':_0x5c3c6c[_0x592d1c(0xd8)]['id'],'taskId':_0x2602cf[_0x592d1c(0xc4)]['id'],'status':0x1,'postBody':_0x16036f,'resultBody':_0x2602cf['data']},_0xd71a56=await this[_0x592d1c(0xfa)]['save'](_0x1289f8);return await this[_0x592d1c(0xc8)][_0x592d1c(0xd6)](_0x5c3c6c[_0x592d1c(0xd8)]['id'],_0xd71a56['id']),_0x2602cf[_0x592d1c(0xc4)];}async[_0x546755(0x115)](_0x5ca724,_0x4b40c9){const _0x5e7751=_0x546755,_0x15d8e2=this[_0x5e7751(0xe4)]('/linkfox-ai/image/v1/make/process/interactCutout');_0x15d8e2[_0x5e7751(0xb7)]=_0x5ca724;const _0x5686fc=await this[_0x5e7751(0xe1)](_0x15d8e2,_0x4b40c9),_0x3d087a=(0x0,utils_1[_0x5e7751(0xb3)])(this['clsService']),_0x3b2a0e={'taskType':0x3,'saasId':_0x3d087a,'userId':_0x4b40c9['user']['id'],'taskId':'','status':0x3,'postBody':_0x5ca724,'resultBody':_0x5686fc['data']},_0x4e2de0=await this[_0x5e7751(0xfa)][_0x5e7751(0xcd)](_0x3b2a0e);return await this['userService'][_0x5e7751(0xd6)](_0x4b40c9[_0x5e7751(0xd8)]['id'],_0x4e2de0['id']),_0x5686fc['data'];}async[_0x546755(0xad)](_0x31e22d,_0x39920b){const _0x2d4447=_0x546755;try{const _0x2cc460=(0x0,utils_1[_0x2d4447(0xb3)])(this[_0x2d4447(0xa3)]),{page:page=0x1,size:size=0x14,status:_0x467b3f,taskType:_0x29f127}=_0x31e22d,_0x33bd4a={};!(0x0,utils_1[_0x2d4447(0xac)])(this['clsService'])&&(_0x33bd4a[_0x2d4447(0xbd)]=_0x2cc460,_0x33bd4a['userId']=_0x39920b[_0x2d4447(0xd8)]['id']);_0x467b3f&&(_0x33bd4a[_0x2d4447(0x114)]=_0x467b3f);_0x29f127&&(_0x33bd4a[_0x2d4447(0xd1)]=_0x29f127);const [_0x232dec,_0x17ee21]=await this[_0x2d4447(0xfa)][_0x2d4447(0xef)]({'where':_0x33bd4a,'take':size,'skip':(page-0x1)*size,'order':{'createdAt':_0x2d4447(0x103)}});return{'rows':_0x232dec,'count':_0x17ee21};}catch(_0x3f3a77){throw new common_1[(_0x2d4447(0x121))](_0x3f3a77['message'],common_1['HttpStatus'][_0x2d4447(0xda)]);}}async[_0x546755(0xae)](_0x399dab){const _0x20c5c2=_0x546755;try{const {page:page=0x1,size:size=0x14}=_0x399dab,_0xcbf5eb=_0x399dab[_0x20c5c2(0x102)][_0x20c5c2(0xc1)]('-');let _0x430b85='';_0xcbf5eb[_0x20c5c2(0xe8)]&&_0xcbf5eb[_0x20c5c2(0xba)](_0x3029f3=>{const _0x40c55c=_0x20c5c2;_0x430b85&&(_0x430b85+=_0x40c55c(0x9e)),_0x3029f3&&(_0x430b85+=_0x40c55c(0x105)+_0x3029f3+'%\x27');});!_0x430b85&&(_0x430b85=_0x20c5c2(0xc9));const _0x660fef=await this['galleryEntity']['query'](_0x20c5c2(0xbf)+_0x430b85),_0x4fdde0=await this[_0x20c5c2(0xb4)][_0x20c5c2(0xb5)](_0x20c5c2(0xa7)+_0x430b85+_0x20c5c2(0x112)+(page-0x1)*size+','+size);return{'rows':_0x4fdde0,'count':parseInt(_0x660fef[0x0]['count'])};}catch(_0x5b0cad){throw new common_1[(_0x20c5c2(0x121))](_0x5b0cad['message'],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x546755(0xe7)](_0x2e363d){const _0x3997d0=_0x546755,_0x1ea92c=this['createRequest'](_0x3997d0(0xc0));_0x1ea92c[_0x3997d0(0xb7)]={'showType':0x0,'type':_0x2e363d};const _0x4b5b58=await this[_0x3997d0(0xc3)](_0x1ea92c),_0x2a1786=[];_0x4b5b58[_0x3997d0(0xc4)][_0x3997d0(0xba)](_0x36bd37=>{const _0x4ede5b=_0x3997d0,_0x530e0f={};Object[_0x4ede5b(0x10b)](_0x36bd37)['forEach'](_0x200ede=>{const _0x15fec8=_0x4ede5b;if(_0x200ede==='id')_0x530e0f[_0x15fec8(0xa5)]=_0x36bd37['id']['toString']();else{if(_0x200ede===_0x15fec8(0x117))_0x530e0f[_0x15fec8(0x11b)]=new Date(_0x36bd37[_0x15fec8(0x117)]);else _0x200ede===_0x15fec8(0x10e)?_0x530e0f[_0x15fec8(0xf8)]=new Date(_0x36bd37[_0x15fec8(0x10e)]):_0x530e0f[_0x200ede]=_0x36bd37[_0x200ede];}}),_0x2a1786['push'](_0x530e0f);});const _0x3abd0e=await this[_0x3997d0(0xb4)]['save'](_0x2a1786);return _0x4b5b58;}async[_0x546755(0xe3)](_0x189723){const _0x115159=_0x546755;try{const _0x301b9b=(0x0,utils_1[_0x115159(0xb3)])(this[_0x115159(0xa3)]);return await this['galleryEntity'][_0x115159(0xcd)]({..._0x189723,'saasId':_0x301b9b}),!![];}catch(_0x15bc1a){throw new common_1[(_0x115159(0x121))](_0x15bc1a[_0x115159(0x110)],common_1['HttpStatus'][_0x115159(0xda)]);}}async[_0x546755(0xce)](){const _0x4ffb30=_0x546755;console[_0x4ffb30(0x10d)]('----------------------获取精选图库---------------------------------'),this[_0x4ffb30(0xb4)]['clear'](),await this['galleryDb'](0x12),console[_0x4ffb30(0x10d)](_0x4ffb30(0xdf));}async[_0x546755(0xf0)](){const _0x4c8632=_0x546755,_0x1d0c6c=await this[_0x4c8632(0xfa)][_0x4c8632(0xb5)](_0x4c8632(0x10c));if(_0x1d0c6c[_0x4c8632(0xe8)]){const _0x21dbb3=await this[_0x4c8632(0xd3)]();if(!_0x21dbb3)throw new Error(_0x4c8632(0xdc));_0x1d0c6c[_0x4c8632(0xba)](async _0x1ea403=>{const _0x198a43=_0x4c8632,_0x4f272c=this[_0x198a43(0xe4)](_0x198a43(0xb0)+(_0x1ea403[_0x198a43(0xd1)]===0x1?'24':'3'));_0x4f272c[_0x198a43(0xb7)]={'id':_0x1ea403[_0x198a43(0xaf)]};const _0x27040f=await this['createClient']()[_0x198a43(0xa6)](_0x4f272c,_0x21dbb3);if((_0x27040f[_0x198a43(0xfe)]==='0'||_0x27040f[_0x198a43(0xfe)]===0x0)&&_0x27040f[_0x198a43(0xc4)]['data']){const _0xe3b072=_0x27040f[_0x198a43(0xc4)][_0x198a43(0xc4)],_0x5aad37=_0xe3b072[_0x198a43(0xee)];_0xe3b072[_0x198a43(0x114)]===0x3&&await Promise['all'](_0x5aad37[_0x198a43(0x120)](async(_0x69ec2c,_0x19250b)=>{const _0x46e0d4=_0x198a43;if(_0x69ec2c[_0x46e0d4(0x11a)]){const _0x52acad=await this[_0x46e0d4(0x122)]['transferFile'](_0x69ec2c[_0x46e0d4(0x11a)]);_0x5aad37[_0x19250b][_0x46e0d4(0x11a)]=_0x52acad;}})),await this[_0x198a43(0xfa)][_0x198a43(0xe5)]({'id':_0x1ea403['id']},{'progress':_0xe3b072['ratio'],'resultBody':_0x5aad37,'status':_0xe3b072[_0x198a43(0x114)]}),console[_0x198a43(0x10d)]('【'+_0x1ea403[_0x198a43(0xaf)]+_0x198a43(0x109),_0x5aad37);}});}}async['makeInfo'](_0xc74e42,_0x56337c){const _0x1878ba=_0x546755;if(_0xc74e42){let _0x41fdf2=await this[_0x1878ba(0xfa)][_0x1878ba(0xf3)]({'where':[{'id':parseInt(_0xc74e42[_0x1878ba(0xa8)]())},{'taskId':_0xc74e42[_0x1878ba(0xa8)]()}]});if(!_0x41fdf2)throw new Error(_0x1878ba(0x124));return{'id':_0x41fdf2['taskId'],'status':_0x41fdf2[_0x1878ba(0x114)],'resultBody':_0x41fdf2[_0x1878ba(0x101)],'process':_0x41fdf2[_0x1878ba(0xa1)]};}const _0x4ce3c5=await this['taskEntity'][_0x1878ba(0xff)]({'taskType':_0x56337c});return _0x4ce3c5[_0x1878ba(0x120)](_0x490bf3=>{const _0x2e03a2=_0x1878ba;return{'id':_0x490bf3['taskId'],'resultBody':_0x490bf3[_0x2e03a2(0x101)],'status':_0x490bf3[_0x2e03a2(0x114)],'process':_0x490bf3[_0x2e03a2(0xa1)]};});}async[_0x546755(0xf1)](_0x1d05bf){const _0x3667a8=_0x546755,_0x4e0653=await this['userService'][_0x3667a8(0xb1)](_0x1d05bf['user']['id']),_0x548ade=await this[_0x3667a8(0x10f)]['getConfig'](_0x3667a8(0xcf));return{'remainCount':_0x4e0653,'freeCount':store_1['LinkFoxConfig']['lfVipFree'],'useIntegrate':store_1[_0x3667a8(0xe0)][_0x3667a8(0xb9)],'preset':_0x548ade['value'][_0x3667a8(0xf9)]};}};LinkFoxService=__decorate([(0x0,common_1[_0x546755(0xa2)])(),__param(0x4,(0x0,typeorm_2[_0x546755(0xbe)])(task_entity_1['TaskEntity'])),__param(0x5,(0x0,typeorm_2['InjectRepository'])(gallery_entity_1[_0x546755(0xde)])),__metadata(_0x546755(0xf5),[user_service_1[_0x546755(0xc7)],nestjs_cls_1['ClsService'],cm_service_1[_0x546755(0xc2)],file_service_1['FileService'],typeorm_1['Repository'],typeorm_1[_0x546755(0x11f)]])],LinkFoxService),exports[_0x546755(0xd5)]=LinkFoxService;