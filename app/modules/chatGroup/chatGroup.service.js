'use strict';function _0x3b2c(_0x2bd042,_0x2353b4){const _0x308a94=_0x308a();return _0x3b2c=function(_0x3b2cb9,_0x545d88){_0x3b2cb9=_0x3b2cb9-0x1d7;let _0x4c9f1c=_0x308a94[_0x3b2cb9];return _0x4c9f1c;},_0x3b2c(_0x2bd042,_0x2353b4);}function _0x308a(){const _0x373bc4=['modelType','Connection','mindTaskService','DESC','delAll','query','pptTaskEntity','chatGroupEntity','125595AVJAwt','3804241RDfEWm','name','clear','stringify','11DwKQVl','title','CHAT','BAD_REQUEST','ChatGroupEntity','map','DocsTaskEntity','docs','../docsTask/entity/docsTask.entity','groupId','set','getOwnPropertyDescriptor','affected','find','user','connection','EPPTTaskType','push','5894370AHmvct','IsNull','config','InjectRepository','update','删除成功','EModelType','save','__esModule','70Rtdkgz','27eDKpFn','431792EfUqwk','../gpts/dto/gpts.chat-group.entity','HttpException','forEach','length','__metadata','../mindTask/mindTask.service','prompt','getTime','updatedAt','decorate','更新对话失败！','非法操作、您在删除一个非法资源！','userId','ppt','MindTaskService','PPTTaskEntity','HttpStatus','__param','新对话','clearhistory','删除失败！','undefined','ChatGroupService','@nestjs/common','join','metadata','gptsChatGroupEntity','__decorate','isSticky','Injectable','topConversation','1192255svLpsy','defineProperty','mind','Repository','updateLastMessage','788088jcgPTq','GptsChatGroupEntity','modelsService','findOne','typeorm','sort','16174068Vdrbnn','function','12GvBoIw','docsTaskEntity','log','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20(','error:\x20','get','20YwWVSx','../models/models.service',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20\x20\x20','getGroupInfoFromId','lastTime','对话组编号和用户编号不匹配，请登录之后创建新的对话！'];_0x308a=function(){return _0x373bc4;};return _0x308a();}const _0x472a59=_0x3b2c;(function(_0x50bdab,_0x1d3c13){const _0x1cb74f=_0x3b2c,_0x3c116f=_0x50bdab();while(!![]){try{const _0x1ef3ee=-parseInt(_0x1cb74f(0x1d7))/0x1+-parseInt(_0x1cb74f(0x218))/0x2*(-parseInt(_0x1cb74f(0x1f8))/0x3)+parseInt(_0x1cb74f(0x21a))/0x4*(-parseInt(_0x1cb74f(0x1ea))/0x5)+parseInt(_0x1cb74f(0x1e4))/0x6*(-parseInt(_0x1cb74f(0x1f9))/0x7)+-parseInt(_0x1cb74f(0x1dc))/0x8*(-parseInt(_0x1cb74f(0x219))/0x9)+parseInt(_0x1cb74f(0x20f))/0xa+parseInt(_0x1cb74f(0x1fd))/0xb*(parseInt(_0x1cb74f(0x1e2))/0xc);if(_0x1ef3ee===_0x1d3c13)break;else _0x3c116f['push'](_0x3c116f['shift']());}catch(_0x42592d){_0x3c116f['push'](_0x3c116f['shift']());}}}(_0x308a,0xf0fe7));var __decorate=this&&this[_0x472a59(0x236)]||function(_0x316f38,_0x29fd4f,_0x545b5b,_0x1fa61e){const _0x8f6fa0=_0x472a59;var _0x5487f6=arguments[_0x8f6fa0(0x21e)],_0x4deab8=_0x5487f6<0x3?_0x29fd4f:_0x1fa61e===null?_0x1fa61e=Object[_0x8f6fa0(0x208)](_0x29fd4f,_0x545b5b):_0x1fa61e,_0x6aeb4;if(typeof Reflect==='object'&&typeof Reflect[_0x8f6fa0(0x224)]===_0x8f6fa0(0x1e3))_0x4deab8=Reflect['decorate'](_0x316f38,_0x29fd4f,_0x545b5b,_0x1fa61e);else{for(var _0x5541df=_0x316f38['length']-0x1;_0x5541df>=0x0;_0x5541df--)if(_0x6aeb4=_0x316f38[_0x5541df])_0x4deab8=(_0x5487f6<0x3?_0x6aeb4(_0x4deab8):_0x5487f6>0x3?_0x6aeb4(_0x29fd4f,_0x545b5b,_0x4deab8):_0x6aeb4(_0x29fd4f,_0x545b5b))||_0x4deab8;}return _0x5487f6>0x3&&_0x4deab8&&Object[_0x8f6fa0(0x1d8)](_0x29fd4f,_0x545b5b,_0x4deab8),_0x4deab8;},__metadata=this&&this[_0x472a59(0x21f)]||function(_0x160ba6,_0x272384){const _0x320282=_0x472a59;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x320282(0x1e3))return Reflect[_0x320282(0x234)](_0x160ba6,_0x272384);},__param=this&&this[_0x472a59(0x22c)]||function(_0x386015,_0x3bf4e7){return function(_0x422b8e,_0x43643a){_0x3bf4e7(_0x422b8e,_0x43643a,_0x386015);};};Object[_0x472a59(0x1d8)](exports,_0x472a59(0x217),{'value':!![]}),exports[_0x472a59(0x231)]=void 0x0;const common_1=require(_0x472a59(0x232)),chatGroup_entity_1=require('./chatGroup.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x472a59(0x1e0)),models_service_1=require(_0x472a59(0x1eb)),model_constant_1=require('../../common/constants/model.constant'),mindTask_service_1=require(_0x472a59(0x220)),pptTask_entity_1=require('../chatgpt/entity/pptTask.entity'),docsTask_entity_1=require(_0x472a59(0x205)),ppt_constant_1=require('../../common/constants/ppt.constant'),gpts_chat_group_entity_1=require(_0x472a59(0x21b));let ChatGroupService=class ChatGroupService{constructor(_0x2fcb51,_0x29d57c,_0x276fae,_0x1336db,_0x59be2d,_0x559ffc,_0x586af4){const _0x4bdccc=_0x472a59;this['chatGroupEntity']=_0x2fcb51,this['modelsService']=_0x29d57c,this[_0x4bdccc(0x1f2)]=_0x276fae,this[_0x4bdccc(0x1f6)]=_0x1336db,this[_0x4bdccc(0x1e5)]=_0x59be2d,this[_0x4bdccc(0x235)]=_0x559ffc,this[_0x4bdccc(0x20c)]=_0x586af4;}async['create'](_0xc00666,_0x44a6c2){const _0x3bf2d4=_0x472a59,{title:title=_0x3bf2d4(0x22d),model:_0x3d0ac3,modelType:modelType=model_constant_1[_0x3bf2d4(0x215)][_0x3bf2d4(0x1ff)]}=_0x44a6c2,_0x50bcb2={'title':title,'modelType':modelType,'userId':_0xc00666[_0x3bf2d4(0x20b)]['id']},_0x231a1f=await this[_0x3bf2d4(0x1de)]['getModelByType'](modelType,_0x3d0ac3);_0x50bcb2[_0x3bf2d4(0x211)]=JSON[_0x3bf2d4(0x1fc)](_0x231a1f);const _0x1892a4=await this[_0x3bf2d4(0x1f7)]['save'](_0x50bcb2);return _0x1892a4;}async[_0x472a59(0x1e9)](_0x5ad0a6,_0x57070a){const _0x556ea5=_0x472a59;try{const _0x31aa4b={'userId':_0x57070a[_0x556ea5(0x20b)]['id'],'id':_0x5ad0a6,'isDelete':![]},_0x490732=await this['chatGroupEntity']['findOne']({'where':_0x31aa4b});return _0x490732;}catch(_0x570b2b){console['log'](_0x556ea5(0x1e8),_0x570b2b);}}async[_0x472a59(0x1db)](_0x448bb1,_0x4f737f,_0x4aa944,_0xa861cd){const _0x2d4364=_0x472a59;console[_0x2d4364(0x1e6)]('updateLastMessage:\x20',_0x448bb1,_0x4f737f,_0x4aa944,_0xa861cd);if(_0x448bb1=='gpts')this[_0x2d4364(0x235)]['update']({'id':_0x4f737f},{'lastMessage':_0xa861cd,'updatedAt':new Date()});else{const _0x5eba45=this['get'](_0x4f737f,_0x4aa944);_0x5eba45&&await this[_0x2d4364(0x1f7)][_0x2d4364(0x213)]({'id':_0x4f737f},{'lastMessage':_0xa861cd,'updatedAt':new Date()});}}async['query'](_0x50761b,_0x1a4d4b,_0xa057cb,_0x484e68){const _0x153a5b=_0x472a59;try{const {id:_0x5a2612}=_0x484e68['user'],_0x10aa9f={'userId':_0x5a2612,'isDelete':![]};_0x50761b?_0x10aa9f[_0x153a5b(0x1f0)]=_0x50761b:_0x10aa9f[_0x153a5b(0x1f0)]=(0x0,typeorm_2[_0x153a5b(0x210)])();let _0x30a6c9=[];if(_0xa057cb>0x0&&_0x1a4d4b>0x0){const _0x242eb9=(_0x1a4d4b-0x1)*_0xa057cb;_0x30a6c9=await this[_0x153a5b(0x1f7)][_0x153a5b(0x20a)]({'where':_0x10aa9f,'take':_0xa057cb,'skip':_0x242eb9,'order':{'isSticky':'DESC','updatedAt':'DESC','id':'DESC'}});}else _0x30a6c9=await this[_0x153a5b(0x1f7)][_0x153a5b(0x20a)]({'where':_0x10aa9f,'order':{'isSticky':_0x153a5b(0x1f3),'updatedAt':_0x153a5b(0x1f3),'id':_0x153a5b(0x1f3)}});if(!_0x30a6c9[_0x153a5b(0x21e)])return _0x30a6c9;const _0x1a087c=_0x30a6c9['map'](_0x319f2c=>_0x319f2c['id']),_0x53b018=await this[_0x153a5b(0x20c)]['query'](_0x153a5b(0x1e7)+_0x1a087c[_0x153a5b(0x233)]()+')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20'),_0x302d15=new Map();_0x53b018[_0x153a5b(0x21d)](_0x4b2022=>{const _0x2b7dfa=_0x153a5b;_0x302d15[_0x2b7dfa(0x207)](_0x4b2022[_0x2b7dfa(0x206)],_0x4b2022[_0x2b7dfa(0x1ee)]);});const _0x5b9c83=_0x30a6c9[_0x153a5b(0x202)](_0x4592ee=>{const _0x2128e4=_0x153a5b;return{..._0x4592ee,'lastTime':_0x302d15[_0x2128e4(0x1e9)](_0x4592ee['id'])||null};});return _0x5b9c83;}catch(_0x53b34c){console[_0x153a5b(0x1e6)](_0x153a5b(0x1e8),_0x53b34c);}}async[_0x472a59(0x213)](_0x9e1416,_0x161e4a){const _0x309656=_0x472a59,{title:_0x56b8ea,isSticky:_0x1a17ce,groupId:_0x325f6a,config:_0x32764f,appType:_0x22077b}=_0x9e1416,{id:_0x4d5baa}=_0x161e4a[_0x309656(0x20b)],_0x34e15c=await this[_0x309656(0x1f7)][_0x309656(0x1df)]({'where':{'id':_0x325f6a,'userId':_0x4d5baa}});if(!_0x34e15c)throw new common_1['HttpException'](_0x309656(0x1ef),common_1[_0x309656(0x22b)]['BAD_REQUEST']);const _0x6efa9a={};_0x56b8ea&&(_0x6efa9a[_0x309656(0x1fe)]=_0x56b8ea),typeof _0x1a17ce!==_0x309656(0x230)&&(_0x6efa9a['isSticky']=_0x1a17ce),_0x32764f&&(_0x6efa9a[_0x309656(0x211)]=_0x32764f);const _0x46d579=await this[_0x309656(0x1f7)][_0x309656(0x213)]({'id':_0x325f6a},_0x6efa9a);if(_0x46d579[_0x309656(0x209)])return!![];else throw new common_1[(_0x309656(0x21c))](_0x309656(0x225),common_1[_0x309656(0x22b)][_0x309656(0x200)]);}async['del'](_0x3038fc,_0x5c526b){const _0x936a3a=_0x472a59,{groupId:_0x1cf7fd}=_0x3038fc,{id:_0xf779ce}=_0x5c526b[_0x936a3a(0x20b)],_0x125a03=await this['chatGroupEntity'][_0x936a3a(0x1df)]({'where':{'id':_0x1cf7fd,'userId':_0xf779ce}});if(!_0x125a03)throw new common_1['HttpException'](_0x936a3a(0x226),common_1[_0x936a3a(0x22b)]['BAD_REQUEST']);const _0x4d5471=await this[_0x936a3a(0x1f7)][_0x936a3a(0x213)]({'id':_0x1cf7fd},{'isDelete':!![]});if(_0x4d5471['affected'])return'删除成功';else throw new common_1[(_0x936a3a(0x21c))]('删除失败！',common_1[_0x936a3a(0x22b)][_0x936a3a(0x200)]);}async[_0x472a59(0x1f4)](_0x570d66){const _0x385cf6=_0x472a59,{id:_0x11c5f3}=_0x570d66['user'],_0x50787c=await this[_0x385cf6(0x1f7)]['update']({'userId':_0x11c5f3,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x50787c[_0x385cf6(0x209)])return _0x385cf6(0x214);else throw new common_1[(_0x385cf6(0x21c))](_0x385cf6(0x22f),common_1[_0x385cf6(0x22b)][_0x385cf6(0x200)]);}async[_0x472a59(0x1ed)](_0x24c2fa){const _0x55530c=_0x472a59;if(!_0x24c2fa||_0x24c2fa===0x0)return null;return await this['chatGroupEntity'][_0x55530c(0x1df)]({'where':{'id':_0x24c2fa}});}async['history'](_0x220052,_0xed4cd5){const _0x24311f=_0x472a59;try{const {id:_0x2c764f}=_0xed4cd5[_0x24311f(0x20b)],_0x3b2343={'userId':_0x2c764f,'isDelete':![]};_0x220052?_0x3b2343[_0x24311f(0x1f0)]=(0x0,typeorm_2['In'])(_0x220052):_0x3b2343[_0x24311f(0x1f0)]=(0x0,typeorm_2[_0x24311f(0x210)])();let _0x14a62b=[];const _0x76319e=await this[_0x24311f(0x1f7)]['find']({'where':_0x3b2343,'order':{'isSticky':'DESC','id':'DESC'}});if(_0x76319e[_0x24311f(0x21e)]){const _0x400b20=_0x76319e[_0x24311f(0x202)](_0x12daca=>_0x12daca['id']),_0x338f99=await this[_0x24311f(0x20c)][_0x24311f(0x1f5)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20('+_0x400b20['join']()+_0x24311f(0x1ec)),_0x524eaf=new Map();_0x338f99[_0x24311f(0x21d)](_0x15ef53=>{const _0xa3b4a=_0x24311f;_0x524eaf['set'](_0x15ef53[_0xa3b4a(0x206)],_0x15ef53['lastTime']);}),_0x14a62b=_0x76319e[_0x24311f(0x202)](_0x5e744a=>{const _0x1d56aa=_0x24311f;return{..._0x5e744a,'lastTime':_0x524eaf[_0x1d56aa(0x1e9)](_0x5e744a['id'])||null};});}const _0x130003=await this[_0x24311f(0x1f2)]['getList'](_0xed4cd5),_0x123ea2=await this[_0x24311f(0x1f6)][_0x24311f(0x20a)]({'where':{'userId':_0xed4cd5[_0x24311f(0x20b)]['id'],'type':ppt_constant_1['EPPTTaskType']['CREATE'],'delFlag':0x0},'order':{'updatedAt':'DESC'}}),_0x4873b7=await this['docsTaskEntity']['find']({'where':{'userId':_0xed4cd5[_0x24311f(0x20b)]['id'],'deleteFlag':0x0},'order':{'updatedAt':_0x24311f(0x1f3)}});return _0x14a62b['push'](..._0x130003['map'](_0x467fb8=>{const _0x179676=_0x24311f;return{'modelType':_0x179676(0x1d9),'id':_0x467fb8['id'],'title':_0x467fb8['name']||_0x467fb8[_0x179676(0x221)],'lastTime':_0x467fb8[_0x179676(0x223)],'userId':_0x467fb8['userId'],'updatedAt':_0x467fb8[_0x179676(0x223)]};})),_0x14a62b[_0x24311f(0x20e)](..._0x123ea2[_0x24311f(0x202)](_0x4b0c6d=>{const _0x3bc780=_0x24311f;return{'modelType':_0x3bc780(0x228),'id':_0x4b0c6d['id'],'title':_0x4b0c6d[_0x3bc780(0x1fe)],'lastTime':_0x4b0c6d[_0x3bc780(0x223)],'userId':_0x4b0c6d[_0x3bc780(0x227)],'updatedAt':_0x4b0c6d[_0x3bc780(0x223)]};})),_0x14a62b[_0x24311f(0x20e)](..._0x4873b7[_0x24311f(0x202)](_0x35b68a=>{const _0x3676e1=_0x24311f;return{'modelType':_0x3676e1(0x204),'id':_0x35b68a['id'],'title':_0x35b68a[_0x3676e1(0x1fa)],'lastTime':_0x35b68a[_0x3676e1(0x223)],'userId':_0x35b68a[_0x3676e1(0x227)],'updatedAt':_0x35b68a[_0x3676e1(0x223)]};})),_0x14a62b[_0x24311f(0x1e1)]((_0x206570,_0x16361e)=>{const _0x585fc5=_0x24311f,_0x73fd91=new Date(_0x206570[_0x585fc5(0x223)])[_0x585fc5(0x222)](),_0x4f637f=new Date(_0x16361e['updatedAt'])[_0x585fc5(0x222)]();return _0x4f637f-_0x73fd91;}),_0x14a62b;}catch(_0x512c0f){console['log'](_0x24311f(0x1e8),_0x512c0f);}}async[_0x472a59(0x22e)](_0x8c7dae,_0x9efd00){const _0x1d8d4d=_0x472a59;try{await this['chatGroupEntity']['update']({'userId':_0x9efd00[_0x1d8d4d(0x20b)]['id'],'isDelete':![],'modelType':(0x0,typeorm_2['In'])(_0x8c7dae)},{'isDelete':!![]}),await this[_0x1d8d4d(0x1f2)][_0x1d8d4d(0x1fb)](_0x9efd00),await this[_0x1d8d4d(0x1f6)]['update']({'userId':_0x9efd00[_0x1d8d4d(0x20b)]['id'],'type':ppt_constant_1[_0x1d8d4d(0x20d)]['CREATE']},{'delFlag':0x1}),await this[_0x1d8d4d(0x1e5)][_0x1d8d4d(0x213)]({'userId':_0x9efd00[_0x1d8d4d(0x20b)]['id']},{'deleteFlag':0x1});}catch(_0x81b00e){console[_0x1d8d4d(0x1e6)](_0x1d8d4d(0x1e8),_0x81b00e);}}async[_0x472a59(0x239)](_0x432fa7,_0x208429,_0x32a3d0){const _0x293f4f=_0x472a59;try{const _0x4521cf=await this['chatGroupEntity'][_0x293f4f(0x1df)]({'where':{'id':_0x432fa7,'userId':_0x32a3d0[_0x293f4f(0x20b)]['id']}});if(!_0x4521cf)throw new Error('会话不存在！');_0x4521cf[_0x293f4f(0x237)]=_0x208429==0x1,await this[_0x293f4f(0x1f7)][_0x293f4f(0x216)](_0x4521cf);}catch(_0x599326){return _0x599326['message'];}}};ChatGroupService=__decorate([(0x0,common_1[_0x472a59(0x238)])(),__param(0x0,(0x0,typeorm_1[_0x472a59(0x212)])(chatGroup_entity_1[_0x472a59(0x201)])),__param(0x3,(0x0,typeorm_1[_0x472a59(0x212)])(pptTask_entity_1[_0x472a59(0x22a)])),__param(0x4,(0x0,typeorm_1[_0x472a59(0x212)])(docsTask_entity_1[_0x472a59(0x203)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(gpts_chat_group_entity_1[_0x472a59(0x1dd)])),__metadata('design:paramtypes',[typeorm_2[_0x472a59(0x1da)],models_service_1['ModelsService'],mindTask_service_1[_0x472a59(0x229)],typeorm_2[_0x472a59(0x1da)],typeorm_2[_0x472a59(0x1da)],typeorm_2[_0x472a59(0x1da)],typeorm_2[_0x472a59(0x1f1)]])],ChatGroupService),exports[_0x472a59(0x231)]=ChatGroupService;