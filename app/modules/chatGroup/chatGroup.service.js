'use strict';function _0x5506(_0x1eccab,_0x410a23){const _0x115658=_0x1156();return _0x5506=function(_0x5506db,_0x3af83b){_0x5506db=_0x5506db-0x181;let _0x4a9796=_0x115658[_0x5506db];return _0x4a9796;},_0x5506(_0x1eccab,_0x410a23);}const _0x3eb7e2=_0x5506;(function(_0xa94e6b,_0x133360){const _0x29a5aa=_0x5506,_0x509e1a=_0xa94e6b();while(!![]){try{const _0x46a1ca=-parseInt(_0x29a5aa(0x189))/0x1*(-parseInt(_0x29a5aa(0x1a0))/0x2)+parseInt(_0x29a5aa(0x1a2))/0x3*(parseInt(_0x29a5aa(0x1b1))/0x4)+parseInt(_0x29a5aa(0x1b6))/0x5+-parseInt(_0x29a5aa(0x1ae))/0x6*(-parseInt(_0x29a5aa(0x194))/0x7)+parseInt(_0x29a5aa(0x19e))/0x8+parseInt(_0x29a5aa(0x1aa))/0x9*(parseInt(_0x29a5aa(0x19a))/0xa)+-parseInt(_0x29a5aa(0x1b5))/0xb;if(_0x46a1ca===_0x133360)break;else _0x509e1a['push'](_0x509e1a['shift']());}catch(_0x365033){_0x509e1a['push'](_0x509e1a['shift']());}}}(_0x1156,0x646a2));function _0x1156(){const _0x3a5bb4=['join','12666RHMNMK','__decorate','update','1796yZLxXe','error:\x20','ModelsService','__param','28840284pMkwgO','2015760CKTJoU','@nestjs/common','map','forEach','config','BAD_REQUEST','EModelType',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20','stringify','length','object','modelsService','modelType','HttpStatus','connection','defineProperty','@nestjs/typeorm','undefined','getModelByType','design:paramtypes','get','HttpException','findOne','__esModule','588611xsbVaC','非法操作、您在删除一个非法资源！','Repository','user','delAll','ChatGroupService','groupId','function','save','del','../models/models.service','2387ONNGXI','chatGroupEntity','../../common/constants/model.constant','decorate','InjectRepository','typeorm','9580PLKlhc','./chatGroup.entity','find','DESC','4827592NvBsVH','删除成功','2nwQxYG','query','1527SzATwn','ChatGroupEntity','isSticky','set','lastTime','删除失败！','__metadata','log','4599cprJqh','affected','metadata'];_0x1156=function(){return _0x3a5bb4;};return _0x1156();}var __decorate=this&&this[_0x3eb7e2(0x1af)]||function(_0x1cde60,_0x19a156,_0x73e05a,_0x3e5d02){const _0x3a89ab=_0x3eb7e2;var _0x306f88=arguments[_0x3a89ab(0x1bf)],_0x13f0c0=_0x306f88<0x3?_0x19a156:_0x3e5d02===null?_0x3e5d02=Object['getOwnPropertyDescriptor'](_0x19a156,_0x73e05a):_0x3e5d02,_0x28775f;if(typeof Reflect===_0x3a89ab(0x1c0)&&typeof Reflect['decorate']==='function')_0x13f0c0=Reflect[_0x3a89ab(0x197)](_0x1cde60,_0x19a156,_0x73e05a,_0x3e5d02);else{for(var _0x282cd5=_0x1cde60[_0x3a89ab(0x1bf)]-0x1;_0x282cd5>=0x0;_0x282cd5--)if(_0x28775f=_0x1cde60[_0x282cd5])_0x13f0c0=(_0x306f88<0x3?_0x28775f(_0x13f0c0):_0x306f88>0x3?_0x28775f(_0x19a156,_0x73e05a,_0x13f0c0):_0x28775f(_0x19a156,_0x73e05a))||_0x13f0c0;}return _0x306f88>0x3&&_0x13f0c0&&Object[_0x3a89ab(0x1c5)](_0x19a156,_0x73e05a,_0x13f0c0),_0x13f0c0;},__metadata=this&&this[_0x3eb7e2(0x1a8)]||function(_0x5950ed,_0x4a0cca){const _0x40cc92=_0x3eb7e2;if(typeof Reflect===_0x40cc92(0x1c0)&&typeof Reflect[_0x40cc92(0x1ac)]===_0x40cc92(0x190))return Reflect['metadata'](_0x5950ed,_0x4a0cca);},__param=this&&this[_0x3eb7e2(0x1b4)]||function(_0xf42b5e,_0x549939){return function(_0x1351ad,_0x4111f2){_0x549939(_0x1351ad,_0x4111f2,_0xf42b5e);};};Object[_0x3eb7e2(0x1c5)](exports,_0x3eb7e2(0x188),{'value':!![]}),exports[_0x3eb7e2(0x18e)]=void 0x0;const common_1=require(_0x3eb7e2(0x1b7)),chatGroup_entity_1=require(_0x3eb7e2(0x19b)),typeorm_1=require(_0x3eb7e2(0x181)),typeorm_2=require(_0x3eb7e2(0x199)),models_service_1=require(_0x3eb7e2(0x193)),model_constant_1=require(_0x3eb7e2(0x196));let ChatGroupService=class ChatGroupService{constructor(_0x209d42,_0x555e3d,_0x3c0ede){const _0x209bfa=_0x3eb7e2;this[_0x209bfa(0x195)]=_0x209d42,this[_0x209bfa(0x1c1)]=_0x555e3d,this[_0x209bfa(0x1c4)]=_0x3c0ede;}async['create'](_0x550372,_0x276404){const _0x1928cd=_0x3eb7e2,{title:title='新对话',model:_0x297896,modelType:modelType=model_constant_1[_0x1928cd(0x1bc)]['CHAT']}=_0x276404,_0x19285d={'title':title,'modelType':modelType,'userId':_0x550372['user']['id']},_0x178bf8=await this[_0x1928cd(0x1c1)][_0x1928cd(0x183)](modelType,_0x297896);_0x19285d['config']=JSON[_0x1928cd(0x1be)](_0x178bf8);const _0x38a060=await this['chatGroupEntity'][_0x1928cd(0x191)](_0x19285d);return _0x38a060;}async[_0x3eb7e2(0x1a1)](_0x56e73d,_0x3e12fc){const _0x3794e2=_0x3eb7e2;try{const {id:_0x20fe26}=_0x3e12fc[_0x3794e2(0x18c)],_0x3632eb={'userId':_0x20fe26,'isDelete':![]};_0x56e73d?_0x3632eb['modelType']=_0x56e73d:_0x3632eb[_0x3794e2(0x1c2)]=(0x0,typeorm_2['IsNull'])();const _0x16de8f=await this[_0x3794e2(0x195)][_0x3794e2(0x19c)]({'where':_0x3632eb,'order':{'isSticky':_0x3794e2(0x19d),'id':_0x3794e2(0x19d)}});if(!_0x16de8f[_0x3794e2(0x1bf)])return _0x16de8f;const _0x29e2a6=_0x16de8f[_0x3794e2(0x1b8)](_0x4397f8=>_0x4397f8['id']),_0x1430c3=await this['connection'][_0x3794e2(0x1a1)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20('+_0x29e2a6[_0x3794e2(0x1ad)]()+_0x3794e2(0x1bd)),_0x52ce05=new Map();_0x1430c3[_0x3794e2(0x1b9)](_0x29ba28=>{const _0x2fb6cb=_0x3794e2;_0x52ce05[_0x2fb6cb(0x1a5)](_0x29ba28[_0x2fb6cb(0x18f)],_0x29ba28[_0x2fb6cb(0x1a6)]);});const _0x166d6=_0x16de8f[_0x3794e2(0x1b8)](_0x25ecff=>{const _0x40b750=_0x3794e2;return{..._0x25ecff,'lastTime':_0x52ce05[_0x40b750(0x185)](_0x25ecff['id'])||null};});return _0x166d6;}catch(_0x49ffd1){console[_0x3794e2(0x1a9)](_0x3794e2(0x1b2),_0x49ffd1);}}async['update'](_0x42bc6d,_0x225a0){const _0x1c218a=_0x3eb7e2,{title:_0x237fb0,isSticky:_0x45a4ff,groupId:_0x4ac711,config:_0x36843c,appType:_0x1c32e2}=_0x42bc6d,{id:_0x1e1b2b}=_0x225a0[_0x1c218a(0x18c)],_0x1109b5=await this[_0x1c218a(0x195)][_0x1c218a(0x187)]({'where':{'id':_0x4ac711,'userId':_0x1e1b2b}});if(!_0x1109b5)throw new common_1[(_0x1c218a(0x186))]('对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x1c218a(0x1c3)][_0x1c218a(0x1bb)]);const _0x288af2={};_0x237fb0&&(_0x288af2['title']=_0x237fb0),typeof _0x45a4ff!==_0x1c218a(0x182)&&(_0x288af2[_0x1c218a(0x1a4)]=_0x45a4ff),_0x36843c&&(_0x288af2[_0x1c218a(0x1ba)]=_0x36843c);const _0x54af49=await this[_0x1c218a(0x195)][_0x1c218a(0x1b0)]({'id':_0x4ac711},_0x288af2);if(_0x54af49[_0x1c218a(0x1ab)])return!![];else throw new common_1[(_0x1c218a(0x186))]('更新对话失败！',common_1[_0x1c218a(0x1c3)][_0x1c218a(0x1bb)]);}async[_0x3eb7e2(0x192)](_0x65e786,_0x25e251){const _0x2fa60a=_0x3eb7e2,{groupId:_0x13ecf3}=_0x65e786,{id:_0x4f50c0}=_0x25e251[_0x2fa60a(0x18c)],_0x552f79=await this['chatGroupEntity']['findOne']({'where':{'id':_0x13ecf3,'userId':_0x4f50c0}});if(!_0x552f79)throw new common_1[(_0x2fa60a(0x186))](_0x2fa60a(0x18a),common_1['HttpStatus'][_0x2fa60a(0x1bb)]);const _0x11bfcf=await this[_0x2fa60a(0x195)][_0x2fa60a(0x1b0)]({'id':_0x13ecf3},{'isDelete':!![]});if(_0x11bfcf[_0x2fa60a(0x1ab)])return _0x2fa60a(0x19f);else throw new common_1[(_0x2fa60a(0x186))](_0x2fa60a(0x1a7),common_1['HttpStatus'][_0x2fa60a(0x1bb)]);}async[_0x3eb7e2(0x18d)](_0x1f320c){const _0x446527=_0x3eb7e2,{id:_0x3c92f7}=_0x1f320c[_0x446527(0x18c)],_0x263be6=await this[_0x446527(0x195)][_0x446527(0x1b0)]({'userId':_0x3c92f7,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x263be6[_0x446527(0x1ab)])return _0x446527(0x19f);else throw new common_1[(_0x446527(0x186))](_0x446527(0x1a7),common_1[_0x446527(0x1c3)][_0x446527(0x1bb)]);}async['getGroupInfoFromId'](_0x31463c){const _0x6191e4=_0x3eb7e2;if(!_0x31463c||_0x31463c===0x0)return null;return await this[_0x6191e4(0x195)][_0x6191e4(0x187)]({'where':{'id':_0x31463c}});}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x3eb7e2(0x198)])(chatGroup_entity_1[_0x3eb7e2(0x1a3)])),__metadata(_0x3eb7e2(0x184),[typeorm_2[_0x3eb7e2(0x18b)],models_service_1[_0x3eb7e2(0x1b3)],typeorm_2['Connection']])],ChatGroupService),exports[_0x3eb7e2(0x18e)]=ChatGroupService;