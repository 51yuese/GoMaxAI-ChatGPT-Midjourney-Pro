'use strict';const _0x3f4b93=_0x33cc;(function(_0x4c3f0f,_0x327442){const _0x3dd6fa=_0x33cc,_0x4c6ddf=_0x4c3f0f();while(!![]){try{const _0x4d9ab7=-parseInt(_0x3dd6fa(0x11d))/0x1+parseInt(_0x3dd6fa(0x135))/0x2*(parseInt(_0x3dd6fa(0x113))/0x3)+parseInt(_0x3dd6fa(0x105))/0x4*(-parseInt(_0x3dd6fa(0x10d))/0x5)+-parseInt(_0x3dd6fa(0x11a))/0x6+parseInt(_0x3dd6fa(0xe0))/0x7+-parseInt(_0x3dd6fa(0xec))/0x8+parseInt(_0x3dd6fa(0x12e))/0x9*(parseInt(_0x3dd6fa(0x13b))/0xa);if(_0x4d9ab7===_0x327442)break;else _0x4c6ddf['push'](_0x4c6ddf['shift']());}catch(_0x25d7b6){_0x4c6ddf['push'](_0x4c6ddf['shift']());}}}(_0x3633,0x4d610));var __decorate=this&&this[_0x3f4b93(0x11f)]||function(_0x21b130,_0x1e28a8,_0x259ed8,_0x292d0b){const _0x4f37c9=_0x3f4b93;var _0x4319da=arguments[_0x4f37c9(0x12a)],_0x2db541=_0x4319da<0x3?_0x1e28a8:_0x292d0b===null?_0x292d0b=Object[_0x4f37c9(0xed)](_0x1e28a8,_0x259ed8):_0x292d0b,_0x47feeb;if(typeof Reflect===_0x4f37c9(0x126)&&typeof Reflect[_0x4f37c9(0x12c)]===_0x4f37c9(0x10c))_0x2db541=Reflect[_0x4f37c9(0x12c)](_0x21b130,_0x1e28a8,_0x259ed8,_0x292d0b);else{for(var _0x7b45ad=_0x21b130['length']-0x1;_0x7b45ad>=0x0;_0x7b45ad--)if(_0x47feeb=_0x21b130[_0x7b45ad])_0x2db541=(_0x4319da<0x3?_0x47feeb(_0x2db541):_0x4319da>0x3?_0x47feeb(_0x1e28a8,_0x259ed8,_0x2db541):_0x47feeb(_0x1e28a8,_0x259ed8))||_0x2db541;}return _0x4319da>0x3&&_0x2db541&&Object[_0x4f37c9(0xfc)](_0x1e28a8,_0x259ed8,_0x2db541),_0x2db541;},__metadata=this&&this[_0x3f4b93(0x110)]||function(_0x50d806,_0x22205a){const _0x1d645e=_0x3f4b93;if(typeof Reflect===_0x1d645e(0x126)&&typeof Reflect['metadata']==='function')return Reflect['metadata'](_0x50d806,_0x22205a);},__param=this&&this[_0x3f4b93(0x115)]||function(_0x2b5b9a,_0x3635e7){return function(_0x48402f,_0x2c721d){_0x3635e7(_0x48402f,_0x2c721d,_0x2b5b9a);};};Object[_0x3f4b93(0xfc)](exports,'__esModule',{'value':!![]}),exports[_0x3f4b93(0xfd)]=void 0x0;function _0x33cc(_0xfc7caf,_0x488487){const _0x363396=_0x3633();return _0x33cc=function(_0x33ccd8,_0x35f4b4){_0x33ccd8=_0x33ccd8-0xde;let _0x1f776b=_0x363396[_0x33ccd8];return _0x1f776b;},_0x33cc(_0xfc7caf,_0x488487);}const common_1=require('@nestjs/common'),chatGroup_entity_1=require(_0x3f4b93(0x123)),typeorm_1=require(_0x3f4b93(0x133)),typeorm_2=require('typeorm'),models_service_1=require(_0x3f4b93(0xdf)),model_constant_1=require(_0x3f4b93(0xe6)),mindTask_service_1=require('../mindTask/mindTask.service'),pptTask_entity_1=require(_0x3f4b93(0xe8)),docsTask_entity_1=require(_0x3f4b93(0x10e)),ppt_constant_1=require(_0x3f4b93(0xf1)),gpts_chat_group_entity_1=require(_0x3f4b93(0x13e));function _0x3633(){const _0x3a8f8c=['4747040zdKFar','getOwnPropertyDescriptor','map','docs','更新对话失败！','../../common/constants/ppt.constant','DocsTaskEntity','create','join','InjectRepository','userId','user','MindTaskService','name','Connection','EModelType','defineProperty','ChatGroupService','affected','update','findOne','topConversation','find','DESC','error:\x20','55388LVwCnd','set','HttpStatus','connection','config','GptsChatGroupEntity','getGroupInfoFromId','function','120oAcEfq','../docsTask/entity/docsTask.entity','会话不存在！','__metadata','modelType','sort','6bQfDpj','lastTime','__param','groupId','message','docsTaskEntity','save','155958jNseBm','gptsChatGroupEntity','CHAT','33923DTfjNp','CREATE','__decorate','BAD_REQUEST','updatedAt','IsNull','./chatGroup.entity','stringify','push','object','updateLastMessage','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20(','mind','length','get','decorate','非法操作、您在删除一个非法资源！','2227023MkTUJL','query','undefined','design:paramtypes','title','@nestjs/typeorm','history','19796xgdHVH','EPPTTaskType','getTime','ppt','clear',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20\x20\x20','50sizjui','chatGroupEntity','log','../gpts/dto/gpts.chat-group.entity','clearhistory','删除失败！','mindTaskService','../models/models.service','318759eggoSY','pptTaskEntity','isSticky','删除成功','HttpException',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20','../../common/constants/model.constant','ChatGroupEntity','../chatgpt/entity/pptTask.entity','gpts','Repository','modelsService'];_0x3633=function(){return _0x3a8f8c;};return _0x3633();}let ChatGroupService=class ChatGroupService{constructor(_0x374536,_0x26f118,_0x41061c,_0x1c0394,_0x4d9ffb,_0x5b4fb4,_0x5c3e80){const _0x31a989=_0x3f4b93;this[_0x31a989(0x13c)]=_0x374536,this['modelsService']=_0x26f118,this[_0x31a989(0xde)]=_0x41061c,this[_0x31a989(0xe1)]=_0x1c0394,this[_0x31a989(0x118)]=_0x4d9ffb,this['gptsChatGroupEntity']=_0x5b4fb4,this[_0x31a989(0x108)]=_0x5c3e80;}async[_0x3f4b93(0xf3)](_0xc896d8,_0x15603c){const _0x5e4ba1=_0x3f4b93,{title:title='新对话',model:_0x161b73,modelType:modelType=model_constant_1[_0x5e4ba1(0xfb)][_0x5e4ba1(0x11c)]}=_0x15603c,_0x487995={'title':title,'modelType':modelType,'userId':_0xc896d8[_0x5e4ba1(0xf7)]['id']},_0x28e59f=await this[_0x5e4ba1(0xeb)]['getModelByType'](modelType,_0x161b73);_0x487995['config']=JSON[_0x5e4ba1(0x124)](_0x28e59f);const _0x40f079=await this['chatGroupEntity'][_0x5e4ba1(0x119)](_0x487995);return _0x40f079;}async[_0x3f4b93(0x12b)](_0x3bab3c,_0x1a16de){const _0x2a0c03=_0x3f4b93;try{const _0x1d9e70={'userId':_0x1a16de[_0x2a0c03(0xf7)]['id'],'id':_0x3bab3c,'isDelete':![]},_0x27759b=await this[_0x2a0c03(0x13c)][_0x2a0c03(0x100)]({'where':_0x1d9e70});return _0x27759b;}catch(_0x3a8fa9){console[_0x2a0c03(0x13d)](_0x2a0c03(0x104),_0x3a8fa9);}}async[_0x3f4b93(0x127)](_0x18e591,_0x28dfc9,_0x4f47fc,_0x33c956){const _0x345355=_0x3f4b93;console['log']('updateLastMessage:\x20',_0x18e591,_0x28dfc9,_0x4f47fc,_0x33c956);if(_0x18e591==_0x345355(0xe9))this[_0x345355(0x11b)][_0x345355(0xff)]({'id':_0x28dfc9},{'lastMessage':_0x33c956,'updatedAt':new Date()});else{const _0x4396fa=this['get'](_0x28dfc9,_0x4f47fc);_0x4396fa&&await this[_0x345355(0x13c)][_0x345355(0xff)]({'id':_0x28dfc9},{'lastMessage':_0x33c956,'updatedAt':new Date()});}}async[_0x3f4b93(0x12f)](_0x488aa5,_0x212265){const _0x1bb93c=_0x3f4b93;try{const {id:_0x1339fd}=_0x212265[_0x1bb93c(0xf7)],_0x287213={'userId':_0x1339fd,'isDelete':![]};_0x488aa5?_0x287213[_0x1bb93c(0x111)]=_0x488aa5:_0x287213[_0x1bb93c(0x111)]=(0x0,typeorm_2[_0x1bb93c(0x122)])();const _0x472b78=await this['chatGroupEntity'][_0x1bb93c(0x102)]({'where':_0x287213,'order':{'isSticky':_0x1bb93c(0x103),'updatedAt':_0x1bb93c(0x103),'id':_0x1bb93c(0x103)}});if(!_0x472b78[_0x1bb93c(0x12a)])return _0x472b78;const _0x4e1c70=_0x472b78[_0x1bb93c(0xee)](_0x49a969=>_0x49a969['id']),_0x18ceec=await this[_0x1bb93c(0x108)]['query'](_0x1bb93c(0x128)+_0x4e1c70[_0x1bb93c(0xf4)]()+_0x1bb93c(0xe5)),_0x23f21f=new Map();_0x18ceec['forEach'](_0x5b7199=>{const _0x3870ec=_0x1bb93c;_0x23f21f[_0x3870ec(0x106)](_0x5b7199[_0x3870ec(0x116)],_0x5b7199['lastTime']);});const _0x63e00d=_0x472b78['map'](_0x3cb823=>{const _0x1d8d2b=_0x1bb93c;return{..._0x3cb823,'lastTime':_0x23f21f[_0x1d8d2b(0x12b)](_0x3cb823['id'])||null};});return _0x63e00d;}catch(_0x50d3d9){console[_0x1bb93c(0x13d)](_0x1bb93c(0x104),_0x50d3d9);}}async[_0x3f4b93(0xff)](_0x5954f4,_0x3dddd5){const _0x5eda20=_0x3f4b93,{title:_0x411369,isSticky:_0x1f26b6,groupId:_0x5abf52,config:_0xef8d91,appType:_0xd808f3}=_0x5954f4,{id:_0x5bb76f}=_0x3dddd5[_0x5eda20(0xf7)],_0x3c1595=await this['chatGroupEntity']['findOne']({'where':{'id':_0x5abf52,'userId':_0x5bb76f}});if(!_0x3c1595)throw new common_1[(_0x5eda20(0xe4))]('对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x5eda20(0x107)][_0x5eda20(0x120)]);const _0x3a7eca={};_0x411369&&(_0x3a7eca[_0x5eda20(0x132)]=_0x411369),typeof _0x1f26b6!==_0x5eda20(0x130)&&(_0x3a7eca[_0x5eda20(0xe2)]=_0x1f26b6),_0xef8d91&&(_0x3a7eca[_0x5eda20(0x109)]=_0xef8d91);const _0x204ae5=await this[_0x5eda20(0x13c)][_0x5eda20(0xff)]({'id':_0x5abf52},_0x3a7eca);if(_0x204ae5[_0x5eda20(0xfe)])return!![];else throw new common_1[(_0x5eda20(0xe4))](_0x5eda20(0xf0),common_1[_0x5eda20(0x107)][_0x5eda20(0x120)]);}async['del'](_0x592bac,_0x4132a7){const _0x2e74a9=_0x3f4b93,{groupId:_0x404a42}=_0x592bac,{id:_0x16cc14}=_0x4132a7['user'],_0x6a6478=await this[_0x2e74a9(0x13c)][_0x2e74a9(0x100)]({'where':{'id':_0x404a42,'userId':_0x16cc14}});if(!_0x6a6478)throw new common_1['HttpException'](_0x2e74a9(0x12d),common_1[_0x2e74a9(0x107)][_0x2e74a9(0x120)]);const _0x5ab903=await this[_0x2e74a9(0x13c)][_0x2e74a9(0xff)]({'id':_0x404a42},{'isDelete':!![]});if(_0x5ab903[_0x2e74a9(0xfe)])return _0x2e74a9(0xe3);else throw new common_1[(_0x2e74a9(0xe4))](_0x2e74a9(0x140),common_1[_0x2e74a9(0x107)]['BAD_REQUEST']);}async['delAll'](_0x3b6402){const _0x2b69d7=_0x3f4b93,{id:_0x44efb4}=_0x3b6402[_0x2b69d7(0xf7)],_0x44c5fc=await this[_0x2b69d7(0x13c)][_0x2b69d7(0xff)]({'userId':_0x44efb4,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x44c5fc[_0x2b69d7(0xfe)])return _0x2b69d7(0xe3);else throw new common_1[(_0x2b69d7(0xe4))](_0x2b69d7(0x140),common_1[_0x2b69d7(0x107)][_0x2b69d7(0x120)]);}async[_0x3f4b93(0x10b)](_0x592f56){const _0x2b83c2=_0x3f4b93;if(!_0x592f56||_0x592f56===0x0)return null;return await this[_0x2b83c2(0x13c)]['findOne']({'where':{'id':_0x592f56}});}async[_0x3f4b93(0x134)](_0xf5697e,_0xe0edd1){const _0x57746a=_0x3f4b93;try{const {id:_0x1c50ec}=_0xe0edd1[_0x57746a(0xf7)],_0x5f3d33={'userId':_0x1c50ec,'isDelete':![]};_0xf5697e?_0x5f3d33[_0x57746a(0x111)]=(0x0,typeorm_2['In'])(_0xf5697e):_0x5f3d33[_0x57746a(0x111)]=(0x0,typeorm_2[_0x57746a(0x122)])();let _0x39596b=[];const _0x212802=await this['chatGroupEntity'][_0x57746a(0x102)]({'where':_0x5f3d33,'order':{'isSticky':_0x57746a(0x103),'id':_0x57746a(0x103)}});if(_0x212802[_0x57746a(0x12a)]){const _0x3ec93e=_0x212802[_0x57746a(0xee)](_0x5a19dc=>_0x5a19dc['id']),_0x5a3c84=await this['connection'][_0x57746a(0x12f)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20('+_0x3ec93e[_0x57746a(0xf4)]()+_0x57746a(0x13a)),_0x2c3250=new Map();_0x5a3c84['forEach'](_0x5eb391=>{const _0x5aa3ab=_0x57746a;_0x2c3250[_0x5aa3ab(0x106)](_0x5eb391[_0x5aa3ab(0x116)],_0x5eb391[_0x5aa3ab(0x114)]);}),_0x39596b=_0x212802['map'](_0x1cecf6=>{return{..._0x1cecf6,'lastTime':_0x2c3250['get'](_0x1cecf6['id'])||null};});}const _0x590ea6=await this['mindTaskService']['getList'](_0xe0edd1),_0x1aa9c9=await this['pptTaskEntity']['find']({'where':{'userId':_0xe0edd1[_0x57746a(0xf7)]['id'],'type':ppt_constant_1[_0x57746a(0x136)][_0x57746a(0x11e)],'delFlag':0x0},'order':{'updatedAt':_0x57746a(0x103)}}),_0x388b24=await this['docsTaskEntity'][_0x57746a(0x102)]({'where':{'userId':_0xe0edd1[_0x57746a(0xf7)]['id'],'deleteFlag':0x0},'order':{'updatedAt':_0x57746a(0x103)}});return _0x39596b[_0x57746a(0x125)](..._0x590ea6[_0x57746a(0xee)](_0x3cb24d=>{const _0x1e97d5=_0x57746a;return{'modelType':_0x1e97d5(0x129),'id':_0x3cb24d['id'],'title':_0x3cb24d[_0x1e97d5(0xf9)]||_0x3cb24d['prompt'],'lastTime':_0x3cb24d[_0x1e97d5(0x121)],'userId':_0x3cb24d['userId'],'updatedAt':_0x3cb24d['updatedAt']};})),_0x39596b[_0x57746a(0x125)](..._0x1aa9c9[_0x57746a(0xee)](_0x5f08fb=>{const _0x50fc49=_0x57746a;return{'modelType':_0x50fc49(0x138),'id':_0x5f08fb['id'],'title':_0x5f08fb['title'],'lastTime':_0x5f08fb[_0x50fc49(0x121)],'userId':_0x5f08fb[_0x50fc49(0xf6)],'updatedAt':_0x5f08fb[_0x50fc49(0x121)]};})),_0x39596b['push'](..._0x388b24[_0x57746a(0xee)](_0x33b61d=>{const _0x52dc1c=_0x57746a;return{'modelType':_0x52dc1c(0xef),'id':_0x33b61d['id'],'title':_0x33b61d['name'],'lastTime':_0x33b61d[_0x52dc1c(0x121)],'userId':_0x33b61d[_0x52dc1c(0xf6)],'updatedAt':_0x33b61d[_0x52dc1c(0x121)]};})),_0x39596b[_0x57746a(0x112)]((_0x104cfc,_0x3f1df5)=>{const _0x2acd8c=_0x57746a,_0x19775d=new Date(_0x104cfc[_0x2acd8c(0x121)])['getTime'](),_0x23f785=new Date(_0x3f1df5[_0x2acd8c(0x121)])[_0x2acd8c(0x137)]();return _0x23f785-_0x19775d;}),_0x39596b;}catch(_0x397699){console['log'](_0x57746a(0x104),_0x397699);}}async[_0x3f4b93(0x13f)](_0x1b2405,_0x3c2326){const _0x276d92=_0x3f4b93;try{await this['chatGroupEntity'][_0x276d92(0xff)]({'userId':_0x3c2326[_0x276d92(0xf7)]['id'],'isDelete':![],'modelType':(0x0,typeorm_2['In'])(_0x1b2405)},{'isDelete':!![]}),await this[_0x276d92(0xde)][_0x276d92(0x139)](_0x3c2326),await this[_0x276d92(0xe1)][_0x276d92(0xff)]({'userId':_0x3c2326[_0x276d92(0xf7)]['id'],'type':ppt_constant_1['EPPTTaskType']['CREATE']},{'delFlag':0x1}),await this['docsTaskEntity'][_0x276d92(0xff)]({'userId':_0x3c2326[_0x276d92(0xf7)]['id']},{'deleteFlag':0x1});}catch(_0x3daa06){console[_0x276d92(0x13d)](_0x276d92(0x104),_0x3daa06);}}async[_0x3f4b93(0x101)](_0x43acc4,_0x58c4fd,_0x348c8f){const _0xebe7bb=_0x3f4b93;try{const _0x2954b3=await this[_0xebe7bb(0x13c)][_0xebe7bb(0x100)]({'where':{'id':_0x43acc4,'userId':_0x348c8f[_0xebe7bb(0xf7)]['id']}});if(!_0x2954b3)throw new Error(_0xebe7bb(0x10f));_0x2954b3[_0xebe7bb(0xe2)]=_0x58c4fd==0x1,await this[_0xebe7bb(0x13c)]['save'](_0x2954b3);}catch(_0x3f2c9b){return _0x3f2c9b[_0xebe7bb(0x117)];}}};ChatGroupService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1[_0x3f4b93(0xe7)])),__param(0x3,(0x0,typeorm_1[_0x3f4b93(0xf5)])(pptTask_entity_1['PPTTaskEntity'])),__param(0x4,(0x0,typeorm_1[_0x3f4b93(0xf5)])(docsTask_entity_1[_0x3f4b93(0xf2)])),__param(0x5,(0x0,typeorm_1[_0x3f4b93(0xf5)])(gpts_chat_group_entity_1[_0x3f4b93(0x10a)])),__metadata(_0x3f4b93(0x131),[typeorm_2['Repository'],models_service_1['ModelsService'],mindTask_service_1[_0x3f4b93(0xf8)],typeorm_2[_0x3f4b93(0xea)],typeorm_2['Repository'],typeorm_2[_0x3f4b93(0xea)],typeorm_2[_0x3f4b93(0xfa)]])],ChatGroupService),exports['ChatGroupService']=ChatGroupService;