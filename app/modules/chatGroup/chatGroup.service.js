'use strict';const _0x5d0e37=_0x30dd;function _0x30dd(_0x5b8375,_0x2cb88b){const _0x362b48=_0x362b();return _0x30dd=function(_0x30ddda,_0x5ef0d8){_0x30ddda=_0x30ddda-0xff;let _0x4ef4cd=_0x362b48[_0x30ddda];return _0x4ef4cd;},_0x30dd(_0x5b8375,_0x2cb88b);}(function(_0x24c33f,_0x5d9026){const _0x3de990=_0x30dd,_0x4073fa=_0x24c33f();while(!![]){try{const _0x27c985=-parseInt(_0x3de990(0x111))/0x1+-parseInt(_0x3de990(0x13c))/0x2*(-parseInt(_0x3de990(0x10c))/0x3)+-parseInt(_0x3de990(0x10a))/0x4+parseInt(_0x3de990(0x106))/0x5*(parseInt(_0x3de990(0x13b))/0x6)+-parseInt(_0x3de990(0x14f))/0x7+-parseInt(_0x3de990(0x12a))/0x8+parseInt(_0x3de990(0x11f))/0x9;if(_0x27c985===_0x5d9026)break;else _0x4073fa['push'](_0x4073fa['shift']());}catch(_0x23c470){_0x4073fa['push'](_0x4073fa['shift']());}}}(_0x362b,0x80800));function _0x362b(){const _0x48f062=['modelType','pptTaskEntity','typeorm','map',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20','CREATE','HttpStatus','@nestjs/common','get','Connection','log','name','findOne','config','6764548fAhWRU','userId','set','title','EPPTTaskType','push','更新对话失败！','删除失败！','../../common/constants/model.constant','__esModule','create','update','join',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20\x20\x20','find','1314015ogXIwG','del','length','MindTaskService','2104796znghNB','modelsService','3783yvwnFh','Repository','error:\x20','../../common/constants/ppt.constant','groupId','896259EolHig','isSticky','DocsTaskEntity','function','../mindTask/mindTask.service','非法操作、您在删除一个非法资源！','InjectRepository','prompt','connection','design:paramtypes','decorate','mind','chatGroupEntity','sort','19317573txSaUp','save','getOwnPropertyDescriptor','新对话','../models/models.service','Injectable','metadata','BAD_REQUEST','docsTaskEntity','lastTime','defineProperty','1480560kgOSUQ','user','query','getModelByType','mindTaskService','__decorate','HttpException','getGroupInfoFromId','删除成功','object','stringify','getTime','getList','undefined','affected','clear','ChatGroupEntity','6OnnPHt','1096poXAlu','DESC','__metadata','updatedAt','forEach'];_0x362b=function(){return _0x48f062;};return _0x362b();}var __decorate=this&&this[_0x5d0e37(0x12f)]||function(_0x28dc4f,_0x260ea4,_0x4489d8,_0x113200){const _0x351068=_0x5d0e37;var _0x422df1=arguments[_0x351068(0x108)],_0x52315d=_0x422df1<0x3?_0x260ea4:_0x113200===null?_0x113200=Object[_0x351068(0x121)](_0x260ea4,_0x4489d8):_0x113200,_0x390f54;if(typeof Reflect===_0x351068(0x133)&&typeof Reflect[_0x351068(0x11b)]===_0x351068(0x114))_0x52315d=Reflect[_0x351068(0x11b)](_0x28dc4f,_0x260ea4,_0x4489d8,_0x113200);else{for(var _0x11dc3a=_0x28dc4f[_0x351068(0x108)]-0x1;_0x11dc3a>=0x0;_0x11dc3a--)if(_0x390f54=_0x28dc4f[_0x11dc3a])_0x52315d=(_0x422df1<0x3?_0x390f54(_0x52315d):_0x422df1>0x3?_0x390f54(_0x260ea4,_0x4489d8,_0x52315d):_0x390f54(_0x260ea4,_0x4489d8))||_0x52315d;}return _0x422df1>0x3&&_0x52315d&&Object[_0x351068(0x129)](_0x260ea4,_0x4489d8,_0x52315d),_0x52315d;},__metadata=this&&this[_0x5d0e37(0x13e)]||function(_0x8c45ef,_0x299c8d){const _0x5105a7=_0x5d0e37;if(typeof Reflect===_0x5105a7(0x133)&&typeof Reflect['metadata']==='function')return Reflect[_0x5105a7(0x125)](_0x8c45ef,_0x299c8d);},__param=this&&this['__param']||function(_0x16f122,_0x4aa2f0){return function(_0x5e4d73,_0x2e7e6b){_0x4aa2f0(_0x5e4d73,_0x2e7e6b,_0x16f122);};};Object['defineProperty'](exports,_0x5d0e37(0x100),{'value':!![]}),exports['ChatGroupService']=void 0x0;const common_1=require(_0x5d0e37(0x148)),chatGroup_entity_1=require('./chatGroup.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x5d0e37(0x143)),models_service_1=require(_0x5d0e37(0x123)),model_constant_1=require(_0x5d0e37(0xff)),mindTask_service_1=require(_0x5d0e37(0x115)),pptTask_entity_1=require('../chatgpt/entity/pptTask.entity'),docsTask_entity_1=require('../docsTask/entity/docsTask.entity'),ppt_constant_1=require(_0x5d0e37(0x10f));let ChatGroupService=class ChatGroupService{constructor(_0x236e0c,_0x4157db,_0x4d27a3,_0x1d8546,_0x44a200,_0x21d5f8){const _0x352d60=_0x5d0e37;this[_0x352d60(0x11d)]=_0x236e0c,this[_0x352d60(0x10b)]=_0x4157db,this['mindTaskService']=_0x4d27a3,this[_0x352d60(0x142)]=_0x1d8546,this[_0x352d60(0x127)]=_0x44a200,this['connection']=_0x21d5f8;}async[_0x5d0e37(0x101)](_0x417166,_0x4c6415){const _0xcc64f2=_0x5d0e37,{title:title=_0xcc64f2(0x122),model:_0x2d64d9,modelType:modelType=model_constant_1['EModelType']['CHAT']}=_0x4c6415,_0x36fbbd={'title':title,'modelType':modelType,'userId':_0x417166[_0xcc64f2(0x12b)]['id']},_0x4f8f86=await this[_0xcc64f2(0x10b)][_0xcc64f2(0x12d)](modelType,_0x2d64d9);_0x36fbbd[_0xcc64f2(0x14e)]=JSON[_0xcc64f2(0x134)](_0x4f8f86);const _0x385dad=await this[_0xcc64f2(0x11d)][_0xcc64f2(0x120)](_0x36fbbd);return _0x385dad;}async[_0x5d0e37(0x149)](_0x1fc6d0,_0x35acc3){const _0x665574=_0x5d0e37;try{const _0x339c41={'userId':_0x35acc3['user']['id'],'id':_0x1fc6d0,'isDelete':![]},_0xd2034a=await this[_0x665574(0x11d)][_0x665574(0x14d)]({'where':_0x339c41});return _0xd2034a;}catch(_0x5db28a){console[_0x665574(0x14b)](_0x665574(0x10e),_0x5db28a);}}async[_0x5d0e37(0x12c)](_0x24775d,_0xd811d3){const _0x1d3ddc=_0x5d0e37;try{const {id:_0x3cebba}=_0xd811d3[_0x1d3ddc(0x12b)],_0x4f470c={'userId':_0x3cebba,'isDelete':![]};_0x24775d?_0x4f470c[_0x1d3ddc(0x141)]=_0x24775d:_0x4f470c[_0x1d3ddc(0x141)]=(0x0,typeorm_2['IsNull'])();const _0x36f3d9=await this[_0x1d3ddc(0x11d)][_0x1d3ddc(0x105)]({'where':_0x4f470c,'order':{'isSticky':_0x1d3ddc(0x13d),'id':'DESC'}});if(!_0x36f3d9[_0x1d3ddc(0x108)])return _0x36f3d9;const _0x1927a9=_0x36f3d9[_0x1d3ddc(0x144)](_0x4fc51e=>_0x4fc51e['id']),_0x13824f=await this[_0x1d3ddc(0x119)]['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20('+_0x1927a9['join']()+_0x1d3ddc(0x145)),_0x195ccb=new Map();_0x13824f['forEach'](_0x2c1dbf=>{const _0x23f469=_0x1d3ddc;_0x195ccb['set'](_0x2c1dbf[_0x23f469(0x110)],_0x2c1dbf[_0x23f469(0x128)]);});const _0x4d9900=_0x36f3d9[_0x1d3ddc(0x144)](_0x3a3e38=>{return{..._0x3a3e38,'lastTime':_0x195ccb['get'](_0x3a3e38['id'])||null};});return _0x4d9900;}catch(_0x5c6d8c){console[_0x1d3ddc(0x14b)](_0x1d3ddc(0x10e),_0x5c6d8c);}}async['update'](_0x4780c5,_0x1c0bee){const _0x348e3b=_0x5d0e37,{title:_0x9b176b,isSticky:_0xd4961a,groupId:_0xb9bf5a,config:_0x53867e,appType:_0x287843}=_0x4780c5,{id:_0x120798}=_0x1c0bee['user'],_0x27b74f=await this[_0x348e3b(0x11d)][_0x348e3b(0x14d)]({'where':{'id':_0xb9bf5a,'userId':_0x120798}});if(!_0x27b74f)throw new common_1[(_0x348e3b(0x130))]('对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x348e3b(0x147)]['BAD_REQUEST']);const _0x12f0c7={};_0x9b176b&&(_0x12f0c7[_0x348e3b(0x152)]=_0x9b176b),typeof _0xd4961a!==_0x348e3b(0x137)&&(_0x12f0c7[_0x348e3b(0x112)]=_0xd4961a),_0x53867e&&(_0x12f0c7[_0x348e3b(0x14e)]=_0x53867e);const _0x2892f1=await this['chatGroupEntity'][_0x348e3b(0x102)]({'id':_0xb9bf5a},_0x12f0c7);if(_0x2892f1[_0x348e3b(0x138)])return!![];else throw new common_1[(_0x348e3b(0x130))](_0x348e3b(0x155),common_1[_0x348e3b(0x147)][_0x348e3b(0x126)]);}async[_0x5d0e37(0x107)](_0x1237a1,_0x19c01f){const _0x4da1e3=_0x5d0e37,{groupId:_0x470775}=_0x1237a1,{id:_0x577fa9}=_0x19c01f[_0x4da1e3(0x12b)],_0x3691f3=await this[_0x4da1e3(0x11d)][_0x4da1e3(0x14d)]({'where':{'id':_0x470775,'userId':_0x577fa9}});if(!_0x3691f3)throw new common_1[(_0x4da1e3(0x130))](_0x4da1e3(0x116),common_1['HttpStatus'][_0x4da1e3(0x126)]);const _0x24e00e=await this[_0x4da1e3(0x11d)][_0x4da1e3(0x102)]({'id':_0x470775},{'isDelete':!![]});if(_0x24e00e['affected'])return _0x4da1e3(0x132);else throw new common_1[(_0x4da1e3(0x130))](_0x4da1e3(0x156),common_1[_0x4da1e3(0x147)][_0x4da1e3(0x126)]);}async['delAll'](_0x2339c3){const _0x554ab5=_0x5d0e37,{id:_0x3610d5}=_0x2339c3[_0x554ab5(0x12b)],_0x292ed0=await this[_0x554ab5(0x11d)]['update']({'userId':_0x3610d5,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x292ed0[_0x554ab5(0x138)])return _0x554ab5(0x132);else throw new common_1[(_0x554ab5(0x130))](_0x554ab5(0x156),common_1[_0x554ab5(0x147)][_0x554ab5(0x126)]);}async[_0x5d0e37(0x131)](_0x171584){const _0x3b33ee=_0x5d0e37;if(!_0x171584||_0x171584===0x0)return null;return await this[_0x3b33ee(0x11d)]['findOne']({'where':{'id':_0x171584}});}async['history'](_0x11ad78,_0x399990){const _0x45c2fc=_0x5d0e37;try{const {id:_0x4b1471}=_0x399990['user'],_0x3db24e={'userId':_0x4b1471,'isDelete':![]};_0x11ad78?_0x3db24e[_0x45c2fc(0x141)]=(0x0,typeorm_2['In'])(_0x11ad78):_0x3db24e[_0x45c2fc(0x141)]=(0x0,typeorm_2['IsNull'])();let _0x38ef75=[];const _0x4a29d3=await this[_0x45c2fc(0x11d)][_0x45c2fc(0x105)]({'where':_0x3db24e,'order':{'isSticky':_0x45c2fc(0x13d),'id':_0x45c2fc(0x13d)}});if(_0x4a29d3['length']){const _0x3d0efd=_0x4a29d3[_0x45c2fc(0x144)](_0x1339f7=>_0x1339f7['id']),_0x4f6f50=await this[_0x45c2fc(0x119)][_0x45c2fc(0x12c)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20('+_0x3d0efd[_0x45c2fc(0x103)]()+_0x45c2fc(0x104)),_0x354c95=new Map();_0x4f6f50[_0x45c2fc(0x140)](_0x257a8b=>{const _0x286208=_0x45c2fc;_0x354c95[_0x286208(0x151)](_0x257a8b[_0x286208(0x110)],_0x257a8b['lastTime']);}),_0x38ef75=_0x4a29d3[_0x45c2fc(0x144)](_0x458772=>{return{..._0x458772,'lastTime':_0x354c95['get'](_0x458772['id'])||null};});}const _0x193b3b=await this[_0x45c2fc(0x12e)][_0x45c2fc(0x136)](_0x399990),_0x1c9a1a=await this[_0x45c2fc(0x142)][_0x45c2fc(0x105)]({'where':{'userId':_0x399990[_0x45c2fc(0x12b)]['id'],'type':ppt_constant_1[_0x45c2fc(0x153)][_0x45c2fc(0x146)],'delFlag':0x0},'order':{'updatedAt':'DESC'}}),_0x32cc84=await this[_0x45c2fc(0x127)]['find']({'where':{'userId':_0x399990[_0x45c2fc(0x12b)]['id'],'deleteFlag':0x0},'order':{'updatedAt':_0x45c2fc(0x13d)}});return _0x38ef75[_0x45c2fc(0x154)](..._0x193b3b[_0x45c2fc(0x144)](_0x1eef84=>{const _0x315ef9=_0x45c2fc;return{'modelType':_0x315ef9(0x11c),'id':_0x1eef84['id'],'title':_0x1eef84[_0x315ef9(0x14c)]||_0x1eef84[_0x315ef9(0x118)],'lastTime':_0x1eef84[_0x315ef9(0x13f)],'userId':_0x1eef84[_0x315ef9(0x150)],'updatedAt':_0x1eef84[_0x315ef9(0x13f)]};})),_0x38ef75[_0x45c2fc(0x154)](..._0x1c9a1a[_0x45c2fc(0x144)](_0x10463f=>{const _0x278fa0=_0x45c2fc;return{'modelType':'ppt','id':_0x10463f['id'],'title':_0x10463f[_0x278fa0(0x152)],'lastTime':_0x10463f[_0x278fa0(0x13f)],'userId':_0x10463f[_0x278fa0(0x150)],'updatedAt':_0x10463f[_0x278fa0(0x13f)]};})),_0x38ef75[_0x45c2fc(0x154)](..._0x32cc84[_0x45c2fc(0x144)](_0x5c4ed1=>{const _0x195024=_0x45c2fc;return{'modelType':'docs','id':_0x5c4ed1['id'],'title':_0x5c4ed1[_0x195024(0x14c)],'lastTime':_0x5c4ed1['updatedAt'],'userId':_0x5c4ed1['userId'],'updatedAt':_0x5c4ed1[_0x195024(0x13f)]};})),_0x38ef75[_0x45c2fc(0x11e)]((_0x7e6b16,_0x416a43)=>{const _0x2abd15=_0x45c2fc,_0x1c23ab=new Date(_0x7e6b16[_0x2abd15(0x13f)])[_0x2abd15(0x135)](),_0x2384b9=new Date(_0x416a43['updatedAt'])['getTime']();return _0x2384b9-_0x1c23ab;}),_0x38ef75;}catch(_0x2bbd93){console[_0x45c2fc(0x14b)](_0x45c2fc(0x10e),_0x2bbd93);}}async['clearhistory'](_0x5853d8,_0x5c0343){const _0x2ebc15=_0x5d0e37;try{await this[_0x2ebc15(0x11d)][_0x2ebc15(0x102)]({'userId':_0x5c0343[_0x2ebc15(0x12b)]['id'],'isDelete':![],'modelType':(0x0,typeorm_2['In'])(_0x5853d8)},{'isDelete':!![]}),await this[_0x2ebc15(0x12e)][_0x2ebc15(0x139)](_0x5c0343),await this[_0x2ebc15(0x142)]['update']({'userId':_0x5c0343[_0x2ebc15(0x12b)]['id'],'type':ppt_constant_1['EPPTTaskType']['CREATE']},{'delFlag':0x1}),await this[_0x2ebc15(0x127)][_0x2ebc15(0x102)]({'userId':_0x5c0343[_0x2ebc15(0x12b)]['id']},{'deleteFlag':0x1});}catch(_0x48df43){console[_0x2ebc15(0x14b)]('error:\x20',_0x48df43);}}async['topConversation'](_0x3de76f,_0x56e99b,_0x4548b2){const _0x1ad103=_0x5d0e37;try{const _0x17c49f=await this[_0x1ad103(0x11d)][_0x1ad103(0x14d)]({'where':{'id':_0x3de76f,'userId':_0x4548b2[_0x1ad103(0x12b)]['id']}});if(!_0x17c49f)throw new Error('会话不存在！');_0x17c49f[_0x1ad103(0x112)]=_0x56e99b==0x1,await this[_0x1ad103(0x11d)][_0x1ad103(0x120)](_0x17c49f);}catch(_0x1a7626){return _0x1a7626['message'];}}};ChatGroupService=__decorate([(0x0,common_1[_0x5d0e37(0x124)])(),__param(0x0,(0x0,typeorm_1[_0x5d0e37(0x117)])(chatGroup_entity_1[_0x5d0e37(0x13a)])),__param(0x3,(0x0,typeorm_1[_0x5d0e37(0x117)])(pptTask_entity_1['PPTTaskEntity'])),__param(0x4,(0x0,typeorm_1[_0x5d0e37(0x117)])(docsTask_entity_1[_0x5d0e37(0x113)])),__metadata(_0x5d0e37(0x11a),[typeorm_2[_0x5d0e37(0x10d)],models_service_1['ModelsService'],mindTask_service_1[_0x5d0e37(0x109)],typeorm_2[_0x5d0e37(0x10d)],typeorm_2[_0x5d0e37(0x10d)],typeorm_2[_0x5d0e37(0x14a)]])],ChatGroupService),exports['ChatGroupService']=ChatGroupService;