'use strict';const _0x2d9b4a=_0x5616;(function(_0x43236e,_0x3ab280){const _0xe36a00=_0x5616,_0x5061fc=_0x43236e();while(!![]){try{const _0x2428cd=-parseInt(_0xe36a00(0x178))/0x1*(-parseInt(_0xe36a00(0x1c7))/0x2)+-parseInt(_0xe36a00(0x1b5))/0x3*(parseInt(_0xe36a00(0x1c9))/0x4)+parseInt(_0xe36a00(0x171))/0x5+parseInt(_0xe36a00(0x1a8))/0x6+-parseInt(_0xe36a00(0x1ce))/0x7+parseInt(_0xe36a00(0x1a1))/0x8*(-parseInt(_0xe36a00(0x1a5))/0x9)+parseInt(_0xe36a00(0x17c))/0xa*(-parseInt(_0xe36a00(0x199))/0xb);if(_0x2428cd===_0x3ab280)break;else _0x5061fc['push'](_0x5061fc['shift']());}catch(_0x4c1aab){_0x5061fc['push'](_0x5061fc['shift']());}}}(_0x4c3e,0xd5961));function _0x4c3e(){const _0xaf152b=['../docsTask/entity/docsTask.entity','InjectRepository','metadata','对话组编号和用户编号不匹配，请登录之后创建新的对话！','../gpts/dto/gpts.chat-group.entity','删除失败！','@nestjs/common','非法操作、您在删除一个非法资源！','clearhistory','function','2545490WDqeez','modelsService','8yEuUxe','defineProperty','updateLastMessage',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20\x20\x20','connection','1341179LVOWLV','BAD_REQUEST','Connection','userId','join','query','del','length','7010625jWGsyt','__decorate','../../common/constants/model.constant','DocsTaskEntity','ModelsService','EModelType','clear','1jdksQp','MindTaskService','message','chatGroupEntity','57490UXHSxu','mindTaskService','config','forEach','../chatgpt/entity/pptTask.entity','../models/models.service','Repository','updateLastMessage:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20(','../../common/constants/ppt.constant','object','IsNull','docsTaskEntity','GptsChatGroupEntity','push','gpts','set','EPPTTaskType','CHAT','update','user','getList','find','gptsChatGroupEntity','ppt','HttpStatus','HttpException','__metadata','delAll','3531uxnwAU','name','pptTaskEntity','design:paramtypes','prompt','affected','isSticky','ChatGroupService','345064xkcMRD','DESC','Injectable','updatedAt','9fbOawK','map',')\x20GROUP\x20BY\x20groupId\x0a\x20\x20\x20\x20\x20\x20','4798212pIvSQu','get','history','error:\x20','CREATE','docs','getModelByType','undefined','PPTTaskEntity','lastTime','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20groupId,\x20MAX(createdAt)\x20AS\x20lastTime\x20\x20FROM\x20chatlog\x20WHERE\x20groupId\x20IN\x20(','__param','topConversation','779346YiamHP','modelType','log','groupId','save','getTime','删除成功','findOne'];_0x4c3e=function(){return _0xaf152b;};return _0x4c3e();}var __decorate=this&&this[_0x2d9b4a(0x172)]||function(_0x4b7a97,_0x2e322d,_0x12abe6,_0x32fabb){const _0x344e2d=_0x2d9b4a;var _0x1328b9=arguments[_0x344e2d(0x170)],_0x4de73c=_0x1328b9<0x3?_0x2e322d:_0x32fabb===null?_0x32fabb=Object['getOwnPropertyDescriptor'](_0x2e322d,_0x12abe6):_0x32fabb,_0x3e42de;if(typeof Reflect===_0x344e2d(0x186)&&typeof Reflect['decorate']===_0x344e2d(0x1c6))_0x4de73c=Reflect['decorate'](_0x4b7a97,_0x2e322d,_0x12abe6,_0x32fabb);else{for(var _0x4973f1=_0x4b7a97[_0x344e2d(0x170)]-0x1;_0x4973f1>=0x0;_0x4973f1--)if(_0x3e42de=_0x4b7a97[_0x4973f1])_0x4de73c=(_0x1328b9<0x3?_0x3e42de(_0x4de73c):_0x1328b9>0x3?_0x3e42de(_0x2e322d,_0x12abe6,_0x4de73c):_0x3e42de(_0x2e322d,_0x12abe6))||_0x4de73c;}return _0x1328b9>0x3&&_0x4de73c&&Object[_0x344e2d(0x1ca)](_0x2e322d,_0x12abe6,_0x4de73c),_0x4de73c;},__metadata=this&&this[_0x2d9b4a(0x197)]||function(_0x12e834,_0x11e03f){const _0x868acb=_0x2d9b4a;if(typeof Reflect===_0x868acb(0x186)&&typeof Reflect['metadata']==='function')return Reflect[_0x868acb(0x1bf)](_0x12e834,_0x11e03f);},__param=this&&this[_0x2d9b4a(0x1b3)]||function(_0x3230c7,_0x278a99){return function(_0x1328eb,_0x185b6f){_0x278a99(_0x1328eb,_0x185b6f,_0x3230c7);};};Object[_0x2d9b4a(0x1ca)](exports,'__esModule',{'value':!![]}),exports['ChatGroupService']=void 0x0;const common_1=require(_0x2d9b4a(0x1c3)),chatGroup_entity_1=require('./chatGroup.entity'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),models_service_1=require(_0x2d9b4a(0x181)),model_constant_1=require(_0x2d9b4a(0x173)),mindTask_service_1=require('../mindTask/mindTask.service'),pptTask_entity_1=require(_0x2d9b4a(0x180)),docsTask_entity_1=require(_0x2d9b4a(0x1bd)),ppt_constant_1=require(_0x2d9b4a(0x185)),gpts_chat_group_entity_1=require(_0x2d9b4a(0x1c1));let ChatGroupService=class ChatGroupService{constructor(_0x37e527,_0x5a6b80,_0x47e9f2,_0x504864,_0x55305c,_0x560e08,_0x50175e){const _0x271ff8=_0x2d9b4a;this[_0x271ff8(0x17b)]=_0x37e527,this[_0x271ff8(0x1c8)]=_0x5a6b80,this[_0x271ff8(0x17d)]=_0x47e9f2,this[_0x271ff8(0x19b)]=_0x504864,this['docsTaskEntity']=_0x55305c,this[_0x271ff8(0x193)]=_0x560e08,this[_0x271ff8(0x1cd)]=_0x50175e;}async['create'](_0x408676,_0x2f8306){const _0x2a0408=_0x2d9b4a,{title:title='新对话',model:_0x43909b,modelType:modelType=model_constant_1[_0x2a0408(0x176)][_0x2a0408(0x18e)]}=_0x2f8306,_0x54f2ed={'title':title,'modelType':modelType,'userId':_0x408676['user']['id']},_0x3ba0d1=await this['modelsService'][_0x2a0408(0x1ae)](modelType,_0x43909b);_0x54f2ed[_0x2a0408(0x17e)]=JSON['stringify'](_0x3ba0d1);const _0x3e29b9=await this[_0x2a0408(0x17b)][_0x2a0408(0x1b9)](_0x54f2ed);return _0x3e29b9;}async[_0x2d9b4a(0x1a9)](_0xd52c3c,_0x3346b7){const _0x522238=_0x2d9b4a;try{const _0x496467={'userId':_0x3346b7[_0x522238(0x190)]['id'],'id':_0xd52c3c,'isDelete':![]},_0x5b0eef=await this[_0x522238(0x17b)][_0x522238(0x1bc)]({'where':_0x496467});return _0x5b0eef;}catch(_0x2ca9cf){console['log'](_0x522238(0x1ab),_0x2ca9cf);}}async[_0x2d9b4a(0x1cb)](_0x32cceb,_0x4b499e,_0x3f758d,_0x5ade69){const _0x5329e7=_0x2d9b4a;console[_0x5329e7(0x1b7)](_0x5329e7(0x183),_0x32cceb,_0x4b499e,_0x3f758d,_0x5ade69);if(_0x32cceb==_0x5329e7(0x18b))this[_0x5329e7(0x193)]['update']({'id':_0x4b499e},{'lastMessage':_0x5ade69,'updatedAt':new Date()});else{const _0x4589bf=this['get'](_0x4b499e,_0x3f758d);_0x4589bf&&await this[_0x5329e7(0x17b)][_0x5329e7(0x18f)]({'id':_0x4b499e},{'lastMessage':_0x5ade69,'updatedAt':new Date()});}}async[_0x2d9b4a(0x16e)](_0x4432b7,_0x1b2dc3,_0x6acb60,_0x20290b){const _0x213493=_0x2d9b4a;try{const {id:_0x270839}=_0x20290b[_0x213493(0x190)],_0x4c82eb={'userId':_0x270839,'isDelete':![]};_0x4432b7?_0x4c82eb[_0x213493(0x1b6)]=_0x4432b7:_0x4c82eb['modelType']=(0x0,typeorm_2[_0x213493(0x187)])();let _0x22e8fa=[];if(_0x6acb60>0x0&&_0x1b2dc3>0x0){const _0x32f86e=(_0x1b2dc3-0x1)*_0x6acb60;_0x22e8fa=await this[_0x213493(0x17b)][_0x213493(0x192)]({'where':_0x4c82eb,'take':_0x6acb60,'skip':_0x32f86e,'order':{'isSticky':'DESC','updatedAt':'DESC','id':_0x213493(0x1a2)}});}else _0x22e8fa=await this[_0x213493(0x17b)][_0x213493(0x192)]({'where':_0x4c82eb,'order':{'isSticky':_0x213493(0x1a2),'updatedAt':_0x213493(0x1a2),'id':_0x213493(0x1a2)}});if(!_0x22e8fa[_0x213493(0x170)])return _0x22e8fa;const _0x541666=_0x22e8fa[_0x213493(0x1a6)](_0x205c9a=>_0x205c9a['id']),_0x372a08=await this[_0x213493(0x1cd)][_0x213493(0x16e)](_0x213493(0x1b2)+_0x541666[_0x213493(0x16d)]()+_0x213493(0x1a7)),_0x510bb7=new Map();_0x372a08[_0x213493(0x17f)](_0x4bd155=>{const _0x58c96e=_0x213493;_0x510bb7[_0x58c96e(0x18c)](_0x4bd155['groupId'],_0x4bd155[_0x58c96e(0x1b1)]);});const _0x44160e=_0x22e8fa['map'](_0x11d282=>{const _0x620f1a=_0x213493;return{..._0x11d282,'lastTime':_0x510bb7[_0x620f1a(0x1a9)](_0x11d282['id'])||null};});return _0x44160e;}catch(_0x2d431d){console['log'](_0x213493(0x1ab),_0x2d431d);}}async[_0x2d9b4a(0x18f)](_0x3b1106,_0x2e8f31){const _0x2b851c=_0x2d9b4a,{title:_0x45b136,isSticky:_0x2e28e5,groupId:_0x1fe63a,config:_0xd7618d,appType:_0x99b559}=_0x3b1106,{id:_0x5f334a}=_0x2e8f31[_0x2b851c(0x190)],_0xa24083=await this[_0x2b851c(0x17b)][_0x2b851c(0x1bc)]({'where':{'id':_0x1fe63a,'userId':_0x5f334a}});if(!_0xa24083)throw new common_1[(_0x2b851c(0x196))](_0x2b851c(0x1c0),common_1[_0x2b851c(0x195)][_0x2b851c(0x16a)]);const _0x2b1abc={};_0x45b136&&(_0x2b1abc['title']=_0x45b136),typeof _0x2e28e5!==_0x2b851c(0x1af)&&(_0x2b1abc[_0x2b851c(0x19f)]=_0x2e28e5),_0xd7618d&&(_0x2b1abc[_0x2b851c(0x17e)]=_0xd7618d);const _0x1404c9=await this[_0x2b851c(0x17b)][_0x2b851c(0x18f)]({'id':_0x1fe63a},_0x2b1abc);if(_0x1404c9[_0x2b851c(0x19e)])return!![];else throw new common_1[(_0x2b851c(0x196))]('更新对话失败！',common_1[_0x2b851c(0x195)]['BAD_REQUEST']);}async[_0x2d9b4a(0x16f)](_0xf975c3,_0x17d0bf){const _0x2ed880=_0x2d9b4a,{groupId:_0x48ce38}=_0xf975c3,{id:_0x40b4a8}=_0x17d0bf[_0x2ed880(0x190)],_0xa0c161=await this['chatGroupEntity'][_0x2ed880(0x1bc)]({'where':{'id':_0x48ce38,'userId':_0x40b4a8}});if(!_0xa0c161)throw new common_1[(_0x2ed880(0x196))](_0x2ed880(0x1c4),common_1[_0x2ed880(0x195)][_0x2ed880(0x16a)]);const _0x224330=await this[_0x2ed880(0x17b)][_0x2ed880(0x18f)]({'id':_0x48ce38},{'isDelete':!![]});if(_0x224330['affected'])return _0x2ed880(0x1bb);else throw new common_1[(_0x2ed880(0x196))]('删除失败！',common_1[_0x2ed880(0x195)][_0x2ed880(0x16a)]);}async[_0x2d9b4a(0x198)](_0x15481b){const _0x300904=_0x2d9b4a,{id:_0x15d056}=_0x15481b[_0x300904(0x190)],_0x54df9f=await this['chatGroupEntity'][_0x300904(0x18f)]({'userId':_0x15d056,'isSticky':![],'isDelete':![]},{'isDelete':!![]});if(_0x54df9f[_0x300904(0x19e)])return _0x300904(0x1bb);else throw new common_1[(_0x300904(0x196))](_0x300904(0x1c2),common_1[_0x300904(0x195)][_0x300904(0x16a)]);}async['getGroupInfoFromId'](_0xee4369){const _0x30ab60=_0x2d9b4a;if(!_0xee4369||_0xee4369===0x0)return null;return await this[_0x30ab60(0x17b)][_0x30ab60(0x1bc)]({'where':{'id':_0xee4369}});}async[_0x2d9b4a(0x1aa)](_0x2cbfcd,_0x4c8502){const _0x5db36f=_0x2d9b4a;try{const {id:_0x578070}=_0x4c8502['user'],_0x175a55={'userId':_0x578070,'isDelete':![]};_0x2cbfcd?_0x175a55[_0x5db36f(0x1b6)]=(0x0,typeorm_2['In'])(_0x2cbfcd):_0x175a55[_0x5db36f(0x1b6)]=(0x0,typeorm_2['IsNull'])();let _0x5847c2=[];const _0x2160ee=await this[_0x5db36f(0x17b)]['find']({'where':_0x175a55,'order':{'isSticky':_0x5db36f(0x1a2),'id':_0x5db36f(0x1a2)}});if(_0x2160ee[_0x5db36f(0x170)]){const _0x4a0d21=_0x2160ee[_0x5db36f(0x1a6)](_0x22cdd9=>_0x22cdd9['id']),_0x457825=await this['connection'][_0x5db36f(0x16e)](_0x5db36f(0x184)+_0x4a0d21[_0x5db36f(0x16d)]()+_0x5db36f(0x1cc)),_0x1d607e=new Map();_0x457825[_0x5db36f(0x17f)](_0x3fc19e=>{const _0x5030bf=_0x5db36f;_0x1d607e[_0x5030bf(0x18c)](_0x3fc19e[_0x5030bf(0x1b8)],_0x3fc19e[_0x5030bf(0x1b1)]);}),_0x5847c2=_0x2160ee[_0x5db36f(0x1a6)](_0x26f411=>{const _0x3d097d=_0x5db36f;return{..._0x26f411,'lastTime':_0x1d607e[_0x3d097d(0x1a9)](_0x26f411['id'])||null};});}const _0x1998fe=await this[_0x5db36f(0x17d)][_0x5db36f(0x191)](_0x4c8502),_0x40d300=await this[_0x5db36f(0x19b)]['find']({'where':{'userId':_0x4c8502[_0x5db36f(0x190)]['id'],'type':ppt_constant_1[_0x5db36f(0x18d)][_0x5db36f(0x1ac)],'delFlag':0x0},'order':{'updatedAt':_0x5db36f(0x1a2)}}),_0x3a2b09=await this[_0x5db36f(0x188)][_0x5db36f(0x192)]({'where':{'userId':_0x4c8502['user']['id'],'deleteFlag':0x0},'order':{'updatedAt':_0x5db36f(0x1a2)}});return _0x5847c2[_0x5db36f(0x18a)](..._0x1998fe[_0x5db36f(0x1a6)](_0x198c12=>{const _0x322b8c=_0x5db36f;return{'modelType':'mind','id':_0x198c12['id'],'title':_0x198c12[_0x322b8c(0x19a)]||_0x198c12[_0x322b8c(0x19d)],'lastTime':_0x198c12['updatedAt'],'userId':_0x198c12[_0x322b8c(0x16c)],'updatedAt':_0x198c12[_0x322b8c(0x1a4)]};})),_0x5847c2['push'](..._0x40d300[_0x5db36f(0x1a6)](_0x261603=>{const _0xece460=_0x5db36f;return{'modelType':_0xece460(0x194),'id':_0x261603['id'],'title':_0x261603['title'],'lastTime':_0x261603[_0xece460(0x1a4)],'userId':_0x261603['userId'],'updatedAt':_0x261603[_0xece460(0x1a4)]};})),_0x5847c2[_0x5db36f(0x18a)](..._0x3a2b09[_0x5db36f(0x1a6)](_0x2099a0=>{const _0x53b1fa=_0x5db36f;return{'modelType':_0x53b1fa(0x1ad),'id':_0x2099a0['id'],'title':_0x2099a0['name'],'lastTime':_0x2099a0[_0x53b1fa(0x1a4)],'userId':_0x2099a0[_0x53b1fa(0x16c)],'updatedAt':_0x2099a0[_0x53b1fa(0x1a4)]};})),_0x5847c2['sort']((_0x33440d,_0x3c7d50)=>{const _0x433bb0=_0x5db36f,_0x20fff3=new Date(_0x33440d[_0x433bb0(0x1a4)])[_0x433bb0(0x1ba)](),_0x3205b=new Date(_0x3c7d50[_0x433bb0(0x1a4)])[_0x433bb0(0x1ba)]();return _0x3205b-_0x20fff3;}),_0x5847c2;}catch(_0x1cc34f){console['log'](_0x5db36f(0x1ab),_0x1cc34f);}}async[_0x2d9b4a(0x1c5)](_0x4a607b,_0x1f3ab7){const _0x226c97=_0x2d9b4a;try{await this['chatGroupEntity']['update']({'userId':_0x1f3ab7['user']['id'],'isDelete':![],'modelType':(0x0,typeorm_2['In'])(_0x4a607b)},{'isDelete':!![]}),await this['mindTaskService'][_0x226c97(0x177)](_0x1f3ab7),await this['pptTaskEntity'][_0x226c97(0x18f)]({'userId':_0x1f3ab7[_0x226c97(0x190)]['id'],'type':ppt_constant_1[_0x226c97(0x18d)][_0x226c97(0x1ac)]},{'delFlag':0x1}),await this['docsTaskEntity']['update']({'userId':_0x1f3ab7[_0x226c97(0x190)]['id']},{'deleteFlag':0x1});}catch(_0x2e8497){console[_0x226c97(0x1b7)](_0x226c97(0x1ab),_0x2e8497);}}async[_0x2d9b4a(0x1b4)](_0x2c71ed,_0x4bb073,_0x55ae97){const _0x1efe16=_0x2d9b4a;try{const _0x1cdd6e=await this[_0x1efe16(0x17b)][_0x1efe16(0x1bc)]({'where':{'id':_0x2c71ed,'userId':_0x55ae97[_0x1efe16(0x190)]['id']}});if(!_0x1cdd6e)throw new Error('会话不存在！');_0x1cdd6e['isSticky']=_0x4bb073==0x1,await this[_0x1efe16(0x17b)][_0x1efe16(0x1b9)](_0x1cdd6e);}catch(_0x346415){return _0x346415[_0x1efe16(0x17a)];}}};function _0x5616(_0x9eca05,_0x44215d){const _0x4c3e94=_0x4c3e();return _0x5616=function(_0x561608,_0x2cdaac){_0x561608=_0x561608-0x16a;let _0x409b50=_0x4c3e94[_0x561608];return _0x409b50;},_0x5616(_0x9eca05,_0x44215d);}ChatGroupService=__decorate([(0x0,common_1[_0x2d9b4a(0x1a3)])(),__param(0x0,(0x0,typeorm_1[_0x2d9b4a(0x1be)])(chatGroup_entity_1['ChatGroupEntity'])),__param(0x3,(0x0,typeorm_1[_0x2d9b4a(0x1be)])(pptTask_entity_1[_0x2d9b4a(0x1b0)])),__param(0x4,(0x0,typeorm_1[_0x2d9b4a(0x1be)])(docsTask_entity_1[_0x2d9b4a(0x174)])),__param(0x5,(0x0,typeorm_1[_0x2d9b4a(0x1be)])(gpts_chat_group_entity_1[_0x2d9b4a(0x189)])),__metadata(_0x2d9b4a(0x19c),[typeorm_2['Repository'],models_service_1[_0x2d9b4a(0x175)],mindTask_service_1[_0x2d9b4a(0x179)],typeorm_2['Repository'],typeorm_2[_0x2d9b4a(0x182)],typeorm_2['Repository'],typeorm_2[_0x2d9b4a(0x16b)]])],ChatGroupService),exports[_0x2d9b4a(0x1a0)]=ChatGroupService;