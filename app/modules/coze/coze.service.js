'use strict';const _0x5c845b=_0x2ed1;function _0x31f6(){const _0x1565fd=['checkBadWords','stream','https://api.coze.cn','deleteKnowledgeDocument','axios','Not','】页-----------','toString','COZEBOT','model_info','updateKnowledge','deductBalance4Coze','createBot','hot','../badwords/badwords.service','contentType','object','guid-typescript','spaceId','content','rows','checkUserStatus','-----------------------------------uploadForUrlERROR----------','UserEntity','CozeMessageEntity','get','data','startFastChat','cozeMessageEntity','keyid','format_type','botId','fastUrl','collectBot','prompt_info','tags','batchKnowledgeProgressResult','length','data:\x20','cozeConversationEntity','https','responseMessageWithThink','7239852RFyWlV','../user/user.service','search','typeorm','files','--------------------------------------------------client.upload','获取智能体失败','detail','userId','../../common/constants/balance.constant','知识库不存在！','__esModule','function','CozeApiConfig','datasets','upload','mergeCollectData','char_count','privateKey','topConversation','./entity/knowledge.entity','findAndCount','./entity/conversation.entity','CONVERSATION_CHAT_CREATED','knowledgeId','hit_count','decorate','failed_file_list','getKnowledgeDocumentList','deduct','onboardingInfo','workflow_info_list','fileService','7474575122028871720','coze','find','deleteBot','-----------------------------------uploadUrlToServerError----------','getMyBotList','Guid','stringify','CozeConversationEntity','getWorkflowList','document_infos','no-cache','documentId','error\x20from\x20startChat!','getBot','vipFreeNum','completed','promptInfo','content_type','difyUrl','fast','avatar','slice_count','InjectRepository','CozeBotEntity','defineProperty','./entity/message.entity','getCozeApi','function_call','batchKnowledgeResult','getOwnPropertyDescriptor','metadata','forEach','getKnowledgeDocumentProgress','dataset_list','usage','uploadFile','会话不存在！','recommend','CozeModelEntity','total','getJWTToken','client.datasets.document.create','getKnowledgeList','UserService','isEnd','143BrtHEH','size','bots','updateBot','conversationId','Repository','BadwordsService','question','knowledge','default','5194147JGsNaW','validateBeforeChat','chunk_strategy','DESC','deleteKnowledge','updateKnowledgeDocument','web_url','784268yxdFvC','design:paramtypes','Injectable','cmService','getUserById','botEntity','CozeAPI','userType','../user/user.entity','160emwHdr','object_string','client.datasets.process','---------------------------CozeChatError--------------------------','write','string','会话不存在','dataset_id','fileUrl','space_bots','cozeWorkflowEntity','setHeader','doc_tree_tos_url','identity','ASC','智能体不存在！','@nestjs/typeorm','Access-Control-Allow-Origin','save','modelId','onboarding_info','source_type','document_id','useCount','workflowIdList','parse','cozeModelEntity','badwordsService','bot_id','FileService','isRelease','api','777910MmIZvF','relId','userService','----------------------updateBot--------------','@nestjs/common','BAD_REQUEST','GET','assistant','user','@coze/api','1024','getKnowledegeDocument','文档不存在！','chatId','retrieve','message','setConversationName','contentObject','modelInfoConfig','../file/file.service','-------------获取智能体列表:共【','isVipUsed','CozeKnowledgeDocumentEntity','uploadForUrl','userEntity','sendDifyMessage','model_id','includes','-----------------------------------createKnowledgeERROR----------','getJwtToken','CozeKnowledgeEntity','getMessageList','choices','Like','update_rule','filter','--------------------DIFYERROR--------------','preview_tos_url','type','model','gpt-4.1-mini','5304TSBIIn','delete','delta','9cMVuMO','---------------当前智能体图标-------------','createConversation','description','-----------------------CreateBotError---------------------------','knowledgeEntity','document_name','end','event','collect','bot_used_count','reasoning_content','statusCode','appId','viewCount','access_token','dify','-----------------获取智能体失败----------','responseMessage','getUserInfoFromHeader','getModelList','getValue','uncollect','conversations','answer','---------------当前智能体ID-------------','count','push','iconFileUrl','documents','collectPage','unifiedFormattingResponse','8GCopAv','SPACE_ID','collectBotList','text','-------------智能体同步完成','create','process','documentBases','getModelFree','LessThan','list','-----------------------updateBotErr--------------','getRemoteFileStream','findOne','log','map','nickname','999','error\x20from\x20startChat-fast!','replace','模型不存在','FastBot','isArray','botType','-----------------------------------createKnowledgeDocumentERROR----------','icon_url','deleteConversation','fileId','805788qdWkGf','EChangeType','createKnowledgeDocument','UserCollectType','ChatEventType','apiKey','batchBotProgressResult','processing_file_id_list','created','uploadUrlToServer','iconFileId','page','knowledgeDocumentEntity','uuid','expires_in','HttpException','validateBalance4Coze','pluginIdList','../chatgpt/helper','desc','formatType','role','当前智能体未匹配到对应模型，暂无法使用，请联系管理员添加','HttpStatus','error','523970UNGVte','status_descript','tag','./entity/model.entity','status','name','bot_name','getCozeModelVipFree','startDifyChat','createMessage','update'];_0x31f6=function(){return _0x1565fd;};return _0x31f6();}(function(_0x526ab5,_0x2dfb39){const _0x5e5254=_0x2ed1,_0x3088bf=_0x526ab5();while(!![]){try{const _0x19dd8d=-parseInt(_0x5e5254(0xbf))/0x1+-parseInt(_0x5e5254(0x127))/0x2+parseInt(_0x5e5254(0xeb))/0x3*(-parseInt(_0x5e5254(0x1d5))/0x4)+-parseInt(_0x5e5254(0x1de))/0x5*(parseInt(_0x5e5254(0xe8))/0x6)+parseInt(_0x5e5254(0x1ce))/0x7+-parseInt(_0x5e5254(0x10b))/0x8*(-parseInt(_0x5e5254(0x175))/0x9)+-parseInt(_0x5e5254(0x140))/0xa*(-parseInt(_0x5e5254(0x1c4))/0xb);if(_0x19dd8d===_0x2dfb39)break;else _0x3088bf['push'](_0x3088bf['shift']());}catch(_0x1309bb){_0x3088bf['push'](_0x3088bf['shift']());}}}(_0x31f6,0x690ed));function _0x2ed1(_0x4bde2f,_0x40d9f4){const _0x31f63c=_0x31f6();return _0x2ed1=function(_0x2ed1a9,_0x1e23ad){_0x2ed1a9=_0x2ed1a9-0xa2;let _0x2b320a=_0x31f63c[_0x2ed1a9];return _0x2b320a;},_0x2ed1(_0x4bde2f,_0x40d9f4);}var __decorate=this&&this['__decorate']||function(_0x42f6d5,_0x2b31ba,_0x50ece6,_0x172c6e){const _0x4b46ef=_0x2ed1;var _0x52049e=arguments['length'],_0x5308ea=_0x52049e<0x3?_0x2b31ba:_0x172c6e===null?_0x172c6e=Object[_0x4b46ef(0x1b4)](_0x2b31ba,_0x50ece6):_0x172c6e,_0x113dc5;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x4b46ef(0x181))_0x5308ea=Reflect[_0x4b46ef(0x18f)](_0x42f6d5,_0x2b31ba,_0x50ece6,_0x172c6e);else{for(var _0xdf42b1=_0x42f6d5['length']-0x1;_0xdf42b1>=0x0;_0xdf42b1--)if(_0x113dc5=_0x42f6d5[_0xdf42b1])_0x5308ea=(_0x52049e<0x3?_0x113dc5(_0x5308ea):_0x52049e>0x3?_0x113dc5(_0x2b31ba,_0x50ece6,_0x5308ea):_0x113dc5(_0x2b31ba,_0x50ece6))||_0x5308ea;}return _0x52049e>0x3&&_0x5308ea&&Object[_0x4b46ef(0x1af)](_0x2b31ba,_0x50ece6,_0x5308ea),_0x5308ea;},__metadata=this&&this['__metadata']||function(_0x3f5a8b,_0x115cfa){const _0x121b2b=_0x2ed1;if(typeof Reflect===_0x121b2b(0x15b)&&typeof Reflect[_0x121b2b(0x1b5)]===_0x121b2b(0x181))return Reflect[_0x121b2b(0x1b5)](_0x3f5a8b,_0x115cfa);},__param=this&&this['__param']||function(_0x3562f7,_0x36fd62){return function(_0x278380,_0x44e7e9){_0x36fd62(_0x278380,_0x44e7e9,_0x3562f7);};};Object[_0x5c845b(0x1af)](exports,_0x5c845b(0x180),{'value':!![]}),exports['CozeService']=void 0x0;const common_1=require(_0x5c845b(0xc3)),typeorm_1=require(_0x5c845b(0xaf)),typeorm_2=require(_0x5c845b(0x178)),bot_entity_1=require('./entity/bot.entity'),knowledge_entity_1=require(_0x5c845b(0x189)),knowledgedocument_entity_1=require('./entity/knowledgedocument.entity'),api_1=require(_0x5c845b(0xc8)),model_entity_1=require(_0x5c845b(0x143)),guid_typescript_1=require(_0x5c845b(0x15c)),https_1=require(_0x5c845b(0x173)),axios_1=require(_0x5c845b(0x14f)),conversation_entity_1=require(_0x5c845b(0x18b)),message_entity_1=require(_0x5c845b(0x1b0)),user_entity_1=require(_0x5c845b(0x1dd)),user_service_1=require(_0x5c845b(0x176)),collectType_constant_1=require('../../common/constants/collectType.constant'),badwords_service_1=require(_0x5c845b(0x159)),workflow_entity_1=require('./entity/workflow.entity'),cm_service_1=require('../cmConfig/cm.service'),file_service_1=require(_0x5c845b(0xd2)),uuid_1=require(_0x5c845b(0x134)),zhipu_1=require('../chatgpt/zhipu'),helper_1=require(_0x5c845b(0x139)),balance_constant_1=require(_0x5c845b(0x17e));let CozeService=class CozeService{constructor(_0x3c23b9,_0x36a4e9,_0xdd14a0,_0x5adf28,_0xcd49ef,_0x418103,_0x182027,_0x4de1e6,_0x209a54,_0x42d55d,_0x59392a,_0x2a0d53){const _0xe5bbdb=_0x5c845b;this[_0xe5bbdb(0x1da)]=_0x3c23b9,this[_0xe5bbdb(0xf0)]=_0x36a4e9,this[_0xe5bbdb(0x133)]=_0xdd14a0,this[_0xe5bbdb(0xb9)]=_0x5adf28,this[_0xe5bbdb(0x172)]=_0xcd49ef,this[_0xe5bbdb(0x167)]=_0x418103,this[_0xe5bbdb(0xa9)]=_0x182027,this['userEntity']=_0x4de1e6,this[_0xe5bbdb(0xc1)]=_0x209a54,this['badwordsService']=_0x42d55d,this['cmService']=_0x59392a,this['fileService']=_0x2a0d53,this[_0xe5bbdb(0x10c)]=_0xe5bbdb(0x196);}async[_0x5c845b(0xdc)](_0x112a15){const _0x5229fb=_0x5c845b;try{const _0x1e9d55=await this[_0x5229fb(0x1d8)][_0x5229fb(0x100)](_0x5229fb(0x182)),_0x12b0e9=_0x1e9d55[_0x5229fb(0xbe)][_0x5229fb(0x187)],_0x498846=_0x1e9d55[_0x5229fb(0xbe)][_0x5229fb(0xf8)],_0x2e738b=_0x1e9d55[_0x5229fb(0xbe)][_0x5229fb(0x168)];this[_0x5229fb(0x10c)]=_0x1e9d55[_0x5229fb(0xbe)][_0x5229fb(0x15d)];let _0x54f402=await(0x0,api_1[_0x5229fb(0x1bf)])({'baseURL':_0x5229fb(0x14d),'appId':_0x498846,'aud':'api.coze.cn','keyid':_0x2e738b,'privateKey':_0x12b0e9,'sessionName':_0x112a15+''});return _0x54f402;}catch(_0x290e83){return{'expires_in':0x0,'access_token':''};}}async[_0x5c845b(0x1b1)](_0x58bda0){const _0x5eb724=_0x5c845b;let _0x4934ba=await this['getJwtToken'](_0x58bda0);const _0x1ec189=new api_1[(_0x5eb724(0x1db))]({'baseURL':_0x5eb724(0x14d),'token':async()=>{const _0x4b4e94=_0x5eb724;if(_0x4934ba[_0x4b4e94(0x135)]*0x3e8>Date['now']()+0x1388)return _0x4934ba[_0x4b4e94(0xfa)];return _0x4934ba=await this[_0x4b4e94(0xdc)](_0x58bda0),_0x4934ba['access_token'];}});return _0x1ec189;}async[_0x5c845b(0x157)](_0x1ec541,_0x107367){const _0x97bde2=_0x5c845b;if(_0x1ec541[_0x97bde2(0x107)]){const _0x2d9a4e=await this[_0x97bde2(0xd6)](_0x1ec541[_0x97bde2(0x107)]);_0x1ec541[_0x97bde2(0x131)]=_0x2d9a4e['id'];}try{const _0x46cc61=await this[_0x97bde2(0x1b1)](_0x107367[_0x97bde2(0xc7)]['id']),_0x182620=await _0x46cc61[_0x97bde2(0x1c6)]['create']({'prompt_info':_0x1ec541['promptInfo'],'onboarding_info':_0x1ec541[_0x97bde2(0x193)],'name':_0x1ec541[_0x97bde2(0x145)],'description':_0x1ec541['description'],'icon_file_id':_0x1ec541[_0x97bde2(0x131)],'space_id':this[_0x97bde2(0x10c)]});return _0x1ec541[_0x97bde2(0x16a)]=_0x182620[_0x97bde2(0xbb)],_0x1ec541[_0x97bde2(0x17d)]=_0x107367[_0x97bde2(0xc7)]['id'],_0x1ec541[_0x97bde2(0x15d)]=this[_0x97bde2(0x10c)],await this[_0x97bde2(0x1da)]['save'](_0x1ec541),_0x1ec541;}catch(_0x4c0fa0){console[_0x97bde2(0x119)](_0x97bde2(0xef),_0x4c0fa0);}}async[_0x5c845b(0x1a4)](_0x4cae33,_0x3a2186){const _0x3de0b7=_0x5c845b;try{const _0x4f70df=this[_0x3de0b7(0xc1)][_0x3de0b7(0xfe)](_0x3a2186),_0xd6a967=_0x4f70df?.['id'],_0x5e248=await this[_0x3de0b7(0x1da)][_0x3de0b7(0x118)]({'where':{'botId':_0x4cae33}});if(!_0x5e248||_0x5e248[_0x3de0b7(0x17d)]!=0x0&&_0x5e248[_0x3de0b7(0x17d)]!=_0xd6a967)throw new common_1[(_0x3de0b7(0x136))](_0x3de0b7(0xae),common_1[_0x3de0b7(0x13e)][_0x3de0b7(0xc4)]);if(_0x5e248[_0x3de0b7(0x122)]=='coze'||!_0x5e248['botType']){const _0x45cc7f=await this[_0x3de0b7(0x1b1)](_0xd6a967||(0x0,uuid_1['v4'])());if(_0x5e248[_0x3de0b7(0xbd)]==0x1){const _0x24d62a=await _0x45cc7f['bots'][_0x3de0b7(0xcd)]({'bot_id':_0x4cae33});_0x5e248[_0x3de0b7(0xd1)]=_0x24d62a['model_info'],_0x5e248[_0x3de0b7(0xb7)]=_0x24d62a[_0x3de0b7(0x194)],_0x5e248['onboardingInfo']=_0x24d62a[_0x3de0b7(0xb3)],_0x5e248[_0x3de0b7(0xf9)]+=0x1,await this[_0x3de0b7(0x1da)][_0x3de0b7(0xb1)](_0x5e248);}}return _0x5e248;}catch(_0x263cd6){console[_0x3de0b7(0x119)](_0x3de0b7(0xfc),_0x263cd6);throw new common_1[(_0x3de0b7(0x136))](_0x3de0b7(0x17b),common_1[_0x3de0b7(0x13e)][_0x3de0b7(0xc4)]);}}async[_0x5c845b(0x1c7)](_0x26ef51,_0x57401c){const _0x235aef=_0x5c845b,_0x8d1b25=await this[_0x235aef(0x1da)][_0x235aef(0x118)]({'where':{'botId':_0x26ef51[_0x235aef(0x16a)]}});if(!_0x8d1b25)throw new Error(_0x235aef(0xae));if(_0x8d1b25[_0x235aef(0x107)]!=_0x26ef51['iconFileUrl']){const _0x3f2251=await this[_0x235aef(0xd6)](_0x26ef51['iconFileUrl']);_0x26ef51[_0x235aef(0x131)]=_0x3f2251['id'];}try{const _0x26a72a=await this[_0x235aef(0x1b1)](_0x57401c[_0x235aef(0xc7)]['id']);Array[_0x235aef(0x121)](_0x8d1b25[_0x235aef(0xb7)])&&(_0x26ef51[_0x235aef(0xb7)]={'ids':_0x8d1b25[_0x235aef(0xb7)]});_0x26ef51[_0x235aef(0xb7)]={};const _0x1f6740={'prompt_info':_0x26ef51[_0x235aef(0x1a7)],'onboarding_info':_0x26ef51[_0x235aef(0x193)],'name':_0x26ef51['name'],'description':_0x26ef51[_0x235aef(0xee)],'icon_file_id':_0x26ef51['iconFileId'],'knowledge':_0x26ef51[_0x235aef(0x1cc)],'bot_id':_0x26ef51['botId'],'plugin_id_list':!_0x26ef51[_0x235aef(0x138)]?{}:Array[_0x235aef(0x121)](_0x26ef51[_0x235aef(0x138)])?{'id_list':_0x26ef51[_0x235aef(0x138)]}:_0x26ef51['pluginIdList'],'workflow_id_list':!_0x26ef51['workflowIdList']?{}:Array[_0x235aef(0x121)](_0x26ef51['workflowIdList'])?{'ids':_0x26ef51[_0x235aef(0xb7)]}:_0x26ef51['workflowIdList'],'model_info_config':_0x26ef51[_0x235aef(0xd1)]};console[_0x235aef(0x119)](_0x235aef(0xc2),_0x1f6740),await _0x26a72a[_0x235aef(0x1c6)][_0x235aef(0x14a)](_0x1f6740),this['publishBot'](_0x8d1b25[_0x235aef(0x16a)],_0x57401c),_0x8d1b25[_0x235aef(0x1a7)]&&(_0x26ef51[_0x235aef(0x1a7)]=_0x8d1b25['promptInfo']),_0x8d1b25[_0x235aef(0x193)]&&(_0x26ef51[_0x235aef(0x193)]=_0x8d1b25[_0x235aef(0x193)]),_0x8d1b25['name']&&(_0x26ef51['name']=_0x8d1b25['name']),_0x26ef51[_0x235aef(0xee)]=_0x8d1b25['description'],_0x8d1b25[_0x235aef(0x131)]&&(_0x26ef51[_0x235aef(0x131)]=_0x8d1b25[_0x235aef(0x131)]),_0x8d1b25[_0x235aef(0x1cc)]&&(_0x26ef51[_0x235aef(0x1cc)]=_0x8d1b25['knowledge']),_0x8d1b25[_0x235aef(0x16a)]&&(_0x26ef51[_0x235aef(0x16a)]=_0x8d1b25[_0x235aef(0x16a)]),_0x8d1b25[_0x235aef(0x138)]&&(_0x26ef51[_0x235aef(0x138)]=_0x8d1b25[_0x235aef(0x138)]),_0x8d1b25[_0x235aef(0xb7)]&&(_0x26ef51[_0x235aef(0xb7)]=_0x8d1b25['workflowIdList']),_0x8d1b25[_0x235aef(0xd1)]&&(_0x26ef51[_0x235aef(0xd1)]=_0x8d1b25[_0x235aef(0xd1)]),await this[_0x235aef(0x1da)][_0x235aef(0xb1)](_0x8d1b25);}catch(_0x34ac9e){return console['log'](_0x235aef(0x116),_0x34ac9e),_0x34ac9e;}}async[_0x5c845b(0x199)](_0x5476d6,_0x2bdc91){const _0x1ccc04=_0x5c845b,_0x17a72a=await this['botEntity']['findOne']({'where':{'botId':_0x5476d6,'userId':_0x2bdc91[_0x1ccc04(0xc7)]['id']}});if(!_0x17a72a||_0x17a72a[_0x1ccc04(0x17d)]!=_0x2bdc91[_0x1ccc04(0xc7)]['id'])throw new Error(_0x1ccc04(0xae));await this[_0x1ccc04(0x1da)][_0x1ccc04(0xe9)](_0x17a72a['id']);}async[_0x5c845b(0x16c)](_0x216c23,_0x324178,_0x1d5dcb){const _0x50177e=_0x5c845b,_0x414f34=await this['botEntity'][_0x50177e(0x118)]({'where':{'botId':_0x216c23}});if(!_0x414f34)throw new Error(_0x50177e(0xae));_0x1d5dcb==0x1?this[_0x50177e(0xc1)][_0x50177e(0xf4)](_0x324178[_0x50177e(0xc7)]['id'],_0x414f34['id'],collectType_constant_1[_0x50177e(0x12a)]['COZEBOT']):this[_0x50177e(0xc1)][_0x50177e(0x101)](_0x324178[_0x50177e(0xc7)]['id'],_0x414f34['id'],collectType_constant_1['UserCollectType'][_0x50177e(0x153)]);}async[_0x5c845b(0x10d)](_0x89ae04,_0x39d211){const _0x405a53=_0x5c845b,_0x3ff96b=await this[_0x405a53(0xc1)][_0x405a53(0x109)](_0x89ae04['page'],_0x89ae04[_0x405a53(0x1c5)],_0x39d211[_0x405a53(0xc7)]['id'],collectType_constant_1['UserCollectType']['COZEBOT']);if(_0x3ff96b[_0x405a53(0x105)]>0x0){const _0x1dc674=await this[_0x405a53(0x1da)]['findBy']({'id':(0x0,typeorm_2['In'])(_0x3ff96b[_0x405a53(0x15f)][_0x405a53(0x11a)](_0xde5a6d=>_0xde5a6d[_0x405a53(0xc0)]))});return{'rows':_0x1dc674,'count':_0x3ff96b['count']};}return{'rows':[],'count':0x0};}async[_0x5c845b(0x19b)](_0x3f8a41,_0x569833){const _0x471d25=_0x5c845b,_0x5ebf70={'userId':_0x569833[_0x471d25(0xc7)]['id']};_0x3f8a41['tag']&&(_0x5ebf70[_0x471d25(0x16e)]=(0x0,typeorm_2['Like'])('%'+_0x3f8a41['tag']+'%'));_0x3f8a41[_0x471d25(0x177)]&&(_0x5ebf70['name']=(0x0,typeorm_2[_0x471d25(0xe0)])('%'+_0x3f8a41[_0x471d25(0x177)]+'%'));const [_0x39ca52,_0x338d91]=await this[_0x471d25(0x1da)][_0x471d25(0x18a)]({'where':_0x5ebf70,'order':{'id':_0x471d25(0x1d1)},'skip':(_0x3f8a41[_0x471d25(0x132)]-0x1)*_0x3f8a41[_0x471d25(0x1c5)],'take':_0x3f8a41[_0x471d25(0x1c5)]}),_0x54e22b=await this[_0x471d25(0xc1)][_0x471d25(0x185)](_0x39ca52,_0x569833,collectType_constant_1[_0x471d25(0x12a)][_0x471d25(0x153)]);return{'rows':_0x54e22b,'count':_0x338d91};}async['getChatBotList'](_0x19ac3a,_0x281f92){const _0x564023=_0x5c845b,_0x31a43d=await this['cozeConversationEntity'][_0x564023(0x198)]({'where':{'userId':_0x281f92[_0x564023(0xc7)]['id']}}),_0x432dd9=[...new Set(_0x31a43d['map'](_0x21c38e=>_0x21c38e[_0x564023(0x16a)]))];if(!_0x432dd9['length'])return{'rows':[],'count':0x0};const _0x15fd1b={'botId':(0x0,typeorm_2['In'])(_0x432dd9)};_0x19ac3a['tag']&&(_0x15fd1b[_0x564023(0x16e)]=(0x0,typeorm_2[_0x564023(0xe0)])('%'+_0x19ac3a[_0x564023(0x142)]+'%'));_0x19ac3a[_0x564023(0x177)]&&(_0x15fd1b[_0x564023(0x145)]=(0x0,typeorm_2[_0x564023(0xe0)])('%'+_0x19ac3a[_0x564023(0x177)]+'%'));const [_0x52c89b,_0x2bd9f8]=await this[_0x564023(0x1da)][_0x564023(0x18a)]({'where':_0x15fd1b,'order':{'id':_0x564023(0x1d1)},'skip':(_0x19ac3a['page']-0x1)*_0x19ac3a['size'],'take':_0x19ac3a[_0x564023(0x1c5)]}),_0xdcea4b=await this[_0x564023(0xc1)][_0x564023(0x185)](_0x52c89b,_0x281f92,collectType_constant_1['UserCollectType'][_0x564023(0x153)]);return{'rows':_0xdcea4b,'count':_0x2bd9f8};}async['getBotList'](_0x1c30c8,_0xeb2706){const _0x52a16e=_0x5c845b,_0x40d28c=[{'publish_flag':0x1}];_0x1c30c8[_0x52a16e(0x142)]&&_0x40d28c[_0x52a16e(0x1b6)](_0x1e17f9=>{const _0x5bea55=_0x52a16e;_0x1e17f9[_0x5bea55(0x16e)]=(0x0,typeorm_2[_0x5bea55(0xe0)])('%'+_0x1c30c8['tag']+'%');});_0x1c30c8[_0x52a16e(0x177)]&&_0x40d28c[_0x52a16e(0x1b6)](_0x122621=>{const _0x583f3a=_0x52a16e;_0x122621['name']=(0x0,typeorm_2[_0x583f3a(0xe0)])('%'+_0x1c30c8['search']+'%');});_0x40d28c[_0x52a16e(0x1b6)](_0x37495b=>{_0x37495b['isRelease']=0x1;});let _0xd0ee57={'id':_0x52a16e(0x1d1)};if(_0x1c30c8['type']==_0x52a16e(0x158))_0xd0ee57={'useCount':_0x52a16e(0x1d1)};else _0x1c30c8[_0x52a16e(0xe5)]==_0x52a16e(0x1bc)?_0xd0ee57={'recommendAt':'DESC'}:_0xd0ee57={'id':_0x52a16e(0x1d1)};const _0x5b85c9=await this[_0x52a16e(0x1da)][_0x52a16e(0x18a)]({'where':_0x40d28c,'order':_0xd0ee57,'skip':(_0x1c30c8[_0x52a16e(0x132)]-0x1)*_0x1c30c8[_0x52a16e(0x1c5)],'take':_0x1c30c8[_0x52a16e(0x1c5)]}),[_0x1382a6,_0x18c430]=_0x5b85c9,_0x68a194=await this[_0x52a16e(0xd7)][_0x52a16e(0x198)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1382a6[_0x52a16e(0x11a)](_0x332697=>_0x332697[_0x52a16e(0x17d)]))}});_0x1382a6[_0x52a16e(0x1b6)](_0x1c142f=>{const _0x1db056=_0x52a16e;if(_0x1c142f[_0x1db056(0x17d)]){const _0x1bd864=_0x68a194[_0x1db056(0x198)](_0xfcbfe3=>_0xfcbfe3['id']==_0x1c142f[_0x1db056(0x17d)]);_0x1c142f['userInfo']={'userId':_0x1bd864['id'],'userName':_0x1bd864[_0x1db056(0x11b)],'avatar':_0x1bd864[_0x1db056(0x1ab)]};}_0x1c142f[_0x1db056(0xd4)]=_0x1c142f[_0x1db056(0x1dc)]?!![]:![];});const _0x2f7f4f=await this[_0x52a16e(0xc1)][_0x52a16e(0x185)](_0x1382a6,_0xeb2706,collectType_constant_1[_0x52a16e(0x12a)][_0x52a16e(0x153)]);return{'rows':_0x2f7f4f,'count':_0x18c430};}async['publishBot'](_0x48fac8,_0x2d8395){const _0x158ac7=_0x5c845b,_0x1e35a4=await this[_0x158ac7(0x1da)][_0x158ac7(0x118)]({'where':{'botId':_0x48fac8,'userId':_0x2d8395[_0x158ac7(0xc7)]['id']}});if(!_0x1e35a4||_0x1e35a4[_0x158ac7(0x17d)]!=_0x2d8395['user']['id'])throw new Error(_0x158ac7(0xae));const _0x1f2571=await this[_0x158ac7(0x1b1)](_0x2d8395['user']['id']);await _0x1f2571[_0x158ac7(0x1c6)]['publish']({'bot_id':_0x1e35a4[_0x158ac7(0x16a)],'connector_ids':[_0x158ac7(0xc9),_0x158ac7(0x11c)]}),_0x1e35a4[_0x158ac7(0xbd)]=0x1,await this[_0x158ac7(0x1da)][_0x158ac7(0xb1)](_0x1e35a4);}async['upload'](_0x1e6f6c,_0x282a54){const _0x50f558=_0x5c845b,_0x4a0fab=await this['getCozeApi'](_0x282a54[_0x50f558(0xc7)]['id']);try{const _0x5298e6=await _0x4a0fab[_0x50f558(0x179)][_0x50f558(0x184)]({'file':_0x1e6f6c});return _0x5298e6;}catch(_0x391261){console[_0x50f558(0x119)](_0x50f558(0x17a),_0x391261);}return![];}async[_0x5c845b(0xd6)](_0x396042){const _0x5b995a=_0x5c845b;try{const _0x5ec8cf=await this[_0x5b995a(0x1b1)](guid_typescript_1[_0x5b995a(0x19c)][_0x5b995a(0x110)]()),_0x2b5020=await(0x0,axios_1['default'])({'url':_0x396042,'method':_0x5b995a(0xc5),'responseType':_0x5b995a(0x14c),'headers':{'Accept-Encoding':_0x5b995a(0xac)}}),_0x4cfa4f=_0x2b5020[_0x5b995a(0x165)],_0x1919b0=await _0x5ec8cf[_0x5b995a(0x179)][_0x5b995a(0x184)]({'file':_0x4cfa4f});return _0x1919b0;}catch(_0x554f23){console[_0x5b995a(0x119)](_0x5b995a(0x161),_0x554f23);}return null;}async['createKnowledge'](_0x40693d,_0x1af646){const _0x543f78=_0x5c845b;try{const _0x33d76f=await this[_0x543f78(0xd6)](_0x40693d[_0x543f78(0xa7)]);_0x40693d[_0x543f78(0x126)]=_0x33d76f['id'];const _0x51c63e=await this[_0x543f78(0x1b1)](_0x1af646['user']['id']),_0x374367=await _0x51c63e[_0x543f78(0x183)][_0x543f78(0x110)]({'name':_0x40693d[_0x543f78(0x145)],'description':_0x40693d[_0x543f78(0xee)],'file_id':_0x40693d[_0x543f78(0x126)],'space_id':this[_0x543f78(0x10c)],'format_type':_0x40693d[_0x543f78(0x13b)]});_0x40693d['spaceId']=this[_0x543f78(0x10c)],_0x40693d[_0x543f78(0x18d)]=_0x374367['dataset_id'],_0x40693d[_0x543f78(0x17d)]=_0x1af646['user']['id'],await this[_0x543f78(0xf0)][_0x543f78(0xb1)](_0x40693d);}catch(_0x385a92){return console[_0x543f78(0x119)](_0x543f78(0xdb),_0x385a92),_0x385a92;}}async[_0x5c845b(0x155)](_0x3055a2,_0x1e0045){const _0x5e8256=_0x5c845b,_0xbc5eaa=await this['knowledgeEntity']['findOne']({'where':{'knowledgeId':_0x3055a2[_0x5e8256(0x18d)]}});if(!_0xbc5eaa||_0xbc5eaa[_0x5e8256(0x17d)]!=_0x1e0045['user']['id'])throw new Error('知识库不存在！');if(_0xbc5eaa['fileUrl']!=_0x3055a2[_0x5e8256(0xa7)]){const _0x149c01=await this[_0x5e8256(0xd6)](_0x3055a2['fileUrl']);_0x3055a2[_0x5e8256(0x126)]=_0x149c01['id'];}const _0x30d0da=await this[_0x5e8256(0x1b1)](_0x1e0045['user']['id']);await _0x30d0da[_0x5e8256(0x183)][_0x5e8256(0x14a)](_0xbc5eaa[_0x5e8256(0x18d)],{'name':_0x3055a2[_0x5e8256(0x145)],'description':_0x3055a2[_0x5e8256(0xee)],'file_id':_0x3055a2[_0x5e8256(0x126)]}),await this[_0x5e8256(0xf0)][_0x5e8256(0xb1)](_0x3055a2);}async[_0x5c845b(0x1d2)](_0x19c8ab,_0x2204c5){const _0x2c271a=_0x5c845b,_0x55249b=await this[_0x2c271a(0xf0)]['findOne']({'where':{'knowledgeId':_0x19c8ab}});if(!_0x55249b||_0x55249b[_0x2c271a(0x17d)]!=_0x2204c5[_0x2c271a(0xc7)]['id'])throw new Error(_0x2c271a(0x17f));const _0x17d16b=await this[_0x2c271a(0x1b1)](_0x2204c5[_0x2c271a(0xc7)]['id']),_0x4f6c5a=await _0x17d16b[_0x2c271a(0x183)]['delete'](_0x55249b[_0x2c271a(0x18d)]);await this[_0x2c271a(0xf0)]['delete'](_0x55249b['id']);}async[_0x5c845b(0x1c1)](_0x29e9ed,_0x276d45){const _0x5d2ba7=_0x5c845b,_0x3077ea={'userId':_0x276d45[_0x5d2ba7(0xc7)]['id']};_0x29e9ed['search']&&(_0x3077ea[_0x5d2ba7(0x145)]=(0x0,typeorm_2[_0x5d2ba7(0xe0)])('%'+_0x29e9ed[_0x5d2ba7(0x177)]+'%'));const [_0x547135,_0x4aad32]=await this['knowledgeEntity']['findAndCount']({'where':_0x3077ea,'order':{'id':_0x5d2ba7(0x1d1)},'skip':(_0x29e9ed[_0x5d2ba7(0x132)]-0x1)*_0x29e9ed['size'],'take':_0x29e9ed['size']});return{'rows':_0x547135,'count':_0x4aad32};}async[_0x5c845b(0xca)](_0x5cedcb,_0x18ba1c){const _0x1cbce7=_0x5c845b;return await this[_0x1cbce7(0x133)][_0x1cbce7(0x118)]({'where':{'documentId':_0x5cedcb,'userId':_0x18ba1c[_0x1cbce7(0xc7)]['id']}});}async[_0x5c845b(0x191)](_0x52b7f7,_0x1a1770){const _0x5644b4=_0x5c845b,_0x3f6418={'userId':_0x1a1770[_0x5644b4(0xc7)]['id'],'knowledgeId':_0x52b7f7[_0x5644b4(0x18d)]};_0x52b7f7['search']&&(_0x3f6418[_0x5644b4(0x145)]=(0x0,typeorm_2[_0x5644b4(0xe0)])('%'+_0x52b7f7[_0x5644b4(0x177)]+'%'));const [_0x5a8d02,_0x178632]=await this[_0x5644b4(0x133)]['findAndCount']({'where':_0x3f6418,'order':{'id':_0x5644b4(0x1d1)},'skip':(_0x52b7f7[_0x5644b4(0x132)]-0x1)*_0x52b7f7[_0x5644b4(0x1c5)],'take':_0x52b7f7[_0x5644b4(0x1c5)]});return{'rows':_0x5a8d02,'count':_0x178632};}async[_0x5c845b(0x129)](_0x43ce55,_0x591202){const _0x723f64=_0x5c845b;try{const _0x261407=await this[_0x723f64(0x1b1)](_0x591202['user']['id']),_0x1fe452=await _0x261407[_0x723f64(0x183)][_0x723f64(0x108)][_0x723f64(0x110)]({'dataset_id':_0x43ce55['knowledgeId'],'document_bases':_0x43ce55[_0x723f64(0x112)],'chunk_strategy':_0x43ce55['chunkStrategy'],'format_type':_0x43ce55[_0x723f64(0x13b)]});let _0x1dc6cf=[];for(const _0x2d30d8 of _0x1fe452){_0x1dc6cf[_0x723f64(0x106)](await this[_0x723f64(0x133)][_0x723f64(0xb1)]({'userId':_0x591202[_0x723f64(0xc7)]['id'],'spaceId':this[_0x723f64(0x10c)],'knowledgeId':_0x43ce55[_0x723f64(0x18d)],'name':_0x2d30d8['name'],'documentId':_0x2d30d8[_0x723f64(0xb5)],'charCount':_0x2d30d8['char_count'],'chunkStrategy':_0x2d30d8[_0x723f64(0x1d0)],'formatType':_0x2d30d8[_0x723f64(0x169)],'hitCount':_0x2d30d8['hit_count'],'size':_0x2d30d8[_0x723f64(0x1c5)],'sliceCount':_0x2d30d8['slice_count'],'status':_0x2d30d8[_0x723f64(0x144)],'type':_0x2d30d8[_0x723f64(0xe5)]}));}return console[_0x723f64(0x119)](_0x723f64(0x1c0),_0x1fe452),_0x1dc6cf;}catch(_0x4d155c){return console[_0x723f64(0x119)](_0x723f64(0x123),_0x4d155c),_0x4d155c;}}async[_0x5c845b(0x1d3)](_0xe83bff,_0x56b8bd){const _0x3994df=_0x5c845b;try{const _0x117c96=await this[_0x3994df(0x133)]['findOne']({'where':{'documentId':_0xe83bff[_0x3994df(0xb5)]}});if(!_0x117c96||_0x117c96['userId']!=_0x56b8bd['user']['id'])throw new Error(_0x3994df(0xcb));_0x117c96['updateRule']=_0xe83bff[_0x3994df(0xe1)],_0x117c96[_0x3994df(0x145)]=_0xe83bff[_0x3994df(0xf1)],await this[_0x3994df(0x133)][_0x3994df(0xb1)](_0x117c96);const _0x15b043=await this[_0x3994df(0x1b1)](_0x56b8bd['user']['id']),_0x34e779=await _0x15b043[_0x3994df(0x183)][_0x3994df(0x108)][_0x3994df(0x14a)](_0xe83bff);return _0x34e779;}catch(_0x1ae0c3){return _0x1ae0c3;}}async[_0x5c845b(0x14e)](_0x29dfc6,_0x527cd5){const _0x27b32a=_0x5c845b,_0x27390a=await this[_0x27b32a(0x133)][_0x27b32a(0x118)]({'where':{'documentId':_0x29dfc6}});if(!_0x27390a||_0x27390a[_0x27b32a(0x17d)]!=_0x527cd5[_0x27b32a(0xc7)]['id'])throw new Error(_0x27b32a(0xcb));await this[_0x27b32a(0x133)]['delete']({'documentId':_0x29dfc6,'userId':_0x527cd5[_0x27b32a(0xc7)]['id']});const _0x2fd75e=await this[_0x27b32a(0x1b1)](_0x527cd5[_0x27b32a(0xc7)]['id']),_0x32e0c3=await _0x2fd75e[_0x27b32a(0x183)]['documents'][_0x27b32a(0xe9)]({'document_ids':[_0x27390a[_0x27b32a(0x1a2)]]});console[_0x27b32a(0x119)]('client.datasets.document.delete',_0x32e0c3);}async[_0x5c845b(0x1b7)](_0x3de6e2,_0x5a9612,_0x54c5ca){const _0x47270=_0x5c845b,_0x20203b=await this[_0x47270(0x1b1)](_0x54c5ca[_0x47270(0xc7)]['id']),_0x3c0477=await _0x20203b[_0x47270(0x183)][_0x47270(0x111)](_0x3de6e2,_0x5a9612);console[_0x47270(0x119)](_0x47270(0x1e0),_0x3c0477);}async[_0x5c845b(0xff)](){const _0x22ff98=_0x5c845b;return await this[_0x22ff98(0xb9)][_0x22ff98(0x198)]({'where':{'isRelease':0x1},'order':{'sortIndex':_0x22ff98(0x1d1),'id':_0x22ff98(0x1d1)}});}async[_0x5c845b(0x117)](_0x3eac36){return new Promise((_0x2dff5f,_0x28b9dd)=>{const _0x25fa79=_0x2ed1;https_1[_0x25fa79(0x1cd)][_0x25fa79(0x164)](_0x3eac36,_0x1dc1ce=>{const _0x142232=_0x25fa79;if(_0x1dc1ce[_0x142232(0xf7)]!==0xc8){_0x28b9dd(new Error('请求失败，状态码:\x20'+_0x1dc1ce['statusCode']));return;}_0x2dff5f(_0x1dc1ce);})['on'](_0x25fa79(0x13f),_0x28126f=>{_0x28b9dd(_0x28126f);});});}async['getConversationList'](_0x40e72c,_0x5e6090){const _0x4b0d55=_0x5c845b,_0x5dd269={'userId':_0x5e6090[_0x4b0d55(0xc7)]['id'],'botId':_0x40e72c['botId']},[_0x55b932,_0x1579e5]=await this[_0x4b0d55(0x172)]['findAndCount']({'where':_0x5dd269,'order':{'isTop':_0x4b0d55(0x13a),'id':_0x4b0d55(0x1d1)},'skip':(_0x40e72c['page']-0x1)*_0x40e72c[_0x4b0d55(0x1c5)],'take':_0x40e72c[_0x4b0d55(0x1c5)]});return{'rows':_0x55b932,'count':_0x1579e5};}async[_0x5c845b(0xed)](_0x3b3479,_0x24082b){const _0x1515c4=_0x5c845b;try{const _0x365203=await this['botEntity'][_0x1515c4(0x118)]({'where':{'botId':_0x3b3479['botId']}});_0x3b3479[_0x1515c4(0x17d)]=_0x24082b[_0x1515c4(0xc7)]['id'];if(!_0x365203[_0x1515c4(0x122)]||_0x365203[_0x1515c4(0x122)]==_0x1515c4(0x197)){const _0x265003=await this[_0x1515c4(0x1b1)](_0x24082b[_0x1515c4(0xc7)]['id']),_0x45ad8d=await _0x265003[_0x1515c4(0x102)]['create']({'bot_id':_0x3b3479['botId']});_0x3b3479[_0x1515c4(0x1c8)]=_0x45ad8d['id'];}else _0x3b3479[_0x1515c4(0x1c8)]=(0x0,uuid_1['v4'])()[_0x1515c4(0x11e)](/-/g,'');return _0x365203[_0x1515c4(0xb6)]=_0x365203[_0x1515c4(0xb6)]?_0x365203[_0x1515c4(0xb6)]+0x1:0x1,await this[_0x1515c4(0x1da)][_0x1515c4(0xb1)](_0x365203),await this[_0x1515c4(0x172)][_0x1515c4(0xb1)](_0x3b3479);}catch(_0x54cb47){return _0x54cb47;}}async[_0x5c845b(0x125)](_0x1b7cb4,_0x38edb1){const _0x2edad9=_0x5c845b;return await this[_0x2edad9(0x172)]['delete']({'conversationId':_0x1b7cb4,'userId':_0x38edb1[_0x2edad9(0xc7)]['id']}),!![];}async[_0x5c845b(0xcf)](_0x21ea4b,_0x49c5dc,_0x231f1f){const _0x5f1010=_0x5c845b,_0x540ca7=await this[_0x5f1010(0x172)][_0x5f1010(0x118)]({'where':{'conversationId':_0x21ea4b,'userId':_0x231f1f[_0x5f1010(0xc7)]['id']}});if(!_0x540ca7)throw new Error('会话不存在！');_0x540ca7[_0x5f1010(0x145)]=_0x49c5dc,await this[_0x5f1010(0x172)][_0x5f1010(0xb1)](_0x540ca7);}async[_0x5c845b(0x188)](_0x550bad,_0x19e44c,_0x273ef4){const _0x13ddc3=_0x5c845b;try{const _0x117d30=await this[_0x13ddc3(0x172)][_0x13ddc3(0x118)]({'where':{'conversationId':_0x550bad,'userId':_0x273ef4[_0x13ddc3(0xc7)]['id']}});if(!_0x117d30)throw new Error(_0x13ddc3(0x1bb));_0x117d30['isTop']=_0x19e44c==0x1?0x1:0x0,await this[_0x13ddc3(0x172)]['save'](_0x117d30);}catch(_0x4da4c2){return _0x4da4c2[_0x13ddc3(0xce)];}}async[_0x5c845b(0xde)](_0x36d3b9,_0x2bb44d){const _0x42aceb=_0x5c845b,_0x2954f3={'userId':_0x2bb44d[_0x42aceb(0xc7)]['id'],'conversationId':_0x36d3b9[_0x42aceb(0x1c8)]},[_0x41a293,_0x2c7570]=await this[_0x42aceb(0x167)]['findAndCount']({'where':_0x2954f3,'order':{'id':_0x42aceb(0x1d1)},'skip':(_0x36d3b9[_0x42aceb(0x132)]-0x1)*_0x36d3b9[_0x42aceb(0x1c5)],'take':_0x36d3b9['size']});return{'rows':_0x41a293,'count':_0x2c7570};}async[_0x5c845b(0x149)](_0x4b0e12,_0x716f02){const _0x364e19=_0x5c845b,_0x3a4937=await this[_0x364e19(0x1b1)](_0x716f02[_0x364e19(0xc7)]['id']),_0xe7ac7=await _0x3a4937[_0x364e19(0x102)]['messages'][_0x364e19(0x110)](_0x4b0e12[_0x364e19(0x1c8)],{'role':_0x4b0e12[_0x364e19(0x13c)],'content':_0x4b0e12['content'],'content_type':_0x4b0e12[_0x364e19(0x15a)],'meta_data':{}});_0x4b0e12['messageId']=_0xe7ac7['id'],this[_0x364e19(0x167)]['save'](_0x4b0e12);}[_0x5c845b(0xfd)](_0x4ac4a5,_0x310e9d){const _0x3ac866=_0x5c845b;_0x4ac4a5[_0x3ac866(0xa3)](_0x3ac866(0x171)+JSON[_0x3ac866(0x19d)](_0x310e9d)+'\x0a\x0a');}async['validateBeforeChat'](_0x1f53d4){const _0x5f9ec6=_0x5c845b,{user:_0x2ca9b6,prompt:_0x3686bf,bot:_0x109a0b,userType:_0x2e0f19}=_0x1f53d4;await this[_0x5f9ec6(0xc1)][_0x5f9ec6(0x160)](_0x2ca9b6),await this[_0x5f9ec6(0xba)][_0x5f9ec6(0x14b)](_0x3686bf,_0x2ca9b6['id']),await this['userService'][_0x5f9ec6(0x137)](_0x2ca9b6['id'],_0x109a0b['id'],_0x109a0b[_0x5f9ec6(0x1a5)],_0x109a0b[_0x5f9ec6(0x192)]),await this[_0x5f9ec6(0xc1)]['validateUserType'](_0x2ca9b6['id'],_0x2e0f19);}async['beforeStartChat'](_0x6b944f,_0x46ed76){const _0x26fc44=_0x5c845b,_0x1b5587=await this['cozeConversationEntity'][_0x26fc44(0x118)]({'where':{'userId':_0x46ed76['user']['id'],'conversationId':_0x6b944f[_0x26fc44(0x1c8)]}});if(!_0x1b5587)throw new common_1[(_0x26fc44(0x136))](_0x26fc44(0xa5),common_1['HttpStatus'][_0x26fc44(0xc4)]);const _0x3d4866=await this[_0x26fc44(0xc1)]['getUserById'](_0x46ed76[_0x26fc44(0xc7)]['id']),_0x26af56=await this[_0x26fc44(0x1da)][_0x26fc44(0x118)]({'where':{'botId':_0x1b5587[_0x26fc44(0x16a)]}});return await this[_0x26fc44(0x1cf)]({'prompt':_0x6b944f[_0x26fc44(0x15e)][_0x26fc44(0x152)](),'user':_0x3d4866,'bot':_0x26af56,'userType':_0x26af56[_0x26fc44(0x1dc)]}),!![];}async['startChat'](_0x3323f8,_0x2076ad,_0x28da02){const _0x10ec21=_0x5c845b;_0x28da02[_0x10ec21(0xaa)]('Content-Type','text/event-stream'),_0x28da02['setHeader']('Transfer-Encoding','chunked'),_0x28da02['setHeader']('Cache-Control',_0x10ec21(0x1a1)),_0x28da02[_0x10ec21(0xaa)]('X-Accel-Buffering','no'),_0x28da02[_0x10ec21(0xaa)](_0x10ec21(0xb0),'*');try{const _0x2156dd=await this[_0x10ec21(0x172)][_0x10ec21(0x118)]({'where':{'userId':_0x2076ad['user']['id'],'conversationId':_0x3323f8['conversationId']}});if(!_0x2156dd){this[_0x10ec21(0xfd)](_0x28da02,{'content':_0x10ec21(0xa5),'contentType':'','isEnd':![],'isError':!![]});return;}const _0x36fac9=await this[_0x10ec21(0x1da)]['findOne']({'where':{'botId':_0x2156dd['botId']}});if(_0x36fac9[_0x10ec21(0x122)]==_0x10ec21(0x1aa)){await this[_0x10ec21(0x166)](_0x3323f8,_0x2076ad,_0x28da02);return;}if(_0x36fac9[_0x10ec21(0x122)]==_0x10ec21(0xfb)){await this[_0x10ec21(0x148)](_0x3323f8,_0x2076ad,_0x28da02);return;}const _0x2abbb4=await this[_0x10ec21(0xc1)][_0x10ec21(0x1d9)](_0x2076ad[_0x10ec21(0xc7)]['id']),_0x217f7b=await this[_0x10ec21(0x1b1)](_0x2076ad[_0x10ec21(0xc7)]['id']),_0x4a533f=await _0x217f7b['bots'][_0x10ec21(0xcd)]({'bot_id':_0x2156dd['botId']});_0x36fac9[_0x10ec21(0xd1)]=_0x4a533f[_0x10ec21(0x154)],_0x36fac9['workflowIdList']=_0x4a533f[_0x10ec21(0x194)],_0x36fac9[_0x10ec21(0x193)]=_0x4a533f[_0x10ec21(0xb3)],await this[_0x10ec21(0x1da)][_0x10ec21(0xb1)](_0x36fac9);const _0x4b114e=await this[_0x10ec21(0xb9)][_0x10ec21(0x118)]({'where':{'modelId':_0x4a533f[_0x10ec21(0x154)][_0x10ec21(0xd9)]}});if(!_0x4b114e){this[_0x10ec21(0xfd)](_0x28da02,{'content':_0x10ec21(0x13d),'contentType':'','isEnd':![],'isError':!![]});return;}await this[_0x10ec21(0x1cf)]({'prompt':_0x3323f8[_0x10ec21(0x15e)][_0x10ec21(0x152)](),'user':_0x2abbb4,'bot':_0x36fac9,'userType':_0x36fac9[_0x10ec21(0x1dc)]});const _0xa218c4=await this['cozeMessageEntity'][_0x10ec21(0x198)]({'where':{'conversationId':_0x3323f8[_0x10ec21(0x1c8)]},'take':0x63,'order':{'id':_0x10ec21(0xad)}});let _0xaae03a=[];_0xa218c4[_0x10ec21(0x1b6)](_0x4c1a52=>{const _0x54a3ac=_0x10ec21;let _0x23983f=_0x4c1a52[_0x54a3ac(0x15e)];_0x4c1a52[_0x54a3ac(0x15a)]==_0x54a3ac(0x1df)&&(_0x23983f=JSON[_0x54a3ac(0x19d)](_0x4c1a52[_0x54a3ac(0xd0)])),_0xaae03a['push']({'role':_0x4c1a52['role'],'content':_0x23983f,'content_type':_0x4c1a52[_0x54a3ac(0x15a)],'type':_0x4c1a52[_0x54a3ac(0xe5)]});});typeof _0x3323f8[_0x10ec21(0x15e)]==='string'?_0xaae03a[_0x10ec21(0x106)]({'content':_0x3323f8[_0x10ec21(0x15e)],'content_type':_0x10ec21(0x10e),'role':_0x10ec21(0xc7),'type':'question'}):_0xaae03a[_0x10ec21(0x106)]({'content':JSON['stringify'](_0x3323f8[_0x10ec21(0x15e)]),'content_type':_0x10ec21(0x1df),'role':'user','type':_0x10ec21(0x1cb)});const _0x346dce=await _0x217f7b['chat'][_0x10ec21(0x14c)]({'bot_id':_0x2156dd[_0x10ec21(0x16a)],'user_id':_0x2076ad[_0x10ec21(0xc7)]['id']['toString'](),'auto_save_history':!![],'additional_messages':_0xaae03a});let _0x17dd3b,_0x12f706='',_0x21a63c='',_0x5e46f3='',_0x1d4a87,_0x45ec8c=[];const _0x44f2de=setInterval(()=>{this['responseMessage'](_0x28da02,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);for await(const _0xac0f9b of _0x346dce){if(_0xac0f9b[_0x10ec21(0xf3)]===api_1['ChatEventType'][_0x10ec21(0x18c)])_0x21a63c=_0x10ec21(0x12f),_0x17dd3b=_0xac0f9b,_0x5e46f3=_0xac0f9b[_0x10ec21(0x165)]['id'];else{if(_0xac0f9b['event']===api_1[_0x10ec21(0x12b)]['CONVERSATION_MESSAGE_DELTA'])_0x12f706+=_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0x15e)],this[_0x10ec21(0xfd)](_0x28da02,{'content':_0xac0f9b['data'][_0x10ec21(0x15e)],'contentType':_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0x1a8)],'isEnd':![],'isError':![]}),_0x21a63c=_0x10ec21(0xea);else{if(_0xac0f9b[_0x10ec21(0xf3)]===api_1[_0x10ec21(0x12b)]['CONVERSATION_MESSAGE_COMPLETED'])_0x21a63c=_0x10ec21(0xea),_0x1d4a87=_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0x1b9)],_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0xe5)]==_0x10ec21(0x1b2)&&_0xac0f9b[_0x10ec21(0x165)]['content']&&(_0x45ec8c['push']({'type':_0xac0f9b['data'][_0x10ec21(0xe5)],'content':JSON[_0x10ec21(0xb8)](_0xac0f9b[_0x10ec21(0x165)]['content'])}),this[_0x10ec21(0xfd)](_0x28da02,{'content':_0xac0f9b[_0x10ec21(0x165)]['content'],'type':_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0xe5)],'contentType':_0xac0f9b[_0x10ec21(0x165)]['content_type'],'isEnd':![],'isError':![],'usage':_0xac0f9b['data'][_0x10ec21(0x1b9)]}));else{if(_0xac0f9b[_0x10ec21(0xf3)]===api_1[_0x10ec21(0x12b)]['CONVERSATION_CHAT_COMPLETED'])_0x21a63c=_0x10ec21(0x1a6),_0x1d4a87=_0xac0f9b[_0x10ec21(0x165)][_0x10ec21(0x1b9)],this[_0x10ec21(0xfd)](_0x28da02,{'content':'','isEnd':!![],'isError':![],'usage':_0xac0f9b[_0x10ec21(0x165)]['usage']});else{if(_0xac0f9b[_0x10ec21(0xf3)]===api_1[_0x10ec21(0x12b)]['DONE'])_0x21a63c='end',this['responseMessage'](_0x28da02,{'content':'','contentType':'','isEnd':!![],'isError':![]});else _0xac0f9b['event']===api_1['ChatEventType']['ERROR']&&(_0x21a63c='error',console['log'](_0x10ec21(0xa2),_0xac0f9b),this[_0x10ec21(0xfd)](_0x28da02,{'content':'','contentType':'','isEnd':![],'isError':!![],'errorData':_0xac0f9b}));}}}}}const _0x1d881d=await this['cozeMessageEntity']['save']({'botId':_0x2156dd[_0x10ec21(0x16a)],'userId':_0x2076ad['user']['id'],'spaceId':this[_0x10ec21(0x10c)],'messageId':_0x5e46f3,'type':_0x10ec21(0x1cb),'contentType':typeof _0x3323f8[_0x10ec21(0x15e)]===_0x10ec21(0xa4)?_0x10ec21(0x10e):_0x10ec21(0x1df),'conversationId':_0x2156dd[_0x10ec21(0x1c8)],'content':typeof _0x3323f8[_0x10ec21(0x15e)]==='string'?_0x3323f8['content']:'','contentObject':typeof _0x3323f8['content']!=='string'?_0x3323f8[_0x10ec21(0x15e)]:[],'role':_0x10ec21(0xc7),'parentId':0x0});await this['cozeMessageEntity'][_0x10ec21(0xb1)]({'botId':_0x2156dd[_0x10ec21(0x16a)],'userId':_0x2076ad[_0x10ec21(0xc7)]['id'],'spaceId':this[_0x10ec21(0x10c)],'messageId':_0x5e46f3,'conversationId':_0x2156dd[_0x10ec21(0x1c8)],'type':_0x10ec21(0x103),'content':_0x12f706,'content_type':_0x10ec21(0x10e),'role':_0x10ec21(0xc6),'usage':_0x1d4a87,'status':_0x21a63c,'parentId':_0x1d881d['id'],'contentObject':_0x45ec8c}),clearInterval(_0x44f2de),await this['userService'][_0x10ec21(0x156)](_0x2076ad[_0x10ec21(0xc7)]['id'],_0x36fac9['id'],_0x36fac9[_0x10ec21(0x145)],_0x36fac9[_0x10ec21(0x1a5)],_0x36fac9[_0x10ec21(0x192)],_0x5e46f3);}catch(_0x4f4664){return console[_0x10ec21(0x13f)](_0x10ec21(0x1a3),_0x4f4664),_0x4f4664;}}async[_0x5c845b(0x166)](_0x2e419d,_0x21c6ff,_0x5c500a){const _0x221e96=_0x5c845b;try{const _0x1c82a5=await this['cozeConversationEntity'][_0x221e96(0x118)]({'where':{'userId':_0x21c6ff[_0x221e96(0xc7)]['id'],'conversationId':_0x2e419d[_0x221e96(0x1c8)]}});if(!_0x1c82a5){this[_0x221e96(0xfd)](_0x5c500a,{'content':_0x221e96(0xa5),'contentType':'','isEnd':![],'isError':!![]});return;}const _0xccac6c=await this['userService'][_0x221e96(0x1d9)](_0x21c6ff[_0x221e96(0xc7)]['id']),_0x559f65=await this[_0x221e96(0x1da)][_0x221e96(0x118)]({'where':{'botId':_0x1c82a5['botId']}});await this[_0x221e96(0x1cf)]({'prompt':_0x2e419d[_0x221e96(0x15e)][_0x221e96(0x152)](),'user':_0xccac6c,'bot':_0x559f65,'userType':_0x559f65[_0x221e96(0x1dc)]});const _0x3bac29=await this[_0x221e96(0x167)][_0x221e96(0x198)]({'where':{'conversationId':_0x2e419d[_0x221e96(0x1c8)]},'take':0x63,'order':{'id':_0x221e96(0xad)}});let _0x39f3d8=[];_0x3bac29[_0x221e96(0x1b6)](_0x160ea4=>{const _0x300f96=_0x221e96;let _0x3da5dd=_0x160ea4[_0x300f96(0x15e)];_0x160ea4[_0x300f96(0x15a)]==_0x300f96(0x1df)&&(_0x3da5dd=JSON[_0x300f96(0x19d)](_0x160ea4[_0x300f96(0xd0)])),_0x39f3d8[_0x300f96(0x106)]({'role':_0x160ea4['role'],'content':_0x3da5dd,'content_type':_0x160ea4['contentType'],'type':_0x160ea4[_0x300f96(0xe5)]});});typeof _0x2e419d[_0x221e96(0x15e)]===_0x221e96(0xa4)?_0x39f3d8[_0x221e96(0x106)]({'content':_0x2e419d[_0x221e96(0x15e)],'content_type':_0x221e96(0x10e),'role':_0x221e96(0xc7),'type':'question'}):_0x39f3d8[_0x221e96(0x106)]({'content':JSON['stringify'](_0x2e419d['content']),'content_type':_0x221e96(0x1df),'role':_0x221e96(0xc7),'type':'question'});let _0x2a9095=null,_0x61f3ee='',_0x1766b6=!![],_0x4b3685='';const _0x51f297=await this[_0x221e96(0x1d8)][_0x221e96(0x100)](_0x221e96(0x182)),_0x54686b=_0x51f297[_0x221e96(0xbe)][_0x221e96(0x16b)],_0x5e35fa=setInterval(()=>{this['responseMessage'](_0x5c500a,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);let _0x189806=await(0x0,zhipu_1['sendMessageFromFastgpt'])([{'role':'user','content':_0x2e419d[_0x221e96(0x15e)]}],{'key':_0x559f65['apiKey'],'chatId':_0x1c82a5[_0x221e96(0x1c8)],'model':_0x559f65[_0x221e96(0xe6)],'apiUrl':_0x54686b,'onProgress':_0x230310=>{const _0x503301=_0x221e96;let _0x1259f6=this[_0x503301(0x174)](_0x5c500a,_0x230310,![]);_0x61f3ee+=_0x1259f6,_0x1766b6=![],_0x2a9095=_0x230310,_0x4b3685=_0x230310['id'];}});this[_0x221e96(0x174)](_0x5c500a,null,!![]);const _0x53840a={'model':_0x559f65[_0x221e96(0xe6)]},_0x8658e8=(0x0,helper_1['unifiedFormattingResponse'])(0x1,_0x189806,_0x53840a),_0x289115=await this[_0x221e96(0x167)][_0x221e96(0xb1)]({'botId':_0x1c82a5[_0x221e96(0x16a)],'userId':_0x21c6ff[_0x221e96(0xc7)]['id'],'spaceId':this['SPACE_ID'],'messageId':_0x4b3685,'type':'question','contentType':typeof _0x2e419d[_0x221e96(0x15e)]===_0x221e96(0xa4)?_0x221e96(0x10e):_0x221e96(0x1df),'conversationId':_0x1c82a5[_0x221e96(0x1c8)],'content':typeof _0x2e419d['content']===_0x221e96(0xa4)?_0x2e419d[_0x221e96(0x15e)]:'','contentObject':typeof _0x2e419d[_0x221e96(0x15e)]!==_0x221e96(0xa4)?_0x2e419d[_0x221e96(0x15e)]:[],'role':_0x221e96(0xc7),'parentId':0x0});await this[_0x221e96(0x167)][_0x221e96(0xb1)]({'botId':_0x1c82a5['botId'],'userId':_0x21c6ff[_0x221e96(0xc7)]['id'],'spaceId':this['SPACE_ID'],'messageId':_0x4b3685,'conversationId':_0x1c82a5[_0x221e96(0x1c8)],'type':_0x221e96(0x103),'content':_0x8658e8[_0x221e96(0x10e)],'content_type':'text','role':_0x221e96(0xc6),'usage':_0x8658e8[_0x221e96(0x1b9)],'status':_0x221e96(0xf2),'parentId':_0x289115['id']}),clearInterval(_0x5e35fa),await this['userService'][_0x221e96(0x156)](_0x21c6ff[_0x221e96(0xc7)]['id'],_0x559f65['id'],_0x559f65[_0x221e96(0x145)],_0x559f65[_0x221e96(0x1a5)],_0x559f65[_0x221e96(0x192)],_0x4b3685,balance_constant_1[_0x221e96(0x128)][_0x221e96(0x120)]);}catch(_0x56b0c7){return console['error'](_0x221e96(0x11d),_0x56b0c7),_0x56b0c7;}}async[_0x5c845b(0x148)](_0x1c02e3,_0x3466ac,_0x5f0bf0){const _0x2f1752=_0x5c845b;try{const _0x4f98fd=await this[_0x2f1752(0x172)]['findOne']({'where':{'userId':_0x3466ac[_0x2f1752(0xc7)]['id'],'conversationId':_0x1c02e3['conversationId']}});if(!_0x4f98fd){this['responseMessage'](_0x5f0bf0,{'content':_0x2f1752(0xa5),'contentType':'','isEnd':![],'isError':!![]});return;}const _0x86e91b=await this[_0x2f1752(0xc1)][_0x2f1752(0x1d9)](_0x3466ac[_0x2f1752(0xc7)]['id']),_0x40483c=await this[_0x2f1752(0x1da)][_0x2f1752(0x118)]({'where':{'botId':_0x4f98fd['botId']}});await this[_0x2f1752(0x1cf)]({'prompt':_0x1c02e3[_0x2f1752(0x15e)]['toString'](),'user':_0x86e91b,'bot':_0x40483c,'userType':_0x40483c['userType']});const _0x547e3b=await this[_0x2f1752(0x167)]['find']({'where':{'conversationId':_0x1c02e3[_0x2f1752(0x1c8)]},'take':0x63,'order':{'id':_0x2f1752(0xad)}});let _0x5b398e=[];_0x547e3b[_0x2f1752(0x1b6)](_0x1b8806=>{const _0x131c81=_0x2f1752;let _0x55eb0b=_0x1b8806['content'];_0x1b8806[_0x131c81(0x15a)]==_0x131c81(0x1df)&&(_0x55eb0b=JSON[_0x131c81(0x19d)](_0x1b8806[_0x131c81(0xd0)])),_0x5b398e[_0x131c81(0x106)]({'role':_0x1b8806[_0x131c81(0x13c)],'content':_0x55eb0b,'content_type':_0x1b8806[_0x131c81(0x15a)],'type':_0x1b8806[_0x131c81(0xe5)]});});typeof _0x1c02e3[_0x2f1752(0x15e)]==='string'?_0x5b398e[_0x2f1752(0x106)]({'content':_0x1c02e3[_0x2f1752(0x15e)],'content_type':_0x2f1752(0x10e),'role':_0x2f1752(0xc7),'type':_0x2f1752(0x1cb)}):_0x5b398e[_0x2f1752(0x106)]({'content':JSON['stringify'](_0x1c02e3['content']),'content_type':_0x2f1752(0x1df),'role':_0x2f1752(0xc7),'type':_0x2f1752(0x1cb)});let _0x4bdd32=null,_0x5599f4='',_0x3fbc09=!![],_0x244a6f='';const _0x32a082=await this[_0x2f1752(0x1d8)][_0x2f1752(0x100)](_0x2f1752(0x182)),_0x1dd733=_0x32a082[_0x2f1752(0xbe)][_0x2f1752(0x1a9)],_0x571764=setInterval(()=>{this['responseMessage'](_0x5f0bf0,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);let _0x491d03;try{_0x491d03=await(0x0,zhipu_1[_0x2f1752(0xd8)])({'apiKey':_0x40483c[_0x2f1752(0x12c)],'apiUrl':_0x1dd733,'query':_0x1c02e3['content']['toString'](),'chatId':_0x4f98fd[_0x2f1752(0xcc)]||'','userId':_0x3466ac[_0x2f1752(0xc7)]['id'][_0x2f1752(0x152)](),'onProgress':_0x19e3f5=>{const _0x44cdb0=_0x2f1752;let _0xd08200=this[_0x44cdb0(0x174)](_0x5f0bf0,_0x19e3f5,![]);_0x5599f4+=_0xd08200,_0x3fbc09=![],_0x4bdd32=_0x19e3f5,_0x244a6f=_0x19e3f5['id'];}});}catch(_0x28b60d){console[_0x2f1752(0x119)](_0x2f1752(0xe3),_0x28b60d);}!_0x4f98fd[_0x2f1752(0xcc)]&&(_0x4f98fd[_0x2f1752(0xcc)]=_0x491d03['id'],this[_0x2f1752(0x172)]['save'](_0x4f98fd));this[_0x2f1752(0x174)](_0x5f0bf0,null,!![]);const _0xcdb101={'model':_0x2f1752(0xe7)},_0x4dfa55=(0x0,helper_1[_0x2f1752(0x10a)])(0x1,_0x491d03,_0xcdb101),_0x23df0a=await this[_0x2f1752(0x167)][_0x2f1752(0xb1)]({'botId':_0x4f98fd[_0x2f1752(0x16a)],'userId':_0x3466ac[_0x2f1752(0xc7)]['id'],'spaceId':this[_0x2f1752(0x10c)],'messageId':_0x244a6f,'type':_0x2f1752(0x1cb),'contentType':typeof _0x1c02e3[_0x2f1752(0x15e)]==='string'?_0x2f1752(0x10e):_0x2f1752(0x1df),'conversationId':_0x4f98fd['conversationId'],'content':typeof _0x1c02e3[_0x2f1752(0x15e)]===_0x2f1752(0xa4)?_0x1c02e3[_0x2f1752(0x15e)]:'','contentObject':typeof _0x1c02e3['content']!=='string'?_0x1c02e3['content']:[],'role':_0x2f1752(0xc7),'parentId':0x0});await this['cozeMessageEntity'][_0x2f1752(0xb1)]({'botId':_0x4f98fd[_0x2f1752(0x16a)],'userId':_0x3466ac[_0x2f1752(0xc7)]['id'],'spaceId':this[_0x2f1752(0x10c)],'messageId':_0x244a6f,'conversationId':_0x4f98fd[_0x2f1752(0x1c8)],'type':_0x2f1752(0x103),'content':_0x4dfa55[_0x2f1752(0x10e)],'content_type':_0x2f1752(0x10e),'role':'assistant','usage':_0x4dfa55['usage'],'status':_0x2f1752(0xf2),'parentId':_0x23df0a['id']}),clearInterval(_0x571764),await this[_0x2f1752(0xc1)][_0x2f1752(0x156)](_0x3466ac[_0x2f1752(0xc7)]['id'],_0x40483c['id'],_0x40483c['name'],_0x40483c[_0x2f1752(0x1a5)],_0x40483c[_0x2f1752(0x192)],_0x244a6f,balance_constant_1[_0x2f1752(0x128)]['DifyBot']);}catch(_0xce0754){return console[_0x2f1752(0x13f)](_0x2f1752(0x11d),_0xce0754),_0xce0754;}}[_0x5c845b(0x174)](_0xabb577,_0x4eff06,_0x53ce30){const _0xccf4b4=_0x5c845b;if(_0x53ce30){let _0x589def={};_0x589def[_0xccf4b4(0x1c3)]=!![],_0x589def[_0xccf4b4(0x15e)]='',_0x589def[_0xccf4b4(0x15a)]='',_0x589def['think']='',_0xabb577[_0xccf4b4(0xa3)](_0xccf4b4(0x171)+JSON[_0xccf4b4(0x19d)](_0x589def)+'\x0a\x0a');return;}let _0xe394b='',_0x3ab382='';_0x4eff06[_0xccf4b4(0x17c)][_0xccf4b4(0xdf)][_0xccf4b4(0x170)]&&_0x4eff06[_0xccf4b4(0x17c)][_0xccf4b4(0xdf)][_0xccf4b4(0x1b6)](_0x79780f=>{const _0xebec09=_0xccf4b4;_0x79780f[_0xebec09(0xea)]?.[_0xebec09(0xf6)]&&(_0x3ab382+=_0x79780f['delta'][_0xebec09(0xf6)]),_0x79780f[_0xebec09(0xea)]?.[_0xebec09(0x15e)]&&(_0xe394b+=_0x79780f[_0xebec09(0xea)]['content']);});let _0x56613f={};return _0x56613f[_0xccf4b4(0x15e)]=_0xe394b,_0x56613f['contentType']=_0xccf4b4(0x10e),_0x56613f['id']=_0x4eff06['id'],_0x56613f[_0xccf4b4(0x1c3)]=_0x53ce30,_0x56613f['think']=_0x3ab382,_0xabb577[_0xccf4b4(0xa3)](_0xccf4b4(0x171)+JSON[_0xccf4b4(0x19d)](_0x56613f)+'\x0a\x0a'),_0x3ab382;}async[_0x5c845b(0x19f)](_0x3e0c82){const _0x5acf78=_0x5c845b,_0x376d85={'isRelease':0x1};_0x3e0c82['search']&&(_0x376d85[_0x5acf78(0x145)]=(0x0,typeorm_2[_0x5acf78(0xe0)])('%'+_0x3e0c82[_0x5acf78(0x177)]+'%'));const [_0x2472ad,_0x190423]=await this[_0x5acf78(0xa9)][_0x5acf78(0x18a)]({'where':_0x376d85,'order':{'id':_0x5acf78(0x1d1)},'skip':(_0x3e0c82[_0x5acf78(0x132)]-0x1)*_0x3e0c82[_0x5acf78(0x1c5)],'take':_0x3e0c82[_0x5acf78(0x1c5)]});return{'rows':_0x2472ad,'count':_0x190423};}async[_0x5c845b(0x1b3)](){const _0x3de9e8=_0x5c845b,_0x1187f2=await this[_0x3de9e8(0x1b1)]('');let _0x4c6535=0x1;while(!![]){const _0x563427=await this[_0x3de9e8(0xf0)][_0x3de9e8(0x198)]({'where':{'spaceId':this[_0x3de9e8(0x10c)]}});let _0x4c0899=await _0x1187f2[_0x3de9e8(0x183)][_0x3de9e8(0x115)]({'space_id':this[_0x3de9e8(0x10c)],'page_num':_0x4c6535,'page_size':0x12c});await new Promise(_0x491148=>setTimeout(_0x491148,0x3e8));if(!_0x4c0899[_0x3de9e8(0x1b8)]||_0x4c0899[_0x3de9e8(0x1b8)][_0x3de9e8(0x170)]==0x0)break;_0x4c0899=_0x4c0899[_0x3de9e8(0x1b8)][_0x3de9e8(0xe2)](_0x13d459=>_0x563427['map'](_0x5b9a37=>_0x5b9a37[_0x3de9e8(0x18d)])[_0x3de9e8(0xda)](_0x13d459[_0x3de9e8(0xa6)]));for(let _0x336b80 of _0x4c0899){await this[_0x3de9e8(0xf0)][_0x3de9e8(0x14a)]({'knowledgeId':_0x336b80[_0x3de9e8(0xa6)]},{'botUsedCount':_0x336b80[_0x3de9e8(0xf5)],'processingFileList':_0x336b80['processing_file_list'],'failedFileList':_0x336b80[_0x3de9e8(0x190)],'formatType':_0x336b80['format_type'],'processingFileIdList':_0x336b80[_0x3de9e8(0x12e)],'allFileSize':_0x336b80['all_file_size'],'hitCount':_0x336b80[_0x3de9e8(0x18e)],'docCount':_0x336b80['doc_count'],'fileList':_0x336b80['file_list'],'chunkStrategy':_0x336b80[_0x3de9e8(0x1d0)]});let _0x2f5142=0x1;while(!![]){const _0x4e20fb=await _0x1187f2[_0x3de9e8(0x183)][_0x3de9e8(0x108)][_0x3de9e8(0x115)]({'dataset_id':_0x336b80[_0x3de9e8(0xa6)],'page':_0x2f5142,'page_size':0x12c});if(!_0x4e20fb[_0x3de9e8(0x1a0)]||_0x4e20fb['document_infos'][_0x3de9e8(0x170)]==0x0)break;for(let _0x56be21 of _0x4e20fb['document_infos']){await this['knowledgeDocumentEntity'][_0x3de9e8(0x14a)]({'documentId':_0x56be21[_0x3de9e8(0xb5)]},{'charCount':_0x56be21[_0x3de9e8(0x186)],'status':_0x56be21['status'],'chunkStrategy':_0x56be21[_0x3de9e8(0x1d0)],'formatType':_0x56be21[_0x3de9e8(0x169)],'hitCount':_0x56be21[_0x3de9e8(0x18e)],'size':_0x56be21[_0x3de9e8(0x1c5)],'sliceCount':_0x56be21[_0x3de9e8(0x1ac)],'sourceType':_0x56be21[_0x3de9e8(0xb4)],'type':_0x56be21['type'],'docTreeTosUrl':_0x56be21[_0x3de9e8(0xab)],'previewTosUrl':_0x56be21[_0x3de9e8(0xe4)],'webUrl':_0x56be21[_0x3de9e8(0x1d4)]});}_0x2f5142++;}}_0x4c6535++;}}async[_0x5c845b(0x16f)](){const _0x3b5dbe=_0x5c845b,_0x40819e=await this[_0x3b5dbe(0x1b1)](''),_0x529aa5=await this['knowledgeDocumentEntity'][_0x3b5dbe(0x198)]({'where':{'progress':(0x0,typeorm_2[_0x3b5dbe(0x114)])(0x64)}});if(_0x529aa5['length'])for(let _0x58a4af of _0x529aa5){const _0x32f9f6=await _0x40819e['datasets'][_0x3b5dbe(0x111)](_0x58a4af[_0x3b5dbe(0x18d)],{'document_ids':[_0x58a4af['documentId']]});if(_0x32f9f6[_0x3b5dbe(0x165)][_0x3b5dbe(0x170)])for(let _0x3de8ee of _0x32f9f6[_0x3b5dbe(0x165)]){await this[_0x3b5dbe(0x133)]['update']({'documentId':_0x3de8ee[_0x3b5dbe(0xb5)]},{'progress':_0x3de8ee['progress'],'size':_0x3de8ee[_0x3b5dbe(0x1c5)],'remainingTime':_0x3de8ee['remaining_time'],'statusDescript':_0x3de8ee[_0x3b5dbe(0x141)]});}}}async[_0x5c845b(0x12d)](){const _0x4d45a2=_0x5c845b,_0x8f4b7d=await this[_0x4d45a2(0x1b1)]('');let _0x57e31a=0x1;while(!![]){const _0x16724d=await _0x8f4b7d['bots']['list']({'space_id':this['SPACE_ID'],'page_index':_0x57e31a});if(!_0x16724d[_0x4d45a2(0xa8)]['length'])break;for(let _0x54a594=0x0;_0x54a594<_0x16724d['space_bots'][_0x4d45a2(0x170)];_0x54a594++){console['log'](_0x4d45a2(0x104),_0x16724d[_0x4d45a2(0xa8)][_0x54a594]['bot_id']);const _0x497b86=await this[_0x4d45a2(0x1da)][_0x4d45a2(0x118)]({'where':{'botId':_0x16724d['space_bots'][_0x54a594][_0x4d45a2(0xbb)]}});if(!_0x497b86){const _0x2d09ff=await this[_0x4d45a2(0x130)](_0x16724d[_0x4d45a2(0xa8)][_0x54a594][_0x4d45a2(0x124)]);console['log'](_0x4d45a2(0xec),_0x2d09ff),await this[_0x4d45a2(0x1da)][_0x4d45a2(0xb1)]({'spaceId':this['SPACE_ID'],'botId':_0x16724d[_0x4d45a2(0xa8)][_0x54a594]['bot_id'],'name':_0x16724d['space_bots'][_0x54a594][_0x4d45a2(0x146)],'description':_0x16724d[_0x4d45a2(0xa8)][_0x54a594][_0x4d45a2(0xee)],'iconFileUrl':_0x2d09ff,'isRelease':0x1,'publish_flag':0x0});}}_0x57e31a++,console[_0x4d45a2(0x119)](_0x4d45a2(0xd3)+_0x16724d[_0x4d45a2(0x1be)]+'】条，当前【'+_0x57e31a+_0x4d45a2(0x151),_0x57e31a);}var _0x458138=await this[_0x4d45a2(0x1da)]['find']({'where':{'userId':0x0,'botType':(0x0,typeorm_2[_0x4d45a2(0x150)])((0x0,typeorm_2['In'])([_0x4d45a2(0xfb),_0x4d45a2(0x1aa)]))}});for(let _0x56c262=0x0;_0x56c262<_0x458138[_0x4d45a2(0x170)];_0x56c262++){const _0x55b85=await _0x8f4b7d[_0x4d45a2(0x1c6)][_0x4d45a2(0xcd)]({'bot_id':_0x458138[_0x56c262][_0x4d45a2(0x16a)]});_0x55b85&&(_0x458138[_0x56c262][_0x4d45a2(0x193)]=_0x55b85[_0x4d45a2(0xb3)],_0x458138[_0x56c262][_0x4d45a2(0x1a7)]=_0x55b85[_0x4d45a2(0x16d)],_0x458138[_0x56c262][_0x4d45a2(0xd1)]=_0x55b85['model_info'],_0x458138[_0x56c262][_0x4d45a2(0xb7)]=_0x55b85[_0x4d45a2(0x194)],await this[_0x4d45a2(0x1da)]['save'](_0x458138[_0x56c262]));}console[_0x4d45a2(0x119)](_0x4d45a2(0x10f));}async[_0x5c845b(0x130)](_0x2a308e){const _0x2609ab=_0x5c845b;try{const _0x530669=await(0x0,axios_1[_0x2609ab(0x1cd)])({'url':_0x2a308e,'method':'GET','responseType':_0x2609ab(0x14c),'headers':{'Accept-Encoding':'identity'}}),_0xca3ab5=_0x530669[_0x2609ab(0x165)];let _0x15b636=(0x0,uuid_1['v4'])();const _0x3b26f8=await this[_0x2609ab(0x195)][_0x2609ab(0x1ba)]({'filename':_0x15b636,'buffer':_0xca3ab5});return _0x3b26f8;}catch(_0x530a52){console[_0x2609ab(0x119)](_0x2609ab(0x19a),_0x530a52);}return null;}async[_0x5c845b(0x113)](_0x118ddf,_0x1d9103){const _0x425e15=_0x5c845b,_0x3a75fd=_0x118ddf[_0x425e15(0xc7)]?.['id'],_0x109773=await this['cozeConversationEntity'][_0x425e15(0x118)]({'where':{'userId':_0x118ddf[_0x425e15(0xc7)]['id'],'conversationId':_0x1d9103[_0x425e15(0x1c8)]}});if(!_0x109773)throw new common_1[(_0x425e15(0x136))](_0x425e15(0xa5),common_1[_0x425e15(0x13e)]['BAD_REQUEST']);const _0x544656=await this['getCozeApi'](_0x118ddf['user']['id']),_0x7034f4=await _0x544656[_0x425e15(0x1c6)][_0x425e15(0xcd)]({'bot_id':_0x109773[_0x425e15(0x16a)]}),_0xe8ff25=await this[_0x425e15(0xb9)][_0x425e15(0x118)]({'where':{'modelId':_0x7034f4[_0x425e15(0x154)][_0x425e15(0xd9)]}});if(!_0xe8ff25)throw new common_1['HttpException'](_0x425e15(0x11f),common_1[_0x425e15(0x13e)][_0x425e15(0xc4)]);if(!_0x3a75fd)return{'remainCount':0x0,'freeCount':0x0,'isVipFree':_0xe8ff25[_0x425e15(0x1a5)]==-0x1,'useIntegrate':_0xe8ff25[_0x425e15(0x192)]};return{'remainCount':await this[_0x425e15(0xc1)][_0x425e15(0x147)](_0x3a75fd,_0xe8ff25[_0x425e15(0xb2)],_0xe8ff25[_0x425e15(0x1a5)]),'freeCount':_0xe8ff25['vipFreeNum'],'isVipFree':_0xe8ff25['vipFreeNum']==-0x1,'useIntegrate':_0xe8ff25['deduct']};}};CozeService=__decorate([(0x0,common_1[_0x5c845b(0x1d7)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(bot_entity_1[_0x5c845b(0x1ae)])),__param(0x1,(0x0,typeorm_1[_0x5c845b(0x1ad)])(knowledge_entity_1[_0x5c845b(0xdd)])),__param(0x2,(0x0,typeorm_1[_0x5c845b(0x1ad)])(knowledgedocument_entity_1[_0x5c845b(0xd5)])),__param(0x3,(0x0,typeorm_1[_0x5c845b(0x1ad)])(model_entity_1[_0x5c845b(0x1bd)])),__param(0x4,(0x0,typeorm_1[_0x5c845b(0x1ad)])(conversation_entity_1[_0x5c845b(0x19e)])),__param(0x5,(0x0,typeorm_1['InjectRepository'])(message_entity_1[_0x5c845b(0x163)])),__param(0x6,(0x0,typeorm_1[_0x5c845b(0x1ad)])(workflow_entity_1['CozeWorkflowEntity'])),__param(0x7,(0x0,typeorm_1[_0x5c845b(0x1ad)])(user_entity_1[_0x5c845b(0x162)])),__metadata(_0x5c845b(0x1d6),[typeorm_2[_0x5c845b(0x1c9)],typeorm_2[_0x5c845b(0x1c9)],typeorm_2[_0x5c845b(0x1c9)],typeorm_2[_0x5c845b(0x1c9)],typeorm_2['Repository'],typeorm_2[_0x5c845b(0x1c9)],typeorm_2[_0x5c845b(0x1c9)],typeorm_2[_0x5c845b(0x1c9)],user_service_1[_0x5c845b(0x1c2)],badwords_service_1[_0x5c845b(0x1ca)],cm_service_1['CmConfigService'],file_service_1[_0x5c845b(0xbc)]])],CozeService),exports['CozeService']=CozeService;