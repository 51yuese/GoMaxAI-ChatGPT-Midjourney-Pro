'use strict';function _0x6e13(_0x1dea88,_0x53d807){const _0x1c2c03=_0x1c2c();return _0x6e13=function(_0x6e1344,_0x4102f5){_0x6e1344=_0x6e1344-0xab;let _0x4ea9c7=_0x1c2c03[_0x6e1344];return _0x4ea9c7;},_0x6e13(_0x1dea88,_0x53d807);}function _0x1c2c(){const _0x57f287=['getConversationList','no-cache','getMessageList','name','CmConfigService','CozeAPI','Access-Control-Allow-Origin','1024','GET','access_token','getOwnPropertyDescriptor','responseMessage','bot_id','text','__esModule','dataset_list','useCount','-----------------------------------createKnowledgeERROR----------','nickname','publishBot','onboardingInfo','47728rSdFSG','UserEntity','CozeKnowledgeEntity','workflow_info_list','getRemoteFileStream','createKnowledgeDocument','Cache-Control','process','deduct','isArray','userEntity','hot','1033274LTSjFs','data','SPACE_ID','error','bots','uploadFile','stringify','toString','includes','hit_count','-------------获取智能体列表:共【','botEntity','fileUrl','stream','type','modelInfoConfig','onboarding_info','tags','chunk_strategy','10734cRWlnL','rows','uncollect','BadwordsService','documentBases','status','cozeMessageEntity','Like','updateKnowledgeDocument','85WZluOD','../badwords/badwords.service','256779KLPmIJ','InjectRepository','spaceId','datasets','preview_tos_url','./entity/message.entity','api','X-Accel-Buffering','findOne','default','collect','document_id','function_call','UserCollectType','uploadUrlToServer','string','findAndCount','client.datasets.document.create','---------------当前智能体图标-------------','forEach','-----------------获取智能体失败----------','-----------------------------------uploadUrlToServerError----------','decorate','fileId','---------------------------CozeChatError--------------------------','knowledgeEntity','filter','3252020YRaajA','CONVERSATION_MESSAGE_DELTA','974262YIIOoI','6FshzLj','CozeModelEntity','CozeKnowledgeDocumentEntity','relId','botId','create','list','-------------智能体同步完成','获取智能体失败','isRelease','CozeWorkflowEntity','keyid','model_id','privateKey','@nestjs/common','save','7474575122028871720','length','./entity/workflow.entity','space_bots','conversations','fileService','17983bYebZM','isTop','CozeConversationEntity','请求失败，状态码:\x20','publish','user','total','../user/user.entity','char_count','delta','createConversation','CONVERSATION_MESSAGE_COMPLETED','getJwtToken','../user/user.service','content_type','parse','iconFileId','defineProperty','doc_count','智能体不存在！','client.datasets.document.delete','cozeWorkflowEntity','tag','created','deleteBot','object','function','description','createKnowledge','bot_used_count','knowledgeDocumentEntity','axios','updateRule','size','getModelFree','format_type','-----------------------updateBotErr--------------','uuid','processing_file_id_list','web_url','DESC','文档不存在！','getBot','count','documents','files','./entity/bot.entity','log','getWorkflowList','getChatBotList','model_info','batchKnowledgeResult','completed','event','text/event-stream','checkBadWords','mergeCollectData','getUserById','question','upload','batchKnowledgeProgressResult','knowledgeId','identity','】页-----------','api.coze.cn','CozeApiConfig','progress','CozeService','@nestjs/typeorm','page','BAD_REQUEST','cozeModelEntity','getCozeModelVipFree','getKnowledegeDocument','__param','update','find','badwordsService','avatar','error\x20from\x20startChat!','当前智能体未匹配到对应模型，暂无法使用，请联系管理员添加','999','delete','getCozeApi','collectBotList','---------------当前智能体ID-------------','client.datasets.process','updateKnowledge','desc','deleteConversation','map','end','userService','__metadata','source_type','remaining_time','setHeader','DONE','answer','会话不存在','-----------------------------------uploadForUrlERROR----------','processing_file_list','知识库不存在！','-----------------------CreateBotError---------------------------','conversationId','findBy','usage','startChat','promptInfo','failed_file_list','pluginIdList','contentObject','icon_url','push','documentId','document_infos','vipFreeNum','search','deleteKnowledgeDocument','ChatEventType','uploadForUrl','--------------------------------------------------client.upload','role','getJWTToken','https://api.coze.cn','COZEBOT','chat','cmService','__decorate','HttpStatus','knowledge','topConversation','modelId','987gofrpn','cozeConversationEntity','content','Guid','getMyBotList','CozeBotEntity','collectPage','message','UserService','validateBalance4Coze','typeorm','doc_tree_tos_url','now','appId','HttpException','contentType','FileService','document_name','userId','collectBot','messages','24TgrBaN','workflowIdList','getModelList','Repository','retrieve','https','object_string','dataset_id','getKnowledgeList','iconFileUrl','createBot'];_0x1c2c=function(){return _0x57f287;};return _0x1c2c();}const _0x435b2e=_0x6e13;(function(_0x3fd808,_0xa151f9){const _0x9780a=_0x6e13,_0x557706=_0x3fd808();while(!![]){try{const _0x57d22b=parseInt(_0x9780a(0x170))/0x1*(-parseInt(_0x9780a(0x15a))/0x2)+-parseInt(_0x9780a(0x159))/0x3+parseInt(_0x9780a(0x112))/0x4*(-parseInt(_0x9780a(0x13a))/0x5)+-parseInt(_0x9780a(0x131))/0x6*(-parseInt(_0x9780a(0xdd))/0x7)+parseInt(_0x9780a(0xf2))/0x8*(parseInt(_0x9780a(0x13c))/0x9)+parseInt(_0x9780a(0x157))/0xa+parseInt(_0x9780a(0x11e))/0xb;if(_0x57d22b===_0xa151f9)break;else _0x557706['push'](_0x557706['shift']());}catch(_0x2570c5){_0x557706['push'](_0x557706['shift']());}}}(_0x1c2c,0x2ad47));var __decorate=this&&this[_0x435b2e(0xd8)]||function(_0x1f332e,_0x19dcce,_0x3331bd,_0x5841a8){const _0x5ccafb=_0x435b2e;var _0x1dfd4f=arguments[_0x5ccafb(0x16b)],_0x1555e6=_0x1dfd4f<0x3?_0x19dcce:_0x5841a8===null?_0x5841a8=Object[_0x5ccafb(0x107)](_0x19dcce,_0x3331bd):_0x5841a8,_0x3aca5f;if(typeof Reflect===_0x5ccafb(0x189)&&typeof Reflect[_0x5ccafb(0x152)]===_0x5ccafb(0x18a))_0x1555e6=Reflect[_0x5ccafb(0x152)](_0x1f332e,_0x19dcce,_0x3331bd,_0x5841a8);else{for(var _0x252052=_0x1f332e[_0x5ccafb(0x16b)]-0x1;_0x252052>=0x0;_0x252052--)if(_0x3aca5f=_0x1f332e[_0x252052])_0x1555e6=(_0x1dfd4f<0x3?_0x3aca5f(_0x1555e6):_0x1dfd4f>0x3?_0x3aca5f(_0x19dcce,_0x3331bd,_0x1555e6):_0x3aca5f(_0x19dcce,_0x3331bd))||_0x1555e6;}return _0x1dfd4f>0x3&&_0x1555e6&&Object[_0x5ccafb(0x181)](_0x19dcce,_0x3331bd,_0x1555e6),_0x1555e6;},__metadata=this&&this[_0x435b2e(0xb5)]||function(_0x48e6c4,_0x284fe6){const _0x2ee3a4=_0x435b2e;if(typeof Reflect===_0x2ee3a4(0x189)&&typeof Reflect['metadata']===_0x2ee3a4(0x18a))return Reflect['metadata'](_0x48e6c4,_0x284fe6);},__param=this&&this[_0x435b2e(0x1ba)]||function(_0x294743,_0x2af0c1){return function(_0xa5934,_0x362535){_0x2af0c1(_0xa5934,_0x362535,_0x294743);};};Object[_0x435b2e(0x181)](exports,_0x435b2e(0x10b),{'value':!![]}),exports[_0x435b2e(0x1b3)]=void 0x0;const common_1=require(_0x435b2e(0x168)),typeorm_1=require(_0x435b2e(0x1b4)),typeorm_2=require(_0x435b2e(0xe7)),bot_entity_1=require(_0x435b2e(0x19e)),knowledge_entity_1=require('./entity/knowledge.entity'),knowledgedocument_entity_1=require('./entity/knowledgedocument.entity'),api_1=require('@coze/api'),model_entity_1=require('./entity/model.entity'),guid_typescript_1=require('guid-typescript'),https_1=require(_0x435b2e(0xf7)),axios_1=require(_0x435b2e(0x18f)),conversation_entity_1=require('./entity/conversation.entity'),message_entity_1=require(_0x435b2e(0x141)),user_entity_1=require(_0x435b2e(0x177)),user_service_1=require(_0x435b2e(0x17d)),collectType_constant_1=require('../../common/constants/collectType.constant'),badwords_service_1=require(_0x435b2e(0x13b)),workflow_entity_1=require(_0x435b2e(0x16c)),cm_service_1=require('../cmConfig/cm.service'),file_service_1=require('../file/file.service'),uuid_1=require(_0x435b2e(0x195));let CozeService=class CozeService{constructor(_0x5c7bf1,_0x5957e7,_0x5b7dd0,_0x1af149,_0x4c7b50,_0x5714b8,_0x216374,_0x4bfcba,_0x473dff,_0x49df07,_0x2327eb,_0x4d8fbd){const _0x20211b=_0x435b2e;this[_0x20211b(0x129)]=_0x5c7bf1,this['knowledgeEntity']=_0x5957e7,this['knowledgeDocumentEntity']=_0x5b7dd0,this[_0x20211b(0x1b7)]=_0x1af149,this[_0x20211b(0xde)]=_0x4c7b50,this[_0x20211b(0x137)]=_0x5714b8,this['cozeWorkflowEntity']=_0x216374,this[_0x20211b(0x11c)]=_0x4bfcba,this[_0x20211b(0xb4)]=_0x473dff,this[_0x20211b(0x1bd)]=_0x49df07,this['cmService']=_0x2327eb,this[_0x20211b(0x16f)]=_0x4d8fbd,this[_0x20211b(0x120)]=_0x20211b(0x16a);}async[_0x435b2e(0x17c)](_0x5e74e8){const _0x5b50a1=_0x435b2e;try{const _0x476ee7=await this[_0x5b50a1(0xd7)]['getValue'](_0x5b50a1(0x1b1)),_0x5e48fb=_0x476ee7[_0x5b50a1(0x142)][_0x5b50a1(0x167)],_0x9a2c6d=_0x476ee7[_0x5b50a1(0x142)][_0x5b50a1(0xea)],_0x2cdfc0=_0x476ee7[_0x5b50a1(0x142)][_0x5b50a1(0x165)];this[_0x5b50a1(0x120)]=_0x476ee7[_0x5b50a1(0x142)][_0x5b50a1(0x13e)];let _0x456f3b=await(0x0,api_1[_0x5b50a1(0xd3)])({'baseURL':'https://api.coze.cn','appId':_0x9a2c6d,'aud':_0x5b50a1(0x1b0),'keyid':_0x2cdfc0,'privateKey':_0x5e48fb,'sessionName':_0x5e74e8+''});return _0x456f3b;}catch(_0x3b0723){return{'expires_in':0x0,'access_token':''};}}async['getCozeApi'](_0x23939f){const _0x21f276=_0x435b2e;let _0x3d93f2=await this['getJwtToken'](_0x23939f);const _0x3b078b=new api_1[(_0x21f276(0x102))]({'baseURL':_0x21f276(0xd4),'token':async()=>{const _0x52bd1a=_0x21f276;if(_0x3d93f2['expires_in']*0x3e8>Date[_0x52bd1a(0xe9)]()+0x1388)return _0x3d93f2['access_token'];return _0x3d93f2=await this[_0x52bd1a(0x17c)](_0x23939f),_0x3d93f2[_0x52bd1a(0x106)];}});return _0x3b078b;}async[_0x435b2e(0xfc)](_0xfc7b5,_0x3d02cf){const _0x29fff3=_0x435b2e;if(_0xfc7b5[_0x29fff3(0xfb)]){const _0x429ebd=await this['uploadForUrl'](_0xfc7b5[_0x29fff3(0xfb)]);_0xfc7b5[_0x29fff3(0x180)]=_0x429ebd['id'];}try{const _0x234094=await this[_0x29fff3(0xab)](_0x3d02cf['user']['id']),_0x56fb26=await _0x234094[_0x29fff3(0x122)]['create']({'prompt_info':_0xfc7b5['promptInfo'],'onboarding_info':_0xfc7b5['onboardingInfo'],'name':_0xfc7b5['name'],'description':_0xfc7b5[_0x29fff3(0x18b)],'icon_file_id':_0xfc7b5[_0x29fff3(0x180)],'space_id':this[_0x29fff3(0x120)]});return _0xfc7b5[_0x29fff3(0x15e)]=_0x56fb26[_0x29fff3(0x109)],_0xfc7b5[_0x29fff3(0xef)]=_0x3d02cf['user']['id'],_0xfc7b5['spaceId']=this['SPACE_ID'],await this[_0x29fff3(0x129)]['save'](_0xfc7b5),_0xfc7b5;}catch(_0x36cf3c){console[_0x29fff3(0x19f)](_0x29fff3(0xbf),_0x36cf3c);}}async[_0x435b2e(0x19a)](_0x48dbae,_0x2838a8){const _0x19ef64=_0x435b2e;try{const _0x1af88f=await this[_0x19ef64(0x129)][_0x19ef64(0x144)]({'where':{'botId':_0x48dbae}});if(!_0x1af88f||_0x1af88f[_0x19ef64(0xef)]!=0x0&&_0x1af88f[_0x19ef64(0xef)]!=_0x2838a8[_0x19ef64(0x175)]['id'])throw new common_1[(_0x19ef64(0xeb))](_0x19ef64(0x183),common_1[_0x19ef64(0xd9)]['BAD_REQUEST']);const _0x1b692c=await this['getCozeApi'](_0x2838a8[_0x19ef64(0x175)]['id']);if(_0x1af88f[_0x19ef64(0x163)]==0x1){const _0x350260=await _0x1b692c['bots'][_0x19ef64(0xf6)]({'bot_id':_0x48dbae});_0x1af88f[_0x19ef64(0x12d)]=_0x350260[_0x19ef64(0x1a2)],_0x1af88f[_0x19ef64(0xf3)]=_0x350260[_0x19ef64(0x115)],_0x1af88f['onboardingInfo']=_0x350260[_0x19ef64(0x12e)],_0x1af88f['viewCount']+=0x1,await this['botEntity'][_0x19ef64(0x169)](_0x1af88f);}return _0x1af88f;}catch(_0x2d434e){console[_0x19ef64(0x19f)](_0x19ef64(0x150),_0x2d434e);throw new common_1[(_0x19ef64(0xeb))](_0x19ef64(0x162),common_1[_0x19ef64(0xd9)][_0x19ef64(0x1b6)]);}}async['updateBot'](_0x884576,_0xc951b1){const _0x10b008=_0x435b2e,_0x327462=await this['botEntity']['findOne']({'where':{'botId':_0x884576[_0x10b008(0x15e)]}});if(!_0x327462)throw new Error(_0x10b008(0x183));if(_0x327462[_0x10b008(0xfb)]!=_0x884576[_0x10b008(0xfb)]){const _0x4cd91a=await this[_0x10b008(0xd0)](_0x884576[_0x10b008(0xfb)]);_0x884576['iconFileId']=_0x4cd91a['id'];}try{const _0x214ee0=await this['getCozeApi'](_0xc951b1[_0x10b008(0x175)]['id']);Array[_0x10b008(0x11b)](_0x327462[_0x10b008(0xf3)])&&(_0x884576[_0x10b008(0xf3)]={'ids':_0x327462[_0x10b008(0xf3)]});_0x884576[_0x10b008(0xf3)]={};const _0x3a2f72={'prompt_info':_0x884576[_0x10b008(0xc4)],'onboarding_info':_0x884576[_0x10b008(0x111)],'name':_0x884576['name'],'description':_0x884576['description'],'icon_file_id':_0x884576['iconFileId'],'knowledge':_0x884576[_0x10b008(0xda)],'bot_id':_0x884576[_0x10b008(0x15e)],'plugin_id_list':!_0x884576['pluginIdList']?{}:Array[_0x10b008(0x11b)](_0x884576[_0x10b008(0xc6)])?{'id_list':_0x884576[_0x10b008(0xc6)]}:_0x884576[_0x10b008(0xc6)],'workflow_id_list':!_0x884576[_0x10b008(0xf3)]?{}:Array[_0x10b008(0x11b)](_0x884576['workflowIdList'])?{'ids':_0x884576[_0x10b008(0xf3)]}:_0x884576['workflowIdList'],'model_info_config':_0x884576[_0x10b008(0x12d)]};console[_0x10b008(0x19f)]('----------------------updateBot--------------',_0x3a2f72),await _0x214ee0['bots']['update'](_0x3a2f72),this[_0x10b008(0x110)](_0x327462[_0x10b008(0x15e)],_0xc951b1),_0x327462[_0x10b008(0xc4)]&&(_0x884576['promptInfo']=_0x327462[_0x10b008(0xc4)]),_0x327462[_0x10b008(0x111)]&&(_0x884576[_0x10b008(0x111)]=_0x327462['onboardingInfo']),_0x327462[_0x10b008(0x100)]&&(_0x884576[_0x10b008(0x100)]=_0x327462[_0x10b008(0x100)]),_0x884576[_0x10b008(0x18b)]=_0x327462[_0x10b008(0x18b)],_0x327462['iconFileId']&&(_0x884576['iconFileId']=_0x327462[_0x10b008(0x180)]),_0x327462[_0x10b008(0xda)]&&(_0x884576[_0x10b008(0xda)]=_0x327462[_0x10b008(0xda)]),_0x327462[_0x10b008(0x15e)]&&(_0x884576[_0x10b008(0x15e)]=_0x327462[_0x10b008(0x15e)]),_0x327462[_0x10b008(0xc6)]&&(_0x884576['pluginIdList']=_0x327462['pluginIdList']),_0x327462[_0x10b008(0xf3)]&&(_0x884576['workflowIdList']=_0x327462[_0x10b008(0xf3)]),_0x327462[_0x10b008(0x12d)]&&(_0x884576[_0x10b008(0x12d)]=_0x327462[_0x10b008(0x12d)]),await this[_0x10b008(0x129)][_0x10b008(0x169)](_0x327462);}catch(_0x58fb95){return console[_0x10b008(0x19f)](_0x10b008(0x194),_0x58fb95),_0x58fb95;}}async[_0x435b2e(0x188)](_0x75465d,_0xc9759f){const _0x2225b6=_0x435b2e,_0x25e2cc=await this[_0x2225b6(0x129)][_0x2225b6(0x144)]({'where':{'botId':_0x75465d,'userId':_0xc9759f['user']['id']}});if(!_0x25e2cc||_0x25e2cc['userId']!=_0xc9759f[_0x2225b6(0x175)]['id'])throw new Error(_0x2225b6(0x183));await this[_0x2225b6(0x129)]['delete'](_0x25e2cc['id']);}async[_0x435b2e(0xf0)](_0x244202,_0x101c32,_0x1645a5){const _0xd1575=_0x435b2e,_0x3cb0fc=await this['botEntity']['findOne']({'where':{'botId':_0x244202}});if(!_0x3cb0fc)throw new Error(_0xd1575(0x183));_0x1645a5==0x1?this[_0xd1575(0xb4)][_0xd1575(0x146)](_0x101c32[_0xd1575(0x175)]['id'],_0x3cb0fc['id'],collectType_constant_1[_0xd1575(0x149)]['COZEBOT']):this['userService'][_0xd1575(0x133)](_0x101c32[_0xd1575(0x175)]['id'],_0x3cb0fc['id'],collectType_constant_1['UserCollectType'][_0xd1575(0xd5)]);}async[_0x435b2e(0xac)](_0x202aec,_0x59028d){const _0x246b48=_0x435b2e,_0x4a7628=await this[_0x246b48(0xb4)][_0x246b48(0xe3)](_0x202aec[_0x246b48(0x1b5)],_0x202aec[_0x246b48(0x191)],_0x59028d[_0x246b48(0x175)]['id'],collectType_constant_1['UserCollectType'][_0x246b48(0xd5)]);if(_0x4a7628['count']>0x0){const _0x504cfb=await this['botEntity'][_0x246b48(0xc1)]({'id':(0x0,typeorm_2['In'])(_0x4a7628[_0x246b48(0x132)][_0x246b48(0xb2)](_0x50748f=>_0x50748f[_0x246b48(0x15d)]))});return{'rows':_0x504cfb,'count':_0x4a7628[_0x246b48(0x19b)]};}return{'rows':[],'count':0x0};}async[_0x435b2e(0xe1)](_0x2130af,_0x9c8614){const _0x1a1898=_0x435b2e,_0x21cdaf={'userId':_0x9c8614[_0x1a1898(0x175)]['id']};_0x2130af[_0x1a1898(0x186)]&&(_0x21cdaf[_0x1a1898(0x12f)]=(0x0,typeorm_2['Like'])('%'+_0x2130af[_0x1a1898(0x186)]+'%'));_0x2130af['search']&&(_0x21cdaf['name']=(0x0,typeorm_2[_0x1a1898(0x138)])('%'+_0x2130af[_0x1a1898(0xcd)]+'%'));const [_0x299a18,_0x4631a1]=await this[_0x1a1898(0x129)][_0x1a1898(0x14c)]({'where':_0x21cdaf,'order':{'id':_0x1a1898(0x198)},'skip':(_0x2130af[_0x1a1898(0x1b5)]-0x1)*_0x2130af[_0x1a1898(0x191)],'take':_0x2130af[_0x1a1898(0x191)]}),_0x11d1ac=await this[_0x1a1898(0xb4)][_0x1a1898(0x1a8)](_0x299a18,_0x9c8614,collectType_constant_1[_0x1a1898(0x149)][_0x1a1898(0xd5)]);return{'rows':_0x11d1ac,'count':_0x4631a1};}async[_0x435b2e(0x1a1)](_0x76035,_0x186188){const _0x4ed715=_0x435b2e,_0x144767=await this[_0x4ed715(0xde)][_0x4ed715(0x1bc)]({'where':{'userId':_0x186188['user']['id']}}),_0x5e0f6b=[...new Set(_0x144767[_0x4ed715(0xb2)](_0x56b51d=>_0x56b51d[_0x4ed715(0x15e)]))];if(!_0x5e0f6b[_0x4ed715(0x16b)])return{'rows':[],'count':0x0};const _0x184256={'botId':(0x0,typeorm_2['In'])(_0x5e0f6b)};_0x76035['tag']&&(_0x184256[_0x4ed715(0x12f)]=(0x0,typeorm_2[_0x4ed715(0x138)])('%'+_0x76035['tag']+'%'));_0x76035[_0x4ed715(0xcd)]&&(_0x184256['name']=(0x0,typeorm_2[_0x4ed715(0x138)])('%'+_0x76035[_0x4ed715(0xcd)]+'%'));const [_0x1f3880,_0x5d3063]=await this[_0x4ed715(0x129)][_0x4ed715(0x14c)]({'where':_0x184256,'order':{'id':_0x4ed715(0x198)},'skip':(_0x76035[_0x4ed715(0x1b5)]-0x1)*_0x76035[_0x4ed715(0x191)],'take':_0x76035[_0x4ed715(0x191)]}),_0x1de12f=await this['userService'][_0x4ed715(0x1a8)](_0x1f3880,_0x186188,collectType_constant_1[_0x4ed715(0x149)][_0x4ed715(0xd5)]);return{'rows':_0x1de12f,'count':_0x5d3063};}async['getBotList'](_0x214cc0,_0x581c55){const _0x4a2a8b=_0x435b2e,_0x3ab0fe=[{'publish_flag':0x1}];_0x214cc0[_0x4a2a8b(0x186)]&&_0x3ab0fe[_0x4a2a8b(0x14f)](_0x51b882=>{const _0x556780=_0x4a2a8b;_0x51b882[_0x556780(0x12f)]=(0x0,typeorm_2['Like'])('%'+_0x214cc0[_0x556780(0x186)]+'%');});_0x214cc0[_0x4a2a8b(0xcd)]&&_0x3ab0fe[_0x4a2a8b(0x14f)](_0x46a13c=>{const _0x439cc8=_0x4a2a8b;_0x46a13c[_0x439cc8(0x100)]=(0x0,typeorm_2[_0x439cc8(0x138)])('%'+_0x214cc0[_0x439cc8(0xcd)]+'%');});_0x3ab0fe[_0x4a2a8b(0x14f)](_0x8d2717=>{const _0x3fb565=_0x4a2a8b;_0x8d2717[_0x3fb565(0x163)]=0x1;});let _0x423faf={'id':'DESC'};if(_0x214cc0[_0x4a2a8b(0x12c)]==_0x4a2a8b(0x11d))_0x423faf={'useCount':_0x4a2a8b(0x198)};else _0x214cc0[_0x4a2a8b(0x12c)]=='recommend'?_0x423faf={'recommendAt':_0x4a2a8b(0x198)}:_0x423faf={'id':'DESC'};const _0x4f42e3=await this['botEntity'][_0x4a2a8b(0x14c)]({'where':_0x3ab0fe,'order':_0x423faf,'skip':(_0x214cc0['page']-0x1)*_0x214cc0[_0x4a2a8b(0x191)],'take':_0x214cc0[_0x4a2a8b(0x191)]}),[_0x452ebd,_0xc34a81]=_0x4f42e3,_0x398e0e=await this[_0x4a2a8b(0x11c)][_0x4a2a8b(0x1bc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x452ebd[_0x4a2a8b(0xb2)](_0x4f650a=>_0x4f650a[_0x4a2a8b(0xef)]))}});_0x452ebd[_0x4a2a8b(0x14f)](_0x3089cc=>{const _0x46295a=_0x4a2a8b;if(_0x3089cc['userId']){const _0x4d6959=_0x398e0e['find'](_0x3c4810=>_0x3c4810['id']==_0x3089cc[_0x46295a(0xef)]);_0x3089cc['userInfo']={'userId':_0x4d6959['id'],'userName':_0x4d6959[_0x46295a(0x10f)],'avatar':_0x4d6959[_0x46295a(0x1be)]};}});const _0xb64c3a=await this[_0x4a2a8b(0xb4)]['mergeCollectData'](_0x452ebd,_0x581c55,collectType_constant_1['UserCollectType']['COZEBOT']);return{'rows':_0xb64c3a,'count':_0xc34a81};}async[_0x435b2e(0x110)](_0x30fd46,_0x444792){const _0x3cd849=_0x435b2e,_0xa59e0a=await this[_0x3cd849(0x129)]['findOne']({'where':{'botId':_0x30fd46,'userId':_0x444792[_0x3cd849(0x175)]['id']}});if(!_0xa59e0a||_0xa59e0a[_0x3cd849(0xef)]!=_0x444792[_0x3cd849(0x175)]['id'])throw new Error(_0x3cd849(0x183));const _0x120391=await this[_0x3cd849(0xab)](_0x444792[_0x3cd849(0x175)]['id']);await _0x120391['bots'][_0x3cd849(0x174)]({'bot_id':_0xa59e0a[_0x3cd849(0x15e)],'connector_ids':[_0x3cd849(0x104),_0x3cd849(0x1c1)]}),_0xa59e0a[_0x3cd849(0x163)]=0x1,await this[_0x3cd849(0x129)][_0x3cd849(0x169)](_0xa59e0a);}async['upload'](_0x48c968,_0x28b648){const _0x3f1b2b=_0x435b2e,_0x2cfda4=await this[_0x3f1b2b(0xab)](_0x28b648['user']['id']);try{const _0x1f00ca=await _0x2cfda4[_0x3f1b2b(0x19d)][_0x3f1b2b(0x1ab)]({'file':_0x48c968});return _0x1f00ca;}catch(_0x159fe9){console[_0x3f1b2b(0x19f)](_0x3f1b2b(0xd1),_0x159fe9);}return![];}async[_0x435b2e(0xd0)](_0x145fdf){const _0xfebe6c=_0x435b2e;try{const _0x17e91e=await this[_0xfebe6c(0xab)](guid_typescript_1[_0xfebe6c(0xe0)][_0xfebe6c(0x15f)]()),_0x5cd9db=await(0x0,axios_1['default'])({'url':_0x145fdf,'method':_0xfebe6c(0x105),'responseType':_0xfebe6c(0x12b),'headers':{'Accept-Encoding':_0xfebe6c(0x1ae)}}),_0x15b5ac=_0x5cd9db['data'],_0x10cd8f=await _0x17e91e[_0xfebe6c(0x19d)]['upload']({'file':_0x15b5ac});return _0x10cd8f;}catch(_0x49cf29){console['log'](_0xfebe6c(0xbc),_0x49cf29);}return null;}async[_0x435b2e(0x18c)](_0x3406f7,_0x45e8ad){const _0x410fb0=_0x435b2e;try{const _0x187e9b=await this[_0x410fb0(0xd0)](_0x3406f7[_0x410fb0(0x12a)]);_0x3406f7[_0x410fb0(0x153)]=_0x187e9b['id'];const _0x9589ed=await this[_0x410fb0(0xab)](_0x45e8ad[_0x410fb0(0x175)]['id']),_0x34fcce=await _0x9589ed['datasets'][_0x410fb0(0x15f)]({'name':_0x3406f7['name'],'description':_0x3406f7[_0x410fb0(0x18b)],'file_id':_0x3406f7[_0x410fb0(0x153)],'space_id':this[_0x410fb0(0x120)],'format_type':_0x3406f7['formatType']});_0x3406f7[_0x410fb0(0x13e)]=this[_0x410fb0(0x120)],_0x3406f7[_0x410fb0(0x1ad)]=_0x34fcce[_0x410fb0(0xf9)],_0x3406f7[_0x410fb0(0xef)]=_0x45e8ad[_0x410fb0(0x175)]['id'],await this[_0x410fb0(0x155)][_0x410fb0(0x169)](_0x3406f7);}catch(_0x2a435f){return console[_0x410fb0(0x19f)](_0x410fb0(0x10e),_0x2a435f),_0x2a435f;}}async[_0x435b2e(0xaf)](_0x2591c3,_0x758516){const _0x553cd4=_0x435b2e,_0x273422=await this[_0x553cd4(0x155)]['findOne']({'where':{'knowledgeId':_0x2591c3['knowledgeId']}});if(!_0x273422||_0x273422[_0x553cd4(0xef)]!=_0x758516['user']['id'])throw new Error('知识库不存在！');if(_0x273422[_0x553cd4(0x12a)]!=_0x2591c3[_0x553cd4(0x12a)]){const _0x1c7b4a=await this['uploadForUrl'](_0x2591c3[_0x553cd4(0x12a)]);_0x2591c3[_0x553cd4(0x153)]=_0x1c7b4a['id'];}const _0x19614=await this[_0x553cd4(0xab)](_0x758516['user']['id']);await _0x19614['datasets']['update'](_0x273422[_0x553cd4(0x1ad)],{'name':_0x2591c3[_0x553cd4(0x100)],'description':_0x2591c3[_0x553cd4(0x18b)],'file_id':_0x2591c3[_0x553cd4(0x153)]}),await this[_0x553cd4(0x155)][_0x553cd4(0x169)](_0x2591c3);}async['deleteKnowledge'](_0x5bf70b,_0x41c0d0){const _0x33fa52=_0x435b2e,_0x454d79=await this['knowledgeEntity'][_0x33fa52(0x144)]({'where':{'knowledgeId':_0x5bf70b}});if(!_0x454d79||_0x454d79[_0x33fa52(0xef)]!=_0x41c0d0[_0x33fa52(0x175)]['id'])throw new Error(_0x33fa52(0xbe));const _0xb1bcd7=await this['getCozeApi'](_0x41c0d0['user']['id']),_0x41552e=await _0xb1bcd7[_0x33fa52(0x13f)][_0x33fa52(0x1c2)](_0x454d79[_0x33fa52(0x1ad)]);await this[_0x33fa52(0x155)][_0x33fa52(0x1c2)](_0x454d79['id']);}async[_0x435b2e(0xfa)](_0x5b1e08,_0x31ac39){const _0xaf1eaa=_0x435b2e,_0x5582ca={'userId':_0x31ac39[_0xaf1eaa(0x175)]['id']};_0x5b1e08[_0xaf1eaa(0xcd)]&&(_0x5582ca['name']=(0x0,typeorm_2[_0xaf1eaa(0x138)])('%'+_0x5b1e08[_0xaf1eaa(0xcd)]+'%'));const [_0x11b576,_0x3f6b0c]=await this[_0xaf1eaa(0x155)][_0xaf1eaa(0x14c)]({'where':_0x5582ca,'order':{'id':_0xaf1eaa(0x198)},'skip':(_0x5b1e08[_0xaf1eaa(0x1b5)]-0x1)*_0x5b1e08[_0xaf1eaa(0x191)],'take':_0x5b1e08['size']});return{'rows':_0x11b576,'count':_0x3f6b0c};}async[_0x435b2e(0x1b9)](_0x4351bd,_0x3deca1){const _0x18a8cb=_0x435b2e;return await this[_0x18a8cb(0x18e)][_0x18a8cb(0x144)]({'where':{'documentId':_0x4351bd,'userId':_0x3deca1[_0x18a8cb(0x175)]['id']}});}async['getKnowledgeDocumentList'](_0x3c2863,_0x3887fb){const _0x182400=_0x435b2e,_0x5902e4={'userId':_0x3887fb[_0x182400(0x175)]['id'],'knowledgeId':_0x3c2863[_0x182400(0x1ad)]};_0x3c2863[_0x182400(0xcd)]&&(_0x5902e4['name']=(0x0,typeorm_2[_0x182400(0x138)])('%'+_0x3c2863['search']+'%'));const [_0x967f08,_0x3fa8b0]=await this[_0x182400(0x18e)][_0x182400(0x14c)]({'where':_0x5902e4,'order':{'id':_0x182400(0x198)},'skip':(_0x3c2863[_0x182400(0x1b5)]-0x1)*_0x3c2863[_0x182400(0x191)],'take':_0x3c2863[_0x182400(0x191)]});return{'rows':_0x967f08,'count':_0x3fa8b0};}async[_0x435b2e(0x117)](_0x5bd565,_0x5d2c2b){const _0x24e72d=_0x435b2e;try{const _0x140efe=await this[_0x24e72d(0xab)](_0x5d2c2b[_0x24e72d(0x175)]['id']),_0x22bebf=await _0x140efe['datasets'][_0x24e72d(0x19c)][_0x24e72d(0x15f)]({'dataset_id':_0x5bd565[_0x24e72d(0x1ad)],'document_bases':_0x5bd565[_0x24e72d(0x135)],'chunk_strategy':_0x5bd565['chunkStrategy'],'format_type':_0x5bd565['formatType']});let _0x271d3e=[];for(const _0x210f25 of _0x22bebf){_0x271d3e[_0x24e72d(0xc9)](await this[_0x24e72d(0x18e)][_0x24e72d(0x169)]({'userId':_0x5d2c2b[_0x24e72d(0x175)]['id'],'spaceId':this[_0x24e72d(0x120)],'knowledgeId':_0x5bd565[_0x24e72d(0x1ad)],'name':_0x210f25[_0x24e72d(0x100)],'documentId':_0x210f25[_0x24e72d(0x147)],'charCount':_0x210f25[_0x24e72d(0x178)],'chunkStrategy':_0x210f25[_0x24e72d(0x130)],'formatType':_0x210f25[_0x24e72d(0x193)],'hitCount':_0x210f25[_0x24e72d(0x127)],'size':_0x210f25['size'],'sliceCount':_0x210f25['slice_count'],'status':_0x210f25[_0x24e72d(0x136)],'type':_0x210f25[_0x24e72d(0x12c)]}));}return console[_0x24e72d(0x19f)](_0x24e72d(0x14d),_0x22bebf),_0x271d3e;}catch(_0x5cbabe){return console[_0x24e72d(0x19f)]('-----------------------------------createKnowledgeDocumentERROR----------',_0x5cbabe),_0x5cbabe;}}async[_0x435b2e(0x139)](_0x2cd4da,_0x24bd8e){const _0x10bc4f=_0x435b2e;try{const _0x710ef4=await this[_0x10bc4f(0x18e)]['findOne']({'where':{'documentId':_0x2cd4da[_0x10bc4f(0x147)]}});if(!_0x710ef4||_0x710ef4['userId']!=_0x24bd8e[_0x10bc4f(0x175)]['id'])throw new Error(_0x10bc4f(0x199));_0x710ef4[_0x10bc4f(0x190)]=_0x2cd4da['update_rule'],_0x710ef4['name']=_0x2cd4da[_0x10bc4f(0xee)],await this[_0x10bc4f(0x18e)][_0x10bc4f(0x169)](_0x710ef4);const _0x3f171b=await this[_0x10bc4f(0xab)](_0x24bd8e[_0x10bc4f(0x175)]['id']),_0xa7164a=await _0x3f171b[_0x10bc4f(0x13f)]['documents']['update'](_0x2cd4da);return _0xa7164a;}catch(_0x138d45){return _0x138d45;}}async[_0x435b2e(0xce)](_0x3b1be0,_0xbc718d){const _0x2d14a8=_0x435b2e,_0x5c07a9=await this['knowledgeDocumentEntity'][_0x2d14a8(0x144)]({'where':{'documentId':_0x3b1be0}});if(!_0x5c07a9||_0x5c07a9[_0x2d14a8(0xef)]!=_0xbc718d[_0x2d14a8(0x175)]['id'])throw new Error('文档不存在！');await this[_0x2d14a8(0x18e)]['delete']({'documentId':_0x3b1be0,'userId':_0xbc718d[_0x2d14a8(0x175)]['id']});const _0xe831c5=await this[_0x2d14a8(0xab)](_0xbc718d['user']['id']),_0xbbd1da=await _0xe831c5[_0x2d14a8(0x13f)]['documents'][_0x2d14a8(0x1c2)]({'document_ids':[_0x5c07a9[_0x2d14a8(0xca)]]});console[_0x2d14a8(0x19f)](_0x2d14a8(0x184),_0xbbd1da);}async['getKnowledgeDocumentProgress'](_0x1bd5cb,_0x39deac,_0x18e342){const _0x318186=_0x435b2e,_0x352e5d=await this[_0x318186(0xab)](_0x18e342['user']['id']),_0x488b2b=await _0x352e5d[_0x318186(0x13f)][_0x318186(0x119)](_0x1bd5cb,_0x39deac);console[_0x318186(0x19f)](_0x318186(0xae),_0x488b2b);}async[_0x435b2e(0xf4)](){const _0x48e0bc=_0x435b2e;return await this[_0x48e0bc(0x1b7)]['find']({'where':{'isRelease':0x1},'order':{'sortIndex':_0x48e0bc(0x198),'id':_0x48e0bc(0x198)}});}async[_0x435b2e(0x116)](_0x579502){return new Promise((_0x310930,_0x263d21)=>{const _0x1a11dd=_0x6e13;https_1[_0x1a11dd(0x145)]['get'](_0x579502,_0xa05306=>{const _0x3116b6=_0x1a11dd;if(_0xa05306['statusCode']!==0xc8){_0x263d21(new Error(_0x3116b6(0x173)+_0xa05306['statusCode']));return;}_0x310930(_0xa05306);})['on']('error',_0x4a24a7=>{_0x263d21(_0x4a24a7);});});}async[_0x435b2e(0xfd)](_0x3f1f4a,_0x179d75){const _0x560e93=_0x435b2e,_0x161890={'userId':_0x179d75[_0x560e93(0x175)]['id'],'botId':_0x3f1f4a[_0x560e93(0x15e)]},[_0x301f78,_0x4ef3d8]=await this[_0x560e93(0xde)][_0x560e93(0x14c)]({'where':_0x161890,'order':{'isTop':_0x560e93(0xb0),'id':_0x560e93(0x198)},'skip':(_0x3f1f4a[_0x560e93(0x1b5)]-0x1)*_0x3f1f4a['size'],'take':_0x3f1f4a[_0x560e93(0x191)]});return{'rows':_0x301f78,'count':_0x4ef3d8};}async[_0x435b2e(0x17a)](_0x170400,_0x1a595f){const _0x5d0b90=_0x435b2e;try{const _0x2d8121=await this[_0x5d0b90(0xab)](_0x1a595f[_0x5d0b90(0x175)]['id']),_0x1b5554=await _0x2d8121[_0x5d0b90(0x16e)]['create']({'bot_id':_0x170400[_0x5d0b90(0x15e)]});_0x170400[_0x5d0b90(0xef)]=_0x1a595f[_0x5d0b90(0x175)]['id'],_0x170400[_0x5d0b90(0xc0)]=_0x1b5554['id'];const _0x35faf9=await this[_0x5d0b90(0x129)][_0x5d0b90(0x144)]({'where':{'botId':_0x170400['botId']}});return _0x35faf9[_0x5d0b90(0x10d)]=_0x35faf9[_0x5d0b90(0x10d)]?_0x35faf9['useCount']+0x1:0x1,await this['botEntity'][_0x5d0b90(0x169)](_0x35faf9),await this[_0x5d0b90(0xde)][_0x5d0b90(0x169)](_0x170400);}catch(_0x26201d){return _0x26201d;}}async[_0x435b2e(0xb1)](_0x42b8bf,_0x449875){const _0x3f141f=_0x435b2e;return await this[_0x3f141f(0xde)][_0x3f141f(0x1c2)]({'conversationId':_0x42b8bf,'userId':_0x449875['user']['id']}),!![];}async['setConversationName'](_0x1b7642,_0x211a4c,_0x1cd5fe){const _0x3ed431=_0x435b2e,_0x3ae1ac=await this[_0x3ed431(0xde)][_0x3ed431(0x144)]({'where':{'conversationId':_0x1b7642,'userId':_0x1cd5fe[_0x3ed431(0x175)]['id']}});if(!_0x3ae1ac)throw new Error('会话不存在！');_0x3ae1ac[_0x3ed431(0x100)]=_0x211a4c,await this[_0x3ed431(0xde)][_0x3ed431(0x169)](_0x3ae1ac);}async[_0x435b2e(0xdb)](_0x2232a3,_0x1ed68c,_0x25e660){const _0x33eb5a=_0x435b2e;try{const _0x888fe2=await this['cozeConversationEntity'][_0x33eb5a(0x144)]({'where':{'conversationId':_0x2232a3,'userId':_0x25e660[_0x33eb5a(0x175)]['id']}});if(!_0x888fe2)throw new Error('会话不存在！');_0x888fe2[_0x33eb5a(0x171)]=_0x1ed68c==0x1?0x1:0x0,await this[_0x33eb5a(0xde)]['save'](_0x888fe2);}catch(_0x2155c7){return _0x2155c7[_0x33eb5a(0xe4)];}}async[_0x435b2e(0xff)](_0x420ec2,_0x4684f2){const _0x3b31c1=_0x435b2e,_0x318e29={'userId':_0x4684f2[_0x3b31c1(0x175)]['id'],'conversationId':_0x420ec2[_0x3b31c1(0xc0)]},[_0x1dfb28,_0x4a8d20]=await this[_0x3b31c1(0x137)][_0x3b31c1(0x14c)]({'where':_0x318e29,'order':{'id':_0x3b31c1(0x198)},'skip':(_0x420ec2[_0x3b31c1(0x1b5)]-0x1)*_0x420ec2[_0x3b31c1(0x191)],'take':_0x420ec2[_0x3b31c1(0x191)]});return{'rows':_0x1dfb28,'count':_0x4a8d20};}async['createMessage'](_0xc9b838,_0x1018fb){const _0x2dfa0b=_0x435b2e,_0x36d8f1=await this[_0x2dfa0b(0xab)](_0x1018fb[_0x2dfa0b(0x175)]['id']),_0x215ad5=await _0x36d8f1[_0x2dfa0b(0x16e)][_0x2dfa0b(0xf1)][_0x2dfa0b(0x15f)](_0xc9b838[_0x2dfa0b(0xc0)],{'role':_0xc9b838[_0x2dfa0b(0xd2)],'content':_0xc9b838['content'],'content_type':_0xc9b838[_0x2dfa0b(0xec)],'meta_data':{}});_0xc9b838['messageId']=_0x215ad5['id'],this[_0x2dfa0b(0x137)][_0x2dfa0b(0x169)](_0xc9b838);}[_0x435b2e(0x108)](_0x4ab22b,_0x1ac796){_0x4ab22b['write']('data:\x20'+JSON['stringify'](_0x1ac796)+'\x0a\x0a');}async['validateBeforeChat'](_0x40f750){const _0x4ec277=_0x435b2e,{user:_0x49f704,prompt:_0x4b8dcf,model:_0x4bf25e}=_0x40f750;await this[_0x4ec277(0xb4)]['checkUserStatus'](_0x49f704),await this[_0x4ec277(0x1bd)][_0x4ec277(0x1a7)](_0x4b8dcf,_0x49f704['id']),await this['userService'][_0x4ec277(0xe6)](_0x49f704['id'],_0x4bf25e[_0x4ec277(0xdc)],_0x4bf25e[_0x4ec277(0xcc)],_0x4bf25e[_0x4ec277(0x11a)]);}async[_0x435b2e(0xc3)](_0x29c4e1,_0x30e253,_0x5cf834){const _0x56d9e2=_0x435b2e;_0x5cf834[_0x56d9e2(0xb8)]('Content-Type',_0x56d9e2(0x1a6)),_0x5cf834['setHeader']('Transfer-Encoding','chunked'),_0x5cf834['setHeader'](_0x56d9e2(0x118),_0x56d9e2(0xfe)),_0x5cf834[_0x56d9e2(0xb8)](_0x56d9e2(0x143),'no'),_0x5cf834[_0x56d9e2(0xb8)](_0x56d9e2(0x103),'*');try{const _0x4ef36b=await this[_0x56d9e2(0xde)][_0x56d9e2(0x144)]({'where':{'userId':_0x30e253[_0x56d9e2(0x175)]['id'],'conversationId':_0x29c4e1['conversationId']}});if(!_0x4ef36b){this[_0x56d9e2(0x108)](_0x5cf834,{'content':_0x56d9e2(0xbb),'contentType':'','isEnd':![],'isError':!![]});return;}const _0x5a82c5=await this[_0x56d9e2(0xb4)][_0x56d9e2(0x1a9)](_0x30e253[_0x56d9e2(0x175)]['id']),_0x23474c=await this['getCozeApi'](_0x30e253[_0x56d9e2(0x175)]['id']),_0x597fdc=await _0x23474c[_0x56d9e2(0x122)][_0x56d9e2(0xf6)]({'bot_id':_0x4ef36b['botId']}),_0x37e8bf=await this[_0x56d9e2(0x129)][_0x56d9e2(0x144)]({'where':{'botId':_0x4ef36b['botId']}});_0x37e8bf['modelInfoConfig']=_0x597fdc['model_info'],_0x37e8bf['workflowIdList']=_0x597fdc[_0x56d9e2(0x115)],_0x37e8bf[_0x56d9e2(0x111)]=_0x597fdc[_0x56d9e2(0x12e)],await this[_0x56d9e2(0x129)][_0x56d9e2(0x169)](_0x37e8bf);const _0x1868a9=await this['cozeModelEntity'][_0x56d9e2(0x144)]({'where':{'modelId':_0x597fdc[_0x56d9e2(0x1a2)][_0x56d9e2(0x166)]}});if(!_0x1868a9){this['responseMessage'](_0x5cf834,{'content':_0x56d9e2(0x1c0),'contentType':'','isEnd':![],'isError':!![]});return;}this['validateBeforeChat']({'prompt':_0x29c4e1[_0x56d9e2(0xdf)][_0x56d9e2(0x125)](),'user':_0x5a82c5,'model':_0x1868a9});const _0x11e28c=await this['cozeMessageEntity'][_0x56d9e2(0x1bc)]({'where':{'conversationId':_0x29c4e1['conversationId']},'take':0x63,'order':{'id':'ASC'}});let _0x1339d5=[];_0x11e28c[_0x56d9e2(0x14f)](_0x1a07df=>{const _0x126cb5=_0x56d9e2;let _0x1fdb78=_0x1a07df['content'];_0x1a07df[_0x126cb5(0xec)]==_0x126cb5(0xf8)&&(_0x1fdb78=JSON['stringify'](_0x1a07df[_0x126cb5(0xc7)])),_0x1339d5[_0x126cb5(0xc9)]({'role':_0x1a07df[_0x126cb5(0xd2)],'content':_0x1fdb78,'content_type':_0x1a07df[_0x126cb5(0xec)],'type':_0x1a07df[_0x126cb5(0x12c)]});});typeof _0x29c4e1[_0x56d9e2(0xdf)]===_0x56d9e2(0x14b)?_0x1339d5[_0x56d9e2(0xc9)]({'content':_0x29c4e1['content'],'content_type':_0x56d9e2(0x10a),'role':_0x56d9e2(0x175),'type':_0x56d9e2(0x1aa)}):_0x1339d5[_0x56d9e2(0xc9)]({'content':JSON[_0x56d9e2(0x124)](_0x29c4e1[_0x56d9e2(0xdf)]),'content_type':_0x56d9e2(0xf8),'role':'user','type':_0x56d9e2(0x1aa)});const _0x2f5a86=await _0x23474c[_0x56d9e2(0xd6)][_0x56d9e2(0x12b)]({'bot_id':_0x4ef36b[_0x56d9e2(0x15e)],'user_id':_0x30e253[_0x56d9e2(0x175)]['id'][_0x56d9e2(0x125)](),'auto_save_history':!![],'additional_messages':_0x1339d5});let _0x2d448e,_0x1f37a8='',_0x2756d3='',_0x72425e='',_0xc3a641,_0x4a03d9=[];for await(const _0x10e5af of _0x2f5a86){if(_0x10e5af[_0x56d9e2(0x1a5)]===api_1[_0x56d9e2(0xcf)]['CONVERSATION_CHAT_CREATED'])_0x2756d3=_0x56d9e2(0x187),_0x2d448e=_0x10e5af,_0x72425e=_0x10e5af[_0x56d9e2(0x11f)]['id'];else{if(_0x10e5af['event']===api_1[_0x56d9e2(0xcf)][_0x56d9e2(0x158)])_0x1f37a8+=_0x10e5af[_0x56d9e2(0x11f)]['content'],this['responseMessage'](_0x5cf834,{'content':_0x10e5af[_0x56d9e2(0x11f)]['content'],'contentType':_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0x17e)],'isEnd':![],'isError':![]}),_0x2756d3=_0x56d9e2(0x179);else{if(_0x10e5af['event']===api_1[_0x56d9e2(0xcf)][_0x56d9e2(0x17b)])_0x2756d3=_0x56d9e2(0x179),_0xc3a641=_0x10e5af['data'][_0x56d9e2(0xc2)],_0x10e5af[_0x56d9e2(0x11f)]['type']==_0x56d9e2(0x148)&&_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0xdf)]&&(_0x4a03d9[_0x56d9e2(0xc9)]({'type':_0x10e5af[_0x56d9e2(0x11f)]['type'],'content':JSON[_0x56d9e2(0x17f)](_0x10e5af[_0x56d9e2(0x11f)]['content'])}),this[_0x56d9e2(0x108)](_0x5cf834,{'content':_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0xdf)],'type':_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0x12c)],'contentType':_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0x17e)],'isEnd':![],'isError':![],'usage':_0x10e5af[_0x56d9e2(0x11f)]['usage']}));else{if(_0x10e5af[_0x56d9e2(0x1a5)]===api_1[_0x56d9e2(0xcf)]['CONVERSATION_CHAT_COMPLETED'])_0x2756d3=_0x56d9e2(0x1a4),_0xc3a641=_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0xc2)],this[_0x56d9e2(0x108)](_0x5cf834,{'content':'','isEnd':!![],'isError':![],'usage':_0x10e5af[_0x56d9e2(0x11f)][_0x56d9e2(0xc2)]});else{if(_0x10e5af[_0x56d9e2(0x1a5)]===api_1[_0x56d9e2(0xcf)][_0x56d9e2(0xb9)])_0x2756d3=_0x56d9e2(0xb3),this[_0x56d9e2(0x108)](_0x5cf834,{'content':'','contentType':'','isEnd':!![],'isError':![]});else _0x10e5af[_0x56d9e2(0x1a5)]===api_1[_0x56d9e2(0xcf)]['ERROR']&&(_0x2756d3=_0x56d9e2(0x121),console[_0x56d9e2(0x19f)](_0x56d9e2(0x154),_0x10e5af),this[_0x56d9e2(0x108)](_0x5cf834,{'content':'','contentType':'','isEnd':![],'isError':!![],'errorData':_0x10e5af}));}}}}}const _0x4f414c=await this[_0x56d9e2(0x137)]['save']({'botId':_0x4ef36b[_0x56d9e2(0x15e)],'userId':_0x30e253[_0x56d9e2(0x175)]['id'],'spaceId':this[_0x56d9e2(0x120)],'messageId':_0x72425e,'type':_0x56d9e2(0x1aa),'contentType':typeof _0x29c4e1[_0x56d9e2(0xdf)]===_0x56d9e2(0x14b)?_0x56d9e2(0x10a):_0x56d9e2(0xf8),'conversationId':_0x4ef36b[_0x56d9e2(0xc0)],'content':typeof _0x29c4e1[_0x56d9e2(0xdf)]==='string'?_0x29c4e1[_0x56d9e2(0xdf)]:'','contentObject':typeof _0x29c4e1[_0x56d9e2(0xdf)]!==_0x56d9e2(0x14b)?_0x29c4e1['content']:[],'role':_0x56d9e2(0x175),'parentId':0x0});await this[_0x56d9e2(0x137)][_0x56d9e2(0x169)]({'botId':_0x4ef36b[_0x56d9e2(0x15e)],'userId':_0x30e253[_0x56d9e2(0x175)]['id'],'spaceId':this['SPACE_ID'],'messageId':_0x72425e,'conversationId':_0x4ef36b[_0x56d9e2(0xc0)],'type':_0x56d9e2(0xba),'content':_0x1f37a8,'content_type':_0x56d9e2(0x10a),'role':'assistant','usage':_0xc3a641,'status':_0x2756d3,'parentId':_0x4f414c['id'],'contentObject':_0x4a03d9}),await this[_0x56d9e2(0xb4)]['deductBalance4Coze'](_0x30e253['user']['id'],_0x1868a9[_0x56d9e2(0xdc)],_0x1868a9[_0x56d9e2(0x100)],_0x1868a9[_0x56d9e2(0xcc)],_0x1868a9[_0x56d9e2(0x11a)],_0x72425e);}catch(_0x9f4268){return console[_0x56d9e2(0x121)](_0x56d9e2(0x1bf),_0x9f4268),_0x9f4268;}}async[_0x435b2e(0x1a0)](_0x330ae6){const _0x395381=_0x435b2e,_0x3debea={'isRelease':0x1};_0x330ae6['search']&&(_0x3debea[_0x395381(0x100)]=(0x0,typeorm_2[_0x395381(0x138)])('%'+_0x330ae6[_0x395381(0xcd)]+'%'));const [_0x2dedfa,_0x37648a]=await this[_0x395381(0x185)][_0x395381(0x14c)]({'where':_0x3debea,'order':{'id':'DESC'},'skip':(_0x330ae6[_0x395381(0x1b5)]-0x1)*_0x330ae6['size'],'take':_0x330ae6[_0x395381(0x191)]});return{'rows':_0x2dedfa,'count':_0x37648a};}async[_0x435b2e(0x1a3)](){const _0x500490=_0x435b2e,_0x4c75d5=await this[_0x500490(0xab)]('');let _0x53969d=0x1;while(!![]){const _0x5800c6=await this['knowledgeEntity'][_0x500490(0x1bc)]({'where':{'spaceId':this['SPACE_ID']}});let _0x20e6e9=await _0x4c75d5['datasets']['list']({'space_id':this['SPACE_ID'],'page_num':_0x53969d,'page_size':0x12c});if(!_0x20e6e9[_0x500490(0x10c)]||_0x20e6e9[_0x500490(0x10c)][_0x500490(0x16b)]==0x0)break;_0x20e6e9=_0x20e6e9[_0x500490(0x10c)][_0x500490(0x156)](_0xd03fef=>_0x5800c6['map'](_0x2d0584=>_0x2d0584[_0x500490(0x1ad)])[_0x500490(0x126)](_0xd03fef[_0x500490(0xf9)]));for(let _0x2ea1c7 of _0x20e6e9){await this['knowledgeEntity'][_0x500490(0x1bb)]({'knowledgeId':_0x2ea1c7[_0x500490(0xf9)]},{'botUsedCount':_0x2ea1c7[_0x500490(0x18d)],'processingFileList':_0x2ea1c7[_0x500490(0xbd)],'failedFileList':_0x2ea1c7[_0x500490(0xc5)],'formatType':_0x2ea1c7[_0x500490(0x193)],'processingFileIdList':_0x2ea1c7[_0x500490(0x196)],'allFileSize':_0x2ea1c7['all_file_size'],'hitCount':_0x2ea1c7['hit_count'],'docCount':_0x2ea1c7[_0x500490(0x182)],'fileList':_0x2ea1c7['file_list'],'chunkStrategy':_0x2ea1c7['chunk_strategy']});let _0x7a5f11=0x1;while(!![]){const _0x55068a=await _0x4c75d5[_0x500490(0x13f)]['documents']['list']({'dataset_id':_0x2ea1c7['dataset_id'],'page':_0x7a5f11,'page_size':0x12c});if(!_0x55068a[_0x500490(0xcb)]||_0x55068a[_0x500490(0xcb)][_0x500490(0x16b)]==0x0)break;for(let _0xfdc3a4 of _0x55068a[_0x500490(0xcb)]){await this[_0x500490(0x18e)][_0x500490(0x1bb)]({'documentId':_0xfdc3a4[_0x500490(0x147)]},{'charCount':_0xfdc3a4[_0x500490(0x178)],'status':_0xfdc3a4[_0x500490(0x136)],'chunkStrategy':_0xfdc3a4[_0x500490(0x130)],'formatType':_0xfdc3a4[_0x500490(0x193)],'hitCount':_0xfdc3a4[_0x500490(0x127)],'size':_0xfdc3a4[_0x500490(0x191)],'sliceCount':_0xfdc3a4['slice_count'],'sourceType':_0xfdc3a4[_0x500490(0xb6)],'type':_0xfdc3a4[_0x500490(0x12c)],'docTreeTosUrl':_0xfdc3a4[_0x500490(0xe8)],'previewTosUrl':_0xfdc3a4[_0x500490(0x140)],'webUrl':_0xfdc3a4[_0x500490(0x197)]});}_0x7a5f11++;}}_0x53969d++;}}async[_0x435b2e(0x1ac)](){const _0x9e6321=_0x435b2e,_0x2d1392=await this[_0x9e6321(0xab)](''),_0x4c33c5=await this[_0x9e6321(0x18e)][_0x9e6321(0x1bc)]({'where':{'progress':(0x0,typeorm_2['LessThan'])(0x64)}});if(_0x4c33c5[_0x9e6321(0x16b)])for(let _0x4d99c9 of _0x4c33c5){const _0x235aaa=await _0x2d1392[_0x9e6321(0x13f)]['process'](_0x4d99c9[_0x9e6321(0x1ad)],{'document_ids':[_0x4d99c9['documentId']]});if(_0x235aaa[_0x9e6321(0x11f)]['length'])for(let _0x2c7ce3 of _0x235aaa[_0x9e6321(0x11f)]){await this['knowledgeDocumentEntity'][_0x9e6321(0x1bb)]({'documentId':_0x2c7ce3['document_id']},{'progress':_0x2c7ce3[_0x9e6321(0x1b2)],'size':_0x2c7ce3[_0x9e6321(0x191)],'remainingTime':_0x2c7ce3[_0x9e6321(0xb7)],'statusDescript':_0x2c7ce3['status_descript']});}}}async['batchBotProgressResult'](){const _0x3967d3=_0x435b2e,_0x2035b1=await this[_0x3967d3(0xab)]('');let _0x309778=0x1;while(!![]){const _0x28efbc=await _0x2035b1[_0x3967d3(0x122)][_0x3967d3(0x160)]({'space_id':this[_0x3967d3(0x120)],'page_index':_0x309778});if(!_0x28efbc['space_bots']['length'])break;for(let _0x2a2290=0x0;_0x2a2290<_0x28efbc[_0x3967d3(0x16d)][_0x3967d3(0x16b)];_0x2a2290++){console[_0x3967d3(0x19f)](_0x3967d3(0xad),_0x28efbc[_0x3967d3(0x16d)][_0x2a2290][_0x3967d3(0x109)]);const _0x32ad43=await this['botEntity'][_0x3967d3(0x144)]({'where':{'botId':_0x28efbc[_0x3967d3(0x16d)][_0x2a2290][_0x3967d3(0x109)]}});if(!_0x32ad43){const _0x1cf930=await this[_0x3967d3(0x14a)](_0x28efbc[_0x3967d3(0x16d)][_0x2a2290][_0x3967d3(0xc8)]);console['log'](_0x3967d3(0x14e),_0x1cf930),await this['botEntity'][_0x3967d3(0x169)]({'spaceId':this[_0x3967d3(0x120)],'botId':_0x28efbc[_0x3967d3(0x16d)][_0x2a2290][_0x3967d3(0x109)],'name':_0x28efbc[_0x3967d3(0x16d)][_0x2a2290]['bot_name'],'description':_0x28efbc[_0x3967d3(0x16d)][_0x2a2290][_0x3967d3(0x18b)],'iconFileUrl':_0x1cf930,'isRelease':0x1,'publish_flag':0x0});}}_0x309778++,console['log'](_0x3967d3(0x128)+_0x28efbc[_0x3967d3(0x176)]+'】条，当前【'+_0x309778+_0x3967d3(0x1af),_0x309778);}var _0x142175=await this['botEntity'][_0x3967d3(0x1bc)]({'where':{'userId':0x0}});for(let _0x5686a7=0x0;_0x5686a7<_0x142175[_0x3967d3(0x16b)];_0x5686a7++){const _0xd457b2=await _0x2035b1[_0x3967d3(0x122)]['retrieve']({'bot_id':_0x142175[_0x5686a7][_0x3967d3(0x15e)]});_0xd457b2&&(_0x142175[_0x5686a7][_0x3967d3(0x111)]=_0xd457b2[_0x3967d3(0x12e)],_0x142175[_0x5686a7][_0x3967d3(0xc4)]=_0xd457b2['prompt_info'],_0x142175[_0x5686a7][_0x3967d3(0x12d)]=_0xd457b2[_0x3967d3(0x1a2)],_0x142175[_0x5686a7][_0x3967d3(0xf3)]=_0xd457b2[_0x3967d3(0x115)],await this[_0x3967d3(0x129)][_0x3967d3(0x169)](_0x142175[_0x5686a7]));}_0x309778++,console[_0x3967d3(0x19f)](_0x3967d3(0x161));}async['uploadUrlToServer'](_0x1f3cb8){const _0x7d392b=_0x435b2e;try{const _0x25b763=await(0x0,axios_1['default'])({'url':_0x1f3cb8,'method':_0x7d392b(0x105),'responseType':'stream','headers':{'Accept-Encoding':'identity'}}),_0x5e0b5a=_0x25b763['data'];let _0x701f64=(0x0,uuid_1['v4'])();return await this['fileService'][_0x7d392b(0x123)]({'filename':_0x701f64,'buffer':_0x5e0b5a});}catch(_0x5ed2fb){console[_0x7d392b(0x19f)](_0x7d392b(0x151),_0x5ed2fb);}return null;}async[_0x435b2e(0x192)](_0x8bd752,_0x35cac8){const _0x1f46c4=_0x435b2e,_0x4e8376=_0x8bd752[_0x1f46c4(0x175)]?.['id'],_0x1e6e89=await this['cozeConversationEntity'][_0x1f46c4(0x144)]({'where':{'userId':_0x8bd752['user']['id'],'conversationId':_0x35cac8[_0x1f46c4(0xc0)]}});if(!_0x1e6e89)throw new common_1[(_0x1f46c4(0xeb))](_0x1f46c4(0xbb),common_1[_0x1f46c4(0xd9)][_0x1f46c4(0x1b6)]);const _0x14f912=await this[_0x1f46c4(0xab)](_0x8bd752['user']['id']),_0x3c5a8a=await _0x14f912[_0x1f46c4(0x122)][_0x1f46c4(0xf6)]({'bot_id':_0x1e6e89[_0x1f46c4(0x15e)]}),_0x5bd93d=await this[_0x1f46c4(0x1b7)][_0x1f46c4(0x144)]({'where':{'modelId':_0x3c5a8a[_0x1f46c4(0x1a2)][_0x1f46c4(0x166)]}});if(!_0x5bd93d)throw new common_1[(_0x1f46c4(0xeb))]('模型不存在',common_1[_0x1f46c4(0xd9)][_0x1f46c4(0x1b6)]);if(!_0x4e8376)return{'remainCount':0x0,'freeCount':0x0,'isVipFree':_0x5bd93d[_0x1f46c4(0xcc)]==-0x1,'useIntegrate':_0x5bd93d['deduct']};return{'remainCount':await this[_0x1f46c4(0xb4)][_0x1f46c4(0x1b8)](_0x4e8376,_0x5bd93d[_0x1f46c4(0xdc)],_0x5bd93d['vipFreeNum']),'freeCount':_0x5bd93d[_0x1f46c4(0xcc)],'isVipFree':_0x5bd93d[_0x1f46c4(0xcc)]==-0x1,'useIntegrate':_0x5bd93d[_0x1f46c4(0x11a)]};}};CozeService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x435b2e(0x13d)])(bot_entity_1[_0x435b2e(0xe2)])),__param(0x1,(0x0,typeorm_1[_0x435b2e(0x13d)])(knowledge_entity_1[_0x435b2e(0x114)])),__param(0x2,(0x0,typeorm_1[_0x435b2e(0x13d)])(knowledgedocument_entity_1[_0x435b2e(0x15c)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(model_entity_1[_0x435b2e(0x15b)])),__param(0x4,(0x0,typeorm_1[_0x435b2e(0x13d)])(conversation_entity_1[_0x435b2e(0x172)])),__param(0x5,(0x0,typeorm_1[_0x435b2e(0x13d)])(message_entity_1['CozeMessageEntity'])),__param(0x6,(0x0,typeorm_1[_0x435b2e(0x13d)])(workflow_entity_1[_0x435b2e(0x164)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0x435b2e(0x113)])),__metadata('design:paramtypes',[typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],typeorm_2[_0x435b2e(0xf5)],user_service_1[_0x435b2e(0xe5)],badwords_service_1[_0x435b2e(0x134)],cm_service_1[_0x435b2e(0x101)],file_service_1[_0x435b2e(0xed)]])],CozeService),exports[_0x435b2e(0x1b3)]=CozeService;