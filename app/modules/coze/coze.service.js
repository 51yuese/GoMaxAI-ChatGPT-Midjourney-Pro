'use strict';const _0xb7860f=_0xcc03;(function(_0x48c441,_0x17a02f){const _0x43ee81=_0xcc03,_0x445a4f=_0x48c441();while(!![]){try{const _0x26a4e1=-parseInt(_0x43ee81(0x283))/0x1+-parseInt(_0x43ee81(0x27b))/0x2*(-parseInt(_0x43ee81(0x2ab))/0x3)+-parseInt(_0x43ee81(0x2cf))/0x4+parseInt(_0x43ee81(0x29f))/0x5+-parseInt(_0x43ee81(0x2f0))/0x6+parseInt(_0x43ee81(0x1f6))/0x7*(parseInt(_0x43ee81(0x219))/0x8)+parseInt(_0x43ee81(0x2ae))/0x9;if(_0x26a4e1===_0x17a02f)break;else _0x445a4f['push'](_0x445a4f['shift']());}catch(_0x45f94f){_0x445a4f['push'](_0x445a4f['shift']());}}}(_0x4f09,0x8fd8a));function _0x4f09(){const _0x444807=['model_info','UserService','knowledgeDocumentEntity','__metadata','badwordsService','LessThan','created','会话不存在！','Cache-Control','promptInfo','collectBotList','./entity/conversation.entity','getMessageList','@nestjs/common','userEntity','type','guid-typescript','请求失败，状态码:\x20','CONVERSATION_CHAT_COMPLETED','@nestjs/typeorm','knowledgeId','cozeModelEntity','batchBotProgressResult','ERROR','https://api.coze.cn','collect','all_file_size','../user/user.service','parse','CozeModelEntity','】条，当前【','SPACE_ID','preview_tos_url','updateKnowledge','avatar','tags','CozeKnowledgeEntity','vipFreeNum','setHeader','isRelease','defineProperty','identity','getBot','cozeMessageEntity','default','getCozeApi','CONVERSATION_MESSAGE_COMPLETED','./entity/message.entity','uploadFile','content_type','GET','28NPETkV','createKnowledgeDocument','fileId','../badwords/badwords.service','bot_used_count','useCount','model_id','getMyBotList','1015927YFCttf','typeorm','publish','text/event-stream','object','document_name','findOne','batchKnowledgeResult','Like','axios','dataset_list','usage','】页-----------','status','botEntity','CozeApiConfig','includes','CozeWorkflowEntity','-----------------------------------uploadForUrlERROR----------','now','expires_in','batchKnowledgeProgressResult','validateBeforeChat','fileUrl','documents','HttpException','findAndCount','../file/file.service','299395BWtZyh','modelInfoConfig','data:\x20','BAD_REQUEST','workflow_info_list','processing_file_list','-------------获取智能体列表:共【','CozeMessageEntity','data','length','api','error','62556UHgqrl','update','onboarding_info','26061255mGgnjr','CONVERSATION_MESSAGE_DELTA','Content-Type','getOwnPropertyDescriptor','getModelList','setConversationName','__esModule','conversationId','appId','bots','metadata','source_type','user','delta','write','contentObject','getModelFree','iconFileId','hit_count','documentId','relId','document_id','COZEBOT','conversations','desc','page','bot_id','publishBot','bot_name','space_bots','find','web_url','--------------------------------------------------client.upload','4514960kZVKtd','status_descript','deductBalance4Coze','userId','log','responseMessage','doc_tree_tos_url','client.datasets.process','end','message','object_string','getBotList','Injectable','answer','file_list','会话不存在','char_count','save','---------------------------CozeChatError--------------------------','7474575122028871720','getConversationList','ChatEventType','forEach','Transfer-Encoding','modelId','description','ASC','../user/user.entity','upload','failed_file_list','knowledgeEntity','no-cache','模型不存在','5652708BajqAM','deleteKnowledgeDocument','createBot','tag','./entity/knowledge.entity','process','-----------------------------------createKnowledgeERROR----------','content','-------------智能体同步完成','deleteBot','DESC','count','filter','999','../../common/constants/collectType.constant','role','cmService','cozeConversationEntity','retrieve','topConversation','api.coze.cn','collectPage','getValue','startChat','deleteKnowledge','format_type','create','chunked','slice_count','function','workflowIdList','datasets','UserCollectType','getKnowledgeList','contentType','text','map','2999339vkLRGP','processing_file_id_list','privateKey','createKnowledge','event','InjectRepository','@coze/api','getJwtToken','createMessage','getKnowledegeDocument','./entity/model.entity','design:paramtypes','name','文档不存在！','BadwordsService','CozeService','uploadUrlToServer','stringify','./entity/bot.entity','createConversation','document_infos','files','decorate','Repository','statusCode','Guid','-----------------------CreateBotError---------------------------','spaceId','botId','CmConfigService','toString','doc_count','total','getKnowledgeDocumentList','dataset_id','8ksuFOK','https','deduct','./entity/workflow.entity','size','checkUserStatus','-----------------------------------uploadUrlToServerError----------','findBy','userService','onboardingInfo','update_rule','CozeBotEntity','iconFileUrl','messageId','__decorate','rows','keyid','知识库不存在！','智能体不存在！','UserEntity','当前智能体未匹配到对应模型，暂无法使用，请联系管理员添加','search','Access-Control-Allow-Origin','function_call','push','cozeWorkflowEntity','formatType','question','HttpStatus','fileService','chunkStrategy','chunk_strategy','DONE','get','isTop','deleteConversation','uploadForUrl','uncollect','X-Accel-Buffering','hot','stream','getCozeModelVipFree','delete','updateKnowledgeDocument','mergeCollectData','checkBadWords','list'];_0x4f09=function(){return _0x444807;};return _0x4f09();}var __decorate=this&&this[_0xb7860f(0x227)]||function(_0x4c9706,_0x246b8e,_0x19fbc4,_0x5ceaaa){const _0x6dfe87=_0xb7860f;var _0x3d5f68=arguments[_0x6dfe87(0x2a8)],_0x1967ef=_0x3d5f68<0x3?_0x246b8e:_0x5ceaaa===null?_0x5ceaaa=Object[_0x6dfe87(0x2b1)](_0x246b8e,_0x19fbc4):_0x5ceaaa,_0x235a3c;if(typeof Reflect===_0x6dfe87(0x287)&&typeof Reflect[_0x6dfe87(0x20c)]===_0x6dfe87(0x30d))_0x1967ef=Reflect[_0x6dfe87(0x20c)](_0x4c9706,_0x246b8e,_0x19fbc4,_0x5ceaaa);else{for(var _0x267b0e=_0x4c9706[_0x6dfe87(0x2a8)]-0x1;_0x267b0e>=0x0;_0x267b0e--)if(_0x235a3c=_0x4c9706[_0x267b0e])_0x1967ef=(_0x3d5f68<0x3?_0x235a3c(_0x1967ef):_0x3d5f68>0x3?_0x235a3c(_0x246b8e,_0x19fbc4,_0x1967ef):_0x235a3c(_0x246b8e,_0x19fbc4))||_0x1967ef;}return _0x3d5f68>0x3&&_0x1967ef&&Object[_0x6dfe87(0x270)](_0x246b8e,_0x19fbc4,_0x1967ef),_0x1967ef;},__metadata=this&&this[_0xb7860f(0x24b)]||function(_0x13f32c,_0x265ea6){const _0x14439d=_0xb7860f;if(typeof Reflect==='object'&&typeof Reflect[_0x14439d(0x2b8)]===_0x14439d(0x30d))return Reflect[_0x14439d(0x2b8)](_0x13f32c,_0x265ea6);},__param=this&&this['__param']||function(_0x2eadf1,_0x45a6e1){return function(_0x5ca27d,_0x59f29d){_0x45a6e1(_0x5ca27d,_0x59f29d,_0x2eadf1);};};Object['defineProperty'](exports,_0xb7860f(0x2b4),{'value':!![]}),exports[_0xb7860f(0x205)]=void 0x0;const common_1=require(_0xb7860f(0x255)),typeorm_1=require(_0xb7860f(0x25b)),typeorm_2=require(_0xb7860f(0x284)),bot_entity_1=require(_0xb7860f(0x208)),knowledge_entity_1=require(_0xb7860f(0x2f4)),knowledgedocument_entity_1=require('./entity/knowledgedocument.entity'),api_1=require(_0xb7860f(0x1fc)),model_entity_1=require(_0xb7860f(0x200)),guid_typescript_1=require(_0xb7860f(0x258)),https_1=require(_0xb7860f(0x21a)),axios_1=require(_0xb7860f(0x28c)),conversation_entity_1=require(_0xb7860f(0x253)),message_entity_1=require(_0xb7860f(0x277)),user_entity_1=require(_0xb7860f(0x2ea)),user_service_1=require(_0xb7860f(0x263)),collectType_constant_1=require(_0xb7860f(0x2fe)),badwords_service_1=require(_0xb7860f(0x27e)),workflow_entity_1=require(_0xb7860f(0x21c)),cm_service_1=require('../cmConfig/cm.service'),file_service_1=require(_0xb7860f(0x29e)),uuid_1=require('uuid');let CozeService=class CozeService{constructor(_0xbfad54,_0x1cf602,_0x54b060,_0x397c60,_0x53152c,_0x438d2b,_0x43044f,_0x27e08b,_0x2cd4dc,_0x45eeaa,_0x2c330d,_0x25a617){const _0x57ff1a=_0xb7860f;this['botEntity']=_0xbfad54,this['knowledgeEntity']=_0x1cf602,this['knowledgeDocumentEntity']=_0x54b060,this['cozeModelEntity']=_0x397c60,this[_0x57ff1a(0x301)]=_0x53152c,this[_0x57ff1a(0x273)]=_0x438d2b,this[_0x57ff1a(0x232)]=_0x43044f,this['userEntity']=_0x27e08b,this[_0x57ff1a(0x221)]=_0x2cd4dc,this[_0x57ff1a(0x24c)]=_0x45eeaa,this[_0x57ff1a(0x300)]=_0x2c330d,this[_0x57ff1a(0x236)]=_0x25a617,this[_0x57ff1a(0x267)]=_0x57ff1a(0x2e2);}async['getJwtToken'](_0x57aeba){const _0x5458b6=_0xb7860f;try{const _0x4291cc=await this['cmService'][_0x5458b6(0x306)](_0x5458b6(0x292)),_0x1adb69=_0x4291cc[_0x5458b6(0x2a9)][_0x5458b6(0x1f8)],_0x99bdbd=_0x4291cc[_0x5458b6(0x2a9)][_0x5458b6(0x2b6)],_0x5772e4=_0x4291cc[_0x5458b6(0x2a9)][_0x5458b6(0x229)];this[_0x5458b6(0x267)]=_0x4291cc[_0x5458b6(0x2a9)]['spaceId'];let _0x469978=await(0x0,api_1['getJWTToken'])({'baseURL':_0x5458b6(0x260),'appId':_0x99bdbd,'aud':_0x5458b6(0x304),'keyid':_0x5772e4,'privateKey':_0x1adb69,'sessionName':_0x57aeba+''});return _0x469978;}catch(_0xb245e6){return{'expires_in':0x0,'access_token':''};}}async[_0xb7860f(0x275)](_0x13cfed){const _0x244334=_0xb7860f;let _0x5ad02e=await this['getJwtToken'](_0x13cfed);const _0x3bf79a=new api_1['CozeAPI']({'baseURL':_0x244334(0x260),'token':async()=>{const _0x1a7682=_0x244334;if(_0x5ad02e[_0x1a7682(0x297)]*0x3e8>Date[_0x1a7682(0x296)]()+0x1388)return _0x5ad02e['access_token'];return _0x5ad02e=await this[_0x1a7682(0x1fd)](_0x13cfed),_0x5ad02e['access_token'];}});return _0x3bf79a;}async[_0xb7860f(0x2f2)](_0x83db87,_0x2f7c1d){const _0x40fcfa=_0xb7860f;if(_0x83db87[_0x40fcfa(0x225)]){const _0x4547ed=await this[_0x40fcfa(0x23d)](_0x83db87['iconFileUrl']);_0x83db87[_0x40fcfa(0x2bf)]=_0x4547ed['id'];}try{const _0x5b1a92=await this[_0x40fcfa(0x275)](_0x2f7c1d['user']['id']),_0x28e30b=await _0x5b1a92[_0x40fcfa(0x2b7)][_0x40fcfa(0x30a)]({'prompt_info':_0x83db87['promptInfo'],'onboarding_info':_0x83db87[_0x40fcfa(0x222)],'name':_0x83db87[_0x40fcfa(0x202)],'description':_0x83db87[_0x40fcfa(0x2e8)],'icon_file_id':_0x83db87[_0x40fcfa(0x2bf)],'space_id':this['SPACE_ID']});return _0x83db87[_0x40fcfa(0x212)]=_0x28e30b['bot_id'],_0x83db87[_0x40fcfa(0x2d2)]=_0x2f7c1d[_0x40fcfa(0x2ba)]['id'],_0x83db87[_0x40fcfa(0x211)]=this[_0x40fcfa(0x267)],await this[_0x40fcfa(0x291)][_0x40fcfa(0x2e0)](_0x83db87),_0x83db87;}catch(_0x59dbff){console['log'](_0x40fcfa(0x210),_0x59dbff);}}async[_0xb7860f(0x272)](_0xd8fce1,_0x1ea805){const _0x5b49cd=_0xb7860f;try{const _0x430e9d=await this['botEntity'][_0x5b49cd(0x289)]({'where':{'botId':_0xd8fce1}});if(!_0x430e9d||_0x430e9d[_0x5b49cd(0x2d2)]!=_0x1ea805['user']['id'])throw new Error(_0x5b49cd(0x22b));const _0x2023ba=await this[_0x5b49cd(0x275)](_0x1ea805['user']['id']);if(_0x430e9d[_0x5b49cd(0x26f)]==0x1){const _0x5bc0b1=await _0x2023ba['bots'][_0x5b49cd(0x302)]({'bot_id':_0xd8fce1});_0x430e9d[_0x5b49cd(0x2a0)]=_0x5bc0b1[_0x5b49cd(0x248)],_0x430e9d['workflowIdList']=_0x5bc0b1[_0x5b49cd(0x2a3)],_0x430e9d[_0x5b49cd(0x222)]=_0x5bc0b1['onboarding_info'],_0x430e9d['viewCount']+=0x1,await this['botEntity'][_0x5b49cd(0x2e0)](_0x430e9d);}return _0x430e9d;}catch(_0x996356){return _0x996356;}}async['updateBot'](_0x4bf341,_0x567279){const _0xed32b6=_0xb7860f,_0x13e48c=await this[_0xed32b6(0x291)]['findOne']({'where':{'botId':_0x4bf341[_0xed32b6(0x212)]}});if(!_0x13e48c||_0x13e48c['userId']!=_0x567279[_0xed32b6(0x2ba)]['id'])throw new Error(_0xed32b6(0x22b));if(_0x13e48c[_0xed32b6(0x225)]!=_0x4bf341['iconFileUrl']){const _0x56556c=await this[_0xed32b6(0x23d)](_0x4bf341['iconFileUrl']);_0x4bf341[_0xed32b6(0x2bf)]=_0x56556c['id'];}try{const _0x5487d4=await this[_0xed32b6(0x275)](_0x567279[_0xed32b6(0x2ba)]['id']);await _0x5487d4[_0xed32b6(0x2b7)][_0xed32b6(0x2ac)]({'prompt_info':_0x4bf341[_0xed32b6(0x251)],'onboarding_info':_0x4bf341[_0xed32b6(0x222)],'name':_0x4bf341[_0xed32b6(0x202)],'description':_0x4bf341[_0xed32b6(0x2e8)],'icon_file_id':_0x4bf341[_0xed32b6(0x2bf)],'knowledge':_0x4bf341['knowledge'],'bot_id':_0x4bf341[_0xed32b6(0x212)],'plugin_id_list':_0x4bf341['pluginIdList'],'workflow_id_list':_0x4bf341[_0xed32b6(0x30e)],'model_info_config':_0x4bf341[_0xed32b6(0x2a0)]}),Object['assign'](_0x13e48c,_0x4bf341),await this[_0xed32b6(0x291)][_0xed32b6(0x2e0)](_0x13e48c);}catch(_0x3fdc07){return _0x3fdc07;}}async[_0xb7860f(0x2f9)](_0x2d9aa1,_0x4959a1){const _0x469459=_0xb7860f,_0x25f265=await this[_0x469459(0x291)][_0x469459(0x289)]({'where':{'botId':_0x2d9aa1,'userId':_0x4959a1[_0x469459(0x2ba)]['id']}});if(!_0x25f265||_0x25f265[_0x469459(0x2d2)]!=_0x4959a1[_0x469459(0x2ba)]['id'])throw new Error(_0x469459(0x22b));await this['botEntity'][_0x469459(0x243)](_0x25f265['id']);}async['collectBot'](_0x23a874,_0x155591,_0x37b56d){const _0x4db3c0=_0xb7860f,_0x11d142=await this['botEntity'][_0x4db3c0(0x289)]({'where':{'botId':_0x23a874}});if(!_0x11d142)throw new Error(_0x4db3c0(0x22b));_0x37b56d==0x1?this[_0x4db3c0(0x221)][_0x4db3c0(0x261)](_0x155591['user']['id'],_0x11d142['id'],collectType_constant_1['UserCollectType'][_0x4db3c0(0x2c4)]):this['userService'][_0x4db3c0(0x23e)](_0x155591[_0x4db3c0(0x2ba)]['id'],_0x11d142['id'],collectType_constant_1['UserCollectType'][_0x4db3c0(0x2c4)]);}async[_0xb7860f(0x252)](_0x47367f,_0x234ba6){const _0x3d2e1f=_0xb7860f,_0x53b00d=await this[_0x3d2e1f(0x221)][_0x3d2e1f(0x305)](_0x47367f[_0x3d2e1f(0x2c7)],_0x47367f['size'],_0x234ba6[_0x3d2e1f(0x2ba)]['id'],collectType_constant_1['UserCollectType'][_0x3d2e1f(0x2c4)]);if(_0x53b00d[_0x3d2e1f(0x2fb)]>0x0){const _0xba6404=await this[_0x3d2e1f(0x291)][_0x3d2e1f(0x220)]({'id':(0x0,typeorm_2['In'])(_0x53b00d[_0x3d2e1f(0x228)]['map'](_0x5336f8=>_0x5336f8[_0x3d2e1f(0x2c2)]))});return{'rows':_0xba6404,'count':_0x53b00d[_0x3d2e1f(0x2fb)]};}return{'rows':[],'count':0x0};}async[_0xb7860f(0x282)](_0x3cf606,_0x5e1b2f){const _0x568c2f=_0xb7860f,_0x71c8b7={'userId':_0x5e1b2f[_0x568c2f(0x2ba)]['id']};_0x3cf606['tag']&&(_0x71c8b7[_0x568c2f(0x26b)]=(0x0,typeorm_2['Like'])('%'+_0x3cf606['tag']+'%'));_0x3cf606[_0x568c2f(0x22e)]&&(_0x71c8b7[_0x568c2f(0x202)]=(0x0,typeorm_2[_0x568c2f(0x28b)])('%'+_0x3cf606[_0x568c2f(0x22e)]+'%'));const [_0x3b531c,_0x47e56f]=await this[_0x568c2f(0x291)]['findAndCount']({'where':_0x71c8b7,'order':{'id':_0x568c2f(0x2fa)},'skip':(_0x3cf606[_0x568c2f(0x2c7)]-0x1)*_0x3cf606[_0x568c2f(0x21d)],'take':_0x3cf606[_0x568c2f(0x21d)]}),_0x230626=await this[_0x568c2f(0x221)][_0x568c2f(0x245)](_0x3b531c,_0x5e1b2f,collectType_constant_1[_0x568c2f(0x1f1)][_0x568c2f(0x2c4)]);return{'rows':_0x230626,'count':_0x47e56f};}async['getChatBotList'](_0x347938,_0x3b9eb3){const _0x4106b2=_0xb7860f,_0x6752a7=await this['cozeConversationEntity'][_0x4106b2(0x2cc)]({'where':{'userId':_0x3b9eb3[_0x4106b2(0x2ba)]['id']}}),_0x391737=[...new Set(_0x6752a7[_0x4106b2(0x1f5)](_0x1da8c5=>_0x1da8c5[_0x4106b2(0x212)]))];if(!_0x391737[_0x4106b2(0x2a8)])return{'rows':[],'count':0x0};const _0x461d63={'botId':(0x0,typeorm_2['In'])(_0x391737)};_0x347938['tag']&&(_0x461d63[_0x4106b2(0x26b)]=(0x0,typeorm_2['Like'])('%'+_0x347938[_0x4106b2(0x2f3)]+'%'));_0x347938[_0x4106b2(0x22e)]&&(_0x461d63['name']=(0x0,typeorm_2[_0x4106b2(0x28b)])('%'+_0x347938[_0x4106b2(0x22e)]+'%'));const [_0x3a6b8a,_0x4ee56d]=await this[_0x4106b2(0x291)][_0x4106b2(0x29d)]({'where':_0x461d63,'order':{'id':_0x4106b2(0x2fa)},'skip':(_0x347938[_0x4106b2(0x2c7)]-0x1)*_0x347938['size'],'take':_0x347938[_0x4106b2(0x21d)]}),_0x864414=await this['userService']['mergeCollectData'](_0x3a6b8a,_0x3b9eb3,collectType_constant_1[_0x4106b2(0x1f1)]['COZEBOT']);return{'rows':_0x864414,'count':_0x4ee56d};}async[_0xb7860f(0x2da)](_0x489d48,_0x4af8cf){const _0xc12467=_0xb7860f,_0x5cf755=[{'userId':0x0},{'publish_flag':0x1}];_0x489d48[_0xc12467(0x2f3)]&&_0x5cf755[_0xc12467(0x2e5)](_0x4264c3=>{const _0x84ac55=_0xc12467;_0x4264c3[_0x84ac55(0x26b)]=(0x0,typeorm_2[_0x84ac55(0x28b)])('%'+_0x489d48[_0x84ac55(0x2f3)]+'%');});_0x489d48[_0xc12467(0x22e)]&&_0x5cf755['forEach'](_0xf712d3=>{const _0x4cdc05=_0xc12467;_0xf712d3[_0x4cdc05(0x202)]=(0x0,typeorm_2[_0x4cdc05(0x28b)])('%'+_0x489d48[_0x4cdc05(0x22e)]+'%');});_0x5cf755[_0xc12467(0x2e5)](_0x198fcc=>{const _0x24cb98=_0xc12467;_0x198fcc[_0x24cb98(0x26f)]=0x1;});let _0x3c87ea={'id':_0xc12467(0x2fa)};if(_0x489d48[_0xc12467(0x257)]==_0xc12467(0x240))_0x3c87ea={'useCount':_0xc12467(0x2fa)};else _0x489d48[_0xc12467(0x257)]=='recommend'?_0x3c87ea={'recommendAt':_0xc12467(0x2fa)}:_0x3c87ea={'id':_0xc12467(0x2fa)};const _0x34134d=await this[_0xc12467(0x291)][_0xc12467(0x29d)]({'where':_0x5cf755,'order':_0x3c87ea,'skip':(_0x489d48[_0xc12467(0x2c7)]-0x1)*_0x489d48[_0xc12467(0x21d)],'take':_0x489d48[_0xc12467(0x21d)]}),[_0x26ad01,_0x552c4c]=_0x34134d,_0x13758f=await this[_0xc12467(0x256)][_0xc12467(0x2cc)]({'where':{'id':(0x0,typeorm_2['In'])(_0x26ad01['map'](_0x344594=>_0x344594[_0xc12467(0x2d2)]))}});_0x26ad01[_0xc12467(0x2e5)](_0x1d76db=>{const _0x30c2f8=_0xc12467;if(_0x1d76db[_0x30c2f8(0x2d2)]){const _0x2ad811=_0x13758f[_0x30c2f8(0x2cc)](_0x5a4251=>_0x5a4251['id']==_0x1d76db[_0x30c2f8(0x2d2)]);_0x1d76db['userInfo']={'userId':_0x2ad811['id'],'userName':_0x2ad811['nickname'],'avatar':_0x2ad811[_0x30c2f8(0x26a)]};}});const _0xb9710e=await this[_0xc12467(0x221)]['mergeCollectData'](_0x26ad01,_0x4af8cf,collectType_constant_1['UserCollectType'][_0xc12467(0x2c4)]);return{'rows':_0xb9710e,'count':_0x552c4c};}async[_0xb7860f(0x2c9)](_0x2fda27,_0x3b2047){const _0x8cc53b=_0xb7860f,_0x2e3e9d=await this['botEntity'][_0x8cc53b(0x289)]({'where':{'botId':_0x2fda27,'userId':_0x3b2047['user']['id']}});if(!_0x2e3e9d||_0x2e3e9d['userId']!=_0x3b2047['user']['id'])throw new Error(_0x8cc53b(0x22b));const _0x36be51=await this[_0x8cc53b(0x275)](_0x3b2047[_0x8cc53b(0x2ba)]['id']);await _0x36be51['bots'][_0x8cc53b(0x285)]({'bot_id':_0x2e3e9d[_0x8cc53b(0x212)],'connector_ids':['1024',_0x8cc53b(0x2fd)]}),_0x2e3e9d[_0x8cc53b(0x26f)]=0x1,await this[_0x8cc53b(0x291)][_0x8cc53b(0x2e0)](_0x2e3e9d);}async[_0xb7860f(0x2eb)](_0x4c6632,_0x5f2fd6){const _0x181d30=_0xb7860f,_0x10ad25=await this[_0x181d30(0x275)](_0x5f2fd6[_0x181d30(0x2ba)]['id']);try{const _0x21694b=await _0x10ad25[_0x181d30(0x20b)]['upload']({'file':_0x4c6632});return _0x21694b;}catch(_0x50b212){console['log'](_0x181d30(0x2ce),_0x50b212);}return![];}async['uploadForUrl'](_0x59d618){const _0x2351c2=_0xb7860f;try{const _0x55e54f=await this[_0x2351c2(0x275)](guid_typescript_1[_0x2351c2(0x20f)][_0x2351c2(0x30a)]()),_0x1fb13f=await(0x0,axios_1[_0x2351c2(0x274)])({'url':_0x59d618,'method':_0x2351c2(0x27a),'responseType':'stream','headers':{'Accept-Encoding':_0x2351c2(0x271)}}),_0xf7f696=_0x1fb13f[_0x2351c2(0x2a7)],_0x3ced28=await _0x55e54f[_0x2351c2(0x20b)][_0x2351c2(0x2eb)]({'file':_0xf7f696});return _0x3ced28;}catch(_0xd78f4f){console[_0x2351c2(0x2d3)](_0x2351c2(0x295),_0xd78f4f);}return null;}async[_0xb7860f(0x1f9)](_0x4337ab,_0x108609){const _0x4c46ea=_0xb7860f;try{const _0x4f2c91=await this[_0x4c46ea(0x23d)](_0x4337ab['fileUrl']);_0x4337ab['fileId']=_0x4f2c91['id'];const _0x3925d1=await this[_0x4c46ea(0x275)](_0x108609[_0x4c46ea(0x2ba)]['id']),_0x540c4d=await _0x3925d1[_0x4c46ea(0x30f)][_0x4c46ea(0x30a)]({'name':_0x4337ab[_0x4c46ea(0x202)],'description':_0x4337ab[_0x4c46ea(0x2e8)],'file_id':_0x4337ab[_0x4c46ea(0x27d)],'space_id':this[_0x4c46ea(0x267)],'format_type':_0x4337ab[_0x4c46ea(0x233)]});_0x4337ab[_0x4c46ea(0x211)]=this[_0x4c46ea(0x267)],_0x4337ab['knowledgeId']=_0x540c4d[_0x4c46ea(0x218)],_0x4337ab[_0x4c46ea(0x2d2)]=_0x108609[_0x4c46ea(0x2ba)]['id'],await this[_0x4c46ea(0x2ed)][_0x4c46ea(0x2e0)](_0x4337ab);}catch(_0x587e87){return console[_0x4c46ea(0x2d3)](_0x4c46ea(0x2f6),_0x587e87),_0x587e87;}}async[_0xb7860f(0x269)](_0x4a3c60,_0x4980ee){const _0x1c265b=_0xb7860f,_0x34a8ed=await this[_0x1c265b(0x2ed)][_0x1c265b(0x289)]({'where':{'knowledgeId':_0x4a3c60['knowledgeId']}});if(!_0x34a8ed||_0x34a8ed[_0x1c265b(0x2d2)]!=_0x4980ee[_0x1c265b(0x2ba)]['id'])throw new Error(_0x1c265b(0x22a));if(_0x34a8ed['fileUrl']!=_0x4a3c60[_0x1c265b(0x29a)]){const _0x6dd229=await this[_0x1c265b(0x23d)](_0x4a3c60[_0x1c265b(0x29a)]);_0x4a3c60['fileId']=_0x6dd229['id'];}const _0x87e341=await this[_0x1c265b(0x275)](_0x4980ee[_0x1c265b(0x2ba)]['id']);await _0x87e341[_0x1c265b(0x30f)][_0x1c265b(0x2ac)](_0x34a8ed[_0x1c265b(0x25c)],{'name':_0x4a3c60[_0x1c265b(0x202)],'description':_0x4a3c60['description'],'file_id':_0x4a3c60[_0x1c265b(0x27d)]}),await this[_0x1c265b(0x2ed)]['save'](_0x4a3c60);}async[_0xb7860f(0x308)](_0x46337a,_0x5736b5){const _0x3da1a1=_0xb7860f,_0xd4ccd0=await this[_0x3da1a1(0x2ed)]['findOne']({'where':{'knowledgeId':_0x46337a}});if(!_0xd4ccd0||_0xd4ccd0[_0x3da1a1(0x2d2)]!=_0x5736b5[_0x3da1a1(0x2ba)]['id'])throw new Error(_0x3da1a1(0x22a));const _0x25558e=await this[_0x3da1a1(0x275)](_0x5736b5[_0x3da1a1(0x2ba)]['id']),_0xd67551=await _0x25558e['datasets']['delete'](_0xd4ccd0[_0x3da1a1(0x25c)]);await this[_0x3da1a1(0x2ed)][_0x3da1a1(0x243)](_0xd4ccd0['id']);}async[_0xb7860f(0x1f2)](_0x21f1da,_0x3b4e6a){const _0x4a587b=_0xb7860f,_0x1d58bd={'userId':_0x3b4e6a[_0x4a587b(0x2ba)]['id']};_0x21f1da[_0x4a587b(0x22e)]&&(_0x1d58bd['name']=(0x0,typeorm_2[_0x4a587b(0x28b)])('%'+_0x21f1da[_0x4a587b(0x22e)]+'%'));const [_0x506957,_0xac4a54]=await this['knowledgeEntity'][_0x4a587b(0x29d)]({'where':_0x1d58bd,'order':{'id':_0x4a587b(0x2fa)},'skip':(_0x21f1da[_0x4a587b(0x2c7)]-0x1)*_0x21f1da[_0x4a587b(0x21d)],'take':_0x21f1da['size']});return{'rows':_0x506957,'count':_0xac4a54};}async[_0xb7860f(0x1ff)](_0x4f2596,_0x2008ad){const _0x5ab9fb=_0xb7860f;return await this['knowledgeDocumentEntity'][_0x5ab9fb(0x289)]({'where':{'documentId':_0x4f2596,'userId':_0x2008ad['user']['id']}});}async[_0xb7860f(0x217)](_0x24a0dc,_0x481036){const _0x57e6b6=_0xb7860f,_0x42ae30={'userId':_0x481036[_0x57e6b6(0x2ba)]['id'],'knowledgeId':_0x24a0dc[_0x57e6b6(0x25c)]};_0x24a0dc['search']&&(_0x42ae30[_0x57e6b6(0x202)]=(0x0,typeorm_2['Like'])('%'+_0x24a0dc[_0x57e6b6(0x22e)]+'%'));const [_0x287f46,_0x419e49]=await this[_0x57e6b6(0x24a)][_0x57e6b6(0x29d)]({'where':_0x42ae30,'order':{'id':'DESC'},'skip':(_0x24a0dc[_0x57e6b6(0x2c7)]-0x1)*_0x24a0dc[_0x57e6b6(0x21d)],'take':_0x24a0dc[_0x57e6b6(0x21d)]});return{'rows':_0x287f46,'count':_0x419e49};}async[_0xb7860f(0x27c)](_0x464ba5,_0x3fe35c){const _0x144faa=_0xb7860f;try{const _0x3884aa=await this['getCozeApi'](_0x3fe35c[_0x144faa(0x2ba)]['id']),_0x6b65f6=await _0x3884aa['datasets']['documents'][_0x144faa(0x30a)]({'dataset_id':_0x464ba5[_0x144faa(0x25c)],'document_bases':_0x464ba5['documentBases'],'chunk_strategy':_0x464ba5[_0x144faa(0x237)],'format_type':_0x464ba5[_0x144faa(0x233)]});let _0x430263=[];for(const _0x341af8 of _0x6b65f6){_0x430263['push'](await this[_0x144faa(0x24a)][_0x144faa(0x2e0)]({'userId':_0x3fe35c['user']['id'],'spaceId':this[_0x144faa(0x267)],'knowledgeId':_0x464ba5['knowledgeId'],'name':_0x341af8[_0x144faa(0x202)],'documentId':_0x341af8[_0x144faa(0x2c3)],'charCount':_0x341af8[_0x144faa(0x2df)],'chunkStrategy':_0x341af8[_0x144faa(0x238)],'formatType':_0x341af8['format_type'],'hitCount':_0x341af8[_0x144faa(0x2c0)],'size':_0x341af8[_0x144faa(0x21d)],'sliceCount':_0x341af8[_0x144faa(0x30c)],'status':_0x341af8[_0x144faa(0x290)],'type':_0x341af8['type']}));}return console['log']('client.datasets.document.create',_0x6b65f6),_0x430263;}catch(_0x5f20f5){return console[_0x144faa(0x2d3)]('-----------------------------------createKnowledgeDocumentERROR----------',_0x5f20f5),_0x5f20f5;}}async[_0xb7860f(0x244)](_0x5a0e30,_0x7cd52d){const _0xc8ea91=_0xb7860f;try{const _0x5aee40=await this[_0xc8ea91(0x24a)]['findOne']({'where':{'documentId':_0x5a0e30[_0xc8ea91(0x2c3)]}});if(!_0x5aee40||_0x5aee40[_0xc8ea91(0x2d2)]!=_0x7cd52d[_0xc8ea91(0x2ba)]['id'])throw new Error(_0xc8ea91(0x203));_0x5aee40['updateRule']=_0x5a0e30[_0xc8ea91(0x223)],_0x5aee40[_0xc8ea91(0x202)]=_0x5a0e30[_0xc8ea91(0x288)],await this['knowledgeDocumentEntity'][_0xc8ea91(0x2e0)](_0x5aee40);const _0x95c04=await this[_0xc8ea91(0x275)](_0x7cd52d['user']['id']),_0x54fd82=await _0x95c04[_0xc8ea91(0x30f)][_0xc8ea91(0x29b)][_0xc8ea91(0x2ac)](_0x5a0e30);return _0x54fd82;}catch(_0x520b14){return _0x520b14;}}async[_0xb7860f(0x2f1)](_0x764faa,_0x564076){const _0x89c149=_0xb7860f,_0x44f44e=await this[_0x89c149(0x24a)][_0x89c149(0x289)]({'where':{'documentId':_0x764faa}});if(!_0x44f44e||_0x44f44e['userId']!=_0x564076[_0x89c149(0x2ba)]['id'])throw new Error(_0x89c149(0x203));await this[_0x89c149(0x24a)]['delete']({'documentId':_0x764faa,'userId':_0x564076[_0x89c149(0x2ba)]['id']});const _0x15cbd6=await this[_0x89c149(0x275)](_0x564076['user']['id']),_0x203838=await _0x15cbd6['datasets'][_0x89c149(0x29b)][_0x89c149(0x243)]({'document_ids':[_0x44f44e['documentId']]});console[_0x89c149(0x2d3)]('client.datasets.document.delete',_0x203838);}async['getKnowledgeDocumentProgress'](_0x4fe2ed,_0x3e618a,_0x2bfc98){const _0x7bfddb=_0xb7860f,_0x32975c=await this[_0x7bfddb(0x275)](_0x2bfc98['user']['id']),_0x464a3f=await _0x32975c[_0x7bfddb(0x30f)]['process'](_0x4fe2ed,_0x3e618a);console[_0x7bfddb(0x2d3)](_0x7bfddb(0x2d6),_0x464a3f);}async[_0xb7860f(0x2b2)](){const _0x22c2de=_0xb7860f;return await this[_0x22c2de(0x25d)][_0x22c2de(0x2cc)]({'where':{'isRelease':0x1},'order':{'sortIndex':'DESC','id':_0x22c2de(0x2fa)}});}async['getRemoteFileStream'](_0x533b93){return new Promise((_0x32b30e,_0x22b603)=>{const _0x48df64=_0xcc03;https_1['default'][_0x48df64(0x23a)](_0x533b93,_0x3f8eaa=>{const _0x40e6e8=_0x48df64;if(_0x3f8eaa['statusCode']!==0xc8){_0x22b603(new Error(_0x40e6e8(0x259)+_0x3f8eaa[_0x40e6e8(0x20e)]));return;}_0x32b30e(_0x3f8eaa);})['on'](_0x48df64(0x2aa),_0x37925c=>{_0x22b603(_0x37925c);});});}async[_0xb7860f(0x2e3)](_0x43c246,_0x2335ed){const _0x2d5426=_0xb7860f,_0x9989c2={'userId':_0x2335ed['user']['id'],'botId':_0x43c246['botId']},[_0x211d76,_0x5a88e4]=await this['cozeConversationEntity'][_0x2d5426(0x29d)]({'where':_0x9989c2,'order':{'isTop':_0x2d5426(0x2c6),'id':_0x2d5426(0x2fa)},'skip':(_0x43c246[_0x2d5426(0x2c7)]-0x1)*_0x43c246[_0x2d5426(0x21d)],'take':_0x43c246[_0x2d5426(0x21d)]});return{'rows':_0x211d76,'count':_0x5a88e4};}async[_0xb7860f(0x209)](_0x2e4dd7,_0x1acd4d){const _0x2b782c=_0xb7860f;try{const _0x44c78f=await this[_0x2b782c(0x275)](_0x1acd4d[_0x2b782c(0x2ba)]['id']),_0x2baf84=await _0x44c78f[_0x2b782c(0x2c5)][_0x2b782c(0x30a)]({'bot_id':_0x2e4dd7[_0x2b782c(0x212)]});_0x2e4dd7['userId']=_0x1acd4d[_0x2b782c(0x2ba)]['id'],_0x2e4dd7[_0x2b782c(0x2b5)]=_0x2baf84['id'];const _0x4a92dc=await this[_0x2b782c(0x291)][_0x2b782c(0x289)]({'where':{'botId':_0x2e4dd7[_0x2b782c(0x212)]}});return _0x4a92dc[_0x2b782c(0x280)]=_0x4a92dc['useCount']?_0x4a92dc[_0x2b782c(0x280)]+0x1:0x1,await this[_0x2b782c(0x291)][_0x2b782c(0x2e0)](_0x4a92dc),await this[_0x2b782c(0x301)][_0x2b782c(0x2e0)](_0x2e4dd7);}catch(_0x506644){return _0x506644;}}async[_0xb7860f(0x23c)](_0x500e95,_0x184ce2){const _0x52d4ed=_0xb7860f;return await this[_0x52d4ed(0x301)][_0x52d4ed(0x243)]({'conversationId':_0x500e95,'userId':_0x184ce2[_0x52d4ed(0x2ba)]['id']}),!![];}async[_0xb7860f(0x2b3)](_0x4fd66d,_0x385464,_0x3fe59e){const _0x549483=_0xb7860f,_0x14effb=await this[_0x549483(0x301)][_0x549483(0x289)]({'where':{'conversationId':_0x4fd66d,'userId':_0x3fe59e['user']['id']}});if(!_0x14effb)throw new Error(_0x549483(0x24f));_0x14effb[_0x549483(0x202)]=_0x385464,await this[_0x549483(0x301)][_0x549483(0x2e0)](_0x14effb);}async[_0xb7860f(0x303)](_0x431e69,_0x487983,_0x3fea6d){const _0x33fa5f=_0xb7860f;try{const _0x43692=await this['cozeConversationEntity'][_0x33fa5f(0x289)]({'where':{'conversationId':_0x431e69,'userId':_0x3fea6d[_0x33fa5f(0x2ba)]['id']}});if(!_0x43692)throw new Error('会话不存在！');_0x43692[_0x33fa5f(0x23b)]=_0x487983==0x1?0x1:0x0,await this[_0x33fa5f(0x301)]['save'](_0x43692);}catch(_0x29e9ce){return _0x29e9ce[_0x33fa5f(0x2d8)];}}async[_0xb7860f(0x254)](_0x458f56,_0x44ec8d){const _0x4cd768=_0xb7860f,_0x109490={'userId':_0x44ec8d[_0x4cd768(0x2ba)]['id'],'conversationId':_0x458f56['conversationId']},[_0x2c4535,_0x35f77e]=await this[_0x4cd768(0x273)]['findAndCount']({'where':_0x109490,'order':{'id':'DESC'},'skip':(_0x458f56[_0x4cd768(0x2c7)]-0x1)*_0x458f56[_0x4cd768(0x21d)],'take':_0x458f56[_0x4cd768(0x21d)]});return{'rows':_0x2c4535,'count':_0x35f77e};}async[_0xb7860f(0x1fe)](_0x1a3fb0,_0x4a83bd){const _0x98108d=_0xb7860f,_0x51a4d0=await this['getCozeApi'](_0x4a83bd['user']['id']),_0x4d0400=await _0x51a4d0[_0x98108d(0x2c5)]['messages']['create'](_0x1a3fb0[_0x98108d(0x2b5)],{'role':_0x1a3fb0[_0x98108d(0x2ff)],'content':_0x1a3fb0[_0x98108d(0x2f7)],'content_type':_0x1a3fb0[_0x98108d(0x1f3)],'meta_data':{}});_0x1a3fb0[_0x98108d(0x226)]=_0x4d0400['id'],this[_0x98108d(0x273)]['save'](_0x1a3fb0);}[_0xb7860f(0x2d4)](_0x1ad8f8,_0x1a4059){const _0x163295=_0xb7860f;_0x1ad8f8[_0x163295(0x2bc)](_0x163295(0x2a1)+JSON['stringify'](_0x1a4059)+'\x0a\x0a');}async[_0xb7860f(0x299)](_0x5a2bbc){const _0xe8f42=_0xb7860f,{user:_0x30b70a,prompt:_0x4b5b22,model:_0x1c74b3}=_0x5a2bbc;await this[_0xe8f42(0x221)][_0xe8f42(0x21e)](_0x30b70a),await this['badwordsService'][_0xe8f42(0x246)](_0x4b5b22,_0x30b70a['id']),await this[_0xe8f42(0x221)]['validateBalance4Coze'](_0x30b70a['id'],_0x1c74b3[_0xe8f42(0x2e7)],_0x1c74b3[_0xe8f42(0x26d)],_0x1c74b3['deduct']);}async[_0xb7860f(0x307)](_0x2c8cee,_0x1cb19a,_0x50efae){const _0x315d2e=_0xb7860f;_0x50efae['setHeader'](_0x315d2e(0x2b0),_0x315d2e(0x286)),_0x50efae[_0x315d2e(0x26e)](_0x315d2e(0x2e6),_0x315d2e(0x30b)),_0x50efae[_0x315d2e(0x26e)](_0x315d2e(0x250),_0x315d2e(0x2ee)),_0x50efae[_0x315d2e(0x26e)](_0x315d2e(0x23f),'no'),_0x50efae[_0x315d2e(0x26e)](_0x315d2e(0x22f),'*');try{const _0x3b0aba=await this['cozeConversationEntity'][_0x315d2e(0x289)]({'where':{'userId':_0x1cb19a['user']['id'],'conversationId':_0x2c8cee[_0x315d2e(0x2b5)]}});if(!_0x3b0aba){this[_0x315d2e(0x2d4)](_0x50efae,{'content':_0x315d2e(0x2de),'contentType':'','isEnd':![],'isError':!![]});return;}const _0x5df7c6=await this['userService']['getUserById'](_0x1cb19a['user']['id']),_0x50d592=await this[_0x315d2e(0x275)](_0x1cb19a[_0x315d2e(0x2ba)]['id']),_0x2bea13=await _0x50d592['bots']['retrieve']({'bot_id':_0x3b0aba[_0x315d2e(0x212)]}),_0x418c26=await this['botEntity']['findOne']({'where':{'botId':_0x3b0aba[_0x315d2e(0x212)]}});_0x418c26[_0x315d2e(0x2a0)]=_0x2bea13['model_info'],_0x418c26[_0x315d2e(0x30e)]=_0x2bea13[_0x315d2e(0x2a3)],_0x418c26[_0x315d2e(0x222)]=_0x2bea13[_0x315d2e(0x2ad)],await this['botEntity']['save'](_0x418c26);const _0x7265f5=await this['cozeModelEntity'][_0x315d2e(0x289)]({'where':{'modelId':_0x2bea13[_0x315d2e(0x248)]['model_id']}});if(!_0x7265f5){this[_0x315d2e(0x2d4)](_0x50efae,{'content':_0x315d2e(0x22d),'contentType':'','isEnd':![],'isError':!![]});return;}this[_0x315d2e(0x299)]({'prompt':_0x2c8cee[_0x315d2e(0x2f7)][_0x315d2e(0x214)](),'user':_0x5df7c6,'model':_0x7265f5});const _0x5c217a=await this[_0x315d2e(0x273)][_0x315d2e(0x2cc)]({'where':{'conversationId':_0x2c8cee[_0x315d2e(0x2b5)]},'order':{'id':_0x315d2e(0x2e9)}});let _0x44ce13=[];_0x5c217a[_0x315d2e(0x2e5)](_0x260cf1=>{const _0x5a4fae=_0x315d2e;let _0x52ddf9=_0x260cf1['content'];_0x260cf1['contentType']=='object_string'&&(_0x52ddf9=JSON[_0x5a4fae(0x207)](_0x260cf1[_0x5a4fae(0x2bd)])),_0x44ce13[_0x5a4fae(0x231)]({'role':_0x260cf1[_0x5a4fae(0x2ff)],'content':_0x52ddf9,'content_type':_0x260cf1[_0x5a4fae(0x1f3)],'type':_0x260cf1[_0x5a4fae(0x257)]});});typeof _0x2c8cee[_0x315d2e(0x2f7)]==='string'?_0x44ce13[_0x315d2e(0x231)]({'content':_0x2c8cee['content'],'content_type':_0x315d2e(0x1f4),'role':_0x315d2e(0x2ba),'type':'question'}):_0x44ce13[_0x315d2e(0x231)]({'content':JSON[_0x315d2e(0x207)](_0x2c8cee[_0x315d2e(0x2f7)]),'content_type':'object_string','role':_0x315d2e(0x2ba),'type':_0x315d2e(0x234)});const _0x584f7e=await _0x50d592['chat'][_0x315d2e(0x241)]({'bot_id':_0x3b0aba['botId'],'user_id':_0x1cb19a[_0x315d2e(0x2ba)]['id'][_0x315d2e(0x214)](),'auto_save_history':!![],'additional_messages':_0x44ce13});let _0x364fef,_0x2e1f27='',_0x2da405='',_0x30b626='',_0x28fbee,_0x9c4b89=[];for await(const _0x51f72e of _0x584f7e){if(_0x51f72e[_0x315d2e(0x1fa)]===api_1[_0x315d2e(0x2e4)]['CONVERSATION_CHAT_CREATED'])_0x2da405=_0x315d2e(0x24e),_0x364fef=_0x51f72e,_0x30b626=_0x51f72e[_0x315d2e(0x2a7)]['id'];else{if(_0x51f72e[_0x315d2e(0x1fa)]===api_1[_0x315d2e(0x2e4)][_0x315d2e(0x2af)])_0x2e1f27+=_0x51f72e[_0x315d2e(0x2a7)]['content'],this[_0x315d2e(0x2d4)](_0x50efae,{'content':_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x2f7)],'contentType':_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x279)],'isEnd':![],'isError':![]}),_0x2da405=_0x315d2e(0x2bb);else{if(_0x51f72e[_0x315d2e(0x1fa)]===api_1[_0x315d2e(0x2e4)][_0x315d2e(0x276)])_0x2da405='delta',_0x28fbee=_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x28e)],_0x51f72e['data'][_0x315d2e(0x257)]==_0x315d2e(0x230)&&_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x2f7)]&&(_0x9c4b89[_0x315d2e(0x231)]({'type':_0x51f72e[_0x315d2e(0x2a7)]['type'],'content':JSON[_0x315d2e(0x264)](_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x2f7)])}),this[_0x315d2e(0x2d4)](_0x50efae,{'content':_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x2f7)],'type':_0x51f72e[_0x315d2e(0x2a7)]['type'],'contentType':_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x279)],'isEnd':![],'isError':![],'usage':_0x51f72e['data'][_0x315d2e(0x28e)]}));else{if(_0x51f72e['event']===api_1['ChatEventType'][_0x315d2e(0x25a)])_0x2da405='completed',_0x28fbee=_0x51f72e[_0x315d2e(0x2a7)][_0x315d2e(0x28e)],this[_0x315d2e(0x2d4)](_0x50efae,{'content':'','isEnd':!![],'isError':![],'usage':_0x51f72e['data']['usage']});else{if(_0x51f72e[_0x315d2e(0x1fa)]===api_1[_0x315d2e(0x2e4)][_0x315d2e(0x239)])_0x2da405=_0x315d2e(0x2d7),this[_0x315d2e(0x2d4)](_0x50efae,{'content':'','contentType':'','isEnd':!![],'isError':![]});else _0x51f72e[_0x315d2e(0x1fa)]===api_1[_0x315d2e(0x2e4)][_0x315d2e(0x25f)]&&(_0x2da405=_0x315d2e(0x2aa),console[_0x315d2e(0x2d3)](_0x315d2e(0x2e1),_0x51f72e),this['responseMessage'](_0x50efae,{'content':'','contentType':'','isEnd':![],'isError':!![],'errorData':_0x51f72e}));}}}}}const _0x5caf71=await this[_0x315d2e(0x273)]['save']({'botId':_0x3b0aba[_0x315d2e(0x212)],'userId':_0x1cb19a[_0x315d2e(0x2ba)]['id'],'spaceId':this[_0x315d2e(0x267)],'messageId':_0x30b626,'type':_0x315d2e(0x234),'contentType':typeof _0x2c8cee[_0x315d2e(0x2f7)]==='string'?_0x315d2e(0x1f4):_0x315d2e(0x2d9),'conversationId':_0x3b0aba[_0x315d2e(0x2b5)],'content':typeof _0x2c8cee[_0x315d2e(0x2f7)]==='string'?_0x2c8cee[_0x315d2e(0x2f7)]:'','contentObject':typeof _0x2c8cee['content']!=='string'?_0x2c8cee[_0x315d2e(0x2f7)]:[],'role':_0x315d2e(0x2ba),'parentId':0x0});await this[_0x315d2e(0x273)]['save']({'botId':_0x3b0aba[_0x315d2e(0x212)],'userId':_0x1cb19a['user']['id'],'spaceId':this['SPACE_ID'],'messageId':_0x30b626,'conversationId':_0x3b0aba[_0x315d2e(0x2b5)],'type':_0x315d2e(0x2dc),'content':_0x2e1f27,'content_type':'text','role':'assistant','usage':_0x28fbee,'status':_0x2da405,'parentId':_0x5caf71['id'],'contentObject':_0x9c4b89}),await this[_0x315d2e(0x221)][_0x315d2e(0x2d1)](_0x1cb19a[_0x315d2e(0x2ba)]['id'],_0x7265f5['modelId'],_0x7265f5[_0x315d2e(0x202)],_0x7265f5[_0x315d2e(0x26d)],_0x7265f5['deduct'],_0x30b626);}catch(_0x675f9f){return console['error']('error\x20from\x20startChat!',_0x675f9f),_0x675f9f;}}async['getWorkflowList'](_0x3180c6){const _0x22d0e2=_0xb7860f,_0x4e51c2={'isRelease':0x1};_0x3180c6[_0x22d0e2(0x22e)]&&(_0x4e51c2[_0x22d0e2(0x202)]=(0x0,typeorm_2[_0x22d0e2(0x28b)])('%'+_0x3180c6[_0x22d0e2(0x22e)]+'%'));const [_0x492480,_0x1efdd4]=await this[_0x22d0e2(0x232)][_0x22d0e2(0x29d)]({'where':_0x4e51c2,'order':{'id':_0x22d0e2(0x2fa)},'skip':(_0x3180c6[_0x22d0e2(0x2c7)]-0x1)*_0x3180c6[_0x22d0e2(0x21d)],'take':_0x3180c6['size']});return{'rows':_0x492480,'count':_0x1efdd4};}async[_0xb7860f(0x28a)](){const _0x1a5123=_0xb7860f,_0x5d4652=await this[_0x1a5123(0x275)]('');let _0x31e23a=0x1;while(!![]){const _0x4a3a6b=await this[_0x1a5123(0x2ed)][_0x1a5123(0x2cc)]({'where':{'spaceId':this['SPACE_ID']}});let _0x5c2e26=await _0x5d4652[_0x1a5123(0x30f)][_0x1a5123(0x247)]({'space_id':this['SPACE_ID'],'page_num':_0x31e23a,'page_size':0x12c});if(!_0x5c2e26[_0x1a5123(0x28d)]||_0x5c2e26[_0x1a5123(0x28d)][_0x1a5123(0x2a8)]==0x0)break;_0x5c2e26=_0x5c2e26[_0x1a5123(0x28d)][_0x1a5123(0x2fc)](_0x2e9680=>_0x4a3a6b[_0x1a5123(0x1f5)](_0x42b92d=>_0x42b92d[_0x1a5123(0x25c)])[_0x1a5123(0x293)](_0x2e9680['dataset_id']));for(let _0x141fa1 of _0x5c2e26){await this[_0x1a5123(0x2ed)]['update']({'knowledgeId':_0x141fa1[_0x1a5123(0x218)]},{'botUsedCount':_0x141fa1[_0x1a5123(0x27f)],'processingFileList':_0x141fa1[_0x1a5123(0x2a4)],'failedFileList':_0x141fa1[_0x1a5123(0x2ec)],'formatType':_0x141fa1[_0x1a5123(0x309)],'processingFileIdList':_0x141fa1[_0x1a5123(0x1f7)],'allFileSize':_0x141fa1[_0x1a5123(0x262)],'hitCount':_0x141fa1['hit_count'],'docCount':_0x141fa1[_0x1a5123(0x215)],'fileList':_0x141fa1[_0x1a5123(0x2dd)],'chunkStrategy':_0x141fa1['chunk_strategy']});let _0x231701=0x1;while(!![]){const _0x252518=await _0x5d4652[_0x1a5123(0x30f)][_0x1a5123(0x29b)][_0x1a5123(0x247)]({'dataset_id':_0x141fa1['dataset_id'],'page':_0x231701,'page_size':0x12c});if(!_0x252518[_0x1a5123(0x20a)]||_0x252518['document_infos'][_0x1a5123(0x2a8)]==0x0)break;for(let _0x51305c of _0x252518['document_infos']){await this[_0x1a5123(0x24a)]['update']({'documentId':_0x51305c['document_id']},{'charCount':_0x51305c[_0x1a5123(0x2df)],'status':_0x51305c[_0x1a5123(0x290)],'chunkStrategy':_0x51305c[_0x1a5123(0x238)],'formatType':_0x51305c[_0x1a5123(0x309)],'hitCount':_0x51305c[_0x1a5123(0x2c0)],'size':_0x51305c[_0x1a5123(0x21d)],'sliceCount':_0x51305c[_0x1a5123(0x30c)],'sourceType':_0x51305c[_0x1a5123(0x2b9)],'type':_0x51305c[_0x1a5123(0x257)],'docTreeTosUrl':_0x51305c[_0x1a5123(0x2d5)],'previewTosUrl':_0x51305c[_0x1a5123(0x268)],'webUrl':_0x51305c[_0x1a5123(0x2cd)]});}_0x231701++;}}_0x31e23a++;}}async[_0xb7860f(0x298)](){const _0xd811e8=_0xb7860f,_0x50e2cc=await this[_0xd811e8(0x275)](''),_0x13f9f3=await this[_0xd811e8(0x24a)][_0xd811e8(0x2cc)]({'where':{'progress':(0x0,typeorm_2[_0xd811e8(0x24d)])(0x64)}});if(_0x13f9f3[_0xd811e8(0x2a8)])for(let _0x378ddf of _0x13f9f3){const _0x59bec9=await _0x50e2cc['datasets'][_0xd811e8(0x2f5)](_0x378ddf[_0xd811e8(0x25c)],{'document_ids':[_0x378ddf[_0xd811e8(0x2c1)]]});if(_0x59bec9[_0xd811e8(0x2a7)][_0xd811e8(0x2a8)])for(let _0x1c05ac of _0x59bec9[_0xd811e8(0x2a7)]){await this[_0xd811e8(0x24a)][_0xd811e8(0x2ac)]({'documentId':_0x1c05ac[_0xd811e8(0x2c3)]},{'progress':_0x1c05ac['progress'],'size':_0x1c05ac[_0xd811e8(0x21d)],'remainingTime':_0x1c05ac['remaining_time'],'statusDescript':_0x1c05ac[_0xd811e8(0x2d0)]});}}}async[_0xb7860f(0x25e)](){const _0x5cd1f5=_0xb7860f,_0x2315b5=await this[_0x5cd1f5(0x275)]('');let _0x5e5efe=0x1;while(!![]){const _0x37c5ec=await _0x2315b5[_0x5cd1f5(0x2b7)]['list']({'space_id':this[_0x5cd1f5(0x267)],'page_index':_0x5e5efe});if(!_0x37c5ec[_0x5cd1f5(0x2cb)][_0x5cd1f5(0x2a8)])break;for(let _0x439da6=0x0;_0x439da6<_0x37c5ec[_0x5cd1f5(0x2cb)]['length'];_0x439da6++){const _0x199094=await this[_0x5cd1f5(0x291)]['findOne']({'where':{'botId':_0x37c5ec[_0x5cd1f5(0x2cb)][_0x439da6][_0x5cd1f5(0x2c8)]}});if(!_0x199094){const _0x908829=await this[_0x5cd1f5(0x206)](_0x37c5ec[_0x5cd1f5(0x2cb)][_0x439da6]['icon_url']);await this[_0x5cd1f5(0x291)]['save']({'spaceId':this[_0x5cd1f5(0x267)],'botId':_0x37c5ec[_0x5cd1f5(0x2cb)][_0x439da6]['bot_id'],'name':_0x37c5ec[_0x5cd1f5(0x2cb)][_0x439da6][_0x5cd1f5(0x2ca)],'description':_0x37c5ec[_0x5cd1f5(0x2cb)][_0x439da6][_0x5cd1f5(0x2e8)],'iconFileUrl':_0x908829,'isRelease':0x1,'publish_flag':0x0});}}_0x5e5efe++,console[_0x5cd1f5(0x2d3)](_0x5cd1f5(0x2a5)+_0x37c5ec[_0x5cd1f5(0x216)]+_0x5cd1f5(0x266)+_0x5e5efe+_0x5cd1f5(0x28f),_0x5e5efe);}console[_0x5cd1f5(0x2d3)](_0x5cd1f5(0x2f8));}async[_0xb7860f(0x206)](_0x100cae){const _0x228e16=_0xb7860f;try{const _0xb167a3=await(0x0,axios_1[_0x228e16(0x274)])({'url':_0x100cae,'method':_0x228e16(0x27a),'responseType':_0x228e16(0x241),'headers':{'Accept-Encoding':'identity'}}),_0x4fe3ee=_0xb167a3[_0x228e16(0x2a7)];let _0x2b2749=(0x0,uuid_1['v4'])();return await this[_0x228e16(0x236)][_0x228e16(0x278)]({'filename':_0x2b2749,'buffer':_0x4fe3ee});}catch(_0x149fe3){console[_0x228e16(0x2d3)](_0x228e16(0x21f),_0x149fe3);}return null;}async[_0xb7860f(0x2be)](_0x362e01,_0x4be648){const _0x2a4bc7=_0xb7860f,_0x1e5f90=_0x362e01[_0x2a4bc7(0x2ba)]?.['id'],_0x5d80c5=await this['cozeConversationEntity'][_0x2a4bc7(0x289)]({'where':{'userId':_0x362e01[_0x2a4bc7(0x2ba)]['id'],'conversationId':_0x4be648[_0x2a4bc7(0x2b5)]}});if(!_0x5d80c5)throw new common_1[(_0x2a4bc7(0x29c))](_0x2a4bc7(0x2de),common_1['HttpStatus'][_0x2a4bc7(0x2a2)]);const _0x509ac9=await this['getCozeApi'](_0x362e01['user']['id']),_0x3c760f=await _0x509ac9[_0x2a4bc7(0x2b7)]['retrieve']({'bot_id':_0x5d80c5[_0x2a4bc7(0x212)]}),_0x3dcaac=await this[_0x2a4bc7(0x25d)]['findOne']({'where':{'modelId':_0x3c760f[_0x2a4bc7(0x248)][_0x2a4bc7(0x281)]}});if(!_0x3dcaac)throw new common_1['HttpException'](_0x2a4bc7(0x2ef),common_1[_0x2a4bc7(0x235)][_0x2a4bc7(0x2a2)]);if(!_0x1e5f90)return{'remainCount':0x0,'freeCount':0x0,'isVipFree':_0x3dcaac[_0x2a4bc7(0x26d)]==-0x1,'useIntegrate':_0x3dcaac[_0x2a4bc7(0x21b)]};return{'remainCount':await this['userService'][_0x2a4bc7(0x242)](_0x1e5f90,_0x3dcaac[_0x2a4bc7(0x2e7)],_0x3dcaac[_0x2a4bc7(0x26d)]),'freeCount':_0x3dcaac[_0x2a4bc7(0x26d)],'isVipFree':_0x3dcaac[_0x2a4bc7(0x26d)]==-0x1,'useIntegrate':_0x3dcaac[_0x2a4bc7(0x21b)]};}};function _0xcc03(_0x2fd668,_0x2bca55){const _0x4f096d=_0x4f09();return _0xcc03=function(_0xcc033a,_0x2ae496){_0xcc033a=_0xcc033a-0x1f1;let _0x584d5a=_0x4f096d[_0xcc033a];return _0x584d5a;},_0xcc03(_0x2fd668,_0x2bca55);}CozeService=__decorate([(0x0,common_1[_0xb7860f(0x2db)])(),__param(0x0,(0x0,typeorm_1[_0xb7860f(0x1fb)])(bot_entity_1[_0xb7860f(0x224)])),__param(0x1,(0x0,typeorm_1[_0xb7860f(0x1fb)])(knowledge_entity_1[_0xb7860f(0x26c)])),__param(0x2,(0x0,typeorm_1[_0xb7860f(0x1fb)])(knowledgedocument_entity_1['CozeKnowledgeDocumentEntity'])),__param(0x3,(0x0,typeorm_1[_0xb7860f(0x1fb)])(model_entity_1[_0xb7860f(0x265)])),__param(0x4,(0x0,typeorm_1[_0xb7860f(0x1fb)])(conversation_entity_1['CozeConversationEntity'])),__param(0x5,(0x0,typeorm_1[_0xb7860f(0x1fb)])(message_entity_1[_0xb7860f(0x2a6)])),__param(0x6,(0x0,typeorm_1[_0xb7860f(0x1fb)])(workflow_entity_1[_0xb7860f(0x294)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(user_entity_1[_0xb7860f(0x22c)])),__metadata(_0xb7860f(0x201),[typeorm_2['Repository'],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],typeorm_2[_0xb7860f(0x20d)],user_service_1[_0xb7860f(0x249)],badwords_service_1[_0xb7860f(0x204)],cm_service_1[_0xb7860f(0x213)],file_service_1['FileService']])],CozeService),exports[_0xb7860f(0x205)]=CozeService;