'use strict';function _0x1178(_0x44b357,_0x3beba7){const _0x1de842=_0x1de8();return _0x1178=function(_0x11784f,_0x148579){_0x11784f=_0x11784f-0x152;let _0x17d87b=_0x1de842[_0x11784f];return _0x17d87b;},_0x1178(_0x44b357,_0x3beba7);}const _0x300d2f=_0x1178;(function(_0xa26a88,_0xacd120){const _0x1165d0=_0x1178,_0x4f6b7c=_0xa26a88();while(!![]){try{const _0x21a74d=-parseInt(_0x1165d0(0x19b))/0x1+-parseInt(_0x1165d0(0x1dc))/0x2*(parseInt(_0x1165d0(0x209))/0x3)+parseInt(_0x1165d0(0x1ce))/0x4+-parseInt(_0x1165d0(0x18c))/0x5+parseInt(_0x1165d0(0x18a))/0x6+parseInt(_0x1165d0(0x244))/0x7*(parseInt(_0x1165d0(0x24f))/0x8)+parseInt(_0x1165d0(0x170))/0x9;if(_0x21a74d===_0xacd120)break;else _0x4f6b7c['push'](_0x4f6b7c['shift']());}catch(_0x4e4654){_0x4f6b7c['push'](_0x4f6b7c['shift']());}}}(_0x1de8,0x30210));var __decorate=this&&this[_0x300d2f(0x18d)]||function(_0xcd78de,_0x243690,_0x297b68,_0x1ba289){const _0x48c66b=_0x300d2f;var _0x34df1e=arguments[_0x48c66b(0x18b)],_0x1297b2=_0x34df1e<0x3?_0x243690:_0x1ba289===null?_0x1ba289=Object['getOwnPropertyDescriptor'](_0x243690,_0x297b68):_0x1ba289,_0x499869;if(typeof Reflect===_0x48c66b(0x232)&&typeof Reflect[_0x48c66b(0x1b1)]==='function')_0x1297b2=Reflect[_0x48c66b(0x1b1)](_0xcd78de,_0x243690,_0x297b68,_0x1ba289);else{for(var _0x2aea56=_0xcd78de[_0x48c66b(0x18b)]-0x1;_0x2aea56>=0x0;_0x2aea56--)if(_0x499869=_0xcd78de[_0x2aea56])_0x1297b2=(_0x34df1e<0x3?_0x499869(_0x1297b2):_0x34df1e>0x3?_0x499869(_0x243690,_0x297b68,_0x1297b2):_0x499869(_0x243690,_0x297b68))||_0x1297b2;}return _0x34df1e>0x3&&_0x1297b2&&Object[_0x48c66b(0x20b)](_0x243690,_0x297b68,_0x1297b2),_0x1297b2;},__metadata=this&&this[_0x300d2f(0x1fd)]||function(_0x507560,_0x4e4822){const _0x59d61d=_0x300d2f;if(typeof Reflect===_0x59d61d(0x232)&&typeof Reflect[_0x59d61d(0x183)]===_0x59d61d(0x1d5))return Reflect[_0x59d61d(0x183)](_0x507560,_0x4e4822);},__param=this&&this[_0x300d2f(0x207)]||function(_0x9cdbc0,_0x3da8dd){return function(_0x2906d8,_0x3fd98f){_0x3da8dd(_0x2906d8,_0x3fd98f,_0x9cdbc0);};};Object[_0x300d2f(0x20b)](exports,'__esModule',{'value':!![]}),exports[_0x300d2f(0x1bc)]=void 0x0;function _0x1de8(){const _0x187701=['forEach','batchKnowledgeProgressResult','document_name','stream','format_type','workflowIdList','findAndCount','-----------------------------------createKnowledgeERROR----------','findOne','client.datasets.document.delete','tag','metadata','avatar','contentObject','checkUserStatus','description','createBot','promptInfo','1136478ndJQXp','length','1828140wCUELZ','__decorate','uploadForUrl','ChatEventType','findBy','update_rule','setConversationName','getJwtToken','../user/user.entity','upload','save','getKnowledegeDocument','formatType','user','useCount','10818dGghqy','dataset_id','deleteKnowledge','api','getKnowledgeList','botEntity','BAD_REQUEST','expires_in','isTop','createConversation','Cache-Control','bot_used_count','7474575122028871720','userId','iconFileId','HttpException','mergeCollectData','text/event-stream','messages','./entity/conversation.entity','BadwordsService','validateBalance4Coze','decorate','desc','https://api.coze.cn','CONVERSATION_MESSAGE_COMPLETED','cozeConversationEntity','viewCount','text','iconFileUrl','files','model_info','source_type','CozeService','CONVERSATION_CHAT_CREATED','Guid','---------------------------CozeChatError--------------------------','document_id','hit_count','DESC','知识库不存在！','getConversationList','name','created','../../common/constants/collectType.constant','模型不存在','message','default','deleteBot','updateKnowledgeDocument','process','358424SAyzLl','getUserById','failed_file_list','remaining_time','DONE','bots','CONVERSATION_MESSAGE_DELTA','function','status_descript','Like','type','CozeConversationEntity','COZEBOT','botId','201346hmqnxU','HttpStatus','chunk_strategy','@nestjs/typeorm','usage','document_infos','hot','Repository','page','getValue','file_list','CozeMessageEntity','conversationId','assign','cozeWorkflowEntity','https','CozeAPI','getWorkflowList','ERROR','CozeApiConfig','getKnowledgeDocumentProgress','all_file_size','onboarding_info','access_token','stringify','InjectRepository','retrieve','ASC','createMessage','UserEntity','delta','find','design:paramtypes','__metadata','-----------------------CreateBotError---------------------------','processing_file_list','no-cache','publish','UserCollectType','./entity/workflow.entity','question','documentId','getCozeModelVipFree','__param','responseMessage','3fvsVym','cmService','defineProperty','processing_file_id_list','getBotList','updateKnowledge','contentType','doc_count','error','knowledgeId','会话不存在','userService','event','onboardingInfo','preview_tos_url','vipFreeNum','bot_id','startChat','delete','getModelList','map','knowledge','@coze/api','updateBot','end','chat','status','collect','web_url','chunkStrategy','badwordsService','knowledgeEntity','push','model_id','toString','string','deduct','size','deductBalance4Coze','doc_tree_tos_url','./entity/message.entity','object','collectBotList','data','updateRule','list','count','statusCode','includes','../user/user.service','../cmConfig/cm.service','modelInfoConfig','update','create','typeorm','fileUrl','documents','object_string','uncollect','57995iWjRmb','answer','deleteConversation','role','CozeKnowledgeEntity','dataset_list','setHeader','modelId','knowledgeDocumentEntity','collectBot','recommend','152gzyuaN','progress','userEntity','fileId','content','axios','cozeMessageEntity','completed','relId','error\x20from\x20startChat!','getKnowledgeDocumentList','../badwords/badwords.service','search','tags','checkBadWords','batchKnowledgeResult','getCozeApi','isRelease','rows','Access-Control-Allow-Origin','now','chunked','spaceId','CozeKnowledgeDocumentEntity','X-Accel-Buffering','getJWTToken','conversations','SPACE_ID','char_count','UserService','privateKey','2140389BTedtY','datasets','createKnowledgeDocument','filter','智能体不存在！','请求失败，状态码:\x20','log','write'];_0x1de8=function(){return _0x187701;};return _0x1de8();}const common_1=require('@nestjs/common'),typeorm_1=require(_0x300d2f(0x1df)),typeorm_2=require(_0x300d2f(0x23f)),bot_entity_1=require('./entity/bot.entity'),knowledge_entity_1=require('./entity/knowledge.entity'),knowledgedocument_entity_1=require('./entity/knowledgedocument.entity'),api_1=require(_0x300d2f(0x21f)),model_entity_1=require('./entity/model.entity'),guid_typescript_1=require('guid-typescript'),https_1=require(_0x300d2f(0x1eb)),axios_1=require(_0x300d2f(0x156)),conversation_entity_1=require(_0x300d2f(0x1ae)),message_entity_1=require(_0x300d2f(0x231)),user_entity_1=require(_0x300d2f(0x194)),user_service_1=require(_0x300d2f(0x23a)),collectType_constant_1=require(_0x300d2f(0x1c7)),badwords_service_1=require(_0x300d2f(0x15c)),workflow_entity_1=require(_0x300d2f(0x203)),cm_service_1=require(_0x300d2f(0x23b));let CozeService=class CozeService{constructor(_0x52aee5,_0x1832c4,_0x2112ad,_0x585e13,_0x53b11d,_0x18ff74,_0x7648e2,_0x31efc5,_0x4a0353,_0x171e86,_0x328112){const _0x345b18=_0x300d2f;this[_0x345b18(0x1a0)]=_0x52aee5,this[_0x345b18(0x228)]=_0x1832c4,this[_0x345b18(0x24c)]=_0x2112ad,this['cozeModelEntity']=_0x585e13,this[_0x345b18(0x1b5)]=_0x53b11d,this['cozeMessageEntity']=_0x18ff74,this[_0x345b18(0x1ea)]=_0x7648e2,this[_0x345b18(0x153)]=_0x31efc5,this[_0x345b18(0x214)]=_0x4a0353,this[_0x345b18(0x227)]=_0x171e86,this[_0x345b18(0x20a)]=_0x328112,this[_0x345b18(0x16c)]=_0x345b18(0x1a7);}async[_0x300d2f(0x193)](_0x27f0de){const _0x632746=_0x300d2f;try{const _0x270532=await this['cmService'][_0x632746(0x1e5)](_0x632746(0x1ef)),_0xfd5c12=_0x270532['api'][_0x632746(0x16f)],_0x3dc4e9=_0x270532[_0x632746(0x19e)]['appId'],_0x53570a=_0x270532[_0x632746(0x19e)]['keyid'];this[_0x632746(0x16c)]=_0x270532[_0x632746(0x19e)]['spaceId'];let _0x39e060=await(0x0,api_1[_0x632746(0x16a)])({'baseURL':_0x632746(0x1b3),'appId':_0x3dc4e9,'aud':'api.coze.cn','keyid':_0x53570a,'privateKey':_0xfd5c12,'sessionName':_0x27f0de+''});return _0x39e060;}catch(_0x309971){return{'expires_in':0x0,'access_token':''};}}async['getCozeApi'](_0x17dbe4){const _0x360606=_0x300d2f;let _0x21b0e4=await this[_0x360606(0x193)](_0x17dbe4);const _0x507bcc=new api_1[(_0x360606(0x1ec))]({'baseURL':'https://api.coze.cn','token':async()=>{const _0x308cb2=_0x360606;if(_0x21b0e4[_0x308cb2(0x1a2)]*0x3e8>Date[_0x308cb2(0x165)]()+0x1388)return _0x21b0e4[_0x308cb2(0x1f3)];return _0x21b0e4=await this['getJwtToken'](_0x17dbe4),_0x21b0e4[_0x308cb2(0x1f3)];}});return _0x507bcc;}async[_0x300d2f(0x188)](_0x14ed76,_0x1d0b9d){const _0xa98bf5=_0x300d2f;if(_0x14ed76[_0xa98bf5(0x1b8)]){const _0x6c9638=await this['uploadForUrl'](_0x14ed76[_0xa98bf5(0x1b8)]);_0x14ed76[_0xa98bf5(0x1a9)]=_0x6c9638['id'];}try{const _0x214fde=await this['getCozeApi'](_0x1d0b9d[_0xa98bf5(0x199)]['id']),_0x2da559=await _0x214fde['bots'][_0xa98bf5(0x23e)]({'prompt_info':_0x14ed76[_0xa98bf5(0x189)],'onboarding_info':_0x14ed76['onboardingInfo'],'name':_0x14ed76[_0xa98bf5(0x1c5)],'description':_0x14ed76[_0xa98bf5(0x187)],'icon_file_id':_0x14ed76[_0xa98bf5(0x1a9)],'space_id':this[_0xa98bf5(0x16c)]});return _0x14ed76[_0xa98bf5(0x1db)]=_0x2da559[_0xa98bf5(0x219)],_0x14ed76[_0xa98bf5(0x1a8)]=_0x1d0b9d[_0xa98bf5(0x199)]['id'],_0x14ed76[_0xa98bf5(0x167)]=this['SPACE_ID'],await this[_0xa98bf5(0x1a0)][_0xa98bf5(0x196)](_0x14ed76),_0x14ed76;}catch(_0x5ba343){console[_0xa98bf5(0x176)](_0xa98bf5(0x1fe),_0x5ba343);}}async['getBot'](_0x62ca88,_0x402891){const _0x3e3b7b=_0x300d2f;try{const _0x345f9c=await this[_0x3e3b7b(0x1a0)][_0x3e3b7b(0x180)]({'where':{'botId':_0x62ca88}});if(!_0x345f9c||_0x345f9c[_0x3e3b7b(0x1a8)]!=_0x402891[_0x3e3b7b(0x199)]['id'])throw new Error(_0x3e3b7b(0x174));const _0x2c6d2c=await this[_0x3e3b7b(0x161)](_0x402891[_0x3e3b7b(0x199)]['id']);if(_0x345f9c[_0x3e3b7b(0x162)]==0x1){const _0x2a45da=await _0x2c6d2c[_0x3e3b7b(0x1d3)][_0x3e3b7b(0x1f6)]({'bot_id':_0x62ca88});_0x345f9c[_0x3e3b7b(0x23c)]=_0x2a45da[_0x3e3b7b(0x1ba)],_0x345f9c[_0x3e3b7b(0x17d)]=_0x2a45da['workflow_info_list'],_0x345f9c['onboardingInfo']=_0x2a45da[_0x3e3b7b(0x1f2)],_0x345f9c[_0x3e3b7b(0x1b6)]+=0x1,await this[_0x3e3b7b(0x1a0)]['save'](_0x345f9c);}return _0x345f9c;}catch(_0x46f4bd){return _0x46f4bd;}}async[_0x300d2f(0x220)](_0x40c5a7,_0x1e8a61){const _0x51a6dc=_0x300d2f,_0x9e5ccc=await this[_0x51a6dc(0x1a0)]['findOne']({'where':{'botId':_0x40c5a7[_0x51a6dc(0x1db)]}});if(!_0x9e5ccc||_0x9e5ccc['userId']!=_0x1e8a61[_0x51a6dc(0x199)]['id'])throw new Error('智能体不存在！');if(_0x9e5ccc['iconFileUrl']!=_0x40c5a7['iconFileUrl']){const _0x2653d3=await this[_0x51a6dc(0x18e)](_0x40c5a7[_0x51a6dc(0x1b8)]);_0x40c5a7['iconFileId']=_0x2653d3['id'];}try{const _0x1241a8=await this['getCozeApi'](_0x1e8a61[_0x51a6dc(0x199)]['id']);await _0x1241a8[_0x51a6dc(0x1d3)][_0x51a6dc(0x23d)]({'prompt_info':_0x40c5a7['promptInfo'],'onboarding_info':_0x40c5a7[_0x51a6dc(0x216)],'name':_0x40c5a7[_0x51a6dc(0x1c5)],'description':_0x40c5a7[_0x51a6dc(0x187)],'icon_file_id':_0x40c5a7['iconFileId'],'knowledge':_0x40c5a7[_0x51a6dc(0x21e)],'bot_id':_0x40c5a7[_0x51a6dc(0x1db)],'plugin_id_list':_0x40c5a7['pluginIdList'],'workflow_id_list':_0x40c5a7['workflowIdList'],'model_info_config':_0x40c5a7[_0x51a6dc(0x23c)]}),Object[_0x51a6dc(0x1e9)](_0x9e5ccc,_0x40c5a7),await this[_0x51a6dc(0x1a0)][_0x51a6dc(0x196)](_0x9e5ccc);}catch(_0x2fa577){return _0x2fa577;}}async[_0x300d2f(0x1cb)](_0x5b7e38,_0x383ffa){const _0x559a29=_0x300d2f,_0x3b0cb4=await this[_0x559a29(0x1a0)][_0x559a29(0x180)]({'where':{'botId':_0x5b7e38,'userId':_0x383ffa['user']['id']}});if(!_0x3b0cb4||_0x3b0cb4['userId']!=_0x383ffa[_0x559a29(0x199)]['id'])throw new Error('智能体不存在！');await this[_0x559a29(0x1a0)]['delete'](_0x3b0cb4['id']);}async[_0x300d2f(0x24d)](_0x5d373f,_0xf40644,_0x3dd670){const _0x2197fd=_0x300d2f,_0x2f84f9=await this['botEntity'][_0x2197fd(0x180)]({'where':{'botId':_0x5d373f}});if(!_0x2f84f9)throw new Error(_0x2197fd(0x174));_0x3dd670==0x1?this['userService'][_0x2197fd(0x224)](_0xf40644[_0x2197fd(0x199)]['id'],_0x2f84f9['id'],collectType_constant_1[_0x2197fd(0x202)][_0x2197fd(0x1da)]):this['userService'][_0x2197fd(0x243)](_0xf40644[_0x2197fd(0x199)]['id'],_0x2f84f9['id'],collectType_constant_1['UserCollectType'][_0x2197fd(0x1da)]);}async[_0x300d2f(0x233)](_0x29d1d1,_0x2ac5c9){const _0x82293a=_0x300d2f,_0x1a4090=await this[_0x82293a(0x214)]['collectPage'](_0x29d1d1[_0x82293a(0x1e4)],_0x29d1d1[_0x82293a(0x22e)],_0x2ac5c9[_0x82293a(0x199)]['id'],collectType_constant_1[_0x82293a(0x202)][_0x82293a(0x1da)]);if(_0x1a4090['count']>0x0){const _0x452c7d=await this[_0x82293a(0x1a0)][_0x82293a(0x190)]({'id':(0x0,typeorm_2['In'])(_0x1a4090[_0x82293a(0x163)][_0x82293a(0x21d)](_0x431f71=>_0x431f71[_0x82293a(0x159)]))});return{'rows':_0x452c7d,'count':_0x1a4090[_0x82293a(0x237)]};}return{'rows':[],'count':0x0};}async['getMyBotList'](_0x4b2e5c,_0x4a906c){const _0x33bc7b=_0x300d2f,_0x23e108={'userId':_0x4a906c[_0x33bc7b(0x199)]['id']};_0x4b2e5c[_0x33bc7b(0x182)]&&(_0x23e108[_0x33bc7b(0x15e)]=(0x0,typeorm_2[_0x33bc7b(0x1d7)])('%'+_0x4b2e5c['tag']+'%'));_0x4b2e5c[_0x33bc7b(0x15d)]&&(_0x23e108['name']=(0x0,typeorm_2[_0x33bc7b(0x1d7)])('%'+_0x4b2e5c[_0x33bc7b(0x15d)]+'%'));const [_0x52485b,_0x587cb9]=await this[_0x33bc7b(0x1a0)][_0x33bc7b(0x17e)]({'where':_0x23e108,'order':{'id':_0x33bc7b(0x1c2)},'skip':(_0x4b2e5c[_0x33bc7b(0x1e4)]-0x1)*_0x4b2e5c[_0x33bc7b(0x22e)],'take':_0x4b2e5c[_0x33bc7b(0x22e)]}),_0x11462b=await this['userService'][_0x33bc7b(0x1ab)](_0x52485b,_0x4a906c,collectType_constant_1[_0x33bc7b(0x202)]['COZEBOT']);return{'rows':_0x11462b,'count':_0x587cb9};}async[_0x300d2f(0x20d)](_0x118bce,_0x27e752){const _0x562cf1=_0x300d2f,_0x562318=[{'userId':0x0},{'publish_flag':0x1}];_0x118bce['tag']&&_0x562318[_0x562cf1(0x178)](_0x6fcd9a=>{const _0x1a2a89=_0x562cf1;_0x6fcd9a[_0x1a2a89(0x15e)]=(0x0,typeorm_2[_0x1a2a89(0x1d7)])('%'+_0x118bce[_0x1a2a89(0x182)]+'%');});_0x118bce[_0x562cf1(0x15d)]&&_0x562318[_0x562cf1(0x178)](_0x574dec=>{const _0x475c7e=_0x562cf1;_0x574dec[_0x475c7e(0x1c5)]=(0x0,typeorm_2[_0x475c7e(0x1d7)])('%'+_0x118bce[_0x475c7e(0x15d)]+'%');});_0x562318[_0x562cf1(0x178)](_0x59314a=>{const _0x985f0f=_0x562cf1;_0x59314a[_0x985f0f(0x162)]=0x1;});let _0x55ea6b={'id':_0x562cf1(0x1c2)};if(_0x118bce[_0x562cf1(0x1d8)]==_0x562cf1(0x1e2))_0x55ea6b={'useCount':'DESC'};else _0x118bce['type']==_0x562cf1(0x24e)?_0x55ea6b={'recommendAt':'DESC'}:_0x55ea6b={'id':'DESC'};const _0x35bb37=await this[_0x562cf1(0x1a0)][_0x562cf1(0x17e)]({'where':_0x562318,'order':_0x55ea6b,'skip':(_0x118bce['page']-0x1)*_0x118bce['size'],'take':_0x118bce[_0x562cf1(0x22e)]}),[_0x1968ba,_0x494a49]=_0x35bb37,_0x55b359=await this['userEntity'][_0x562cf1(0x1fb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1968ba[_0x562cf1(0x21d)](_0x4936ef=>_0x4936ef[_0x562cf1(0x1a8)]))}});_0x1968ba[_0x562cf1(0x178)](_0x4cdc0d=>{const _0x4c8108=_0x562cf1;if(_0x4cdc0d[_0x4c8108(0x1a8)]){const _0x4c36b5=_0x55b359[_0x4c8108(0x1fb)](_0x2f24a3=>_0x2f24a3['id']==_0x4cdc0d['userId']);_0x4cdc0d['userInfo']={'userId':_0x4c36b5['id'],'userName':_0x4c36b5['nickname'],'avatar':_0x4c36b5[_0x4c8108(0x184)]};}});const _0x179237=await this[_0x562cf1(0x214)]['mergeCollectData'](_0x1968ba,_0x27e752,collectType_constant_1[_0x562cf1(0x202)][_0x562cf1(0x1da)]);return{'rows':_0x179237,'count':_0x494a49};}async['publishBot'](_0x33214b,_0x3e9fac){const _0x10e9e0=_0x300d2f,_0xb3ba01=await this[_0x10e9e0(0x1a0)][_0x10e9e0(0x180)]({'where':{'botId':_0x33214b,'userId':_0x3e9fac[_0x10e9e0(0x199)]['id']}});if(!_0xb3ba01||_0xb3ba01['userId']!=_0x3e9fac[_0x10e9e0(0x199)]['id'])throw new Error(_0x10e9e0(0x174));const _0x5bf33f=await this[_0x10e9e0(0x161)](_0x3e9fac[_0x10e9e0(0x199)]['id']);await _0x5bf33f[_0x10e9e0(0x1d3)][_0x10e9e0(0x201)]({'bot_id':_0xb3ba01[_0x10e9e0(0x1db)],'connector_ids':['1024','999']}),_0xb3ba01[_0x10e9e0(0x162)]=0x1,await this['botEntity'][_0x10e9e0(0x196)](_0xb3ba01);}async[_0x300d2f(0x195)](_0x2db80f,_0x19e729){const _0x359f00=_0x300d2f,_0x1eb85e=await this[_0x359f00(0x161)](_0x19e729[_0x359f00(0x199)]['id']);try{const _0x5a428a=await _0x1eb85e[_0x359f00(0x1b9)][_0x359f00(0x195)]({'file':_0x2db80f});return _0x5a428a;}catch(_0x48b1e3){console[_0x359f00(0x176)]('--------------------------------------------------client.upload',_0x48b1e3);}return![];}async['uploadForUrl'](_0x471531){const _0x5273da=_0x300d2f;try{const _0x25bf1a=await this['getCozeApi'](guid_typescript_1[_0x5273da(0x1be)][_0x5273da(0x23e)]()),_0x5de646=await(0x0,axios_1[_0x5273da(0x1ca)])({'url':_0x471531,'method':'GET','responseType':_0x5273da(0x17b)}),_0x2d08b2=_0x5de646['data'],_0x429e56=await _0x25bf1a[_0x5273da(0x1b9)]['upload']({'file':_0x2d08b2});return _0x429e56;}catch(_0x2edcc7){console[_0x5273da(0x176)]('-----------------------------------uploadForUrlERROR----------',_0x2edcc7);}return null;}async['createKnowledge'](_0x545d94,_0x2f98a9){const _0x330547=_0x300d2f;try{const _0x37d48c=await this['uploadForUrl'](_0x545d94['fileUrl']);_0x545d94[_0x330547(0x154)]=_0x37d48c['id'];const _0xbb9326=await this[_0x330547(0x161)](_0x2f98a9[_0x330547(0x199)]['id']),_0x9bea41=await _0xbb9326[_0x330547(0x171)][_0x330547(0x23e)]({'name':_0x545d94['name'],'description':_0x545d94[_0x330547(0x187)],'file_id':_0x545d94[_0x330547(0x154)],'space_id':this[_0x330547(0x16c)],'format_type':_0x545d94['formatType']});_0x545d94[_0x330547(0x167)]=this[_0x330547(0x16c)],_0x545d94[_0x330547(0x212)]=_0x9bea41[_0x330547(0x19c)],_0x545d94['userId']=_0x2f98a9[_0x330547(0x199)]['id'],await this[_0x330547(0x228)][_0x330547(0x196)](_0x545d94);}catch(_0x46d677){return console[_0x330547(0x176)](_0x330547(0x17f),_0x46d677),_0x46d677;}}async[_0x300d2f(0x20e)](_0x1ce4d4,_0x2621df){const _0x282e01=_0x300d2f,_0x218975=await this['knowledgeEntity'][_0x282e01(0x180)]({'where':{'knowledgeId':_0x1ce4d4[_0x282e01(0x212)]}});if(!_0x218975||_0x218975[_0x282e01(0x1a8)]!=_0x2621df[_0x282e01(0x199)]['id'])throw new Error(_0x282e01(0x1c3));if(_0x218975[_0x282e01(0x240)]!=_0x1ce4d4['fileUrl']){const _0x23a82e=await this['uploadForUrl'](_0x1ce4d4[_0x282e01(0x240)]);_0x1ce4d4[_0x282e01(0x154)]=_0x23a82e['id'];}const _0x5a3429=await this[_0x282e01(0x161)](_0x2621df[_0x282e01(0x199)]['id']);await _0x5a3429[_0x282e01(0x171)]['update'](_0x218975[_0x282e01(0x212)],{'name':_0x1ce4d4[_0x282e01(0x1c5)],'description':_0x1ce4d4['description'],'file_id':_0x1ce4d4[_0x282e01(0x154)]}),await this[_0x282e01(0x228)][_0x282e01(0x196)](_0x1ce4d4);}async[_0x300d2f(0x19d)](_0x74d2b7,_0x5e8693){const _0x30e270=_0x300d2f,_0x5ce452=await this[_0x30e270(0x228)][_0x30e270(0x180)]({'where':{'knowledgeId':_0x74d2b7}});if(!_0x5ce452||_0x5ce452[_0x30e270(0x1a8)]!=_0x5e8693[_0x30e270(0x199)]['id'])throw new Error('知识库不存在！');const _0x12ce61=await this[_0x30e270(0x161)](_0x5e8693[_0x30e270(0x199)]['id']),_0x9c921d=await _0x12ce61['datasets'][_0x30e270(0x21b)](_0x5ce452[_0x30e270(0x212)]);await this['knowledgeEntity'][_0x30e270(0x21b)](_0x5ce452['id']);}async[_0x300d2f(0x19f)](_0xa2f0a1,_0x41c8b8){const _0x3dc0f5=_0x300d2f,_0x52b591={'userId':_0x41c8b8[_0x3dc0f5(0x199)]['id']};_0xa2f0a1[_0x3dc0f5(0x15d)]&&(_0x52b591[_0x3dc0f5(0x1c5)]=(0x0,typeorm_2[_0x3dc0f5(0x1d7)])('%'+_0xa2f0a1[_0x3dc0f5(0x15d)]+'%'));const [_0x50416a,_0x203fb1]=await this[_0x3dc0f5(0x228)][_0x3dc0f5(0x17e)]({'where':_0x52b591,'order':{'id':_0x3dc0f5(0x1c2)},'skip':(_0xa2f0a1['page']-0x1)*_0xa2f0a1[_0x3dc0f5(0x22e)],'take':_0xa2f0a1[_0x3dc0f5(0x22e)]});return{'rows':_0x50416a,'count':_0x203fb1};}async[_0x300d2f(0x197)](_0x522993,_0x623236){const _0x3b3247=_0x300d2f;return await this[_0x3b3247(0x24c)][_0x3b3247(0x180)]({'where':{'documentId':_0x522993,'userId':_0x623236[_0x3b3247(0x199)]['id']}});}async[_0x300d2f(0x15b)](_0x3f7612,_0x496012){const _0xc1422c=_0x300d2f,_0x548421={'userId':_0x496012[_0xc1422c(0x199)]['id'],'knowledgeId':_0x3f7612[_0xc1422c(0x212)]};_0x3f7612[_0xc1422c(0x15d)]&&(_0x548421[_0xc1422c(0x1c5)]=(0x0,typeorm_2[_0xc1422c(0x1d7)])('%'+_0x3f7612[_0xc1422c(0x15d)]+'%'));const [_0x55df7e,_0xb32a07]=await this[_0xc1422c(0x24c)]['findAndCount']({'where':_0x548421,'order':{'id':_0xc1422c(0x1c2)},'skip':(_0x3f7612[_0xc1422c(0x1e4)]-0x1)*_0x3f7612['size'],'take':_0x3f7612['size']});return{'rows':_0x55df7e,'count':_0xb32a07};}async[_0x300d2f(0x172)](_0x49fa56,_0x8730c4){const _0x3e77c9=_0x300d2f;try{const _0x46a9f0=await this[_0x3e77c9(0x161)](_0x8730c4[_0x3e77c9(0x199)]['id']),_0x4f1be4=await _0x46a9f0[_0x3e77c9(0x171)][_0x3e77c9(0x241)][_0x3e77c9(0x23e)]({'dataset_id':_0x49fa56[_0x3e77c9(0x212)],'document_bases':_0x49fa56['documentBases'],'chunk_strategy':_0x49fa56[_0x3e77c9(0x226)],'format_type':_0x49fa56[_0x3e77c9(0x198)]});let _0xe1a128=[];for(const _0x1fdcb3 of _0x4f1be4){_0xe1a128[_0x3e77c9(0x229)](await this[_0x3e77c9(0x24c)][_0x3e77c9(0x196)]({'userId':_0x8730c4[_0x3e77c9(0x199)]['id'],'spaceId':this[_0x3e77c9(0x16c)],'knowledgeId':_0x49fa56[_0x3e77c9(0x212)],'name':_0x1fdcb3['name'],'documentId':_0x1fdcb3[_0x3e77c9(0x1c0)],'charCount':_0x1fdcb3[_0x3e77c9(0x16d)],'chunkStrategy':_0x1fdcb3[_0x3e77c9(0x1de)],'formatType':_0x1fdcb3[_0x3e77c9(0x17c)],'hitCount':_0x1fdcb3['hit_count'],'size':_0x1fdcb3[_0x3e77c9(0x22e)],'sliceCount':_0x1fdcb3['slice_count'],'status':_0x1fdcb3[_0x3e77c9(0x223)],'type':_0x1fdcb3['type']}));}return console['log']('client.datasets.document.create',_0x4f1be4),_0xe1a128;}catch(_0x164166){return console[_0x3e77c9(0x176)]('-----------------------------------createKnowledgeDocumentERROR----------',_0x164166),_0x164166;}}async[_0x300d2f(0x1cc)](_0x503322,_0x251e3e){const _0x3a870f=_0x300d2f;try{const _0x7e8e78=await this['knowledgeDocumentEntity']['findOne']({'where':{'documentId':_0x503322['document_id']}});if(!_0x7e8e78||_0x7e8e78[_0x3a870f(0x1a8)]!=_0x251e3e[_0x3a870f(0x199)]['id'])throw new Error('文档不存在！');_0x7e8e78[_0x3a870f(0x235)]=_0x503322[_0x3a870f(0x191)],_0x7e8e78['name']=_0x503322[_0x3a870f(0x17a)],await this[_0x3a870f(0x24c)][_0x3a870f(0x196)](_0x7e8e78);const _0x392928=await this['getCozeApi'](_0x251e3e[_0x3a870f(0x199)]['id']),_0x1fc886=await _0x392928[_0x3a870f(0x171)][_0x3a870f(0x241)][_0x3a870f(0x23d)](_0x503322);return _0x1fc886;}catch(_0x347301){return _0x347301;}}async['deleteKnowledgeDocument'](_0x491449,_0x3dc6de){const _0x3c3c2e=_0x300d2f,_0x1c1db6=await this['knowledgeDocumentEntity'][_0x3c3c2e(0x180)]({'where':{'documentId':_0x491449}});if(!_0x1c1db6||_0x1c1db6[_0x3c3c2e(0x1a8)]!=_0x3dc6de['user']['id'])throw new Error('文档不存在！');await this[_0x3c3c2e(0x24c)][_0x3c3c2e(0x21b)]({'documentId':_0x491449,'userId':_0x3dc6de[_0x3c3c2e(0x199)]['id']});const _0x549e11=await this[_0x3c3c2e(0x161)](_0x3dc6de[_0x3c3c2e(0x199)]['id']),_0x5908ce=await _0x549e11[_0x3c3c2e(0x171)]['documents'][_0x3c3c2e(0x21b)]({'document_ids':[_0x1c1db6['documentId']]});console[_0x3c3c2e(0x176)](_0x3c3c2e(0x181),_0x5908ce);}async[_0x300d2f(0x1f0)](_0x4cf55f,_0x3272a5,_0x4a80e8){const _0x28fe78=_0x300d2f,_0x51b621=await this[_0x28fe78(0x161)](_0x4a80e8[_0x28fe78(0x199)]['id']),_0x545348=await _0x51b621['datasets'][_0x28fe78(0x1cd)](_0x4cf55f,_0x3272a5);console[_0x28fe78(0x176)]('client.datasets.process',_0x545348);}async[_0x300d2f(0x21c)](){const _0x298aae=_0x300d2f;return await this['cozeModelEntity']['find']({'where':{'isRelease':0x1},'order':{'sortIndex':'DESC','id':_0x298aae(0x1c2)}});}async['getRemoteFileStream'](_0x5ee68a){return new Promise((_0x5aa78f,_0x37244f)=>{const _0x1ca090=_0x1178;https_1[_0x1ca090(0x1ca)]['get'](_0x5ee68a,_0x5f594f=>{const _0x16411c=_0x1ca090;if(_0x5f594f[_0x16411c(0x238)]!==0xc8){_0x37244f(new Error(_0x16411c(0x175)+_0x5f594f[_0x16411c(0x238)]));return;}_0x5aa78f(_0x5f594f);})['on'](_0x1ca090(0x211),_0x32f353=>{_0x37244f(_0x32f353);});});}async[_0x300d2f(0x1c4)](_0x24221d,_0x52248e){const _0x923ba1=_0x300d2f,_0x4ca33f={'userId':_0x52248e[_0x923ba1(0x199)]['id'],'botId':_0x24221d[_0x923ba1(0x1db)]},[_0x33be24,_0x234944]=await this[_0x923ba1(0x1b5)][_0x923ba1(0x17e)]({'where':_0x4ca33f,'order':{'isTop':_0x923ba1(0x1b2),'id':_0x923ba1(0x1c2)},'skip':(_0x24221d[_0x923ba1(0x1e4)]-0x1)*_0x24221d[_0x923ba1(0x22e)],'take':_0x24221d[_0x923ba1(0x22e)]});return{'rows':_0x33be24,'count':_0x234944};}async[_0x300d2f(0x1a4)](_0x59d425,_0x146ccc){const _0xda4558=_0x300d2f;try{const _0x39547c=await this[_0xda4558(0x161)](_0x146ccc[_0xda4558(0x199)]['id']),_0x16cff4=await _0x39547c[_0xda4558(0x16b)][_0xda4558(0x23e)]({'bot_id':_0x59d425[_0xda4558(0x1db)]});_0x59d425[_0xda4558(0x1a8)]=_0x146ccc['user']['id'],_0x59d425['conversationId']=_0x16cff4['id'];const _0x3fbf4c=await this[_0xda4558(0x1a0)][_0xda4558(0x180)]({'where':{'botId':_0x59d425[_0xda4558(0x1db)]}});return _0x3fbf4c[_0xda4558(0x19a)]=_0x3fbf4c['useCount']?_0x3fbf4c[_0xda4558(0x19a)]+0x1:0x1,await this[_0xda4558(0x1a0)]['save'](_0x3fbf4c),await this['cozeConversationEntity']['save'](_0x59d425);}catch(_0x4aada2){return _0x4aada2;}}async[_0x300d2f(0x246)](_0x14dd85,_0x5cc9e8){const _0x5796c9=_0x300d2f;return await this[_0x5796c9(0x1b5)][_0x5796c9(0x21b)]({'conversationId':_0x14dd85,'userId':_0x5cc9e8['user']['id']}),!![];}async[_0x300d2f(0x192)](_0x45584b,_0x2da488,_0x4152fd){const _0xbf1665=_0x300d2f,_0x431538=await this[_0xbf1665(0x1b5)][_0xbf1665(0x180)]({'where':{'conversationId':_0x45584b,'userId':_0x4152fd[_0xbf1665(0x199)]['id']}});if(!_0x431538)throw new Error('会话不存在！');_0x431538[_0xbf1665(0x1c5)]=_0x2da488,await this[_0xbf1665(0x1b5)][_0xbf1665(0x196)](_0x431538);}async['topConversation'](_0x1cd7f7,_0x57f8ee,_0x5b280c){const _0x59fb65=_0x300d2f;try{const _0x3034f6=await this[_0x59fb65(0x1b5)][_0x59fb65(0x180)]({'where':{'conversationId':_0x1cd7f7,'userId':_0x5b280c[_0x59fb65(0x199)]['id']}});if(!_0x3034f6)throw new Error('会话不存在！');_0x3034f6[_0x59fb65(0x1a3)]=_0x57f8ee==0x1?0x1:0x0,await this['cozeConversationEntity'][_0x59fb65(0x196)](_0x3034f6);}catch(_0x232910){return _0x232910[_0x59fb65(0x1c9)];}}async['getMessageList'](_0x34eb31,_0x13d5eb){const _0x3f163d=_0x300d2f,_0x44588d={'userId':_0x13d5eb[_0x3f163d(0x199)]['id'],'conversationId':_0x34eb31[_0x3f163d(0x1e8)]},[_0x309503,_0x532ff7]=await this['cozeMessageEntity'][_0x3f163d(0x17e)]({'where':_0x44588d,'order':{'id':'DESC'},'skip':(_0x34eb31[_0x3f163d(0x1e4)]-0x1)*_0x34eb31[_0x3f163d(0x22e)],'take':_0x34eb31[_0x3f163d(0x22e)]});return{'rows':_0x309503,'count':_0x532ff7};}async[_0x300d2f(0x1f8)](_0xf197f,_0x2065bd){const _0xf2f3ce=_0x300d2f,_0x5f46f6=await this['getCozeApi'](_0x2065bd[_0xf2f3ce(0x199)]['id']),_0x2b4961=await _0x5f46f6['conversations'][_0xf2f3ce(0x1ad)][_0xf2f3ce(0x23e)](_0xf197f[_0xf2f3ce(0x1e8)],{'role':_0xf197f[_0xf2f3ce(0x247)],'content':_0xf197f[_0xf2f3ce(0x155)],'content_type':_0xf197f[_0xf2f3ce(0x20f)],'meta_data':{}});_0xf197f['messageId']=_0x2b4961['id'],this['cozeMessageEntity'][_0xf2f3ce(0x196)](_0xf197f);}[_0x300d2f(0x208)](_0x3158b2,_0x4d4b9b){const _0x59df3e=_0x300d2f;_0x3158b2[_0x59df3e(0x177)]('data:\x20'+JSON[_0x59df3e(0x1f4)](_0x4d4b9b)+'\x0a\x0a');}async['validateBeforeChat'](_0x18a749){const _0x232a7f=_0x300d2f,{user:_0x55324a,prompt:_0x4ad03d,model:_0x2d7002}=_0x18a749;await this[_0x232a7f(0x214)][_0x232a7f(0x186)](_0x55324a),await this[_0x232a7f(0x227)][_0x232a7f(0x15f)](_0x4ad03d,_0x55324a['id']),await this[_0x232a7f(0x214)][_0x232a7f(0x1b0)](_0x55324a['id'],_0x2d7002[_0x232a7f(0x24b)],_0x2d7002[_0x232a7f(0x218)],_0x2d7002[_0x232a7f(0x22d)]);}async[_0x300d2f(0x21a)](_0x4e10d1,_0x2285c3,_0x29263a){const _0x45ebc3=_0x300d2f;_0x29263a['setHeader']('Content-Type',_0x45ebc3(0x1ac)),_0x29263a[_0x45ebc3(0x24a)]('Transfer-Encoding',_0x45ebc3(0x166)),_0x29263a[_0x45ebc3(0x24a)](_0x45ebc3(0x1a5),_0x45ebc3(0x200)),_0x29263a[_0x45ebc3(0x24a)](_0x45ebc3(0x169),'no'),_0x29263a['setHeader'](_0x45ebc3(0x164),'*');try{const _0x2cf1f6=await this['cozeConversationEntity'][_0x45ebc3(0x180)]({'where':{'userId':_0x2285c3[_0x45ebc3(0x199)]['id'],'conversationId':_0x4e10d1[_0x45ebc3(0x1e8)]}});if(!_0x2cf1f6)throw new common_1[(_0x45ebc3(0x1aa))](_0x45ebc3(0x213),common_1[_0x45ebc3(0x1dd)]['BAD_REQUEST']);const _0x4dd5c2=await this[_0x45ebc3(0x214)][_0x45ebc3(0x1cf)](_0x2285c3['user']['id']),_0x5a58b5=await this[_0x45ebc3(0x161)](_0x2285c3[_0x45ebc3(0x199)]['id']),_0x1d0a96=await _0x5a58b5['bots'][_0x45ebc3(0x1f6)]({'bot_id':_0x2cf1f6[_0x45ebc3(0x1db)]}),_0x2c5b3b=await this[_0x45ebc3(0x1a0)]['findOne']({'where':{'botId':_0x2cf1f6[_0x45ebc3(0x1db)]}});_0x2c5b3b[_0x45ebc3(0x23c)]=_0x1d0a96[_0x45ebc3(0x1ba)],_0x2c5b3b[_0x45ebc3(0x17d)]=_0x1d0a96['workflow_info_list'],_0x2c5b3b[_0x45ebc3(0x216)]=_0x1d0a96[_0x45ebc3(0x1f2)],await this['botEntity'][_0x45ebc3(0x196)](_0x2c5b3b);const _0x56479d=await this['cozeModelEntity'][_0x45ebc3(0x180)]({'where':{'modelId':_0x1d0a96[_0x45ebc3(0x1ba)][_0x45ebc3(0x22a)]}});if(!_0x56479d)throw new common_1[(_0x45ebc3(0x1aa))](_0x45ebc3(0x1c8),common_1[_0x45ebc3(0x1dd)][_0x45ebc3(0x1a1)]);this['validateBeforeChat']({'prompt':_0x4e10d1[_0x45ebc3(0x155)]['toString'](),'user':_0x4dd5c2,'model':_0x56479d});const _0x408d98=await this[_0x45ebc3(0x157)][_0x45ebc3(0x1fb)]({'where':{'conversationId':_0x4e10d1[_0x45ebc3(0x1e8)]},'order':{'id':_0x45ebc3(0x1f7)}});let _0xdfb97=[];_0x408d98['forEach'](_0x10e7ba=>{const _0x40b357=_0x45ebc3;let _0x303f5c=_0x10e7ba[_0x40b357(0x155)];_0x10e7ba[_0x40b357(0x20f)]==_0x40b357(0x242)&&(_0x303f5c=JSON[_0x40b357(0x1f4)](_0x10e7ba[_0x40b357(0x185)])),_0xdfb97[_0x40b357(0x229)]({'role':_0x10e7ba[_0x40b357(0x247)],'content':_0x303f5c,'content_type':_0x10e7ba['contentType'],'type':_0x10e7ba[_0x40b357(0x1d8)]});});typeof _0x4e10d1[_0x45ebc3(0x155)]===_0x45ebc3(0x22c)?_0xdfb97[_0x45ebc3(0x229)]({'content':_0x4e10d1['content'],'content_type':_0x45ebc3(0x1b7),'role':_0x45ebc3(0x199),'type':'question'}):_0xdfb97[_0x45ebc3(0x229)]({'content':JSON[_0x45ebc3(0x1f4)](_0x4e10d1[_0x45ebc3(0x155)]),'content_type':_0x45ebc3(0x242),'role':'user','type':_0x45ebc3(0x204)});const _0x28fd85=await _0x5a58b5[_0x45ebc3(0x222)][_0x45ebc3(0x17b)]({'bot_id':_0x2cf1f6[_0x45ebc3(0x1db)],'user_id':_0x2285c3[_0x45ebc3(0x199)]['id'][_0x45ebc3(0x22b)](),'auto_save_history':!![],'additional_messages':_0xdfb97});let _0x3dc06c,_0x471886='',_0x2a1395='',_0x15c86b='',_0xc988f7;for await(const _0x22f1a4 of _0x28fd85){if(_0x22f1a4['event']===api_1['ChatEventType'][_0x45ebc3(0x1bd)])_0x2a1395=_0x45ebc3(0x1c6),_0x3dc06c=_0x22f1a4,_0x15c86b=_0x22f1a4[_0x45ebc3(0x234)]['id'];else{if(_0x22f1a4[_0x45ebc3(0x215)]===api_1[_0x45ebc3(0x18f)][_0x45ebc3(0x1d4)])_0x471886+=_0x22f1a4[_0x45ebc3(0x234)][_0x45ebc3(0x155)],this[_0x45ebc3(0x208)](_0x29263a,{'content':_0x22f1a4[_0x45ebc3(0x234)][_0x45ebc3(0x155)],'contentType':_0x22f1a4[_0x45ebc3(0x234)]['content_type'],'isEnd':![],'isError':![]}),_0x2a1395=_0x45ebc3(0x1fa);else{if(_0x22f1a4[_0x45ebc3(0x215)]===api_1[_0x45ebc3(0x18f)][_0x45ebc3(0x1b4)]){}else{if(_0x22f1a4['event']===api_1['ChatEventType']['CONVERSATION_CHAT_COMPLETED'])_0x2a1395=_0x45ebc3(0x158),_0xc988f7=_0x22f1a4[_0x45ebc3(0x234)]['usage'],this[_0x45ebc3(0x208)](_0x29263a,{'content':_0x471886,'contentType':'text','isEnd':!![],'isError':![],'usage':_0x22f1a4[_0x45ebc3(0x234)][_0x45ebc3(0x1e0)]});else{if(_0x22f1a4['event']===api_1['ChatEventType'][_0x45ebc3(0x1d2)])_0x2a1395=_0x45ebc3(0x221),this[_0x45ebc3(0x208)](_0x29263a,{'content':'','contentType':'','isEnd':!![],'isError':![]});else _0x22f1a4[_0x45ebc3(0x215)]===api_1['ChatEventType'][_0x45ebc3(0x1ee)]&&(_0x2a1395=_0x45ebc3(0x211),console[_0x45ebc3(0x176)](_0x45ebc3(0x1bf),_0x22f1a4),this[_0x45ebc3(0x208)](_0x29263a,{'content':'','contentType':'','isEnd':![],'isError':!![],'errorData':_0x22f1a4}));}}}}}const _0x5bcc95=await this[_0x45ebc3(0x157)][_0x45ebc3(0x196)]({'botId':_0x2cf1f6[_0x45ebc3(0x1db)],'userId':_0x2285c3['user']['id'],'spaceId':this['SPACE_ID'],'messageId':_0x15c86b,'type':'question','contentType':typeof _0x4e10d1[_0x45ebc3(0x155)]===_0x45ebc3(0x22c)?_0x45ebc3(0x1b7):_0x45ebc3(0x242),'conversationId':_0x2cf1f6[_0x45ebc3(0x1e8)],'content':typeof _0x4e10d1[_0x45ebc3(0x155)]===_0x45ebc3(0x22c)?_0x4e10d1[_0x45ebc3(0x155)]:'','contentObject':typeof _0x4e10d1['content']!==_0x45ebc3(0x22c)?_0x4e10d1['content']:[],'role':_0x45ebc3(0x199),'parentId':0x0});await this[_0x45ebc3(0x157)]['save']({'botId':_0x2cf1f6[_0x45ebc3(0x1db)],'userId':_0x2285c3[_0x45ebc3(0x199)]['id'],'spaceId':this[_0x45ebc3(0x16c)],'messageId':_0x15c86b,'conversationId':_0x2cf1f6[_0x45ebc3(0x1e8)],'type':_0x45ebc3(0x245),'content':_0x471886,'content_type':_0x45ebc3(0x1b7),'role':'assistant','usage':_0xc988f7,'status':_0x2a1395,'parentId':_0x5bcc95['id'],'contentObject':[]}),await this[_0x45ebc3(0x214)][_0x45ebc3(0x22f)](_0x2285c3[_0x45ebc3(0x199)]['id'],_0x56479d[_0x45ebc3(0x24b)],_0x56479d['name'],_0x56479d['vipFreeNum'],_0x56479d[_0x45ebc3(0x22d)],_0x15c86b);}catch(_0x362f3c){return console[_0x45ebc3(0x211)](_0x45ebc3(0x15a),_0x362f3c),_0x362f3c;}}async[_0x300d2f(0x1ed)](_0x5762f6){const _0x33e696=_0x300d2f,_0x427655={'isRelease':0x1};_0x5762f6[_0x33e696(0x15d)]&&(_0x427655[_0x33e696(0x1c5)]=(0x0,typeorm_2[_0x33e696(0x1d7)])('%'+_0x5762f6[_0x33e696(0x15d)]+'%'));const [_0x1adc3b,_0x10f1c9]=await this[_0x33e696(0x1ea)]['findAndCount']({'where':_0x427655,'order':{'id':_0x33e696(0x1c2)},'skip':(_0x5762f6['page']-0x1)*_0x5762f6[_0x33e696(0x22e)],'take':_0x5762f6['size']});return{'rows':_0x1adc3b,'count':_0x10f1c9};}async[_0x300d2f(0x160)](){const _0x9c052c=_0x300d2f,_0x2bb0c6=await this[_0x9c052c(0x161)]('');let _0x39eee6=0x1;while(!![]){const _0x46e5f6=await this[_0x9c052c(0x228)][_0x9c052c(0x1fb)]({'where':{'spaceId':this[_0x9c052c(0x16c)]}});let _0x332930=await _0x2bb0c6['datasets'][_0x9c052c(0x236)]({'space_id':this[_0x9c052c(0x16c)],'page_num':_0x39eee6,'page_size':0x12c});if(!_0x332930[_0x9c052c(0x249)]||_0x332930[_0x9c052c(0x249)]['length']==0x0)break;_0x332930=_0x332930[_0x9c052c(0x249)][_0x9c052c(0x173)](_0x594680=>_0x46e5f6[_0x9c052c(0x21d)](_0x495eb0=>_0x495eb0[_0x9c052c(0x212)])[_0x9c052c(0x239)](_0x594680[_0x9c052c(0x19c)]));for(let _0xf9d497 of _0x332930){await this[_0x9c052c(0x228)][_0x9c052c(0x23d)]({'knowledgeId':_0xf9d497[_0x9c052c(0x19c)]},{'botUsedCount':_0xf9d497[_0x9c052c(0x1a6)],'processingFileList':_0xf9d497[_0x9c052c(0x1ff)],'failedFileList':_0xf9d497[_0x9c052c(0x1d0)],'formatType':_0xf9d497[_0x9c052c(0x17c)],'processingFileIdList':_0xf9d497[_0x9c052c(0x20c)],'allFileSize':_0xf9d497[_0x9c052c(0x1f1)],'hitCount':_0xf9d497[_0x9c052c(0x1c1)],'docCount':_0xf9d497[_0x9c052c(0x210)],'fileList':_0xf9d497[_0x9c052c(0x1e6)],'chunkStrategy':_0xf9d497[_0x9c052c(0x1de)]});let _0x35c489=0x1;while(!![]){const _0x42ba30=await _0x2bb0c6[_0x9c052c(0x171)][_0x9c052c(0x241)][_0x9c052c(0x236)]({'dataset_id':_0xf9d497[_0x9c052c(0x19c)],'page':_0x35c489,'page_size':0x12c});if(!_0x42ba30[_0x9c052c(0x1e1)]||_0x42ba30['document_infos'][_0x9c052c(0x18b)]==0x0)break;for(let _0x2e8e9d of _0x42ba30[_0x9c052c(0x1e1)]){await this[_0x9c052c(0x24c)][_0x9c052c(0x23d)]({'documentId':_0x2e8e9d[_0x9c052c(0x1c0)]},{'charCount':_0x2e8e9d[_0x9c052c(0x16d)],'status':_0x2e8e9d[_0x9c052c(0x223)],'chunkStrategy':_0x2e8e9d[_0x9c052c(0x1de)],'formatType':_0x2e8e9d[_0x9c052c(0x17c)],'hitCount':_0x2e8e9d[_0x9c052c(0x1c1)],'size':_0x2e8e9d[_0x9c052c(0x22e)],'sliceCount':_0x2e8e9d['slice_count'],'sourceType':_0x2e8e9d[_0x9c052c(0x1bb)],'type':_0x2e8e9d[_0x9c052c(0x1d8)],'docTreeTosUrl':_0x2e8e9d[_0x9c052c(0x230)],'previewTosUrl':_0x2e8e9d[_0x9c052c(0x217)],'webUrl':_0x2e8e9d[_0x9c052c(0x225)]});}_0x35c489++;}}_0x39eee6++;}}async[_0x300d2f(0x179)](){const _0x529545=_0x300d2f,_0x47ea43=await this[_0x529545(0x161)](''),_0x12b69b=await this[_0x529545(0x24c)][_0x529545(0x1fb)]({'where':{'progress':(0x0,typeorm_2['LessThan'])(0x64)}});if(_0x12b69b[_0x529545(0x18b)])for(let _0x42bece of _0x12b69b){const _0x4429a4=await _0x47ea43[_0x529545(0x171)][_0x529545(0x1cd)](_0x42bece[_0x529545(0x212)],{'document_ids':[_0x42bece[_0x529545(0x205)]]});if(_0x4429a4[_0x529545(0x234)][_0x529545(0x18b)])for(let _0x1741e7 of _0x4429a4[_0x529545(0x234)]){await this[_0x529545(0x24c)][_0x529545(0x23d)]({'documentId':_0x1741e7[_0x529545(0x1c0)]},{'progress':_0x1741e7[_0x529545(0x152)],'size':_0x1741e7[_0x529545(0x22e)],'remainingTime':_0x1741e7[_0x529545(0x1d1)],'statusDescript':_0x1741e7[_0x529545(0x1d6)]});}}}async['getModelFree'](_0x102678,_0xe117fe){const _0x422941=_0x300d2f,_0x3f92e6=_0x102678['user']?.['id'],_0x285566=await this[_0x422941(0x1b5)]['findOne']({'where':{'userId':_0x102678[_0x422941(0x199)]['id'],'conversationId':_0xe117fe[_0x422941(0x1e8)]}});if(!_0x285566)throw new common_1[(_0x422941(0x1aa))](_0x422941(0x213),common_1[_0x422941(0x1dd)][_0x422941(0x1a1)]);const _0x142dbc=await this[_0x422941(0x161)](_0x102678[_0x422941(0x199)]['id']),_0x53a230=await _0x142dbc[_0x422941(0x1d3)][_0x422941(0x1f6)]({'bot_id':_0x285566[_0x422941(0x1db)]}),_0x5b2f25=await this['cozeModelEntity']['findOne']({'where':{'modelId':_0x53a230[_0x422941(0x1ba)]['model_id']}});if(!_0x5b2f25)throw new common_1[(_0x422941(0x1aa))](_0x422941(0x1c8),common_1[_0x422941(0x1dd)][_0x422941(0x1a1)]);if(!_0x3f92e6)return{'remainCount':0x0,'freeCount':0x0,'isVipFree':_0x5b2f25[_0x422941(0x218)]==-0x1,'useIntegrate':_0x5b2f25['deduct']};return{'remainCount':await this['userService'][_0x422941(0x206)](_0x3f92e6,_0x5b2f25[_0x422941(0x24b)],_0x5b2f25['vipFreeNum']),'freeCount':_0x5b2f25['vipFreeNum'],'isVipFree':_0x5b2f25[_0x422941(0x218)]==-0x1,'useIntegrate':_0x5b2f25[_0x422941(0x22d)]};}};CozeService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(bot_entity_1['CozeBotEntity'])),__param(0x1,(0x0,typeorm_1[_0x300d2f(0x1f5)])(knowledge_entity_1[_0x300d2f(0x248)])),__param(0x2,(0x0,typeorm_1[_0x300d2f(0x1f5)])(knowledgedocument_entity_1[_0x300d2f(0x168)])),__param(0x3,(0x0,typeorm_1[_0x300d2f(0x1f5)])(model_entity_1['CozeModelEntity'])),__param(0x4,(0x0,typeorm_1[_0x300d2f(0x1f5)])(conversation_entity_1[_0x300d2f(0x1d9)])),__param(0x5,(0x0,typeorm_1[_0x300d2f(0x1f5)])(message_entity_1[_0x300d2f(0x1e7)])),__param(0x6,(0x0,typeorm_1[_0x300d2f(0x1f5)])(workflow_entity_1['CozeWorkflowEntity'])),__param(0x7,(0x0,typeorm_1[_0x300d2f(0x1f5)])(user_entity_1[_0x300d2f(0x1f9)])),__metadata(_0x300d2f(0x1fc),[typeorm_2[_0x300d2f(0x1e3)],typeorm_2['Repository'],typeorm_2[_0x300d2f(0x1e3)],typeorm_2[_0x300d2f(0x1e3)],typeorm_2[_0x300d2f(0x1e3)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2['Repository'],user_service_1[_0x300d2f(0x16e)],badwords_service_1[_0x300d2f(0x1af)],cm_service_1['CmConfigService']])],CozeService),exports[_0x300d2f(0x1bc)]=CozeService;