'use strict';function _0x51db(_0x50a4ff,_0x2a939a){const _0x39a461=_0x39a4();return _0x51db=function(_0x51dbff,_0x40c7ff){_0x51dbff=_0x51dbff-0x1be;let _0x3c100b=_0x39a461[_0x51dbff];return _0x3c100b;},_0x51db(_0x50a4ff,_0x2a939a);}const _0x87bb81=_0x51db;(function(_0x5295e5,_0x56e0b1){const _0x3670a7=_0x51db,_0x2ebedf=_0x5295e5();while(!![]){try{const _0x219fca=parseInt(_0x3670a7(0x219))/0x1*(parseInt(_0x3670a7(0x20c))/0x2)+parseInt(_0x3670a7(0x200))/0x3*(-parseInt(_0x3670a7(0x1f1))/0x4)+-parseInt(_0x3670a7(0x1ce))/0x5+parseInt(_0x3670a7(0x218))/0x6+parseInt(_0x3670a7(0x1c4))/0x7+-parseInt(_0x3670a7(0x1d1))/0x8+-parseInt(_0x3670a7(0x1e9))/0x9*(-parseInt(_0x3670a7(0x1fd))/0xa);if(_0x219fca===_0x56e0b1)break;else _0x2ebedf['push'](_0x2ebedf['shift']());}catch(_0xfafebb){_0x2ebedf['push'](_0x2ebedf['shift']());}}}(_0x39a4,0x9947d));function _0x39a4(){const _0x5310b1=['document_id','client.upload','智能体不存在！','typeorm','save','getOwnPropertyDescriptor','user','CozeBotEntity','default','iconFileId','getKnowledgeDocumentProgress','COZE_SPACE_ID','description','4671PmvNrq','knowledgeEntity','fileUrl','__metadata','bots','deleteKnowledge','COZE_API_KEY','Injectable','40kmZhRN','name','userId','deleteKnowledgeDocument','knowledge','CozeKnowledgeEntity','promptInfo','workflowIdList','Repository','client.datasets.document.delete','COZE_BASE_URL','pluginIdList','12830tPMUYy','CozeAPI','getKnowledgeDocumentList','306249VDkCMX','page','decorate','@nestjs/common','iconFileUrl','function','createKnowledgeDocument','文档不存在！','publishBot','client.datasets.document.create','knowledgeId','findOne','6SrOQXs','dataset_id','updateKnowledge','CozeService','findAndCount','__decorate','SPACE_ID','documents','object','botEntity','files','publish','216102TWSkgH','207151hpwRMx','fileId','documentId','knowledgeDocumentEntity','CozeKnowledgeDocumentEntity','datasets','client.datasets.process','process','8465044MpsNrk','env','@nestjs/typeorm','log','./entity/bot.entity','uploadForUrl','isRelease','@coze/api','upload','getCozeApi','955385WSxHEN','./entity/knowledgedocument.entity','defineProperty','5543160uwlKRV','length','metadata','InjectRepository','delete','update','知识库不存在！','size','updateBot','botId','create'];_0x39a4=function(){return _0x5310b1;};return _0x39a4();}var __decorate=this&&this[_0x87bb81(0x211)]||function(_0x55caeb,_0x2f58a0,_0x23e793,_0x4665eb){const _0x7aaf43=_0x87bb81;var _0x54adcd=arguments['length'],_0x23dfd1=_0x54adcd<0x3?_0x2f58a0:_0x4665eb===null?_0x4665eb=Object[_0x7aaf43(0x1e1)](_0x2f58a0,_0x23e793):_0x4665eb,_0x56dd19;if(typeof Reflect===_0x7aaf43(0x214)&&typeof Reflect[_0x7aaf43(0x202)]==='function')_0x23dfd1=Reflect[_0x7aaf43(0x202)](_0x55caeb,_0x2f58a0,_0x23e793,_0x4665eb);else{for(var _0x142007=_0x55caeb[_0x7aaf43(0x1d2)]-0x1;_0x142007>=0x0;_0x142007--)if(_0x56dd19=_0x55caeb[_0x142007])_0x23dfd1=(_0x54adcd<0x3?_0x56dd19(_0x23dfd1):_0x54adcd>0x3?_0x56dd19(_0x2f58a0,_0x23e793,_0x23dfd1):_0x56dd19(_0x2f58a0,_0x23e793))||_0x23dfd1;}return _0x54adcd>0x3&&_0x23dfd1&&Object[_0x7aaf43(0x1d0)](_0x2f58a0,_0x23e793,_0x23dfd1),_0x23dfd1;},__metadata=this&&this[_0x87bb81(0x1ec)]||function(_0x41aa16,_0x3c4c90){const _0x621660=_0x87bb81;if(typeof Reflect===_0x621660(0x214)&&typeof Reflect[_0x621660(0x1d3)]===_0x621660(0x205))return Reflect[_0x621660(0x1d3)](_0x41aa16,_0x3c4c90);},__param=this&&this['__param']||function(_0x53e2b6,_0x132b73){return function(_0x5e3d8f,_0x190a9b){_0x132b73(_0x5e3d8f,_0x190a9b,_0x53e2b6);};};Object[_0x87bb81(0x1d0)](exports,'__esModule',{'value':!![]}),exports[_0x87bb81(0x20f)]=void 0x0;const common_1=require(_0x87bb81(0x203)),typeorm_1=require(_0x87bb81(0x1c6)),typeorm_2=require(_0x87bb81(0x1df)),bot_entity_1=require(_0x87bb81(0x1c8)),knowledge_entity_1=require('./entity/knowledge.entity'),knowledgedocument_entity_1=require(_0x87bb81(0x1cf)),api_1=require(_0x87bb81(0x1cb)),fs_1=require('fs');let CozeService=class CozeService{constructor(_0x118759,_0x2d37a7,_0xd6c74){const _0x4f3cc1=_0x87bb81;this['botEntity']=_0x118759,this[_0x4f3cc1(0x1ea)]=_0x2d37a7,this[_0x4f3cc1(0x1bf)]=_0xd6c74,this[_0x4f3cc1(0x212)]=process[_0x4f3cc1(0x1c5)][_0x4f3cc1(0x1e7)];}[_0x87bb81(0x1cd)](){const _0x31db47=_0x87bb81,_0x7634ab=process[_0x31db47(0x1c5)][_0x31db47(0x1fb)]||'https://api.coze.cn',_0xec77d=process[_0x31db47(0x1c5)][_0x31db47(0x1ef)];return new api_1[(_0x31db47(0x1fe))]({'baseURL':_0x7634ab,'token':_0xec77d});}async['createBot'](_0x2e5fcb,_0x47051a){const _0x341d3e=_0x87bb81;if(_0x2e5fcb['iconFileUrl']){const _0x1d9000=await this['uploadForUrl'](_0x2e5fcb[_0x341d3e(0x204)]);_0x2e5fcb[_0x341d3e(0x1e5)]=_0x1d9000['id'];}const _0x559625=this[_0x341d3e(0x1cd)](),_0x2bd85f=await _0x559625['bots'][_0x341d3e(0x1db)]({'prompt_info':_0x2e5fcb[_0x341d3e(0x1f7)],'onboarding_info':_0x2e5fcb['onboardingInfo'],'name':_0x2e5fcb[_0x341d3e(0x1f2)],'description':_0x2e5fcb[_0x341d3e(0x1e8)],'icon_file_id':_0x2e5fcb['iconFileId'],'space_id':this['SPACE_ID']});_0x2e5fcb[_0x341d3e(0x1da)]=_0x2bd85f['bot_id'],_0x2e5fcb[_0x341d3e(0x1f3)]=_0x47051a[_0x341d3e(0x1e2)]['id'],await this[_0x341d3e(0x215)][_0x341d3e(0x1e0)](_0x2e5fcb);}async[_0x87bb81(0x1d9)](_0x8d39b5,_0x291b26){const _0x49d110=_0x87bb81,_0x20d88e=await this[_0x49d110(0x215)][_0x49d110(0x20b)]({'where':{'id':_0x8d39b5['id']}});if(!_0x20d88e||_0x20d88e[_0x49d110(0x1f3)]!=_0x291b26[_0x49d110(0x1e2)]['id'])throw new Error(_0x49d110(0x1de));if(_0x20d88e['iconFileUrl']!=_0x8d39b5[_0x49d110(0x204)]){const _0x510f8d=await this[_0x49d110(0x1c9)](_0x8d39b5[_0x49d110(0x204)]);_0x8d39b5[_0x49d110(0x1e5)]=_0x510f8d['id'];}const _0x13652a=this[_0x49d110(0x1cd)]();await _0x13652a[_0x49d110(0x1ed)]['update']({'prompt_info':_0x8d39b5[_0x49d110(0x1f7)],'onboarding_info':_0x8d39b5['onboardingInfo'],'name':_0x8d39b5['name'],'description':_0x8d39b5['description'],'icon_file_id':_0x8d39b5['iconFileId'],'knowledge':_0x8d39b5[_0x49d110(0x1f5)],'bot_id':_0x8d39b5[_0x49d110(0x1da)],'plugin_id_list':_0x8d39b5[_0x49d110(0x1fc)],'workflow_id_list':_0x8d39b5[_0x49d110(0x1f8)]}),await this[_0x49d110(0x215)][_0x49d110(0x1e0)](_0x8d39b5);}async[_0x87bb81(0x208)](_0x3b8f8c,_0x5929df){const _0x30ed04=_0x87bb81,_0x2d9cb2=await this[_0x30ed04(0x215)][_0x30ed04(0x20b)]({'where':{'id':_0x3b8f8c}});if(!_0x2d9cb2||_0x2d9cb2[_0x30ed04(0x1f3)]!=_0x5929df[_0x30ed04(0x1e2)]['id'])throw new Error(_0x30ed04(0x1de));const _0x361b71=this['getCozeApi']();await _0x361b71['bots'][_0x30ed04(0x217)]({'bot_id':_0x2d9cb2[_0x30ed04(0x1da)],'connector_ids':['1024','999']}),_0x2d9cb2[_0x30ed04(0x1ca)]=0x1,await this['botEntity']['save'](_0x2d9cb2);}async[_0x87bb81(0x1cc)](_0x573c44,_0x7a080a){const _0xb9d4e1=_0x87bb81,_0x2d05aa=this[_0xb9d4e1(0x1cd)](),_0x125807=await _0x2d05aa[_0xb9d4e1(0x216)][_0xb9d4e1(0x1cc)]({'file':_0x573c44});console[_0xb9d4e1(0x1c7)](_0xb9d4e1(0x1dd),_0x125807);}async['uploadForUrl'](_0x2d18e4){const _0x598fa9=_0x87bb81,_0x553d6d=this['getCozeApi'](),_0xc5d0f7=fs_1[_0x598fa9(0x1e4)]['createReadStream'](_0x2d18e4),_0x558d6c=await _0x553d6d[_0x598fa9(0x216)][_0x598fa9(0x1cc)]({'file':_0xc5d0f7});return _0x558d6c;}async['createKnowledge'](_0x2c9c6f,_0x271eec){const _0x5a360b=_0x87bb81,_0x426987=await this[_0x5a360b(0x1c9)](_0x2c9c6f[_0x5a360b(0x1eb)]);_0x2c9c6f[_0x5a360b(0x21a)]=_0x426987['id'];const _0x228038=this[_0x5a360b(0x1cd)](),_0x5ac9e7=await _0x228038[_0x5a360b(0x1c1)][_0x5a360b(0x1db)]({'name':_0x2c9c6f[_0x5a360b(0x1f2)],'description':_0x2c9c6f[_0x5a360b(0x1e8)],'file_id':_0x2c9c6f[_0x5a360b(0x21a)],'space_id':this[_0x5a360b(0x212)],'format_type':_0x2c9c6f['formatType']});_0x2c9c6f[_0x5a360b(0x20a)]=_0x5ac9e7['dataset_id'],_0x2c9c6f[_0x5a360b(0x1f3)]=_0x271eec[_0x5a360b(0x1e2)]['id'],await this[_0x5a360b(0x1ea)][_0x5a360b(0x1e0)](_0x2c9c6f);}async[_0x87bb81(0x20e)](_0x4c36ec,_0x5c4594){const _0x4d384b=_0x87bb81,_0xb923c7=await this[_0x4d384b(0x1ea)][_0x4d384b(0x20b)]({'where':{'id':_0x4c36ec['id']}});if(!_0xb923c7||_0xb923c7[_0x4d384b(0x1f3)]!=_0x5c4594[_0x4d384b(0x1e2)]['id'])throw new Error(_0x4d384b(0x1d7));if(_0xb923c7[_0x4d384b(0x1eb)]!=_0x4c36ec['fileUrl']){const _0x1d7591=await this[_0x4d384b(0x1c9)](_0x4c36ec[_0x4d384b(0x1eb)]);_0x4c36ec['fileId']=_0x1d7591['id'];}const _0x48538c=this[_0x4d384b(0x1cd)]();await _0x48538c[_0x4d384b(0x1c1)][_0x4d384b(0x1d6)](_0xb923c7[_0x4d384b(0x20a)],{'name':_0x4c36ec[_0x4d384b(0x1f2)],'description':_0x4c36ec['description'],'file_id':_0x4c36ec[_0x4d384b(0x21a)]}),await this[_0x4d384b(0x215)][_0x4d384b(0x1e0)](_0x4c36ec);}async[_0x87bb81(0x1ee)](_0x331475,_0x19cda5){const _0x5ca2cd=_0x87bb81,_0x3d8b19=await this[_0x5ca2cd(0x1ea)][_0x5ca2cd(0x20b)]({'where':{'id':_0x331475}});if(!_0x3d8b19||_0x3d8b19[_0x5ca2cd(0x1f3)]!=_0x19cda5[_0x5ca2cd(0x1e2)]['id'])throw new Error(_0x5ca2cd(0x1d7));const _0x340aa3=this['getCozeApi'](),_0x58857f=await _0x340aa3['datasets'][_0x5ca2cd(0x1d5)](_0x3d8b19[_0x5ca2cd(0x20a)]);await this[_0x5ca2cd(0x1ea)]['delete'](_0x331475);}async['getKnowledgeList'](_0x1d1a93,_0x5c4f00){const _0x421df5=_0x87bb81,[_0x402e90,_0x5a5a84]=await this[_0x421df5(0x1ea)][_0x421df5(0x210)]({'where':{'userId':_0x5c4f00[_0x421df5(0x1e2)]['id']},'order':{'id':'DESC'},'skip':(_0x1d1a93[_0x421df5(0x201)]-0x1)*_0x1d1a93['size'],'take':_0x1d1a93[_0x421df5(0x1d8)]});return{'rows':_0x402e90,'count':_0x5a5a84};}async[_0x87bb81(0x1ff)](_0xfd66ce,_0x105c70){const _0x4182da=_0x87bb81,[_0x57a26b,_0x21882b]=await this[_0x4182da(0x1bf)]['findAndCount']({'where':{'userId':_0x105c70[_0x4182da(0x1e2)]['id']},'order':{'id':'DESC'},'skip':(_0xfd66ce[_0x4182da(0x201)]-0x1)*_0xfd66ce[_0x4182da(0x1d8)],'take':_0xfd66ce['size']});return{'rows':_0x57a26b,'count':_0x21882b};}async[_0x87bb81(0x206)](_0x4bb085,_0x27dcba){const _0x335171=_0x87bb81,_0x22758a=this[_0x335171(0x1cd)](),_0x44ce44=await _0x22758a[_0x335171(0x1c1)]['documents']['create'](_0x4bb085);for(const _0x155c15 of _0x44ce44){await this[_0x335171(0x1bf)][_0x335171(0x1e0)]({'userId':_0x27dcba['user']['id'],'spaceId':this[_0x335171(0x212)],'knowledgeId':_0x4bb085[_0x335171(0x20d)],'name':_0x155c15['name'],'documentId':_0x155c15[_0x335171(0x1dc)]});}console[_0x335171(0x1c7)](_0x335171(0x209),_0x44ce44);}async['updateKnowledgeDocument'](_0x489e97,_0x1593eb){const _0x2a0c93=_0x87bb81,_0x541958=await this[_0x2a0c93(0x1bf)][_0x2a0c93(0x20b)]({'where':{'id':_0x489e97['id']}});if(!_0x541958||_0x541958[_0x2a0c93(0x1f3)]!=_0x1593eb[_0x2a0c93(0x1e2)]['id'])throw new Error(_0x2a0c93(0x207));await this['knowledgeDocumentEntity'][_0x2a0c93(0x1e0)](_0x489e97);const _0x392dad=this['getCozeApi'](),_0x1173f3=await _0x392dad[_0x2a0c93(0x1c1)][_0x2a0c93(0x213)]['update']({'document_id':_0x541958[_0x2a0c93(0x1be)],'document_name':_0x489e97[_0x2a0c93(0x1f2)]});}async[_0x87bb81(0x1f4)](_0x5bf4f2,_0x57b14b){const _0x9bb526=_0x87bb81,_0x4a365c=await this[_0x9bb526(0x1bf)]['findOne']({'where':{'id':_0x5bf4f2}});if(!_0x4a365c||_0x4a365c[_0x9bb526(0x1f3)]!=_0x57b14b[_0x9bb526(0x1e2)]['id'])throw new Error('文档不存在！');await this[_0x9bb526(0x1bf)][_0x9bb526(0x1d5)](_0x5bf4f2);const _0x234507=this[_0x9bb526(0x1cd)](),_0xa84f3d=await _0x234507[_0x9bb526(0x1c1)][_0x9bb526(0x213)][_0x9bb526(0x1d5)]({'document_ids':[_0x4a365c[_0x9bb526(0x1be)]]});console[_0x9bb526(0x1c7)](_0x9bb526(0x1fa),_0xa84f3d);}async[_0x87bb81(0x1e6)](_0x2fc970,_0x7f966a,_0x2f974d){const _0x34d269=_0x87bb81,_0x49185d=this['getCozeApi'](),_0x47b8d4=await _0x49185d[_0x34d269(0x1c1)][_0x34d269(0x1c3)](_0x2fc970,_0x7f966a);console['log'](_0x34d269(0x1c2),_0x47b8d4);}};CozeService=__decorate([(0x0,common_1[_0x87bb81(0x1f0)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(bot_entity_1[_0x87bb81(0x1e3)])),__param(0x1,(0x0,typeorm_1[_0x87bb81(0x1d4)])(knowledge_entity_1[_0x87bb81(0x1f6)])),__param(0x2,(0x0,typeorm_1[_0x87bb81(0x1d4)])(knowledgedocument_entity_1[_0x87bb81(0x1c0)])),__metadata('design:paramtypes',[typeorm_2[_0x87bb81(0x1f9)],typeorm_2[_0x87bb81(0x1f9)],typeorm_2['Repository']])],CozeService),exports[_0x87bb81(0x20f)]=CozeService;