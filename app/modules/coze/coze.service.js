'use strict';const _0x1d773c=_0x1a88;(function(_0x56ef8e,_0x500a17){const _0x15a7c7=_0x1a88,_0x495830=_0x56ef8e();while(!![]){try{const _0x2e3ac8=parseInt(_0x15a7c7(0x138))/0x1+-parseInt(_0x15a7c7(0x18c))/0x2+parseInt(_0x15a7c7(0x1af))/0x3+parseInt(_0x15a7c7(0x199))/0x4+-parseInt(_0x15a7c7(0x13b))/0x5+parseInt(_0x15a7c7(0x1a5))/0x6+parseInt(_0x15a7c7(0x1d8))/0x7*(-parseInt(_0x15a7c7(0xef))/0x8);if(_0x2e3ac8===_0x500a17)break;else _0x495830['push'](_0x495830['shift']());}catch(_0x358967){_0x495830['push'](_0x495830['shift']());}}}(_0x2723,0x94db5));var __decorate=this&&this[_0x1d773c(0x19c)]||function(_0x5978a1,_0x18297b,_0x32645e,_0x58ab1c){const _0x5dad00=_0x1d773c;var _0x25db4c=arguments['length'],_0x4593c1=_0x25db4c<0x3?_0x18297b:_0x58ab1c===null?_0x58ab1c=Object['getOwnPropertyDescriptor'](_0x18297b,_0x32645e):_0x58ab1c,_0x252c32;if(typeof Reflect===_0x5dad00(0x109)&&typeof Reflect[_0x5dad00(0x1db)]===_0x5dad00(0xe1))_0x4593c1=Reflect[_0x5dad00(0x1db)](_0x5978a1,_0x18297b,_0x32645e,_0x58ab1c);else{for(var _0x3fb257=_0x5978a1[_0x5dad00(0x19a)]-0x1;_0x3fb257>=0x0;_0x3fb257--)if(_0x252c32=_0x5978a1[_0x3fb257])_0x4593c1=(_0x25db4c<0x3?_0x252c32(_0x4593c1):_0x25db4c>0x3?_0x252c32(_0x18297b,_0x32645e,_0x4593c1):_0x252c32(_0x18297b,_0x32645e))||_0x4593c1;}return _0x25db4c>0x3&&_0x4593c1&&Object[_0x5dad00(0xc6)](_0x18297b,_0x32645e,_0x4593c1),_0x4593c1;},__metadata=this&&this[_0x1d773c(0x188)]||function(_0x19526d,_0x14d43e){const _0x382f9e=_0x1d773c;if(typeof Reflect===_0x382f9e(0x109)&&typeof Reflect[_0x382f9e(0x1c5)]===_0x382f9e(0xe1))return Reflect[_0x382f9e(0x1c5)](_0x19526d,_0x14d43e);},__param=this&&this[_0x1d773c(0xb3)]||function(_0x15972a,_0x595a46){return function(_0xf06744,_0x43609c){_0x595a46(_0xf06744,_0x43609c,_0x15972a);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x1d773c(0xe5)]=void 0x0;const common_1=require(_0x1d773c(0x1f2)),typeorm_1=require(_0x1d773c(0xb2)),typeorm_2=require('typeorm'),bot_entity_1=require('./entity/bot.entity'),knowledge_entity_1=require(_0x1d773c(0xc4)),knowledgedocument_entity_1=require(_0x1d773c(0x125)),api_1=require('@coze/api'),model_entity_1=require('./entity/model.entity'),guid_typescript_1=require('guid-typescript'),https_1=require('https'),axios_1=require(_0x1d773c(0x19b)),conversation_entity_1=require('./entity/conversation.entity'),message_entity_1=require(_0x1d773c(0x123)),user_entity_1=require('../user/user.entity'),user_service_1=require(_0x1d773c(0x168)),collectType_constant_1=require(_0x1d773c(0x16d)),badwords_service_1=require(_0x1d773c(0x1d4)),workflow_entity_1=require(_0x1d773c(0xb5)),cm_service_1=require('../cmConfig/cm.service'),file_service_1=require(_0x1d773c(0x178)),uuid_1=require('uuid'),zhipu_1=require(_0x1d773c(0xee)),helper_1=require(_0x1d773c(0xd1)),balance_constant_1=require(_0x1d773c(0xfe));function _0x1a88(_0x428c28,_0x1af5e2){const _0x2723bf=_0x2723();return _0x1a88=function(_0x1a88f3,_0x25e381){_0x1a88f3=_0x1a88f3-0xb1;let _0x4fc072=_0x2723bf[_0x1a88f3];return _0x4fc072;},_0x1a88(_0x428c28,_0x1af5e2);}let CozeService=class CozeService{constructor(_0x3b8106,_0x2b53a1,_0x48eb0b,_0x5e2566,_0x12c86c,_0x4a6246,_0x45a8e5,_0x155fdb,_0x26a5bf,_0x276c88,_0x39b55b,_0x5dfeef){const _0x494f7e=_0x1d773c;this[_0x494f7e(0x118)]=_0x3b8106,this[_0x494f7e(0x12e)]=_0x2b53a1,this[_0x494f7e(0x1df)]=_0x48eb0b,this[_0x494f7e(0xfa)]=_0x5e2566,this[_0x494f7e(0x1e4)]=_0x12c86c,this[_0x494f7e(0xd3)]=_0x4a6246,this[_0x494f7e(0x1a7)]=_0x45a8e5,this[_0x494f7e(0x156)]=_0x155fdb,this[_0x494f7e(0x18e)]=_0x26a5bf,this[_0x494f7e(0xc7)]=_0x276c88,this[_0x494f7e(0x153)]=_0x39b55b,this[_0x494f7e(0xcf)]=_0x5dfeef,this[_0x494f7e(0xea)]=_0x494f7e(0x117);}async[_0x1d773c(0x163)](_0x255fcd){const _0x21739a=_0x1d773c;try{const _0x392a6c=await this[_0x21739a(0x153)][_0x21739a(0x185)]('CozeApiConfig'),_0x360b79=_0x392a6c[_0x21739a(0xde)][_0x21739a(0x197)],_0x10e6b2=_0x392a6c[_0x21739a(0xde)][_0x21739a(0x1a4)],_0xc04670=_0x392a6c[_0x21739a(0xde)]['keyid'];this[_0x21739a(0xea)]=_0x392a6c['api'][_0x21739a(0x198)];let _0x3bd7c5=await(0x0,api_1[_0x21739a(0x154)])({'baseURL':'https://api.coze.cn','appId':_0x10e6b2,'aud':_0x21739a(0x15f),'keyid':_0xc04670,'privateKey':_0x360b79,'sessionName':_0x255fcd+''});return _0x3bd7c5;}catch(_0x35aaf4){return{'expires_in':0x0,'access_token':''};}}async[_0x1d773c(0x1ac)](_0x20c68c){const _0xdfb178=_0x1d773c;let _0x3e9e10=await this[_0xdfb178(0x163)](_0x20c68c);const _0x5c9cb6=new api_1[(_0xdfb178(0xdd))]({'baseURL':_0xdfb178(0x10c),'token':async()=>{const _0x20ff2e=_0xdfb178;if(_0x3e9e10[_0x20ff2e(0xf7)]*0x3e8>Date[_0x20ff2e(0x165)]()+0x1388)return _0x3e9e10[_0x20ff2e(0x13c)];return _0x3e9e10=await this['getJwtToken'](_0x20c68c),_0x3e9e10[_0x20ff2e(0x13c)];}});return _0x5c9cb6;}async[_0x1d773c(0x1b7)](_0xad4da8,_0x5d7939){const _0x40d03b=_0x1d773c;if(_0xad4da8[_0x40d03b(0x1e5)]){const _0x59532b=await this['uploadForUrl'](_0xad4da8[_0x40d03b(0x1e5)]);_0xad4da8['iconFileId']=_0x59532b['id'];}try{const _0x10f22d=await this[_0x40d03b(0x1ac)](_0x5d7939[_0x40d03b(0x1b1)]['id']),_0x454b0b=await _0x10f22d['bots'][_0x40d03b(0xfc)]({'prompt_info':_0xad4da8['promptInfo'],'onboarding_info':_0xad4da8[_0x40d03b(0xff)],'name':_0xad4da8[_0x40d03b(0x102)],'description':_0xad4da8[_0x40d03b(0x16f)],'icon_file_id':_0xad4da8[_0x40d03b(0x150)],'space_id':this[_0x40d03b(0xea)]});return _0xad4da8[_0x40d03b(0x11e)]=_0x454b0b[_0x40d03b(0x107)],_0xad4da8[_0x40d03b(0x1ce)]=_0x5d7939[_0x40d03b(0x1b1)]['id'],_0xad4da8[_0x40d03b(0x198)]=this[_0x40d03b(0xea)],await this['botEntity'][_0x40d03b(0x180)](_0xad4da8),_0xad4da8;}catch(_0x58558a){console[_0x40d03b(0x126)](_0x40d03b(0x193),_0x58558a);}}async[_0x1d773c(0x12c)](_0x1474d0,_0x11a54b){const _0x8ab00a=_0x1d773c;try{const _0x233729=this[_0x8ab00a(0x18e)][_0x8ab00a(0x160)](_0x11a54b),_0x36a683=_0x233729?.['id'],_0x15d734=await this['botEntity'][_0x8ab00a(0xe2)]({'where':{'botId':_0x1474d0}});if(!_0x15d734||_0x15d734[_0x8ab00a(0x1ce)]!=0x0&&_0x15d734[_0x8ab00a(0x1ce)]!=_0x36a683)throw new common_1[(_0x8ab00a(0x18b))]('智能体不存在！',common_1[_0x8ab00a(0x17a)][_0x8ab00a(0x132)]);if(_0x15d734['botType']==_0x8ab00a(0x147)||!_0x15d734[_0x8ab00a(0x1a6)]){const _0x4de4ce=await this[_0x8ab00a(0x1ac)](_0x36a683||(0x0,uuid_1['v4'])());if(_0x15d734[_0x8ab00a(0xe6)]==0x1){const _0x1bdaff=await _0x4de4ce['bots']['retrieve']({'bot_id':_0x1474d0});_0x15d734['modelInfoConfig']=_0x1bdaff['model_info'],_0x15d734[_0x8ab00a(0xdf)]=_0x1bdaff[_0x8ab00a(0x100)],_0x15d734['onboardingInfo']=_0x1bdaff[_0x8ab00a(0x113)],_0x15d734[_0x8ab00a(0x108)]+=0x1,await this[_0x8ab00a(0x118)][_0x8ab00a(0x180)](_0x15d734);}}return _0x15d734;}catch(_0x4c0927){console['log']('-----------------获取智能体失败----------',_0x4c0927);throw new common_1[(_0x8ab00a(0x18b))](_0x8ab00a(0x1eb),common_1[_0x8ab00a(0x17a)][_0x8ab00a(0x132)]);}}async[_0x1d773c(0x194)](_0x289a6a,_0x388905){const _0x33c66a=_0x1d773c,_0x15a319=await this['botEntity']['findOne']({'where':{'botId':_0x289a6a[_0x33c66a(0x11e)]}});if(!_0x15a319)throw new Error('智能体不存在！');if(_0x15a319[_0x33c66a(0x1e5)]!=_0x289a6a[_0x33c66a(0x1e5)]){const _0x416e0e=await this[_0x33c66a(0x18f)](_0x289a6a[_0x33c66a(0x1e5)]);_0x289a6a[_0x33c66a(0x150)]=_0x416e0e['id'];}try{const _0x3fd9f8=await this[_0x33c66a(0x1ac)](_0x388905[_0x33c66a(0x1b1)]['id']);Array[_0x33c66a(0xec)](_0x15a319[_0x33c66a(0xdf)])&&(_0x289a6a[_0x33c66a(0xdf)]={'ids':_0x15a319[_0x33c66a(0xdf)]});_0x289a6a['workflowIdList']={};const _0x209621={'prompt_info':_0x289a6a[_0x33c66a(0x11b)],'onboarding_info':_0x289a6a['onboardingInfo'],'name':_0x289a6a[_0x33c66a(0x102)],'description':_0x289a6a['description'],'icon_file_id':_0x289a6a[_0x33c66a(0x150)],'knowledge':_0x289a6a[_0x33c66a(0xfd)],'bot_id':_0x289a6a[_0x33c66a(0x11e)],'plugin_id_list':!_0x289a6a[_0x33c66a(0xf2)]?{}:Array[_0x33c66a(0xec)](_0x289a6a[_0x33c66a(0xf2)])?{'id_list':_0x289a6a['pluginIdList']}:_0x289a6a[_0x33c66a(0xf2)],'workflow_id_list':!_0x289a6a[_0x33c66a(0xdf)]?{}:Array[_0x33c66a(0xec)](_0x289a6a[_0x33c66a(0xdf)])?{'ids':_0x289a6a[_0x33c66a(0xdf)]}:_0x289a6a['workflowIdList'],'model_info_config':_0x289a6a[_0x33c66a(0x17e)]};console[_0x33c66a(0x126)]('----------------------updateBot--------------',_0x209621),await _0x3fd9f8[_0x33c66a(0x171)]['update'](_0x209621),this[_0x33c66a(0x144)](_0x15a319[_0x33c66a(0x11e)],_0x388905),_0x15a319[_0x33c66a(0x11b)]&&(_0x289a6a['promptInfo']=_0x15a319['promptInfo']),_0x15a319[_0x33c66a(0xff)]&&(_0x289a6a[_0x33c66a(0xff)]=_0x15a319[_0x33c66a(0xff)]),_0x15a319[_0x33c66a(0x102)]&&(_0x289a6a[_0x33c66a(0x102)]=_0x15a319[_0x33c66a(0x102)]),_0x289a6a['description']=_0x15a319[_0x33c66a(0x16f)],_0x15a319[_0x33c66a(0x150)]&&(_0x289a6a[_0x33c66a(0x150)]=_0x15a319[_0x33c66a(0x150)]),_0x15a319['knowledge']&&(_0x289a6a['knowledge']=_0x15a319[_0x33c66a(0xfd)]),_0x15a319[_0x33c66a(0x11e)]&&(_0x289a6a[_0x33c66a(0x11e)]=_0x15a319[_0x33c66a(0x11e)]),_0x15a319[_0x33c66a(0xf2)]&&(_0x289a6a[_0x33c66a(0xf2)]=_0x15a319[_0x33c66a(0xf2)]),_0x15a319['workflowIdList']&&(_0x289a6a[_0x33c66a(0xdf)]=_0x15a319[_0x33c66a(0xdf)]),_0x15a319[_0x33c66a(0x17e)]&&(_0x289a6a[_0x33c66a(0x17e)]=_0x15a319['modelInfoConfig']),await this[_0x33c66a(0x118)][_0x33c66a(0x180)](_0x15a319);}catch(_0x14ee6a){return console['log']('-----------------------updateBotErr--------------',_0x14ee6a),_0x14ee6a;}}async[_0x1d773c(0x11d)](_0xd2f3b3,_0x1ee9df){const _0x4c5366=_0x1d773c,_0x1e3b98=await this[_0x4c5366(0x118)]['findOne']({'where':{'botId':_0xd2f3b3,'userId':_0x1ee9df[_0x4c5366(0x1b1)]['id']}});if(!_0x1e3b98||_0x1e3b98[_0x4c5366(0x1ce)]!=_0x1ee9df[_0x4c5366(0x1b1)]['id'])throw new Error(_0x4c5366(0x1d9));await this[_0x4c5366(0x118)][_0x4c5366(0x106)](_0x1e3b98['id']);}async[_0x1d773c(0x13d)](_0x296971,_0x2413f9,_0x552555){const _0x429f84=_0x1d773c,_0x2c7061=await this[_0x429f84(0x118)]['findOne']({'where':{'botId':_0x296971}});if(!_0x2c7061)throw new Error('智能体不存在！');_0x552555==0x1?this[_0x429f84(0x18e)][_0x429f84(0x1f3)](_0x2413f9[_0x429f84(0x1b1)]['id'],_0x2c7061['id'],collectType_constant_1[_0x429f84(0x1c4)][_0x429f84(0x158)]):this[_0x429f84(0x18e)][_0x429f84(0x1b0)](_0x2413f9['user']['id'],_0x2c7061['id'],collectType_constant_1[_0x429f84(0x1c4)]['COZEBOT']);}async[_0x1d773c(0xe8)](_0x4f116a,_0x51aef9){const _0x36f3d1=_0x1d773c,_0x2651a4=await this[_0x36f3d1(0x18e)][_0x36f3d1(0x11c)](_0x4f116a[_0x36f3d1(0x161)],_0x4f116a[_0x36f3d1(0xd8)],_0x51aef9[_0x36f3d1(0x1b1)]['id'],collectType_constant_1[_0x36f3d1(0x1c4)][_0x36f3d1(0x158)]);if(_0x2651a4['count']>0x0){const _0x1ac269=await this[_0x36f3d1(0x118)]['findBy']({'id':(0x0,typeorm_2['In'])(_0x2651a4[_0x36f3d1(0x1ec)][_0x36f3d1(0x1d3)](_0x2e135f=>_0x2e135f[_0x36f3d1(0x1c7)]))});return{'rows':_0x1ac269,'count':_0x2651a4[_0x36f3d1(0x1ea)]};}return{'rows':[],'count':0x0};}async[_0x1d773c(0x1dc)](_0x2d033c,_0x38ba92){const _0x41c2d5=_0x1d773c,_0x5f0433={'userId':_0x38ba92[_0x41c2d5(0x1b1)]['id']};_0x2d033c['tag']&&(_0x5f0433[_0x41c2d5(0x1dd)]=(0x0,typeorm_2[_0x41c2d5(0x1ba)])('%'+_0x2d033c[_0x41c2d5(0xba)]+'%'));_0x2d033c[_0x41c2d5(0x10b)]&&(_0x5f0433['name']=(0x0,typeorm_2[_0x41c2d5(0x1ba)])('%'+_0x2d033c['search']+'%'));const [_0x1a7f35,_0x1e183f]=await this[_0x41c2d5(0x118)][_0x41c2d5(0x13f)]({'where':_0x5f0433,'order':{'id':'DESC'},'skip':(_0x2d033c['page']-0x1)*_0x2d033c[_0x41c2d5(0xd8)],'take':_0x2d033c[_0x41c2d5(0xd8)]}),_0x1a8115=await this[_0x41c2d5(0x18e)][_0x41c2d5(0x166)](_0x1a7f35,_0x38ba92,collectType_constant_1['UserCollectType'][_0x41c2d5(0x158)]);return{'rows':_0x1a8115,'count':_0x1e183f};}async[_0x1d773c(0xbc)](_0xca58ab,_0x389492){const _0x23b454=_0x1d773c,_0x5b154e=await this[_0x23b454(0x1e4)]['find']({'where':{'userId':_0x389492['user']['id']}}),_0x151b0c=[...new Set(_0x5b154e[_0x23b454(0x1d3)](_0xee5f74=>_0xee5f74[_0x23b454(0x11e)]))];if(!_0x151b0c['length'])return{'rows':[],'count':0x0};const _0x46d9c9={'botId':(0x0,typeorm_2['In'])(_0x151b0c)};_0xca58ab[_0x23b454(0xba)]&&(_0x46d9c9[_0x23b454(0x1dd)]=(0x0,typeorm_2[_0x23b454(0x1ba)])('%'+_0xca58ab['tag']+'%'));_0xca58ab['search']&&(_0x46d9c9[_0x23b454(0x102)]=(0x0,typeorm_2['Like'])('%'+_0xca58ab[_0x23b454(0x10b)]+'%'));const [_0x1efe65,_0x28faa4]=await this['botEntity']['findAndCount']({'where':_0x46d9c9,'order':{'id':_0x23b454(0x1b9)},'skip':(_0xca58ab['page']-0x1)*_0xca58ab[_0x23b454(0xd8)],'take':_0xca58ab[_0x23b454(0xd8)]}),_0x392037=await this[_0x23b454(0x18e)][_0x23b454(0x166)](_0x1efe65,_0x389492,collectType_constant_1['UserCollectType'][_0x23b454(0x158)]);return{'rows':_0x392037,'count':_0x28faa4};}async[_0x1d773c(0x1d0)](_0x3052e6,_0x5cf737){const _0x14af45=_0x1d773c,_0x12b81b=[{'publish_flag':0x1}];_0x3052e6[_0x14af45(0xba)]&&_0x12b81b[_0x14af45(0x104)](_0x5e61c5=>{const _0xc3e3ac=_0x14af45;_0x5e61c5[_0xc3e3ac(0x1dd)]=(0x0,typeorm_2[_0xc3e3ac(0x1ba)])('%'+_0x3052e6['tag']+'%');});_0x3052e6[_0x14af45(0x10b)]&&_0x12b81b[_0x14af45(0x104)](_0x51b818=>{const _0x5c1d70=_0x14af45;_0x51b818[_0x5c1d70(0x102)]=(0x0,typeorm_2[_0x5c1d70(0x1ba)])('%'+_0x3052e6[_0x5c1d70(0x10b)]+'%');});_0x12b81b[_0x14af45(0x104)](_0x12363f=>{const _0x11d718=_0x14af45;_0x12363f[_0x11d718(0xe6)]=0x1;});let _0x2b44f6={'id':_0x14af45(0x1b9)};if(_0x3052e6[_0x14af45(0x10a)]==_0x14af45(0x152))_0x2b44f6={'useCount':_0x14af45(0x1b9)};else _0x3052e6[_0x14af45(0x10a)]==_0x14af45(0x136)?_0x2b44f6={'recommendAt':_0x14af45(0x1b9)}:_0x2b44f6={'id':_0x14af45(0x1b9)};const _0x1b4712=await this[_0x14af45(0x118)][_0x14af45(0x13f)]({'where':_0x12b81b,'order':_0x2b44f6,'skip':(_0x3052e6['page']-0x1)*_0x3052e6[_0x14af45(0xd8)],'take':_0x3052e6[_0x14af45(0xd8)]}),[_0x5e591e,_0x52362a]=_0x1b4712,_0x590984=await this['userEntity']['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x5e591e['map'](_0x3c8a45=>_0x3c8a45[_0x14af45(0x1ce)]))}});_0x5e591e['forEach'](_0x564b63=>{const _0x13b3b8=_0x14af45;if(_0x564b63['userId']){const _0x6b24be=_0x590984[_0x13b3b8(0x1d6)](_0x313799=>_0x313799['id']==_0x564b63[_0x13b3b8(0x1ce)]);_0x564b63[_0x13b3b8(0xc5)]={'userId':_0x6b24be['id'],'userName':_0x6b24be[_0x13b3b8(0x101)],'avatar':_0x6b24be[_0x13b3b8(0x14c)]};}_0x564b63['isVipUsed']=_0x564b63[_0x13b3b8(0x1de)]?!![]:![];});const _0xe139c5=await this['userService'][_0x14af45(0x166)](_0x5e591e,_0x5cf737,collectType_constant_1[_0x14af45(0x1c4)]['COZEBOT']);return{'rows':_0xe139c5,'count':_0x52362a};}async[_0x1d773c(0x144)](_0x4b0aa7,_0x1142eb){const _0x54c4e4=_0x1d773c,_0x1224da=await this[_0x54c4e4(0x118)][_0x54c4e4(0xe2)]({'where':{'botId':_0x4b0aa7,'userId':_0x1142eb[_0x54c4e4(0x1b1)]['id']}});if(!_0x1224da||_0x1224da[_0x54c4e4(0x1ce)]!=_0x1142eb[_0x54c4e4(0x1b1)]['id'])throw new Error(_0x54c4e4(0x1d9));const _0xe9acf1=await this[_0x54c4e4(0x1ac)](_0x1142eb[_0x54c4e4(0x1b1)]['id']);await _0xe9acf1[_0x54c4e4(0x171)][_0x54c4e4(0xb8)]({'bot_id':_0x1224da[_0x54c4e4(0x11e)],'connector_ids':[_0x54c4e4(0x1bd),_0x54c4e4(0xd7)]}),_0x1224da[_0x54c4e4(0xe6)]=0x1,await this[_0x54c4e4(0x118)][_0x54c4e4(0x180)](_0x1224da);}async[_0x1d773c(0x189)](_0x50c686,_0x44f3fa){const _0x30d8b2=_0x1d773c,_0x46cbda=await this[_0x30d8b2(0x1ac)](_0x44f3fa['user']['id']);try{const _0x55acd5=await _0x46cbda[_0x30d8b2(0x159)][_0x30d8b2(0x189)]({'file':_0x50c686});return _0x55acd5;}catch(_0x47cc60){console[_0x30d8b2(0x126)](_0x30d8b2(0x1c2),_0x47cc60);}return![];}async[_0x1d773c(0x18f)](_0x24b2ea){const _0x4ae1a6=_0x1d773c;try{const _0x533228=await this['getCozeApi'](guid_typescript_1[_0x4ae1a6(0x112)][_0x4ae1a6(0xfc)]()),_0x32850f=await(0x0,axios_1[_0x4ae1a6(0xc9)])({'url':_0x24b2ea,'method':'GET','responseType':_0x4ae1a6(0x169),'headers':{'Accept-Encoding':_0x4ae1a6(0x16a)}}),_0x23e044=_0x32850f[_0x4ae1a6(0x190)],_0x5e6753=await _0x533228[_0x4ae1a6(0x159)][_0x4ae1a6(0x189)]({'file':_0x23e044});return _0x5e6753;}catch(_0x2b9dc9){console['log']('-----------------------------------uploadForUrlERROR----------',_0x2b9dc9);}return null;}async[_0x1d773c(0x19f)](_0x43e850,_0x4bb1ae){const _0x33d031=_0x1d773c;try{const _0x28e36a=await this[_0x33d031(0x18f)](_0x43e850[_0x33d031(0x164)]);_0x43e850['fileId']=_0x28e36a['id'];const _0x46e2dc=await this[_0x33d031(0x1ac)](_0x4bb1ae[_0x33d031(0x1b1)]['id']),_0x4c8046=await _0x46e2dc['datasets'][_0x33d031(0xfc)]({'name':_0x43e850[_0x33d031(0x102)],'description':_0x43e850[_0x33d031(0x16f)],'file_id':_0x43e850[_0x33d031(0x120)],'space_id':this[_0x33d031(0xea)],'format_type':_0x43e850[_0x33d031(0x1e8)]});_0x43e850[_0x33d031(0x198)]=this['SPACE_ID'],_0x43e850[_0x33d031(0x1b3)]=_0x4c8046[_0x33d031(0xc2)],_0x43e850[_0x33d031(0x1ce)]=_0x4bb1ae[_0x33d031(0x1b1)]['id'],await this[_0x33d031(0x12e)][_0x33d031(0x180)](_0x43e850);}catch(_0x47fda6){return console[_0x33d031(0x126)](_0x33d031(0x10f),_0x47fda6),_0x47fda6;}}async['updateKnowledge'](_0x17f018,_0xc91721){const _0x57428c=_0x1d773c,_0x1f625c=await this[_0x57428c(0x12e)]['findOne']({'where':{'knowledgeId':_0x17f018[_0x57428c(0x1b3)]}});if(!_0x1f625c||_0x1f625c[_0x57428c(0x1ce)]!=_0xc91721[_0x57428c(0x1b1)]['id'])throw new Error(_0x57428c(0x140));if(_0x1f625c[_0x57428c(0x164)]!=_0x17f018['fileUrl']){const _0x105aed=await this[_0x57428c(0x18f)](_0x17f018['fileUrl']);_0x17f018['fileId']=_0x105aed['id'];}const _0x55ad42=await this[_0x57428c(0x1ac)](_0xc91721['user']['id']);await _0x55ad42[_0x57428c(0xb7)][_0x57428c(0x1ab)](_0x1f625c[_0x57428c(0x1b3)],{'name':_0x17f018[_0x57428c(0x102)],'description':_0x17f018[_0x57428c(0x16f)],'file_id':_0x17f018[_0x57428c(0x120)]}),await this['knowledgeEntity'][_0x57428c(0x180)](_0x17f018);}async[_0x1d773c(0x103)](_0x50dd21,_0x43a119){const _0x2f5ecc=_0x1d773c,_0x276011=await this[_0x2f5ecc(0x12e)]['findOne']({'where':{'knowledgeId':_0x50dd21}});if(!_0x276011||_0x276011[_0x2f5ecc(0x1ce)]!=_0x43a119['user']['id'])throw new Error('知识库不存在！');const _0xc976d6=await this['getCozeApi'](_0x43a119[_0x2f5ecc(0x1b1)]['id']),_0x206282=await _0xc976d6[_0x2f5ecc(0xb7)][_0x2f5ecc(0x106)](_0x276011[_0x2f5ecc(0x1b3)]);await this[_0x2f5ecc(0x12e)][_0x2f5ecc(0x106)](_0x276011['id']);}async[_0x1d773c(0x1ae)](_0x2014b8,_0x49d11e){const _0x5062ea=_0x1d773c,_0x1dd9d4={'userId':_0x49d11e[_0x5062ea(0x1b1)]['id']};_0x2014b8['search']&&(_0x1dd9d4['name']=(0x0,typeorm_2[_0x5062ea(0x1ba)])('%'+_0x2014b8[_0x5062ea(0x10b)]+'%'));const [_0x3da835,_0x549386]=await this[_0x5062ea(0x12e)][_0x5062ea(0x13f)]({'where':_0x1dd9d4,'order':{'id':_0x5062ea(0x1b9)},'skip':(_0x2014b8['page']-0x1)*_0x2014b8['size'],'take':_0x2014b8[_0x5062ea(0xd8)]});return{'rows':_0x3da835,'count':_0x549386};}async['getKnowledegeDocument'](_0x100313,_0x51e3ce){const _0x563a20=_0x1d773c;return await this[_0x563a20(0x1df)][_0x563a20(0xe2)]({'where':{'documentId':_0x100313,'userId':_0x51e3ce[_0x563a20(0x1b1)]['id']}});}async[_0x1d773c(0x134)](_0x54cdec,_0x2e6042){const _0x407116=_0x1d773c,_0xd48886={'userId':_0x2e6042['user']['id'],'knowledgeId':_0x54cdec[_0x407116(0x1b3)]};_0x54cdec[_0x407116(0x10b)]&&(_0xd48886[_0x407116(0x102)]=(0x0,typeorm_2[_0x407116(0x1ba)])('%'+_0x54cdec[_0x407116(0x10b)]+'%'));const [_0x4ea864,_0x2796b6]=await this[_0x407116(0x1df)][_0x407116(0x13f)]({'where':_0xd48886,'order':{'id':_0x407116(0x1b9)},'skip':(_0x54cdec[_0x407116(0x161)]-0x1)*_0x54cdec[_0x407116(0xd8)],'take':_0x54cdec[_0x407116(0xd8)]});return{'rows':_0x4ea864,'count':_0x2796b6};}async[_0x1d773c(0x184)](_0x1eef9c,_0x2dcc0a){const _0x115cc6=_0x1d773c;try{const _0x55c55c=await this['getCozeApi'](_0x2dcc0a[_0x115cc6(0x1b1)]['id']),_0x3264f0=await _0x55c55c[_0x115cc6(0xb7)][_0x115cc6(0x14b)]['create']({'dataset_id':_0x1eef9c[_0x115cc6(0x1b3)],'document_bases':_0x1eef9c[_0x115cc6(0xbf)],'chunk_strategy':_0x1eef9c['chunkStrategy'],'format_type':_0x1eef9c[_0x115cc6(0x1e8)]});let _0x414424=[];for(const _0x475095 of _0x3264f0){_0x414424[_0x115cc6(0x172)](await this[_0x115cc6(0x1df)][_0x115cc6(0x180)]({'userId':_0x2dcc0a['user']['id'],'spaceId':this['SPACE_ID'],'knowledgeId':_0x1eef9c[_0x115cc6(0x1b3)],'name':_0x475095[_0x115cc6(0x102)],'documentId':_0x475095[_0x115cc6(0x181)],'charCount':_0x475095[_0x115cc6(0x130)],'chunkStrategy':_0x475095[_0x115cc6(0x174)],'formatType':_0x475095[_0x115cc6(0x1b5)],'hitCount':_0x475095[_0x115cc6(0x143)],'size':_0x475095[_0x115cc6(0xd8)],'sliceCount':_0x475095[_0x115cc6(0x105)],'status':_0x475095[_0x115cc6(0xc0)],'type':_0x475095[_0x115cc6(0x10a)]}));}return console[_0x115cc6(0x126)](_0x115cc6(0xdc),_0x3264f0),_0x414424;}catch(_0xc2b1f7){return console[_0x115cc6(0x126)](_0x115cc6(0x15e),_0xc2b1f7),_0xc2b1f7;}}async['updateKnowledgeDocument'](_0x2054d8,_0x316a67){const _0x232708=_0x1d773c;try{const _0x52cc84=await this[_0x232708(0x1df)][_0x232708(0xe2)]({'where':{'documentId':_0x2054d8['document_id']}});if(!_0x52cc84||_0x52cc84[_0x232708(0x1ce)]!=_0x316a67[_0x232708(0x1b1)]['id'])throw new Error(_0x232708(0xd5));_0x52cc84[_0x232708(0x16e)]=_0x2054d8[_0x232708(0x149)],_0x52cc84[_0x232708(0x102)]=_0x2054d8['document_name'],await this[_0x232708(0x1df)]['save'](_0x52cc84);const _0x505599=await this[_0x232708(0x1ac)](_0x316a67[_0x232708(0x1b1)]['id']),_0x30b7ba=await _0x505599['datasets'][_0x232708(0x14b)]['update'](_0x2054d8);return _0x30b7ba;}catch(_0x923105){return _0x923105;}}async['deleteKnowledgeDocument'](_0x34f443,_0x4077fd){const _0x563145=_0x1d773c,_0x3c666f=await this[_0x563145(0x1df)][_0x563145(0xe2)]({'where':{'documentId':_0x34f443}});if(!_0x3c666f||_0x3c666f[_0x563145(0x1ce)]!=_0x4077fd[_0x563145(0x1b1)]['id'])throw new Error(_0x563145(0xd5));await this[_0x563145(0x1df)][_0x563145(0x106)]({'documentId':_0x34f443,'userId':_0x4077fd['user']['id']});const _0xd08d9e=await this['getCozeApi'](_0x4077fd[_0x563145(0x1b1)]['id']),_0x261426=await _0xd08d9e[_0x563145(0xb7)][_0x563145(0x14b)][_0x563145(0x106)]({'document_ids':[_0x3c666f[_0x563145(0x18d)]]});console[_0x563145(0x126)](_0x563145(0x114),_0x261426);}async[_0x1d773c(0x1be)](_0xd30dd3,_0xf7b7e1,_0x4c716c){const _0x2b51c7=_0x1d773c,_0x168f12=await this[_0x2b51c7(0x1ac)](_0x4c716c[_0x2b51c7(0x1b1)]['id']),_0x320f09=await _0x168f12['datasets'][_0x2b51c7(0x1a3)](_0xd30dd3,_0xf7b7e1);console[_0x2b51c7(0x126)](_0x2b51c7(0x16c),_0x320f09);}async['getModelList'](){const _0x39c4fd=_0x1d773c;return await this[_0x39c4fd(0xfa)]['find']({'where':{'isRelease':0x1},'order':{'sortIndex':'DESC','id':_0x39c4fd(0x1b9)}});}async['getRemoteFileStream'](_0x55466b){return new Promise((_0x40c0e7,_0x5eb74d)=>{const _0x438bcd=_0x1a88;https_1[_0x438bcd(0xc9)][_0x438bcd(0x17d)](_0x55466b,_0x33cc84=>{const _0x2c57a0=_0x438bcd;if(_0x33cc84[_0x2c57a0(0xe7)]!==0xc8){_0x5eb74d(new Error(_0x2c57a0(0xdb)+_0x33cc84[_0x2c57a0(0xe7)]));return;}_0x40c0e7(_0x33cc84);})['on'](_0x438bcd(0xe0),_0x21aa72=>{_0x5eb74d(_0x21aa72);});});}async[_0x1d773c(0xbe)](_0x1ecc0c,_0x11e029){const _0x50d80e=_0x1d773c,_0x3c5d9a={'userId':_0x11e029[_0x50d80e(0x1b1)]['id'],'botId':_0x1ecc0c[_0x50d80e(0x11e)]},[_0x5c6a88,_0x4f6238]=await this[_0x50d80e(0x1e4)]['findAndCount']({'where':_0x3c5d9a,'order':{'isTop':_0x50d80e(0x1a8),'id':_0x50d80e(0x1b9)},'skip':(_0x1ecc0c[_0x50d80e(0x161)]-0x1)*_0x1ecc0c[_0x50d80e(0xd8)],'take':_0x1ecc0c[_0x50d80e(0xd8)]});return{'rows':_0x5c6a88,'count':_0x4f6238};}async[_0x1d773c(0xe3)](_0xa44cc0,_0x157d5d){const _0x358b3b=_0x1d773c;try{const _0x53a268=await this['botEntity'][_0x358b3b(0xe2)]({'where':{'botId':_0xa44cc0[_0x358b3b(0x11e)]}});_0xa44cc0[_0x358b3b(0x1ce)]=_0x157d5d[_0x358b3b(0x1b1)]['id'];if(!_0x53a268[_0x358b3b(0x1a6)]||_0x53a268[_0x358b3b(0x1a6)]==_0x358b3b(0x147)){const _0x293e7c=await this[_0x358b3b(0x1ac)](_0x157d5d[_0x358b3b(0x1b1)]['id']),_0x1117e5=await _0x293e7c['conversations']['create']({'bot_id':_0xa44cc0[_0x358b3b(0x11e)]});_0xa44cc0[_0x358b3b(0xf4)]=_0x1117e5['id'];}else _0xa44cc0[_0x358b3b(0xf4)]=(0x0,uuid_1['v4'])()[_0x358b3b(0xbd)](/-/g,'');return _0x53a268['useCount']=_0x53a268[_0x358b3b(0x145)]?_0x53a268[_0x358b3b(0x145)]+0x1:0x1,await this[_0x358b3b(0x118)][_0x358b3b(0x180)](_0x53a268),await this[_0x358b3b(0x1e4)][_0x358b3b(0x180)](_0xa44cc0);}catch(_0xb58430){return _0xb58430;}}async[_0x1d773c(0x1a0)](_0x538eda,_0x1db479){const _0xd2679e=_0x1d773c;return await this[_0xd2679e(0x1e4)]['delete']({'conversationId':_0x538eda,'userId':_0x1db479['user']['id']}),!![];}async[_0x1d773c(0x167)](_0x3d541c,_0xaadeef,_0x3d75db){const _0x1e4418=_0x1d773c,_0x2ef64a=await this[_0x1e4418(0x1e4)][_0x1e4418(0xe2)]({'where':{'conversationId':_0x3d541c,'userId':_0x3d75db['user']['id']}});if(!_0x2ef64a)throw new Error(_0x1e4418(0x1e2));_0x2ef64a[_0x1e4418(0x102)]=_0xaadeef,await this['cozeConversationEntity']['save'](_0x2ef64a);}async[_0x1d773c(0x1c0)](_0x34fb78,_0xd0fb26,_0x584279){const _0x3f59db=_0x1d773c;try{const _0x3e8fc2=await this[_0x3f59db(0x1e4)][_0x3f59db(0xe2)]({'where':{'conversationId':_0x34fb78,'userId':_0x584279['user']['id']}});if(!_0x3e8fc2)throw new Error(_0x3f59db(0x1e2));_0x3e8fc2[_0x3f59db(0x17c)]=_0xd0fb26==0x1?0x1:0x0,await this['cozeConversationEntity'][_0x3f59db(0x180)](_0x3e8fc2);}catch(_0x132138){return _0x132138[_0x3f59db(0x12d)];}}async[_0x1d773c(0xf9)](_0x286237,_0x56e6f6){const _0x345bdc=_0x1d773c,_0x3ada49={'userId':_0x56e6f6[_0x345bdc(0x1b1)]['id'],'conversationId':_0x286237[_0x345bdc(0xf4)]},[_0x1ba53d,_0x411a07]=await this[_0x345bdc(0xd3)][_0x345bdc(0x13f)]({'where':_0x3ada49,'order':{'id':_0x345bdc(0x1b9)},'skip':(_0x286237['page']-0x1)*_0x286237[_0x345bdc(0xd8)],'take':_0x286237[_0x345bdc(0xd8)]});return{'rows':_0x1ba53d,'count':_0x411a07};}async[_0x1d773c(0xed)](_0x4f5fee,_0x1c783e){const _0x17c8d5=_0x1d773c,_0xd55d98=await this['getCozeApi'](_0x1c783e[_0x17c8d5(0x1b1)]['id']),_0x826e3f=await _0xd55d98[_0x17c8d5(0x1ef)][_0x17c8d5(0x16b)]['create'](_0x4f5fee[_0x17c8d5(0xf4)],{'role':_0x4f5fee[_0x17c8d5(0xd0)],'content':_0x4f5fee['content'],'content_type':_0x4f5fee[_0x17c8d5(0x1a1)],'meta_data':{}});_0x4f5fee[_0x17c8d5(0x131)]=_0x826e3f['id'],this[_0x17c8d5(0xd3)][_0x17c8d5(0x180)](_0x4f5fee);}[_0x1d773c(0x12a)](_0x53363f,_0x1f58d9){const _0x49ab4c=_0x1d773c;_0x53363f[_0x49ab4c(0x1e9)](_0x49ab4c(0x10e)+JSON[_0x49ab4c(0x110)](_0x1f58d9)+'\x0a\x0a');}async['validateBeforeChat'](_0x517b3d){const _0x931183=_0x1d773c,{user:_0x4308da,prompt:_0x15e3b4,bot:_0x1e3402,userType:_0x29d741}=_0x517b3d;await this['userService'][_0x931183(0x1aa)](_0x4308da),await this['badwordsService'][_0x931183(0x177)](_0x15e3b4,_0x4308da['id']),await this['userService'][_0x931183(0xca)](_0x4308da['id'],_0x1e3402['id'],_0x1e3402[_0x931183(0x183)],_0x1e3402[_0x931183(0x19d)]),await this[_0x931183(0x18e)][_0x931183(0x1da)](_0x4308da['id'],_0x29d741);}async[_0x1d773c(0x1e7)](_0x33e1fa,_0x37da6f){const _0x5532c9=_0x1d773c,_0x45c073=await this[_0x5532c9(0x1e4)]['findOne']({'where':{'userId':_0x37da6f[_0x5532c9(0x1b1)]['id'],'conversationId':_0x33e1fa[_0x5532c9(0xf4)]}});if(!_0x45c073)throw new common_1[(_0x5532c9(0x18b))](_0x5532c9(0x1e0),common_1['HttpStatus'][_0x5532c9(0x132)]);const _0x5cd1d6=await this[_0x5532c9(0x18e)][_0x5532c9(0xb1)](_0x37da6f[_0x5532c9(0x1b1)]['id']),_0x4c3dfa=await this[_0x5532c9(0x118)][_0x5532c9(0xe2)]({'where':{'botId':_0x45c073[_0x5532c9(0x11e)]}});return await this[_0x5532c9(0xd4)]({'prompt':_0x33e1fa[_0x5532c9(0x141)][_0x5532c9(0xce)](),'user':_0x5cd1d6,'bot':_0x4c3dfa,'userType':_0x4c3dfa[_0x5532c9(0x1de)]}),!![];}async['startChat'](_0x189e53,_0x30a309,_0x23b976){const _0x442fb1=_0x1d773c;_0x23b976[_0x442fb1(0x1cc)](_0x442fb1(0x196),_0x442fb1(0x128)),_0x23b976[_0x442fb1(0x1cc)](_0x442fb1(0xfb),_0x442fb1(0xc1)),_0x23b976[_0x442fb1(0x1cc)]('Cache-Control',_0x442fb1(0xf8)),_0x23b976[_0x442fb1(0x1cc)](_0x442fb1(0x135),'no'),_0x23b976[_0x442fb1(0x1cc)](_0x442fb1(0x176),'*');try{const _0xc37a61=await this[_0x442fb1(0x1e4)][_0x442fb1(0xe2)]({'where':{'userId':_0x30a309[_0x442fb1(0x1b1)]['id'],'conversationId':_0x189e53[_0x442fb1(0xf4)]}});if(!_0xc37a61){this['responseMessage'](_0x23b976,{'content':'会话不存在','contentType':'','isEnd':![],'isError':!![]});return;}const _0x25feb2=await this[_0x442fb1(0x118)][_0x442fb1(0xe2)]({'where':{'botId':_0xc37a61[_0x442fb1(0x11e)]}});if(_0x25feb2[_0x442fb1(0x1a6)]=='fast'){await this['startFastChat'](_0x189e53,_0x30a309,_0x23b976);return;}if(_0x25feb2[_0x442fb1(0x1a6)]==_0x442fb1(0x1c1)){await this[_0x442fb1(0x139)](_0x189e53,_0x30a309,_0x23b976);return;}const _0xc750fd=await this['userService'][_0x442fb1(0xb1)](_0x30a309[_0x442fb1(0x1b1)]['id']),_0x4acdb4=await this[_0x442fb1(0x1ac)](_0x30a309['user']['id']),_0x1f5b9d=await _0x4acdb4[_0x442fb1(0x171)][_0x442fb1(0x157)]({'bot_id':_0xc37a61['botId']});_0x25feb2[_0x442fb1(0x17e)]=_0x1f5b9d[_0x442fb1(0x115)],_0x25feb2['workflowIdList']=_0x1f5b9d[_0x442fb1(0x100)],_0x25feb2[_0x442fb1(0xff)]=_0x1f5b9d['onboarding_info'],await this[_0x442fb1(0x118)][_0x442fb1(0x180)](_0x25feb2);const _0x421657=await this[_0x442fb1(0xfa)]['findOne']({'where':{'modelId':_0x1f5b9d[_0x442fb1(0x115)]['model_id']}});if(!_0x421657){this[_0x442fb1(0x12a)](_0x23b976,{'content':_0x442fb1(0xcd),'contentType':'','isEnd':![],'isError':!![]});return;}await this[_0x442fb1(0xd4)]({'prompt':_0x189e53['content']['toString'](),'user':_0xc750fd,'bot':_0x25feb2,'userType':_0x25feb2['userType']});const _0x48234e=await this[_0x442fb1(0xd3)][_0x442fb1(0x1d6)]({'where':{'conversationId':_0x189e53[_0x442fb1(0xf4)]},'take':0x63,'order':{'id':_0x442fb1(0xcb)}});let _0x1e0ae3=[];_0x48234e[_0x442fb1(0x104)](_0x44c418=>{const _0x16d324=_0x442fb1;let _0x3ac55c=_0x44c418[_0x16d324(0x141)];_0x44c418[_0x16d324(0x1a1)]==_0x16d324(0x137)&&(_0x3ac55c=JSON[_0x16d324(0x110)](_0x44c418['contentObject'])),_0x1e0ae3[_0x16d324(0x172)]({'role':_0x44c418[_0x16d324(0xd0)],'content':_0x3ac55c,'content_type':_0x44c418[_0x16d324(0x1a1)],'type':_0x44c418[_0x16d324(0x10a)]});});typeof _0x189e53[_0x442fb1(0x141)]===_0x442fb1(0x182)?_0x1e0ae3[_0x442fb1(0x172)]({'content':_0x189e53[_0x442fb1(0x141)],'content_type':'text','role':_0x442fb1(0x1b1),'type':'question'}):_0x1e0ae3[_0x442fb1(0x172)]({'content':JSON[_0x442fb1(0x110)](_0x189e53[_0x442fb1(0x141)]),'content_type':_0x442fb1(0x137),'role':_0x442fb1(0x1b1),'type':_0x442fb1(0xbb)});const _0x1562e8=await _0x4acdb4[_0x442fb1(0x173)][_0x442fb1(0x169)]({'bot_id':_0xc37a61['botId'],'user_id':_0x30a309[_0x442fb1(0x1b1)]['id'][_0x442fb1(0xce)](),'auto_save_history':!![],'additional_messages':_0x1e0ae3});let _0x14807c,_0x4d2ab2='',_0x3ae365='',_0x1928d7='',_0x4d6dd5,_0x27fedf=[];const _0x78902=setInterval(()=>{const _0x5332af=_0x442fb1;this[_0x5332af(0x12a)](_0x23b976,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);for await(const _0x1fd558 of _0x1562e8){if(_0x1fd558['event']===api_1[_0x442fb1(0x15a)]['CONVERSATION_CHAT_CREATED'])_0x3ae365=_0x442fb1(0x1bc),_0x14807c=_0x1fd558,_0x1928d7=_0x1fd558[_0x442fb1(0x190)]['id'];else{if(_0x1fd558[_0x442fb1(0x195)]===api_1[_0x442fb1(0x15a)][_0x442fb1(0x1c9)])_0x4d2ab2+=_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x141)],this[_0x442fb1(0x12a)](_0x23b976,{'content':_0x1fd558[_0x442fb1(0x190)]['content'],'contentType':_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x1b2)],'isEnd':![],'isError':![]}),_0x3ae365=_0x442fb1(0x111);else{if(_0x1fd558['event']===api_1[_0x442fb1(0x15a)][_0x442fb1(0x1bb)])_0x3ae365='delta',_0x4d6dd5=_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x124)],_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x10a)]==_0x442fb1(0x1c6)&&_0x1fd558[_0x442fb1(0x190)]['content']&&(_0x27fedf['push']({'type':_0x1fd558['data'][_0x442fb1(0x10a)],'content':JSON[_0x442fb1(0x151)](_0x1fd558[_0x442fb1(0x190)]['content'])}),this['responseMessage'](_0x23b976,{'content':_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x141)],'type':_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x10a)],'contentType':_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x1b2)],'isEnd':![],'isError':![],'usage':_0x1fd558[_0x442fb1(0x190)][_0x442fb1(0x124)]}));else{if(_0x1fd558[_0x442fb1(0x195)]===api_1[_0x442fb1(0x15a)][_0x442fb1(0xb9)])_0x3ae365=_0x442fb1(0x1c8),_0x4d6dd5=_0x1fd558['data']['usage'],this[_0x442fb1(0x12a)](_0x23b976,{'content':'','isEnd':!![],'isError':![],'usage':_0x1fd558['data'][_0x442fb1(0x124)]});else{if(_0x1fd558[_0x442fb1(0x195)]===api_1[_0x442fb1(0x15a)]['DONE'])_0x3ae365='end',this['responseMessage'](_0x23b976,{'content':'','contentType':'','isEnd':!![],'isError':![]});else _0x1fd558[_0x442fb1(0x195)]===api_1[_0x442fb1(0x15a)][_0x442fb1(0x1ad)]&&(_0x3ae365=_0x442fb1(0xe0),console[_0x442fb1(0x126)](_0x442fb1(0x1cf),_0x1fd558),this[_0x442fb1(0x12a)](_0x23b976,{'content':'','contentType':'','isEnd':![],'isError':!![],'errorData':_0x1fd558}));}}}}}const _0x522680=await this['cozeMessageEntity']['save']({'botId':_0xc37a61[_0x442fb1(0x11e)],'userId':_0x30a309['user']['id'],'spaceId':this[_0x442fb1(0xea)],'messageId':_0x1928d7,'type':'question','contentType':typeof _0x189e53[_0x442fb1(0x141)]===_0x442fb1(0x182)?'text':_0x442fb1(0x137),'conversationId':_0xc37a61[_0x442fb1(0xf4)],'content':typeof _0x189e53[_0x442fb1(0x141)]===_0x442fb1(0x182)?_0x189e53[_0x442fb1(0x141)]:'','contentObject':typeof _0x189e53[_0x442fb1(0x141)]!==_0x442fb1(0x182)?_0x189e53[_0x442fb1(0x141)]:[],'role':'user','parentId':0x0});await this[_0x442fb1(0xd3)][_0x442fb1(0x180)]({'botId':_0xc37a61[_0x442fb1(0x11e)],'userId':_0x30a309[_0x442fb1(0x1b1)]['id'],'spaceId':this[_0x442fb1(0xea)],'messageId':_0x1928d7,'conversationId':_0xc37a61[_0x442fb1(0xf4)],'type':'answer','content':_0x4d2ab2,'content_type':'text','role':_0x442fb1(0xd9),'usage':_0x4d6dd5,'status':_0x3ae365,'parentId':_0x522680['id'],'contentObject':_0x27fedf}),clearInterval(_0x78902),await this['userService']['deductBalance4Coze'](_0x30a309[_0x442fb1(0x1b1)]['id'],_0x25feb2['id'],_0x25feb2['name'],_0x25feb2[_0x442fb1(0x183)],_0x25feb2[_0x442fb1(0x19d)],_0x1928d7);}catch(_0x376fd1){return console[_0x442fb1(0xe0)](_0x442fb1(0x1c3),_0x376fd1),_0x376fd1;}}async['startFastChat'](_0x41ce0c,_0x687cae,_0x4d59d0){const _0x6a8727=_0x1d773c;try{const _0x970ec0=await this[_0x6a8727(0x1e4)]['findOne']({'where':{'userId':_0x687cae['user']['id'],'conversationId':_0x41ce0c[_0x6a8727(0xf4)]}});if(!_0x970ec0){this[_0x6a8727(0x12a)](_0x4d59d0,{'content':_0x6a8727(0x1e0),'contentType':'','isEnd':![],'isError':!![]});return;}const _0x5b16d4=await this[_0x6a8727(0x18e)]['getUserById'](_0x687cae[_0x6a8727(0x1b1)]['id']),_0x3dadb=await this[_0x6a8727(0x118)][_0x6a8727(0xe2)]({'where':{'botId':_0x970ec0[_0x6a8727(0x11e)]}});await this[_0x6a8727(0xd4)]({'prompt':_0x41ce0c[_0x6a8727(0x141)][_0x6a8727(0xce)](),'user':_0x5b16d4,'bot':_0x3dadb,'userType':_0x3dadb[_0x6a8727(0x1de)]});const _0x50867e=await this[_0x6a8727(0xd3)][_0x6a8727(0x1d6)]({'where':{'conversationId':_0x41ce0c[_0x6a8727(0xf4)]},'take':0x63,'order':{'id':_0x6a8727(0xcb)}});let _0x50861d=[];_0x50867e[_0x6a8727(0x104)](_0x99a9a5=>{const _0x15cd89=_0x6a8727;let _0x1c41bf=_0x99a9a5[_0x15cd89(0x141)];_0x99a9a5[_0x15cd89(0x1a1)]==_0x15cd89(0x137)&&(_0x1c41bf=JSON['stringify'](_0x99a9a5['contentObject'])),_0x50861d[_0x15cd89(0x172)]({'role':_0x99a9a5['role'],'content':_0x1c41bf,'content_type':_0x99a9a5[_0x15cd89(0x1a1)],'type':_0x99a9a5[_0x15cd89(0x10a)]});});typeof _0x41ce0c[_0x6a8727(0x141)]===_0x6a8727(0x182)?_0x50861d[_0x6a8727(0x172)]({'content':_0x41ce0c[_0x6a8727(0x141)],'content_type':_0x6a8727(0x15c),'role':_0x6a8727(0x1b1),'type':_0x6a8727(0xbb)}):_0x50861d[_0x6a8727(0x172)]({'content':JSON[_0x6a8727(0x110)](_0x41ce0c['content']),'content_type':_0x6a8727(0x137),'role':_0x6a8727(0x1b1),'type':_0x6a8727(0xbb)});let _0x1a0f59=null,_0x383552='',_0x16b866=!![],_0x486f8f='';const _0x3cf08c=await this[_0x6a8727(0x153)][_0x6a8727(0x185)](_0x6a8727(0x1f1)),_0x4818e6=_0x3cf08c['api'][_0x6a8727(0x1cd)],_0x40b1db=setInterval(()=>{const _0x49c5b0=_0x6a8727;this[_0x49c5b0(0x12a)](_0x4d59d0,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);let _0x5a39ff=await(0x0,zhipu_1[_0x6a8727(0x1b8)])([{'role':_0x6a8727(0x1b1),'content':_0x41ce0c[_0x6a8727(0x141)]}],{'key':_0x3dadb[_0x6a8727(0x1ca)],'chatId':_0x970ec0[_0x6a8727(0xf4)],'model':_0x3dadb[_0x6a8727(0xc3)],'apiUrl':_0x4818e6,'onProgress':_0x3bc704=>{const _0x3c9a60=_0x6a8727;let _0x6e32c0=this[_0x3c9a60(0x155)](_0x4d59d0,_0x3bc704,![]);_0x383552+=_0x6e32c0,_0x16b866=![],_0x1a0f59=_0x3bc704,_0x486f8f=_0x3bc704['id'];}});this[_0x6a8727(0x155)](_0x4d59d0,null,!![]);const _0x403e74={'model':_0x3dadb['model']},_0x34d840=(0x0,helper_1[_0x6a8727(0x1e1)])(0x1,_0x5a39ff,_0x403e74),_0x18e323=await this[_0x6a8727(0xd3)][_0x6a8727(0x180)]({'botId':_0x970ec0[_0x6a8727(0x11e)],'userId':_0x687cae[_0x6a8727(0x1b1)]['id'],'spaceId':this['SPACE_ID'],'messageId':_0x486f8f,'type':'question','contentType':typeof _0x41ce0c[_0x6a8727(0x141)]===_0x6a8727(0x182)?_0x6a8727(0x15c):_0x6a8727(0x137),'conversationId':_0x970ec0[_0x6a8727(0xf4)],'content':typeof _0x41ce0c[_0x6a8727(0x141)]==='string'?_0x41ce0c[_0x6a8727(0x141)]:'','contentObject':typeof _0x41ce0c[_0x6a8727(0x141)]!==_0x6a8727(0x182)?_0x41ce0c[_0x6a8727(0x141)]:[],'role':_0x6a8727(0x1b1),'parentId':0x0});await this[_0x6a8727(0xd3)][_0x6a8727(0x180)]({'botId':_0x970ec0['botId'],'userId':_0x687cae[_0x6a8727(0x1b1)]['id'],'spaceId':this['SPACE_ID'],'messageId':_0x486f8f,'conversationId':_0x970ec0[_0x6a8727(0xf4)],'type':'answer','content':_0x34d840[_0x6a8727(0x15c)],'content_type':_0x6a8727(0x15c),'role':_0x6a8727(0xd9),'usage':_0x34d840[_0x6a8727(0x124)],'status':_0x6a8727(0x13e),'parentId':_0x18e323['id']}),clearInterval(_0x40b1db),await this['userService'][_0x6a8727(0x186)](_0x687cae[_0x6a8727(0x1b1)]['id'],_0x3dadb['id'],_0x3dadb[_0x6a8727(0x102)],_0x3dadb['vipFreeNum'],_0x3dadb['deduct'],_0x486f8f,balance_constant_1[_0x6a8727(0xe4)][_0x6a8727(0x1e6)]);}catch(_0x5c34f9){return console[_0x6a8727(0xe0)](_0x6a8727(0x1d2),_0x5c34f9),_0x5c34f9;}}async[_0x1d773c(0x139)](_0x845953,_0x399076,_0x3849a8){const _0x493525=_0x1d773c;try{const _0x3a69f5=await this[_0x493525(0x1e4)]['findOne']({'where':{'userId':_0x399076[_0x493525(0x1b1)]['id'],'conversationId':_0x845953[_0x493525(0xf4)]}});if(!_0x3a69f5){this['responseMessage'](_0x3849a8,{'content':'会话不存在','contentType':'','isEnd':![],'isError':!![]});return;}const _0x1e014a=await this[_0x493525(0x18e)][_0x493525(0xb1)](_0x399076[_0x493525(0x1b1)]['id']),_0x27f284=await this[_0x493525(0x118)][_0x493525(0xe2)]({'where':{'botId':_0x3a69f5[_0x493525(0x11e)]}});await this[_0x493525(0xd4)]({'prompt':_0x845953[_0x493525(0x141)]['toString'](),'user':_0x1e014a,'bot':_0x27f284,'userType':_0x27f284['userType']});const _0x26b613=await this[_0x493525(0xd3)][_0x493525(0x1d6)]({'where':{'conversationId':_0x845953['conversationId']},'take':0x63,'order':{'id':'ASC'}});let _0x3e16b2=[];_0x26b613[_0x493525(0x104)](_0x35d532=>{const _0x565627=_0x493525;let _0xcb4387=_0x35d532[_0x565627(0x141)];_0x35d532[_0x565627(0x1a1)]==_0x565627(0x137)&&(_0xcb4387=JSON[_0x565627(0x110)](_0x35d532['contentObject'])),_0x3e16b2['push']({'role':_0x35d532['role'],'content':_0xcb4387,'content_type':_0x35d532['contentType'],'type':_0x35d532[_0x565627(0x10a)]});});typeof _0x845953['content']===_0x493525(0x182)?_0x3e16b2[_0x493525(0x172)]({'content':_0x845953['content'],'content_type':_0x493525(0x15c),'role':_0x493525(0x1b1),'type':_0x493525(0xbb)}):_0x3e16b2[_0x493525(0x172)]({'content':JSON['stringify'](_0x845953[_0x493525(0x141)]),'content_type':'object_string','role':_0x493525(0x1b1),'type':'question'});let _0x50968d=null,_0x553cb3='',_0x3aafe7=!![],_0x377c04='';const _0x49a810=await this[_0x493525(0x153)][_0x493525(0x185)]('CozeApiConfig'),_0x8c72f0=_0x49a810[_0x493525(0xde)][_0x493525(0xf3)],_0x532919=setInterval(()=>{this['responseMessage'](_0x3849a8,{'content':'','isEnd':![],'isHeart':!![]});},0x3a98);let _0x1f1ed3;try{_0x1f1ed3=await(0x0,zhipu_1[_0x493525(0x187)])({'apiKey':_0x27f284[_0x493525(0x1ca)],'apiUrl':_0x8c72f0,'query':_0x845953['content']['toString'](),'chatId':_0x3a69f5[_0x493525(0x14a)]||'','userId':_0x399076[_0x493525(0x1b1)]['id'][_0x493525(0xce)](),'onProgress':_0x659ad0=>{const _0x5ab87c=_0x493525;let _0x3c08ea=this[_0x5ab87c(0x155)](_0x3849a8,_0x659ad0,![]);_0x553cb3+=_0x3c08ea,_0x3aafe7=![],_0x50968d=_0x659ad0,_0x377c04=_0x659ad0['id'];}});}catch(_0x9ed65e){console[_0x493525(0x126)](_0x493525(0x11a),_0x9ed65e);}!_0x3a69f5[_0x493525(0x14a)]&&(_0x3a69f5[_0x493525(0x14a)]=_0x1f1ed3['id'],this[_0x493525(0x1e4)][_0x493525(0x180)](_0x3a69f5));this[_0x493525(0x155)](_0x3849a8,null,!![]);const _0x312128={'model':_0x493525(0x1e3)},_0x4ab828=(0x0,helper_1[_0x493525(0x1e1)])(0x1,_0x1f1ed3,_0x312128),_0x117339=await this[_0x493525(0xd3)][_0x493525(0x180)]({'botId':_0x3a69f5[_0x493525(0x11e)],'userId':_0x399076[_0x493525(0x1b1)]['id'],'spaceId':this[_0x493525(0xea)],'messageId':_0x377c04,'type':'question','contentType':typeof _0x845953['content']===_0x493525(0x182)?'text':_0x493525(0x137),'conversationId':_0x3a69f5['conversationId'],'content':typeof _0x845953[_0x493525(0x141)]===_0x493525(0x182)?_0x845953[_0x493525(0x141)]:'','contentObject':typeof _0x845953[_0x493525(0x141)]!==_0x493525(0x182)?_0x845953['content']:[],'role':_0x493525(0x1b1),'parentId':0x0});await this[_0x493525(0xd3)]['save']({'botId':_0x3a69f5[_0x493525(0x11e)],'userId':_0x399076['user']['id'],'spaceId':this[_0x493525(0xea)],'messageId':_0x377c04,'conversationId':_0x3a69f5[_0x493525(0xf4)],'type':_0x493525(0xf0),'content':_0x4ab828[_0x493525(0x15c)],'content_type':'text','role':_0x493525(0xd9),'usage':_0x4ab828[_0x493525(0x124)],'status':_0x493525(0x13e),'parentId':_0x117339['id']}),clearInterval(_0x532919),await this[_0x493525(0x18e)][_0x493525(0x186)](_0x399076[_0x493525(0x1b1)]['id'],_0x27f284['id'],_0x27f284[_0x493525(0x102)],_0x27f284[_0x493525(0x183)],_0x27f284[_0x493525(0x19d)],_0x377c04,balance_constant_1[_0x493525(0xe4)][_0x493525(0x142)]);}catch(_0x23b54d){return console[_0x493525(0xe0)](_0x493525(0x1d2),_0x23b54d),_0x23b54d;}}[_0x1d773c(0x155)](_0x5cf8c6,_0x17975b,_0x496b9a){const _0x367635=_0x1d773c;if(_0x496b9a){let _0x767357={};_0x767357['isEnd']=!![],_0x767357[_0x367635(0x141)]='',_0x767357['contentType']='',_0x767357['think']='',_0x5cf8c6[_0x367635(0x1e9)]('data:\x20'+JSON[_0x367635(0x110)](_0x767357)+'\x0a\x0a');return;}let _0x1db0dd='',_0x58842f='';_0x17975b[_0x367635(0x179)][_0x367635(0xeb)][_0x367635(0x19a)]&&_0x17975b[_0x367635(0x179)][_0x367635(0xeb)][_0x367635(0x104)](_0x8ecf96=>{const _0x186229=_0x367635;_0x8ecf96['delta']?.[_0x186229(0x12f)]&&(_0x58842f+=_0x8ecf96[_0x186229(0x111)][_0x186229(0x12f)]),_0x8ecf96[_0x186229(0x111)]?.[_0x186229(0x141)]&&(_0x1db0dd+=_0x8ecf96[_0x186229(0x111)][_0x186229(0x141)]);});let _0x532ad9={};return _0x532ad9['content']=_0x1db0dd,_0x532ad9[_0x367635(0x1a1)]=_0x367635(0x15c),_0x532ad9['id']=_0x17975b['id'],_0x532ad9[_0x367635(0x1a9)]=_0x496b9a,_0x532ad9['think']=_0x58842f,_0x5cf8c6[_0x367635(0x1e9)](_0x367635(0x10e)+JSON[_0x367635(0x110)](_0x532ad9)+'\x0a\x0a'),_0x58842f;}async[_0x1d773c(0x1d7)](_0x2dd54c){const _0x39caac=_0x1d773c,_0x4f84fb={'isRelease':0x1};_0x2dd54c[_0x39caac(0x10b)]&&(_0x4f84fb[_0x39caac(0x102)]=(0x0,typeorm_2['Like'])('%'+_0x2dd54c['search']+'%'));const [_0x18e8b2,_0x52c314]=await this[_0x39caac(0x1a7)]['findAndCount']({'where':_0x4f84fb,'order':{'id':_0x39caac(0x1b9)},'skip':(_0x2dd54c['page']-0x1)*_0x2dd54c[_0x39caac(0xd8)],'take':_0x2dd54c[_0x39caac(0xd8)]});return{'rows':_0x18e8b2,'count':_0x52c314};}async[_0x1d773c(0x18a)](){const _0x2ed776=_0x1d773c,_0x504267=await this[_0x2ed776(0x1ac)]('');let _0x45f20a=0x1;while(!![]){const _0x4b99ad=await this[_0x2ed776(0x12e)][_0x2ed776(0x1d6)]({'where':{'spaceId':this[_0x2ed776(0xea)]}});let _0x39c4dc=await _0x504267['datasets'][_0x2ed776(0x1ed)]({'space_id':this[_0x2ed776(0xea)],'page_num':_0x45f20a,'page_size':0x12c});await new Promise(_0x43f69d=>setTimeout(_0x43f69d,0x3e8));if(!_0x39c4dc['dataset_list']||_0x39c4dc[_0x2ed776(0x146)][_0x2ed776(0x19a)]==0x0)break;_0x39c4dc=_0x39c4dc[_0x2ed776(0x146)]['filter'](_0x529e3f=>_0x4b99ad['map'](_0x1dbf65=>_0x1dbf65[_0x2ed776(0x1b3)])[_0x2ed776(0x175)](_0x529e3f[_0x2ed776(0xc2)]));for(let _0x235846 of _0x39c4dc){await this[_0x2ed776(0x12e)][_0x2ed776(0x1ab)]({'knowledgeId':_0x235846[_0x2ed776(0xc2)]},{'botUsedCount':_0x235846[_0x2ed776(0xb4)],'processingFileList':_0x235846[_0x2ed776(0x170)],'failedFileList':_0x235846[_0x2ed776(0x122)],'formatType':_0x235846[_0x2ed776(0x1b5)],'processingFileIdList':_0x235846[_0x2ed776(0xd2)],'allFileSize':_0x235846['all_file_size'],'hitCount':_0x235846[_0x2ed776(0x143)],'docCount':_0x235846['doc_count'],'fileList':_0x235846[_0x2ed776(0x191)],'chunkStrategy':_0x235846[_0x2ed776(0x174)]});let _0x46a781=0x1;while(!![]){const _0x1e3b83=await _0x504267['datasets']['documents'][_0x2ed776(0x1ed)]({'dataset_id':_0x235846['dataset_id'],'page':_0x46a781,'page_size':0x12c});if(!_0x1e3b83[_0x2ed776(0x14e)]||_0x1e3b83['document_infos']['length']==0x0)break;for(let _0x3859e7 of _0x1e3b83[_0x2ed776(0x14e)]){await this[_0x2ed776(0x1df)]['update']({'documentId':_0x3859e7[_0x2ed776(0x181)]},{'charCount':_0x3859e7['char_count'],'status':_0x3859e7[_0x2ed776(0xc0)],'chunkStrategy':_0x3859e7[_0x2ed776(0x174)],'formatType':_0x3859e7[_0x2ed776(0x1b5)],'hitCount':_0x3859e7[_0x2ed776(0x143)],'size':_0x3859e7['size'],'sliceCount':_0x3859e7[_0x2ed776(0x105)],'sourceType':_0x3859e7[_0x2ed776(0xcc)],'type':_0x3859e7[_0x2ed776(0x10a)],'docTreeTosUrl':_0x3859e7[_0x2ed776(0x1a2)],'previewTosUrl':_0x3859e7[_0x2ed776(0x14d)],'webUrl':_0x3859e7[_0x2ed776(0x192)]});}_0x46a781++;}}_0x45f20a++;}}async['batchKnowledgeProgressResult'](){const _0x286d65=_0x1d773c,_0x2aceda=await this[_0x286d65(0x1ac)](''),_0x42008a=await this[_0x286d65(0x1df)]['find']({'where':{'progress':(0x0,typeorm_2[_0x286d65(0x14f)])(0x64)}});if(_0x42008a[_0x286d65(0x19a)])for(let _0x4d8e8e of _0x42008a){const _0x19b165=await _0x2aceda[_0x286d65(0xb7)][_0x286d65(0x1a3)](_0x4d8e8e['knowledgeId'],{'document_ids':[_0x4d8e8e[_0x286d65(0x18d)]]});if(_0x19b165[_0x286d65(0x190)]['length'])for(let _0xad111a of _0x19b165[_0x286d65(0x190)]){await this[_0x286d65(0x1df)][_0x286d65(0x1ab)]({'documentId':_0xad111a[_0x286d65(0x181)]},{'progress':_0xad111a[_0x286d65(0x17f)],'size':_0xad111a[_0x286d65(0xd8)],'remainingTime':_0xad111a[_0x286d65(0x1bf)],'statusDescript':_0xad111a['status_descript']});}}}async[_0x1d773c(0x17b)](){const _0x2eec3c=_0x1d773c,_0x3eddc0=await this[_0x2eec3c(0x1ac)]('');let _0x53e7cb=0x1;while(!![]){const _0xb4ed3a=await _0x3eddc0[_0x2eec3c(0x171)]['list']({'space_id':this['SPACE_ID'],'page_index':_0x53e7cb});if(!_0xb4ed3a[_0x2eec3c(0xe9)][_0x2eec3c(0x19a)])break;for(let _0x41bae6=0x0;_0x41bae6<_0xb4ed3a['space_bots'][_0x2eec3c(0x19a)];_0x41bae6++){console[_0x2eec3c(0x126)](_0x2eec3c(0xda),_0xb4ed3a[_0x2eec3c(0xe9)][_0x41bae6][_0x2eec3c(0x107)]);const _0x19fae8=await this[_0x2eec3c(0x118)][_0x2eec3c(0xe2)]({'where':{'botId':_0xb4ed3a['space_bots'][_0x41bae6][_0x2eec3c(0x107)]}});if(!_0x19fae8){const _0x344a5d=await this[_0x2eec3c(0xf1)](_0xb4ed3a[_0x2eec3c(0xe9)][_0x41bae6]['icon_url']);console[_0x2eec3c(0x126)](_0x2eec3c(0x1d1),_0x344a5d),await this['botEntity'][_0x2eec3c(0x180)]({'spaceId':this['SPACE_ID'],'botId':_0xb4ed3a[_0x2eec3c(0xe9)][_0x41bae6]['bot_id'],'name':_0xb4ed3a[_0x2eec3c(0xe9)][_0x41bae6][_0x2eec3c(0x11f)],'description':_0xb4ed3a[_0x2eec3c(0xe9)][_0x41bae6]['description'],'iconFileUrl':_0x344a5d,'isRelease':0x1,'publish_flag':0x0});}}_0x53e7cb++,console['log'](_0x2eec3c(0x119)+_0xb4ed3a[_0x2eec3c(0x10d)]+_0x2eec3c(0x127)+_0x53e7cb+'】页-----------',_0x53e7cb);}var _0x516496=await this['botEntity']['find']({'where':{'userId':0x0,'botType':(0x0,typeorm_2['Not'])((0x0,typeorm_2['In'])(['dify',_0x2eec3c(0x121)]))}});for(let _0x322b2d=0x0;_0x322b2d<_0x516496[_0x2eec3c(0x19a)];_0x322b2d++){const _0x1bfb7c=await _0x3eddc0[_0x2eec3c(0x171)][_0x2eec3c(0x157)]({'bot_id':_0x516496[_0x322b2d]['botId']});_0x1bfb7c&&(_0x516496[_0x322b2d][_0x2eec3c(0xff)]=_0x1bfb7c[_0x2eec3c(0x113)],_0x516496[_0x322b2d][_0x2eec3c(0x11b)]=_0x1bfb7c[_0x2eec3c(0x15d)],_0x516496[_0x322b2d][_0x2eec3c(0x17e)]=_0x1bfb7c['model_info'],_0x516496[_0x322b2d][_0x2eec3c(0xdf)]=_0x1bfb7c[_0x2eec3c(0x100)],await this[_0x2eec3c(0x118)][_0x2eec3c(0x180)](_0x516496[_0x322b2d]));}console['log'](_0x2eec3c(0x162));}async[_0x1d773c(0xf1)](_0x3c23ab){const _0x952ad5=_0x1d773c;try{const _0x322695=await(0x0,axios_1['default'])({'url':_0x3c23ab,'method':_0x952ad5(0xd6),'responseType':'stream','headers':{'Accept-Encoding':_0x952ad5(0x16a)}}),_0x1856f5=_0x322695[_0x952ad5(0x190)];let _0xcc06ee=(0x0,uuid_1['v4'])();const _0x2da2d4=await this[_0x952ad5(0xcf)][_0x952ad5(0x12b)]({'filename':_0xcc06ee,'buffer':_0x1856f5});return _0x2da2d4;}catch(_0x49b054){console[_0x952ad5(0x126)](_0x952ad5(0x1f0),_0x49b054);}return null;}async[_0x1d773c(0xb6)](_0x47d97f,_0x395380){const _0x525559=_0x1d773c,_0x15eeb8=_0x47d97f['user']?.['id'],_0x4c166b=await this[_0x525559(0x1e4)][_0x525559(0xe2)]({'where':{'userId':_0x47d97f[_0x525559(0x1b1)]['id'],'conversationId':_0x395380[_0x525559(0xf4)]}});if(!_0x4c166b)throw new common_1[(_0x525559(0x18b))](_0x525559(0x1e0),common_1[_0x525559(0x17a)][_0x525559(0x132)]);const _0x123f8f=await this['getCozeApi'](_0x47d97f[_0x525559(0x1b1)]['id']),_0x45fda7=await _0x123f8f['bots'][_0x525559(0x157)]({'bot_id':_0x4c166b[_0x525559(0x11e)]}),_0x4cdbb9=await this[_0x525559(0xfa)]['findOne']({'where':{'modelId':_0x45fda7['model_info'][_0x525559(0xf6)]}});if(!_0x4cdbb9)throw new common_1[(_0x525559(0x18b))]('模型不存在',common_1['HttpStatus'][_0x525559(0x132)]);if(!_0x15eeb8)return{'remainCount':0x0,'freeCount':0x0,'isVipFree':_0x4cdbb9[_0x525559(0x183)]==-0x1,'useIntegrate':_0x4cdbb9[_0x525559(0x19d)]};return{'remainCount':await this[_0x525559(0x18e)][_0x525559(0x13a)](_0x15eeb8,_0x4cdbb9[_0x525559(0x133)],_0x4cdbb9[_0x525559(0x183)]),'freeCount':_0x4cdbb9[_0x525559(0x183)],'isVipFree':_0x4cdbb9[_0x525559(0x183)]==-0x1,'useIntegrate':_0x4cdbb9[_0x525559(0x19d)]};}};function _0x2723(){const _0x18e204=['botEntity','-------------获取智能体列表:共【','--------------------DIFYERROR--------------','promptInfo','collectPage','deleteBot','botId','bot_name','fileId','fast','failed_file_list','./entity/message.entity','usage','./entity/knowledgedocument.entity','log','】条，当前【','text/event-stream','Repository','responseMessage','uploadFile','getBot','message','knowledgeEntity','reasoning_content','char_count','messageId','BAD_REQUEST','modelId','getKnowledgeDocumentList','X-Accel-Buffering','recommend','object_string','449331DklhBW','startDifyChat','getCozeModelVipFree','5014490rTsfPK','access_token','collectBot','end','findAndCount','知识库不存在！','content','DifyBot','hit_count','publishBot','useCount','dataset_list','coze','CozeConversationEntity','update_rule','chatId','documents','avatar','preview_tos_url','document_infos','LessThan','iconFileId','parse','hot','cmService','getJWTToken','responseMessageWithThink','userEntity','retrieve','COZEBOT','files','ChatEventType','CozeMessageEntity','text','prompt_info','-----------------------------------createKnowledgeDocumentERROR----------','api.coze.cn','getUserInfoFromHeader','page','-------------智能体同步完成','getJwtToken','fileUrl','now','mergeCollectData','setConversationName','../user/user.service','stream','identity','messages','client.datasets.process','../../common/constants/collectType.constant','updateRule','description','processing_file_list','bots','push','chat','chunk_strategy','includes','Access-Control-Allow-Origin','checkBadWords','../file/file.service','detail','HttpStatus','batchBotProgressResult','isTop','get','modelInfoConfig','progress','save','document_id','string','vipFreeNum','createKnowledgeDocument','getValue','deductBalance4Coze','sendDifyMessage','__metadata','upload','batchKnowledgeResult','HttpException','1145294inWPIF','documentId','userService','uploadForUrl','data','file_list','web_url','-----------------------CreateBotError---------------------------','updateBot','event','Content-Type','privateKey','spaceId','3887660iVFWMe','length','axios','__decorate','deduct','CozeModelEntity','createKnowledge','deleteConversation','contentType','doc_tree_tos_url','process','appId','5252274jCHusa','botType','cozeWorkflowEntity','desc','isEnd','checkUserStatus','update','getCozeApi','ERROR','getKnowledgeList','1199883ZkobtF','uncollect','user','content_type','knowledgeId','design:paramtypes','format_type','FileService','createBot','sendMessageFromFastgpt','DESC','Like','CONVERSATION_MESSAGE_COMPLETED','created','1024','getKnowledgeDocumentProgress','remaining_time','topConversation','dify','--------------------------------------------------client.upload','error\x20from\x20startChat!','UserCollectType','metadata','function_call','relId','completed','CONVERSATION_MESSAGE_DELTA','apiKey','CozeKnowledgeEntity','setHeader','fastUrl','userId','---------------------------CozeChatError--------------------------','getBotList','---------------当前智能体图标-------------','error\x20from\x20startChat-fast!','map','../badwords/badwords.service','Injectable','find','getWorkflowList','7HnzkFG','智能体不存在！','validateUserType','decorate','getMyBotList','tags','userType','knowledgeDocumentEntity','会话不存在','unifiedFormattingResponse','会话不存在！','gpt-4.1-mini','cozeConversationEntity','iconFileUrl','FastBot','beforeStartChat','formatType','write','count','获取智能体失败','rows','list','BadwordsService','conversations','-----------------------------------uploadUrlToServerError----------','CozeApiConfig','@nestjs/common','collect','InjectRepository','getUserById','@nestjs/typeorm','__param','bot_used_count','./entity/workflow.entity','getModelFree','datasets','publish','CONVERSATION_CHAT_COMPLETED','tag','question','getChatBotList','replace','getConversationList','documentBases','status','chunked','dataset_id','model','./entity/knowledge.entity','userInfo','defineProperty','badwordsService','UserEntity','default','validateBalance4Coze','ASC','source_type','当前智能体未匹配到对应模型，暂无法使用，请联系管理员添加','toString','fileService','role','../chatgpt/helper','processing_file_id_list','cozeMessageEntity','validateBeforeChat','文档不存在！','GET','999','size','assistant','---------------当前智能体ID-------------','请求失败，状态码:\x20','client.datasets.document.create','CozeAPI','api','workflowIdList','error','function','findOne','createConversation','EChangeType','CozeService','isRelease','statusCode','collectBotList','space_bots','SPACE_ID','choices','isArray','createMessage','../chatgpt/zhipu','4090592cFlPyb','answer','uploadUrlToServer','pluginIdList','difyUrl','conversationId','CmConfigService','model_id','expires_in','no-cache','getMessageList','cozeModelEntity','Transfer-Encoding','create','knowledge','../../common/constants/balance.constant','onboardingInfo','workflow_info_list','nickname','name','deleteKnowledge','forEach','slice_count','delete','bot_id','viewCount','object','type','search','https://api.coze.cn','total','data:\x20','-----------------------------------createKnowledgeERROR----------','stringify','delta','Guid','onboarding_info','client.datasets.document.delete','model_info','CozeKnowledgeDocumentEntity','7474575122028871720'];_0x2723=function(){return _0x18e204;};return _0x2723();}CozeService=__decorate([(0x0,common_1[_0x1d773c(0x1d5)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(bot_entity_1['CozeBotEntity'])),__param(0x1,(0x0,typeorm_1[_0x1d773c(0x1f4)])(knowledge_entity_1[_0x1d773c(0x1cb)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(knowledgedocument_entity_1[_0x1d773c(0x116)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(model_entity_1[_0x1d773c(0x19e)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(conversation_entity_1[_0x1d773c(0x148)])),__param(0x5,(0x0,typeorm_1[_0x1d773c(0x1f4)])(message_entity_1[_0x1d773c(0x15b)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(workflow_entity_1['CozeWorkflowEntity'])),__param(0x7,(0x0,typeorm_1[_0x1d773c(0x1f4)])(user_entity_1[_0x1d773c(0xc8)])),__metadata(_0x1d773c(0x1b4),[typeorm_2[_0x1d773c(0x129)],typeorm_2[_0x1d773c(0x129)],typeorm_2[_0x1d773c(0x129)],typeorm_2[_0x1d773c(0x129)],typeorm_2[_0x1d773c(0x129)],typeorm_2[_0x1d773c(0x129)],typeorm_2['Repository'],typeorm_2[_0x1d773c(0x129)],user_service_1['UserService'],badwords_service_1[_0x1d773c(0x1ee)],cm_service_1[_0x1d773c(0xf5)],file_service_1[_0x1d773c(0x1b6)]])],CozeService),exports[_0x1d773c(0xe5)]=CozeService;