'use strict';const _0x1c4e6e=_0xd746;function _0x2e97(){const _0x14dfef=['handleRequest','role','AuthGuard','validateToken','@nestjs/common','redisCacheService','__decorate','HttpException','log','authorization','ClsService','headers','nestjs-cls','canActivate','156wNaOOJ','set','RedisCacheService','getOwnPropertyDescriptor','user','UNAUTHORIZED','__esModule','@nestjs/passport','Bearer','split','156775VRBVmr','cls','2474226ehXwcj','8649072QHqdqh','__metadata','metadata','design:paramtypes','decorate','fingerprint','JWT_SECRET','authService','id:\x20','verify','function','5653791CuetQR','object','819ypIcVS','jwt','extractToken','defineProperty','JwtAuthGuard','亲爱的用户,请登录后继续操作,我们正在等您的到来！','67446fJWEvu','@nestjs/core','slice','length','20mlqPHY','../../modules/redisCache/redisCache.service','moduleRef','2502354DJYtzK','AuthService','1hTHyXy','3975903wItbDY'];_0x2e97=function(){return _0x14dfef;};return _0x2e97();}(function(_0x44eeb6,_0x3ec952){const _0x2b572a=_0xd746,_0x2c5255=_0x44eeb6();while(!![]){try{const _0x347da3=-parseInt(_0x2b572a(0xdd))/0x1*(-parseInt(_0x2b572a(0xdb))/0x2)+-parseInt(_0x2b572a(0xf9))/0x3+parseInt(_0x2b572a(0xed))/0x4*(-parseInt(_0x2b572a(0xf7))/0x5)+-parseInt(_0x2b572a(0xd4))/0x6*(-parseInt(_0x2b572a(0xce))/0x7)+-parseInt(_0x2b572a(0xc1))/0x8+parseInt(_0x2b572a(0xde))/0x9*(parseInt(_0x2b572a(0xd8))/0xa)+parseInt(_0x2b572a(0xcc))/0xb;if(_0x347da3===_0x3ec952)break;else _0x2c5255['push'](_0x2c5255['shift']());}catch(_0x10925b){_0x2c5255['push'](_0x2c5255['shift']());}}}(_0x2e97,0xcbe60));var __decorate=this&&this[_0x1c4e6e(0xe5)]||function(_0x27a6bc,_0x2b0752,_0x475278,_0x16acd7){const _0x3ffedb=_0x1c4e6e;var _0x350ff0=arguments[_0x3ffedb(0xd7)],_0xc71adb=_0x350ff0<0x3?_0x2b0752:_0x16acd7===null?_0x16acd7=Object[_0x3ffedb(0xf0)](_0x2b0752,_0x475278):_0x16acd7,_0x26bff2;if(typeof Reflect===_0x3ffedb(0xcd)&&typeof Reflect[_0x3ffedb(0xc5)]==='function')_0xc71adb=Reflect[_0x3ffedb(0xc5)](_0x27a6bc,_0x2b0752,_0x475278,_0x16acd7);else{for(var _0x5041f7=_0x27a6bc[_0x3ffedb(0xd7)]-0x1;_0x5041f7>=0x0;_0x5041f7--)if(_0x26bff2=_0x27a6bc[_0x5041f7])_0xc71adb=(_0x350ff0<0x3?_0x26bff2(_0xc71adb):_0x350ff0>0x3?_0x26bff2(_0x2b0752,_0x475278,_0xc71adb):_0x26bff2(_0x2b0752,_0x475278))||_0xc71adb;}return _0x350ff0>0x3&&_0xc71adb&&Object[_0x3ffedb(0xd1)](_0x2b0752,_0x475278,_0xc71adb),_0xc71adb;},__metadata=this&&this[_0x1c4e6e(0xc2)]||function(_0x45d4c8,_0x9cf6df){const _0x59cbf0=_0x1c4e6e;if(typeof Reflect===_0x59cbf0(0xcd)&&typeof Reflect[_0x59cbf0(0xc3)]===_0x59cbf0(0xcb))return Reflect[_0x59cbf0(0xc3)](_0x45d4c8,_0x9cf6df);};Object[_0x1c4e6e(0xd1)](exports,_0x1c4e6e(0xf3),{'value':!![]}),exports['JwtAuthGuard']=void 0x0;const redisCache_service_1=require(_0x1c4e6e(0xd9)),common_1=require(_0x1c4e6e(0xe3)),passport_1=require(_0x1c4e6e(0xf4)),jwt=require('jsonwebtoken'),core_1=require(_0x1c4e6e(0xd5)),auth_service_1=require('../../modules/auth/auth.service'),nestjs_cls_1=require(_0x1c4e6e(0xeb));let JwtAuthGuard=class JwtAuthGuard extends(0x0,passport_1[_0x1c4e6e(0xe1)])(_0x1c4e6e(0xcf)){constructor(_0x4ff914,_0xf30089,_0xe8a845,_0x389b52){const _0x143671=_0x1c4e6e;super(),this[_0x143671(0xe4)]=_0x4ff914,this[_0x143671(0xda)]=_0xf30089,this[_0x143671(0xc8)]=_0xe8a845,this['cls']=_0x389b52;}async[_0x1c4e6e(0xec)](_0x2144f1){const _0x5716e1=_0x1c4e6e;!this[_0x5716e1(0xe4)]&&(this[_0x5716e1(0xe4)]=this[_0x5716e1(0xda)]['get'](redisCache_service_1[_0x5716e1(0xef)],{'strict':![]}));const _0x51e7ce=_0x2144f1['switchToHttp']()['getRequest'](),_0x6c7919=this[_0x5716e1(0xd0)](_0x51e7ce);_0x51e7ce['user']=this[_0x5716e1(0xe2)](_0x6c7919),this[_0x5716e1(0xf8)][_0x5716e1(0xee)](_0x5716e1(0xe0),_0x51e7ce[_0x5716e1(0xf1)]['role']);if(_0x51e7ce['user'][_0x5716e1(0xe0)]==='visitor')throw new common_1[(_0x5716e1(0xe6))](_0x5716e1(0xd3),common_1['HttpStatus'][_0x5716e1(0xf2)]);return await this[_0x5716e1(0xe4)]['checkTokenAuth'](_0x6c7919,_0x51e7ce),!![];}['extractToken'](_0xacb89){const _0x153042=_0x1c4e6e;if(!_0xacb89['headers'][_0x153042(0xe8)]){if(_0xacb89[_0x153042(0xea)][_0x153042(0xc6)]){let _0x1f31af=_0xacb89[_0x153042(0xea)][_0x153042(0xc6)];return _0x1f31af>0x7fffffff&&(_0x1f31af=_0x1f31af['toString']()[_0x153042(0xd6)](-0x9),_0x1f31af=Number(String(Number(_0x1f31af))),console[_0x153042(0xe7)](_0x153042(0xc9),_0x1f31af)),this['authService']['createTokenFromFingerprint'](_0x1f31af);}return null;}const _0x16b919=_0xacb89[_0x153042(0xea)][_0x153042(0xe8)][_0x153042(0xf6)]('\x20');if(_0x16b919[_0x153042(0xd7)]!==0x2||_0x16b919[0x0]!==_0x153042(0xf5))return null;return _0x16b919[0x1];}[_0x1c4e6e(0xe2)](_0x146fae){const _0x10b3c5=_0x1c4e6e;try{return jwt[_0x10b3c5(0xca)](_0x146fae,process['env'][_0x10b3c5(0xc7)]);}catch(_0x92ac6a){throw new common_1['HttpException'](_0x10b3c5(0xd3),common_1['HttpStatus']['UNAUTHORIZED']);}}[_0x1c4e6e(0xdf)](_0x3685b6,_0x549af7,_0x3cab72){if(_0x3685b6||!_0x549af7){console['log']('err:\x20',_0x3685b6);throw _0x3685b6||new common_1['UnauthorizedException']();}return _0x549af7;}};function _0xd746(_0x43dbf7,_0x1d5716){const _0x2e9781=_0x2e97();return _0xd746=function(_0xd746c9,_0x123de1){_0xd746c9=_0xd746c9-0xc1;let _0x22a122=_0x2e9781[_0xd746c9];return _0x22a122;},_0xd746(_0x43dbf7,_0x1d5716);}JwtAuthGuard=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x1c4e6e(0xc4),[redisCache_service_1[_0x1c4e6e(0xef)],core_1['ModuleRef'],auth_service_1[_0x1c4e6e(0xdc)],nestjs_cls_1[_0x1c4e6e(0xe9)]])],JwtAuthGuard),exports[_0x1c4e6e(0xd2)]=JwtAuthGuard;