
/**
 * 由 Fantastic-admin 提供技术支持
 * Powered by Fantastic-admin
 * Gitee  https://gitee.com/hooray/fantastic-admin
 * Github https://github.com/hooray/fantastic-admin
 */
  
import{d as e,U as a,r as l,C as o,c as t,V as r,e as d,ah as s,o as i,f as n,m as u,g as c,h as p,F as m,J as g,j as f,i as b,q as y,Y as v,k as x,t as h,s as w,ag as k,ae as _,a4 as F,a1 as V,a2 as C}from"../main-6fd6ef79.js";import{A as z}from"./package.375a7266.js";import{u as U}from"../utcformatTime/utcformatTime.f6db2c52.js";import{C as A}from"../index/index.29fd00dc.js";import{a as j}from"../access/access.e0439180.js";const I={class:"search_add_card"},q={style:{display:"flex","align-items":"center"}},R={style:{"margin-left":"10px"}},M={style:{"margin-left":"10px"}},S={style:{"margin-top":"22px"}},B={style:{padding:"0 20px","border-bottom":"1px solid var(--el-border-color-lighter)"}},E={style:{padding:"20px",display:"flex","align-items":"center","justify-content":"space-between"}},N={style:{color:"#20295A","font-size":"15px","font-weight":"bold","background-color":"#EFF6FF",padding:"15px 20px","border-top":"15px",display:"flex","align-items":"center","justify-content":"space-between","border-top-right-radius":"15px","border-top-left-radius":"15px"}},P={style:{padding:"0 20px","border-bottom":"1px solid var(--el-border-color-lighter)"}},Y={key:1},L={style:{padding:"20px",display:"flex","align-items":"center","justify-content":"space-between"}},D=e({__name:"crami",setup(e){const V=a();l();const C=l(0),D=l(!1);l(!1);const T=l(),$=l(0),O=l([]),J=l([]),G=l(!1),H=l([]);l([]);const K=o({packageId:null,count:1,score:1}),Q=o({useId:"",status:"",page:1,size:15}),W=o({packageId:[{required:!0,message:"请选择套餐类型",trigger:"change"}],days:[{required:!0,message:"请填写有效期天数",trigger:"blur"}],count:[{required:!0,message:"请填写想要生成的数量",trigger:"blur"}],score:[{required:!0,message:"卡密携带积分数量",trigger:"blur"}]}),X=l([]);async function Z(){try{G.value=!0;const e=await z.queryAllCrami(Q),{rows:a,count:l}=e.data;G.value=!1,C.value=l,X.value=a}catch(e){G.value=!1}}async function ee(e){const a=await k.queryAllUser({size:30,username:e});J.value=a.data.rows}function ae(){K.packageId=null,K.count=1,K.score=1,async function(){const e=await z.queryAllPackage({size:100});O.value=e.data.rows}(),D.value=!0}async function le(e){null==e||e.validate((async e=>{if(e){if(0==V.isUserModifyPermissions())return _.error("非超级管理员无权限操作！");const e=await z.createCrami(K);(function(e,a){const l=function(e){return e.join("\n")}(e),o=new Blob([l],{type:"text/plain"}),t=URL.createObjectURL(o),r=document.createElement("a");r.href=t,r.download=`${a}.txt`,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout((()=>URL.revokeObjectURL(t)),0)})(e.data.map((e=>`${e.code}<----\x3e${e.packageName||"自定义套餐"}`)),"卡密信息"),_({type:"success",message:"生成卡密成功！"}),D.value=!1,Z()}}))}function oe(){Q.useId="",Q.status="",Z()}async function te(e){H.value=e}const re=l(null),de=l(!1),se=l([]);async function ie(){if(0===H.value.map((e=>e.id)).length)return void _.error("请选择要赠送的卡密");const{data:e}=await j.getSaasPage({size:1e3,page:1});se.value=e.rows,de.value=!0}async function ne(){const e=H.value.map((e=>e.id));0!==e.length?(await z.batchDistribute({ids:e,saasId:re.value}),de.value=!1,H.value=[],Z()):_.error("请选择要赠送的卡密")}return t((()=>X.value.some((e=>e.email)))),r((()=>{Z()})),(e,a)=>{const l=d("el-option"),o=d("el-select"),t=d("el-button"),r=d("RefreshRight"),k=d("el-icon"),j=d("el-table-column"),H=d("el-tag"),ue=d("el-popconfirm"),ce=d("el-table"),pe=d("el-pagination"),me=d("el-row"),ge=d("el-dialog"),fe=F,be=d("el-switch"),ye=d("el-form-item"),ve=d("el-input"),xe=d("el-form"),he=s("platform"),we=s("loading");return i(),n("div",null,[u("div",I,[u("div",q,[u("div",null,[a[15]||(a[15]=u("div",{class:"condition_name"},"用户信息",-1)),c(o,{modelValue:Q.useId,"onUpdate:modelValue":a[0]||(a[0]=e=>Q.useId=e),filterable:"",clearable:"",remote:"","reserve-keyword":"",placeholder:"用户姓名[模糊搜索]","remote-show-suffix":"","remote-method":ee,style:{width:"192px"}},{default:p((()=>[(i(!0),n(m,null,g(b(J),(e=>(i(),f(l,{key:e.id,label:e.username,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),u("div",R,[a[16]||(a[16]=u("div",{class:"condition_name"},"卡密状态",-1)),c(o,{modelValue:Q.status,"onUpdate:modelValue":a[1]||(a[1]=e=>Q.status=e),placeholder:"请选择卡密状态",clearable:"",style:{width:"192px"}},{default:p((()=>[(i(!0),n(m,null,g(b(A),(e=>(i(),f(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),u("div",M,[c(t,{bg:"",text:"",type:"primary",size:"large",style:{"font-size":"15px",height:"32px",background:"#EFF6FF",color:"#60A5FA","border-radius":"8px","margin-top":"25px"},onClick:Z},{default:p((()=>a[17]||(a[17]=[y(" 查询 ")]))),_:1})]),u("div",{style:{"margin-left":"12px","background-color":"#EFF6FF",padding:"4px 16px","border-radius":"8px","margin-top":"22px",cursor:"pointer"},onClick:oe},[c(k,{color:"#3B82F6",size:"20"},{default:p((()=>[c(r)])),_:1})])]),u("div",S,[b(V).isSuperAdmin?v((i(),f(t,{key:0,style:{"background-color":"transparent",border:"1px solid #15d3a4","border-radius":"8px",color:"#15d3a4"},onClick:ie},{default:p((()=>a[18]||(a[18]=[y("批量赠送 ")]))),_:1})),[[he,["saas"]]]):x("",!0),b(V).isSuperAdmin?(i(),f(t,{key:1,style:{"background-color":"transparent",border:"1px solid #3B82F6","border-radius":"8px",color:"#3B82F6"},onClick:ae},{default:p((()=>a[19]||(a[19]=[y("批量生成 ")]))),_:1})):x("",!0)])]),u("div",null,[v((i(),f(ce,{border:"",data:b(X),height:"calc(100vh - 310px)",style:{width:"100%"},size:"large",onSelectionChange:te},{default:p((()=>[c(j,{type:"selection",width:"55"}),b(V).isSuperAdmin||b(V).isAdmin?v((i(),f(j,{key:0,prop:"saasName",label:"所属代理"},null,512)),[[he,["saas"]]]):x("",!0),c(j,{prop:"code",label:"卡密账号"}),c(j,{prop:"packageName",label:"套餐类型"},{default:p((e=>[c(H,{type:e.row.packageName?"primary":"danger"},{default:p((()=>[y(h(e.row.packageName||"自定义卡密"),1)])),_:2},1032,["type"])])),_:1}),c(j,{prop:"code",label:"卡密状态"},{default:p((e=>[c(H,{type:e.row.status?"danger":"primary"},{default:p((()=>[y(h(e.row.status?"已使用":"未使用"),1)])),_:2},1032,["type"])])),_:1}),c(j,{prop:"username",label:"用户名"},{default:p((e=>[y(h(null==e.row.username?"--":e.row.username),1)])),_:1}),c(j,{prop:"phone",label:"手机号"},{default:p((e=>[y(h(""==e.row.phone?"--":e.row.phone),1)])),_:1}),c(j,{prop:"email",label:"邮箱"},{default:p((e=>[y(h(""==e.row.email?"--":e.row.email),1)])),_:1}),c(j,{prop:"createdAt",label:"生成时间"},{default:p((e=>[y(h(b(U)(e.row.createdAt,"YYYY-MM-DD hh:mm:ss")),1)])),_:1}),c(j,{label:"操作"},{default:p((e=>[c(ue,{title:"确认删除此卡密么?",width:"200","icon-color":"red",onConfirm:a=>async function(e){if(0==V.isUserModifyPermissions())return _.error("非超级管理员无权限操作！");await z.delCrami({id:e.id}),_({type:"success",message:"删除卡密成功！"}),Z()}(e.row)},{reference:p((()=>[c(t,{link:"",type:"danger",size:"small"},{default:p((()=>a[20]||(a[20]=[y(" 删除卡密 ")]))),_:1})])),_:2},1032,["onConfirm"])])),_:1})])),_:1},8,["data"])),[[we,b(G)]]),c(me,{class:"flex justify-end mt-5"},{default:p((()=>[c(pe,{"current-page":Q.page,"onUpdate:currentPage":a[2]||(a[2]=e=>Q.page=e),"page-size":Q.size,"onUpdate:pageSize":a[3]||(a[3]=e=>Q.size=e),class:"mr-5","page-sizes":[15,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:b(C),onSizeChange:Z,onCurrentChange:Z},null,8,["current-page","page-size","total"])])),_:1})]),c(ge,{modelValue:b(de),"onUpdate:modelValue":a[6]||(a[6]=e=>w(de)?de.value=e:null),width:"500","show-close":!1,"destroy-on-close":""},{header:p((()=>a[21]||(a[21]=[u("div",{style:{color:"#20295A","font-size":"15px","font-weight":"bold","background-color":"#EFF6FF",padding:"15px 20px","border-top":"15px",display:"flex","align-items":"center","justify-content":"space-between","border-top-right-radius":"15px","border-top-left-radius":"15px"}}," 请选择要赠送的代理商 ",-1)]))),default:p((()=>[u("div",B,[c(o,{modelValue:b(re),"onUpdate:modelValue":a[4]||(a[4]=e=>w(re)?re.value=e:null)},{default:p((()=>[(i(!0),n(m,null,g(b(se),(e=>(i(),f(l,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),u("div",E,[c(t,{bg:"",text:"",style:{width:"40%",padding:"20px 0","background-color":"#F4F4F5",color:"#20295A","border-radius":"8px"},onClick:a[5]||(a[5]=e=>de.value=!1)},{default:p((()=>a[22]||(a[22]=[y("取消 ")]))),_:1}),c(t,{bg:"",text:"",style:{width:"40%",padding:"20px 0","background-color":"#3B82F6",color:"#FFF","border-radius":"8px"},type:"primary",onClick:ne},{default:p((()=>a[23]||(a[23]=[y(" 确认 ")]))),_:1})])])),_:1},8,["modelValue"]),c(ge,{modelValue:b(D),"onUpdate:modelValue":a[14]||(a[14]=e=>w(D)?D.value=e:null),width:"500","show-close":!1,"destroy-on-close":""},{header:p((({close:e,titleId:l,titleClass:o})=>[u("div",N,[a[24]||(a[24]=u("div",null," 生成卡密 ",-1)),u("div",{onClick:a[7]||(a[7]=e=>D.value=!1),style:{cursor:"pointer"}},[c(k,null,{default:p((()=>[c(fe,{name:"close"})])),_:1})])])])),default:p((()=>[u("div",P,[c(xe,{ref_key:"formCramiRef",ref:T,"label-position":"right","label-width":"100px",model:K,rules:W},{default:p((()=>[c(me,null,{default:p((()=>[c(ye,{label:"是否生成自定义卡密","label-width":"170px"},{default:p((()=>[c(be,{modelValue:b($),"onUpdate:modelValue":a[8]||(a[8]=e=>w($)?$.value=e:null),"active-value":1,"inactive-value":0},null,8,["modelValue"])])),_:1})])),_:1}),b($)?x("",!0):(i(),f(ye,{key:0,label:"套餐类型",prop:"packageId"},{default:p((()=>[c(o,{size:"large",modelValue:K.packageId,"onUpdate:modelValue":a[9]||(a[9]=e=>K.packageId=e),modelModifiers:{number:!0},placeholder:"请选择套餐类型",clearable:"",style:{width:"100%"}},{default:p((()=>[(i(!0),n(m,null,g(b(O),(e=>(i(),f(l,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})),b($)?(i(),n("div",Y,[c(ye,{label:"积分额度",prop:"score"},{default:p((()=>[c(ve,{size:"large",modelValue:K.score,"onUpdate:modelValue":a[10]||(a[10]=e=>K.score=e),modelModifiers:{number:!0},type:"number",placeholder:"卡密携带积分额度额度"},null,8,["modelValue"])])),_:1})])):x("",!0),c(ye,{label:"生成数量",prop:"count"},{default:p((()=>[c(ve,{size:"large",modelValue:K.count,"onUpdate:modelValue":a[11]||(a[11]=e=>K.count=e),modelModifiers:{number:!0},type:"number",placeholder:"本次生成的张数"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])]),u("div",L,[c(t,{bg:"",text:"",style:{width:"40%",padding:"20px 0","background-color":"#F4F4F5",color:"#20295A","border-radius":"8px"},onClick:a[12]||(a[12]=e=>D.value=!1)},{default:p((()=>a[25]||(a[25]=[y("取消 ")]))),_:1}),c(t,{bg:"",text:"",style:{width:"40%",padding:"20px 0","background-color":"#3B82F6",color:"#FFF","border-radius":"8px"},type:"primary",onClick:a[13]||(a[13]=e=>le(b(T)))},{default:p((()=>a[26]||(a[26]=[y(" 确认 ")]))),_:1})])])),_:1},8,["modelValue"])])}}});"function"==typeof C&&C(D);const T=V(D,[["__scopeId","data-v-0001efbe"]]);export{T as default};
