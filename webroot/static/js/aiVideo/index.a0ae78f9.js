import{a as e}from"../index/index.85cd695d.js";import{T as a}from"../index/index.347b3f04.js";import{j as t,aZ as s,e as o,r,p as d,k as i,g as n,q as l,I as p,aF as u,ah as c,w as m,x as g,B as v,C as f,an as h,bs as y,$ as b}from"../main-a0b53047.js";import{i as w,b as I,h as L}from"../music/music.aee9a7ff.js";import{u as T}from"../useUpload/useUpload.78be6f1d.js";import"../aboutUs copy/aboutUs copy.f440c040.js";const S={style:{display:"flex",height:"100%"}},x={style:{width:"100%"},class:"bg-[#fff] dark:bg-[#24252B]"},O=o({__name:"index",setup(o){const{selectFileByImageAndVideo:O}=T(),P=r("/api/file/upload"),q=d(),A=["succeeded","completed","succeed"],j=i(),B=n((()=>j.isLogin)),D={page:1,size:20},M=r(0),N=r({data:[],styleData:[],hasMore:!1,loading:!1,generate:!1});return l((()=>{p.emit("setSliderMenus")})),async function(){try{const a=await(e={dictType:"video-style",dictName:"",page:1,size:30},t({url:"/dict/page",data:e}));N.value.styleData=a.data.rows}catch(a){q.error(a.message)}var e}(),function(){try{setInterval((()=>{if(1===M.value){const e=N.value.data.filter((e=>"error"!==e.status&&(!A.includes(e.status)||"usesLeft"===e.type||null===e.cover))).map((e=>e.id));e.length&&(console.log(N.value.data,"videoData.value.data"),console.log("peddingIds",e),j.getUserInfo(),w({ids:e.join()}).then((e=>{1===M.value&&e.data.forEach((e=>{if(null!=e.errMsg){q.error(e.errMsg);const a=N.value.data.findIndex((a=>a.id==e.id));"服务异常、请重新试试吧！！！"===e.errMsg?N.value.data[a].status="error":a>-1&&N.value.data.splice(a,1)}else if(A.includes(e.answer)){const a=N.value.data.findIndex((a=>a.id==e.id));a>-1&&(N.value.data[a]={...e.children[0],modelSubType:e.modelSubType,conversationOptions:e.conversationOptions,id:e.id,requestParams:e.requestParams,generateLoading:!1,model:e.model,prompt:e.prompt,status:e.answer,modelInfo:e.modelInfo})}}))})))}}),3e3)}catch(e){console.log(e),q.error(e.message)}}(),u("videoBase",{list:async function(e,a,t){return console.log("videoBaseTabType",e),t>0?D.page=t:D.page++,M.value=e,new Promise((async(t,s)=>{var o;let r={};r=0==e?await I({...D,modelType:"video",modelSubType:a}):await L({...D,modelType:"video",order:"createAt",modelSubType:a});let d,i=(null==(o=null==r?void 0:r.data)?void 0:o.records)||[],n=[];d=1==e?JSON.parse(JSON.stringify(i)).reverse():JSON.parse(JSON.stringify(i)),d.forEach((async e=>{if(e.errMsg)n.push({conversationOptions:e.conversationOptions,id:e.id,modelSubType:e.modelSubType,requestParams:e.requestParams,model:e.model,prompt:e.prompt,generateLoading:!1,intro:e.prompt.indexOf("prompt ")>-1?e.prompt.split("--")[0].split("prompt ")[1]:e.prompt,createdAt:e.createdAt,status:"error"});else if(e.children&&e.children.length>0){const a=e.children.find((e=>e.mp4));a&&(e.prompt.indexOf("prompt ")>-1?a.intro=e.prompt.split("--")[0].split("prompt ")[1]:a.intro=e.prompt);const t={...a||e.children[0],id:e.id,conversationOptions:e.conversationOptions,modelSubType:e.modelSubType,model:e.model,prompt:e.prompt,status:e.answer,requestParams:e.requestParams,modelInfo:e.modelInfo};n.push(t)}else n.push({...e})})),1==e&&n.sort(((e,a)=>new Date(e.createdAt)-new Date(a.createdAt))),1===D.page?N.value.data=n:N.value.data.unshift(...n),i.length<D.size&&(N.value.noMore=!0),N.value.loading=!1,p.emit("setBeginTime",!0),t(r)}))},remove:function(e){y({id:e}).then((a=>{q.success(b("common.deleteSuccess"));const t=N.value.data.findIndex((a=>a.id===e||a.chatLogId===e));N.value.data.splice(t,1)})).catch((e=>{e.message&&q.error(e.message)}))},create:function(e,a){return N.value.generate=!0,new Promise((t=>{if(B.value){const o=e();(function(e,a=""){return s({url:"/chatgpt/chat-video"+(a?"-"+a:""),data:e})})(o,a).then((e=>{o.id=e.data.id,o.createdAt=e.data.createdAt,o.intro=e.data.prompt.split("--")[0].split("prompt ")[1],o.status="pedding",e.data.requestParams&&(o.requestParams=e.data.requestParams),e.data.modelInfo&&(o.modelInfo=e.data.modelInfo),1===M.value&&N.value.data.push(o),N.value.generate=!1,t(e)})).catch((e=>{N.value.generate=!1,q.error(e.message),t(!1)}))}else j.setLoginDialog(!0),N.value.generate=!1,t(!1)}))},uploadFile:async function(e){return new Promise((async(a,t)=>{try{console.log(e,"setKLvideoLoading");const t=await O();p.emit("setKLvideoLoading",{e:e,data:!0}),await h.post(P.value,{file:t},{headers:{"Content-Type":"multipart/form-data"}}).then((t=>{console.log(t),p.emit("setKLvideoLoading",{e:e,data:!1}),200==t.data.code?a(t.data.data):q.error(null==t.data.message?t.data.data:t.data.message)}))}catch(s){p.emit("setKLvideoLoading",{e:s,data:!1}),q.error(s.message),a(!1)}}))},videoData:N,getIsLogin:()=>j.isLogin}),(t,s)=>{const o=c("RouterView");return m(),g("div",S,[v("div",x,[f(o,{style:{height:"100%"},class:"bg-[#fff] dark:bg-[#19191B]"})]),f(e),f(a)])}}});export{O as default};
