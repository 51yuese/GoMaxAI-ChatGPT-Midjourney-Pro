import{ao as e,aQ as l,j as a,be as n,e as i,r as s,R as o,a9 as r,ax as u,a0 as c,A as d,ai as g,au as v,bf as p,bg as f,O as m,P as h,Z as x,_ as y,U as b,X as k,a6 as I,N as S,$ as w,aa as O,W as T,H as L,bh as C,aR as N,a1 as B,a2 as _,K as F,bi as A,a3 as H}from"../main-ddc3955a.js";import{c as M}from"../index/index.d335b448.js";function G(){const t=e(),i=l(),s=a((()=>i.usingContext));return{usingContext:s,toggleUsingContext:function(){i.setUsingContext(!s.value),s.value?t.success(n("chat.turnOnContext")):t.warning(n("chat.turnOffContext"))}}}function j(){const e=l();return{addGroupChat:t=>{e.addGroupChat(t)},updateGroupChat:(t,l)=>{e.updateGroupChat(t,l)},updateGroupChatSome:(t,l)=>{e.updateGroupChatSome(t,l)}}}function J(){const t=e(),n=l(),i=a((()=>n.usingNetwork));return{usingNetwork:i,toggleUsingNetwork:function(){n.setUsingNetwork(!i.value),i.value?t.success("已开启联网模式、上下文状态失效！"):t.warning("已关闭联网模式！")}}}const U=e=>(B("data-v-f72652db"),e=e(),_(),e),q={class:"messageBox"},E={style:{width:"100%",display:"flex","justify-content":"flex-end","margin-top":"24px","flex-direction":"column","align-items":"flex-end"}},R={key:0},z=["src"],D=["innerHTML"],P={key:1},V={class:"dark:bg-[#19191B] bg-[#F8F9F9]",style:{padding:"8px","border-radius":"8px",display:"flex","align-items":"center"}},$={key:0,style:{"background-color":"#10a37f",padding:"4px","border-radius":"4px",display:"flex"}},K=[U((()=>h("img",{style:{width:"30px",height:"30px"},src:"/static/svg/file-16b3e23d.svg",alt:""},null,-1)))],Q={style:{"margin-left":"5px"}},W={style:{"font-size":"15px"}},X={key:0,style:{"font-size":"12px"}},Z=["innerHTML"],Y={key:2},ee=["innerHTML"],te={key:3},le=["innerHTML"],ae={style:{"margin-top":"24px",display:"flex","align-items":"flex-start","flex-direction":"column"}},ne={style:{display:"flex","align-items":"flex-start"}},ie={class:"border dark:border-[#25262A] border-[#EAEAEA]",style:{"border-radius":"50%",width:"34px",height:"34px"}},se=["src"],oe={key:0,class:"chatLeft"},re=["innerHTML"],ue={style:{display:"flex","align-items":"center","margin-top":"12px","margin-left":"45px"}},ce=["onClick"],de={key:0,src:"/static/svg/copyBtn-00ccc1be.svg",alt:""},ge={key:1,src:"/static/svg/copyBtn copy-6bf79128.svg",alt:""},ve=U((()=>h("span",null,"复制",-1))),pe=["onClick"],fe={key:0,src:"/static/svg/refresh-719a54ac.svg",alt:""},me={key:1,src:"/static/svg/refresh copy-4bbd102c.svg",alt:""},he=U((()=>h("span",null,"刷新",-1))),xe=["onClick"],ye={key:0,src:"/static/svg/delet-4ab48311.svg",alt:""},be={key:1,src:"/static/svg/delet copy-1e1716eb.svg",alt:""},ke=U((()=>h("span",null,"删除",-1))),Ie={class:"AItip dark:bg-[#222325] bg-[#F0F0F0]"},Se={style:{display:"flex","align-items":"center"}},we={key:0,src:"/static/svg/tip-01b599c6.svg",alt:""},Oe={key:1,src:"/static/svg/tip copy-d2ba358b.svg",alt:""},Te={style:{"margin-left":"4px"},class:"text-[#8B8C8C] dark:text-[#6C6E79]"},Le={class:"sticky bottom-0 left-0 flex justify-center"},Ce=U((()=>h("p",{style:{"margin-left":"8px"}},"停止输出",-1))),Ne=H(i({__name:"haveChatLog",props:{chatLogList:Array,appItem:Object,handleSubmit:String,type:String},emits:["changeChatLog","isSuccess"],setup(n,{emit:i}){const{addGroupChat:B,updateGroupChat:_,updateGroupChatSome:H}=j(),U=e(),Ne=s([]),Be=l(),_e=o(),Fe=r(),Ae=a((()=>"dark"===Fe.theme)),He=u(),{usingContext:Me,toggleUsingContext:Ge}=G(),je=a((()=>Be.chatList)),Je=s(!1),Ue=s(""),qe=n;function Ee(e){Ne.value=e.filter((e=>null!=e.conversationOptions)),0!=Ne.value.length?(Ne.value.forEach((e=>{let{prompt:t}=e.requestOptions,{text:l}=e;null!=l&&(e.text=v(l),-1!=t.indexOf("png")||-1!=t.indexOf("jpeg")||-1!=t.indexOf("jpg")?(e.fileSrc=t.split(" ")[0],e.fileText=t.split(" ")[1]):-1!=t.indexOf("http")&&(-1!=t.split(" ")[0].indexOf("http")?e.fileSrc1=t.split(" ")[0]:e.fileSrc1="",e.fileText1=t.split(" ")[1]))})),setTimeout((()=>{it()}),100)):c.emit("notData",Ne.value)}qe.appItem&&(qe.appItem.config?Je.value=!1:Je.value=!0),c.on("chatLogList",(e=>{Ee(e)}));const Re=i;d(Ne,(async e=>{await F(),setTimeout((()=>{const e=document.getElementsByClassName("markdown-body-generate");for(let t=0;t<e.length;t++){const l=e[t].getElementsByTagName("p");for(let e=0;e<l.length;e++)l[e].style.lineHeight="25px"}}),3e3)}),{immediate:!0,deep:!0}),d(qe,(e=>{console.log(e,"newValue22"),e.handleSubmit&&(c.emit("haveLog",!0),at(e.handleSubmit))})),d((()=>qe.chatLogList),((e,t)=>{console.log(e,"newValue",t),String(e)!==String(t)&&(console.log(11111111),Ee(qe.chatLogList))}),{immediate:!0});const ze=s(""),De=s("");if(g({keys:["dialogueTail","robotAvatar"]}).then((e=>{ze.value=e.data.dialogueTail,De.value=e.data.robotAvatar})),c.on("uuid",(e=>{let t;e.config&&(t=JSON.parse(e.config).modelInfo.modelType),e.gptsApp?Je.value=!0:Je.value="app"==t})),localStorage.getItem("chatLogId")){let e,t=JSON.parse(localStorage.getItem("chatLogId"));t.config&&(e=JSON.parse(t.config).modelInfo.modelType),t.gptsApp||"app"==e?Je.value=!0:Je.value=!1}v.setOptions({pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});const Pe=s(""),Ve=s(!1),{usingNetwork:$e}=J(),Ke=s(!1),Qe=s(!0),We=a((()=>Be.active)),Xe=a((()=>Be.groupList.find((e=>e.uuid===We.value)))),Ze=a((()=>je.value.filter((e=>!e.inversion&&!e.error))));let Ye=new AbortController;const et=a((()=>Number(null==Be?void 0:Be.activeModelKeyType)));c.on("setFileModel",(e=>{console.log(e,"datasssss"),Ue.value=null==e?void 0:e.model})),c.on("sendGuide",(e=>{c.emit("haveLog",!0),e.isApp&&(Je.value=!0),at(e.msg)}));const tt=s("");d(tt,(e=>{let t=nt.value;t.scrollTop=t.scrollHeight}));const lt=s();async function at(e){var l;console.log(e,"msg",Pe.value);let a="",n="",i="",s="";if(-1!=(null==e?void 0:e.indexOf("http"))){let t=null==e?void 0:e.split(" ")[0];-1!=(null==t?void 0:t.indexOf("png"))||-1!=(null==t?void 0:t.indexOf("jpeg"))||-1!=(null==t?void 0:t.indexOf("jpg"))?(i=null==e?void 0:e.split(" ")[0],a=null==e?void 0:e.split(" ")[1]):(s=-1!=e.split(" ")[0].indexOf("http")?null==e?void 0:e.split(" ")[0]:"",n=null==e?void 0:e.split(" ")[1])}let o=e||Pe.value;if(Ve.value)return;if(Ye=new AbortController,!o||""===o.trim())return;v.setOptions({pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});let r={dateTime:(new Date).toLocaleString(),text:"AI思考中",inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:null},fileText:a,fileText1:n,fileSrc:i,fileSrc1:s};Ne.value=Ne.value.length>0?[...Ne.value,r]:[r],setTimeout((()=>{it()}),100),c.emit("sendSuccess"),Re("isSuccess",!0);let u={};u=Je.value?{groupId:+We.value,usingNetwork:$e.value,model:Ue.value,type:"gpts"}:{groupId:+We.value,usingNetwork:$e.value,model:Ue.value};const d=null==(l=Ze.value[Ze.value.length-1])?void 0:l.conversationOptions;d&&Me.value&&!$e.value&&(u={groupId:d.groupId,usingNetwork:d.usingNetwork,...u});let g="",m="",h=0,x=null;Ke.value=!0;let y={};He.updateIsChatIn(!0);try{const e=async()=>{lt.value=setInterval((async()=>{var e;if(Ve.value=!0,g&&g[h]&&m.length<g.length&&(m+=g[h]),g&&g[h]){Qe.value=!1;const e=Ne.value.length>0?Ne.value.length-1:Ne.value.length;Ne.value[e]&&(Ne.value[e].text=m,Ne.value[e].text=v(Ne.value[e].text)),tt.value=m,h++}if(!Ke.value&&(null==m?void 0:m.length)>=(null==g?void 0:g.length)&&(tt.value="",c.emit("getUserInfo",!0),c.emit("updateMessageList",!0),c.emit("updateModelList",!0),h=0,m="",lt.value&&clearInterval(lt.value),lt.value=null,Ve.value=!1,Qe.value=!0,H(je.value.length-1,{loading:!1}),He.updateIsChatIn(!1),y&&_e.updateUserBanance(y),2===je.value.length&&!(null==(e=null==Xe?void 0:Xe.value)?void 0:e.appId))){const e=je.value[1].text.length>15?je.value[1].text.slice(0,15):je.value[1].text;await Be.updateGroupInfo({groupId:+We.value,title:e}),await Be.queryMyGroup()}}),16),"fileType"===qe.type?await p({prompt:o,appId:Xe.value?Xe.value.appId:0,options:{model:null==u?void 0:u.model,usingNetwork:null==u?void 0:u.usingNetwork},signal:Ye.signal,onDownloadProgress:({event:e})=>{var t;setTimeout((()=>{it()}),100);const l=e.target,{responseText:a}=l;if([1].includes(et.value))try{x=JSON.parse(a)}catch(n){(null==x?void 0:x.data.includes("OpenAI timed out waiting for response"))&&U.warning("会话超时了、告知管理员吧~~~")}if([2,3].includes(et.value)){const e=a.toString().split("\n").filter((e=>""!==e.trim()));let t="",l={};for(const a of e)try{const e=JSON.parse(a);t=e,l=e}catch(n){}l.result=t,x=l}if([4].includes(et.value))try{x=JSON.parse(a)}catch(n){(null==x?void 0:x.data.includes("xunfeizhipu timed out waiting for response"))&&U.warning("会话超时了、告知管理员吧~~~")}try{[1].includes(et.value)&&(g=null==x?void 0:x.data,Ke.value=!x.is_end,(null==(t=null==x?void 0:x.detail)?void 0:t.usage)&&(Qe.value=x.is_end,y=null==x?void 0:x.userBanance)),[2,3].includes(et.value)&&(g=null==x?void 0:x.data,Ke.value=!(null==x?void 0:x.is_end),(null==x?void 0:x.userBanance)&&(y=null==x?void 0:x.userBanance)),[4].includes(et.value)&&(g=null==x?void 0:x.data,Ke.value=!(null==x?void 0:x.is_end),(null==x?void 0:x.userBanance)&&(y=null==x?void 0:x.userBanance))}catch(n){console.log(n)}}}):await f({prompt:o,appId:Xe.value?Xe.value.appId:0,options:u,signal:Ye.signal,onDownloadProgress:({event:e})=>{var t;setTimeout((()=>{it()}),100);const l=e.target,{responseText:a}=l;if([1].includes(et.value)){const e=a.lastIndexOf("\n",a.length-2);let t=a;-1!==e&&(t=a.substring(e));try{x=JSON.parse(t)}catch(n){t.includes("OpenAI timed out waiting for response")&&U.warning("会话超时了、告知管理员吧~~~")}}if([2,3].includes(et.value)){const e=a.toString().split("\n").filter((e=>""!==e.trim()));let t="",l={};for(const a of e)try{const e=JSON.parse(a);t=e.text,l=e}catch(n){}l.result=t,x=l}if([4].includes(et.value)){const e=a.lastIndexOf("\n",a.length);let t=a;-1!==e&&(t=a.substring(e));try{x=JSON.parse(t)}catch(n){t.includes("xunfeizhipu timed out waiting for response")&&U.warning("会话超时了、告知管理员吧~~~")}}try{if([1].includes(et.value)&&(g=x.text,Ke.value=!x.is_end,(null==(t=null==x?void 0:x.detail)?void 0:t.usage)&&(Qe.value=x.is_end,y=null==x?void 0:x.userBanance)),[2,3].includes(et.value)){const{result:e,is_end:t}=x;g=e,Ke.value=!t,(null==x?void 0:x.userBanance)&&(y=null==x?void 0:x.userBanance)}if([4].includes(et.value)){const{text:e,is_end:t}=x;g=e,Ke.value=!t,(null==x?void 0:x.userBanance)&&(y=null==x?void 0:x.userBanance)}}catch(n){console.log(n)}}})};await e()}catch(b){if(!b)return;const e=Ne.value.length>0?Ne.value.length-1:Ne.value.length;Ne.value[e].text=b.message,He.updateIsChatIn(!1),clearInterval(lt.value),Ke.value=!1,(402===b.code||(null==b?void 0:b.message.includes("余额不足"))||(null==b?void 0:b.message.includes("免费额度已经使用完毕")))&&He.updateVipDialog(!0);let l=(null==b?void 0:b.message)??t("common.wrong");if("Request failed with status code 401"===l&&(l="非法操作、请先登录后再进行问答使用！"),null==b?void 0:b.message.includes("canceled"))return H(je.value.length-1,{loading:!1}),void setTimeout((()=>{_e.getUserBalance()}),200);const a=je.value[je.value.length-1];if((null==a?void 0:a.text)&&""!==a.text)return void H(je.value.length-1,{text:`${"AI思考中"===a.text?"":a.text}\n[${l}]`,error:!1,loading:!1});_(je.value.length-1,{dateTime:(new Date).toLocaleString(),text:l,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...u}}})}finally{Ve.value=!1,Ke.value=!1}}const nt=s(null);function it(){let e=nt.value;e&&e.scrollTo({top:e.scrollHeight+e.clientHeight,behavior:"smooth"})}function st(){Ve.value&&(Ye.abort(),Ve.value=!1,Ke.value=!1,Qe.value=!0,clearInterval(lt.value))}return(e,t)=>(S(),m("div",q,[h("div",{class:"chatLogBox",ref_key:"toTop",ref:nt},[(S(!0),m(x,null,y(Ne.value,(e=>(S(),m("div",{class:"LogItem",key:e.chatId},[h("div",E,[""!=e.fileSrc?(S(),m("div",R,[h("img",{style:{width:"150px",height:"auto"},src:e.fileSrc,alt:""},null,8,z),e.fileText?(S(),m("div",{key:0,class:"chatRight1 dark:bg-[#222325] bg-[#F0F0F0] markdown-body-generate",innerHTML:e.fileText},null,8,D)):I("",!0)])):I("",!0),e.fileSrc1&&-1!=e.fileSrc1.indexOf("/ai/")?(S(),m("div",P,[h("div",V,[-1!=e.fileSrc1.indexOf("/ai/")?(S(),m("div",$,K)):I("",!0),h("div",Q,[h("p",W,w(e.fileSrc1.split("/ai/")[1]),1),""!=e.fileSrc1&&-1!=e.fileSrc1.indexOf("/ai/")?(S(),m("p",X,w(e.fileSrc1.split("/ai/")[1].split(".")[1]),1)):I("",!0)])]),e.fileText1?(S(),m("div",{key:0,class:"chatRight1 dark:bg-[#222325] bg-[#F0F0F0] markdown-body-generate",innerHTML:e.fileText1},null,8,Z)):I("",!0)])):I("",!0),e.fileSrc1?(S(),m("div",Y,[!e.fileSrc1&&!e.fileSrc||-1==e.fileSrc1.indexOf("/ai/")?(S(),m("div",{key:0,class:"chatRight dark:bg-[#222325] bg-[#F0F0F0]",innerHTML:e.requestOptions.prompt},null,8,ee)):I("",!0)])):(S(),m("div",te,[!e.fileSrc1&&!e.fileSrc||-1==e.fileSrc.indexOf("/ai/")?(S(),m("div",{key:0,class:"chatRight dark:bg-[#222325] bg-[#F0F0F0]",innerHTML:e.requestOptions.prompt},null,8,le)):I("",!0)]))]),h("div",ae,[h("div",ne,[h("div",ie,[h("img",{src:De.value,alt:""},null,8,se)]),null==e.text||""==e.text?(S(),m("div",oe," 接口错误，请联系管理员处理~ ")):(S(),m("div",{key:1,class:"chatLeft markdown-body-generate",innerHTML:e.text,style:{"line-height":"15px","margin-top":"13px"}},null,8,re))]),h("div",ue,[h("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>function(e){if(e.text){const{text:t}=e;M({text:t}),U.success("复制成功")}else U.error("复制失败")}(e)},[b(k(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:T((()=>[Ae.value?(S(),m("img",de)):(S(),m("img",ge))])),default:T((()=>[ve])),_:1},8,["style"])],10,ce),h("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>function(e){const{prompt:t}=e.requestOptions;at(t)}(e)},[b(k(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:T((()=>[Ae.value?(S(),m("img",fe)):(S(),m("img",me))])),default:T((()=>[he])),_:1},8,["style"])],10,pe),h("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>async function(e){let t={id:e.chatId};await A(t).then((t=>{Ne.value=Ne.value.filter((t=>t.chatId!=e.chatId)),U.success("删除成功")})).catch((e=>{U.error("删除失败")})),0==Ne.value.length&&(console.log("暂无数据"),c.emit("haveLog",!1))}(e)},[b(k(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:T((()=>[Ae.value?(S(),m("img",ye)):(S(),m("img",be))])),default:T((()=>[ke])),_:1},8,["style"])],10,xe),h("div",Ie,[h("div",Se,[Ae.value?(S(),m("img",we)):(S(),m("img",Oe))]),h("p",Te,w(ze.value),1)])])])])))),128)),h("div",Le,[Ve.value?(S(),m("div",{key:0,onClick:st,class:"stopBox"},[b(k(N),{icon:"ri:stop-circle-line"}),Ce])):I("",!0)])],512)]))}}),[["__scopeId","data-v-f72652db"]]),Be="/static/svg/sendBox_2 copy-a52e6131.svg",_e="/static/svg/sendBox_3-8999da18.svg";export{Be as _,_e as a,j as b,J as c,Ne as h,G as u};
