import{an as e,aP as l,j as a,bc as n,e as i,r as s,O as o,a7 as r,aw as u,Y as c,A as d,ah as g,at as v,bd as p,R as f,S as m,U as h,W as x,a2 as y,a8 as b,a4 as k,Q as I,X as S,a9 as O,a3 as w,H as L,be as C,aQ as T,Z as B,_ as F,K as N,bf as A,$ as H}from"../main-f2e6132a.js";import{c as _}from"../index/index.d335b448.js";function M(){const t=e(),i=l(),s=a((()=>i.usingContext));return{usingContext:s,toggleUsingContext:function(){i.setUsingContext(!s.value),s.value?t.success(n("chat.turnOnContext")):t.warning(n("chat.turnOffContext"))}}}function G(){const e=l();return{addGroupChat:t=>{e.addGroupChat(t)},updateGroupChat:(t,l)=>{e.updateGroupChat(t,l)},updateGroupChatSome:(t,l)=>{e.updateGroupChatSome(t,l)}}}function j(){const t=e(),n=l(),i=a((()=>n.usingNetwork));return{usingNetwork:i,toggleUsingNetwork:function(){n.setUsingNetwork(!i.value),i.value?t.success("已开启联网模式、上下文状态失效！"):t.warning("已关闭联网模式！")}}}const U=e=>(B("data-v-e79ec51e"),e=e(),F(),e),q={class:"messageBox"},E={style:{width:"100%",display:"flex","justify-content":"flex-end","margin-top":"24px","flex-direction":"column","align-items":"flex-end"}},J={key:0},R=["src"],z=["innerHTML"],D={key:1},$={class:"dark:bg-[#19191B] bg-[#F8F9F9]",style:{padding:"8px","border-radius":"8px",display:"flex","align-items":"center"}},K={key:0,style:{"background-color":"#10a37f",padding:"4px","border-radius":"4px",display:"flex"}},P=[U((()=>m("img",{style:{width:"30px",height:"30px"},src:"/static/svg/file-16b3e23d.svg",alt:""},null,-1)))],Q={style:{"margin-left":"5px"}},V={style:{"font-size":"15px"}},W={key:0,style:{"font-size":"12px"}},X=["innerHTML"],Y={key:2},Z=["innerHTML"],ee={key:3},te=["innerHTML"],le={style:{"margin-top":"24px",display:"flex","align-items":"flex-start","flex-direction":"column"}},ae={style:{display:"flex","align-items":"flex-start"}},ne={class:"border dark:border-[#25262A] border-[#EAEAEA]",style:{"border-radius":"50%",width:"34px",height:"34px"}},ie=["src"],se={key:0,class:"chatLeft"},oe=["innerHTML"],re={style:{display:"flex","align-items":"center","margin-top":"12px","margin-left":"45px"}},ue=["onClick"],ce={key:0,src:"/static/svg/copyBtn-00ccc1be.svg",alt:""},de={key:1,src:"/static/svg/copyBtn copy-6bf79128.svg",alt:""},ge=U((()=>m("span",null,"复制",-1))),ve=["onClick"],pe={key:0,src:"/static/svg/refresh-719a54ac.svg",alt:""},fe={key:1,src:"/static/svg/refresh copy-4bbd102c.svg",alt:""},me=U((()=>m("span",null,"刷新",-1))),he=["onClick"],xe={key:0,src:"/static/svg/delet-4ab48311.svg",alt:""},ye={key:1,src:"/static/svg/delet copy-1e1716eb.svg",alt:""},be=U((()=>m("span",null,"删除",-1))),ke={class:"AItip dark:bg-[#222325] bg-[#F0F0F0]"},Ie={style:{display:"flex","align-items":"center"}},Se={key:0,src:"/static/svg/tip-01b599c6.svg",alt:""},Oe={key:1,src:"/static/svg/tip copy-d2ba358b.svg",alt:""},we={style:{"margin-left":"4px"},class:"text-[#8B8C8C] dark:text-[#6C6E79]"},Le={class:"sticky bottom-0 left-0 flex justify-center"},Ce=U((()=>m("p",{style:{"margin-left":"8px"}},"停止输出",-1))),Te=H(i({__name:"haveChatLog",props:{chatLogList:Array,appItem:Object,handleSubmit:String},emits:["changeChatLog","isSuccess"],setup(n,{emit:i}){const{addGroupChat:B,updateGroupChat:F,updateGroupChatSome:H}=G(),U=e(),Te=s([]),Be=l(),Fe=o(),Ne=r(),Ae=a((()=>"dark"===Ne.theme)),He=u(),{usingContext:_e,toggleUsingContext:Me}=M(),Ge=a((()=>Be.chatList)),je=s(!1),Ue=n;function qe(e){Te.value=e.filter((e=>null!=e.conversationOptions)),0!=Te.value.length?(Te.value.forEach((e=>{let{prompt:t}=e.requestOptions,{text:l}=e;null!=l&&(e.text=v(l),-1!=t.indexOf("png")||-1!=t.indexOf("jpeg")||-1!=t.indexOf("jpg")?(e.fileSrc=t.split(" ")[0],e.fileText=t.split(" ")[1]):-1!=t.indexOf("http")&&(-1!=t.split(" ")[0].indexOf("http")?e.fileSrc1=t.split(" ")[0]:e.fileSrc1="",e.fileText1=t.split(" ")[1]))})),setTimeout((()=>{at()}),100)):c.emit("notData",Te.value)}Ue.appItem&&(Ue.appItem.config?je.value=!1:je.value=!0),c.on("chatLogList",(e=>{qe(e)}));const Ee=i;d(Te,(async e=>{await N(),setTimeout((()=>{const e=document.getElementsByClassName("markdown-body-generate");for(let t=0;t<e.length;t++){const l=e[t].getElementsByTagName("p");for(let e=0;e<l.length;e++)l[e].style.lineHeight="25px"}}),3e3)}),{immediate:!0,deep:!0}),d(Ue,(e=>{e.handleSubmit&&(c.emit("haveLog",!0),tt(e.handleSubmit))})),d((()=>Ue.chatLogList),((e,t)=>{console.log(e,"newValue",t),String(e)!==String(t)&&(console.log(11111111),qe(Ue.chatLogList))}),{immediate:!0});const Je=s(""),Re=s("");if(g({keys:["dialogueTail","robotAvatar"]}).then((e=>{Je.value=e.data.dialogueTail,Re.value=e.data.robotAvatar})),c.on("uuid",(e=>{let t;e.config&&(t=JSON.parse(e.config).modelInfo.modelType),e.gptsApp?je.value=!0:je.value="app"==t})),localStorage.getItem("chatLogId")){let e,t=JSON.parse(localStorage.getItem("chatLogId"));t.config&&(e=JSON.parse(t.config).modelInfo.modelType),t.gptsApp||"app"==e?je.value=!0:je.value=!1}v.setOptions({pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});const ze=s(""),De=s(!1),{usingNetwork:$e}=j(),Ke=s(!1),Pe=s(!0),Qe=a((()=>Be.active)),Ve=a((()=>Be.groupList.find((e=>e.uuid===Qe.value)))),We=a((()=>Ge.value.filter((e=>!e.inversion&&!e.error))));let Xe=new AbortController;const Ye=a((()=>Number(null==Be?void 0:Be.activeModelKeyType)));c.on("sendGuide",(e=>{c.emit("haveLog",!0),e.isApp&&(je.value=!0),tt(e.msg)}));const Ze=s("");d(Ze,(e=>{let t=lt.value;t.scrollTop=t.scrollHeight}));const et=s();async function tt(e){var l;console.log(e,"msg");let a="",n="",i="",s="";if(-1!=(null==e?void 0:e.indexOf("http"))){let t=null==e?void 0:e.split(" ")[0];-1!=(null==t?void 0:t.indexOf("png"))||-1!=(null==t?void 0:t.indexOf("jpeg"))||-1!=(null==t?void 0:t.indexOf("jpg"))?(i=null==e?void 0:e.split(" ")[0],a=null==e?void 0:e.split(" ")[1]):(s=-1!=e.split(" ")[0].indexOf("http")?null==e?void 0:e.split(" ")[0]:"",n=null==e?void 0:e.split(" ")[1])}let o=e||ze.value;if(De.value)return;if(Xe=new AbortController,!o||""===o.trim())return;v.setOptions({pedantic:!1,gfm:!0,breaks:!1,sanitize:!1,smartLists:!0,smartypants:!1,xhtml:!1});let r={dateTime:(new Date).toLocaleString(),text:"AI思考中",inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:null},fileText:a,fileText1:n,fileSrc:i,fileSrc1:s};Te.value=Te.value.length>0?[...Te.value,r]:[r],setTimeout((()=>{at()}),100),c.emit("sendSuccess"),Ee("isSuccess",!0);let u={};u=je.value?{groupId:+Qe.value,usingNetwork:$e.value,type:"gpts"}:{groupId:+Qe.value,usingNetwork:$e.value};const d=null==(l=We.value[We.value.length-1])?void 0:l.conversationOptions;d&&_e.value&&!$e.value&&(u={groupId:d.groupId,usingNetwork:d.usingNetwork,...u});let g="",f="",m=0,h=null;Ke.value=!0;let x={};He.updateIsChatIn(!0);try{const e=async()=>{et.value=setInterval((async()=>{var e;if(De.value=!0,g&&g[m]&&f.length<g.length&&(f+=g[m]),g&&g[m]){Pe.value=!1;const e=Te.value.length>0?Te.value.length-1:Te.value.length;Te.value[e]&&(Te.value[e].text=f,Te.value[e].text=v(Te.value[e].text)),Ze.value=f,m++}if(!Ke.value&&f.length>=g.length&&(Ze.value="",c.emit("getUserInfo",!0),c.emit("updateMessageList",!0),c.emit("updateModelList",!0),m=0,f="",et.value&&clearInterval(et.value),et.value=null,De.value=!1,Pe.value=!0,H(Ge.value.length-1,{loading:!1}),He.updateIsChatIn(!1),x&&Fe.updateUserBanance(x),2===Ge.value.length&&!(null==(e=null==Ve?void 0:Ve.value)?void 0:e.appId))){const e=Ge.value[1].text.length>15?Ge.value[1].text.slice(0,15):Ge.value[1].text;await Be.updateGroupInfo({groupId:+Qe.value,title:e}),await Be.queryMyGroup()}}),16),await p({prompt:o,appId:Ve.value?Ve.value.appId:0,options:u,signal:Xe.signal,onDownloadProgress:({event:e})=>{var t;setTimeout((()=>{at()}),100);const l=e.target,{responseText:a}=l;if([1].includes(Ye.value)){const e=a.lastIndexOf("\n",a.length-2);let t=a;-1!==e&&(t=a.substring(e));try{h=JSON.parse(t)}catch(n){t.includes("OpenAI timed out waiting for response")&&U.warning("会话超时了、告知管理员吧~~~")}}if([2,3].includes(Ye.value)){const e=a.toString().split("\n").filter((e=>""!==e.trim()));let t="",l={};for(const a of e)try{const e=JSON.parse(a);t=e.text,l=e}catch(n){}l.result=t,h=l}if([4].includes(Ye.value)){const e=a.lastIndexOf("\n",a.length);let t=a;-1!==e&&(t=a.substring(e));try{h=JSON.parse(t)}catch(n){t.includes("xunfeizhipu timed out waiting for response")&&U.warning("会话超时了、告知管理员吧~~~")}}try{if([1].includes(Ye.value)&&(g=h.text,Ke.value=!h.is_end,(null==(t=null==h?void 0:h.detail)?void 0:t.usage)&&(Pe.value=h.is_end,x=null==h?void 0:h.userBanance)),[2,3].includes(Ye.value)){const{result:e,is_end:t}=h;g=e,Ke.value=!t,(null==h?void 0:h.userBanance)&&(x=null==h?void 0:h.userBanance)}if([4].includes(Ye.value)){const{text:e,is_end:t}=h;g=e,Ke.value=!t,(null==h?void 0:h.userBanance)&&(x=null==h?void 0:h.userBanance)}}catch(n){console.log(n)}}})};await e()}catch(y){if(!y)return;const e=Te.value.length>0?Te.value.length-1:Te.value.length;Te.value[e].text=y.message,He.updateIsChatIn(!1),clearInterval(et.value),Ke.value=!1,(402===y.code||(null==y?void 0:y.message.includes("余额不足"))||(null==y?void 0:y.message.includes("免费额度已经使用完毕")))&&He.updateVipDialog(!0);let l=(null==y?void 0:y.message)??t("common.wrong");if("Request failed with status code 401"===l&&(l="非法操作、请先登录后再进行问答使用！"),null==y?void 0:y.message.includes("canceled"))return H(Ge.value.length-1,{loading:!1}),void setTimeout((()=>{Fe.getUserBalance()}),200);const a=Ge.value[Ge.value.length-1];if((null==a?void 0:a.text)&&""!==a.text)return void H(Ge.value.length-1,{text:`${"AI思考中"===a.text?"":a.text}\n[${l}]`,error:!1,loading:!1});F(Ge.value.length-1,{dateTime:(new Date).toLocaleString(),text:l,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...u}}})}finally{De.value=!1,Ke.value=!1}}const lt=s(null);function at(){let e=lt.value;e&&e.scrollTo({top:e.scrollHeight+e.clientHeight,behavior:"smooth"})}function nt(){De.value&&(Xe.abort(),De.value=!1,Ke.value=!1,Pe.value=!0,clearInterval(et.value))}return(e,t)=>(I(),f("div",q,[m("div",{class:"chatLogBox",ref_key:"toTop",ref:lt},[(I(!0),f(h,null,x(Te.value,(e=>(I(),f("div",{class:"LogItem",key:e.chatId},[m("div",E,[""!=e.fileSrc?(I(),f("div",J,[m("img",{style:{width:"150px",height:"auto"},src:e.fileSrc,alt:""},null,8,R),e.fileText?(I(),f("div",{key:0,class:"chatRight1 dark:bg-[#222325] bg-[#F0F0F0] markdown-body-generate",innerHTML:e.fileText},null,8,z)):k("",!0)])):k("",!0),e.fileSrc1&&-1!=e.fileSrc1.indexOf("/ai/")?(I(),f("div",D,[m("div",$,[-1!=e.fileSrc1.indexOf("/ai/")?(I(),f("div",K,P)):k("",!0),m("div",Q,[m("p",V,S(e.fileSrc1.split("/ai/")[1]),1),""!=e.fileSrc1&&-1!=e.fileSrc1.indexOf("/ai/")?(I(),f("p",W,S(e.fileSrc1.split("/ai/")[1].split(".")[1]),1)):k("",!0)])]),e.fileText1?(I(),f("div",{key:0,class:"chatRight1 dark:bg-[#222325] bg-[#F0F0F0] markdown-body-generate",innerHTML:e.fileText1},null,8,X)):k("",!0)])):k("",!0),e.fileSrc1?(I(),f("div",Y,[!e.fileSrc1&&!e.fileSrc||-1==e.fileSrc1.indexOf("/ai/")?(I(),f("div",{key:0,class:"chatRight dark:bg-[#222325] bg-[#F0F0F0]",innerHTML:e.requestOptions.prompt},null,8,Z)):k("",!0)])):(I(),f("div",ee,[!e.fileSrc1&&!e.fileSrc||-1==e.fileSrc.indexOf("/ai/")?(I(),f("div",{key:0,class:"chatRight dark:bg-[#222325] bg-[#F0F0F0]",innerHTML:e.requestOptions.prompt},null,8,te)):k("",!0)]))]),m("div",le,[m("div",ae,[m("div",ne,[m("img",{src:Re.value,alt:""},null,8,ie)]),null==e.text||""==e.text?(I(),f("div",se," 接口错误，请联系管理员处理~ ")):(I(),f("div",{key:1,class:"chatLeft markdown-body-generate",innerHTML:e.text,style:{"line-height":"15px","margin-top":"13px"}},null,8,oe))]),m("div",re,[m("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>function(e){if(e.text){const{text:t}=e;_({text:t}),U.success("复制成功")}else U.error("复制失败")}(e)},[y(b(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:w((()=>[Ae.value?(I(),f("img",ce)):(I(),f("img",de))])),default:w((()=>[ge])),_:1},8,["style"])],10,ue),m("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>function(e){const{prompt:t}=e.requestOptions;tt(t)}(e)},[y(b(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:w((()=>[Ae.value?(I(),f("img",pe)):(I(),f("img",fe))])),default:w((()=>[me])),_:1},8,["style"])],10,ve),m("div",{style:{display:"flex","align-items":"center",cursor:"pointer",padding:"4px"},class:O(Ae.value?"handleIcon":"handleIcon1"),onClick:t=>async function(e){let t={id:e.chatId};await A(t).then((t=>{Te.value=Te.value.filter((t=>t.chatId!=e.chatId)),U.success("删除成功")})).catch((e=>{U.error("删除失败")})),0==Te.value.length&&(console.log("暂无数据"),c.emit("haveLog",!1))}(e)},[y(b(C),{trigger:"hover",placement:"bottom",style:L([{"border-radius":"8px"},Ae.value?"background:#fff;color:#000":"background:#000;color:#fff;"])},{trigger:w((()=>[Ae.value?(I(),f("img",xe)):(I(),f("img",ye))])),default:w((()=>[be])),_:1},8,["style"])],10,he),m("div",ke,[m("div",Ie,[Ae.value?(I(),f("img",Se)):(I(),f("img",Oe))]),m("p",we,S(Je.value),1)])])])])))),128)),m("div",Le,[De.value?(I(),f("div",{key:0,onClick:nt,class:"stopBox"},[y(b(T),{icon:"ri:stop-circle-line"}),Ce])):k("",!0)])],512)]))}}),[["__scopeId","data-v-e79ec51e"]]),Be="/static/svg/sendBox_2 copy-a52e6131.svg",Fe="/static/svg/sendBox_3-8999da18.svg";export{Be as _,Fe as a,G as b,j as c,Te as h,M as u};
