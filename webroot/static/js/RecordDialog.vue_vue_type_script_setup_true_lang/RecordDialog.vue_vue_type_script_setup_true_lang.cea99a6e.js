import{a6 as e,ar as t,Z as a,g as i,p as s,r as n,cr as o,e as l,k as r,bN as c,w as u,O as h,D as d,B as v,y as p,x as f,C as m,F as w,E as g,a3 as y,A as x,z as k,ak as b,R as M,cs as C,a2 as R,G as D,n as P}from"../main-b114ff11.js";import{S as T}from"../index/index.8a2765df.js";import{N as A,a as S}from"../DrawerContent/DrawerContent.d6b8ca84.js";const{isMobile:F}=e(),q=t(),z=a();i((()=>q.recordDialog));var I=(e=>(e[e.none=0]="none",e[e.listening=1]="listening",e[e.thinking=2]="thinking",e[e.speaking=3]="speaking",e[e.error=4]="error",e))(I||{});const _=()=>{const e=s(),t=i((()=>z.theme)),a=n("alloy"),l=n(!1),r=n(0),c=n(),u=n(),h=n(),d=new Map;let v;const p=n(),f=n([]),m=n();let w=0,g=null,y=null;const x=new AbortController,k=async()=>{const e=h.value;if(!e||!e.getContext)return!1;const a=e.getContext("2d");let i=e.width=F.value?window.innerWidth:608,s=e.height=F.value?window.innerHeight/2:415;window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,17)};let n=[];const o="waiting gpt thinking",l=20;function r(e,t,a,i){this.ctx=e,this.init(t,a,i)}r.prototype.init=function(e,a,i){this.x=e,this.y=a,this.r=i,this.v=1,this.a=0,this.rad=this.a*Math.PI/180,this.points=[],this.setPoints(),this.c={r:"dark"===t.value?255:120,g:"dark"===t.value?255:197,b:"dark"===t.value?255:247}},r.prototype.setPoints=function(){for(let a=0;a<l;a++){let a=[Math.cos(this.rad)*this.r,Math.sin(this.rad)*this.r,(e=0,t=360,Math.floor(Math.random()*(t-e+1)+e))];this.points.push(a),this.a+=18,this.rad=this.a*Math.PI/180}var e,t},r.prototype.draw=function(){const e=this.ctx;e.save(),e.fillStyle="rgb("+this.c.r+", "+this.c.g+", "+this.c.b+")",e.beginPath(),e.translate(this.x,this.y),e.rotate(3*Math.sin(this.rad)),e.translate(-this.x,-this.y);const t=(this.points[0][0]+this.points[19][0])/2+this.x,a=(this.points[0][1]+this.points[19][1])/2+this.y;e.moveTo(t,a);for(let i=1;i<this.points.length-1;i++){let t=(this.points[i][0]+this.points[i+1][0])/2,a=(this.points[i][1]+this.points[i+1][1])/2;e.quadraticCurveTo(this.points[i][0]+this.x,this.points[i][1]+this.y,t+this.x,a+this.y)}e.quadraticCurveTo(this.points[19][0]+this.x,this.points[19][1]+this.y,t,a),e.closePath(),e.fill(),e.restore(),e.save(),e.fillStyle="transparent",e.translate(this.x,this.y),e.rotate(3*Math.sin(this.rad)),e.translate(-this.x,-this.y);for(let i=0;i<20;i++)e.save(),e.translate(1*this.points[i][0]+this.x,1*this.points[i][1]+this.y),e.rotate((18*i+90)*Math.PI/180),e.translate(-this.points[i][0]-this.x,-this.points[i][1]-this.y),e.fillText(o[i],1*this.points[i][0]+this.x,1*this.points[i][1]+this.y),e.restore();e.restore()},r.prototype.transform=function(){for(let e=0;e<this.points.length;e++)this.points[e][0]-=Math.sin(this.points[e][2]*Math.PI/180*5),this.points[e][1]-=Math.cos(this.points[e][2]*Math.PI/180*8),this.points[e][2]-=this.v},r.prototype.updateParams=function(){this.a+=.3,this.rad=this.a*Math.PI/180},r.prototype.resize=function(){this.x=i/2,this.y=s/2},r.prototype.render=function(){this.updateParams(),this.transform(),this.draw()};for(let t=0;t<1;t++)n.push(new r(a,i/2,s/2,110));!function e(){a.clearRect(0,0,i,s);for(let t=0;t<n.length;t++)n[t].render(t);requestAnimationFrame(e)}(),window.addEventListener("resize",(function(){!function(){i=e.width=F.value?window.innerWidth:608,s=e.height=F.value?window.innerHeight/2:415;for(let e=0;e<n.length;e++)n[e].resize()}()})),window.onunload=()=>{window.removeEventListener("resize",(()=>{}))}},b=async()=>{if(!location.protocol.includes("https"))return Promise.reject("录音功能必须要https协议");await C(),await k()},M=e=>{let t=window.AudioContext||window.webkitAudioContext;m.value=new t;let a=m.value.createMediaStreamSource(e),i=m.value.createGain();a.connect(i);let s=m.value.createAnalyser();s.fftSize=256;let n=s.frequencyBinCount;v=new Uint8Array(n),a.connect(s);const o=m.value.createScriptProcessor(2048,1,1);o.onaudioprocess=function(e){let t=e.inputBuffer.getChannelData(0),a=0;for(let s=0;s<t.length;s++)a<t[s]&&(a=t[s]);const i=Math.round(100*a);w=i;const{width:n,height:o}=c.value;u.value.clearRect(0,0,n,o),s.getByteFrequencyData(v);const l=v.length/30,r=n/l/2;u.value.fillStyle="#78c5f7";for(let s=0;s<l;s++){const e=v[s]/255*o*.5,t=s*r+n/2,a=n/2-(s+1)*r,i=o/2;u.value.fillRect(t,i,Math.ceil(r-10),e),u.value.fillRect(t,i,Math.ceil(r-10),-e),u.value.fillRect(a,i,Math.ceil(r-10),e),u.value.fillRect(a,i,Math.ceil(r-10),-e)}if(i<2){d.has("timer")||(d.set("timer",!0),g=setTimeout((()=>{d.delete("timer"),w>2?(console.log("检测到声音大于阈值，有人说话，清理定时器"),g&&clearTimeout(g)):(y&&clearTimeout(y),y=setTimeout((async()=>{w>2?(y&&clearTimeout(y),console.log("检测到声音大于阈值，有人说话，清理定时器"),g&&clearTimeout(g)):(await P(2),console.log("说话结束，清除所有定时器"))}),1400))}),2800))}else d.delete("timer"),g&&clearTimeout(g),y&&clearTimeout(y)},i.connect(o),o.connect(m.value.destination)};const C=async()=>{const e=c.value;if(!e)return;u.value=e.getContext("2d");const t=F.value?4:8,a=F.value?8:4;e.width=window.innerWidth/t*devicePixelRatio,e.height=window.innerHeight/a*devicePixelRatio;const i=navigator.mediaDevices.getUserMedia||navigator.mediaDevices.webkitGetUserMedia||navigator.mediaDevices.mozGetUserMedia||navigator.mediaDevices.msGetUserMedia;if(f.value=[],!i)return!1;await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,noiseSuppression:!0,echoCancellation:!0,frameRate:16,sampleRate:48e3,sampleSize:1}}).then((e=>{var t;t=e,p.value=new MediaRecorder(t),p.value.ondataavailable=e=>{f.value.push(e.data)},p.value.onstop=async()=>{console.log("录音已经停止");const e=new Blob(f.value,{type:"audio/wav"});await R(e)},p.value.start(),M(e)})).catch((e=>{console.error(e)}))},R=async t=>{const i=new FormData;i.append("file",new File([t],Date.now()+"record.wav")),i.append("voice",a.value);const s=x.signal;await o(i,s).catch((t=>{D(),t&&"CanceledError: canceled"!==t.message&&e.error(t.message||"")}))},D=()=>{var e,t;l.value=!1,g&&clearTimeout(g),p.value&&(null==(e=p.value)||e.stop()),m.value&&(null==(t=m.value)||t.close())},P=async e=>{r.value=e,D(),(()=>{const{width:e,height:t}=c.value;u.value.clearRect(0,0,e,t)})()};return{voice:a,isListen:l,listenStatus:r,recordingRef:c,playVoiceRef:h,controller:x,hasMicrophone:async()=>{const e=await navigator.mediaDevices.enumerateDevices();return 0!==e.length&&e.some((e=>"audioinput"===e.kind&&"default"!=e.deviceId&&"communications"!=e.deviceId))},initAndStart:b,stop:P,restart:async()=>{g&&clearTimeout(g),l.value=!0,r.value=1,f.value=[],await b()},getRecordedVoice:async()=>new Blob(f.value,{type:"audio/ogg; codecs=opus"})}},j={key:0},B={class:"flex flex-col"},U=["onClick"],E={key:0,class:"absolute right-2 top-[5px]"},G={class:"text-md"},L={key:1},V={class:"px-2"},H={class:"flex flex-col"},W=["onClick"],K={key:0,class:"absolute right-2 top-[5px]"},N={class:"text-md"},O={class:"h-full transition-all"},Z={class:"h-full overflow-hidden"},J={class:"flex flex-col justify-center items-center mt-10"},Q={class:"select-none ml-1"},X={class:"px-4 flex flex-col items-center"},Y={class:"w-full h-auto"},$={class:"flex flex-col justify-end"},ee={class:"flex justify-center items-center"},te={class:"text-center"},ae={class:"flex justify-around items-center w-full mt-8"},ie=l({__name:"RecordDialog",props:{visible:{type:Boolean}},emits:["submit"],setup(o,{emit:l}){const{isMobile:F}=e(),q=r(),z=s(),ie=a();i((()=>ie.theme));const se=t(),ne=n(!0);e(),c();const oe=n(!1),{initAndStart:le,stop:re,controller:ce,hasMicrophone:ue,voice:he,isListen:de,listenStatus:ve,recordingRef:pe,playVoiceRef:fe}=_(),me=i((()=>q.userInfo.avatar)),we=i((()=>q.userInfo.username)),ge=()=>{re(I.none),ne.value=!0,de.value=!1,ve.value=0},ye=()=>{if(de.value&&ve.value!==I.none)return re(I.none),void ce.abort();de.value=!de.value,ve.value===I.none&&(ve.value=I.listening),de.value&&le().catch((e=>{z.error(e)})),!de.value&&re(I.none)},xe=i((()=>ve.value===I.listening?"聆听中...":ve.value===I.thinking?"思考中...":ve.value===I.speaking?"回答中...":ve.value===I.none?"点击左下角开始，右下角选择音色":"对话出错，请再说一遍试试")),ke=()=>{de.value=!1,re(I.none),ce.abort(),se.updateRecordDialog(!1)},be=()=>{P().then((()=>{(async()=>{await ue()?(de.value=!1,ve.value=1,ye()):z.error("未检测到麦克风，请插入麦克风等音频输入设备。")})()}))},Me=[{value:"alloy"},{value:"echo"},{value:"fable"},{value:"onyx"},{value:"nova"},{value:"shimmer"}];return(e,t)=>(u(),h(p(b),{show:e.visible,style:D([{width:"100%","max-width":"640px"},[p(F)?"height: 100vh":"height: auto"]]),"on-after-enter":be,"on-after-leave":ge},{default:d((()=>[v("div",{class:R(["bg-white rounded dark:bg-gradient-to-b from-[#262643] to-[#0C0C16]",[p(F)?"":"pb-8"]])},[p(F)?(u(),f("div",L,[m(p(S),{show:oe.value,"onUpdate:show":t[1]||(t[1]=e=>oe.value=e),"mask-closable":!1,placement:"bottom",class:"!h-[45vh]",style:{"--n-body-padding":"0"}},{default:d((()=>[m(p(A),{class:"mydrawer"},{default:d((()=>[v("div",V,[t[4]||(t[4]=v("p",{class:"mt-4"},"选择音调",-1)),v("ul",H,[(u(),f(w,null,g(Me,(e=>v("li",{class:"relative my-1 leading-8 dark:bg-[#262643] px-2 cursor-pointer",onClick:t=>(e=>{he.value=e.value,oe.value=!1})(e)},[e.value===p(he)?(u(),f("div",K,[m(p(y),{icon:"gravity-ui:check",class:"text-xl"})])):x("",!0),v("p",N,k(e.value),1)],8,W))),64))])])])),_:1})])),_:1},8,["show"])])):(u(),f("div",j,[m(p(b),{show:oe.value,preset:"dialog","show-icon":!1,onClose:t[0]||(t[0]=e=>oe.value=!1),style:{width:"60%","max-width":"500px"}},{default:d((()=>[v("div",null,[t[3]||(t[3]=v("p",null,"选择音调",-1)),v("ul",B,[(u(),f(w,null,g(Me,(e=>v("li",{class:"relative my-1 leading-8 dark:bg-[#262643] px-2 cursor-pointer",onClick:t=>he.value=e.value},[e.value===p(he)?(u(),f("div",E,[m(p(y),{icon:"gravity-ui:check",class:"text-xl"})])):x("",!0),v("p",G,k(e.value),1)],8,U))),64))])])])),_:1},8,["show"])])),v("div",O,[v("div",Z,[v("div",J,[m(p(C),{size:64,src:me.value,round:"",bordered:"","fallback-src":p(M),class:"cursor-pointer"},null,8,["src","fallback-src"]),v("p",Q,k(we.value),1)]),v("div",X,[v("div",Y,[v("canvas",{class:"h-[45vh] w-full",ref_key:"playVoiceRef",ref:fe},null,512)]),v("div",$,[v("canvas",{class:"h-[50px] w-full",ref_key:"recordingRef",ref:pe},null,512),v("div",ee,[p(de)&&1===p(ve)?(u(),h(p(y),{key:0,icon:"streamline:voice-mail"})):x("",!0),v("p",te,k(xe.value),1)])])]),v("div",ae,[m(p(y),{icon:p(de)?"heroicons-solid:stop":"gridicons:pause",class:"text-[28px] cursor-pointer",onClick:ye},null,8,["icon"]),v("div",{class:"darK:bg-[red] bg-[#d81e6] text-[#d81e6] dark:text-[#fff]",onClick:ke},[m(p(T),{name:"icon_cancel",class:"text-[44px] cursor-pointer darK:bg-[red] bg-[#d81e6]"})]),m(p(y),{icon:"ep:set-up",class:"text-[24px] cursor-pointer",onClick:t[2]||(t[2]=e=>oe.value=!0)})])])])],2)])),_:1},8,["show","style"]))}});export{ie as _};
