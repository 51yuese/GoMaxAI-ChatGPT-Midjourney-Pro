import{_ as a,u as e,r as t,q as n,s as l,a8 as o,B as s,a1 as i,F as r,m as u,p as c,b as d,w as v,X as p,a9 as m,a4 as f,Y as g,a0 as h,i as y,G as _,a as j,d as w,H as C,I as b,J as k,L as x,a5 as R,a7 as I,ak as O,U as z,au as A,v as L,aL as S,e as E,t as K,j as P}from"./index-5HZnFt5a.js";import{_ as q}from"./z-paging.B8jSxtUa.js";import{_ as D}from"./dot.DpsQkUPS.js";import{_ as B,c as F,d as U,j as V,a as G,m as H,s as J}from"./chat-item.Bfa0bW6i.js";import{p as M,c as N}from"./chat-input.DeV8qM2T.js";import{m as T}from"./my-item.AXCVt8MA.js";import{a as Y}from"./apps.NDkBLVtm.js";import{c as $}from"./chat.Ba42RxGW.js";import"./zero-markdown-view.36PbCcI6.js";import"./uv-loading-icon.D2OVaaMI.js";import"./sound-pay.Vvxa2jSR.js";import"./digital-man.CbE7ZGLY.js";import"./dialog.CErO1ANM.js";import"./new.BGSq1aH5.js";import"./dump.dPDEymx_.js";import"./index.BIXFsUHK.js";import"./addChat.DRTE-l9I.js";import"./uni-icons.mAW8qLNS.js";import"./air.BsGE5UBU.js";const Q=a({__name:"apps",setup(a){const{t:Q}=e(),X=t(""),Z=t(null),W=t(null),aa=t(null),ea=t(""),ta=t("APPS_CHAT_GROUP"),na=n(),la=l((()=>{var a;return!!(null==(a=na.userInfo)?void 0:a.id)})),oa=t({}),sa=t(""),ia=t([]),ra=t([]),ua=async()=>{var a;const e=ea.value;if(h(e))return;const{data:t}=await Y.chatListAsync({page:1,size:999,conversationId:e}),n=f(t.rows).reverse();for(let l=0;l<n.length;l++)null==(a=W.value)||a.addChatRecordData(n[l])},ca=t(!1),da=async a=>{var e,t,n;if(!la.value)return void R();let l=ea.value;if(h(l)){const{data:e}=await Y.createConversation({botId:X.value,name:a.substring(0,20)});l=m(e).conversationId,ea.value=l}null==(e=W.value)||e.addChatRecordData({content:a,type:"question"}),null==(t=W.value)||t.addChatRecordData({content:Q("chat.index.content"),type:"answer"}),ca.value=!0,null==(n=Z.value)||n.setLoading(!0);const o={conversationId:l,content:a},{code:s,data:i,error:r}=await $.beforeStartChatAsync(o);if(200!==s||!i)return ra.value[0].content=r.message||Q("chat.index.message"),void ga();const u=I("token");aa.value.startChat({url:O+"/api/coze/startChat",headers:{Authorization:`Bearer ${u}`,"Content-Type":"application/json"},body:o})},va=()=>{ra.value[0].content=""},pa=a=>{var e;const t=null==(e=ra.value[0])?void 0:e.content;h(t)&&(ra.value[0].content=Q("chat.index.error")),z({title:a,icon:"none"}),ga()},ma=t([]),fa=a=>{ma.value.push(a),ba()},ga=()=>{var a,e;ca.value=!1,null==(a=Z.value)||a.setLoading(!1),null==(e=aa.value)||e.stopChat()},ha=()=>{var a,e,t;ca.value?(ca.value=!1,null==(a=Z.value)||a.setLoading(!1),null==(e=aa.value)||e.stopChat()):(ca.value=!1,null==(t=Z.value)||t.setLoading(!1))},ya=()=>{ua()},_a=()=>{ra.value=[],ea.value=""},ja=async()=>{const a=ea.value;if(h(a))return void z({title:Q("chat.index.noContent"),icon:"none"});await A({title:Q("app.tip.title"),content:Q("apps.chat.clear"),confirmColor:"#10A37F"})&&(await Y.clear({conversationId:a}),ra.value=[],ea.value="")},wa=async a=>{if(ra.value[0].id=a.id,"function_call"===a.type)try{const e=JSON.parse(a.content);e.plugin&&(ra.value[0].contentObject=[{content:{plugin_name:i(null==e?void 0:e.plugin)}}])}catch(e){}else if(a.content)for(const t of a.content)ra.value[0].content+=i(t),await J(10);a.isError&&(ra.value[0].content=Q("chat.index.apiError"),ga()),a.isEnd&&ga()},Ca=t(!1),ba=async()=>{const a=U((()=>{Ca.value||(async()=>{if(!(Ca.value||ma.value.length<=0))try{for(Ca.value=!0;ma.value.length>0;){const{data:a,type:e}=ma.value[0];if("h5"===e){const e=V(a);console.log(e),await wa(e)}else if("mp"===e){const e=(await G(a)).trim().split("\n").filter((a=>""!==a.trim())),t=await H(e);await wa(t)}ma.value.shift()}}catch(a){console.log(a.message),z({title:Q("app.tip.error"),icon:"none"})}finally{Ca.value=!1}})()}),50);L((()=>ma.value.length),a)};return o((()=>{ha()})),s((({id:a,cid:e})=>{X.value=i(a),ea.value=i(e),(async()=>{p({title:Q("app.loading"),mask:!0});const{data:a}=await Y.getBotAsync({botId:X.value}),e=m(a);oa.value=e;const t=m(e.onboardingInfo);sa.value=i(t.prologue),ia.value=f(t.suggested_questions),g()})(),ua()})),(a,e)=>{const t=r("ai-bindphone"),n=r("ai-privacy"),l=S,o=y,s=P,i=u(c("uv-icon"),_),p=u(c("z-paging"),q);return j(),d(o,{class:"dialog-chat-apps-page"},{default:v((()=>[w(t,{ref:"aiPrivacyRef"},null,512),w(n,{ref:"aiPrivacyRef"},null,512),w(p,{ref_key:"pagingRef",ref:W,modelValue:ra.value,"onUpdate:modelValue":e[0]||(e[0]=a=>ra.value=a),"default-page-size":99999,"use-chat-record-mode":"","auto-to-bottom-when-chat":"","refresher-enabled":!1,"loading-more-enabled":!1,"hide-empty-view":"","chat-loading-more-default-as-loading":!1,auto:!1},{top:v((()=>[w(M,{data:oa.value,onClear:ja,onCreate:_a},null,8,["data"])])),bottom:v((()=>[w(N,{ref_key:"inputRef",ref:Z,chatKey:ta.value,data:oa.value,onSend:da,onClear:ja,onCancel:ha,onCreate:_a},null,8,["chatKey","data"])])),default:v((()=>[w(o,{class:"main-box"},{default:v((()=>[ra.value.length<=0&&ia.value.length>0&&sa.value?(j(),d(o,{key:0,class:"chat-card"},{default:v((()=>[w(o,{class:"title"},{default:v((()=>[w(l,{nodes:sa.value},null,8,["nodes"])])),_:1}),w(o,{class:"cell-item"},{default:v((()=>[(j(!0),C(k,null,b(ia.value,((a,e)=>(j(),d(o,{key:e,class:"item",onClick:e=>da(a)},{default:v((()=>[w(s,{src:D,class:"icon"}),w(o,{class:"content"},{default:v((()=>[E(K(a),1)])),_:2},1024),w(i,{name:"arrow-right",size:"14",color:"#000"})])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})):x("",!0),(j(!0),C(k,null,b(ra.value,((a,e)=>(j(),C(k,{key:e},["question"===a.type?(j(),d(o,{key:0,class:"chat-item my-message"},{default:v((()=>[w(T,{text:a.content},null,8,["text"])])),_:2},1024)):(j(),d(o,{key:1,class:"chat-item answer-message"},{default:v((()=>[w(F,{data:oa.value,message:a,text:a.content,loading:0===e&&ca.value,onDelete:ya,onRefresh:a=>(a=>{const e=ra.value[a+1];da(null==e?void 0:e.content)})(e)},null,8,["data","message","text","loading","onRefresh"])])),_:2},1024))],64)))),128))])),_:1})])),_:1},8,["modelValue"]),w(B,{ref_key:"chatSSERef",ref:aa,groupKey:ta.value,onOnOpen:va,onOnError:pa,onOnMessage:fa,onOnFinish:ga},null,8,["groupKey"])])),_:1})}}},[["__scopeId","data-v-b5779e78"]]);export{Q as default};
