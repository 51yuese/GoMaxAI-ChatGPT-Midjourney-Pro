import{_ as e,a as t,b as a,i as n,l as s,s as o,r,o as l,m as i,n as d,p as c,G as u,w as h,g as p,L as m,d as g,e as f,t as y,M as v,H as w,J as b,a7 as x,ay as k,X as j,Y as C,c as _,h as O}from"./index-5HZnFt5a.js";import{_ as T}from"./zero-markdown-view.36PbCcI6.js";import{_ as $}from"./uv-loading-icon.D2OVaaMI.js";import{d as z}from"./dialog.CErO1ANM.js";function I(e){let t,a,n,s=!1;return function(o){void 0===t?(t=o,a=0,n=-1):t=function(e,t){const a=new Uint8Array(e.length+t.length);return a.set(e),a.set(t,e.length),a}(t,o);const r=t.length;let l=0;for(;a<r;){s&&(10===t[a]&&(l=++a),s=!1);let o=-1;for(;a<r&&-1===o;++a)switch(t[a]){case 58:-1===n&&(n=a-l);break;case 13:s=!0;case 10:o=a}if(-1===o)break;e(t.subarray(l,o),n),l=a,n=-1}l===r?t=void 0:0!==l&&(t=t.subarray(l),a-=l)}}function A(e,t){var{signal:a,headers:n,onopen:s,onmessage:o,onclose:r,onerror:l,openWhenHidden:i,fetch:d}=t,c=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(a[n[s]]=e[n[s]])}return a}(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((t,u)=>{const h=Object.assign({},n);let p;function m(){p.abort(),document.hidden||b()}h.accept||(h.accept="text/event-stream"),i||document.addEventListener("visibilitychange",m);let g=1e3,f=0;function y(){document.removeEventListener("visibilitychange",m),window.clearTimeout(f),p.abort()}null==a||a.addEventListener("abort",(()=>{y(),t()}));const v=null!=d?d:window.fetch,w=null!=s?s:D;async function b(){var a;p=new AbortController;try{const a=await v(e,Object.assign(Object.assign({},c),{headers:h,signal:p.signal}));200===a.status||201===a.status?(await w(a),await async function(e,t){const a=e.getReader();let n;for(;!(n=await a.read()).done;)t(n.value)}(a.body,I(function(e,t,a){let n={data:"",event:"",id:"",retry:void 0};const s=new TextDecoder;return function(o,r){if(0===o.length)null==a||a(n),n={data:"",event:"",id:"",retry:void 0};else if(r>0){const l=s.decode(o.subarray(0,r)),i=r+(32===o[r+1]?2:1),d=s.decode(o.subarray(i));switch(l){case"data":n.data=n.data?n.data+"\n"+d:d;break;case"event":n.event=d;break;case"id":e(n.id=d);break;case"retry":const r=parseInt(d,10);isNaN(r)||t(n.retry=r);break;default:const l=s.decode(o,{stream:!0});n.data=l,a(n)}}}}((e=>{e?h["last-event-id"]=e:delete h["last-event-id"]}),(e=>{g=e}),o))),null==r||r(),y(),t()):(y(),u("接口报错"))}catch(n){if(!p.signal.aborted)try{const e=null!==(a=null==l?void 0:l(n))&&void 0!==a?a:g;window.clearTimeout(f),f=window.setTimeout(b,e)}catch(s){y(),u(s)}}}b()}))}function D(e){const t=e.headers.get("content-type");if(!(null==t?void 0:t.startsWith("text/event-stream")))throw new Error(`Expected content-type to be text/event-stream, Actual: ${t}`)}const N={data:()=>({ctrl:null}),methods:{stopChatCore(){var e;null==(e=this.ctrl)||e.abort()},startChatCore({url:e,body:t,headers:a}){if(e)try{this.ctrl=new AbortController,A(e,{readJson:!0,method:"POST",openWidthHidden:!0,signal:this.ctrl.signal,headers:{"Content-Type":"application/json",...a},body:t,timeout:6e5,onopen:()=>{this.$ownerInstance.callMethod("open")},onmessage:({data:e})=>{this.$ownerInstance.callMethod("message",e)},onerror:e=>{this.$ownerInstance.callMethod("error",e)}}).then((()=>{this.$ownerInstance.callMethod("finish")})).catch((e=>{this.$ownerInstance.callMethod("error",e)}))}catch(n){console.log(n)}}}},E=e=>{e.$renderjs||(e.$renderjs=[]),e.$renderjs.push("chat"),e.mixins||(e.mixins=[]),e.mixins.push({beforeCreate(){this.chat=this},mounted(){this.$ownerInstance=this.$gcd(this,!0)}}),e.mixins.push(N)},M={props:{groupKey:{type:String,default:""}},data:()=>({stopCount:0,renderjsData:{url:"",key:0,body:""}}),methods:{stopChat(){this.stopCount+=1},startChat({body:e,url:t,headers:a={}}){this.renderjsData=Object.assign({},this.renderjsData,{key:this.renderjsData.key+1,body:JSON.stringify(e),url:t,headers:a})},open(){this.$emit("onOpen")},message(e){this.$emit("onMessage",e)},error(e){this.$emit("onError",e)},finish(){this.$emit("onFinish")}}};E(M);const S=e(M,[["render",function(e,s,o,r,l,i){const d=n;return t(),a(d,{renderjsData:l.renderjsData,"change:renderjsData":e.chat.startChatCore,stopCount:l.stopCount,"change:stopCount":e.chat.stopChatCore},null,8,["renderjsData","change:renderjsData","stopCount","change:stopCount"])}]]),q=e({__name:"chatItem",props:{showTitle:{type:Boolean,default:!1},showToolbar:{type:Boolean,default:!1},message:{type:Object,default:()=>({})},group:{type:Object,default:()=>({})},config:{type:Object,default:()=>({})},showLoading:{type:Boolean,default:!1},showAvatar:{type:Boolean,default:!1},inputStatus:{type:Boolean,default:!1},groupKey:{type:String,default:""}},emits:["delete"],setup(e,{emit:I}){const A=s(),D=e,N=I,E=o((()=>{var e,t,a;try{const n=(null==(e=D.message)?void 0:e.contentObject)||[];return n.length>0?null==(a=null==(t=n[0])?void 0:t.content)?void 0:a.plugin_name:""}catch(n){return""}})),M=o((()=>{var e;return null==(e=D.group)?void 0:e.logo}));o((()=>{var e,t,a;return(null==(e=D.group)?void 0:e.modelName)||(null==(a=null==(t=D.config)?void 0:t.modelInfo)?void 0:a.modelName)||A.query.robotName||"聊天机器人AI"}));const S=o((()=>{if(!D.message.text)return;let e="";if(D.message.text.split("```").length%2){let t=D.message.text;"\n"!=t[t.length-1]&&(t+="\n"),e=t}else e=D.message.text;return e}));function q(){var e,t,a;N("input",(null==(t=null==(e=D.message)?void 0:e.requestOptions)?void 0:t.prompt)||x("CURRENT_KEYWORD"),(null==(a=D.message)?void 0:a.systemMessage)||"")}function L(){k({title:"提示",content:"是否删除该记录",success:async e=>{e.confirm&&(j({title:"删除中.."}),await z.delChatLog({id:D.message.chatId}),N("delete"),C())}})}let W=r(null);const R=()=>{D.showToolbar&&O.copy(D.message.text)};return l((()=>{(async e=>{const{data:t}=await _.query({keys:["robotAvatar","siteRobotName","subSiteName","guideWelcome"]});console.log("data--",t),W.value=t})()})),(s,o)=>{const r=i(c("uv-avatar"),d),l=n,x=i(c("zero-markdown-view"),T),k=i(c("uv-loading-icon"),$),j=i(c("uv-icon"),u);return t(),a(l,{style:{"margin-top":"24rpx"},class:v([e.groupKey,D.showTitle?"":"flex"])},{default:h((()=>[D.showTitle?(t(),a(l,{key:0,class:"items-center asjd",style:{width:"100%",display:"flex","flex-direction":"column","align-items":"center"}},{default:h((()=>{var e,n;return[D.showAvatar?(t(),a(r,{key:0,src:null==(e=p(W))?void 0:e.robotAvatar,"default-url":null==(n=p(W))?void 0:n.robotAvatar,size:"150rpx"},null,8,["src","default-url"])):m("",!0),g(l,{style:{"font-size":"32rpx","font-weight":"600",color:"#000",margin:"0 auto 10rpx"}},{default:h((()=>{var e;return[f(y(null==(e=p(W))?void 0:e.siteRobotName),1)]})),_:1}),g(l,{style:{"font-size":"28rpx",color:"#3d3d3d",width:"562rpx","text-align":"center"}},{default:h((()=>{var e;return[f(y(null==(e=p(W))?void 0:e.guideWelcome),1)]})),_:1})]})),_:1})):m("",!0),!D.showTitle&&D.showAvatar?(t(),a(l,{key:1},{default:h((()=>[g(r,{src:M.value,"default-url":p(A).query.robotAvatar,size:"44rpx"},null,8,["src","default-url"])])),_:1})):m("",!0),g(l,{class:v(["item-content",D.showTitle?"":"item-content-noTitle"])},{default:h((()=>[E.value?(t(),a(l,{key:0,class:"chat-message-plugin-name"},{default:h((()=>[f("已调用工作流 "+y(E.value),1)])),_:1})):m("",!0),e.message.think?(t(),a(l,{key:1,class:"chat-message-think-text"},{default:h((()=>[g(x,{style:{padding:"0"},color:"#767676",markdown:e.message.think},null,8,["markdown"])])),_:1})):m("",!0),D.showLoading?(t(),a(l,{key:2,style:{padding:"20rpx",display:"flex"}},{default:h((()=>[g(k,{text:"生成中.."})])),_:1})):(t(),a(l,{key:3,style:{position:"relative","z-index":"19"},onClickCapture:R},{default:h((()=>[g(x,{style:{padding:"0"},markdown:S.value},null,8,["markdown"])])),_:1})),D.showLoading||!e.message.text&&!e.message.think?m("",!0):(t(),w(b,{key:4},[D.showToolbar&&!D.inputStatus?(t(),a(l,{key:0,class:"tool-bar"},{default:h((()=>[g(l,{class:"creat-from"},{default:h((()=>[f(y(p(A).query.dialogueTail),1)])),_:1}),g(l,{class:"flex-between"},{default:h((()=>[g(l,null,{default:h((()=>[g(l,{class:"item-op-btn",onClick:q},{default:h((()=>[g(j,{name:"https://ziliao-1259214170-1259214170.cos.ap-shanghai.myqcloud.com/gomaxai111-uni/retry.svg",size:"24rpx"}),g(l,{class:"icon-word",style:{"font-size":"24rpx",color:"#767676"}},{default:h((()=>[f("重新生成")])),_:1})])),_:1})])),_:1}),g(l,{class:"items-center"},{default:h((()=>[g(l,{class:"item-op-btn",style:{padding:"0 16rpx"},onClick:o[0]||(o[0]=e=>s.$tools.copy(S.value))},{default:h((()=>[g(j,{name:"https://ziliao-1259214170-1259214170.cos.ap-shanghai.myqcloud.com/gomaxai111-uni/copy.svg",size:"22rpx"})])),_:1}),g(l,{class:"item-op-btn",style:{"margin-left":"14rpx"},onClick:L},{default:h((()=>[g(j,{name:"https://ziliao-1259214170-1259214170.cos.ap-shanghai.myqcloud.com/gomaxai111-uni/trash.svg",size:"22rpx"})])),_:1})])),_:1})])),_:1})])),_:1})):m("",!0)],64))])),_:1},8,["class"])])),_:1},8,["class"])}}},[["__scopeId","data-v-966cdd12"]]);export{S as C,q as c};
