import{_ as e,l as a,q as t,r as l,s as o,ab as n,aJ as s,o as u,a7 as r,m as i,G as c,p as v,a as p,b as d,w as f,d as g,K as h,H as m,J as y,I as _,e as b,t as w,L as C,ad as x,a0 as k,ak as I,X as j,Y as R,U as T,ay as O,aL as z,i as B,j as A,V as K,a8 as S,B as $,a1 as q,F as P,a9 as E,T as J}from"./index-5HZnFt5a.js";import{_ as M}from"./new.BGSq1aH5.js";import{_ as U}from"./dump.dPDEymx_.js";import{_ as F}from"./dot.DpsQkUPS.js";import{E as H,m as L,_ as G}from"./MyChatItem.CWl-ZwNN.js";import{C as N,c as D}from"./chatItem.B7d2C8sU.js";import{A as Q}from"./ApplyChatInput.ukU-fBQM.js";import{a as V}from"./apps.NDkBLVtm.js";import{a as X}from"./index.BIXFsUHK.js";import"./uni-icons.mAW8qLNS.js";import"./zero-markdown-view.36PbCcI6.js";import"./uv-loading-icon.D2OVaaMI.js";import"./dialog.CErO1ANM.js";import"./uv-textarea.CFQj21ZG.js";import"./props.CsYLBIgk.js";import"./addChat.DRTE-l9I.js";import"./air.BsGE5UBU.js";const Y=e({__name:"AppsChatContent",props:{groupKey:{type:String,default:""},config:{type:Object,default:()=>({})},blurTo:{type:Boolean,default:!1},newChat:{type:Boolean,default:!1},botId:{type:String,default:""}},emits:["change"],setup(e,{expose:S,emit:$}){a();const q=t(),P=l({}),E=l({}),J=x(),M=l([]),U=$,X=e,Y=l(),W=o((()=>{let e=J.ctx.$uv.sys().windowBottom;return le.value>0&&(e=-20),e+ee.value+le.value})),Z=l(),ee=l(0),ae=l(0),te=l(0),le=l(0),oe=l(null),ne=l([]),se=l(0),ue=l(null),re=o((()=>{var e,a;return null==(a=null==(e=P.value)?void 0:e.onboardingInfo)?void 0:a.suggested_questions})),ie=o((()=>{var e,a;const t=null==(a=null==(e=P.value)?void 0:e.onboardingInfo)?void 0:a.prologue;return t?t.replace(/\\n/g,"<br/>"):"欢迎!我是您的个人Al助手，您可以从下面选择建议或告诉我您需要什么"}));function ce(){s().in(J.proxy).select(".inputRef").boundingClientRect((e=>{ee.value=e.height})).exec()}function ve(){n((()=>{s().in(J.proxy).select("#scroll-view-content").boundingClientRect((e=>{let a=e.height-W.value;a>0&&(ae.value=a)})).exec()}))}function pe(){setTimeout((()=>{ce(),ve()}),200)}async function de(e){var a;let t=null==(a=E.value)?void 0:a.conversationId;if(console.log("conversationId",t),k(t)){const{data:a}=await V.createConversation({botId:X.botId,name:e});M.value.push(a),t=a.conversationId,E.value=a}fe(),ue.value=!0,M.value.push({content:e,type:"question"}),pe(),oe.value=setInterval((()=>{ve()}),100);const l={conversationId:t,content:e},o={Authorization:`Bearer ${r("token")}`,"Content-Type":"application/json"};me.value.startChat({url:I+"/api/coze/startChat",headers:o,body:l})}function fe(){clearInterval(oe.value),oe.value=null,se.value=0,ne.value=[],ue.value&&me.value.stopChat()}function ge(e){fe(),U("change",e)}async function he(e){var a;j({title:"加载中"});const{data:t}=await V.conversationList({page:1,size:999,botId:X.botId});if(E.value=null==t?void 0:t.rows[0],E.value){const e=await V.chatList({page:1,size:999,conversationId:E.value.conversationId});M.value=null==(a=null==e?void 0:e.data)?void 0:a.rows.reverse()}else M.value=[];if(e)return R();pe(),R()}H.on("chatscrollToBottom",(()=>{console.log("chatscrollToBottom"),setTimeout((()=>{ce(),ve()}),500)}));const me=l(null),ye=()=>{console.log("open sse"),M.value.push({content:"",type:"answer"})},_e=e=>{console.log("error sse：",e),T({title:e,icon:"none"}),fe(),pe()},be=e=>{console.log("msg",e),function(e){const a=JSON.parse(e);let t="";try{t=JSON.parse(a.content).plugin}catch(l){t=""}t?M.value[M.value.length-1].contentObject=[{content:{plugin_name:t}}]:((null==a?void 0:a.isError)&&(M.value[M.value.length-1].content="接口错误，请联系管理员处理~",fe(),q.getUserInfo(),ue.value=null),(null==a?void 0:a.isEnd)&&(fe(),q.getUserInfo(),ue.value=null),M.value[M.value.length-1].content+=null==a?void 0:a.content)}(e)},we=()=>{ue.value=null},Ce=()=>{M.value=[],E.value={},pe()};u((()=>{n((()=>{xe()})),setTimeout((()=>{ve()}),5e3)}));const xe=()=>{fe(),P.value=r(X.groupKey),X.newChat||he(!0),pe()};return S({clearRecord:async()=>{const{conversationId:e}=E.value;O({title:"提示",content:"确定清空该智能体对话吗？",confirmColor:"#10A37F",success:async a=>{a.confirm&&(await V.clear({conversationId:e}),Ce())}})},cancelRequest:fe,init:xe,newChat:()=>{fe(),M.value=[],E.value={}}}),(a,t)=>{const l=z,o=B,n=A,s=i(v("uv-icon"),c),u=K;return p(),d(o,{class:"apps-chat-content",style:{height:"100%"}},{default:f((()=>[g(N,{ref_key:"chatSSEClientRef",ref:me,groupKey:e.groupKey,onOnOpen:ye,onOnError:_e,onOnMessage:be,onOnFinish:we},null,8,["groupKey"]),g(o,{ref_key:"chatRef",ref:Y,class:"chatRef",style:h(`height: calc(100% - ${W.value}px); position: relative`)},{default:f((()=>[g(u,{"scroll-y":"true",style:{overflow:"auto",height:"100%","box-sizing":"border-box"},"scroll-top":ae.value,onScroll:t[0]||(t[0]=e=>te.value=e.detail.scrollTop)},{default:f((()=>[g(o,{id:"scroll-view-content",style:{height:"100%","box-sizing":"border-box","padding-bottom":"80rpx"}},{default:f((()=>[M.value.length<=0?(p(),d(o,{key:0,class:"chat-card"},{default:f((()=>[g(o,{class:"title"},{default:f((()=>[g(l,{nodes:ie.value},null,8,["nodes"])])),_:1}),g(o,{class:"cell-item"},{default:f((()=>{var e;return[(null==(e=re.value)?void 0:e.length)>0?(p(!0),m(y,{key:0},_(re.value,(e=>(p(),d(o,{class:"item",onClick:a=>de(e)},{default:f((()=>[g(n,{src:F,class:"icon"}),g(o,{class:"content"},{default:f((()=>[b(w(e),1)])),_:2},1024),g(s,{name:"arrow-right",size:"14",color:"#000"})])),_:2},1032,["onClick"])))),256)):C("",!0)]})),_:1})])),_:1})):C("",!0),(p(!0),m(y,null,_(M.value,((a,t)=>{return p(),m(y,{key:t},["question"===a.type&&(l=a.content,/^(http|https|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(l.split(" ")[0]))?(p(),d(o,{key:0},{default:f((()=>[g(o,{class:"flex-end",style:{margin:"50rpx 0 20rpx"}},{default:f((()=>[g(o,{class:"myMessage",style:{"max-width":"570rpx","overflow-wrap":"break-word"}},{default:f((()=>[g(L,{message:{text:a.content}},null,8,["message"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):"question"===a.type?(p(),d(o,{key:1},{default:f((()=>[g(o,{class:"flex-end",style:{margin:"50rpx 0 20rpx"}},{default:f((()=>[g(o,{class:"myMessage",style:{"max-width":"570rpx","overflow-wrap":"break-word"}},{default:f((()=>[g(L,{message:{text:a.content}},null,8,["message"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):(p(),d(D,{key:2,message:{...a,text:a.content},group:P.value,config:e.config,"show-title":!1,"show-toolbar":!0,onDelete:he,onInput:de,"input-status":!!ue.value},null,8,["message","group","config","input-status"]))],64);var l})),128)),null!==ue.value&&0===se.value?(p(),d(D,{key:1,group:P.value,config:e.config,"show-title":!1,"show-toolbar":!1,"show-loading":!0},null,8,["group","config"])):C("",!0)])),_:1})])),_:1},8,["scroll-top"]),g(o,{ref_key:"inputRef",ref:Z,class:"inputRef",style:h({bottom:le.value+"px"})},{default:f((()=>[g(Q,{onHeight:pe,onChange:ge,onInput:de,onClear:Ce,onCancel:fe,group:P.value,currentConversation:E.value,config:e.config,count:M.value.length,"input-status":!!ue.value,blurTo:e.blurTo,"group-key":e.groupKey},null,8,["group","currentConversation","config","count","input-status","blurTo","group-key"])])),_:1},8,["style"]),ae.value-te.value>700&&te.value>0?(p(),d(n,{key:0,class:"glide",src:G,onClick:t[1]||(t[1]=e=>{ae.value+=1,pe()})})):C("",!0)])),_:1},8,["style"])])),_:1})}}},[["__scopeId","data-v-fd91fed6"]]),W=e({__name:"apps",setup(e){const a=l(),t=l(""),o=l(!1),n=l(!1),s=l(!1),u=()=>{var e;null==(e=a.value)||e.newChat()},r=l({});return S((()=>{var e;null==(e=a.value)||e.cancelRequest()})),H.on("inputCreateGroup",(()=>{u()})),$((({id:e,blurTo:a,newChat:l})=>{t.value=q(e),k(a)||(a.value=Boolean(a)),(async()=>{j({title:"加载中...",mask:!0});const{data:e}=await V.getBot({botId:t.value});r.value=E(e),R()})(),s.value=!k(l)})),(e,l)=>{const m=P("ai-bindphone"),y=P("ai-privacy"),_=i(v("uv-icon"),c),x=A,k=B;return p(),d(k,{class:"dialog-chat-apps",onClick:l[3]||(l[3]=e=>o.value=!1)},{default:f((()=>[g(m,{ref:"aiPrivacyRef"},null,512),g(y,{ref:"aiPrivacyRef"},null,512),g(X,{height:55,bg:!1},{left:f((()=>[g(k,{class:"back"},{default:f((()=>[g(_,{name:"arrow-left",bold:"",size:"22",color:"#000",onClick:l[0]||(l[0]=a=>e.$tools.back())}),g(k,{class:"nav-info"},{default:f((()=>{var e;return[g(x,{src:null==(e=r.value)?void 0:e.iconFileUrl},null,8,["src"]),g(k,{class:"info"},{default:f((()=>[g(k,{class:"name uv-line-1"},{default:f((()=>{var e;return[b(w(null==(e=r.value)?void 0:e.name),1)]})),_:1}),g(k,{class:"desc uv-line-1"},{default:f((()=>{var e;return[b(w(null==(e=r.value)?void 0:e.description),1)]})),_:1})])),_:1})]})),_:1})])),_:1})])),right:f((()=>[g(k,{class:"icons"},{default:f((()=>[g(k,{onClick:l[1]||(l[1]=J((e=>o.value=!0),["stop","prevent"]))},{default:f((()=>[g(_,{name:"more-dot-fill",size:"32rpx",color:"#000000"})])),_:1})])),_:1}),o.value?(p(),d(k,{key:0,class:"operate"},{default:f((()=>[g(k,{class:"item",onClick:u},{default:f((()=>[g(k,{class:"action"},{default:f((()=>[b("新建对话")])),_:1}),g(x,{src:M})])),_:1}),g(k,{class:"item",onClick:l[2]||(l[2]=e=>{var t;return null==(t=a.value)?void 0:t.clearRecord()})},{default:f((()=>[g(k,{class:"action"},{default:f((()=>[b("清空当前对话 ")])),_:1}),g(x,{src:U})])),_:1})])),_:1})):C("",!0)])),_:1}),g(k,{style:{height:"20rpx"}}),g(k,{style:h({height:`calc(${e.$tools.height().contentHeight}px - 40rpx)`})},{default:f((()=>[g(Y,{ref_key:"chatContentRef",ref:a,newChat:s.value,"bot-id":t.value,"group-key":"APPS_CHAT_GROUP",blurTo:n.value},null,8,["newChat","bot-id","blurTo"])])),_:1},8,["style"])])),_:1})}}},[["__scopeId","data-v-e88bd153"]]);export{W as default};
