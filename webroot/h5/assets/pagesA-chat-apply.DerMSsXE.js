import{_ as a,u as e,r as t,q as n,s as l,a8 as s,B as o,a1 as i,F as u,m as r,p as c,b as d,w as p,i as v,G as m,a as f,d as g,H as h,I as y,J as w,L as _,X as j,Y as C,a0 as k,a5 as x,a9 as I,a7 as R,ak as b,U as A,au as L,v as O,aL as M,e as z,t as P,a4 as D,j as K}from"./index-5HZnFt5a.js";import{_ as q}from"./z-paging.B8jSxtUa.js";import{_ as F}from"./dot.DpsQkUPS.js";import{_ as U,c as G,d as N,j as S,a as V,s as Y}from"./chat-item.Bfa0bW6i.js";import{p as B,c as E}from"./chat-input.DeV8qM2T.js";import{m as H}from"./my-item.AXCVt8MA.js";import{a as T}from"./apply.Dlzismsu.js";import{d as $}from"./dialog.CErO1ANM.js";import{c as J}from"./chat.Ba42RxGW.js";import"./zero-markdown-view.36PbCcI6.js";import"./uv-loading-icon.D2OVaaMI.js";import"./sound-pay.Vvxa2jSR.js";import"./digital-man.CbE7ZGLY.js";import"./new.BGSq1aH5.js";import"./dump.dPDEymx_.js";import"./index.BIXFsUHK.js";import"./addChat.DRTE-l9I.js";import"./uni-icons.mAW8qLNS.js";import"./air.BsGE5UBU.js";const Q=a({__name:"apply",setup(a){const{t:Q}=e(),X=t(""),Z=t(null),W=t(null),aa=t(null),ea=t(""),ta=t("APPLY_CHAT_GROUP"),na=n(),la=l((()=>{var a;return!!(null==(a=na.userInfo)?void 0:a.id)})),sa=t({}),oa=t(""),ia=t([]),ua=async()=>{const a=ea.value;if(!k(a))return;const{data:e}=await $.getAppsGroup({modelId:X.value}),t=D(e);t.length>0&&(ea.value=t[0].id)},ra=t([]),ca=async()=>{var a;const e=ea.value;if(k(e))return;const{data:t}=await $.chatList({groupId:e}),n=D(t);for(let l=0;l<n.length;l++){const e=n[l];null==(a=W.value)||a.addChatRecordData({...e,content:e.text,type:k(e.conversationOptions)?"question":"answer"})}},da=t(!1),pa=async a=>{var e,t,n;if(!la.value)return void x();let l=ea.value;if(k(l)){const{data:a}=await $.gptsCreate({appId:X.value}),e=I(a);ea.value=e.id,l=e.id}null==(e=W.value)||e.addChatRecordData({content:a,type:"question"}),null==(t=W.value)||t.addChatRecordData({content:Q("chat.index.content"),type:"answer"}),da.value=!0,null==(n=Z.value)||n.setLoading(!0);let s=I(ra.value[0]);console.log("处理消息",s);const o={appId:0,prompt:a,options:{parentMessageId:s.id,groupId:l,model:sa.value.modelId,type:"gpts",usingNetwork:!1},systemMessage:""},{code:i,data:u,error:r}=await J.beforeChatProcessAsync(o);if(200!==i||!u)return ra.value[0].content=r.message||Q("chat.index.message"),void ha();const c=R("token");aa.value.startChat({url:b+"/api/chatgpt/chat-process",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"},body:o})},va=()=>{ra.value[0].think="",ra.value[0].content=""},ma=a=>{var e;const t=null==(e=ra.value[0])?void 0:e.content;k(t)&&(ra.value[0].content=Q("chat.index.error")),A({title:a,icon:"none"}),ha()},fa=t([]),ga=a=>{fa.value.push(a),Ia()},ha=()=>{var a,e;da.value=!1,null==(a=Z.value)||a.setLoading(!1),null==(e=aa.value)||e.stopChat()},ya=()=>{var a,e,t;da.value?(da.value=!1,null==(a=Z.value)||a.setLoading(!1),null==(e=aa.value)||e.stopChat()):(da.value=!1,null==(t=Z.value)||t.setLoading(!1))},wa=()=>{ca()},_a=()=>{ra.value=[]},ja=async()=>{const a=ea.value;if(k(a))return void A({title:Q("chat.index.noContent"),icon:"none"});await L({title:Q("app.tip.title"),content:Q("app.tip.clear"),confirmColor:"#10A37F"})&&(await $.clear({groupId:a,type:"gpts"}),ra.value=[])},Ca=async()=>{await(async()=>{j({title:Q("app.loading"),mask:!0});const{data:a}=await T.getAppModelAsync({id:X.value}),e=I(a);e.iconFileUrl=i(e.logo),e.name=i(e.modelName),e.description=i(e.desc),sa.value=e,oa.value=i(e.desc);const t=i(null==e?void 0:e.demoData);ia.value=null==t?void 0:t.split("\n"),await ua(),C()})(),await ca()},ka=async a=>{if(ra.value[0].id=a.id,ra.value[0].parentMessageId=a.parentMessageId,a.think)for(const e of a.think)ra.value[0].think+=i(e),await Y(10);if(a.delta)for(const e of a.delta)ra.value[0].content+=i(e),await Y(10);a.is_end&&ha()},xa=t(!1),Ia=async()=>{const a=N((()=>{xa.value||(async()=>{if(!(xa.value||fa.value.length<=0))try{for(xa.value=!0;fa.value.length>0;){const{data:a,type:e}=fa.value[0];if("h5"===e){const e=S(a);await ka(e)}else if("mp"===e){const e=(await V(a)).trim().split("\n").filter((a=>""!==a.trim()));for(const a of e){const e=S(a);await ka(e)}}fa.value.shift()}}catch(a){A({title:Q("app.tip.error"),icon:"none"})}finally{xa.value=!1}})()}),50);O((()=>fa.value.length),a)};return s((()=>{ya()})),o((({id:a,cid:e})=>{X.value=i(a),ea.value=i(e),Ca()})),(a,e)=>{const t=u("ai-bindphone"),n=u("ai-privacy"),l=M,s=v,o=K,i=r(c("uv-icon"),m),j=r(c("z-paging"),q);return f(),d(s,{class:"dialog-chat-apply-page"},{default:p((()=>[g(t,{ref:"aiPrivacyRef"},null,512),g(n,{ref:"aiPrivacyRef"},null,512),g(j,{ref_key:"pagingRef",ref:W,modelValue:ra.value,"onUpdate:modelValue":e[0]||(e[0]=a=>ra.value=a),"default-page-size":99999,"use-chat-record-mode":"","auto-to-bottom-when-chat":"","refresher-enabled":!1,"loading-more-enabled":!1,"hide-empty-view":"","chat-loading-more-default-as-loading":!1,auto:!1},{top:p((()=>[g(B,{data:sa.value,onClear:ja,onCreate:_a},null,8,["data"])])),bottom:p((()=>[g(E,{ref_key:"inputRef",ref:Z,data:sa.value,onSend:pa,onClear:ja,onCancel:ya,onCreate:_a},null,8,["data"])])),default:p((()=>[g(s,{class:"main-box"},{default:p((()=>[ra.value.length<=0&&ia.value.length>0&&oa.value?(f(),d(s,{key:0,class:"chat-card"},{default:p((()=>[g(s,{class:"title"},{default:p((()=>[g(l,{nodes:oa.value},null,8,["nodes"])])),_:1}),g(s,{class:"cell-item"},{default:p((()=>[(f(!0),h(w,null,y(ia.value,((a,e)=>(f(),d(s,{key:e,class:"item",onClick:e=>pa(a)},{default:p((()=>[g(o,{src:F,class:"icon"}),g(s,{class:"content"},{default:p((()=>[z(P(a),1)])),_:2},1024),g(i,{name:"arrow-right",size:"14",color:"#000"})])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})):_("",!0),(f(!0),h(w,null,y(ra.value,((a,e)=>(f(),h(w,{key:e},["question"===a.type?(f(),d(s,{key:0,class:"chat-item my-message"},{default:p((()=>[g(H,{text:a.content},null,8,["text"])])),_:2},1024)):(f(),d(s,{key:1,class:"chat-item answer-message"},{default:p((()=>[g(G,{chatKey:ta.value,data:sa.value,message:a,text:a.content,loading:0===e&&da.value,onDelete:wa,onRefresh:a=>(a=>{const e=ra.value[a+1];pa(null==e?void 0:e.content)})(e)},null,8,["chatKey","data","message","text","loading","onRefresh"])])),_:2},1024))],64)))),128))])),_:1})])),_:1},8,["modelValue"]),g(U,{ref_key:"chatSSERef",ref:aa,groupKey:ta.value,onOnOpen:va,onOnError:ma,onOnMessage:ga,onOnFinish:ha},null,8,["groupKey"])])),_:1})}}},[["__scopeId","data-v-086fcecf"]]);export{Q as default};
