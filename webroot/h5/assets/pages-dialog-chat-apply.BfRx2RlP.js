import{_ as e,l,q as a,r as t,o,ab as s,a7 as n,c as u,s as i,aJ as r,X as c,Y as p,m as d,G as v,p as f,a as g,b as m,w as y,d as h,K as _,e as x,t as k,H as w,J as C,I as b,L as R,T,ad as I,N as j,ak as O,U as N,ay as E,i as A,j as K,V as P,B as M,C as U,h as $,a8 as Y,aK as z,F as B}from"./index-5HZnFt5a.js";import{_ as D}from"./dump.dPDEymx_.js";import{_ as S}from"./dot.DpsQkUPS.js";import{E as q,m as G,_ as H}from"./MyChatItem.CWl-ZwNN.js";import{A as J}from"./ApplyChatInput.ukU-fBQM.js";import{C as L,c as W}from"./chatItem.B7d2C8sU.js";import{d as F}from"./dialog.CErO1ANM.js";import{a as Q}from"./index.BIXFsUHK.js";import"./uni-icons.mAW8qLNS.js";import"./uv-textarea.CFQj21ZG.js";import"./props.CsYLBIgk.js";import"./addChat.DRTE-l9I.js";import"./air.BsGE5UBU.js";import"./apps.NDkBLVtm.js";import"./zero-markdown-view.36PbCcI6.js";import"./uv-loading-icon.D2OVaaMI.js";const V=e({__name:"ApplyChatContent",props:{groupKey:{type:String,default:""},config:{type:Object,default:()=>({})},blurTo:{type:Boolean,default:!1}},emits:["change"],setup(e,{expose:M,emit:U}){const $=l(),Y=a(),z=t({}),B=I(),D=t([]),Q=U,V=e;o((()=>{s((()=>{X(),ee()}))}));const X=()=>{ye(),z.value=n(V.groupKey),console.log(z.value),_e(!0),ge()};let Z=t(null);const ee=async e=>{const{data:l}=await u.query({keys:["chatGuide"]});Z.value=l},le=t(),ae=i((()=>{let e=B.ctx.$uv.sys().windowBottom;return ue.value>0&&(e=-20),e+oe.value+ue.value})),te=t(),oe=t(0),se=t(0),ne=t(0),ue=t(0),ie=t(null),re=t([]),ce=t(0),pe=t(null);i((()=>{var e,l;return null==(l=null==(e=$.query)?void 0:e.guideAnswer)?void 0:l.split("/")}));const de=i((()=>{var e,l;return null==(l=null==(e=z.value)?void 0:e.demoData)?void 0:l.split("\n")}));function ve(){r().in(B.proxy).select(".inputRef").boundingClientRect((e=>{oe.value=e.height})).exec()}function fe(){s((()=>{r().in(B.proxy).select("#scroll-view-content").boundingClientRect((e=>{let l=e.height-ae.value;l>0&&(se.value=l)})).exec()}))}function ge(){setTimeout((()=>{ve(),fe()}),200)}function me(e){ye(),j("CURRENT_KEYWORD",e),pe.value=!0,D.value.push({text:e,conversationOptions:null}),ge(),ie.value=setInterval((()=>{var e,l,a;const t=re.value[ce.value];if(t&&(null==t?void 0:t.id)){const o=D.value.findIndex((e=>e.id===t.id));o>-1?D.value[o]={...t}:D.value.push(t),ce.value++,fe(),((null==(a=null==(l=null==(e=null==t?void 0:t.detail)?void 0:e.choices)?void 0:l[0])?void 0:a.finish_reason)||(null==t?void 0:t.is_end))&&(console.log("结束"),ye(),Y.getUserInfo())}}),100);const l=z.value,a={appId:0,prompt:e,options:{parentMessageId:"",groupId:null==l?void 0:l.id,model:l.model,type:"gpts",usingNetwork:!1},systemMessage:""},t={Authorization:`Bearer ${n("token")}`,"Content-Type":"application/json"};xe.value.startChat({url:O+"/api/chatgpt/chat-process",headers:t,body:a})}function ye(){clearInterval(ie.value),ie.value=null,pe.value=null,ce.value=0,re.value=[],pe.value&&(xe.value.stopChat(),ge())}function he(e){ye(),Q("change",e)}async function _e(e){var l,a;c({title:"加载中"});const{data:t}=await F.chatList({groupId:null==(l=z.value)?void 0:l.id,logType:"gpt"===(null==(a=z.value)?void 0:a.modelType)?2:1});if(D.value=t||[],e)return p();n("CURRENT_KEYWORD")&&me(n("CURRENT_KEYWORD")),ge(),p()}q.on("chatscrollToBottom",(()=>{setTimeout((()=>{ve(),fe()}),500)}));const xe=t(null),ke=()=>{console.log("open sse")},we=e=>{N({title:e,icon:"none"}),ye()},Ce=e=>{!function(e){try{const a=null==e?void 0:e.trim().split("\n");for(let e=0;e<a.length;e++)try{const l=JSON.parse(a[e]);"object"==typeof l&&re.value.push(l)}catch(l){console.log("非完整数据流，跳过。")}}catch(l){console.log("非完整分片，跳过。")}}(e)},be=()=>{console.log("finish sse"),4===V.config.modelInfo.keyType&&(pe.value=null)},Re=()=>{D.value=[],ge()};return M({clearRecord:async()=>{E({title:"提示",content:"确定清空该应用对话吗？",confirmColor:"#10A37F",success:async e=>{var l,a;e.confirm&&(await F.clear({groupId:null==(l=z.value)?void 0:l.id,type:(null==(a=z.value)?void 0:a.modelName)?"gpts":"chat"}),Re())}})},cancelRequest:ye,init:X}),(l,a)=>{const t=A,o=K,s=d(f("uv-icon"),v),n=P;return g(),m(t,{class:"apply-chat-content"},{default:y((()=>[h(L,{ref_key:"chatSSEClientRef",ref:xe,onOnOpen:ke,onOnError:we,onOnMessage:Ce,onOnFinish:be},null,512),h(t,{ref_key:"chatRef",ref:le,class:"chatRef",style:_(`height: calc(100% - ${ae.value}px); position: relative`)},{default:y((()=>[h(n,{"scroll-y":"true",style:{overflow:"auto",height:"100%","box-sizing":"border-box"},"scroll-top":se.value,onScroll:a[0]||(a[0]=e=>ne.value=e.detail.scrollTop)},{default:y((()=>[h(t,{id:"scroll-view-content"},{default:y((()=>[D.value.length<=0?(g(),m(t,{key:0,class:"chat-card"},{default:y((()=>[h(t,{class:"title"},{default:y((()=>[x(k(z.value.desc),1)])),_:1}),h(t,{class:"cell-item"},{default:y((()=>[(g(!0),w(C,null,b(de.value,(e=>(g(),m(t,{class:"item",onClick:l=>me(e)},{default:y((()=>[h(o,{src:S,class:"icon"}),h(t,{class:"content"},{default:y((()=>[x(k(e),1)])),_:2},1024),h(s,{name:"arrow-right",size:"14",color:"#000"})])),_:2},1032,["onClick"])))),256))])),_:1})])),_:1})):R("",!0),(g(!0),w(C,null,b(D.value,((l,a)=>{return g(),w(C,{key:a},[null===l.conversationOptions&&(o=l.text,/^(http|https|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(o.split(" ")[0]))?(g(),w(C,{key:0},[h(t,null,{default:y((()=>[h(t,{class:"flex-end",style:{margin:"50rpx 0 20rpx"}},{default:y((()=>[h(t,{class:"myMessage",style:{"max-width":"570rpx","overflow-wrap":"break-word"}},{default:y((()=>[h(G,{message:{text:l.text.split(" ")[0]}},null,8,["message"])])),_:2},1024)])),_:2},1024)])),_:2},1024),l.text.split(" ")[1]?(g(),m(t,{key:0},{default:y((()=>[h(t,{class:"flex-end",style:{margin:"50rpx 0 20rpx"}},{default:y((()=>[h(t,{class:"myMessage",style:{"max-width":"570rpx","overflow-wrap":"break-word"}},{default:y((()=>[h(G,{message:{text:l.text.split(" ")[1]}},null,8,["message"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):R("",!0)],64)):null===l.conversationOptions?(g(),m(t,{key:1},{default:y((()=>[h(t,{class:"flex-end",style:{margin:"50rpx 0 20rpx"}},{default:y((()=>[h(t,{class:"myMessage",style:{"max-width":"570rpx","overflow-wrap":"break-word"}},{default:y((()=>[h(G,{message:l},null,8,["message"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):(g(),m(W,{key:2,message:l,group:z.value,config:e.config,"show-title":!1,"show-toolbar":!0,onDelete:_e,onInput:me,"show-loading":!l.text,"input-status":!!pe.value},null,8,["message","group","config","show-loading","input-status"]))],64);var o})),128)),null!==pe.value&&0===ce.value?(g(),m(W,{key:1,group:z.value,config:e.config,"show-title":!1,"show-toolbar":!1,"show-loading":!0},null,8,["group","config"])):R("",!0)])),_:1})])),_:1},8,["scroll-top"]),h(t,{ref_key:"inputRef",ref:te,class:"inputRef",style:_({bottom:ue.value+"px"})},{default:y((()=>[h(J,{onHeight:ge,onChange:he,onInput:me,onClear:Re,onCancel:ye,group:z.value,config:e.config,count:D.value.length,"input-status":!!pe.value,blurTo:e.blurTo,"group-key":e.groupKey},null,8,["group","config","count","input-status","blurTo","group-key"])])),_:1},8,["style"]),se.value-ne.value>700&&ne.value>0?(g(),m(o,{key:0,class:"glide",src:H,onClick:a[1]||(a[1]=T((e=>{se.value+=1,ge()}),["stop"]))})):R("",!0)])),_:1},8,["style"])])),_:1})}}},[["__scopeId","data-v-ec55f4d4"]]),X=e({__name:"apply",setup(e){const l=t(),a=t(!1),o=t(!1),s=t({}),u=i((()=>{var e;return JSON.parse((null==(e=s.value)?void 0:e.config)||"{}")}));return M((e=>{o.value=Boolean(null==e?void 0:e.blurTo)})),U((()=>{s.value=n("APPLY_CHAT_GROUP"),console.log(s.value)})),q.on("inputCreateGroup",(()=>{$.redirectTo("/pages/dialog/chat/apply?blurTo=1",!0)})),Y((()=>{var e;z("CURRENT_KEYWORD"),null==(e=l.value)||e.cancelRequest()})),(e,t)=>{const n=B("ai-bindphone"),i=B("ai-privacy"),r=d(f("uv-icon"),v),c=K,p=A;return g(),m(p,{class:"dialog-chat-apply",onClick:t[3]||(t[3]=e=>a.value=!1)},{default:y((()=>[h(n,{ref:"aiPrivacyRef"},null,512),h(i,{ref:"aiPrivacyRef"},null,512),h(Q,{height:55,bg:!1},{left:y((()=>[h(p,{class:"back"},{default:y((()=>[h(r,{name:"arrow-left",bold:"",size:"22",color:"#000",onClick:t[0]||(t[0]=l=>e.$tools.back())}),h(p,{class:"nav-info"},{default:y((()=>{var e,l,a;return[h(c,{src:(null==(l=null==(e=u.value)?void 0:e.modelInfo)?void 0:l.cover)||(null==(a=s.value)?void 0:a.logo)},null,8,["src"]),h(p,{class:"info"},{default:y((()=>[h(p,{class:"name uv-line-1"},{default:y((()=>{var e,l,a;return[x(k((null==(e=s.value)?void 0:e.modelName)||(null==(a=null==(l=u.value)?void 0:l.modelInfo)?void 0:a.modelName)),1)]})),_:1}),h(p,{class:"desc uv-line-1"},{default:y((()=>{var e,l,a;return[x(k((null==(e=s.value)?void 0:e.desc)||(null==(a=null==(l=u.value)?void 0:l.modelInfo)?void 0:a.description)),1)]})),_:1})])),_:1})]})),_:1})])),_:1})])),right:y((()=>[h(p,{class:"icons"},{default:y((()=>[h(p,{onClick:t[1]||(t[1]=T((e=>a.value=!0),["stop","prevent"]))},{default:y((()=>[h(r,{name:"more-dot-fill",size:"22",color:"#000"})])),_:1})])),_:1}),a.value?(g(),m(p,{key:0,class:"operate"},{default:y((()=>[h(p,{class:"item",onClick:t[2]||(t[2]=e=>{var a;return null==(a=l.value)?void 0:a.clearRecord()})},{default:y((()=>[h(p,{class:"action"},{default:y((()=>[x("清空当前对话 ")])),_:1}),h(c,{src:D})])),_:1})])),_:1})):R("",!0)])),_:1}),h(p,{style:{height:"20rpx"}}),h(p,{style:_({height:`calc(${e.$tools.height().contentHeight}px - 40rpx)`})},{default:y((()=>[h(V,{ref_key:"chatContentRef",ref:l,"group-key":"APPLY_CHAT_GROUP",config:u.value,blurTo:o.value},null,8,["config","blurTo"])])),_:1},8,["style"])])),_:1})}}},[["__scopeId","data-v-1351e569"]]);export{X as default};
