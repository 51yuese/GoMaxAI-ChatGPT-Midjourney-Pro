import{_ as e,a as t,b as n,i as a,r as s,l as o,u as r,s as i,a4 as l,a9 as c,a1 as d,a0 as u,m as h,p,G as m,w as f,d as g,e as v,t as y,g as b,L as C,h as w,U as j,X as k,Y as x,ay as _}from"./index-5HZnFt5a.js";import{_ as O}from"./zero-markdown-view.36PbCcI6.js";import{_ as $}from"./uv-loading-icon.D2OVaaMI.js";import{_ as S}from"./sound-pay.Vvxa2jSR.js";import{m as E}from"./digital-man.CbE7ZGLY.js";import{d as T}from"./dialog.CErO1ANM.js";const I=e=>new Promise((t=>setTimeout(t,e))),D=(e,t,n={})=>{let a=null;const{leading:s=!1,trailing:o=!0,maxWait:r}=n;return function(...n){s&&!a&&e.apply(this,n),a&&clearTimeout(a),a=setTimeout((()=>{o&&e.apply(this,n),a=null}),t)}},M=e=>{try{return JSON.parse(e)}catch(t){return""}},z=async e=>{if("string"==typeof e)return e;let t;if("[object Uint8Array]"===Object.prototype.toString.call(e))t=decodeURIComponent(escape(String.fromCharCode(...e)));else if(e instanceof ArrayBuffer){t=(e=>{let t="",n=0;for(;n<e.length;){const a=e[n++];if(a<128)t+=String.fromCharCode(a);else if(a<224){const s=e[n++];t+=String.fromCharCode((31&a)<<6|63&s)}else if(a<240){const s=e[n++],o=e[n++];t+=String.fromCharCode((15&a)<<12|(63&s)<<6|63&o)}else{const s=(7&a)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++];t+=String.fromCharCode(55296+(s>>10),56320+(1023&s))}}return t})(new Uint8Array(e))}return t},P=async e=>{const t=[];let n,a,s,o;for(const r of e){const e=r.replace(/^data: /,""),i=JSON.parse(e);t.push(i.content),a||(a=i.contentType,n=i.type,s=i.isEnd,o=i.isError)}return{content:t.join(""),type:n,contentType:a,isEnd:s,isError:o}};function A(e){let t,n,a,s=!1;return function(o){void 0===t?(t=o,n=0,a=-1):t=function(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}(t,o);const r=t.length;let i=0;for(;n<r;){s&&(10===t[n]&&(i=++n),s=!1);let o=-1;for(;n<r&&-1===o;++n)switch(t[n]){case 58:-1===a&&(a=n-i);break;case 13:s=!0;case 10:o=n}if(-1===o)break;e(t.subarray(i,o),a),i=n,a=-1}i===r?t=void 0:0!==i&&(t=t.subarray(i),n-=i)}}function L(e,t){var{signal:n,headers:a,onopen:s,onmessage:o,onclose:r,onerror:i,openWhenHidden:l,fetch:c}=t,d=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(a=Object.getOwnPropertySymbols(e);s<a.length;s++)t.indexOf(a[s])<0&&Object.prototype.propertyIsEnumerable.call(e,a[s])&&(n[a[s]]=e[a[s]])}return n}(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((t,u)=>{const h=Object.assign({},a);let p;function m(){p.abort(),document.hidden||C()}h.accept||(h.accept="text/event-stream"),l||document.addEventListener("visibilitychange",m);let f=1e3,g=0;function v(){document.removeEventListener("visibilitychange",m),window.clearTimeout(g),p.abort()}null==n||n.addEventListener("abort",(()=>{v(),t()}));const y=null!=c?c:window.fetch,b=null!=s?s:N;async function C(){var n;p=new AbortController;try{const n=await y(e,Object.assign(Object.assign({},d),{headers:h,signal:p.signal}));200===n.status||201===n.status?(await b(n),await async function(e,t){const n=e.getReader();let a;for(;!(a=await n.read()).done;)t(a.value)}(n.body,A(function(e,t,n){let a={data:"",event:"",id:"",retry:void 0};const s=new TextDecoder;return function(o,r){if(0===o.length)null==n||n(a),a={data:"",event:"",id:"",retry:void 0};else if(r>0){const i=s.decode(o.subarray(0,r)),l=r+(32===o[r+1]?2:1),c=s.decode(o.subarray(l));switch(i){case"data":a.data=a.data?a.data+"\n"+c:c;break;case"event":a.event=c;break;case"id":e(a.id=c);break;case"retry":const r=parseInt(c,10);isNaN(r)||t(a.retry=r);break;default:const i=s.decode(o,{stream:!0});a.data=i,n(a)}}}}((e=>{e?h["last-event-id"]=e:delete h["last-event-id"]}),(e=>{f=e}),o))),null==r||r(),v(),t()):(v(),u("接口报错"))}catch(a){if(!p.signal.aborted)try{const e=null!==(n=null==i?void 0:i(a))&&void 0!==n?n:f;window.clearTimeout(g),g=window.setTimeout(C,e)}catch(s){v(),u(s)}}}C()}))}function N(e){const t=e.headers.get("content-type");if(!(null==t?void 0:t.startsWith("text/event-stream")))throw new Error(`Expected content-type to be text/event-stream, Actual: ${t}`)}const U={data:()=>({ctrl:null}),methods:{stopChatCore(){var e;null==(e=this.ctrl)||e.abort()},startChatCore({url:e,body:t,headers:n}){if(e)try{this.ctrl=new AbortController,L(e,{readJson:!0,method:"POST",openWidthHidden:!0,signal:this.ctrl.signal,headers:{"Content-Type":"application/json",...n},body:t,timeout:6e5,onopen:()=>{this.$ownerInstance.callMethod("open")},onmessage:({data:e})=>{this.$ownerInstance.callMethod("message",e)},onerror:e=>{this.$ownerInstance.callMethod("error",e)}}).then((()=>{this.$ownerInstance.callMethod("finish")})).catch((e=>{this.$ownerInstance.callMethod("error",e)}))}catch(a){console.log(a)}}}},B=e=>{e.$renderjs||(e.$renderjs=[]),e.$renderjs.push("chat"),e.mixins||(e.mixins=[]),e.mixins.push({beforeCreate(){this.chat=this},mounted(){this.$ownerInstance=this.$gcd(this,!0)}}),e.mixins.push(U)},W={data:()=>({stopCount:0,renderjsData:{url:"",key:0,body:""}}),methods:{stopChat(){this.stopCount+=1},startChat({body:e,url:t,headers:n={}}){this.renderjsData=Object.assign({},this.renderjsData,{key:this.renderjsData.key+1,body:JSON.stringify(e),url:t,headers:n})},open(){this.$emit("onOpen")},message(e){this.$emit("onMessage",{data:e,type:"h5"})},error(e){this.$emit("onError",e)},finish(){this.$emit("onFinish")}}};B(W);const F=e(W,[["render",function(e,s,o,r,i,l){const c=a;return t(),n(c,{renderjsData:i.renderjsData,"change:renderjsData":e.chat.startChatCore,stopCount:i.stopCount,"change:stopCount":e.chat.stopChatCore},null,8,["renderjsData","change:renderjsData","stopCount","change:stopCount"])}]]),J={__name:"index",emits:["onOpen","onMessage","onError","onFinish"],setup(e,{expose:a,emit:o}){const r=s(null),i=o,l=()=>{i("onOpen")},c=e=>{i("onError",e)},d=e=>{i("onMessage",e)},u=()=>{i("onFinish")};return a({startChat:e=>{var t;null==(t=r.value)||t.startChat(e)},stopChat:()=>{var e;null==(e=r.value)||e.stopChat()}}),(e,a)=>(t(),n(F,{ref_key:"chatSSERef",ref:r,onOnOpen:l,onOnError:c,onOnMessage:d,onOnFinish:u},null,512))}},R=e({__name:"chat-item",props:{data:{type:Object,default:()=>({})},message:{type:Object,default:()=>({})},loading:{type:Boolean,default:!1},text:{type:[String,Number],default:""},chatKey:{type:String,default:""},toolBar:{type:Boolean,default:!0}},emits:["delete","refresh"],setup(e,{emit:I}){const D=o(),M=e,{t:z}=r(),P=I,A=i((()=>{var e,t;try{const n=l(null==(e=M.message)?void 0:e.contentObject);if(n.length>0){const e=c(null==(t=n[0])?void 0:t.content);return d(null==e?void 0:e.plugin_name)}return""}catch(n){return""}})),L=i((()=>{var e;return d(null==(e=M.message)?void 0:e.think)})),N=i((()=>{const e=d(M.text);if(u(e))return;let t="";if(e.split("```").length%2){let e=d(M.text);"\n"!==e[e.length-1]&&(e+="\n"),t=e}else t=e;return t.replace(/\.json/g,".json ")})),U=i((()=>{const e=c(null==D?void 0:D.query);return d(null==e?void 0:e.dialogueTail)})),B=()=>{P("refresh")},W=()=>{const e=d(M.text);w.copy(e)},F=async()=>{var e;const t=d(null==(e=M.message)?void 0:e.messageId);if(u(t))return void j({title:z("chat.index.item.del"),icon:"none"});await J()&&(k({title:z("app.del.loading"),mask:!0}),T.delChatLog({id:t}).then((e=>{P("delete"),x()})).catch((e=>{x()})))},J=async()=>new Promise((e=>{_({title:z("app.tip.title"),content:z("chat.index.item.delLog"),success:t=>{t.confirm?e(!0):e(!1)}})})),R=s(null),H=s("1"),V=s(""),q=async()=>{var e,t;H.value="1";const n=d(V.value);if(!u(n))return null==(e=R.value)||e.play(),void(H.value="3");const a=d(null==(t=M.message)?void 0:t.think),s=`${a?a+"\n\n":""}${d(M.text)}`;H.value="2";const{code:o,data:r}=await E.tts({request:{text:s}});if(200!==o||u(r))H.value="1",V.value="";else{if(V.value=r,"2"!==H.value)return;setTimeout((()=>{var e;H.value="3",null==(e=R.value)||e.play()}),1e3)}},Y=()=>{var e;null==(e=R.value)||e.stop(),H.value="1"},G=({type:e})=>{"ended"!==e&&"stop"!==e||(H.value="1")};return(s,o)=>{const r=a,i=h(p("zero-markdown-view"),O),l=h(p("uv-loading-icon"),$),c=h(p("uv-icon"),m);return t(),n(r,{class:"chat-item-box"},{default:f((()=>[g(r,{class:"item-content"},{default:f((()=>[A.value?(t(),n(r,{key:0,class:"plugin-name"},{default:f((()=>[v(y(b(z)("chat.index.item.plugin"))+"} "+y(A.value),1)])),_:1})):C("",!0),L.value?(t(),n(r,{key:1,class:"think-text"},{default:f((()=>[g(i,{markdown:L.value,color:"#767676",style:{padding:"0"}},null,8,["markdown"])])),_:1})):C("",!0),N.value?(t(),n(r,{key:2,class:"message-text",onClickCapture:W},{default:f((()=>[g(i,{style:{padding:"0"},markdown:N.value},null,8,["markdown"])])),_:1})):C("",!0),e.loading?(t(),n(r,{key:3,class:"loading"},{default:f((()=>[g(l,{text:b(z)("app.generation.loading")},null,8,["text"])])),_:1})):C("",!0),e.toolBar&&!e.loading?(t(),n(r,{key:4,class:"tool-bar"},{default:f((()=>[g(r,{class:"creat-from"},{default:f((()=>[v(y(U.value),1)])),_:1}),g(r,{class:"container"},{default:f((()=>[g(r,{class:"left"},{default:f((()=>[g(r,{class:"item-op-btn refresh",onClick:B},{default:f((()=>[g(c,{name:"/static/chat/retry.svg",size:"24rpx"}),g(r,{class:"icon-word"},{default:f((()=>[v(y(b(z)("chat.item.refresh")),1)])),_:1})])),_:1})])),_:1}),g(r,{class:"right"},{default:f((()=>["1"===H.value?(t(),n(r,{key:0,class:"item-op-btn voice",onClick:q},{default:f((()=>[g(c,{name:"/static/chat/voice.svg",size:"22rpx"})])),_:1})):"2"===H.value?(t(),n(r,{key:1,class:"item-op-btn ing",onClick:Y},{default:f((()=>[g(c,{name:"/static/video-create-ing.png",size:"22rpx"})])),_:1})):(t(),n(r,{key:2,class:"item-op-btn voice",onClick:Y},{default:f((()=>[g(c,{name:"/static/chat/voice.gif",size:"22rpx"})])),_:1})),g(r,{class:"item-op-btn copy",onClick:W},{default:f((()=>[g(c,{name:"/static/chat/copy.svg",size:"22rpx"})])),_:1}),g(r,{class:"item-op-btn delete",onClick:F},{default:f((()=>[g(c,{name:"/static/chat/trash.svg",size:"22rpx"})])),_:1})])),_:1})])),_:1})])),_:1})):C("",!0)])),_:1}),g(S,{ref_key:"soundPayRef",ref:R,modelValue:V.value,"onUpdate:modelValue":o[0]||(o[0]=e=>V.value=e),onChange:G},null,8,["modelValue"])])),_:1})}}},[["__scopeId","data-v-56cd3de0"]]);export{J as _,z as a,R as c,D as d,M as j,P as m,I as s};
