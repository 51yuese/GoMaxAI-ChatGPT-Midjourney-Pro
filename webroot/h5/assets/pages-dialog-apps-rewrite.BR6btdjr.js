import{_ as e,r as l,m as a,G as t,p as o,a as s,b as n,w as u,d as r,e as i,t as c,T as d,L as p,X as v,Y as f,N as m,j as g,i as h,W as _,K as y,H as x,J as b,I as k,V as C,C as w,a7 as I,F as S,U as j,ak as z,aO as R,M as O,ab as P,aJ as V,ad as $}from"./index-5HZnFt5a.js";import{_ as E,a as U,b as A}from"./edit.ClCNdCUx.js";import{C as N,c as H}from"./chatItem.B7d2C8sU.js";import{a as M}from"./index.BIXFsUHK.js";import{_ as G}from"./uv-navbar.BqnHoo3Z.js";import{_ as T}from"./uv-input.DP28rKYF.js";import{_ as J}from"./uv-modal.Clrzaq6u.js";import{_ as F}from"./dump.dPDEymx_.js";import{d as L}from"./dialog.CErO1ANM.js";import{_ as Y}from"./index.CqNThjil.js";import"./zero-markdown-view.36PbCcI6.js";import"./uv-loading-icon.D2OVaaMI.js";import"./uv-line.rnRAS3LR.js";import"./props.CsYLBIgk.js";const B=e({__name:"RecordItem",props:{data:{type:Object,default:()=>({})}},emits:["update","detail"],setup(e,{emit:_}){const y=l(!1),x=l(),b=l(""),k=e,C=_;function w(){b.value=k.data.title||"",x.value.open()}async function I(){v({title:"修改中"}),await L.update({groupId:k.data.id,title:b.value}),f(),y.value=!1,C("update"),x.value.close()}async function S(){await L.deleteGroup({groupId:k.data.id}),y.value=!1,C("update")}const j=()=>{m("APPLY_CHAT_GROUP",k.data),C("detail",k.data.id)};return(l,v)=>{const f=g,m=h,_=a(o("uv-icon"),t),k=a(o("uv-input"),T),C=a(o("uv-modal"),J);return s(),n(m,{class:"record-item",onClick:j},{default:u((()=>[r(f,{src:E}),r(m,{class:"name uv-line-1"},{default:u((()=>[i(c(e.data.title),1)])),_:1}),r(m,{onClick:v[0]||(v[0]=d((e=>y.value=!0),["stop","prevent"]))},{default:u((()=>[r(_,{name:"more-dot-fill",size:"28rpx",color:"#000000",bold:""})])),_:1}),y.value?(s(),n(m,{key:0,class:"operate"},{default:u((()=>[r(m,{class:"item",onClick:d(w,["stop","prevent"])},{default:u((()=>[r(m,{class:"action"},{default:u((()=>[i("编辑对话名称")])),_:1}),r(f,{src:U})])),_:1}),r(m,{class:"item",onClick:d(S,["stop","prevent"])},{default:u((()=>[r(m,{class:"action"},{default:u((()=>[i("清空当前对话 ")])),_:1}),r(f,{src:F})])),_:1})])),_:1})):p("",!0),r(C,{ref_key:"groupNameRef",ref:x,title:"修改对话名称",showCancelButton:!0,onConfirm:I},{default:u((()=>[r(k,{modelValue:b.value,"onUpdate:modelValue":v[1]||(v[1]=e=>b.value=e)},null,8,["modelValue"])])),_:1},512)])),_:1})}}},[["__scopeId","data-v-70381fad"]]),D=e({__name:"Menu",emits:["change","detail"],setup(e,{expose:c,emit:d}){const p=l(),v=l([]),f=l(""),m=d,g=async()=>{const{data:e}=await L.getAppsGroup({modelId:f.value});v.value=e};const w=async()=>{var e;await L.gptsCreate({appId:f.value,hasHistory:!0}),g(),m("change"),null==(e=p.value)||e.close()},I=e=>{var l;null==(l=p.value)||l.close(),m("detail",e)};return c({show:function(e){var l;f.value=e,g(),null==(l=p.value)||l.open()}}),(e,l)=>{const c=h,d=a(o("uv-navbar"),G),f=a(o("uv-icon"),t),m=C,S=a(o("uv-popup"),_);return s(),n(S,{ref_key:"popupRef",ref:p,mode:"left",customStyle:{width:"600rpx"}},{default:u((()=>[r(d,{fixed:!1},{left:u((()=>[r(c,{class:"title"},{default:u((()=>[i("写作记录")])),_:1})])),_:1}),r(m,{"scroll-y":"",style:y({height:`${e.$tools.height().contentHeight}px`,padding:"0 26rpx",boxSizing:"border-box"})},{default:u((()=>[r(c,{class:"new-btn",onClick:w},{default:u((()=>[r(f,{name:"plus",color:"#574FFE",size:"28rpx",bold:""}),r(c,null,{default:u((()=>[i("新建写作")])),_:1})])),_:1}),(s(!0),x(b,null,k(v.value,((e,l)=>(s(),n(B,{key:l,data:e,onUpdate:g,onDetail:I},null,8,["data"])))),128))])),_:1},8,["style"])])),_:1},512)}}},[["__scopeId","data-v-7a9c7b29"]]),q=e({__name:"rewrite",setup(e){const d=l({}),v=l(),f=l(""),m=l(null),_=l(null),E=l([]),U=l(0),G=l(null),T=l([]),J=l(0),F=$();function B(){P((()=>{V().in(F.proxy).select("#scroll-view-content").boundingClientRect((e=>{let l=e.height;l>0&&(J.value=l)})).exec()}))}function q(){var e,l,a;if(G.value)return;if(!f.value)return void j({title:"请输入你的问题",icon:"none"});let t={},o="";if(null==(e=d.value.customConfig)?void 0:e.tags.length){let e=!1;if(d.value.customConfig.tags.some((l=>{var a;if(!(null==(a=l.value)?void 0:a.trim())&&1==l.required)return j({title:"请选择或填写"+l.key,icon:"none"}),e=!0,!0;t[l.key]=l.value})),e)return;t["输入内容"]=f.value,o=W(d.value.customConfig.format,t)}K(),G.value=!0,function(e){_.value=setInterval((()=>{var l,a,t;const o=E.value[U.value];if(o&&(null==o?void 0:o.id)){const s=T.value.findIndex((e=>e.id===o.id));s>-1?T.value[s]={...o,systemMessage:e}:T.value.push(o),U.value++,B(),((null==(t=null==(a=null==(l=null==o?void 0:o.detail)?void 0:l.choices)?void 0:a[0])?void 0:t.finish_reason)||(null==o?void 0:o.is_end))&&(console.log("结束"),K())}}),100)}("");const s={appId:0,prompt:o,options:{parentMessageId:"",groupId:null==(l=d.value)?void 0:l.id,type:(null==(a=d.value)?void 0:a.modelName)?"gpts":"",usingNetwork:!1},systemMessage:""},n={Authorization:`Bearer ${I("token")}`,"Content-Type":"application/json"};m.value.startChat({url:z+"/api/chatgpt/chat-process",headers:n,body:s})}function K(){clearInterval(_.value),_.value=null,G.value=null,U.value=0,E.value=[],G.value&&m.value.stopChat()}const W=(e,l)=>e.replace(/\{\{([\u4e00-\u9fa5\w.]+)\}\}/g,((e,a)=>{try{let e=a.split(".").reduce(((e,l)=>null==e?void 0:e[l]),l);return void 0!==e?e:`[未定义：${a}]`}catch(t){return console.error(`解析失败: ${a} => ${t.message}`),"[错误]"}})),X=()=>{console.log("open sse")},Q=e=>{console.log("error sse：",e),j({title:e||"接口异常，请稍后重试",icon:"none"}),K()},Z=e=>{console.log("message sse：",e),function(e){try{const a=null==e?void 0:e.trim().split("\n");for(let e=0;e<a.length;e++)try{const l=JSON.parse(a[e]);"object"==typeof l&&E.value.push(l)}catch(l){console.log("非完整数据流，跳过。")}}catch(l){console.log("非完整分片，跳过。")}}(e)},ee=()=>{var e,l;console.log("finish sse"),4===(null==(l=JSON.parse(null==(e=d.value)?void 0:e.config))?void 0:l.modelInfo.keyType)&&(G.value=null)};const le=()=>{R({url:"/pages/dialog/apps/rewrite"})},ae=async e=>{d.value=I("APPLY_CHAT_GROUP");const{data:l}=await L.chatlog({groupId:e});l.length?(T.value=[l.pop()],B()):T.value=[]};return w((()=>{d.value=I("APPLY_CHAT_GROUP")})),(e,l)=>{const _=S("ai-bindphone"),w=S("ai-privacy"),I=a(o("uv-icon"),t),j=g,z=h,R=C;return s(),x(b,null,[r(z,{class:"dialog-apps-rewrite"},{default:u((()=>[r(_,{ref:"aiPrivacyRef"},null,512),r(w,{ref:"aiPrivacyRef"},null,512),r(M,{bg:!1},{left:u((()=>[r(z,{class:"dialog-apps-rewrite-left"},{default:u((()=>[r(I,{name:"arrow-left",bold:"",size:"22",color:"#000",onClick:l[0]||(l[0]=l=>e.$tools.back())}),r(j,{class:"menu-right",src:A,onClick:l[1]||(l[1]=e=>{var l;return null==(l=v.value)?void 0:l.show(d.value.modelId)})})])),_:1})])),center:u((()=>[r(z,{class:"title"},{default:u((()=>[i(c(d.value.modelName),1)])),_:1})])),right:u((()=>[r(j,{class:"menu-right",src:A,onClick:l[2]||(l[2]=e=>{var l;return null==(l=v.value)?void 0:l.show(d.value.modelId)})})])),_:1}),r(R,{"scroll-y":!0,style:y(`height: calc(${e.$tools.height().contentHeight}px -  170rpx);padding: 0 30rpx; box-sizing: border-box;`),"scroll-top":J.value},{default:u((()=>[r(N,{ref_key:"chatSSEClientRef",ref:m,onOnOpen:X,onOnError:Q,onOnMessage:Z,onOnFinish:ee},null,512),T.value.length<=0?(s(),n(z,{key:0,class:"base-params-list"},{default:u((()=>{var e;return[r(z,{class:"base-params-item"},{default:u((()=>{var e;return[r(z,{class:"base-title-box"},{default:u((()=>[r(z,{class:"left"},{default:u((()=>[r(z,null,{default:u((()=>[i("输入内容")])),_:1})])),_:1})])),_:1}),r(Y,{modelValue:f.value,"onUpdate:modelValue":l[3]||(l[3]=e=>f.value=e),height:96,maxlength:3e3,placeholder:(null==(e=d.value.customConfig)?void 0:e.placeholder)||"请输入内容",theme:"light",customStyle:{background:"#fff",color:"#000000",fontSize:"28rpx",border:"1px solid #E0E2E9",borderRadius:"16rpx"},textStyle:{color:"#000000",fontSize:"28rpx"},placeholderStyle:{color:"#767676",fontSize:"28rpx"},countStyle:{color:"#767676"},clearIcon:"delete-12",clearIconStyle:{width:"24rpx",height:"24rpx"}},null,8,["modelValue","placeholder"])]})),_:1}),(s(!0),x(b,null,k(null==(e=d.value.customConfig)?void 0:e.tags,((e,l)=>(s(),n(z,{class:"base-params-item",key:l},{default:u((()=>[r(z,{class:"base-title-box"},{default:u((()=>[r(z,{class:"left a"},{default:u((()=>[r(z,null,{default:u((()=>[i(c(e.key),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),"select"===e.tag?(s(),n(z,{key:0,class:"select"},{default:u((()=>{var l;return[(s(!0),x(b,null,k(null==(l=e.options)?void 0:l.split(","),((l,a)=>(s(),n(z,{class:O(["select-item",{active:e.value===l}]),key:a,onClick:a=>e.value=l},{default:u((()=>[i(c(l),1)])),_:2},1032,["class","onClick"])))),128))]})),_:2},1024)):"input"===e.tag?(s(),n(z,{key:1,class:"input"},{default:u((()=>[r(Y,{modelValue:e.value,"onUpdate:modelValue":l=>e.value=l,height:96,maxlength:3e3,placeholder:`请输入${e.key}`,theme:"light",count:!1,clearContent:!1,customStyle:{background:"#fff",color:"#000000",fontSize:"28rpx",border:"1px solid #E0E2E9",borderRadius:"16rpx"},textStyle:{color:"#000",fontSize:"28rpx"},placeholderStyle:{color:"#767676",fontSize:"28rpx"},countStyle:{color:"#767676"},clearIcon:"delete-12",clearIconStyle:{width:"24rpx",height:"24rpx"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])])),_:2},1024)):p("",!0)])),_:2},1024)))),128))]})),_:1})):p("",!0),T.value.length>0?(s(),n(z,{key:1,id:"scroll-view-content",style:{"box-sizing":"border-box"}},{default:u((()=>[r(H,{message:T.value[0]},null,8,["message"])])),_:1})):p("",!0)])),_:1},8,["style","scroll-top"]),r(z,{class:"footer"},{default:u((()=>[!G.value&&T.value.length?(s(),x(b,{key:0},[r(z,{class:"recreate",onClick:l[4]||(l[4]=e=>T.value=[])},{default:u((()=>[i("重新生成")])),_:1}),r(z,{class:"copy",onClick:l[5]||(l[5]=l=>e.$tools.copy(T.value[0].text))},{default:u((()=>[i("复制内容")])),_:1})],64)):(s(),n(z,{key:1,class:"create",onClick:q},{default:u((()=>[i(c(G.value?"生成中...":"立即生成"),1)])),_:1}))])),_:1})])),_:1}),r(D,{ref_key:"menuRef",ref:v,onChange:le,onDetail:ae},null,512)],64)}}},[["__scopeId","data-v-483b4e55"]]);export{q as default};
